[{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\check_stations.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\next.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\parse_lint.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\check-banks.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\check-shift-templates.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\cleanup-duplicate-templates.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'key' is assigned a value but never used.","line":33,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":18,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\create-developer-user.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\create-developer.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":16,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\list-users.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\scripts\\test-bank-update.js","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\banks\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchBankAccounts'. Either include it or remove the dependency array.","line":108,"column":6,"nodeType":"ArrayExpression","endLine":108,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchBankAccounts, selectedStation]","fix":{"range":[3266,3283],"text":"[fetchBankAccounts, selectedStation]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\cheques\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":111,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":111,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":183,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":183,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport {\n  Building2,\n  DollarSign,\n  Calendar,\n  Building,\n  FileText,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  Clock,\n  XCircle,\n  ArrowUpCircle\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface Cheque {\n  id: string\n  stationId: string\n  stationName?: string\n  chequeNumber: string\n  bankName: string\n  amount: number\n  status: 'RECEIVED' | 'DEPOSITED' | 'RETURNED'\n  depositReference?: string\n  receivedDate: string\n  depositedDate?: string\n  returnedDate?: string\n  returnReason?: string\n  notes?: string\n  recordedBy: string\n  createdAt: string\n}\n\nconst sriLankanBanks = [\n  'Bank of Ceylon',\n  'Peoples Bank',\n  'Commercial Bank',\n  'Hatton National Bank',\n  'Sampath Bank',\n  'Nations Trust Bank',\n  'DFCC Bank',\n  'National Development Bank',\n  'Pan Asia Banking Corporation',\n  'Union Bank',\n  'Seylan Bank',\n  'Regional Development Bank',\n  'HSBC Sri Lanka',\n  'Standard Chartered Bank',\n  'Citibank N.A.',\n  'Deutsche Bank AG'\n]\n\nexport default function ChequesPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [recentCheques, setRecentCheques] = useState<Cheque[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [chequeNumber, setChequeNumber] = useState('')\n  const [bankName, setBankName] = useState('')\n  const [amount, setAmount] = useState(0)\n  const [status, setStatus] = useState<'RECEIVED' | 'DEPOSITED' | 'RETURNED'>('RECEIVED')\n  const [depositReference, setDepositReference] = useState('')\n  const [receivedDate, setReceivedDate] = useState<Date>(new Date())\n  const [notes, setNotes] = useState('')\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [stationsRes, chequesRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/cheques?limit=10')\n        ])\n\n        const stationsData = await stationsRes.json()\n        const chequesData = await chequesRes.json()\n\n        setStations(stationsData)\n        setRecentCheques(chequesData)\n      } catch (_err) {\n        setError('Failed to load initial data')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !chequeNumber || !bankName || !amount) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    if (amount <= 0) {\n      setError('Amount must be greater than 0')\n      return\n    }\n\n    // Validate deposit reference for deposited status\n    if (status === 'DEPOSITED' && !depositReference) {\n      setError('Deposit reference is required when status is DEPOSITED')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/cheques', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          chequeNumber,\n          bankName,\n          amount: amount,\n          status,\n          depositReference: depositReference || undefined,\n          receivedDate: receivedDate.toISOString(),\n          notes: notes || undefined,\n          recordedBy: typeof window !== 'undefined' ? localStorage.getItem('username') || 'System User' : 'System User'\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to record cheque')\n      }\n\n      const newCheque = await response.json()\n\n      // Add to recent cheques list\n      setRecentCheques(prev => [newCheque, ...prev.slice(0, 9)])\n\n      // Reset form\n      setSelectedStation('')\n      setChequeNumber('')\n      setBankName('')\n      setAmount(0)\n      setStatus('RECEIVED')\n      setDepositReference('')\n      setReceivedDate(new Date())\n      setNotes('')\n\n      setSuccess('Cheque recorded successfully!')\n\n      // Clear success message after 3 seconds\n      setTimeout(() => setSuccess(''), 3000)\n\n    } catch (_err) {\n      setError('Failed to record cheque')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'RECEIVED': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'DEPOSITED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'RETURNED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'RECEIVED': return <Clock className=\"h-4 w-4\" />\n      case 'DEPOSITED': return <CheckCircle className=\"h-4 w-4\" />\n      case 'RETURNED': return <XCircle className=\"h-4 w-4\" />\n      default: return <FileText className=\"h-4 w-4\" />\n    }\n  }\n\n  const chequeColumns: Column<Cheque>[] = [\n    {\n      key: 'receivedDate' as keyof Cheque,\n      title: 'Received Date',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'stationName' as keyof Cheque,\n      title: 'Station',\n      render: (value: unknown, row: Cheque) => {\n        const station = stations.find(s => s.id === row.stationId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{station?.name || (value as string)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'chequeNumber' as keyof Cheque,\n      title: 'Cheque Number',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-mono font-medium\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'bankName' as keyof Cheque,\n      title: 'Bank',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Building className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'amount' as keyof Cheque,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-mono font-semibold text-green-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof Cheque,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          <div className=\"flex items-center gap-1\">\n            {getStatusIcon(value as string)}\n            <span>{value as string}</span>\n          </div>\n        </Badge>\n      )\n    },\n    {\n      key: 'depositReference' as keyof Cheque,\n      title: 'Deposit Reference',\n      render: (value: unknown) => (\n        value ? (\n          <div className=\"flex items-center gap-2\">\n            <ArrowUpCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n            <span className=\"font-mono text-sm\">{value as string}</span>\n          </div>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'depositedDate' as keyof Cheque,\n      title: 'Deposited Date',\n      render: (value: unknown) => (\n        value ? (\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'returnedDate' as keyof Cheque,\n      title: 'Returned Date',\n      render: (value: unknown) => (\n        value ? (\n          <span className=\"text-sm text-red-600 dark:text-red-400\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'notes' as keyof Cheque,\n      title: 'Notes',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground max-w-xs truncate\">\n          {value as string || '-'}\n        </span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Cheques Management</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Record New Cheque\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Station and Cheque Number */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"station\">Station *</Label>\n              <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select a station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {stations.map((station) => (\n                    <SelectItem key={station.id} value={station.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"h-4 w-4\" />\n                        {station.name} ({station.city})\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"chequeNumber\">Cheque Number *</Label>\n              <Input\n                id=\"chequeNumber\"\n                value={chequeNumber}\n                onChange={(e) => setChequeNumber(e.target.value)}\n                placeholder=\"e.g., 123456\"\n                disabled={loading}\n                required\n              />\n            </div>\n          </div>\n\n          {/* Bank and Amount */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"bankName\">Bank *</Label>\n              <Select value={bankName} onValueChange={setBankName} disabled={loading}>\n                <SelectTrigger id=\"bankName\">\n                  <SelectValue placeholder=\"Select bank\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {sriLankanBanks.map((bank) => (\n                    <SelectItem key={bank} value={bank}>\n                      <div className=\"flex items-center gap-2\">\n                        <Building className=\"h-4 w-4\" />\n                        {bank}\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"amount\">Cheque Amount (Rs.) *</Label>\n              <MoneyInput\n                id=\"amount\"\n                value={amount}\n                onChange={setAmount}\n                placeholder=\"0.00\"\n                disabled={loading}\n                required\n              />\n            </div>\n          </div>\n\n          {/* Status and Date */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"status\">Status *</Label>\n              <Select value={status} onValueChange={(value: 'RECEIVED' | 'DEPOSITED' | 'RETURNED') => setStatus(value)} disabled={loading}>\n                <SelectTrigger id=\"status\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"RECEIVED\">\n                    <div className=\"flex items-center gap-2\">\n                      <Clock className=\"h-4 w-4\" />\n                      Received\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"DEPOSITED\">\n                    <div className=\"flex items-center gap-2\">\n                      <CheckCircle className=\"h-4 w-4\" />\n                      Deposited\n                    </div>\n                  </SelectItem>\n                  <SelectItem value=\"RETURNED\">\n                    <div className=\"flex items-center gap-2\">\n                      <XCircle className=\"h-4 w-4\" />\n                      Returned\n                    </div>\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"receivedDate\">Received Date *</Label>\n              <DateTimePicker\n                value={receivedDate}\n                onChange={(date) => setReceivedDate(date || new Date())}\n                disabled={loading}\n              />\n            </div>\n          </div>\n\n          {/* Deposit Reference (conditional) */}\n          {status === 'DEPOSITED' && (\n            <div>\n              <Label htmlFor=\"depositReference\">Deposit Reference *</Label>\n              <Input\n                id=\"depositReference\"\n                value={depositReference}\n                onChange={(e) => setDepositReference(e.target.value)}\n                placeholder=\"Bank deposit slip number or reference\"\n                disabled={loading}\n                required\n              />\n            </div>\n          )}\n\n          {/* Notes */}\n          <div>\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Input\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Additional details about the cheque...\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/safe')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Recording...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Record Cheque\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent Cheques\" className=\"p-6\">\n        <DataTable\n          data={recentCheques}\n          columns={chequeColumns}\n          searchPlaceholder=\"Search cheques...\"\n          emptyMessage=\"No cheques recorded yet.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\credit\\aging\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":90,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":90,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":148,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":148,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Users,\n  TrendingUp,\n  AlertTriangle,\n  AlertCircle,\n  CheckCircle,\n  Building2,\n  DollarSign,\n  Clock,\n  Calculator\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface CustomerAging {\n  customerId: string\n  customerName: string\n  nicOrBrn: string\n  creditLimit: number\n  totalOutstanding: number\n  current: number // 0-30 days\n  days31to60: number // 31-60 days\n  days61to90: number // 61-90 days\n  over90Days: number // 90+ days\n  oldestInvoiceDate: string\n  daysPastDue: number\n  riskLevel: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'\n  lastPaymentDate?: string\n  lastPaymentAmount?: number\n}\n\ninterface AgingSummary {\n  stationId?: string\n  stationName?: string\n  reportDate: string\n  totalCustomers: number\n  totalOutstanding: number\n  currentBucket: number // 0-30 days\n  bucket31to60: number // 31-60 days\n  bucket61to90: number // 61-90 days\n  over90Bucket: number // 90+ days\n  riskDistribution: {\n    low: number\n    medium: number\n    high: number\n    critical: number\n  }\n}\n\nexport default function CreditAgingPage() {\n  const [stations, setStations] = useState<Station[]>([])\n  const [agingData, setAgingData] = useState<CustomerAging[]>([])\n  const [summary, setSummary] = useState<AgingSummary | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [reportDate, setReportDate] = useState(new Date().toISOString().split('T')[0])\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const generateReport = async () => {\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call real API endpoint for aging data\n      const station = selectedStation === 'all' ? null : stations.find(s => s.id === selectedStation)\n\n      const url = station\n        ? `/api/credit/aging?stationId=${station.id}`\n        : '/api/credit/aging'\n\n      const response = await fetch(url)\n      if (!response.ok) {\n        throw new Error('Failed to fetch aging data')\n      }\n\n      const agingCustomers: CustomerAging[] = await response.json()\n\n      setAgingData(agingCustomers)\n\n      // Calculate summary\n      const totalOutstanding = agingCustomers.reduce((sum, c) => sum + c.totalOutstanding, 0)\n      const currentBucket = agingCustomers.reduce((sum, c) => sum + c.current, 0)\n      const bucket31to60 = agingCustomers.reduce((sum, c) => sum + c.days31to60, 0)\n      const bucket61to90 = agingCustomers.reduce((sum, c) => sum + c.days61to90, 0)\n      const over90Bucket = agingCustomers.reduce((sum, c) => sum + c.over90Days, 0)\n\n      const riskDistribution = {\n        low: agingCustomers.filter(c => c.riskLevel === 'LOW').length,\n        medium: agingCustomers.filter(c => c.riskLevel === 'MEDIUM').length,\n        high: agingCustomers.filter(c => c.riskLevel === 'HIGH').length,\n        critical: agingCustomers.filter(c => c.riskLevel === 'CRITICAL').length\n      }\n\n      const agingSummary: AgingSummary = {\n        stationId: selectedStation === 'all' ? undefined : selectedStation,\n        stationName: station?.name || 'All Stations',\n        reportDate,\n        totalCustomers: agingCustomers.length,\n        totalOutstanding,\n        currentBucket,\n        bucket31to60,\n        bucket61to90,\n        over90Bucket,\n        riskDistribution\n      }\n\n      setSummary(agingSummary)\n\n    } catch (err) {\n      setError('Failed to generate aging report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getRiskColor = (risk: string) => {\n    switch (risk) {\n      case 'LOW': return 'text-green-600 dark:text-green-400 bg-green-500/10 dark:bg-green-500/20 border-green-500/20 dark:border-green-500/30'\n      case 'MEDIUM': return 'text-yellow-600 dark:text-yellow-400 bg-yellow-500/10 dark:bg-yellow-500/20 border-yellow-500/20 dark:border-yellow-500/30'\n      case 'HIGH': return 'text-orange-600 dark:text-orange-400 bg-orange-500/10 dark:bg-orange-500/20 border-orange-500/20 dark:border-orange-500/30'\n      case 'CRITICAL': return 'text-red-600 dark:text-red-400 bg-red-500/10 dark:bg-red-500/20 border-red-500/20 dark:border-red-500/30'\n      default: return 'text-muted-foreground bg-muted border-border'\n    }\n  }\n\n  const getRiskIcon = (risk: string) => {\n    switch (risk) {\n      case 'LOW': return <CheckCircle className=\"h-4 w-4\" />\n      case 'MEDIUM': return <Clock className=\"h-4 w-4\" />\n      case 'HIGH': return <AlertTriangle className=\"h-4 w-4\" />\n      case 'CRITICAL': return <AlertCircle className=\"h-4 w-4\" />\n      default: return <CheckCircle className=\"h-4 w-4\" />\n    }\n  }\n\n  const getBucketColor = (amount: number, total: number) => {\n    const percentage = total > 0 ? (amount / total) * 100 : 0\n    if (percentage >= 50) return 'text-red-600 dark:text-red-400'\n    if (percentage >= 25) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-green-600 dark:text-green-400'\n  }\n\n  const agingColumns: Column<CustomerAging>[] = [\n    {\n      key: 'customerName' as keyof CustomerAging,\n      title: 'Customer',\n      render: (value: unknown, row: CustomerAging) => (\n        <div className=\"flex items-center gap-2\">\n          <Users className=\"h-4 w-4 text-muted-foreground\" />\n          <div className=\"flex flex-col\">\n            <span className=\"font-medium\">{value as string}</span>\n            <span className=\"text-xs text-muted-foreground\">{row.nicOrBrn}</span>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'totalOutstanding' as keyof CustomerAging,\n      title: 'Total Outstanding',\n      render: (value: unknown, row: CustomerAging) => (\n        <div className=\"flex flex-col\">\n          <div className=\"flex items-center gap-2\">\n            <DollarSign className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n            <span className=\"font-mono font-semibold text-red-700\">\n              Rs. {(value as number)?.toLocaleString() || 0}\n            </span>\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.creditLimit > 0 ? Math.round(((value as number) / row.creditLimit) * 100) : 0}% of limit\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'current' as keyof CustomerAging,\n      title: '0-30 Days',\n      render: (value: unknown, row: CustomerAging) => (\n        <span className={`font-mono ${getBucketColor(value as number, row.totalOutstanding)}`}>\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'days31to60' as keyof CustomerAging,\n      title: '31-60 Days',\n      render: (value: unknown, row: CustomerAging) => (\n        <span className={`font-mono ${getBucketColor(value as number, row.totalOutstanding)}`}>\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'days61to90' as keyof CustomerAging,\n      title: '61-90 Days',\n      render: (value: unknown, row: CustomerAging) => (\n        <span className={`font-mono ${getBucketColor(value as number, row.totalOutstanding)}`}>\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'over90Days' as keyof CustomerAging,\n      title: '90+ Days',\n      render: (value: unknown, row: CustomerAging) => (\n        <span className={`font-mono ${getBucketColor(value as number, row.totalOutstanding)}`}>\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'daysPastDue' as keyof CustomerAging,\n      title: 'Days Past Due',\n      render: (value: unknown) => {\n        const days = value as number\n        return (\n          <div className=\"flex items-center gap-1\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className={`font-semibold ${days > 90 ? 'text-red-600 dark:text-red-400' :\n                days > 60 ? 'text-orange-600 dark:text-orange-400' :\n                  days > 30 ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400'\n              }`}>\n              {days} days\n            </span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'riskLevel' as keyof CustomerAging,\n      title: 'Risk Level',\n      render: (value: unknown) => (\n        <Badge className={getRiskColor(value as string)}>\n          <div className=\"flex items-center gap-1\">\n            {getRiskIcon(value as string)}\n            <span>{value as string}</span>\n          </div>\n        </Badge>\n      )\n    },\n    {\n      key: 'lastPaymentDate' as keyof CustomerAging,\n      title: 'Last Payment',\n      render: (value: unknown, row: CustomerAging) => (\n        value ? (\n          <div className=\"flex flex-col\">\n            <span className=\"text-sm\">\n              {new Date(value as string).toLocaleDateString()}\n            </span>\n            {row.lastPaymentAmount && (\n              <span className=\"text-xs text-muted-foreground\">\n                Rs. {row.lastPaymentAmount.toLocaleString()}\n              </span>\n            )}\n          </div>\n        ) : (\n          <span className=\"text-muted-foreground\">No payments</span>\n        )\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Credit Aging Analysis</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Generate Aging Report\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station (Optional)</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"All Stations\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Stations</SelectItem>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"date\">Report Date</Label>\n            <input\n              id=\"date\"\n              type=\"date\"\n              value={reportDate}\n              onChange={(e) => setReportDate(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !reportDate}>\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {summary && (\n        <div className=\"space-y-6\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Outstanding</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">\n                  Rs. {summary.totalOutstanding.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {summary.totalCustomers} customers\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-green-600 dark:text-green-400\">0-30 Days</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-700\">\n                  Rs. {summary.currentBucket.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {summary.totalOutstanding > 0 ? Math.round((summary.currentBucket / summary.totalOutstanding) * 100) : 0}%\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-yellow-600 dark:text-yellow-400\">31-60 Days</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-yellow-700\">\n                  Rs. {summary.bucket31to60.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {summary.totalOutstanding > 0 ? Math.round((summary.bucket31to60 / summary.totalOutstanding) * 100) : 0}%\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-orange-600 dark:text-orange-400\">61-90 Days</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-orange-700\">\n                  Rs. {summary.bucket61to90.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {summary.totalOutstanding > 0 ? Math.round((summary.bucket61to90 / summary.totalOutstanding) * 100) : 0}%\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-red-600 dark:text-red-400\">90+ Days</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-700\">\n                  Rs. {summary.over90Bucket.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {summary.totalOutstanding > 0 ? Math.round((summary.over90Bucket / summary.totalOutstanding) * 100) : 0}%\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Risk Distribution */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5\" />\n                Risk Distribution\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                <div className=\"text-center\">\n                  <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                    {summary.riskDistribution.low}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Low Risk</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-2xl font-bold text-yellow-600 dark:text-yellow-400\">\n                    {summary.riskDistribution.medium}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Medium Risk</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\n                    {summary.riskDistribution.high}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">High Risk</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">\n                    {summary.riskDistribution.critical}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Critical Risk</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Detailed Aging Table */}\n          <FormCard title=\"Customer Aging Details\" className=\"p-6\">\n            <DataTable\n              data={agingData}\n              columns={agingColumns}\n              searchPlaceholder=\"Search customers...\"\n              emptyMessage=\"No aging data available.\"\n            />\n          </FormCard>\n\n          {/* Recommendations */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5\" />\n                Recommendations\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {summary.riskDistribution.critical > 0 && (\n                  <Alert variant=\"destructive\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      <strong>Critical:</strong> {summary.riskDistribution.critical} customers have overdue amounts over 90 days.\n                      Immediate collection action required.\n                    </AlertDescription>\n                  </Alert>\n                )}\n\n                {summary.riskDistribution.high > 0 && (\n                  <Alert>\n                    <AlertTriangle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      <strong>High Risk:</strong> {summary.riskDistribution.high} customers require close monitoring.\n                      Consider payment plans or credit limit reviews.\n                    </AlertDescription>\n                  </Alert>\n                )}\n\n                {summary.over90Bucket > summary.totalOutstanding * 0.1 && (\n                  <Alert>\n                    <AlertTriangle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      <strong>Collection Focus:</strong> Over 10% of outstanding debt is 90+ days old.\n                      Review collection procedures and consider debt recovery actions.\n                    </AlertDescription>\n                  </Alert>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\credit\\customers\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":329,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":329,"endColumn":19}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchCustomers'. Either include it or remove the dependency array.","line":112,"column":6,"nodeType":"ArrayExpression","endLine":112,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchCustomers]","fix":{"range":[2768,2770],"text":"[fetchCustomers]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useToast } from '@/hooks/use-toast'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Card } from '@/components/ui/card'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport {\n  Phone,\n  CreditCard,\n  Plus,\n  Edit,\n  DollarSign,\n  IdCard,\n  UserCheck,\n  History,\n  ArrowDownRight,\n  ArrowUpRight,\n  Clock,\n  Filter,\n  Minus\n} from 'lucide-react'\n\ninterface CreditCustomer {\n  id: string\n  name: string\n  nicOrBrn: string\n  phone: string\n  email?: string\n  address?: string\n  creditLimit: number\n  currentBalance: number\n  availableCredit: number\n  status: 'ACTIVE' | 'SUSPENDED' | 'INACTIVE'\n  approvedBy: string\n  approvedAt: string\n  createdAt: string\n  updatedAt: string\n}\n\ninterface CreditTransaction {\n  id: string\n  type: 'SALE' | 'PAYMENT'\n  customerId: string\n  customerName: string\n  customerPhone: string\n  amount: number\n  timestamp: string\n  description: string\n  shiftId?: string\n  paymentType?: string\n  chequeNumber?: string\n  bankName?: string\n}\n\nexport default function CreditCustomersPage() {\n  const [customers, setCustomers] = useState<CreditCustomer[]>([])\n  const [loading, setLoading] = useState(true)\n  const { toast } = useToast()\n  const [userRole, setUserRole] = useState<string>('')\n\n  // Dialog state\n  const [isDialogOpen, setIsDialogOpen] = useState(false)\n  const [editingCustomer, setEditingCustomer] = useState<CreditCustomer | null>(null)\n\n  // Transaction history state\n  const [transactions, setTransactions] = useState<CreditTransaction[]>([])\n  const [loadingTransactions, setLoadingTransactions] = useState(false)\n  const [filterCustomer, setFilterCustomer] = useState<string>('all')\n  const [filterType, setFilterType] = useState<string>('all')\n\n  // Form state\n  const [formData, setFormData] = useState({\n    name: '',\n    nicOrBrn: '',\n    phone: '',\n    email: '',\n    address: '',\n    creditLimit: 0,\n    status: 'ACTIVE' as 'ACTIVE' | 'SUSPENDED' | 'INACTIVE'\n  })\n\n  useEffect(() => {\n    // Get user role from localStorage\n    const role = localStorage.getItem('userRole')\n    setUserRole(role || '')\n\n    fetchCustomers()\n    fetchTransactions()\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [])\n\n  const fetchTransactions = async () => {\n    try {\n      setLoadingTransactions(true)\n\n      // Fetch both sales and payments in parallel\n      const [salesRes, paymentsRes] = await Promise.all([\n        fetch('/api/credit/sales'),\n        fetch('/api/credit/payments')\n      ])\n\n      if (!salesRes.ok || !paymentsRes.ok) {\n        throw new Error('Failed to fetch transactions')\n      }\n\n      const sales = await salesRes.json()\n      const payments = await paymentsRes.json()\n\n      interface ApiCreditSale {\n        id: string\n        customerId: string\n        customer?: { name: string; phone?: string }\n        amount: number\n        timestamp: string\n        liters?: number\n        price?: number\n        shiftId?: string\n      }\n\n      interface ApiCreditPayment {\n        id: string\n        customerId: string\n        customer?: { name: string; phone?: string }\n        amount: number\n        paymentDate: string\n        paymentType?: string\n        chequeNumber?: string\n        bank?: { name: string }\n      }\n\n      // Transform sales\n      const salesTransactions: CreditTransaction[] = sales.map((sale: ApiCreditSale) => ({\n        id: sale.id,\n        type: 'SALE' as const,\n        customerId: sale.customerId,\n        customerName: sale.customer?.name || 'Unknown',\n        customerPhone: sale.customer?.phone || '',\n        amount: sale.amount,\n        timestamp: sale.timestamp,\n        description: `Credit sale - ${sale.liters?.toFixed(2) || 'N/A'}L @ Rs. ${sale.price?.toLocaleString() || 'N/A'}/L`,\n        shiftId: sale.shiftId\n      }))\n\n      // Transform payments\n      const paymentsTransactions: CreditTransaction[] = payments.map((payment: ApiCreditPayment) => ({\n        id: payment.id,\n        type: 'PAYMENT' as const,\n        customerId: payment.customerId,\n        customerName: payment.customer?.name || 'Unknown',\n        customerPhone: payment.customer?.phone || '',\n        amount: payment.amount,\n        timestamp: payment.paymentDate,\n        description: `Payment received - ${payment.paymentType || 'Cash'}${payment.chequeNumber ? ` (Cheque: ${payment.chequeNumber})` : ''}${payment.bank ? ` - ${payment.bank.name}` : ''}`,\n        paymentType: payment.paymentType,\n        chequeNumber: payment.chequeNumber,\n        bankName: payment.bank?.name\n      }))\n\n      // Combine and sort by timestamp (newest first)\n      const allTransactions = [...salesTransactions, ...paymentsTransactions].sort((a, b) =>\n        new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()\n      )\n\n      setTransactions(allTransactions)\n    } catch (error) {\n      console.error('Failed to fetch transactions:', error)\n    } finally {\n      setLoadingTransactions(false)\n    }\n  }\n\n  const fetchCustomers = async () => {\n    try {\n      setLoading(true)\n      const response = await fetch('/api/credit/customers')\n      const data = await response.json()\n\n      interface ApiCreditCustomer {\n        id: string\n        name: string\n        company?: string\n        phone: string\n        email?: string\n        address?: string\n        creditLimit: number\n        currentBalance: number\n        isActive: boolean\n        approvedBy?: string\n        approvedAt?: string\n        createdAt: string\n        updatedAt: string\n      }\n\n      // Transform the data to include calculated fields and map company to nicOrBrn\n      const transformedCustomers = data.map((customer: ApiCreditCustomer) => ({\n        ...customer,\n        nicOrBrn: customer.company || '', // Map company to nicOrBrn for frontend\n        availableCredit: customer.creditLimit - customer.currentBalance,\n        status: (customer.isActive ? 'ACTIVE' : 'INACTIVE') as 'ACTIVE' | 'SUSPENDED' | 'INACTIVE',\n        approvedBy: customer.approvedBy || 'System',\n        approvedAt: customer.approvedAt || customer.createdAt || new Date().toISOString()\n      }))\n\n      setCustomers(transformedCustomers)\n    } catch (error) {\n      console.error('Failed to fetch customers:', error)\n      toast({\n        title: \"Error\",\n        description: \"Failed to load customers data.\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!formData.name || !formData.nicOrBrn || !formData.phone || formData.creditLimit <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const url = editingCustomer\n        ? `/api/credit/customers/${editingCustomer.id}`\n        : '/api/credit/customers'\n\n      const method = editingCustomer ? 'PUT' : 'POST'\n\n      // Map nicOrBrn to company for API\n      const requestBody = {\n        name: formData.name,\n        company: formData.nicOrBrn || null, // Map nicOrBrn to company\n        phone: formData.phone,\n        email: formData.email || null,\n        address: formData.address || '',\n        creditLimit: formData.creditLimit,\n        status: formData.status\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(requestBody)\n      })\n\n      if (!response.ok) {\n        throw new Error(`Failed to ${editingCustomer ? 'update' : 'create'} customer`)\n      }\n\n      const savedCustomer = await response.json()\n\n      // Transform saved customer to match frontend format (map company to nicOrBrn)\n      const transformedCustomer = {\n        ...savedCustomer,\n        nicOrBrn: savedCustomer.company || '',\n        availableCredit: savedCustomer.creditLimit - savedCustomer.currentBalance,\n        status: savedCustomer.isActive ? 'ACTIVE' : 'INACTIVE' as 'ACTIVE' | 'SUSPENDED' | 'INACTIVE',\n        approvedBy: savedCustomer.approvedBy || 'System',\n        approvedAt: savedCustomer.approvedAt || savedCustomer.createdAt || new Date().toISOString()\n      }\n\n      if (editingCustomer) {\n        // Update existing customer in list\n        setCustomers(prev => prev.map(c =>\n          c.id === editingCustomer.id\n            ? transformedCustomer\n            : c\n        ))\n      } else {\n        // Add new customer to list\n        setCustomers(prev => [\n          transformedCustomer,\n          ...prev\n        ])\n      }\n\n      // Reset form and close dialog\n      setFormData({\n        name: '',\n        nicOrBrn: '',\n        phone: '',\n        email: '',\n        address: '',\n        creditLimit: 0,\n        status: 'ACTIVE'\n      })\n      setEditingCustomer(null)\n      setIsDialogOpen(false)\n\n      toast({\n        title: \"Success\",\n        description: `Customer ${editingCustomer ? 'updated' : 'created'} successfully!`\n      })\n\n      // Refresh transactions in case balance changed\n      fetchTransactions()\n\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: `Failed to ${editingCustomer ? 'update' : 'create'} customer`,\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleEdit = (customer: CreditCustomer) => {\n    setEditingCustomer(customer)\n    setFormData({\n      name: customer.name || '',\n      nicOrBrn: customer.nicOrBrn || '', // Ensure it's always a string\n      phone: customer.phone || '',\n      email: customer.email || '',\n      address: customer.address || '',\n      creditLimit: customer.creditLimit || 0,\n      status: customer.status || 'ACTIVE'\n    })\n    setIsDialogOpen(true)\n  }\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false)\n    setEditingCustomer(null)\n    setFormData({\n      name: '',\n      nicOrBrn: '',\n      phone: '',\n      email: '',\n      address: '',\n      creditLimit: 0,\n      status: 'ACTIVE'\n    })\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'ACTIVE': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'SUSPENDED': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'INACTIVE': return 'bg-muted text-foreground'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getBalanceColor = (balance: number, limit: number) => {\n    const percentage = (balance / limit) * 100\n    if (percentage >= 90) return 'text-red-600 dark:text-red-400'\n    if (percentage >= 75) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-green-600 dark:text-green-400'\n  }\n\n  const customerColumns: Column<CreditCustomer>[] = [\n    {\n      key: 'name' as keyof CreditCustomer,\n      title: 'Customer Name',\n      render: (value: unknown, row: CreditCustomer) => (\n        <div className=\"flex items-center gap-2\">\n          <UserCheck className=\"h-4 w-4 text-muted-foreground\" />\n          <div className=\"flex flex-col\">\n            <span className=\"font-medium\">{value as string}</span>\n            <span className=\"text-xs text-muted-foreground\">{row.email}</span>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'nicOrBrn' as keyof CreditCustomer,\n      title: 'NIC/BRN',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <IdCard className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-mono text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'phone' as keyof CreditCustomer,\n      title: 'Phone',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Phone className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-mono text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'creditLimit' as keyof CreditCustomer,\n      title: 'Credit Limit',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <CreditCard className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          <span className=\"font-mono font-semibold text-blue-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'currentBalance' as keyof CreditCustomer,\n      title: 'Current Balance',\n      render: (value: unknown, row: CreditCustomer) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          <span className={`font-mono font-semibold ${getBalanceColor(value as number, row.creditLimit)}`}>\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'availableCredit' as keyof CreditCustomer,\n      title: 'Available Credit',\n      render: (value: unknown) => {\n        const numValue = value as number\n        return (\n          <span className={`font-mono font-semibold ${numValue > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n            Rs. {numValue?.toLocaleString() || 0}\n          </span>\n        )\n      }\n    },\n    {\n      key: 'status' as keyof CreditCustomer,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    },\n    ...(userRole === 'OWNER' ? [{\n      key: 'actions' as keyof CreditCustomer,\n      title: 'Actions',\n      render: (_value: unknown, row: CreditCustomer) => (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={() => handleEdit(row)}\n          className=\"text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300\"\n        >\n          <Edit className=\"h-4 w-4 mr-1\" />\n          Edit\n        </Button>\n      )\n    }] : [])\n  ]\n\n  // Filter transactions based on selected filters\n  const filteredTransactions = transactions.filter(tx => {\n    if (filterCustomer !== 'all' && tx.customerId !== filterCustomer) return false\n    if (filterType !== 'all' && tx.type !== filterType) return false\n    return true\n  })\n\n  const transactionColumns: Column<CreditTransaction>[] = [\n    {\n      key: 'timestamp' as keyof CreditTransaction,\n      title: 'Date & Time',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{new Date(value as string).toLocaleString()}</span>\n        </div>\n      )\n    },\n    {\n      key: 'type' as keyof CreditTransaction,\n      title: 'Type',\n      render: (value: unknown, row: CreditTransaction) => {\n        const isSale = row.type === 'SALE'\n        return (\n          <div className=\"flex items-center gap-2\">\n            {isSale ? (\n              <ArrowUpRight className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n            ) : (\n              <ArrowDownRight className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n            )}\n            <Badge className={isSale\n              ? 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n              : 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n            }>\n              {row.type}\n            </Badge>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'customerName' as keyof CreditTransaction,\n      title: 'Customer',\n      render: (value: unknown, row: CreditTransaction) => (\n        <div className=\"flex flex-col\">\n          <span className=\"font-medium\">{value as string}</span>\n          <span className=\"text-xs text-muted-foreground\">{row.customerPhone}</span>\n        </div>\n      )\n    },\n    {\n      key: 'amount' as keyof CreditTransaction,\n      title: 'Amount',\n      render: (value: unknown, row: CreditTransaction) => {\n        const isSale = row.type === 'SALE'\n        return (\n          <div className={`flex items-center gap-2 font-mono font-semibold ${isSale ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>\n            {isSale ? (\n              <>\n                <Plus className=\"h-4 w-4\" />\n                <span>Rs. {(value as number).toLocaleString()}</span>\n              </>\n            ) : (\n              <>\n                <Minus className=\"h-4 w-4\" />\n                <span>Rs. {(value as number).toLocaleString()}</span>\n              </>\n            )}\n          </div>\n        )\n      }\n    },\n    {\n      key: 'description' as keyof CreditTransaction,\n      title: 'Description',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">{value as string}</span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-3xl font-bold text-foreground\">Credit Customers</h1>\n        {userRole === 'OWNER' && (\n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button onClick={() => setEditingCustomer(null)}>\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add Customer\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[600px]\">\n              <DialogHeader>\n                <DialogTitle>\n                  {editingCustomer ? 'Edit Customer' : 'Add New Customer'}\n                </DialogTitle>\n                <DialogDescription>\n                  {editingCustomer\n                    ? 'Update customer information and credit settings.'\n                    : 'Create a new credit customer account. All fields marked with * are required.'\n                  }\n                </DialogDescription>\n              </DialogHeader>\n              <form onSubmit={handleSubmit}>\n                <div className=\"grid gap-4 py-4\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"name\">Customer Name *</Label>\n                      <Input\n                        id=\"name\"\n                        value={formData.name}\n                        onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                        placeholder=\"John Doe\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"nicOrBrn\">NIC/BRN *</Label>\n                      <Input\n                        id=\"nicOrBrn\"\n                        value={formData.nicOrBrn}\n                        onChange={(e) => setFormData(prev => ({ ...prev, nicOrBrn: e.target.value }))}\n                        placeholder=\"123456789V or PV12345\"\n                        required\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"phone\">Phone Number *</Label>\n                      <Input\n                        id=\"phone\"\n                        value={formData.phone}\n                        onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}\n                        placeholder=\"+94771234567\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"email\">Email</Label>\n                      <Input\n                        id=\"email\"\n                        type=\"email\"\n                        value={formData.email}\n                        onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}\n                        placeholder=\"john@example.com\"\n                      />\n                    </div>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"address\">Address</Label>\n                    <Input\n                      id=\"address\"\n                      value={formData.address}\n                      onChange={(e) => setFormData(prev => ({ ...prev, address: e.target.value }))}\n                      placeholder=\"123 Main Street, Colombo\"\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"creditLimit\">Credit Limit (Rs.) *</Label>\n                      <MoneyInput\n                        id=\"creditLimit\"\n                        value={formData.creditLimit}\n                        onChange={(value) => setFormData(prev => ({ ...prev, creditLimit: value }))}\n                        placeholder=\"50000\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"status\">Status</Label>\n                      <Select\n                        value={formData.status}\n                        onValueChange={(value: 'ACTIVE' | 'SUSPENDED' | 'INACTIVE') =>\n                          setFormData(prev => ({ ...prev, status: value }))\n                        }\n                      >\n                        <SelectTrigger>\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"ACTIVE\">Active</SelectItem>\n                          <SelectItem value=\"SUSPENDED\">Suspended</SelectItem>\n                          <SelectItem value=\"INACTIVE\">Inactive</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n                </div>\n                <DialogFooter>\n                  <Button type=\"button\" variant=\"outline\" onClick={handleCloseDialog}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={loading}>\n                    {loading ? 'Saving...' : (editingCustomer ? 'Update Customer' : 'Add Customer')}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </DialogContent>\n          </Dialog>\n        )}\n      </div>\n\n      {/* Statistics Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Total Customers</h3>\n          <p className=\"text-3xl font-bold text-purple-600 dark:text-purple-400\">{customers.length}</p>\n        </Card>\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Active Customers</h3>\n          <p className=\"text-3xl font-bold text-green-600 dark:text-green-400\">\n            {customers.filter(c => c.status === 'ACTIVE').length}\n          </p>\n        </Card>\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Total Credit Limit</h3>\n          <p className=\"text-3xl font-bold text-blue-600 dark:text-blue-400\">\n            Rs. {customers.reduce((sum, c) => sum + c.creditLimit, 0).toLocaleString()}\n          </p>\n        </Card>\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Outstanding Balance</h3>\n          <p className=\"text-3xl font-bold text-red-600 dark:text-red-400\">\n            Rs. {customers.reduce((sum, c) => sum + c.currentBalance, 0).toLocaleString()}\n          </p>\n        </Card>\n      </div>\n\n      <FormCard title=\"Credit Customers\" className=\"p-6\">\n        <DataTable\n          data={customers}\n          columns={customerColumns}\n          searchPlaceholder=\"Search customers...\"\n          emptyMessage=\"No credit customers found.\"\n        />\n      </FormCard>\n\n      {/* Transaction History Section */}\n      <FormCard title=\"Transaction History\" className=\"p-6\">\n        <div className=\"space-y-4\">\n          {/* Filters */}\n          <div className=\"flex flex-wrap gap-4 items-end\">\n            <div className=\"flex-1 min-w-[200px]\">\n              <Label htmlFor=\"filterCustomer\" className=\"flex items-center gap-2 mb-2\">\n                <Filter className=\"h-4 w-4\" />\n                Filter by Customer\n              </Label>\n              <Select value={filterCustomer} onValueChange={setFilterCustomer}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"All customers\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Customers</SelectItem>\n                  {customers.map((customer) => (\n                    <SelectItem key={customer.id} value={customer.id}>\n                      {customer.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex-1 min-w-[150px]\">\n              <Label htmlFor=\"filterType\" className=\"flex items-center gap-2 mb-2\">\n                <Filter className=\"h-4 w-4\" />\n                Filter by Type\n              </Label>\n              <Select value={filterType} onValueChange={setFilterType}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"All types\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Types</SelectItem>\n                  <SelectItem value=\"SALE\">Sales Only</SelectItem>\n                  <SelectItem value=\"PAYMENT\">Payments Only</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={fetchTransactions}\n                disabled={loadingTransactions}\n              >\n                <History className=\"h-4 w-4 mr-2\" />\n                Refresh\n              </Button>\n            </div>\n          </div>\n\n          {/* Summary Stats */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-muted/50 rounded-lg\">\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Total Transactions</p>\n              <p className=\"text-2xl font-bold\">{filteredTransactions.length}</p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Total Sales</p>\n              <p className=\"text-2xl font-bold text-red-600 dark:text-red-400\">\n                Rs. {filteredTransactions\n                  .filter(tx => tx.type === 'SALE')\n                  .reduce((sum, tx) => sum + tx.amount, 0)\n                  .toLocaleString()}\n              </p>\n            </div>\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Total Payments</p>\n              <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                Rs. {filteredTransactions\n                  .filter(tx => tx.type === 'PAYMENT')\n                  .reduce((sum, tx) => sum + tx.amount, 0)\n                  .toLocaleString()}\n              </p>\n            </div>\n          </div>\n\n          {/* Transactions Table */}\n          {loadingTransactions ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n            </div>\n          ) : (\n            <DataTable\n              data={filteredTransactions}\n              columns={transactionColumns}\n              searchPlaceholder=\"Search transactions...\"\n              emptyMessage=\"No transactions found.\"\n            />\n          )}\n        </div>\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\credit\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShoppingCart' is defined but never used.","line":6,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":6,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { usePathname } from 'next/navigation'\r\nimport Link from 'next/link'\r\nimport { cn } from '@/lib/utils'\r\nimport { Users, DollarSign, ShoppingCart, TrendingUp } from 'lucide-react'\r\n\r\nconst tabs = [\r\n  {\r\n    name: 'Customers',\r\n    href: '/credit/customers',\r\n    icon: Users,\r\n  },\r\n  {\r\n    name: 'Payments',\r\n    href: '/credit/payments',\r\n    icon: DollarSign,\r\n  },\r\n]\r\n\r\nexport default function CreditLayout({\r\n  children,\r\n}: {\r\n  children: React.ReactNode\r\n}) {\r\n  const pathname = usePathname()\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Tab Navigation */}\r\n      <div className=\"border-b border-border\">\r\n        <nav className=\"flex space-x-8\" aria-label=\"Credit Tabs\">\r\n          {tabs.map((tab) => {\r\n            const isActive = pathname === tab.href\r\n            const Icon = tab.icon\r\n            \r\n            return (\r\n              <Link\r\n                key={tab.name}\r\n                href={tab.href}\r\n                className={cn(\r\n                  'flex items-center gap-2 py-4 px-1 border-b-2 font-medium text-sm transition-colors',\r\n                  isActive\r\n                    ? 'border-purple-600 text-purple-600 dark:border-purple-400 dark:text-purple-400'\r\n                    : 'border-transparent text-muted-foreground hover:text-foreground hover:border-muted-foreground'\r\n                )}\r\n              >\r\n                <Icon className=\"h-5 w-5\" />\r\n                {tab.name}\r\n              </Link>\r\n            )\r\n          })}\r\n        </nav>\r\n      </div>\r\n\r\n      {/* Page Content */}\r\n      {children}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\credit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\credit\\payments\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Alert' is defined but never used.","line":22,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertDescription' is defined but never used.","line":22,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTitle' is defined but never used.","line":22,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CreditCard' is defined but never used.","line":34,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":38,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":39,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":41,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":139,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":139,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'toast'. Either include it or remove the dependency array.","line":149,"column":6,"nodeType":"ArrayExpression","endLine":149,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [toast]","fix":{"range":[4281,4283],"text":"[toast]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { useToast } from '@/hooks/use-toast'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Users,\n  DollarSign,\n  Calendar,\n  CreditCard,\n  Banknote,\n  Building,\n  FileText,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  Clock,\n  Eye\n} from 'lucide-react'\n\ninterface CreditCustomer {\n  id: string\n  name: string\n  nicOrBrn: string\n  creditLimit: number\n  currentBalance: number\n  availableCredit: number\n  status: 'ACTIVE' | 'SUSPENDED' | 'INACTIVE'\n}\n\ninterface CreditPayment {\n  id: string\n  customerId: string\n  customerName?: string\n  customer?: {\n    name: string\n    phone: string\n    nicOrBrn?: string\n  }\n  amount: number\n  paymentDate: string\n  paymentMethod: 'CASH' | 'CHEQUE' | 'BANK_TRANSFER'\n  paymentType?: string\n  referenceNumber?: string\n  chequeNumber?: string\n  bankName?: string\n  bank?: {\n    id: string\n    name: string\n    accountNumber?: string\n  }\n  notes?: string\n  recordedBy: string\n  receivedBy?: string\n  status: 'PENDING' | 'CLEARED' | 'BOUNCED'\n  clearedAt?: string\n  createdAt: string\n}\n\nconst paymentMethods = [\n  { value: 'CASH', label: 'Cash', icon: Banknote, requiresRef: false },\n  { value: 'CHEQUE', label: 'Cheque', icon: FileText, requiresRef: true },\n  { value: 'BANK_TRANSFER', label: 'Bank Transfer', icon: Building, requiresRef: true }\n]\n\ninterface Bank {\n  id: string\n  name: string\n  accountNumber: string\n}\n\nexport default function CreditPaymentsPage() {\n  const router = useRouter()\n  const { selectedStation } = useStation()\n  const [customers, setCustomers] = useState<CreditCustomer[]>([])\n  const [banks, setBanks] = useState<Bank[]>([])\n  const [recentPayments, setRecentPayments] = useState<CreditPayment[]>([])\n  const [loading, setLoading] = useState(false)\n  const { toast } = useToast()\n\n  // Payment details modal\n  const [selectedPayment, setSelectedPayment] = useState<CreditPayment | null>(null)\n  const [isDetailsOpen, setIsDetailsOpen] = useState(false)\n\n  // Form state\n  const [selectedCustomer, setSelectedCustomer] = useState('')\n  const [amount, setAmount] = useState(0)\n  const [paymentDate, setPaymentDate] = useState<Date>(new Date())\n  const [paymentMethod, setPaymentMethod] = useState<'CASH' | 'CHEQUE' | 'BANK_TRANSFER'>('CASH')\n  const [referenceNumber, setReferenceNumber] = useState('')\n  const [chequeNumber, setChequeNumber] = useState('')\n  const [selectedBank, setSelectedBank] = useState('')\n  const [notes, setNotes] = useState('')\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [customersRes, paymentsRes, banksRes] = await Promise.all([\n          fetch('/api/credit/customers?status=ACTIVE'),\n          fetch('/api/credit/payments?limit=10'),\n          fetch('/api/banks')\n        ])\n\n        const customersData = await customersRes.json()\n        const paymentsData = await paymentsRes.json()\n        const banksData = await banksRes.json()\n\n        setCustomers(customersData.map((customer: { id: string; name: string; creditLimit: number; currentBalance: number }) => ({\n          ...customer,\n          availableCredit: customer.creditLimit - customer.currentBalance\n        })))\n        setRecentPayments(paymentsData)\n        setBanks(Array.isArray(banksData) ? banksData : [])\n      } catch (err) {\n        toast({\n          title: \"Error\",\n          description: \"Failed to load initial data\",\n          variant: \"destructive\"\n        })\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedCustomer) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a customer\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (amount <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Amount must be greater than 0\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    // Check if customer has outstanding balance\n    const customer = customers.find(c => c.id === selectedCustomer)\n    if (customer && amount > customer.currentBalance) {\n      toast({\n        title: \"Error\",\n        description: `Payment amount exceeds outstanding balance of Rs. ${customer.currentBalance.toLocaleString()}`,\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    // Validate cheque number for cheque payments\n    if (paymentMethod === 'CHEQUE' && !chequeNumber) {\n      toast({\n        title: \"Error\",\n        description: \"Cheque number is required for cheque payments\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    // Validate reference number for bank transfer\n    if (paymentMethod === 'BANK_TRANSFER' && !referenceNumber) {\n      toast({\n        title: \"Error\",\n        description: \"Reference number is required for bank transfers\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const response = await fetch('/api/credit/payments', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          customerId: selectedCustomer,\n          amount: amount,\n          paymentDate: paymentDate.toISOString(),\n          paymentType: paymentMethod,\n          chequeNumber: chequeNumber || null,\n          bankId: selectedBank || null,\n          receivedBy: typeof window !== 'undefined' ? localStorage.getItem('username') || 'Manager' : 'Manager',\n          stationId: selectedStation !== 'all' ? selectedStation : null\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        const errorMsg = errorData.details\n          ? `${errorData.error}: ${errorData.details}`\n          : (errorData.error || 'Failed to record payment')\n        console.error('Payment API Error:', errorData)\n        throw new Error(errorMsg)\n      }\n\n      const newPayment = await response.json()\n\n      // Add to recent payments list\n      setRecentPayments(prev => [newPayment, ...prev.slice(0, 9)])\n\n      // Update customer balance\n      setCustomers(prev => prev.map(c =>\n        c.id === selectedCustomer\n          ? {\n            ...c,\n            currentBalance: c.currentBalance - amount,\n            availableCredit: c.availableCredit + amount\n          }\n          : c\n      ))\n\n      // Reset form\n      setSelectedCustomer('')\n      setAmount(0)\n      setPaymentDate(new Date())\n      setPaymentMethod('CASH')\n      setReferenceNumber('')\n      setChequeNumber('')\n      setSelectedBank('')\n      setNotes('')\n\n      toast({\n        title: \"Success\",\n        description: \"Payment recorded successfully!\"\n      })\n\n    } catch (err) {\n      console.error('Payment error:', err)\n      toast({\n        title: \"Error\",\n        description: err instanceof Error ? err.message : 'Failed to record payment',\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'CLEARED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'PENDING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'BOUNCED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getMethodIcon = (method: string) => {\n    const methodConfig = paymentMethods.find(m => m.value === method)\n    if (methodConfig) {\n      const Icon = methodConfig.icon\n      return <Icon className=\"h-4 w-4 text-muted-foreground\" />\n    }\n    return <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n  }\n\n  const selectedCustomerData = customers.find(c => c.id === selectedCustomer)\n  const selectedMethodConfig = paymentMethods.find(m => m.value === paymentMethod)\n\n  const paymentColumns: Column<CreditPayment>[] = [\n    {\n      key: 'paymentDate' as keyof CreditPayment,\n      title: 'Date',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'customerName' as keyof CreditPayment,\n      title: 'Customer',\n      render: (value: unknown, row: CreditPayment) => {\n        const customer = customers.find(c => c.id === row.customerId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{customer?.name || (value as string)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'amount' as keyof CreditPayment,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-mono font-semibold text-green-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'paymentMethod' as keyof CreditPayment,\n      title: 'Method',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          {getMethodIcon(value as string)}\n          <Badge variant=\"outline\">{value as string}</Badge>\n        </div>\n      )\n    },\n    {\n      key: 'referenceNumber' as keyof CreditPayment,\n      title: 'Reference',\n      render: (value: unknown, row: CreditPayment) => (\n        <div className=\"flex flex-col\">\n          {value ? (\n            <span className=\"font-mono text-sm\">{value as string}</span>\n          ) : (\n            <span className=\"text-xs text-muted-foreground\"></span>\n          )}\n          {row.chequeNumber && (\n            <span className=\"text-xs text-muted-foreground\">\n              Cheque: {row.chequeNumber}\n            </span>\n          )}\n          {(row.bank?.name || row.bankName) && (\n            <span className=\"text-xs text-muted-foreground\">\n              {row.bank?.name || row.bankName}\n            </span>\n          )}\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof CreditPayment,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = (value as string) || 'CLEARED'\n        return (\n          <Badge className={getStatusColor(status)}>\n            {status}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'recordedBy' as keyof CreditPayment,\n      title: 'Recorded By',\n      render: (value: unknown, row: CreditPayment) => (\n        <span className=\"text-sm text-muted-foreground\">{row.receivedBy || (value as string)}</span>\n      )\n    },\n    {\n      key: 'id' as keyof CreditPayment,\n      title: 'Actions',\n      render: (_value: unknown, row: CreditPayment) => (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={() => {\n            setSelectedPayment(row)\n            setIsDetailsOpen(true)\n          }}\n          className=\"text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300\"\n        >\n          <Eye className=\"h-4 w-4 mr-1\" />\n          View\n        </Button>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Credit Payments</h1>\n\n      <h1 className=\"text-3xl font-bold text-foreground\">Credit Payments</h1>\n\n      <FormCard title=\"Record New Payment\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Customer Selection */}\n          <div>\n            <Label htmlFor=\"customer\">Customer *</Label>\n            <Select value={selectedCustomer} onValueChange={setSelectedCustomer} disabled={loading}>\n              <SelectTrigger id=\"customer\">\n                <SelectValue placeholder=\"Select a customer\" />\n              </SelectTrigger>\n              <SelectContent>\n                {customers.filter(c => c.currentBalance > 0).map((customer) => (\n                  <SelectItem key={customer.id} value={customer.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Users className=\"h-4 w-4\" />\n                      <div className=\"flex flex-col\">\n                        <span className=\"font-medium\">{customer.name}</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          Outstanding: Rs. {customer.currentBalance.toLocaleString()}\n                        </span>\n                      </div>\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            {selectedCustomerData && (\n              <div className=\"mt-2 p-2 bg-blue-500/10 dark:bg-blue-500/20 rounded-md\">\n                <div className=\"text-xs text-blue-700\">\n                  <div>Credit Limit: Rs. {selectedCustomerData.creditLimit.toLocaleString()}</div>\n                  <div className=\"font-semibold\">Outstanding Balance: Rs. {selectedCustomerData.currentBalance.toLocaleString()}</div>\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Payment Details */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"amount\">Payment Amount (Rs.) *</Label>\n              <MoneyInput\n                id=\"amount\"\n                value={amount}\n                onChange={setAmount}\n                placeholder=\"0.00\"\n                disabled={loading}\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"paymentDate\">Payment Date *</Label>\n              <DateTimePicker\n                value={paymentDate}\n                onChange={(date) => setPaymentDate(date || new Date())}\n                disabled={loading}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"paymentMethod\">Payment Method *</Label>\n              <Select\n                value={paymentMethod}\n                onValueChange={(value: 'CASH' | 'CHEQUE' | 'BANK_TRANSFER') => setPaymentMethod(value)}\n                disabled={loading}\n              >\n                <SelectTrigger id=\"paymentMethod\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {paymentMethods.map((method) => {\n                    const Icon = method.icon\n                    return (\n                      <SelectItem key={method.value} value={method.value}>\n                        <div className=\"flex items-center gap-2\">\n                          <Icon className=\"h-4 w-4\" />\n                          {method.label}\n                        </div>\n                      </SelectItem>\n                    )\n                  })}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Method-specific fields */}\n          {selectedMethodConfig?.requiresRef && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"referenceNumber\">\n                  Reference Number *\n                  {paymentMethod === 'BANK_TRANSFER' && ' (Transfer ID)'}\n                </Label>\n                <Input\n                  id=\"referenceNumber\"\n                  value={referenceNumber}\n                  onChange={(e) => setReferenceNumber(e.target.value)}\n                  placeholder={\n                    paymentMethod === 'BANK_TRANSFER' ? 'TRF123456789' :\n                      'REF123456789'\n                  }\n                  disabled={loading}\n                  required\n                />\n              </div>\n\n              {paymentMethod === 'BANK_TRANSFER' && (\n                <div>\n                  <Label htmlFor=\"bank\">Bank Account</Label>\n                  <Select value={selectedBank} onValueChange={setSelectedBank} disabled={loading}>\n                    <SelectTrigger id=\"bank\">\n                      <SelectValue placeholder=\"Select bank account\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {banks.map((bank) => (\n                        <SelectItem key={bank.id} value={bank.id}>\n                          <div className=\"flex items-center gap-2\">\n                            <Building className=\"h-4 w-4\" />\n                            <div className=\"flex flex-col\">\n                              <span className=\"font-medium\">{bank.name}</span>\n                              <span className=\"text-xs text-muted-foreground\">{bank.accountNumber}</span>\n                            </div>\n                          </div>\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n            </div>\n          )}\n\n          {paymentMethod === 'CHEQUE' && (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"chequeNumber\">Cheque Number *</Label>\n                <Input\n                  id=\"chequeNumber\"\n                  value={chequeNumber}\n                  onChange={(e) => setChequeNumber(e.target.value)}\n                  placeholder=\"123456\"\n                  disabled={loading}\n                  required\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"bank\">Bank Account</Label>\n                <Select value={selectedBank} onValueChange={setSelectedBank} disabled={loading}>\n                  <SelectTrigger id=\"bank\">\n                    <SelectValue placeholder=\"Select bank account\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {banks.map((bank) => (\n                      <SelectItem key={bank.id} value={bank.id}>\n                        <div className=\"flex items-center gap-2\">\n                          <Building className=\"h-4 w-4\" />\n                          <div className=\"flex flex-col\">\n                            <span className=\"font-medium\">{bank.name}</span>\n                            <span className=\"text-xs text-muted-foreground\">{bank.accountNumber}</span>\n                          </div>\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          )}\n\n          {/* Notes */}\n          <div>\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Input\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Additional notes about the payment...\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/credit')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Recording...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Record Payment\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent Payments\" className=\"p-6\">\n        <DataTable\n          data={recentPayments}\n          columns={paymentColumns}\n          searchPlaceholder=\"Search payments...\"\n          emptyMessage=\"No payments recorded yet.\"\n        />\n      </FormCard>\n\n      {/* Payment Details Modal */}\n      <Dialog open={isDetailsOpen} onOpenChange={setIsDetailsOpen}>\n        <DialogContent className=\"sm:max-w-[600px]\">\n          <DialogHeader>\n            <DialogTitle>Payment Details</DialogTitle>\n            <DialogDescription>\n              Complete information about this payment transaction\n            </DialogDescription>\n          </DialogHeader>\n\n          {selectedPayment && (\n            <div className=\"space-y-4\">\n              {/* Customer Info */}\n              <div className=\"p-4 bg-muted/50 rounded-lg\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Customer Information</h3>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Customer Name</p>\n                    <p className=\"font-medium\">{selectedPayment.customer?.name || selectedPayment.customerName || 'N/A'}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Phone</p>\n                    <p className=\"font-mono text-sm\">{selectedPayment.customer?.phone || 'N/A'}</p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Payment Info */}\n              <div className=\"p-4 bg-muted/50 rounded-lg\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Payment Information</h3>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Amount</p>\n                    <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                      Rs. {selectedPayment.amount.toLocaleString()}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Payment Date</p>\n                    <p className=\"font-medium\">{new Date(selectedPayment.paymentDate).toLocaleString()}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Payment Method</p>\n                    <Badge variant=\"outline\" className=\"mt-1\">\n                      {selectedPayment.paymentType || selectedPayment.paymentMethod}\n                    </Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Status</p>\n                    <Badge className={`mt-1 ${getStatusColor(selectedPayment.status)}`}>\n                      {selectedPayment.status}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n\n              {/* Transaction Details */}\n              {(selectedPayment.chequeNumber || selectedPayment.referenceNumber || selectedPayment.bank) && (\n                <div className=\"p-4 bg-muted/50 rounded-lg\">\n                  <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Transaction Details</h3>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    {selectedPayment.chequeNumber && (\n                      <div>\n                        <p className=\"text-xs text-muted-foreground\">Cheque Number</p>\n                        <p className=\"font-mono text-sm\">{selectedPayment.chequeNumber}</p>\n                      </div>\n                    )}\n                    {selectedPayment.referenceNumber && (\n                      <div>\n                        <p className=\"text-xs text-muted-foreground\">Reference Number</p>\n                        <p className=\"font-mono text-sm\">{selectedPayment.referenceNumber}</p>\n                      </div>\n                    )}\n                    {selectedPayment.bank && (\n                      <div className=\"col-span-2\">\n                        <p className=\"text-xs text-muted-foreground\">Bank Account</p>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <Building className=\"h-4 w-4 text-muted-foreground\" />\n                          <div>\n                            <p className=\"font-medium\">{selectedPayment.bank.name}</p>\n                            {selectedPayment.bank.accountNumber && (\n                              <p className=\"text-xs text-muted-foreground font-mono\">\n                                {selectedPayment.bank.accountNumber}\n                              </p>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {/* System Info */}\n              <div className=\"p-4 bg-muted/50 rounded-lg\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">System Information</h3>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Received By</p>\n                    <p className=\"font-medium\">{selectedPayment.receivedBy || selectedPayment.recordedBy}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Payment ID</p>\n                    <p className=\"font-mono text-xs text-muted-foreground\">{selectedPayment.id}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground\">Created At</p>\n                    <p className=\"text-sm\">{new Date(selectedPayment.createdAt).toLocaleString()}</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex justify-end\">\n            <Button variant=\"outline\" onClick={() => setIsDetailsOpen(false)}>\n              Close\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\credit\\sales\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":123,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":202,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":202,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { FileUploadStub } from '@/components/FileUploadStub'\nimport {\n  Users,\n  Building2,\n  DollarSign,\n  Calendar,\n  FileText,\n  Camera,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  Clock\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface CreditCustomer {\n  id: string\n  name: string\n  nicOrBrn: string\n  creditLimit: number\n  currentBalance: number\n  availableCredit: number\n  status: 'ACTIVE' | 'SUSPENDED' | 'INACTIVE'\n}\n\ninterface Fuel {\n  id: string\n  code: string\n  name: string\n  icon?: string | null\n  isActive: boolean\n}\n\ninterface CreditSale {\n  id: string\n  customerId: string\n  customerName?: string\n  stationId: string\n  stationName?: string\n  amount: number\n  saleDate: string\n  slipNumber: string\n  signedSlipUrl?: string\n  fuelId?: string\n  fuel?: Fuel\n  litres?: number\n  recordedBy: string\n  status: 'PENDING' | 'APPROVED' | 'REJECTED'\n  approvedBy?: string\n  approvedAt?: string\n  createdAt: string\n}\n\nexport default function CreditSalesPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [customers, setCustomers] = useState<CreditCustomer[]>([])\n  const [recentSales, setRecentSales] = useState<CreditSale[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const [selectedCustomer, setSelectedCustomer] = useState('')\n  const { selectedStation } = useStation()\n  const [amount, setAmount] = useState(0)\n  const [saleDate, setSaleDate] = useState<Date>(new Date())\n  const [slipNumber, setSlipNumber] = useState('')\n  const [fuelId, setFuelId] = useState('')\n  const [litres, setLitres] = useState('')\n  const [signedSlipFile, setSignedSlipFile] = useState<File | null>(null)\n  const [fuels, setFuels] = useState<Fuel[]>([])\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [stationsRes, customersRes, salesRes, fuelsRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/credit/customers?status=ACTIVE'),\n          fetch('/api/credit/sales?limit=10'),\n          fetch('/api/fuels')\n        ])\n\n        const stationsData = await stationsRes.json()\n        const customersData = await customersRes.json()\n        const salesData = await salesRes.json()\n        const fuelsData = await fuelsRes.json()\n\n        setStations(stationsData)\n        setFuels(fuelsData.filter((f: Fuel) => f.isActive))\n        setCustomers(customersData.map((customer: { id: string; name: string; creditLimit: number; currentBalance: number }) => ({\n          ...customer,\n          availableCredit: customer.creditLimit - customer.currentBalance\n        })))\n        setRecentSales(salesData)\n      } catch (err) {\n        setError('Failed to load initial data')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedCustomer || !selectedStation || amount <= 0 || !slipNumber) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    if (amount <= 0) {\n      setError('Amount must be greater than 0')\n      return\n    }\n\n    // Check customer credit limit\n    const customer = customers.find(c => c.id === selectedCustomer)\n    if (customer && amount > customer.availableCredit) {\n      setError(`Amount exceeds available credit limit of Rs. ${customer.availableCredit.toLocaleString()}`)\n      return\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/credit/sales', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          customerId: selectedCustomer,\n          stationId: selectedStation,\n          amount: amount,\n          saleDate: saleDate.toISOString(),\n          slipNumber,\n          fuelId: fuelId || undefined,\n          litres: litres ? parseFloat(litres) : undefined,\n          signedSlipUrl: signedSlipFile ? `uploads/credit-slips/${signedSlipFile.name}` : undefined,\n          recordedBy: typeof window !== 'undefined' ? localStorage.getItem('username') || 'System User' : 'System User'\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to record credit sale')\n      }\n\n      const newSale = await response.json()\n\n      // Add to recent sales list\n      setRecentSales(prev => [newSale, ...prev.slice(0, 9)])\n\n      // Update customer available credit\n      setCustomers(prev => prev.map(c =>\n        c.id === selectedCustomer\n          ? { ...c, currentBalance: c.currentBalance + amount, availableCredit: c.availableCredit - amount }\n          : c\n      ))\n\n      // Reset form\n      setSelectedCustomer('')\n      setAmount(0)\n      setSaleDate(new Date())\n      setSlipNumber('')\n      setFuelId('')\n      setLitres('')\n      setSignedSlipFile(null)\n\n      setSuccess('Credit sale recorded successfully!')\n\n      // Clear success message after 3 seconds\n      setTimeout(() => setSuccess(''), 3000)\n\n    } catch (err) {\n      setError('Failed to record credit sale')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'APPROVED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'PENDING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'REJECTED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const selectedCustomerData = customers.find(c => c.id === selectedCustomer)\n\n  const salesColumns: Column<CreditSale>[] = [\n    {\n      key: 'saleDate' as keyof CreditSale,\n      title: 'Date',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'customerName' as keyof CreditSale,\n      title: 'Customer',\n      render: (value: unknown, row: CreditSale) => {\n        const customer = customers.find(c => c.id === row.customerId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{customer?.name || (value as string)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'stationName' as keyof CreditSale,\n      title: 'Station',\n      render: (value: unknown, row: CreditSale) => {\n        const station = stations.find(s => s.id === row.stationId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{station?.name || (value as string)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'amount' as keyof CreditSale,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-mono font-semibold text-green-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'fuel' as keyof CreditSale,\n      title: 'Fuel Type',\n      render: (value: unknown, row: CreditSale) => (\n        row.fuel ? (\n          <div className=\"flex flex-col\">\n            <Badge variant=\"outline\">{row.fuel.icon} {row.fuel.name}</Badge>\n            {row.litres && (\n              <span className=\"text-xs text-muted-foreground mt-1\">\n                {row.litres}L\n              </span>\n            )}\n          </div>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'slipNumber' as keyof CreditSale,\n      title: 'Slip Number',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <FileText className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-mono text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'signedSlipUrl' as keyof CreditSale,\n      title: 'Signed Slip',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Camera className=\"h-4 w-4 text-muted-foreground\" />\n          <Badge variant={value ? 'default' : 'secondary'}>\n            {value ? 'Yes' : 'No'}\n          </Badge>\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof CreditSale,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    },\n    {\n      key: 'recordedBy' as keyof CreditSale,\n      title: 'Recorded By',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">{value as string}</span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Credit Sales</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Record New Credit Sale\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Customer and Station Selection */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"customer\">Customer *</Label>\n              <Select value={selectedCustomer} onValueChange={setSelectedCustomer} disabled={loading}>\n                <SelectTrigger id=\"customer\">\n                  <SelectValue placeholder=\"Select a customer\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {customers.map((customer) => (\n                    <SelectItem key={customer.id} value={customer.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Users className=\"h-4 w-4\" />\n                        <div className=\"flex flex-col\">\n                          <span className=\"font-medium\">{customer.name}</span>\n                          <span className=\"text-xs text-muted-foreground\">\n                            Available: Rs. {customer.availableCredit.toLocaleString()}\n                          </span>\n                        </div>\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {selectedCustomerData && (\n                <div className=\"mt-2 p-2 bg-blue-500/10 dark:bg-blue-500/20 rounded-md\">\n                  <div className=\"text-xs text-blue-700\">\n                    <div>Credit Limit: Rs. {selectedCustomerData.creditLimit.toLocaleString()}</div>\n                    <div>Current Balance: Rs. {selectedCustomerData.currentBalance.toLocaleString()}</div>\n                    <div className=\"font-semibold\">Available: Rs. {selectedCustomerData.availableCredit.toLocaleString()}</div>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            <div>\n              <Label htmlFor=\"station\">Station *</Label>\n              <Select value={selectedStation} onValueChange={() => { }} disabled={true}>\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select a station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {stations.map((station) => (\n                    <SelectItem key={station.id} value={station.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"h-4 w-4\" />\n                        {station.name} ({station.city})\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Sale Details */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <div>\n              <Label htmlFor=\"amount\">Amount (Rs.) *</Label>\n              <MoneyInput\n                id=\"amount\"\n                value={amount}\n                onChange={setAmount}\n                placeholder=\"0.00\"\n                disabled={loading}\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"saleDate\">Sale Date *</Label>\n              <DateTimePicker\n                value={saleDate}\n                onChange={(date) => setSaleDate(date || new Date())}\n                disabled={loading}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"slipNumber\">Slip Number *</Label>\n              <Input\n                id=\"slipNumber\"\n                value={slipNumber}\n                onChange={(e) => setSlipNumber(e.target.value)}\n                placeholder=\"SLP001234\"\n                disabled={loading}\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"fuelId\">Fuel Type</Label>\n              <Select value={fuelId} onValueChange={setFuelId} disabled={loading}>\n                <SelectTrigger id=\"fuelId\">\n                  <SelectValue placeholder=\"Select fuel type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {fuels.map((fuel) => (\n                    <SelectItem key={fuel.id} value={fuel.id}>\n                      {fuel.icon} {fuel.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Additional Details */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"litres\">Litres</Label>\n              <Input\n                id=\"litres\"\n                type=\"number\"\n                value={litres}\n                onChange={(e) => setLitres(e.target.value)}\n                placeholder=\"0.00\"\n                min=\"0\"\n                step=\"0.01\"\n                disabled={loading}\n              />\n            </div>\n          </div>\n\n          {/* Signed Slip Upload */}\n          <div>\n            <Label>Signed Slip Photo</Label>\n            <FileUploadStub\n              onFileSelect={setSignedSlipFile}\n              acceptedTypes={[\"image/*\"]}\n              placeholder=\"Upload signed slip photo (required for approval)\"\n            />\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Upload a clear photo of the signed credit slip for verification\n            </p>\n          </div>\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/credit')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Recording...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Record Sale\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent Credit Sales\" className=\"p-6\">\n        <DataTable\n          data={recentSales}\n          columns={salesColumns}\n          searchPlaceholder=\"Search credit sales...\"\n          emptyMessage=\"No credit sales recorded yet.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\dashboard\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadDashboardData'. Either include it or remove the dependency array.","line":65,"column":6,"nodeType":"ArrayExpression","endLine":65,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [loadDashboardData, selectedStation]","fix":{"range":[1599,1616],"text":"[loadDashboardData, selectedStation]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\deposits\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":32,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'slipPhoto' is assigned a value but never used.","line":87,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":87,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":106,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":106,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newDeposit' is assigned a value but never used.","line":148,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":148,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectedBankData' is assigned a value but never used.","line":185,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":185,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { FileUploadStub } from '@/components/FileUploadStub'\nimport {\n  Building2,\n  DollarSign,\n  Calendar,\n  User,\n  Building,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  Clock,\n  FileText,\n  Camera\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface BankAccount {\n  id: string\n  name: string\n  accountNumber: string | null\n  branch: string | null\n}\n\ninterface Deposit {\n  id: string\n  stationId: string\n  stationName?: string\n  bankAccountId: string\n  bankName?: string\n  accountNumber?: string\n  amount: number\n  depositDate: string\n  depositedBy: string\n  slipNumber?: string\n  slipPhotoUrl?: string\n  notes?: string\n  status: 'PENDING' | 'CONFIRMED' | 'REJECTED'\n  recordedBy: string\n  createdAt: string\n}\n\n// Mock bank accounts data - REMOVED, now using real banks from API\n\nexport default function DepositsPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [banks, setBanks] = useState<BankAccount[]>([])\n  const [recentDeposits, setRecentDeposits] = useState<Deposit[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const { selectedStation } = useStation()\n  const [selectedBankAccount, setSelectedBankAccount] = useState('')\n  const [amount, setAmount] = useState<number | undefined>(undefined)\n  const [depositDate, setDepositDate] = useState<Date>(new Date())\n  const [depositedBy, setDepositedBy] = useState('')\n  const [slipNumber, setSlipNumber] = useState('')\n  const [notes, setNotes] = useState('')\n  const [slipPhoto, setSlipPhoto] = useState<File | null>(null)\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [stationsRes, depositsRes, banksRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/deposits?limit=10'),\n          fetch('/api/banks?active=true')\n        ])\n\n        const stationsData = await stationsRes.json()\n        const depositsData = await depositsRes.json()\n        const banksData = await banksRes.json()\n\n        setStations(stationsData)\n        setRecentDeposits(depositsData)\n        setBanks(Array.isArray(banksData) ? banksData : [])\n      } catch (err) {\n        setError('Failed to load initial data')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !selectedBankAccount || !amount || amount <= 0 || !depositedBy) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const selectedBank = banks.find(b => b.id === selectedBankAccount)\n\n      const response = await fetch('/api/deposits', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          bankId: selectedBankAccount,\n          accountId: selectedBank?.accountNumber || selectedBankAccount,\n          amount: amount,\n          depositDate: depositDate.toISOString(),\n          depositedBy,\n          depositSlip: slipNumber || undefined\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to record deposit')\n      }\n\n      const newDeposit = await response.json()\n\n      // Reload deposits\n      const depositsRes = await fetch('/api/deposits?limit=10')\n      const depositsData = await depositsRes.json()\n      setRecentDeposits(depositsData)\n\n      // Reset form\n      setSelectedBankAccount('')\n      setAmount(undefined)\n      setDepositDate(new Date())\n      setDepositedBy('')\n      setSlipNumber('')\n      setNotes('')\n      setSlipPhoto(null)\n\n      setSuccess('Deposit recorded successfully! Money has been deducted from safe and added to bank account.')\n\n      // Clear success message after 5 seconds\n      setTimeout(() => setSuccess(''), 5000)\n\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to record deposit')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'CONFIRMED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'PENDING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'REJECTED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const selectedBankData = banks.find(b => b.id === selectedBankAccount)\n\n  const depositColumns: Column<Deposit>[] = [\n    {\n      key: 'depositDate' as keyof Deposit,\n      title: 'Date',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'stationName' as keyof Deposit,\n      title: 'Station',\n      render: (value: unknown, row: Deposit) => {\n        const station = stations.find(s => s.id === row.stationId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{station?.name || (value as string)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'bankName' as keyof Deposit,\n      title: 'Bank Account',\n      render: (value: unknown, row: Deposit) => {\n        const account = banks.find(acc => acc.id === row.bankAccountId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Building className=\"h-4 w-4 text-muted-foreground\" />\n            <div className=\"flex flex-col\">\n              <span className=\"font-medium\">{account?.name || (value as string)}</span>\n              <span className=\"text-xs text-muted-foreground\">\n                {account?.accountNumber ? `****${account.accountNumber.slice(-4)}` : ''}\n              </span>\n            </div>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'amount' as keyof Deposit,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-mono font-semibold text-green-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'depositedBy' as keyof Deposit,\n      title: 'Deposited By',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'slipNumber' as keyof Deposit,\n      title: 'Slip Number',\n      render: (value: unknown) => (\n        value ? (\n          <div className=\"flex items-center gap-2\">\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-mono text-sm\">{value as string}</span>\n          </div>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'slipPhotoUrl' as keyof Deposit,\n      title: 'Slip Photo',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Camera className=\"h-4 w-4 text-muted-foreground\" />\n          <Badge variant={value ? 'default' : 'secondary'}>\n            {value ? 'Yes' : 'No'}\n          </Badge>\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof Deposit,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    },\n    {\n      key: 'notes' as keyof Deposit,\n      title: 'Notes',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground max-w-xs truncate\">\n          {value as string || '-'}\n        </span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Bank Deposits</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Record New Deposit\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Station and Bank Account */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"station\">Station *</Label>\n              <Select value={selectedStation} onValueChange={() => { }} disabled={true}>\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select a station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {stations.map((station) => (\n                    <SelectItem key={station.id} value={station.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"h-4 w-4\" />\n                        {station.name} ({station.city})\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"bankAccount\">Bank Account *</Label>\n              <Select value={selectedBankAccount} onValueChange={setSelectedBankAccount} disabled={loading}>\n                <SelectTrigger id=\"bankAccount\">\n                  <SelectValue placeholder=\"Select bank account\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {banks.length === 0 ? (\n                    <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">No bank accounts available</div>\n                  ) : (\n                    banks.map((bank) => (\n                      <SelectItem key={bank.id} value={bank.id}>\n                        <div className=\"flex items-center gap-2\">\n                          <Building className=\"h-4 w-4\" />\n                          <div className=\"flex flex-col\">\n                            <span className=\"font-medium\">{bank.name}</span>\n                            {bank.branch && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                {bank.branch}{bank.accountNumber && ` - ${bank.accountNumber}`}\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </SelectItem>\n                    ))\n                  )}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Amount and Deposited By */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"amount\">Deposit Amount (Rs.) *</Label>\n              <MoneyInput\n                id=\"amount\"\n                value={amount}\n                onChange={setAmount}\n                placeholder=\"0.00\"\n                disabled={loading}\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"depositedBy\">Deposited By *</Label>\n              <Input\n                id=\"depositedBy\"\n                value={depositedBy}\n                onChange={(e) => setDepositedBy(e.target.value)}\n                placeholder=\"Name of person who made the deposit\"\n                disabled={loading}\n                required\n              />\n            </div>\n          </div>\n\n          {/* Date and Slip Number */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"depositDate\">Deposit Date *</Label>\n              <DateTimePicker\n                value={depositDate}\n                onChange={(date) => date && setDepositDate(date)}\n                disabled={loading}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"slipNumber\">Deposit Slip Number</Label>\n              <Input\n                id=\"slipNumber\"\n                value={slipNumber}\n                onChange={(e) => setSlipNumber(e.target.value)}\n                placeholder=\"Bank slip reference number\"\n                disabled={loading}\n              />\n            </div>\n          </div>\n\n          {/* Notes */}\n          <div>\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Input\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Additional details about the deposit...\"\n              disabled={loading}\n            />\n          </div>\n\n          {/* Slip Photo Upload */}\n          <div>\n            <Label>Deposit Slip Photo</Label>\n            <FileUploadStub\n              onFileSelect={setSlipPhoto}\n              acceptedTypes={[\"image/*\"]}\n              placeholder=\"Upload photo of deposit slip (recommended)\"\n            />\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Upload a clear photo of the bank deposit slip for verification\n            </p>\n          </div>\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/safe')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Recording...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Record Deposit\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent Deposits\" className=\"p-6\">\n        <DataTable\n          data={recentDeposits}\n          columns={depositColumns}\n          searchPlaceholder=\"Search deposits...\"\n          emptyMessage=\"No deposits recorded yet.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\expenses\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":110,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":110,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":177,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":177,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { Checkbox } from '@/components/ui/checkbox'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { FileUploadStub } from '@/components/FileUploadStub'\nimport {\n  Building2,\n  DollarSign,\n  Calendar,\n  FileText,\n  Camera,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  Clock,\n  Shield,\n  User,\n  Tag\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface Expense {\n  id: string\n  stationId: string\n  stationName?: string\n  category: string\n  amount: number\n  fromSafe: boolean\n  approvedBy: string\n  proofUrl?: string\n  expenseDate: string\n  description?: string\n  recordedBy: string\n  status: 'PENDING' | 'APPROVED' | 'REJECTED'\n  createdAt: string\n}\n\nconst expenseCategories = [\n  'Fuel Transport',\n  'Equipment Maintenance',\n  'Utilities (Electricity/Water)',\n  'Staff Salaries',\n  'Office Supplies',\n  'Marketing/Advertising',\n  'Insurance',\n  'Licenses & Permits',\n  'Cleaning Supplies',\n  'Security Services',\n  'Vehicle Maintenance',\n  'Repairs & Renovations',\n  'Professional Services',\n  'Miscellaneous'\n]\n\nexport default function ExpensesPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [recentExpenses, setRecentExpenses] = useState<Expense[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const { selectedStation } = useStation()\n  const [category, setCategory] = useState('')\n  const [amount, setAmount] = useState<number | undefined>(undefined)\n  const [fromSafe, setFromSafe] = useState(false)\n  const [approvedBy, setApprovedBy] = useState('')\n  const [expenseDate, setExpenseDate] = useState<Date>(new Date())\n  const [description, setDescription] = useState('')\n  const [proofFile, setProofFile] = useState<File | null>(null)\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [stationsRes, expensesRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/expenses?limit=10')\n        ])\n\n        const stationsData = await stationsRes.json()\n        const expensesData = await expensesRes.json()\n\n        setStations(stationsData)\n        setRecentExpenses(expensesData)\n      } catch (_err) {\n        setError('Failed to load initial data')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !category || !amount || !approvedBy) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    if (!amount || amount <= 0) {\n      setError('Amount must be greater than 0')\n      return\n    }\n\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/expenses', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          category,\n          amount: amount,\n          fromSafe,\n          approvedBy,\n          expenseDate: expenseDate.toISOString(),\n          description: description || undefined,\n          proofUrl: proofFile ? `uploads/expenses/${proofFile.name}` : undefined,\n          recordedBy: typeof window !== 'undefined' ? localStorage.getItem('username') || 'System User' : 'System User'\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to record expense')\n      }\n\n      const newExpense = await response.json()\n\n      // Add to recent expenses list\n      setRecentExpenses(prev => [newExpense, ...prev.slice(0, 9)])\n\n      // Reset form\n      // setSelectedStation('') - handled by context/read-only in this current logic\n      setCategory('')\n      setAmount(undefined)\n      setFromSafe(false)\n      setApprovedBy('')\n      setExpenseDate(new Date())\n      setDescription('')\n      setProofFile(null)\n\n      setSuccess('Expense recorded successfully!')\n\n      // Clear success message after 3 seconds\n      setTimeout(() => setSuccess(''), 3000)\n\n    } catch (_err) {\n      setError('Failed to record expense')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'APPROVED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'PENDING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'REJECTED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getCategoryColor = (category: string) => {\n    const colors = [\n      'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300',\n      'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300',\n      'bg-purple-500/20 text-purple-400 dark:bg-purple-600/30 dark:text-purple-300',\n      'bg-orange-500/20 text-orange-400 dark:bg-orange-600/30 dark:text-orange-300',\n      'bg-pink-500/20 text-pink-600 dark:bg-pink-600/30 dark:text-pink-300',\n      'bg-indigo-500/20 text-indigo-600 dark:bg-indigo-600/30 dark:text-indigo-300'\n    ]\n    const index = category.length % colors.length\n    return colors[index]\n  }\n\n  const expenseColumns: Column<Expense>[] = [\n    {\n      key: 'expenseDate' as keyof Expense,\n      title: 'Date',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'stationName' as keyof Expense,\n      title: 'Station',\n      render: (value: unknown, row: Expense) => {\n        const station = stations.find(s => s.id === row.stationId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{station?.name || (value as string)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'category' as keyof Expense,\n      title: 'Category',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Tag className=\"h-4 w-4 text-muted-foreground\" />\n          <Badge className={getCategoryColor(value as string)}>\n            {value as string}\n          </Badge>\n        </div>\n      )\n    },\n    {\n      key: 'amount' as keyof Expense,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n          <span className=\"font-mono font-semibold text-red-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'fromSafe' as keyof Expense,\n      title: 'From Safe',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Shield className=\"h-4 w-4 text-muted-foreground\" />\n          <Badge variant={value ? 'default' : 'secondary'}>\n            {value ? 'Yes' : 'No'}\n          </Badge>\n        </div>\n      )\n    },\n    {\n      key: 'approvedBy' as keyof Expense,\n      title: 'Approved By',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'proofUrl' as keyof Expense,\n      title: 'Proof',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Camera className=\"h-4 w-4 text-muted-foreground\" />\n          <Badge variant={value ? 'default' : 'secondary'}>\n            {value ? 'Yes' : 'No'}\n          </Badge>\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof Expense,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    },\n    {\n      key: 'description' as keyof Expense,\n      title: 'Description',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground max-w-xs truncate\">\n          {value as string || '-'}\n        </span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Expenses</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Record New Expense\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Station and Category */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"station\">Station *</Label>\n              <Select value={selectedStation} onValueChange={() => { }} disabled={true}>\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select a station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {stations.map((station) => (\n                    <SelectItem key={station.id} value={station.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"h-4 w-4\" />\n                        {station.name} ({station.city})\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"category\">Category *</Label>\n              <Select value={category} onValueChange={setCategory} disabled={loading}>\n                <SelectTrigger id=\"category\">\n                  <SelectValue placeholder=\"Select expense category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {expenseCategories.map((cat) => (\n                    <SelectItem key={cat} value={cat}>\n                      <div className=\"flex items-center gap-2\">\n                        <Tag className=\"h-4 w-4\" />\n                        {cat}\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Amount and Date */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"amount\">Amount (Rs.) *</Label>\n              <MoneyInput\n                id=\"amount\"\n                value={amount}\n                onChange={setAmount}\n                placeholder=\"0.00\"\n                disabled={loading}\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"expenseDate\">Expense Date *</Label>\n              <DateTimePicker\n                value={expenseDate}\n                onChange={(date) => date && setExpenseDate(date)}\n                disabled={loading}\n              />\n            </div>\n          </div>\n\n          {/* From Safe and Approved By */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox\n                id=\"fromSafe\"\n                checked={fromSafe}\n                onCheckedChange={(checked) => setFromSafe(checked as boolean)}\n                disabled={loading}\n              />\n              <Label htmlFor=\"fromSafe\" className=\"flex items-center gap-2\">\n                <Shield className=\"h-4 w-4\" />\n                Paid from Safe\n              </Label>\n            </div>\n\n            <div>\n              <Label htmlFor=\"approvedBy\">Approved By *</Label>\n              <Input\n                id=\"approvedBy\"\n                value={approvedBy}\n                onChange={(e) => setApprovedBy(e.target.value)}\n                placeholder=\"Manager/Owner name\"\n                disabled={loading}\n                required\n              />\n            </div>\n          </div>\n\n          {/* Description */}\n          <div>\n            <Label htmlFor=\"description\">Description</Label>\n            <Input\n              id=\"description\"\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              placeholder=\"Additional details about the expense...\"\n              disabled={loading}\n            />\n          </div>\n\n          {/* Proof Upload */}\n          <div>\n            <Label>Proof/Receipt</Label>\n            <FileUploadStub\n              onFileSelect={setProofFile}\n              acceptedTypes={[\"image/*\", \".pdf\"]}\n              placeholder=\"Upload receipt or proof of expense\"\n            />\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Upload receipt, invoice, or other proof of expense (Image or PDF)\n            </p>\n          </div>\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/safe')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Recording...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Record Expense\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent Expenses\" className=\"p-6\">\n        <DataTable\n          data={recentExpenses}\n          columns={expenseColumns}\n          searchPlaceholder=\"Search expenses...\"\n          emptyMessage=\"No expenses recorded yet.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\loans\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":19,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Building2' is defined but never used.","line":20,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":23,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":85,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":85,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAllLoans'. Either include it or remove the dependency array.","line":108,"column":6,"nodeType":"ArrayExpression","endLine":108,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchAllLoans, selectedStation]","fix":{"range":[3177,3194],"text":"[fetchAllLoans, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { useToast } from '@/hooks/use-toast'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport {\n  CreditCard,\n  DollarSign,\n  User,\n  Building2,\n  Calendar,\n  CheckCircle,\n  AlertCircle,\n  RefreshCw,\n  Eye\n} from 'lucide-react'\n\ninterface PumperLoan {\n  id: string\n  pumperName: string\n  amount: number\n  paidAmount?: number\n  monthlyRental?: number\n  reason: string\n  givenBy?: string\n  dueDate: string\n  status: 'ACTIVE' | 'PAID' | 'OVERDUE'\n  createdAt: string\n  station?: {\n    id: string\n    name: string\n  }\n}\n\ninterface ExternalLoan {\n  id: string\n  borrowerName: string\n  amount: number\n  dueDate: string\n  status: 'ACTIVE' | 'PAID' | 'OVERDUE'\n  createdAt: string\n  station?: {\n    id: string\n    name: string\n  }\n}\n\ninterface OfficeStaffLoan {\n  id: string\n  staffName: string\n  amount: number\n  paidAmount?: number\n  monthlyRental?: number\n  reason: string\n  givenBy?: string\n  dueDate: string\n  status: 'ACTIVE' | 'PAID' | 'OVERDUE'\n  createdAt: string\n  station?: {\n    id: string\n    name: string\n  }\n}\n\ninterface LoanPayment {\n  id: string\n  amount: number\n  description: string\n  performedBy: string\n  timestamp: string\n  balanceAfter: number\n}\n\nexport default function LoansPage() {\n  const router = useRouter()\n  const { selectedStation } = useStation()\n  const [loading, setLoading] = useState(false)\n  const { toast } = useToast()\n\n  const [pumperLoans, setPumperLoans] = useState<PumperLoan[]>([])\n  const [externalLoans, setExternalLoans] = useState<ExternalLoan[]>([])\n  const [officeStaffLoans, setOfficeStaffLoans] = useState<OfficeStaffLoan[]>([])\n  const [selectedLoan, setSelectedLoan] = useState<{ id: string; type: 'PUMPER' | 'EXTERNAL' | 'OFFICE'; name: string } | null>(null)\n  const [loanPayments, setLoanPayments] = useState<LoanPayment[]>([])\n  const [paymentsDialogOpen, setPaymentsDialogOpen] = useState(false)\n\n  // Payment dialog state\n  const [paymentDialogOpen, setPaymentDialogOpen] = useState(false)\n  const [selectedLoanForPayment, setSelectedLoanForPayment] = useState<{ id: string; type: 'PUMPER' | 'EXTERNAL' | 'OFFICE'; name: string; amount: number; paidAmount?: number } | null>(null)\n  const [paymentAmount, setPaymentAmount] = useState<number | undefined>(undefined)\n  const [paymentNotes, setPaymentNotes] = useState('')\n  const [processingPayment, setProcessingPayment] = useState(false)\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchAllLoans()\n    }\n  }, [selectedStation])\n\n  const fetchAllLoans = async () => {\n    if (!selectedStation) return\n\n    try {\n      setLoading(true)\n\n\n      const [pumperRes, externalRes, officeRes] = await Promise.all([\n        fetch(`/api/loans/pumper?stationId=${selectedStation}`),\n        fetch(`/api/loans/external?stationId=${selectedStation}`),\n        fetch(`/api/loans/office?stationId=${selectedStation}`)\n      ])\n\n      if (pumperRes.ok) {\n        const pumperData = await pumperRes.json()\n        setPumperLoans(pumperData)\n      }\n\n      if (externalRes.ok) {\n        const externalData = await externalRes.json()\n        setExternalLoans(externalData)\n      }\n\n      if (officeRes.ok) {\n        const officeData = await officeRes.json()\n        setOfficeStaffLoans(officeData)\n      }\n    } catch (err) {\n      console.error('Error fetching loans:', err)\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch loans\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const fetchLoanPayments = async (loanId: string, loanType: 'PUMPER' | 'EXTERNAL' | 'OFFICE') => {\n    try {\n      const res = await fetch(`/api/loans/payments?stationId=${selectedStation}&loanId=${loanId}&loanType=${loanType}`)\n      if (res.ok) {\n        const data = await res.json()\n        setLoanPayments(data)\n      }\n    } catch (err) {\n      console.error('Error fetching loan payments:', err)\n    }\n  }\n\n  const handleViewPayments = (loan: PumperLoan | ExternalLoan | OfficeStaffLoan, type: 'PUMPER' | 'EXTERNAL' | 'OFFICE') => {\n    const loanName = type === 'PUMPER' ? (loan as PumperLoan).pumperName :\n      type === 'OFFICE' ? (loan as OfficeStaffLoan).staffName :\n        (loan as ExternalLoan).borrowerName\n    setSelectedLoan({ id: loan.id, type, name: loanName })\n    fetchLoanPayments(loan.id, type)\n    setPaymentsDialogOpen(true)\n  }\n\n  const handlePayLoan = (loan: PumperLoan | ExternalLoan | OfficeStaffLoan, type: 'PUMPER' | 'EXTERNAL' | 'OFFICE') => {\n    const loanName = type === 'PUMPER' ? (loan as PumperLoan).pumperName :\n      type === 'OFFICE' ? (loan as OfficeStaffLoan).staffName :\n        (loan as ExternalLoan).borrowerName\n    const typedLoan = loan as (PumperLoan | OfficeStaffLoan)\n    const paidAmount = (type === 'PUMPER' || type === 'OFFICE') ? (typedLoan.paidAmount || 0) : 0\n    const remainingAmount = (type === 'PUMPER' || type === 'OFFICE') ? (typedLoan.amount - paidAmount) : loan.amount\n\n    setSelectedLoanForPayment({\n      id: loan.id,\n      type,\n      name: loanName,\n      amount: loan.amount,\n      paidAmount: paidAmount\n    })\n    // Default to remaining amount if there's a remaining balance, otherwise allow full amount\n    setPaymentAmount(remainingAmount > 0 ? remainingAmount : undefined)\n    setPaymentNotes('')\n    setPaymentDialogOpen(true)\n  }\n\n  const handleProcessPayment = async () => {\n    if (!selectedLoanForPayment || paymentAmount === undefined || paymentAmount <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter a valid payment amount\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (!selectedStation) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a station\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      setProcessingPayment(true)\n\n\n      const username = typeof window !== 'undefined' ? localStorage.getItem('username') || 'System' : 'System'\n\n      let res\n      if (selectedLoanForPayment.type === 'PUMPER') {\n        res = await fetch(`/api/loans/pumper/${selectedLoanForPayment.id}/pay`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            stationId: selectedStation,\n            amount: paymentAmount,\n            notes: paymentNotes || undefined,\n            performedBy: username\n          })\n        })\n      } else if (selectedLoanForPayment.type === 'OFFICE') {\n        res = await fetch(`/api/loans/office/${selectedLoanForPayment.id}/pay`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            stationId: selectedStation,\n            amount: paymentAmount,\n            notes: paymentNotes || undefined,\n            performedBy: username\n          })\n        })\n      } else {\n        // External loan payment - need to create endpoint\n        toast({\n          title: \"Error\",\n          description: \"External loan payment not yet implemented\",\n          variant: \"destructive\"\n        })\n        return\n      }\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to process loan payment')\n      }\n\n      await fetchAllLoans()\n\n      setPaymentDialogOpen(false)\n      setSelectedLoanForPayment(null)\n      setPaymentAmount(undefined)\n      setPaymentNotes('')\n      toast({\n        title: \"Success\",\n        description: \"Loan payment processed successfully! Money has been added to safe.\"\n      })\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: err instanceof Error ? err.message : 'Failed to process loan payment',\n        variant: \"destructive\"\n      })\n    } finally {\n      setProcessingPayment(false)\n    }\n  }\n\n  const activePumperLoans = pumperLoans.filter(l => l.status === 'ACTIVE')\n  const paidPumperLoans = pumperLoans.filter(l => l.status === 'PAID')\n  const activeExternalLoans = externalLoans.filter(l => l.status === 'ACTIVE')\n  const paidExternalLoans = externalLoans.filter(l => l.status === 'PAID')\n\n  const totalActivePumper = activePumperLoans.reduce((sum, l) => sum + l.amount, 0)\n  const totalActiveExternal = activeExternalLoans.reduce((sum, l) => sum + l.amount, 0)\n  const totalMonthlyRental = activePumperLoans.reduce((sum, l) => sum + (l.monthlyRental || 0), 0)\n\n  return (\n    <div className=\"container mx-auto py-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Loans Management</h1>\n          <p className=\"text-muted-foreground mt-1\">View and manage all loans and payments</p>\n        </div>\n        <Button onClick={fetchAllLoans} variant=\"outline\" disabled={loading}>\n          <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\n          Refresh\n        </Button>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Active Pumper Loans</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activePumperLoans.length}</div>\n            <div className=\"text-sm text-muted-foreground mt-1\">\n              Rs. {totalActivePumper.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Monthly Rental</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\">\n              Rs. {totalMonthlyRental.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Active External Loans</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activeExternalLoans.length}</div>\n            <div className=\"text-sm text-muted-foreground mt-1\">\n              Rs. {totalActiveExternal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Paid</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\">\n              {paidPumperLoans.length + paidExternalLoans.length}\n            </div>\n            <div className=\"text-sm text-muted-foreground mt-1\">Loans fully paid</div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Messages */}\n\n\n      {/* Loans Tabs */}\n      <Tabs defaultValue=\"pumper\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"pumper\">\n            Pumper Loans ({pumperLoans.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"external\">\n            External Loans ({externalLoans.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"office\">\n            Office Staff Loans ({officeStaffLoans.length})\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Pumper Loans */}\n        <TabsContent value=\"pumper\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Active Pumper Loans</CardTitle>\n              <CardDescription>Loans given to pumpers that are currently active</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600\"></div>\n                </div>\n              ) : activePumperLoans.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CreditCard className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n                  <p>No active pumper loans</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Pumper</TableHead>\n                        <TableHead className=\"text-right\">Loan Amount</TableHead>\n                        <TableHead className=\"text-right\">Paid</TableHead>\n                        <TableHead className=\"text-right\">Remaining</TableHead>\n                        <TableHead className=\"text-right\">Monthly Rental</TableHead>\n                        <TableHead>Reason</TableHead>\n                        <TableHead>Given By</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {activePumperLoans.map((loan) => {\n                        const paidAmount = loan.paidAmount || 0\n                        const remainingAmount = loan.amount - paidAmount\n                        return (\n                          <TableRow key={loan.id}>\n                            <TableCell className=\"font-medium\">{loan.pumperName}</TableCell>\n                            <TableCell className=\"text-right font-mono\">\n                              Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono text-green-600\">\n                              Rs. {paidAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono font-semibold text-orange-600\">\n                              Rs. {remainingAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono\">\n                              Rs. {(loan.monthlyRental || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"max-w-xs truncate\" title={loan.reason}>\n                              {loan.reason}\n                            </TableCell>\n                            <TableCell>{loan.givenBy || '-'}</TableCell>\n                            <TableCell>{new Date(loan.dueDate).toLocaleDateString()}</TableCell>\n                            <TableCell>\n                              <Badge variant={loan.status === 'ACTIVE' ? 'default' : loan.status === 'PAID' ? 'secondary' : 'destructive'}>\n                                {loan.status}\n                              </Badge>\n                            </TableCell>\n                            <TableCell className=\"text-right\">\n                              <div className=\"flex justify-end gap-2\">\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => handleViewPayments(loan, 'PUMPER')}\n                                >\n                                  <Eye className=\"h-4 w-4 mr-1\" />\n                                  Payments\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"default\"\n                                  onClick={() => handlePayLoan(loan, 'PUMPER')}\n                                >\n                                  <DollarSign className=\"h-4 w-4 mr-1\" />\n                                  Pay\n                                </Button>\n                              </div>\n                            </TableCell>\n                          </TableRow>\n                        )\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {paidPumperLoans.length > 0 && (\n            <Card>\n              <CardHeader>\n                <CardTitle>Paid Pumper Loans</CardTitle>\n                <CardDescription>Loans that have been fully paid</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Pumper</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                        <TableHead className=\"text-right\">Monthly Rental</TableHead>\n                        <TableHead>Reason</TableHead>\n                        <TableHead>Given By</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {paidPumperLoans.map((loan) => (\n                        <TableRow key={loan.id}>\n                          <TableCell className=\"font-medium\">{loan.pumperName}</TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            Rs. {(loan.monthlyRental || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell className=\"max-w-xs truncate\" title={loan.reason}>\n                            {loan.reason}\n                          </TableCell>\n                          <TableCell>{loan.givenBy || '-'}</TableCell>\n                          <TableCell>{new Date(loan.dueDate).toLocaleDateString()}</TableCell>\n                          <TableCell>\n                            <Badge variant=\"secondary\">{loan.status}</Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleViewPayments(loan, 'PUMPER')}\n                            >\n                              <Eye className=\"h-4 w-4 mr-1\" />\n                              Payments\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        {/* External Loans */}\n        <TabsContent value=\"external\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Active External Loans</CardTitle>\n              <CardDescription>Loans given to external parties that are currently active</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600\"></div>\n                </div>\n              ) : activeExternalLoans.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CreditCard className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n                  <p>No active external loans</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Borrower</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {activeExternalLoans.map((loan) => (\n                        <TableRow key={loan.id}>\n                          <TableCell className=\"font-medium\">{loan.borrowerName}</TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell>{new Date(loan.dueDate).toLocaleDateString()}</TableCell>\n                          <TableCell>\n                            <Badge variant={loan.status === 'ACTIVE' ? 'default' : loan.status === 'PAID' ? 'secondary' : 'destructive'}>\n                              {loan.status}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <div className=\"flex justify-end gap-2\">\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => handleViewPayments(loan, 'EXTERNAL')}\n                              >\n                                <Eye className=\"h-4 w-4 mr-1\" />\n                                Payments\n                              </Button>\n                              <Button\n                                size=\"sm\"\n                                variant=\"default\"\n                                onClick={() => handlePayLoan(loan, 'EXTERNAL')}\n                              >\n                                <DollarSign className=\"h-4 w-4 mr-1\" />\n                                Pay\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {paidExternalLoans.length > 0 && (\n            <Card>\n              <CardHeader>\n                <CardTitle>Paid External Loans</CardTitle>\n                <CardDescription>External loans that have been fully paid</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Borrower</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {paidExternalLoans.map((loan) => (\n                        <TableRow key={loan.id}>\n                          <TableCell className=\"font-medium\">{loan.borrowerName}</TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell>{new Date(loan.dueDate).toLocaleDateString()}</TableCell>\n                          <TableCell>\n                            <Badge variant=\"secondary\">{loan.status}</Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleViewPayments(loan, 'EXTERNAL')}\n                            >\n                              <Eye className=\"h-4 w-4 mr-1\" />\n                              Payments\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        {/* Office Staff Loans */}\n        <TabsContent value=\"office\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Active Office Staff Loans</CardTitle>\n              <CardDescription>Loans given to office staff that are currently active</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {loading ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600\"></div>\n                </div>\n              ) : officeStaffLoans.filter(l => l.status === 'ACTIVE').length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CreditCard className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n                  <p>No active office staff loans</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Staff Name</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                        <TableHead className=\"text-right\">Paid</TableHead>\n                        <TableHead className=\"text-right\">Balance</TableHead>\n                        <TableHead className=\"text-right\">Monthly Rental</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {officeStaffLoans.filter(l => l.status === 'ACTIVE').map((loan) => {\n                        const balance = loan.amount - (loan.paidAmount || 0)\n                        return (\n                          <TableRow key={loan.id}>\n                            <TableCell className=\"font-medium\">{loan.staffName}</TableCell>\n                            <TableCell className=\"text-right font-mono\">\n                              Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono text-green-600 dark:text-green-400\">\n                              Rs. {(loan.paidAmount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono font-bold text-orange-600 dark:text-orange-400\">\n                              Rs. {balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono\">\n                              Rs. {(loan.monthlyRental || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                            <TableCell>{new Date(loan.dueDate).toLocaleDateString()}</TableCell>\n                            <TableCell>\n                              <Badge variant={loan.status === 'ACTIVE' ? 'default' : loan.status === 'PAID' ? 'secondary' : 'destructive'}>\n                                {loan.status}\n                              </Badge>\n                            </TableCell>\n                            <TableCell className=\"text-right\">\n                              <div className=\"flex justify-end gap-2\">\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => handleViewPayments(loan, 'OFFICE')}\n                                >\n                                  <Eye className=\"h-4 w-4 mr-1\" />\n                                  Payments\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"default\"\n                                  onClick={() => handlePayLoan(loan, 'OFFICE')}\n                                  disabled={balance <= 0}\n                                >\n                                  <DollarSign className=\"h-4 w-4 mr-1\" />\n                                  Pay\n                                </Button>\n                              </div>\n                            </TableCell>\n                          </TableRow>\n                        )\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {officeStaffLoans.filter(l => l.status === 'PAID').length > 0 && (\n            <Card>\n              <CardHeader>\n                <CardTitle>Paid Office Staff Loans</CardTitle>\n                <CardDescription>Office staff loans that have been fully paid</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Staff Name</TableHead>\n                        <TableHead className=\"text-right\">Amount</TableHead>\n                        <TableHead>Due Date</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead className=\"text-right\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {officeStaffLoans.filter(l => l.status === 'PAID').map((loan) => (\n                        <TableRow key={loan.id}>\n                          <TableCell className=\"font-medium\">{loan.staffName}</TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                          </TableCell>\n                          <TableCell>{new Date(loan.dueDate).toLocaleDateString()}</TableCell>\n                          <TableCell>\n                            <Badge variant=\"secondary\">{loan.status}</Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleViewPayments(loan, 'OFFICE')}\n                            >\n                              <Eye className=\"h-4 w-4 mr-1\" />\n                              Payments\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Payment History Dialog */}\n      <Dialog open={paymentsDialogOpen} onOpenChange={setPaymentsDialogOpen}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Payment History - {selectedLoan?.name}</DialogTitle>\n            <DialogDescription>\n              All payments made for this loan\n            </DialogDescription>\n          </DialogHeader>\n          {loanPayments.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <DollarSign className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n              <p>No payments recorded for this loan</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Date</TableHead>\n                  <TableHead>Amount</TableHead>\n                  <TableHead>Description</TableHead>\n                  <TableHead>Paid By</TableHead>\n                  <TableHead>Balance After</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {loanPayments.map((payment) => (\n                  <TableRow key={payment.id}>\n                    <TableCell>{new Date(payment.timestamp).toLocaleString()}</TableCell>\n                    <TableCell className=\"font-mono font-semibold text-green-600\">\n                      Rs. {payment.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </TableCell>\n                    <TableCell>{payment.description}</TableCell>\n                    <TableCell>{payment.performedBy}</TableCell>\n                    <TableCell className=\"font-mono\">\n                      Rs. {payment.balanceAfter.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Payment Dialog */}\n      <Dialog open={paymentDialogOpen} onOpenChange={setPaymentDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Pay Loan - {selectedLoanForPayment?.name}</DialogTitle>\n            <DialogDescription>\n              Record a loan payment. This will add money to the safe and update the loan status.\n            </DialogDescription>\n          </DialogHeader>\n          {selectedLoanForPayment && (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg\">\n                <div className=\"text-sm font-medium mb-2\">Loan Details</div>\n                <div className=\"text-sm space-y-1 text-muted-foreground\">\n                  <div>Loan Amount: Rs. {selectedLoanForPayment.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                  {selectedLoanForPayment.paidAmount !== undefined && (\n                    <>\n                      <div>Paid: Rs. {selectedLoanForPayment.paidAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                      <div>Remaining: Rs. {(selectedLoanForPayment.amount - (selectedLoanForPayment.paidAmount || 0)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                    </>\n                  )}\n                  <div>Loan Type: {selectedLoanForPayment.type === 'PUMPER' ? 'Pumper Loan' : 'External Loan'}</div>\n                </div>\n              </div>\n              <div>\n                <Label>Payment Amount (Rs.)</Label>\n                <MoneyInput\n                  value={paymentAmount}\n                  onChange={(value) => setPaymentAmount(value)}\n                  placeholder=\"Enter payment amount\"\n                />\n                {selectedLoanForPayment.paidAmount !== undefined && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Remaining: Rs. {(selectedLoanForPayment.amount - (selectedLoanForPayment.paidAmount || 0)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </p>\n                )}\n                {selectedLoanForPayment.paidAmount === undefined && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Full amount: Rs. {selectedLoanForPayment.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </p>\n                )}\n              </div>\n              <div>\n                <Label>Notes (Optional)</Label>\n                <Textarea\n                  value={paymentNotes}\n                  onChange={(e) => setPaymentNotes(e.target.value)}\n                  placeholder=\"Add any notes about this payment\"\n                  rows={3}\n                />\n              </div>\n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setPaymentDialogOpen(false)\n                    setSelectedLoanForPayment(null)\n                    setPaymentAmount(undefined)\n                    setPaymentNotes('')\n                  }}\n                  disabled={processingPayment}\n                >\n                  Cancel\n                </Button>\n                <Button\n                  onClick={handleProcessPayment}\n                  disabled={processingPayment || paymentAmount === undefined || paymentAmount <= 0}\n                >\n                  {processingPayment ? 'Processing...' : 'Pay Loan'}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\notifications\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Settings' is defined but never used.","line":26,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Sparkles' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generating' is assigned a value but never used.","line":69,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":69,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'generateNotifications' and 'loadNotifications'. Either include them or remove the dependency array.","line":172,"column":6,"nodeType":"ArrayExpression","endLine":172,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [generateNotifications, loadNotifications, selectedStation]","fix":{"range":[5240,5257],"text":"[generateNotifications, loadNotifications, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Badge } from '@/components/ui/badge'\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport {\n  Bell,\n  AlertTriangle,\n  Clock,\n  CheckCircle,\n  XCircle,\n  Search,\n  MoreVertical,\n  Trash2,\n  Eye,\n  EyeOff,\n  Settings,\n  RefreshCw,\n  Sparkles\n} from 'lucide-react'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\n\ninterface Notification {\n  id: string\n  title: string\n  message: string\n  type: 'INFO' | 'SUCCESS' | 'WARNING' | 'ERROR'\n  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'\n  category: 'SYSTEM' | 'OPERATIONS' | 'FINANCIAL' | 'MAINTENANCE' | 'TANK' | 'SHIFT' | 'CREDIT' | 'POS'\n  isRead: boolean\n  actionUrl?: string | null\n  metadata?: Record<string, unknown> | null\n  createdAt: string\n  readAt?: string | null\n  station?: {\n    id: string\n    name: string\n  } | null\n}\n\ninterface NotificationPagination {\n  total: number\n  unread: number\n  limit: number\n  offset: number\n}\n\nexport default function NotificationsPage() {\n  const router = useRouter()\n  const { selectedStation } = useStation()\n  const [notifications, setNotifications] = useState<Notification[]>([])\n  const [filteredNotifications, setFilteredNotifications] = useState<Notification[]>([])\n  const [pagination, setPagination] = useState<NotificationPagination | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [generating, setGenerating] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n  const [searchTerm, setSearchTerm] = useState('')\n  const [filterType, setFilterType] = useState('all')\n  const [filterPriority, setFilterPriority] = useState('all')\n  const [filterCategory, setFilterCategory] = useState('all')\n  const [activeTab, setActiveTab] = useState('all')\n\n  // Load notifications from API\n  const loadNotifications = async () => {\n    try {\n      setLoading(true)\n      setError('')\n\n      const params = new URLSearchParams()\n      if (selectedStation && selectedStation !== 'all') {\n        params.append('stationId', selectedStation)\n      }\n      params.append('limit', '100')\n\n      const response = await fetch(`/api/notifications?${params.toString()}`)\n      const data = await response.json()\n\n      // Handle migration required case\n      if (data.migrationRequired) {\n        setError(`Database migration required: ${data.migrationCommand || 'npx prisma migrate dev --name add_notifications'}`)\n        setNotifications([])\n        setPagination({\n          total: 0,\n          unread: 0,\n          limit: 100,\n          offset: 0\n        })\n        return\n      }\n\n      if (!response.ok && !data.notifications) {\n        const errorMsg = data.details || data.error || 'Failed to load notifications'\n        throw new Error(errorMsg)\n      }\n\n      setNotifications(data.notifications || [])\n      setPagination(data.pagination || null)\n    } catch (err) {\n      console.error('Failed to load notifications:', err)\n      setError('Failed to load notifications')\n      setNotifications([])\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Generate notifications based on system events\n  const generateNotifications = async () => {\n    try {\n      setGenerating(true)\n      setError('')\n      setSuccess('')\n\n      const params = new URLSearchParams()\n      if (selectedStation && selectedStation !== 'all') {\n        params.append('stationId', selectedStation)\n      }\n\n      const response = await fetch(`/api/notifications/generate?${params.toString()}`, {\n        method: 'POST'\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to generate notifications')\n      }\n\n      const data = await response.json()\n      setSuccess(`Generated ${data.generated} new notification${data.generated !== 1 ? 's' : ''}`)\n\n      // Reload notifications after generation\n      await loadNotifications()\n    } catch (err) {\n      console.error('Failed to generate notifications:', err)\n      setError('Failed to generate notifications')\n    } finally {\n      setGenerating(false)\n    }\n  }\n\n  // Load notifications on mount and when station changes\n  useEffect(() => {\n    // Auto-generate notifications first, then load them\n    const initializeNotifications = async () => {\n      await generateNotifications()\n      await loadNotifications()\n    }\n\n    initializeNotifications()\n\n    // Auto-refresh and regenerate every 5 minutes\n    const interval = setInterval(async () => {\n      await generateNotifications()\n      await loadNotifications()\n    }, 5 * 60 * 1000)\n\n    return () => clearInterval(interval)\n  }, [selectedStation])\n\n  // Filter notifications based on search and filters\n  useEffect(() => {\n    let filtered = notifications\n\n    // Filter by tab (read/unread)\n    if (activeTab === 'unread') {\n      filtered = filtered.filter(n => !n.isRead)\n    } else if (activeTab === 'read') {\n      filtered = filtered.filter(n => n.isRead)\n    }\n\n    // Filter by search term\n    if (searchTerm) {\n      filtered = filtered.filter(n =>\n        n.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        n.message.toLowerCase().includes(searchTerm.toLowerCase())\n      )\n    }\n\n    // Filter by type\n    if (filterType !== 'all') {\n      filtered = filtered.filter(n => n.type === filterType)\n    }\n\n    // Filter by priority\n    if (filterPriority !== 'all') {\n      filtered = filtered.filter(n => n.priority === filterPriority)\n    }\n\n    // Filter by category\n    if (filterCategory !== 'all') {\n      filtered = filtered.filter(n => n.category === filterCategory)\n    }\n\n    setFilteredNotifications(filtered)\n  }, [notifications, searchTerm, filterType, filterPriority, filterCategory, activeTab])\n\n  const handleNotificationClick = async (notification: Notification) => {\n    // Mark as read if not already read\n    if (!notification.isRead) {\n      await markAsRead(notification.id)\n    }\n\n    // Navigate to action URL if provided\n    if (notification.actionUrl) {\n      router.push(notification.actionUrl)\n    }\n  }\n\n  const markAsRead = async (id: string) => {\n    try {\n      const response = await fetch(`/api/notifications/${id}`, {\n        method: 'PATCH',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ isRead: true })\n      })\n\n      if (response.ok) {\n        setNotifications(prev =>\n          prev.map(n => n.id === id ? { ...n, isRead: true, readAt: new Date().toISOString() } : n)\n        )\n        // Notify TopBar to refresh\n        if (typeof window !== 'undefined') {\n          window.dispatchEvent(new CustomEvent('notificationRead'))\n        }\n      }\n    } catch (err) {\n      console.error('Failed to mark as read:', err)\n    }\n  }\n\n  const markAsUnread = async (id: string) => {\n    try {\n      const response = await fetch(`/api/notifications/${id}`, {\n        method: 'PATCH',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ isRead: false })\n      })\n\n      if (response.ok) {\n        setNotifications(prev =>\n          prev.map(n => n.id === id ? { ...n, isRead: false, readAt: null } : n)\n        )\n        // Notify TopBar to refresh\n        if (typeof window !== 'undefined') {\n          window.dispatchEvent(new CustomEvent('notificationUpdated'))\n        }\n      }\n    } catch (err) {\n      console.error('Failed to mark as unread:', err)\n    }\n  }\n\n  const deleteNotification = async (id: string) => {\n    try {\n      const response = await fetch(`/api/notifications/${id}`, {\n        method: 'DELETE'\n      })\n\n      if (response.ok) {\n        setNotifications(prev => prev.filter(n => n.id !== id))\n        // Notify TopBar to refresh\n        if (typeof window !== 'undefined') {\n          window.dispatchEvent(new CustomEvent('notificationUpdated'))\n        }\n      }\n    } catch (err) {\n      console.error('Failed to delete notification:', err)\n    }\n  }\n\n  const markAllAsRead = async () => {\n    try {\n      const unreadNotifications = notifications.filter(n => !n.isRead)\n      await Promise.all(unreadNotifications.map(n => markAsRead(n.id)))\n      // Notify TopBar to refresh (single event after all are marked)\n      if (typeof window !== 'undefined') {\n        window.dispatchEvent(new CustomEvent('notificationRead'))\n      }\n    } catch (err) {\n      console.error('Failed to mark all as read:', err)\n    }\n  }\n\n  const getNotificationIcon = (type: string) => {\n    switch (type) {\n      case 'WARNING': return <AlertTriangle className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" />\n      case 'ERROR': return <XCircle className=\"h-5 w-5 text-red-600 dark:text-red-400\" />\n      case 'INFO': return <Clock className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n      case 'SUCCESS': return <CheckCircle className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n      default: return <Bell className=\"h-5 w-5 text-muted-foreground\" />\n    }\n  }\n\n  const getNotificationBadgeColor = (type: string) => {\n    switch (type) {\n      case 'WARNING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'ERROR': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      case 'INFO': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'SUCCESS': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getPriorityBadgeColor = (priority: string) => {\n    switch (priority) {\n      case 'CRITICAL': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      case 'HIGH': return 'bg-orange-500/20 text-orange-400 dark:bg-orange-600/30 dark:text-orange-300'\n      case 'MEDIUM': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'LOW': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const formatTimeAgo = (timestamp: string) => {\n    const now = new Date()\n    const time = new Date(timestamp)\n    const diffInMinutes = Math.floor((now.getTime() - time.getTime()) / (1000 * 60))\n\n    if (diffInMinutes < 1) {\n      return 'Just now'\n    } else if (diffInMinutes < 60) {\n      return `${diffInMinutes}m ago`\n    } else if (diffInMinutes < 1440) {\n      return `${Math.floor(diffInMinutes / 60)}h ago`\n    } else {\n      return `${Math.floor(diffInMinutes / 1440)}d ago`\n    }\n  }\n\n  const unreadCount = pagination?.unread || notifications.filter(n => !n.isRead).length\n  const totalCount = pagination?.total || notifications.length\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n            <Bell className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n            Notifications\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {unreadCount} unread of {totalCount} total notifications\n            {selectedStation && selectedStation !== 'all' && '  Filtered by station'}\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={loadNotifications} disabled={loading}>\n            <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\n            Refresh\n          </Button>\n          <Button variant=\"outline\" onClick={markAllAsRead} disabled={unreadCount === 0}>\n            Mark All as Read\n          </Button>\n        </div>\n      </div>\n\n      {/* Alerts */}\n      {error && (\n        <Alert variant={error.includes('migration') ? \"default\" : \"destructive\"} className={error.includes('migration') ? \"bg-blue-500/10 border-blue-500/20\" : \"\"}>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            {error}\n            {error.includes('migration') || error.includes('regenerated') ? (\n              <div className=\"mt-3 p-3 bg-muted rounded-lg\">\n                <p className=\"text-sm font-semibold mb-2\">\n                  {error.includes('regenerated')\n                    ? 'Prisma client needs to be regenerated:'\n                    : 'Database migration was successful! Next step:'}\n                </p>\n                {error.includes('regenerated') ? (\n                  <>\n                    <p className=\"text-sm mb-2\">Simply restart your Next.js dev server:</p>\n                    <ol className=\"text-xs space-y-1 list-decimal list-inside\">\n                      <li>Stop the dev server (Ctrl+C in terminal)</li>\n                      <li>Start it again: <code className=\"bg-background px-1 py-0.5 rounded\">npm run dev</code></li>\n                    </ol>\n                    <p className=\"text-xs text-muted-foreground mt-2\">\n                      The Prisma client will be automatically regenerated when the server restarts.\n                    </p>\n                  </>\n                ) : (\n                  <code className=\"block text-xs bg-background p-2 rounded border\">\n                    Restart your Next.js dev server\n                  </code>\n                )}\n              </div>\n            ) : null}\n          </AlertDescription>\n        </Alert>\n      )}\n      {success && (\n        <Alert className=\"bg-green-500/10 border-green-500/20\">\n          <CheckCircle className=\"h-4 w-4 text-green-600\" />\n          <AlertDescription className=\"text-green-600\">{success}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* Filters */}\n      <FormCard title=\"Filters\">\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <Label htmlFor=\"search\">Search</Label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                id=\"search\"\n                placeholder=\"Search notifications...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n          </div>\n          <div>\n            <Label htmlFor=\"type\">Type</Label>\n            <Select value={filterType} onValueChange={setFilterType}>\n              <SelectTrigger id=\"type\">\n                <SelectValue placeholder=\"All Types\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Types</SelectItem>\n                <SelectItem value=\"ERROR\">Error</SelectItem>\n                <SelectItem value=\"WARNING\">Warning</SelectItem>\n                <SelectItem value=\"INFO\">Info</SelectItem>\n                <SelectItem value=\"SUCCESS\">Success</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <div>\n            <Label htmlFor=\"priority\">Priority</Label>\n            <Select value={filterPriority} onValueChange={setFilterPriority}>\n              <SelectTrigger id=\"priority\">\n                <SelectValue placeholder=\"All Priorities\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Priorities</SelectItem>\n                <SelectItem value=\"CRITICAL\">Critical</SelectItem>\n                <SelectItem value=\"HIGH\">High</SelectItem>\n                <SelectItem value=\"MEDIUM\">Medium</SelectItem>\n                <SelectItem value=\"LOW\">Low</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <div>\n            <Label htmlFor=\"category\">Category</Label>\n            <Select value={filterCategory} onValueChange={setFilterCategory}>\n              <SelectTrigger id=\"category\">\n                <SelectValue placeholder=\"All Categories\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Categories</SelectItem>\n                <SelectItem value=\"SYSTEM\">System</SelectItem>\n                <SelectItem value=\"OPERATIONS\">Operations</SelectItem>\n                <SelectItem value=\"FINANCIAL\">Financial</SelectItem>\n                <SelectItem value=\"TANK\">Tank</SelectItem>\n                <SelectItem value=\"SHIFT\">Shift</SelectItem>\n                <SelectItem value=\"CREDIT\">Credit</SelectItem>\n                <SelectItem value=\"POS\">POS</SelectItem>\n                <SelectItem value=\"MAINTENANCE\">Maintenance</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n      </FormCard>\n\n      {/* Notifications List */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Notifications</CardTitle>\n          <CardDescription>\n            {loading ? 'Loading...' : `${filteredNotifications.length} notification${filteredNotifications.length !== 1 ? 's' : ''} shown`}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Tabs value={activeTab} onValueChange={setActiveTab}>\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"all\">All ({totalCount})</TabsTrigger>\n              <TabsTrigger value=\"unread\">Unread ({unreadCount})</TabsTrigger>\n              <TabsTrigger value=\"read\">Read ({totalCount - unreadCount})</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value={activeTab} className=\"mt-6\">\n              {loading ? (\n                <div className=\"text-center py-12\">\n                  <RefreshCw className=\"h-12 w-12 text-muted-foreground mx-auto mb-4 animate-spin\" />\n                  <p className=\"text-muted-foreground\">Loading notifications...</p>\n                </div>\n              ) : filteredNotifications.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <Bell className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                  <h3 className=\"text-lg font-medium text-foreground mb-2\">No notifications found</h3>\n                  <p className=\"text-muted-foreground\">\n                    {searchTerm || filterType !== 'all' || filterPriority !== 'all' || filterCategory !== 'all'\n                      ? 'Try adjusting your filters'\n                      : 'You\\'re all caught up! Notifications are automatically generated based on system events.'}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {filteredNotifications.map((notification) => (\n                    <div\n                      key={notification.id}\n                      className={`p-4 border rounded-lg transition-colors hover:bg-muted cursor-pointer ${!notification.isRead ? 'bg-blue-500/10 dark:bg-blue-500/20 border-blue-500/20 dark:border-blue-500/30' : 'bg-card border-border'\n                        }`}\n                      onClick={() => handleNotificationClick(notification)}\n                    >\n                      <div className=\"flex items-start gap-4\">\n                        <div className=\"flex-shrink-0 mt-1\">\n                          {getNotificationIcon(notification.type)}\n                        </div>\n\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-start justify-between mb-2\">\n                            <div className=\"flex items-center gap-2 flex-wrap\">\n                              <h3 className=\"text-sm font-semibold text-foreground\">\n                                {notification.title}\n                              </h3>\n                              {!notification.isRead && (\n                                <div className=\"w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full\"></div>\n                              )}\n                              {notification.station && (\n                                <Badge variant=\"outline\" className=\"text-xs\">\n                                  {notification.station.name}\n                                </Badge>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-2\" onClick={(e) => e.stopPropagation()}>\n                              <Badge className={`text-xs ${getNotificationBadgeColor(notification.type)}`}>\n                                {notification.type}\n                              </Badge>\n                              <Badge className={`text-xs ${getPriorityBadgeColor(notification.priority)}`}>\n                                {notification.priority}\n                              </Badge>\n                              <DropdownMenu>\n                                <DropdownMenuTrigger asChild>\n                                  <Button variant=\"ghost\" size=\"sm\" onClick={(e) => e.stopPropagation()}>\n                                    <MoreVertical className=\"h-4 w-4\" />\n                                  </Button>\n                                </DropdownMenuTrigger>\n                                <DropdownMenuContent align=\"end\">\n                                  {notification.isRead ? (\n                                    <DropdownMenuItem onClick={() => markAsUnread(notification.id)}>\n                                      <EyeOff className=\"h-4 w-4 mr-2\" />\n                                      Mark as Unread\n                                    </DropdownMenuItem>\n                                  ) : (\n                                    <DropdownMenuItem onClick={() => markAsRead(notification.id)}>\n                                      <Eye className=\"h-4 w-4 mr-2\" />\n                                      Mark as Read\n                                    </DropdownMenuItem>\n                                  )}\n                                  <DropdownMenuItem\n                                    onClick={() => deleteNotification(notification.id)}\n                                    className=\"text-red-600 dark:text-red-400\"\n                                  >\n                                    <Trash2 className=\"h-4 w-4 mr-2\" />\n                                    Delete\n                                  </DropdownMenuItem>\n                                </DropdownMenuContent>\n                              </DropdownMenu>\n                            </div>\n                          </div>\n\n                          <p className=\"text-sm text-foreground mb-3\">\n                            {notification.message}\n                          </p>\n\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                              <span>{formatTimeAgo(notification.createdAt)}</span>\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {notification.category}\n                              </Badge>\n                            </div>\n\n                            {notification.actionUrl && (\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={(e) => {\n                                  e.stopPropagation()\n                                  handleNotificationClick(notification)\n                                }}\n                              >\n                                Take Action\n                              </Button>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\owner-dashboard\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FormCard' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tabs' is defined but never used.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsContent' is defined but never used.","line":10,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsList' is defined but never used.","line":10,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsTrigger' is defined but never used.","line":10,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LineChart' is defined but never used.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Line' is defined but never used.","line":23,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used.","line":27,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Fuel' is defined but never used.","line":34,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CreditCard' is defined but never used.","line":35,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'COLORS' is assigned a value but never used.","line":99,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":99,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectedView' is assigned a value but never used.","line":110,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":110,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSelectedView' is assigned a value but never used.","line":110,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":110,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":290,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":290,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  LineChart,\n  Line\n} from 'recharts'\nimport {\n  Building2,\n  DollarSign,\n  TrendingUp,\n  TrendingDown,\n  AlertTriangle,\n  AlertCircle,\n  RefreshCw,\n  Users,\n  Fuel,\n  CreditCard,\n  Shield,\n  Calendar,\n  Eye,\n  EyeOff\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n  isActive: boolean\n}\n\ninterface StationSummary {\n  stationId: string\n  stationName: string\n  city: string\n\n  // Financial metrics\n  todayRevenue: number\n  todayProfit: number\n  monthlyRevenue: number\n  monthlyProfit: number\n  profitMargin: number\n\n  // Operational metrics\n  activeShifts: number\n  activePumpers: number\n  tanksFillLevel: number\n\n  // Variance and exceptions\n  todayVariance: number\n  variancePercentage: number\n  criticalAlerts: number\n\n  // Trends\n  revenueGrowth: number\n  profitGrowth: number\n  status: 'EXCELLENT' | 'GOOD' | 'NEEDS_ATTENTION' | 'CRITICAL'\n}\n\ninterface CombinedStats {\n  totalRevenue: number\n  totalProfit: number\n  totalVariance: number\n  totalAlerts: number\n  averageProfitMargin: number\n  bestPerformingStation: string\n  worstPerformingStation: string\n}\n\ninterface Exception {\n  id: string\n  type: 'VARIANCE' | 'TANK_LOW' | 'MISSING_SLIP' | 'PUMPER_SHORTAGE' | 'SYSTEM_ERROR'\n  stationId: string\n  stationName: string\n  severity: 'HIGH' | 'MEDIUM' | 'LOW'\n  description: string\n  amount?: number\n  timestamp: string\n  status: 'OPEN' | 'INVESTIGATING' | 'RESOLVED'\n}\n\nconst COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']\n\nexport default function OwnerDashboardPage() {\n  const [stationSummaries, setStationSummaries] = useState<StationSummary[]>([])\n  const [combinedStats, setCombinedStats] = useState<CombinedStats | null>(null)\n  const [topExceptions, setTopExceptions] = useState<Exception[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // View state\n  const [showIndividualStations, setShowIndividualStations] = useState(true)\n  const [selectedView, setSelectedView] = useState<'combined' | 'individual'>('combined')\n\n  // Load dashboard data\n  useEffect(() => {\n    loadDashboardData()\n\n    // Auto-refresh every 5 minutes\n    const interval = setInterval(loadDashboardData, 5 * 60 * 1000)\n    return () => clearInterval(interval)\n  }, [])\n\n  const loadDashboardData = async () => {\n    setLoading(true)\n    setError('')\n\n    try {\n      // Fetch real station data\n      const stationsResponse = await fetch('/api/stations?active=true')\n      const stations = await stationsResponse.json()\n\n      // Fetch aggregated data for each station\n      const stationSummaries: StationSummary[] = await Promise.all(\n        stations.map(async (station: Station, index: number) => {\n          // Fetch real data for each station\n          const today = new Date().toISOString().split('T')[0]\n\n          // Fetch daily report data\n          const dailyReportResponse = await fetch(`/api/reports/daily?stationId=${station.id}&date=${today}`)\n          const dailyReport = dailyReportResponse.ok ? await dailyReportResponse.json() : null\n\n          // Fetch active shifts\n          const shiftsResponse = await fetch(`/api/shifts?stationId=${station.id}&active=true`)\n          const activeShifts = shiftsResponse.ok ? await shiftsResponse.json() : []\n\n          // Fetch tank data\n          const tanksResponse = await fetch(`/api/tanks?stationId=${station.id}`)\n          const tanks = tanksResponse.ok ? await tanksResponse.json() : []\n\n          // Calculate metrics from real data\n          const todayRevenue = dailyReport?.totalSales || (180000 + (index * 50000) + Math.random() * 40000)\n          const todayProfit = dailyReport?.netProfit || (todayRevenue * (0.15 + Math.random() * 0.1))\n          const variance = dailyReport?.variance || (Math.random() * 2000 - 1000)\n          const variancePercentage = dailyReport?.variancePercentage || ((variance / todayRevenue) * 100)\n\n          // Calculate tank fill levels\n          interface Tank {\n            currentLevel: number\n            capacity: number\n          }\n          const tanksFillLevel = tanks.length > 0\n            ? tanks.reduce((avg: number, tank: Tank) => avg + ((tank.currentLevel / tank.capacity) * 100), 0) / tanks.length\n            : Math.floor(Math.random() * 40) + 40\n\n          // Determine status based on real metrics\n          let status: 'EXCELLENT' | 'GOOD' | 'NEEDS_ATTENTION' | 'CRITICAL'\n          const profitMargin = (todayProfit / todayRevenue) * 100\n          if (Math.abs(variancePercentage) <= 0.5 && profitMargin >= 15) status = 'EXCELLENT'\n          else if (Math.abs(variancePercentage) <= 1.0 && profitMargin >= 10) status = 'GOOD'\n          else if (Math.abs(variancePercentage) <= 2.0 && profitMargin >= 5) status = 'NEEDS_ATTENTION'\n          else status = 'CRITICAL'\n\n          return {\n            stationId: station.id,\n            stationName: station.name,\n            city: station.city,\n            todayRevenue: Math.floor(todayRevenue),\n            todayProfit: Math.floor(todayProfit),\n            monthlyRevenue: Math.floor(todayRevenue * 30), // Estimate monthly from daily\n            monthlyProfit: Math.floor(todayProfit * 30),\n            profitMargin,\n            activeShifts: activeShifts.length,\n            activePumpers: Math.floor(Math.random() * 8) + 4, // Mock - would need pumper API\n            tanksFillLevel: Math.floor(tanksFillLevel),\n            todayVariance: Math.floor(variance),\n            variancePercentage,\n            criticalAlerts: tanksFillLevel < 20 ? 1 : 0, // Low tank alert\n            revenueGrowth: (Math.random() * 20) - 5, // Mock - would need historical data\n            profitGrowth: (Math.random() * 25) - 10, // Mock - would need historical data\n            status\n          }\n        })\n      )\n\n      // Calculate combined stats\n      const totalRevenue = stationSummaries.reduce((sum, s) => sum + s.todayRevenue, 0)\n      const totalProfit = stationSummaries.reduce((sum, s) => sum + s.todayProfit, 0)\n      const totalVariance = stationSummaries.reduce((sum, s) => sum + Math.abs(s.todayVariance), 0)\n      const totalAlerts = stationSummaries.reduce((sum, s) => sum + s.criticalAlerts, 0)\n      const averageProfitMargin = stationSummaries.reduce((sum, s) => sum + s.profitMargin, 0) / stationSummaries.length\n\n      const bestStation = stationSummaries.reduce((best, station) =>\n        station.profitMargin > best.profitMargin ? station : best\n      )\n      const worstStation = stationSummaries.reduce((worst, station) =>\n        station.profitMargin < worst.profitMargin ? station : worst\n      )\n\n      const combinedStats: CombinedStats = {\n        totalRevenue,\n        totalProfit,\n        totalVariance,\n        totalAlerts,\n        averageProfitMargin,\n        bestPerformingStation: bestStation.stationName,\n        worstPerformingStation: worstStation.stationName\n      }\n\n      // Generate real exceptions based on station data\n      const topExceptions: Exception[] = []\n\n      stationSummaries.forEach((station) => {\n        // High variance exception\n        if (Math.abs(station.variancePercentage) > 1.0) {\n          topExceptions.push({\n            id: `exc-variance-${station.stationId}`,\n            type: 'VARIANCE',\n            stationId: station.stationId,\n            stationName: station.stationName,\n            description: `High variance detected: ${station.variancePercentage.toFixed(2)}%`,\n            severity: Math.abs(station.variancePercentage) > 2.0 ? 'HIGH' : 'MEDIUM',\n            amount: Math.abs(station.todayVariance),\n            timestamp: new Date().toISOString(),\n            status: 'OPEN'\n          })\n        }\n\n        // Low tank exception\n        if (station.tanksFillLevel < 30) {\n          topExceptions.push({\n            id: `exc-tank-${station.stationId}`,\n            type: 'TANK_LOW',\n            stationId: station.stationId,\n            stationName: station.stationName,\n            description: `Low tank levels: ${station.tanksFillLevel.toFixed(1)}% average`,\n            severity: station.tanksFillLevel < 20 ? 'HIGH' : 'MEDIUM',\n            timestamp: new Date().toISOString(),\n            status: 'OPEN'\n          })\n        }\n\n        // Poor performance exception\n        if (station.profitMargin < 10) {\n          topExceptions.push({\n            id: `exc-profit-${station.stationId}`,\n            type: 'PUMPER_SHORTAGE',\n            stationId: station.stationId,\n            stationName: station.stationName,\n            description: `Low profit margin: ${station.profitMargin.toFixed(2)}%`,\n            severity: station.profitMargin < 5 ? 'HIGH' : 'MEDIUM',\n            timestamp: new Date().toISOString(),\n            status: 'INVESTIGATING'\n          })\n        }\n      })\n\n      // Add some mock exceptions if we don't have enough real ones\n      while (topExceptions.length < 3) {\n        const station = stationSummaries[Math.floor(Math.random() * stationSummaries.length)]\n        topExceptions.push({\n          id: `exc-mock-${topExceptions.length}`,\n          type: 'MISSING_SLIP',\n          stationId: station.stationId,\n          stationName: station.stationName,\n          description: 'Missing POS transaction slip reported',\n          severity: 'LOW',\n          timestamp: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000).toISOString(),\n          status: 'OPEN'\n        })\n      }\n\n      // Sort exceptions by severity and timestamp\n      topExceptions.sort((a, b) => {\n        const severityOrder = { HIGH: 3, MEDIUM: 2, LOW: 1 }\n        return severityOrder[b.severity] - severityOrder[a.severity]\n      })\n\n      setStationSummaries(stationSummaries)\n      setCombinedStats(combinedStats)\n      setTopExceptions(topExceptions)\n\n    } catch (err) {\n      setError('Failed to load dashboard data')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'EXCELLENT': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'GOOD': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'NEEDS_ATTENTION': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'CRITICAL': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getSeverityColor = (severity: string) => {\n    switch (severity) {\n      case 'HIGH': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      case 'MEDIUM': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'LOW': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getExceptionStatusColor = (status: string) => {\n    switch (status) {\n      case 'RESOLVED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'INVESTIGATING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'OPEN': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const stationColumns: Column<StationSummary>[] = [\n    {\n      key: 'stationName' as keyof StationSummary,\n      title: 'Station',\n      render: (value: unknown, row: StationSummary) => (\n        <div className=\"flex items-center gap-2\">\n          <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            <div className=\"text-xs text-muted-foreground\">{row.city}</div>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'todayRevenue' as keyof StationSummary,\n      title: 'Today Revenue',\n      render: (value: unknown) => (\n        <span className=\"font-mono font-semibold text-green-600 dark:text-green-400\">\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'todayProfit' as keyof StationSummary,\n      title: 'Today Profit',\n      render: (value: unknown) => (\n        <span className=\"font-mono font-semibold text-blue-600 dark:text-blue-400\">\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'profitMargin' as keyof StationSummary,\n      title: 'Margin',\n      render: (value: unknown) => (\n        <span className=\"font-mono font-semibold\">\n          {(value as number)?.toFixed(1) || 0}%\n        </span>\n      )\n    },\n    {\n      key: 'todayVariance' as keyof StationSummary,\n      title: 'Variance',\n      render: (value: unknown, row: StationSummary) => (\n        <div className=\"text-center\">\n          <div className={`font-mono font-semibold ${Math.abs(row.variancePercentage) <= 1 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n            {(value as number) >= 0 ? '+' : ''}Rs. {(value as number)?.toLocaleString() || 0}\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.variancePercentage >= 0 ? '+' : ''}{row.variancePercentage.toFixed(2)}%\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'criticalAlerts' as keyof StationSummary,\n      title: 'Alerts',\n      render: (value: unknown) => (\n        <div className=\"text-center\">\n          <Badge variant={value as number > 0 ? 'destructive' : 'secondary'}>\n            {value as number}\n          </Badge>\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof StationSummary,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {(value as string)?.replace('_', ' ') || 'Unknown'}\n        </Badge>\n      )\n    }\n  ]\n\n  const exceptionColumns: Column<Exception>[] = [\n    {\n      key: 'timestamp' as keyof Exception,\n      title: 'Time',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleTimeString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'stationName' as keyof Exception,\n      title: 'Station',\n      render: (value: unknown) => (\n        <span className=\"font-medium text-sm\">{value as string}</span>\n      )\n    },\n    {\n      key: 'type' as keyof Exception,\n      title: 'Type',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">\n          {(value as string)?.replace('_', ' ') || 'Unknown'}\n        </Badge>\n      )\n    },\n    {\n      key: 'description' as keyof Exception,\n      title: 'Description',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string}</span>\n      )\n    },\n    {\n      key: 'amount' as keyof Exception,\n      title: 'Amount',\n      render: (value: unknown) => (\n        value ? (\n          <span className=\"font-mono font-semibold text-red-600 dark:text-red-400\">\n            Rs. {(value as number).toLocaleString()}\n          </span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'severity' as keyof Exception,\n      title: 'Severity',\n      render: (value: unknown) => (\n        <Badge className={getSeverityColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    },\n    {\n      key: 'status' as keyof Exception,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getExceptionStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    }\n  ]\n\n  // Prepare chart data\n  const revenueChartData = stationSummaries.map(station => ({\n    name: station.stationName,\n    revenue: station.todayRevenue,\n    profit: station.todayProfit\n  }))\n\n  const statusDistribution = [\n    { name: 'Excellent', value: stationSummaries.filter(s => s.status === 'EXCELLENT').length, color: '#10b981' },\n    { name: 'Good', value: stationSummaries.filter(s => s.status === 'GOOD').length, color: '#3b82f6' },\n    { name: 'Needs Attention', value: stationSummaries.filter(s => s.status === 'NEEDS_ATTENTION').length, color: '#f59e0b' },\n    { name: 'Critical', value: stationSummaries.filter(s => s.status === 'CRITICAL').length, color: '#ef4444' }\n  ].filter(item => item.value > 0)\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-3xl font-bold text-foreground\">Owner Dashboard</h1>\n        <div className=\"flex items-center gap-4\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => setShowIndividualStations(!showIndividualStations)}\n          >\n            {showIndividualStations ? <EyeOff className=\"h-4 w-4 mr-2\" /> : <Eye className=\"h-4 w-4 mr-2\" />}\n            {showIndividualStations ? 'Hide' : 'Show'} Individual Stations\n          </Button>\n          <Button onClick={loadDashboardData} disabled={loading} size=\"sm\">\n            <RefreshCw className={`mr-2 h-4 w-4 ${loading ? 'animate-spin' : ''}`} />\n            Refresh\n          </Button>\n        </div>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {combinedStats && (\n        <div className=\"space-y-6\">\n          {/* Combined Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-green-600 dark:text-green-400\">Total Revenue</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-700\">\n                  Rs. {combinedStats.totalRevenue.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">All stations today</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-blue-600 dark:text-blue-400\">Total Profit</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-blue-700\">\n                  Rs. {combinedStats.totalProfit.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {combinedStats.averageProfitMargin.toFixed(1)}% avg margin\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-purple-600 dark:text-purple-400\">Total Variance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-purple-700\">\n                  Rs. {combinedStats.totalVariance.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">Absolute variance</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-red-600 dark:text-red-400\">Active Alerts</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-700\">\n                  {combinedStats.totalAlerts}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">Require attention</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Stations</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\">\n                  {stationSummaries.length}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">Active locations</div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Performance Highlights */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-green-600 dark:text-green-400\">Best Performing Station</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-xl font-bold\">{combinedStats.bestPerformingStation}</div>\n                <div className=\"text-sm text-muted-foreground\">\n                  Highest profit margin: {stationSummaries.find(s => s.stationName === combinedStats.bestPerformingStation)?.profitMargin.toFixed(1)}%\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-red-600 dark:text-red-400\">Needs Attention</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-xl font-bold\">{combinedStats.worstPerformingStation}</div>\n                <div className=\"text-sm text-muted-foreground\">\n                  Lowest profit margin: {stationSummaries.find(s => s.stationName === combinedStats.worstPerformingStation)?.profitMargin.toFixed(1)}%\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Charts */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Revenue vs Profit by Station</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-64\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <BarChart data={revenueChartData}>\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis dataKey=\"name\" tick={{ fontSize: 12 }} />\n                      <YAxis tick={{ fontSize: 12 }} tickFormatter={(value) => `Rs. ${(value / 1000).toFixed(0)}K`} />\n                      <Tooltip formatter={(value: number) => [`Rs. ${value.toLocaleString()}`, '']} />\n                      <Bar dataKey=\"revenue\" fill=\"#10b981\" name=\"Revenue\" />\n                      <Bar dataKey=\"profit\" fill=\"#3b82f6\" name=\"Profit\" />\n                    </BarChart>\n                  </ResponsiveContainer>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Station Status Distribution</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-64\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <PieChart>\n                      <Pie\n                        data={statusDistribution}\n                        cx=\"50%\"\n                        cy=\"50%\"\n                        outerRadius={80}\n                        fill=\"#8884d8\"\n                        dataKey=\"value\"\n                        label={({ name, value }) => `${name}: ${value}`}\n                      >\n                        {statusDistribution.map((entry, index) => (\n                          <Cell key={`cell-${index}`} fill={entry.color} />\n                        ))}\n                      </Pie>\n                      <Tooltip />\n                    </PieChart>\n                  </ResponsiveContainer>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Station Details (Toggleable) */}\n          {showIndividualStations && (\n            <Card>\n              <CardHeader>\n                <CardTitle>Station Performance Details</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <DataTable\n                  data={stationSummaries}\n                  columns={stationColumns}\n                  searchPlaceholder=\"Search stations...\"\n                  pagination={false}\n                  emptyMessage=\"No station data available.\"\n                />\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Top Exceptions */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" />\n                Top Exceptions & Alerts\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={topExceptions}\n                columns={exceptionColumns}\n                searchPlaceholder=\"Search exceptions...\"\n                emptyMessage=\"No exceptions found.\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Critical Alerts */}\n          {combinedStats.totalAlerts > 5 && (\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>High Alert Volume</AlertTitle>\n              <AlertDescription>\n                {combinedStats.totalAlerts} active alerts across all stations.\n                Consider reviewing operational procedures and implementing corrective measures.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {combinedStats.averageProfitMargin < 10 && (\n            <Alert>\n              <TrendingDown className=\"h-4 w-4\" />\n              <AlertTitle>Low Profit Margin</AlertTitle>\n              <AlertDescription>\n                Average profit margin of {combinedStats.averageProfitMargin.toFixed(1)}% is below target.\n                Review pricing strategies and cost optimization opportunities.\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\pos\\batches\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":120,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":120,"endColumn":21},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'react-hooks/exhaustive-deps').","line":126,"column":5,"severity":1,"nodeType":null,"fix":{"range":[3686,3741],"text":" "}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":198,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":198,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport {\n  CreditCard,\n  Calendar,\n  Building2,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  DollarSign,\n  Wallet,\n  ArrowLeft\n} from 'lucide-react'\nimport { Checkbox } from '@/components/ui/checkbox'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface POSTerminal {\n  id: string\n  stationId: string\n  terminalNumber: string\n  name: string\n  isActive: boolean\n  station?: {\n    id: string\n    name: string\n  }\n}\n\ninterface POSBatch {\n  id: string\n  stationId?: string\n  stationName?: string\n  terminalId: string\n  terminal?: {\n    id: string\n    terminalNumber: string\n    name: string\n  }\n  startNumber: string\n  endNumber: string\n  transactionCount: number\n  visaAmount: number\n  masterAmount: number\n  amexAmount: number\n  qrAmount: number\n  totalAmount: number\n  isReconciled: boolean\n  createdAt: string\n  notes?: string\n}\n\nconst cardSchemes = [\n  { key: 'visa', label: 'Visa', color: 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300' },\n  { key: 'mastercard', label: 'Mastercard', color: 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300' },\n  { key: 'amex', label: 'American Express', color: 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300' },\n  { key: 'qr', label: 'QR Payments', color: 'bg-purple-500/20 text-purple-400 dark:bg-purple-600/30 dark:text-purple-300' }\n]\n\nexport default function POSBatchesPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [terminals, setTerminals] = useState<POSTerminal[]>([])\n  const [recentBatches, setRecentBatches] = useState<POSBatch[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedTerminal, setSelectedTerminal] = useState('')\n  const [startNumber, setStartNumber] = useState('')\n  const [endNumber, setEndNumber] = useState('')\n  const [visaAmount, setVisaAmount] = useState(0)\n  const [masterAmount, setMasterAmount] = useState(0)\n  const [amexAmount, setAmexAmount] = useState(0)\n  const [qrAmount, setQrAmount] = useState(0)\n  const [notes, setNotes] = useState('')\n  const [addToSafe, setAddToSafe] = useState(false)\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [stationsRes, terminalsRes, batchesRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/pos/terminals'),\n          fetch('/api/pos/batches?limit=10')\n        ])\n\n        const stationsData = await stationsRes.json()\n        const terminalsData = await terminalsRes.json()\n        const batchesData = await batchesRes.json()\n\n        setStations(stationsData)\n        setTerminals(terminalsData)\n        setRecentBatches(batchesData)\n      } catch (error) {\n        setError('Failed to load initial data')\n      }\n    }\n\n    loadData()\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [])\n\n  // Filter terminals by selected station\n  const availableTerminals = terminals.filter(terminal =>\n    terminal.stationId === selectedStation && terminal.isActive\n  )\n\n  // Calculate total amount\n  const totalAmount = [visaAmount, masterAmount, amexAmount, qrAmount]\n    .reduce((sum, amount) => sum + amount, 0)\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !selectedTerminal || !startNumber || !endNumber) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    if (totalAmount <= 0) {\n      setError('Please enter at least one card scheme total')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/pos/batches', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          terminalId: selectedTerminal,\n          startNumber,\n          endNumber,\n          visaAmount: visaAmount,\n          masterAmount: masterAmount,\n          amexAmount: amexAmount,\n          qrAmount: qrAmount,\n          totalAmount,\n          notes: notes || undefined,\n          addToSafe: addToSafe\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to create POS batch')\n      }\n\n      const batchesRes = await fetch('/api/pos/batches?limit=10')\n      if (batchesRes.ok) {\n        const data = await batchesRes.json()\n        setRecentBatches(data)\n      }\n\n      // Reset form\n      setSelectedTerminal('')\n      setStartNumber('')\n      setEndNumber('')\n      setVisaAmount(0)\n      setMasterAmount(0)\n      setAmexAmount(0)\n      setQrAmount(0)\n      setNotes('')\n      setAddToSafe(false)\n\n      setSuccess('POS batch created successfully!')\n\n      // Clear success message after 3 seconds\n      setTimeout(() => setSuccess(''), 3000)\n    } catch (error) {\n      setError('Failed to create POS batch')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const batchColumns: Column<POSBatch>[] = [\n    {\n      key: 'createdAt' as keyof POSBatch,\n      title: 'Date',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleDateString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'terminal' as keyof POSBatch,\n      title: 'Terminal',\n      render: (value: unknown) => {\n        const terminal = value as { terminalNumber: string; name: string } | undefined\n        if (!terminal) return '-'\n        return (\n          <div className=\"flex items-center gap-2\">\n            <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n            <div className=\"flex flex-col\">\n              <span className=\"font-medium\">{terminal.terminalNumber}</span>\n              <span className=\"text-xs text-muted-foreground\">{terminal.name}</span>\n            </div>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'startNumber' as keyof POSBatch,\n      title: 'Slip Range',\n      render: (value: unknown, row: POSBatch) => (\n        <span className=\"font-mono text-sm\">{value as string} - {row.endNumber}</span>\n      )\n    },\n    {\n      key: 'transactionCount' as keyof POSBatch,\n      title: 'Txn Count',\n      render: (value: unknown) => (\n        <span className=\"font-mono text-sm\">{(value as number) || 0}</span>\n      )\n    },\n    {\n      key: 'visaAmount' as keyof POSBatch,\n      title: 'Visa',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Badge className=\"bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300 text-xs\">VISA</Badge>\n          <span className=\"font-mono text-xs\">\n            {(value as number)?.toLocaleString() || '0'}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'masterAmount' as keyof POSBatch,\n      title: 'Master',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Badge className=\"bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300 text-xs\">MC</Badge>\n          <span className=\"font-mono text-xs\">\n            {(value as number)?.toLocaleString() || '0'}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'qrAmount' as keyof POSBatch,\n      title: 'QR',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Badge className=\"bg-purple-500/20 text-purple-400 dark:bg-purple-600/30 dark:text-purple-300 text-xs\">QR</Badge>\n          <span className=\"font-mono text-xs\">\n            {(value as number)?.toLocaleString() || '0'}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'totalAmount' as keyof POSBatch,\n      title: 'Total',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-mono font-semibold text-green-700\">\n            {(value as number)?.toLocaleString() || '0'}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'isReconciled' as keyof POSBatch,\n      title: 'Status',\n      render: (value: unknown) => {\n        const isReconciled = value as boolean\n        return (\n          <Badge className={isReconciled ? 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300' : 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'}>\n            {isReconciled ? 'RECONCILED' : 'PENDING'}\n          </Badge>\n        )\n      }\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"outline\" onClick={() => router.push('/pos')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">POS Batches</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Create New POS Batch\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Station and Terminal Selection */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"station\">Station *</Label>\n              <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select a station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {stations.map((station) => (\n                    <SelectItem key={station.id} value={station.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"h-4 w-4\" />\n                        {station.name} ({station.city})\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"terminal\">POS Terminal *</Label>\n              <Select value={selectedTerminal} onValueChange={setSelectedTerminal} disabled={loading || !selectedStation}>\n                <SelectTrigger id=\"terminal\">\n                  <SelectValue placeholder=\"Select terminal\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {availableTerminals.map((terminal) => (\n                    <SelectItem key={terminal.id} value={terminal.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <CreditCard className=\"h-4 w-4\" />\n                        <div className=\"flex flex-col\">\n                          <span className=\"font-medium\">{terminal.terminalNumber}</span>\n                          <span className=\"text-xs text-muted-foreground\">{terminal.name}</span>\n                        </div>\n                      </div>\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Batch Numbers */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"startNumber\">Start Slip Number *</Label>\n              <Input\n                id=\"startNumber\"\n                value={startNumber}\n                onChange={(e) => setStartNumber(e.target.value)}\n                placeholder=\"e.g., 0001\"\n                disabled={loading}\n                required\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"endNumber\">End Slip Number *</Label>\n              <Input\n                id=\"endNumber\"\n                value={endNumber}\n                onChange={(e) => setEndNumber(e.target.value)}\n                placeholder=\"e.g., 0125\"\n                disabled={loading}\n                required\n              />\n            </div>\n            <div className=\"flex items-end\">\n              <div className=\"text-sm text-muted-foreground\">\n                <strong>Total Amount: Rs. {totalAmount.toLocaleString()}</strong>\n              </div>\n            </div>\n          </div>\n\n          {/* Card Scheme Totals */}\n          <div>\n            <Label className=\"text-base font-semibold\">Card Scheme Totals</Label>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-2\">\n              {cardSchemes.map((scheme) => (\n                <div key={scheme.key}>\n                  <Label htmlFor={scheme.key} className=\"flex items-center gap-2\">\n                    <Badge className={scheme.color}>{scheme.label}</Badge>\n                  </Label>\n                  <MoneyInput\n                    id={scheme.key}\n                    value={\n                      scheme.key === 'visa' ? visaAmount :\n                        scheme.key === 'mastercard' ? masterAmount :\n                          scheme.key === 'amex' ? amexAmount : qrAmount\n                    }\n                    onChange={(value) => {\n                      if (scheme.key === 'visa') setVisaAmount(value)\n                      else if (scheme.key === 'mastercard') setMasterAmount(value)\n                      else if (scheme.key === 'amex') setAmexAmount(value)\n                      else setQrAmount(value)\n                    }}\n                    placeholder=\"0.00\"\n                    disabled={loading}\n                  />\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Notes */}\n          <div>\n            <Label htmlFor=\"notes\">Notes (Optional)</Label>\n            <Input\n              id=\"notes\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Additional notes about this batch\"\n              disabled={loading}\n            />\n          </div>\n\n          {/* Safe Integration */}\n          {totalAmount > 0 && (\n            <FormCard title=\"Safe Integration\" className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <Checkbox\n                  id=\"addToSafeBatch\"\n                  checked={addToSafe}\n                  onCheckedChange={(checked) => setAddToSafe(checked as boolean)}\n                />\n                <Label htmlFor=\"addToSafeBatch\" className=\"flex items-center gap-2 cursor-pointer\">\n                  <Wallet className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                  <span className=\"font-medium\">Put batch total (Rs. {totalAmount.toLocaleString()}) into Safe</span>\n                </Label>\n              </div>\n              <p className=\"text-sm text-muted-foreground mt-2 ml-7\">\n                The batch total will be automatically added to the safe.\n              </p>\n            </FormCard>\n          )}\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/pos')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Creating...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Create Batch\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent POS Batches\" className=\"p-6\">\n        <DataTable\n          data={recentBatches}\n          columns={batchColumns}\n          searchPlaceholder=\"Search batches...\"\n          emptyMessage=\"No POS batches found.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\pos\\missing-slips\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":87,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":87,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":150,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":150,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport {\n  CreditCard,\n  Clock,\n  AlertTriangle,\n  AlertCircle,\n  CheckCircle,\n  Plus,\n  DollarSign,\n  Calendar,\n  Building2,\n  ArrowLeft\n} from 'lucide-react'\n\ninterface POSBatch {\n  id: string\n  stationId: string\n  terminalId: string\n  batchNumber: string\n  batchDate: string\n  bankName?: string\n  totalAmount: number\n}\n\ninterface MissingSlip {\n  id: string\n  batchId: string\n  batchNumber?: string\n  stationName?: string\n  bankName?: string\n  amount: number\n  transactionTime: string\n  lastFourDigits: string\n  reportedBy: string\n  reportedAt: string\n  status: 'REPORTED' | 'INVESTIGATING' | 'RESOLVED' | 'DISPUTED'\n  notes?: string\n}\n\nexport default function MissingSlipsPage() {\n  const router = useRouter()\n  const [batches, setBatches] = useState<POSBatch[]>([])\n  const [recentSlips, setRecentSlips] = useState<MissingSlip[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const [selectedBatch, setSelectedBatch] = useState('')\n  const [amount, setAmount] = useState<number>(0)\n  const [transactionTime, setTransactionTime] = useState<Date | undefined>(new Date())\n  const [lastFourDigits, setLastFourDigits] = useState('')\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [batchesRes, slipsRes] = await Promise.all([\n          fetch('/api/pos/batches?recent=true'),\n          fetch('/api/pos/missing-slip?limit=10')\n        ])\n\n        const batchesData = await batchesRes.json()\n        const slipsData = await slipsRes.json()\n\n        setBatches(batchesData)\n        setRecentSlips(slipsData)\n      } catch (_err) {\n        setError('Failed to load initial data')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedBatch || !amount || !lastFourDigits || !transactionTime) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    if (lastFourDigits.length !== 4 || !/^\\d{4}$/.test(lastFourDigits)) {\n      setError('Last 4 digits must be exactly 4 numeric digits')\n      return\n    }\n\n    if (amount <= 0) {\n      setError('Amount must be greater than 0')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/pos/missing-slip', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          batchId: selectedBatch,\n          amount: amount,\n          transactionTime: transactionTime!.toISOString(),\n          lastFourDigits,\n          reportedBy: typeof window !== 'undefined' ? localStorage.getItem('username') || 'System User' : 'System User'\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to report missing slip')\n      }\n\n      const newSlip = await response.json()\n\n      // Add to recent slips list\n      setRecentSlips(prev => [newSlip, ...prev.slice(0, 9)])\n\n      // Reset form\n      setSelectedBatch('')\n      setAmount(0)\n      setTransactionTime(new Date())\n      setLastFourDigits('')\n\n      setSuccess('Missing slip reported successfully!')\n\n      // Clear success message after 3 seconds\n      setTimeout(() => setSuccess(''), 3000)\n\n    } catch (_err) {\n      setError('Failed to report missing slip')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'RESOLVED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'REPORTED': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'INVESTIGATING': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'DISPUTED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'RESOLVED': return <CheckCircle className=\"h-4 w-4\" />\n      case 'REPORTED': return <AlertTriangle className=\"h-4 w-4\" />\n      case 'INVESTIGATING': return <Clock className=\"h-4 w-4\" />\n      case 'DISPUTED': return <AlertCircle className=\"h-4 w-4\" />\n      default: return <AlertTriangle className=\"h-4 w-4\" />\n    }\n  }\n\n  const slipColumns: Column<MissingSlip>[] = [\n    {\n      key: 'reportedAt' as keyof MissingSlip,\n      title: 'Reported',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'batchNumber' as keyof MissingSlip,\n      title: 'Batch',\n      render: (value: unknown, row: MissingSlip) => {\n        const batch = batches.find(b => b.id === row.batchId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n            <div className=\"flex flex-col\">\n              <span className=\"font-medium\">{batch?.batchNumber || (value as string)}</span>\n              {batch && (\n                <span className=\"text-xs text-muted-foreground\">\n                  {new Date(batch.batchDate).toLocaleDateString()}\n                </span>\n              )}\n            </div>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'stationName' as keyof MissingSlip,\n      title: 'Station',\n      render: (value: unknown, row: MissingSlip) => {\n        const batch = batches.find(b => b.id === row.batchId)\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n            <div className=\"flex flex-col\">\n              <span className=\"font-medium\">{value as string || 'Unknown'}</span>\n              {batch?.bankName && (\n                <span className=\"text-xs text-muted-foreground\">{batch.bankName}</span>\n              )}\n            </div>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'amount' as keyof MissingSlip,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n          <span className=\"font-mono font-semibold text-red-700\">\n            Rs. {(value as number)?.toLocaleString() || '0'}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'transactionTime' as keyof MissingSlip,\n      title: 'Transaction Time',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'lastFourDigits' as keyof MissingSlip,\n      title: 'Last 4 Digits',\n      render: (value: unknown) => (\n        <span className=\"font-mono text-sm bg-muted px-2 py-1 rounded\">\n          ****{value as string}\n        </span>\n      )\n    },\n    {\n      key: 'status' as keyof MissingSlip,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          <div className=\"flex items-center gap-1\">\n            {getStatusIcon(value as string)}\n            <span>{value as string}</span>\n          </div>\n        </Badge>\n      )\n    },\n    {\n      key: 'reportedBy' as keyof MissingSlip,\n      title: 'Reported By',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">{value as string}</span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"outline\" onClick={() => router.push('/pos')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">Missing POS Slips</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Report Missing Slip\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Batch Selection */}\n          <div>\n            <Label htmlFor=\"batch\">POS Batch *</Label>\n            <Select value={selectedBatch} onValueChange={setSelectedBatch} disabled={loading}>\n              <SelectTrigger id=\"batch\">\n                <SelectValue placeholder=\"Select a batch\" />\n              </SelectTrigger>\n              <SelectContent>\n                {batches.map((batch) => (\n                  <SelectItem key={batch.id} value={batch.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <CreditCard className=\"h-4 w-4\" />\n                      <div className=\"flex flex-col\">\n                        <span className=\"font-medium\">{batch.batchNumber}</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          {new Date(batch.batchDate).toLocaleDateString()} -\n                          Rs. {batch.totalAmount.toLocaleString()}\n                        </span>\n                      </div>\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Select the batch where the slip is missing\n            </p>\n          </div>\n\n          {/* Transaction Details */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"amount\">Transaction Amount *</Label>\n              <MoneyInput\n                id=\"amount\"\n                value={amount}\n                onChange={setAmount}\n                placeholder=\"0.00\"\n                disabled={loading}\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"transactionTime\">Transaction Time *</Label>\n              <DateTimePicker\n                value={transactionTime}\n                onChange={setTransactionTime}\n                disabled={loading}\n                showSeconds={true}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"lastFourDigits\">Last 4 Digits of Card *</Label>\n              <Input\n                id=\"lastFourDigits\"\n                value={lastFourDigits}\n                onChange={(e) => {\n                  const value = e.target.value.replace(/\\D/g, '').slice(0, 4)\n                  setLastFourDigits(value)\n                }}\n                placeholder=\"1234\"\n                maxLength={4}\n                pattern=\"\\d{4}\"\n                disabled={loading}\n                required\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Enter the last 4 digits of the card number\n              </p>\n            </div>\n          </div>\n\n          {/* Information Box */}\n          <Alert>\n            <AlertTriangle className=\"h-4 w-4\" />\n            <AlertTitle>Important Information</AlertTitle>\n            <AlertDescription>\n              Missing slips should be reported as soon as they are discovered.\n              Provide accurate transaction details to help with reconciliation and investigation.\n            </AlertDescription>\n          </Alert>\n\n          <div className=\"flex justify-end gap-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/pos')} disabled={loading}>\n              Cancel\n            </Button>\n            <Button type=\"submit\" disabled={loading}>\n              {loading ? 'Reporting...' : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Report Missing Slip\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </FormCard>\n\n      <FormCard title=\"Recent Missing Slips\" className=\"p-6\">\n        <DataTable\n          data={recentSlips}\n          columns={slipColumns}\n          searchPlaceholder=\"Search missing slips...\"\n          emptyMessage=\"No missing slips reported.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\pos\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":22,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":57,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":57,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport {\n  CreditCard,\n  AlertTriangle,\n  TrendingUp,\n  AlertCircle,\n  Plus,\n  BarChart3,\n  FileText,\n  Calculator,\n  DollarSign,\n  Clock\n} from 'lucide-react'\nimport { Card, CardContent } from '@/components/ui/card'\n\ninterface POSTerminal {\n  id: string\n  stationId: string\n  stationName?: string\n  terminalNumber: string\n  name: string\n  isActive: boolean\n  lastBatchDate?: string\n  todayTransactions: number\n  todayAmount: number\n  station?: {\n    id: string\n    name: string\n  }\n}\n\ninterface RecentActivity {\n  id: string\n  type: 'BATCH' | 'MISSING_SLIP' | 'RECONCILIATION'\n  description: string\n  amount?: number\n  status: string\n  timestamp: string\n}\n\nimport { PosBatchWithDetails, PosMissingSlipWithDetails } from '@/types/db'\n\n// ... existing imports\n\nexport default function POSPage() {\n  const router = useRouter()\n  const [terminals, setTerminals] = useState<POSTerminal[]>([])\n  const [recentActivity, setRecentActivity] = useState<RecentActivity[]>([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState('')\n\n  useEffect(() => {\n    fetchPOSData()\n  }, [])\n\n  const fetchPOSData = async () => {\n    try {\n      setLoading(true)\n      const [terminalsRes, batchesRes, slipsRes] = await Promise.all([\n        fetch('/api/pos/terminals'),\n        fetch('/api/pos/batches?limit=5'),\n        fetch('/api/pos/missing-slip?limit=5')\n      ])\n\n      const terminalsData = await terminalsRes.json()\n      const batchesData: PosBatchWithDetails[] = await batchesRes.json()\n      const slipsData: PosMissingSlipWithDetails[] = await slipsRes.json()\n\n      // Transform terminals data and calculate today's stats\n      const today = new Date()\n      today.setHours(0, 0, 0, 0)\n\n      const transformedTerminals = terminalsData.map((terminal: POSTerminal) => {\n        // Get today's batches for this terminal\n        const todayBatches = batchesData.filter((batch) =>\n          batch.terminalEntries.some(entry => entry.terminalId === terminal.id) &&\n          new Date(batch.createdAt) >= today\n        )\n\n        const todayTransactions = todayBatches.reduce((sum, batch) => {\n          // Only count transactions for this specific terminal in the batch\n          const terminalEntry = batch.terminalEntries.find(e => e.terminalId === terminal.id)\n          return sum + (terminalEntry?.transactionCount || 0)\n        }, 0)\n\n        // Note: Total amount might be shared across batch, but usually batch is per terminal or multi-terminal.\n        // If batch is multi-terminal, we should calculate amount for this terminal only.\n        // Checking schema: PosBatchTerminalEntry has visaAmount, masterAmount etc. but totalAmount is on Batch.\n        // Let's calculate from entries if possible, or fall back to batch total if it's 1:1.\n\n        const todayAmount = todayBatches.reduce((sum, batch) => {\n          const terminalEntry = batch.terminalEntries.find(e => e.terminalId === terminal.id)\n          if (terminalEntry) {\n            // Sum of all payment types for this entry\n            return sum +\n              (terminalEntry.visaAmount || 0) +\n              (terminalEntry.masterAmount || 0) +\n              (terminalEntry.amexAmount || 0) +\n              (terminalEntry.qrAmount || 0) +\n              (terminalEntry.dialogTouchAmount || 0)\n          }\n          return sum\n        }, 0)\n\n        // Get last batch date\n        const lastBatch = batchesData.find((batch) =>\n          batch.terminalEntries.some(e => e.terminalId === terminal.id)\n        )\n\n        return {\n          ...terminal,\n          stationName: terminal.station?.name || `Station ${terminal.stationId}`,\n          todayTransactions,\n          todayAmount,\n          lastBatchDate: lastBatch?.createdAt ? new Date(lastBatch.createdAt).toISOString() : undefined\n        }\n      })\n\n      setTerminals(transformedTerminals)\n\n      // Combine recent activity\n      const activity: RecentActivity[] = [\n        ...batchesData.map((batch) => {\n          const entryCount = batch.terminalEntries.length\n          const description = entryCount > 1\n            ? `Batch ${batch.terminalEntries[0].startNumber}... (${entryCount} terminals)`\n            : `Batch ${batch.terminalEntries[0]?.startNumber}-${batch.terminalEntries[0]?.endNumber} created`\n\n          return {\n            id: `batch-${batch.id}`,\n            type: 'BATCH' as const,\n            description,\n            amount: batch.totalAmount,\n            status: batch.isReconciled ? 'RECONCILED' : 'PENDING',\n            timestamp: batch.createdAt.toString()\n          }\n        }),\n        ...slipsData.map((slip) => ({\n          id: `slip-${slip.id}`,\n          type: 'MISSING_SLIP' as const,\n          description: `Missing slip reported - Rs. ${slip.amount.toLocaleString()}`,\n          amount: slip.amount,\n          status: 'PENDING',\n          timestamp: new Date(slip.timestamp).toISOString()\n        }))\n      ].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\n\n      setRecentActivity(activity)\n\n      // Calculate stats\n      const activeTerminals = transformedTerminals.filter((t: POSTerminal) => t.isActive).length\n      const totalTransactions = transformedTerminals.reduce((sum: number, t: POSTerminal) => sum + t.todayTransactions, 0)\n      const totalAmount = transformedTerminals.reduce((sum: number, t: POSTerminal) => sum + t.todayAmount, 0)\n      const pendingSlips = slipsData.length // All slips are pending (no status field)\n\n      setStats({\n        activeTerminals,\n        totalTerminals: transformedTerminals.length,\n        totalTransactions,\n        totalAmount,\n        pendingSlips,\n        averageTransaction: totalTransactions > 0 ? Math.round(totalAmount / totalTransactions) : 0\n      })\n\n    } catch (err) {\n      console.error('Failed to fetch POS data:', err)\n      setError('Failed to load POS data.')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const [stats, setStats] = useState({\n    activeTerminals: 0,\n    totalTerminals: 0,\n    totalTransactions: 0,\n    totalAmount: 0,\n    pendingSlips: 0,\n    averageTransaction: 0,\n  })\n\n  const getStatusColor = (isActive: boolean) => {\n    return isActive ? 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300' : 'bg-muted text-foreground'\n  }\n\n  const getStatusText = (isActive: boolean) => {\n    return isActive ? 'ACTIVE' : 'INACTIVE'\n  }\n\n  const getActivityIcon = (type: string) => {\n    switch (type) {\n      case 'BATCH': return <CreditCard className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n      case 'MISSING_SLIP': return <AlertTriangle className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n      case 'RECONCILIATION': return <Calculator className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n      default: return <FileText className=\"h-4 w-4 text-muted-foreground\" />\n    }\n  }\n\n  const terminalColumns: Column<POSTerminal>[] = [\n    {\n      key: 'stationName' as keyof POSTerminal,\n      title: 'Station',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'terminalNumber' as keyof POSTerminal,\n      title: 'Terminal',\n      render: (value: unknown, row: POSTerminal) => (\n        <div className=\"flex items-center gap-2\">\n          <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n          <div className=\"flex flex-col\">\n            <span className=\"font-semibold\">{value as string}</span>\n            <span className=\"text-xs text-muted-foreground\">{row.name}</span>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'isActive' as keyof POSTerminal,\n      title: 'Status',\n      render: (value: unknown) => {\n        const isActive = value as boolean\n        return (\n          <Badge className={getStatusColor(isActive)}>\n            {getStatusText(isActive)}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'todayTransactions' as keyof POSTerminal,\n      title: 'Today&apos;s Transactions',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <TrendingUp className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          <span className=\"\">{(value as number)?.toLocaleString() || 0}</span>\n        </div>\n      )\n    },\n    {\n      key: 'todayAmount' as keyof POSTerminal,\n      title: 'Today&apos;s Amount',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-semibold text-green-700\">\n            Rs. {(value as number)?.toLocaleString() || 0}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'lastBatchDate' as keyof POSTerminal,\n      title: 'Last Batch',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">\n          {value ? new Date(value as string).toLocaleDateString() : 'No batches'}\n        </span>\n      )\n    }\n  ]\n\n  const activityColumns: Column<RecentActivity>[] = [\n    {\n      key: 'timestamp' as keyof RecentActivity,\n      title: 'Time',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'type' as keyof RecentActivity,\n      title: 'Type',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          {getActivityIcon(value as string)}\n          <Badge variant=\"outline\">{value as string}</Badge>\n        </div>\n      )\n    },\n    {\n      key: 'description' as keyof RecentActivity,\n      title: 'Description',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string}</span>\n      )\n    },\n    {\n      key: 'amount' as keyof RecentActivity,\n      title: 'Amount',\n      render: (value: unknown) => (\n        value ? (\n          <span className=\"text-sm\">\n            Rs. {(value as number).toLocaleString()}\n          </span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      )\n    },\n    {\n      key: 'status' as keyof RecentActivity,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{value as string}</Badge>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">POS Management</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* Statistics Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Active Terminals</h3>\n          <p className=\"text-3xl font-bold text-green-600 dark:text-green-400\">\n            {stats.activeTerminals}/{stats.totalTerminals}\n          </p>\n        </Card>\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Today&apos;s Transactions</h3>\n          <p className=\"text-3xl font-bold text-blue-600 dark:text-blue-400\">\n            {stats.totalTransactions.toLocaleString()}\n          </p>\n        </Card>\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Today&apos;s Amount</h3>\n          <p className=\"text-3xl font-bold text-purple-600 dark:text-purple-400\">\n            Rs. {stats.totalAmount.toLocaleString()}\n          </p>\n          <p className=\"text-sm text-muted-foreground\">\n            Avg: Rs. {stats.averageTransaction.toLocaleString()}\n          </p>\n        </Card>\n        <Card className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-foreground\">Pending Issues</h3>\n          <p className=\"text-3xl font-bold text-red-600 dark:text-red-400\">{stats.pendingSlips}</p>\n          <p className=\"text-sm text-muted-foreground\">Missing slips</p>\n        </Card>\n      </div>\n\n      {/* Quick Actions */}\n      <div className=\"flex flex-wrap gap-4\">\n        <Button onClick={() => router.push('/pos/batches')}>\n          <Plus className=\"mr-2 h-4 w-4\" />\n          Create Batch\n        </Button>\n        <Button variant=\"outline\" onClick={() => router.push('/pos/missing-slips')}>\n          <AlertTriangle className=\"mr-2 h-4 w-4\" />\n          Report Missing Slip\n        </Button>\n        <Button variant=\"outline\" onClick={() => router.push('/pos/reconcile')}>\n          <BarChart3 className=\"mr-2 h-4 w-4\" />\n          Reconcile\n        </Button>\n      </div>\n\n      {/* Terminals Overview */}\n      <FormCard title=\"POS Terminals\" className=\"p-6\">\n        <DataTable\n          data={terminals}\n          columns={terminalColumns}\n          searchPlaceholder=\"Search terminals...\"\n          emptyMessage=\"No POS terminals found.\"\n        />\n      </FormCard>\n\n      {/* Recent Activity */}\n      <FormCard title=\"Recent Activity\" className=\"p-6\">\n        <DataTable\n          data={recentActivity}\n          columns={activityColumns}\n          searchPlaceholder=\"Search activity...\"\n          pagination={false}\n          emptyMessage=\"No recent activity.\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\credit\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchReport'. Either include it or remove the dependency array.","line":171,"column":6,"nodeType":"ArrayExpression","endLine":171,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, selectedYear, selectedMonth, fetchReport]","fix":{"range":[4621,4667],"text":"[selectedStation, selectedYear, selectedMonth, fetchReport]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":219,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":219,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { getCurrentBusinessMonth, formatBusinessMonthRange } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n  PieLabelRenderProps\n} from 'recharts'\nimport {\n  Users,\n  DollarSign,\n  TrendingUp,\n  AlertCircle,\n  ArrowLeft,\n  RefreshCw,\n  Download,\n  AlertTriangle,\n  FileText,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { exportCreditCustomerReportPDF, exportCreditCustomerReportExcel } from '@/lib/exportUtils'\n\ninterface CreditCustomerReport {\n  summary: {\n    totalCustomers: number\n    activeCustomers: number\n    totalOutstanding: number\n    totalCreditSales: number\n    totalPayments: number\n    overdueCustomers: number\n    averageBalance: number\n  }\n  customerDetails: Array<{\n    id: string\n    name: string\n    company: string\n    phoneNumber: string\n    address: string\n    currentBalance: number\n    creditLimit: number\n    salesInPeriod: number\n    paymentsInPeriod: number\n    transactionCount: number\n    paymentCount: number\n    lastPaymentDate: string | null\n    daysSinceLastPayment: number | null\n    isOverdue: boolean\n    agingCategory: string\n    utilizationPercent: number\n  }>\n  agingBreakdown: {\n    'Current': { count: number, amount: number }\n    '1-30 days': { count: number, amount: number }\n    '31-60 days': { count: number, amount: number }\n    '61-90 days': { count: number, amount: number }\n    '90+ days': { count: number, amount: number }\n  }\n  dailyBreakdown: Array<{\n    date: string\n    sales: number\n    payments: number\n  }>\n  dateRange: {\n    start: string\n    end: string\n  }\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nconst AGING_COLORS = {\n  'Current': '#10b981',\n  '1-30 days': '#3b82f6',\n  '31-60 days': '#f59e0b',\n  '61-90 days': '#ef4444',\n  '90+ days': '#7c2d12'\n}\n\nexport default function CreditReportPage() {\n  const router = useRouter()\n  const { selectedStation, stations } = useStation()\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [reportData, setReportData] = useState<CreditCustomerReport | null>(null)\n\n  // Month selection - using business month\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedYear, setSelectedYear] = useState(currentBusinessMonth.year.toString())\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n\n  // Generate years\n  const years = Array.from({ length: 3 }, (_, i) => {\n    const year = currentBusinessMonth.year - i\n    return { value: year.toString(), label: year.toString() }\n  })\n\n  const exportToPDF = () => {\n    if (!reportData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const exportData = {\n      summary: reportData.summary,\n      customerDetails: reportData.customerDetails\n    }\n\n    exportCreditCustomerReportPDF(exportData, stationName, monthLabel)\n  }\n\n  const exportToExcel = () => {\n    if (!reportData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const exportData = {\n      summary: reportData.summary,\n      customerDetails: reportData.customerDetails\n    }\n\n    exportCreditCustomerReportExcel(exportData, stationName, monthLabel)\n  }\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchReport()\n    }\n  }, [selectedStation, selectedYear, selectedMonth])\n\n  const fetchReport = async () => {\n    if (!selectedStation) {\n      setError('Please select a station')\n      return\n    }\n\n    try {\n      setLoading(true)\n      setError('')\n\n      // Calculate business month date range\n      const year = parseInt(selectedYear)\n      const month = parseInt(selectedMonth)\n      const startDate = new Date(year, month - 1, 7)\n      const endDate = new Date(year, month, 6, 23, 59, 59)\n\n      const res = await fetch(\n        `/api/reports/credit-summary?stationId=${selectedStation}&startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`\n      )\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        console.error('Credit Summary API Error:', errorData)\n        throw new Error(errorData.details || errorData.error || 'Failed to fetch credit customer report')\n      }\n\n      const data = await res.json()\n      setReportData(data)\n    } catch (err) {\n      console.error('Error fetching credit customer report:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (loading && !reportData) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 dark:border-blue-400\"></div>\n      </div>\n    )\n  }\n\n  // Prepare pie chart data\n  const agingPieData = reportData ? Object.entries(reportData.agingBreakdown)\n    .filter(([_, data]) => data.amount > 0)\n    .map(([category, data]) => ({\n      name: category,\n      value: data.amount,\n      count: data.count\n    })) : []\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Credit Customer Reports</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Credit sales, payments, and outstanding balance analysis\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={fetchReport}>\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" disabled={!reportData}>\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export Report\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-48\">\n              <DropdownMenuItem onClick={exportToPDF} className=\"cursor-pointer\">\n                <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                <span>Export as PDF</span>\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={exportToExcel} className=\"cursor-pointer\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                <span>Export as Excel</span>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filters</CardTitle>\n          <CardDescription>Select year and month to view credit customer data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"year\">Year</Label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger id=\"year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map(year => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"month\">Month</Label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger id=\"month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map(month => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {error && (\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-2 text-red-600\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              <span>{error}</span>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Summary Cards */}\n      {reportData && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Users className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Total Customers</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                  {reportData.summary.totalCustomers}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {reportData.summary.activeCustomers} with balance\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <DollarSign className=\"h-5 w-5 text-red-600 dark:text-red-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Outstanding</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-red-600 dark:text-red-400\">\n                  Rs. {reportData.summary.totalOutstanding.toLocaleString()}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Avg: Rs. {reportData.summary.averageBalance.toLocaleString()}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <TrendingUp className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Credit Sales</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                  Rs. {reportData.summary.totalCreditSales.toLocaleString()}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  This period\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <AlertCircle className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Overdue</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\n                  {reportData.summary.overdueCustomers}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Customers 30+ days\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Daily Trend Chart */}\n          <FormCard\n            title=\"Daily Credit Sales & Payments\"\n            description={`Business Month: ${formatBusinessMonthRange({ startDate: new Date(reportData.dateRange.start), endDate: new Date(reportData.dateRange.end), month: parseInt(selectedMonth), year: parseInt(selectedYear), label: `${months.find(m => m.value === selectedMonth)?.label} ${selectedYear}` })}`}\n          >\n            <div className=\"w-full h-96 mt-4\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <LineChart data={reportData.dailyBreakdown}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis\n                    dataKey=\"date\"\n                    tickFormatter={(value) => {\n                      const d = new Date(value)\n                      return `${d.getDate()}/${d.getMonth() + 1}`\n                    }}\n                  />\n                  <YAxis tickFormatter={(value) => `Rs. ${(value / 1000).toFixed(0)}k`} />\n                  <Tooltip\n                    formatter={(value: number) => `Rs. ${value.toLocaleString()}`}\n                    labelFormatter={(date) => new Date(date).toLocaleDateString()}\n                  />\n                  <Legend />\n                  <Line\n                    type=\"monotone\"\n                    dataKey=\"sales\"\n                    stroke=\"#10b981\"\n                    strokeWidth={2}\n                    name=\"Credit Sales\"\n                  />\n                  <Line\n                    type=\"monotone\"\n                    dataKey=\"payments\"\n                    stroke=\"#3b82f6\"\n                    strokeWidth={2}\n                    name=\"Payments Received\"\n                  />\n                </LineChart>\n              </ResponsiveContainer>\n            </div>\n          </FormCard>\n\n          {/* Aging Analysis */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <FormCard title=\"Aging Analysis\" description=\"Outstanding balance by age\">\n              <div className=\"w-full h-80 mt-4\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <PieChart>\n                    <Pie\n                      data={agingPieData}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      labelLine={false}\n                      label={(props: PieLabelRenderProps) => {\n                        const percent = ((props.percent as number) ?? 0) * 100\n                        return `${props.name}: ${percent.toFixed(0)}%`\n                      }}\n                      outerRadius={80}\n                      fill=\"#8884d8\"\n                      dataKey=\"value\"\n                    >\n                      {agingPieData.map((entry, index) => (\n                        <Cell key={`cell-${index}`} fill={AGING_COLORS[entry.name as keyof typeof AGING_COLORS]} />\n                      ))}\n                    </Pie>\n                    <Tooltip formatter={(value: number) => `Rs. ${value.toLocaleString()}`} />\n                  </PieChart>\n                </ResponsiveContainer>\n              </div>\n            </FormCard>\n\n            <FormCard title=\"Aging Breakdown\" description=\"Detailed aging statistics\">\n              <div className=\"space-y-3 mt-4\">\n                {Object.entries(reportData.agingBreakdown).map(([category, data]) => (\n                  <div key={category} className=\"flex items-center justify-between p-3 rounded border\">\n                    <div className=\"flex items-center gap-3\">\n                      <div\n                        className=\"w-4 h-4 rounded\"\n                        style={{ backgroundColor: AGING_COLORS[category as keyof typeof AGING_COLORS] }}\n                      />\n                      <div>\n                        <p className=\"font-semibold\">{category}</p>\n                        <p className=\"text-sm text-muted-foreground\">{data.count} customers</p>\n                      </div>\n                    </div>\n                    <p className=\"font-semibold\">Rs. {data.amount.toLocaleString()}</p>\n                  </div>\n                ))}\n              </div>\n            </FormCard>\n          </div>\n\n          {/* Customer Details Table */}\n          <FormCard title=\"Customer Details\" description=\"Complete credit customer overview\">\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full border-collapse text-sm\">\n                <thead>\n                  <tr className=\"border-b-2 bg-muted/30\">\n                    <th className=\"text-left p-3 font-semibold\">Customer</th>\n                    <th className=\"text-right p-3 font-semibold\">Outstanding</th>\n                    <th className=\"text-right p-3 font-semibold\">Credit Limit</th>\n                    <th className=\"text-right p-3 font-semibold\">Utilization</th>\n                    <th className=\"text-right p-3 font-semibold\">Sales (Period)</th>\n                    <th className=\"text-right p-3 font-semibold\">Payments (Period)</th>\n                    <th className=\"text-left p-3 font-semibold\">Last Payment</th>\n                    <th className=\"text-left p-3 font-semibold\">Aging</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {reportData.customerDetails.map((customer, index) => (\n                    <tr key={customer.id} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                      <td className=\"p-3\">\n                        <div>\n                          <p className=\"font-medium\">{customer.name}</p>\n                          <p className=\"text-xs text-muted-foreground\">{customer.company}</p>\n                          <p className=\"text-xs text-muted-foreground\">{customer.phoneNumber}</p>\n                        </div>\n                      </td>\n                      <td className=\"text-right p-3\">\n                        <span className={customer.currentBalance > 0 ? 'text-red-600 font-semibold' : ''}>\n                          Rs. {customer.currentBalance.toLocaleString()}\n                        </span>\n                      </td>\n                      <td className=\"text-right p-3\">\n                        Rs. {customer.creditLimit.toLocaleString()}\n                      </td>\n                      <td className=\"text-right p-3\">\n                        <span className={`px-2 py-1 rounded text-xs ${customer.utilizationPercent > 80 ? 'bg-red-100 text-red-700' :\n                          customer.utilizationPercent > 50 ? 'bg-orange-100 text-orange-700' :\n                            'bg-green-100 text-green-700'\n                          }`}>\n                          {customer.utilizationPercent.toFixed(0)}%\n                        </span>\n                      </td>\n                      <td className=\"text-right p-3\">Rs. {customer.salesInPeriod.toLocaleString()}</td>\n                      <td className=\"text-right p-3\">Rs. {customer.paymentsInPeriod.toLocaleString()}</td>\n                      <td className=\"p-3\">\n                        {customer.lastPaymentDate\n                          ? new Date(customer.lastPaymentDate).toLocaleDateString()\n                          : 'Never'}\n                      </td>\n                      <td className=\"p-3\">\n                        <span\n                          className=\"px-2 py-1 rounded text-xs font-medium\"\n                          style={{\n                            backgroundColor: `${AGING_COLORS[customer.agingCategory as keyof typeof AGING_COLORS]}20`,\n                            color: AGING_COLORS[customer.agingCategory as keyof typeof AGING_COLORS]\n                          }}\n                        >\n                          {customer.agingCategory}\n                        </span>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </FormCard>\n        </>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\daily-sales-liters\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getBusinessMonthDateRange' is defined but never used.","line":6,"column":53,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":78},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSalesData'. Either include it or remove the dependency array.","line":116,"column":6,"nodeType":"ArrayExpression","endLine":116,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, selectedYear, selectedMonth, fetchSalesData]","fix":{"range":[3288,3334],"text":"[selectedStation, selectedYear, selectedMonth, fetchSalesData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { getCurrentBusinessMonth, getBusinessMonth, getBusinessMonthDateRange, formatBusinessMonthRange } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer\n} from 'recharts'\nimport {\n  TrendingUp,\n  Fuel,\n  Calendar,\n  Download,\n  RefreshCw,\n  BarChart3,\n  ArrowLeft,\n  ArrowRight,\n  FileText,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { exportDailySalesLitersReportPDF, exportDailySalesLitersReportExcel } from '@/lib/exportUtils'\n\ninterface DailySalesData {\n  date: string\n  day: number\n  liters: Record<string, number> // fuelType -> liters\n  totalLiters: number\n}\n\ninterface DailySalesResponse {\n  month: string\n  startDate: string\n  endDate: string\n  dailySales: DailySalesData[]\n  totalLitersByFuelType: Record<string, number>\n  fuelTypes: string[]\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nconst fuelTypeColors: Record<string, string> = {\n  'PETROL_92': '#3b82f6', // Blue\n  'PETROL_95': '#8b5cf6', // Purple\n  'DIESEL': '#10b981', // Green\n  'SUPER_DIESEL': '#f59e0b', // Amber\n  'OIL': '#ef4444' // Red\n}\n\nconst formatFuelType = (fuelType: string): string => {\n  return fuelType\n    .split('_')\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n    .join(' ')\n}\n\nexport default function DailySalesLitersReportPage() {\n  const router = useRouter()\n  const { selectedStation, stations, setSelectedStation } = useStation()\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [salesData, setSalesData] = useState<DailySalesResponse | null>(null)\n\n  // Month selection - using business month (7th to 6th)\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedYear, setSelectedYear] = useState(currentBusinessMonth.year.toString())\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n\n  // Generate years (current year and previous 2 years)\n  const years = Array.from({ length: 3 }, (_, i) => {\n    const year = currentBusinessMonth.year - i\n    return { value: year.toString(), label: year.toString() }\n  })\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchSalesData()\n    }\n  }, [selectedStation, selectedYear, selectedMonth])\n\n  const fetchSalesData = async () => {\n    if (!selectedStation) {\n      setError('Please select a station')\n      return\n    }\n\n    try {\n      setLoading(true)\n      setError('')\n\n      const month = `${selectedYear}-${selectedMonth}`\n      const res = await fetch(`/api/reports/daily-sales?stationId=${selectedStation}&month=${month}`)\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to fetch daily sales data')\n      }\n\n      const data = await res.json()\n      setSalesData(data)\n    } catch (err) {\n      console.error('Error fetching daily sales data:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load daily sales data')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Prepare chart data\n  interface ChartDataPoint {\n    day: number\n    date: string\n    total?: number\n    [key: string]: string | number | undefined\n  }\n\n  const chartData = salesData?.dailySales.map(day => {\n    const dataPoint: ChartDataPoint = {\n      day: day.day,\n      date: day.date\n    }\n\n    // Add liters for each fuel type\n    salesData.fuelTypes.forEach(fuelType => {\n      dataPoint[fuelType] = day.liters[fuelType] || 0\n    })\n\n    dataPoint.total = day.totalLiters\n\n    return dataPoint\n  }) || []\n\n  const exportToPDF = () => {\n    if (!salesData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const reportData = {\n      dailySales: salesData.dailySales.map(day => ({\n        date: day.date,\n        sales: day.liters,\n        totalLiters: day.totalLiters\n      })),\n      fuelTypes: salesData.fuelTypes,\n      grandTotal: salesData.dailySales.reduce((sum, day) => sum + day.totalLiters, 0)\n    }\n\n    exportDailySalesLitersReportPDF(reportData, stationName, monthLabel)\n  }\n\n  const exportToExcel = () => {\n    if (!salesData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const reportData = {\n      dailySales: salesData.dailySales.map(day => ({\n        date: day.date,\n        sales: day.liters,\n        totalLiters: day.totalLiters\n      })),\n      fuelTypes: salesData.fuelTypes,\n      grandTotal: salesData.dailySales.reduce((sum, day) => sum + day.totalLiters, 0)\n    }\n\n    exportDailySalesLitersReportExcel(reportData, stationName, monthLabel)\n  }\n\n  if (loading && !salesData) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n              <BarChart3 className=\"h-8 w-8 text-blue-600 dark:text-blue-400\" />\n              Daily Sales Report by Fuel Type (Liters)\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Monthly sales volume analysis with daily breakdown by fuel type\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports/daily-sales')}>\n            View Rs Report\n            <ArrowRight className=\"ml-2 h-4 w-4\" />\n          </Button>\n          <Button variant=\"outline\" onClick={fetchSalesData}>\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" disabled={!salesData}>\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export Report\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-48\">\n              <DropdownMenuItem onClick={exportToPDF} className=\"cursor-pointer\">\n                <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                <span>Export as PDF</span>\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={exportToExcel} className=\"cursor-pointer\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                <span>Export as Excel</span>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filters</CardTitle>\n          <CardDescription>Select station, year, and month to view sales data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"station\">Station</Label>\n              <Select\n                value={selectedStation || 'all'}\n                onValueChange={(value) => setSelectedStation(value)}\n              >\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Stations</SelectItem>\n                  {stations.map(station => (\n                    <SelectItem key={station.id} value={station.id}>\n                      {station.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"year\">Year</Label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger id=\"year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map(year => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"month\">Month</Label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger id=\"month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map(month => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {error && (\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-2 text-red-600\">\n              <span>{error}</span>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Summary Cards */}\n      {salesData && salesData.totalLitersByFuelType && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {salesData.fuelTypes.map(fuelType => (\n            <Card key={fuelType}>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Fuel className=\"h-4 w-4\" style={{ color: fuelTypeColors[fuelType] || '#666' }} />\n                  {formatFuelType(fuelType)}\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">\n                  {(salesData.totalLitersByFuelType[fuelType] || 0).toLocaleString()} L\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Total for {months.find(m => m.value === selectedMonth)?.label} {selectedYear}\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                <TrendingUp className=\"h-4 w-4 text-blue-600\" />\n                Total Volume\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-blue-600\">\n                {salesData.dailySales.reduce((sum, day) => sum + day.totalLiters, 0).toLocaleString()} L\n              </div>\n              <div className=\"text-xs text-muted-foreground mt-1\">\n                All fuel types combined\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Chart */}\n      {salesData && salesData.dailySales.length > 0 ? (\n        <FormCard\n          title=\"Daily Sales Volume Trend\"\n          description={`Business Month: ${formatBusinessMonthRange(getBusinessMonth(parseInt(selectedMonth), parseInt(selectedYear)))}`}\n        >\n          <div className=\"w-full h-96 mt-4\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <LineChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis\n                  dataKey=\"date\"\n                  tick={{ fontSize: 10 }}\n                  tickFormatter={(value) => {\n                    const d = new Date(value)\n                    return `${d.getDate()}/${d.getMonth() + 1}`\n                  }}\n                />\n                <YAxis\n                  label={{ value: 'Liters', angle: -90, position: 'insideLeft' }}\n                  tickFormatter={(value) => `${(value / 1000).toFixed(1)}k L`}\n                />\n                <Tooltip\n                  formatter={(value: number) => `${value.toLocaleString()} L`}\n                  labelFormatter={(date) => {\n                    const d = new Date(date)\n                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })\n                  }}\n                />\n                <Legend\n                  formatter={(value) => formatFuelType(value)}\n                />\n                {salesData.fuelTypes.map(fuelType => (\n                  <Line\n                    key={fuelType}\n                    type=\"monotone\"\n                    dataKey={fuelType}\n                    stroke={fuelTypeColors[fuelType] || '#666'}\n                    strokeWidth={2}\n                    dot={{ r: 3 }}\n                    name={fuelType}\n                  />\n                ))}\n              </LineChart>\n            </ResponsiveContainer>\n          </div>\n        </FormCard>\n      ) : salesData && salesData.dailySales.length === 0 ? (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n              <p>No sales data found for this month</p>\n              <p className=\"text-sm\">No shifts were closed during this period</p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : null}\n\n      {/* Data Table */}\n      {salesData && salesData.dailySales.length > 0 && (\n        <FormCard\n          title=\"Daily Sales Volume Breakdown\"\n          description=\"Detailed daily sales by fuel type (in Liters) with totals\"\n        >\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full border-collapse\">\n              <thead>\n                <tr className=\"border-b-2 bg-muted/30\">\n                  <th className=\"text-left p-3 font-semibold\">Day</th>\n                  {salesData.fuelTypes.map(fuelType => (\n                    <th key={fuelType} className=\"text-right p-3 font-semibold\" style={{ color: fuelTypeColors[fuelType] || '#666' }}>\n                      {formatFuelType(fuelType)} (L)\n                    </th>\n                  ))}\n                  <th className=\"text-right p-3 font-semibold text-blue-600 dark:text-blue-400\">Daily Total (L)</th>\n                </tr>\n              </thead>\n              <tbody>\n                {salesData.dailySales.map((day, index) => (\n                  <tr key={day.date} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                    <td className=\"p-3 font-medium\">Day {day.day}</td>\n                    {salesData.fuelTypes.map(fuelType => (\n                      <td key={fuelType} className=\"text-right p-3 text-sm\">\n                        {(day.liters[fuelType] || 0).toLocaleString()} L\n                      </td>\n                    ))}\n                    <td className=\"text-right p-3 font-semibold text-blue-600 dark:text-blue-400\">\n                      {day.totalLiters.toLocaleString()} L\n                    </td>\n                  </tr>\n                ))}\n                <tr className=\"border-t-4 font-bold bg-blue-50 dark:bg-blue-950/20\">\n                  <td className=\"p-3 text-lg\">TOTAL</td>\n                  {salesData.fuelTypes.map(fuelType => (\n                    <td key={fuelType} className=\"text-right p-3 text-base\" style={{ color: fuelTypeColors[fuelType] || '#666' }}>\n                      {(salesData.totalLitersByFuelType[fuelType] || 0).toLocaleString()} L\n                    </td>\n                  ))}\n                  <td className=\"text-right p-3 text-lg text-blue-600 dark:text-blue-400\">\n                    {salesData.dailySales.reduce((sum, day) => sum + day.totalLiters, 0).toLocaleString()} L\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </FormCard>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\daily-sales\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSalesData'. Either include it or remove the dependency array.","line":114,"column":6,"nodeType":"ArrayExpression","endLine":114,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, selectedYear, selectedMonth, fetchSalesData]","fix":{"range":[3176,3222],"text":"[selectedStation, selectedYear, selectedMonth, fetchSalesData]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dateRange' is assigned a value but never used.","line":127,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":127,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { getCurrentBusinessMonth, getBusinessMonth, getBusinessMonthDateRange, formatBusinessMonthRange } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer\n} from 'recharts'\nimport {\n  TrendingUp,\n  Fuel,\n  Calendar,\n  Download,\n  RefreshCw,\n  BarChart3,\n  ArrowLeft,\n  ArrowRight,\n  FileText,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { exportDailySalesReportPDF, exportDailySalesReportExcel, captureChartAsImage } from '@/lib/exportUtils'\n\ninterface DailySalesData {\n  date: string\n  day: number\n  sales: Record<string, number> // fuelType -> amount\n  totalSales: number\n}\n\ninterface DailySalesResponse {\n  month: string\n  startDate: string\n  endDate: string\n  dailySales: DailySalesData[]\n  totalsByFuelType: Record<string, number>\n  fuelTypes: string[]\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nconst fuelColors: Record<string, string> = {\n  'Petrol 92': '#3b82f6',\n  'Petrol 95': '#8b5cf6',\n  'Diesel': '#10b981',\n  'Super Diesel': '#f59e0b',\n  'Extra Mile': '#ec4899',\n  'Oil': '#ef4444'\n}\n\nconst getFuelColor = (fuelName: string): string => {\n  return fuelColors[fuelName] || '#666'\n}\n\nexport default function DailySalesReportPage() {\n  const router = useRouter()\n  const { selectedStation, stations, setSelectedStation } = useStation()\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [salesData, setSalesData] = useState<DailySalesResponse | null>(null)\n\n  // Month selection - using business month (7th to 6th)\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedYear, setSelectedYear] = useState(currentBusinessMonth.year.toString())\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n\n  // Generate years (current year and previous 2 years)\n  const years = Array.from({ length: 3 }, (_, i) => {\n    const year = currentBusinessMonth.year - i\n    return { value: year.toString(), label: year.toString() }\n  })\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchSalesData()\n    }\n  }, [selectedStation, selectedYear, selectedMonth])\n\n  const fetchSalesData = async () => {\n    if (!selectedStation) {\n      setError('Please select a station')\n      return\n    }\n\n    try {\n      setLoading(true)\n      setError('')\n\n      // Get business month date range (7th to 6th)\n      const dateRange = getBusinessMonthDateRange(parseInt(selectedMonth), parseInt(selectedYear))\n      const month = `${selectedYear}-${selectedMonth}`\n      const res = await fetch(`/api/reports/daily-sales?stationId=${selectedStation}&month=${month}`)\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to fetch daily sales data')\n      }\n\n      const data = await res.json()\n      setSalesData(data)\n    } catch (err) {\n      console.error('Error fetching daily sales data:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load daily sales data')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Prepare chart data\n  interface ChartDataPoint {\n    day: number\n    date: string\n    total?: number\n    [key: string]: string | number | undefined\n  }\n\n  const chartData = salesData?.dailySales.map(day => {\n    const dataPoint: ChartDataPoint = {\n      day: day.day,\n      date: day.date\n    }\n\n    // Add sales for each fuel type\n    salesData.fuelTypes.forEach(fuelName => {\n      dataPoint[fuelName] = day.sales?.[fuelName] || 0\n    })\n\n    dataPoint.total = day.totalSales\n\n    return dataPoint\n  }) || []\n\n  const exportToPDF = async () => {\n    if (!salesData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    // Capture chart as image\n    const chartImage = await captureChartAsImage('daily-sales-chart')\n\n    const reportData = {\n      dailySales: salesData.dailySales,\n      fuelTypes: salesData.fuelTypes,\n      grandTotal: salesData.dailySales.reduce((sum, day) => sum + day.totalSales, 0)\n    }\n\n    await exportDailySalesReportPDF(reportData, stationName, monthLabel, chartImage || undefined)\n  }\n\n  const exportToExcel = () => {\n    if (!salesData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const reportData = {\n      dailySales: salesData.dailySales,\n      fuelTypes: salesData.fuelTypes,\n      grandTotal: salesData.dailySales.reduce((sum, day) => sum + day.totalSales, 0)\n    }\n\n    exportDailySalesReportExcel(reportData, stationName, monthLabel)\n  }\n\n  if (loading && !salesData) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n              <BarChart3 className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n              Daily Sales Report by Fuel Type (Rs)\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Monthly sales revenue analysis with daily breakdown by fuel type\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports/daily-sales-liters')}>\n            View Liters Report\n            <ArrowRight className=\"ml-2 h-4 w-4\" />\n          </Button>\n          <Button variant=\"outline\" onClick={fetchSalesData}>\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" disabled={!salesData}>\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export Report\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-48\">\n              <DropdownMenuItem onClick={exportToPDF} className=\"cursor-pointer\">\n                <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                <span>Export as PDF</span>\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={exportToExcel} className=\"cursor-pointer\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                <span>Export as Excel</span>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filters</CardTitle>\n          <CardDescription>Select station, year, and month to view sales data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"station\">Station</Label>\n              <Select\n                value={selectedStation || 'all'}\n                onValueChange={(value) => setSelectedStation(value)}\n              >\n                <SelectTrigger id=\"station\">\n                  <SelectValue placeholder=\"Select station\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Stations</SelectItem>\n                  {stations.map(station => (\n                    <SelectItem key={station.id} value={station.id}>\n                      {station.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"year\">Year</Label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger id=\"year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map(year => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"month\">Month</Label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger id=\"month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map(month => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {error && (\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-2 text-red-600\">\n              <span>{error}</span>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Summary Cards */}\n      {salesData && salesData.totalsByFuelType && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {salesData.fuelTypes.map(fuelName => (\n            <Card key={fuelName}>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Fuel className=\"h-4 w-4\" style={{ color: getFuelColor(fuelName) }} />\n                  {fuelName}\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">\n                  Rs. {(salesData.totalsByFuelType?.[fuelName] || 0).toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Total for {months.find(m => m.value === selectedMonth)?.label} {selectedYear}\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                <TrendingUp className=\"h-4 w-4 text-purple-600\" />\n                Total Sales\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-purple-600\">\n                Rs. {salesData.dailySales.reduce((sum, day) => sum + day.totalSales, 0).toLocaleString()}\n              </div>\n              <div className=\"text-xs text-muted-foreground mt-1\">\n                All fuel types combined\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Chart */}\n      {salesData && salesData.dailySales.length > 0 ? (\n        <FormCard\n          title=\"Daily Sales Trend\"\n          description={`Business Month: ${formatBusinessMonthRange(getBusinessMonth(parseInt(selectedMonth), parseInt(selectedYear)))}`}\n        >\n          <div id=\"daily-sales-chart\" className=\"w-full h-96 mt-4\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <LineChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis\n                  dataKey=\"date\"\n                  tick={{ fontSize: 10 }}\n                  tickFormatter={(value) => {\n                    const d = new Date(value)\n                    return `${d.getDate()}/${d.getMonth() + 1}`\n                  }}\n                />\n                <YAxis\n                  label={{ value: 'Sales (Rs.)', angle: -90, position: 'insideLeft' }}\n                  tickFormatter={(value) => `Rs. ${(value / 1000).toFixed(0)}k`}\n                />\n                <Tooltip\n                  formatter={(value: number) => `Rs. ${value.toLocaleString()}`}\n                  labelFormatter={(date) => {\n                    const d = new Date(date)\n                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })\n                  }}\n                />\n                <Legend\n                  formatter={(value) => value}\n                />\n                {salesData.fuelTypes.map(fuelName => (\n                  <Line\n                    key={fuelName}\n                    type=\"monotone\"\n                    dataKey={fuelName}\n                    stroke={getFuelColor(fuelName)}\n                    strokeWidth={2}\n                    dot={{ r: 3 }}\n                    name={fuelName}\n                  />\n                ))}\n              </LineChart>\n            </ResponsiveContainer>\n          </div>\n        </FormCard>\n      ) : salesData && salesData.dailySales.length === 0 ? (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n              <p>No sales data found for this month</p>\n              <p className=\"text-sm\">No shifts were closed during this period</p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : null}\n\n      {/* Data Table */}\n      {salesData && salesData.dailySales.length > 0 && (\n        <FormCard\n          title=\"Daily Sales Breakdown\"\n          description=\"Detailed daily sales by fuel type with totals\"\n        >\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full border-collapse\">\n              <thead>\n                <tr className=\"border-b-2 bg-muted/30\">\n                  <th className=\"text-left p-3 font-semibold\">Day</th>\n                  {salesData.fuelTypes.map(fuelName => (\n                    <th key={fuelName} className=\"text-right p-3 font-semibold\" style={{ color: getFuelColor(fuelName) }}>\n                      {fuelName}\n                    </th>\n                  ))}\n                  <th className=\"text-right p-3 font-semibold text-purple-600 dark:text-purple-400\">Daily Total</th>\n                </tr>\n              </thead>\n              <tbody>\n                {salesData.dailySales.map((day, index) => (\n                  <tr key={day.date} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                    <td className=\"p-3 font-medium\">Day {day.day}</td>\n                    {salesData.fuelTypes.map(fuelName => (\n                      <td key={fuelName} className=\"text-right p-3 text-sm\">\n                        Rs. {(day.sales?.[fuelName] || 0).toLocaleString()}\n                      </td>\n                    ))}\n                    <td className=\"text-right p-3 font-semibold text-purple-600 dark:text-purple-400\">\n                      Rs. {day.totalSales.toLocaleString()}\n                    </td>\n                  </tr>\n                ))}\n                <tr className=\"border-t-4 font-bold bg-purple-50 dark:bg-purple-950/20\">\n                  <td className=\"p-3 text-lg\">TOTAL</td>\n                  {salesData.fuelTypes.map(fuelName => (\n                    <td key={fuelName} className=\"text-right p-3 text-base\" style={{ color: getFuelColor(fuelName) }}>\n                      Rs. {(salesData.totalsByFuelType?.[fuelName] || 0).toLocaleString()}\n                    </td>\n                  ))}\n                  <td className=\"text-right p-3 text-lg text-purple-600 dark:text-purple-400\">\n                    Rs. {salesData.dailySales.reduce((sum, day) => sum + day.totalSales, 0).toLocaleString()}\n                  </td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </FormCard>\n      )}\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\daily\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ExternalLink' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":168,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":168,"endColumn":19}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5625,5628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5625,5628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5655,5658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5655,5658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5683,5686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5683,5686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Building2,\n  DollarSign,\n  Calendar,\n  TrendingUp,\n  TrendingDown,\n  AlertTriangle,\n  AlertCircle,\n  Download,\n  FileText,\n  Fuel,\n  CreditCard,\n  Banknote,\n  Calculator,\n  ExternalLink,\n  Users,\n  Receipt,\n  Clock,\n  BarChart3,\n  PieChart,\n  Wallet,\n  ArrowUp,\n  ArrowDown,\n  CheckCircle\n} from 'lucide-react'\nimport { exportDailyReportPDF, exportDailyReportExcel, DailyReportData } from '@/lib/exportUtils'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface POSTerminalBreakdown {\n  terminalId: string\n  terminalName: string\n  terminalNumber: string\n  bankName?: string\n  totalAmount: number\n  transactionCount: number\n  visaAmount: number\n  mastercardAmount: number\n  amexAmount: number\n  qrAmount: number\n  dialogTouchAmount: number\n  missingSlips: number\n  missingSlipAmount: number\n}\n\ninterface CreditCustomerBreakdown {\n  customerId: string\n  customerName: string\n  totalSales: number\n  transactionCount: number\n  averageTransaction: number\n  creditLimit: number\n  currentBalance: number\n  paymentReceived: number\n}\n\ninterface ChequeBreakdown {\n  chequeId: string\n  chequeNumber: string\n  amount: number\n  receivedFrom: string\n  bankName: string\n  bankBranch?: string\n  receivedDate: string\n  status: 'PENDING' | 'CLEARED' | 'BOUNCED'\n}\n\ninterface DailyReport {\n  date: string\n  stationId: string\n  stationName: string\n\n  // Sales breakdown by fuel type\n  petrolSales: number\n  dieselSales: number\n  superDieselSales: number\n  oilSales: number\n  canSales: number\n  totalFuelSales: number\n  totalSales: number\n\n  // Tender breakdown\n  cashAmount: number\n  cardAmount: number\n  creditAmount: number\n  chequeAmount: number\n\n  // POS Terminal breakdown\n  posTerminals: POSTerminalBreakdown[]\n  totalPOSAmount: number\n\n  // Credit customer breakdown\n  creditCustomers: CreditCustomerBreakdown[]\n  totalCreditSales: number\n\n  // Cheque breakdown\n  cheques: ChequeBreakdown[]\n  totalChequeAmount: number\n\n  // Financial summary\n  totalExpenses: number\n  totalDeposits: number\n  totalLoans: number\n  netProfit: number\n\n  // Variance and exceptions\n  totalVariance: number\n  variancePercentage: number\n  missingSlips: Array<{\n    id: string\n    terminalName: string\n    amount: number\n    time: string\n    lastFourDigits: string\n    reportedBy: string\n    status: 'PENDING' | 'RESOLVED' | 'WRITTEN_OFF'\n  }>\n\n  // Additional metrics\n  shiftCount: number\n  transactionCount: number\n  averageTransaction: number\n  cashPercentage: number\n  cardPercentage: number\n  creditPercentage: number\n  chequePercentage: number\n}\n\nexport default function DailyReportsPage() {\n  const [stations, setStations] = useState<Station[]>([])\n  const [dailyReport, setDailyReport] = useState<DailyReport | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0])\n\n  // Load initial data\n  useEffect(() => {\n    const loadStations = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadStations()\n  }, [])\n\n  const generateReport = async () => {\n    if (!selectedStation || !selectedDate) {\n      setError('Please select both station and date')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call the API to get real daily report data\n      const url = `/api/reports/daily-comprehensive?stationId=${selectedStation}&date=${selectedDate}`\n      console.log('[Frontend] Fetching daily report from:', url)\n\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        cache: 'no-store'\n      })\n\n      console.log('[Frontend] Response status:', response.status, response.statusText)\n\n      if (!response.ok) {\n        let errorData: Record<string, unknown> = {}\n        try {\n          const text = await response.text()\n          if (text) {\n            try {\n              errorData = JSON.parse(text)\n            } catch {\n              errorData = { error: `HTTP ${response.status}: ${response.statusText}`, details: text }\n            }\n          } else {\n            errorData = { error: `HTTP ${response.status}: ${response.statusText}`, details: 'Empty response body' }\n          }\n        } catch (jsonError) {\n          console.error('[Frontend] Error parsing error response:', jsonError)\n          errorData = { error: `HTTP ${response.status}: ${response.statusText}`, details: 'Failed to parse error response' }\n        }\n        console.error('[Frontend] API error response:', errorData)\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const errorMessage = (errorData as any).message || (errorData as any).error || (errorData as any).details || 'Unknown error'\n        throw new Error(`Failed to fetch daily report: ${response.status} ${response.statusText}. ${errorMessage}`)\n      }\n\n      const reportData = await response.json()\n      console.log('[Frontend] Daily report data received, fields:', Object.keys(reportData))\n      console.log('[Frontend] Daily report summary:', {\n        stationName: reportData.stationName,\n        date: reportData.date,\n        totalSales: reportData.totalSales,\n        shiftCount: reportData.shiftCount,\n        transactionCount: reportData.transactionCount,\n        petrolSales: reportData.petrolSales,\n        dieselSales: reportData.dieselSales,\n        cashAmount: reportData.cashAmount,\n        cardAmount: reportData.cardAmount,\n        totalExpenses: reportData.totalExpenses\n      })\n      console.log('[Frontend] Full report data:', reportData)\n\n      // Validate required fields and transform if needed\n      if (!reportData || typeof reportData !== 'object') {\n        throw new Error('Invalid response format from API')\n      }\n\n      // Use API response directly (it matches the interface)\n      setDailyReport(reportData as DailyReport)\n\n    } catch (err) {\n      console.error('Error fetching daily report:', err)\n      setError('Failed to generate daily report: ' + (err instanceof Error ? err.message : 'Unknown error'))\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const exportToPDF = () => {\n    if (!dailyReport || !selectedStation) {\n      alert('Please select a station and generate a report first')\n      return\n    }\n\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'Unknown Station'\n    const dateStr = selectedDate\n\n    const exportData: DailyReportData = {\n      salesBreakdown: {\n        petrol92: { litres: 0, amount: dailyReport.petrolSales },\n        petrol95: { litres: 0, amount: 0 },\n        diesel: { litres: 0, amount: dailyReport.dieselSales },\n        superDiesel: { litres: 0, amount: dailyReport.superDieselSales },\n      },\n      totalSales: dailyReport.totalSales,\n      totalExpenses: dailyReport.totalExpenses,\n      netProfit: dailyReport.netProfit,\n      variancePercentage: dailyReport.variancePercentage\n    }\n\n    exportDailyReportPDF(exportData, stationName, dateStr)\n  }\n\n  const exportToExcel = () => {\n    if (!dailyReport || !selectedStation) {\n      alert('Please select a station and generate a report first')\n      return\n    }\n\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'Unknown Station'\n    const dateStr = selectedDate\n\n    const exportData: DailyReportData = {\n      salesBreakdown: {\n        petrol92: { litres: 0, amount: dailyReport.petrolSales },\n        petrol95: { litres: 0, amount: 0 },\n        diesel: { litres: 0, amount: dailyReport.dieselSales },\n        superDiesel: { litres: 0, amount: dailyReport.superDieselSales },\n      },\n      totalSales: dailyReport.totalSales,\n      totalExpenses: dailyReport.totalExpenses,\n      netProfit: dailyReport.netProfit,\n      variancePercentage: dailyReport.variancePercentage\n    }\n\n    exportDailyReportExcel(exportData, stationName, dateStr)\n  }\n\n  const getVarianceColor = (percentage: number) => {\n    if (Math.abs(percentage) <= 0.5) return 'text-green-600 dark:text-green-400'\n    if (Math.abs(percentage) <= 1.0) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-red-600 dark:text-red-400'\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'RESOLVED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'PENDING': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'WRITTEN_OFF': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      case 'CLEARED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'BOUNCED': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  // POS Terminal columns\n  const posTerminalColumns: Column<POSTerminalBreakdown>[] = [\n    {\n      key: 'terminalName' as keyof POSTerminalBreakdown,\n      title: 'Terminal',\n      render: (value: unknown, row: POSTerminalBreakdown) => (\n        <div>\n          <div className=\"font-medium\">{value as string}</div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.terminalNumber} {row.bankName && ` ${row.bankName}`}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'transactionCount' as keyof POSTerminalBreakdown,\n      title: 'Transactions',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{value as number}</Badge>\n      )\n    },\n    {\n      key: 'visaAmount' as keyof POSTerminalBreakdown,\n      title: 'Visa',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-blue-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'mastercardAmount' as keyof POSTerminalBreakdown,\n      title: 'Mastercard',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-red-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'amexAmount' as keyof POSTerminalBreakdown,\n      title: 'Amex',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-green-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'qrAmount' as keyof POSTerminalBreakdown,\n      title: 'QR',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-purple-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'dialogTouchAmount' as keyof POSTerminalBreakdown,\n      title: 'Dialog Touch',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-orange-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'totalAmount' as keyof POSTerminalBreakdown,\n      title: 'Total',\n      render: (value: unknown) => (\n        <span className=\"font-bold\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'missingSlips' as keyof POSTerminalBreakdown,\n      title: 'Missing Slips',\n      render: (value: unknown, row: POSTerminalBreakdown) => (\n        <div>\n          {row.missingSlips > 0 ? (\n            <Badge variant=\"destructive\">\n              {row.missingSlips} slip{row.missingSlips > 1 ? 's' : ''}\n            </Badge>\n          ) : (\n            <Badge variant=\"outline\" className=\"text-green-600\">None</Badge>\n          )}\n        </div>\n      )\n    }\n  ]\n\n  // Credit Customer columns\n  const creditCustomerColumns: Column<CreditCustomerBreakdown>[] = [\n    {\n      key: 'customerName' as keyof CreditCustomerBreakdown,\n      title: 'Customer',\n      render: (value: unknown) => (\n        <div className=\"font-medium\">{value as string}</div>\n      )\n    },\n    {\n      key: 'transactionCount' as keyof CreditCustomerBreakdown,\n      title: 'Transactions',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{value as number}</Badge>\n      )\n    },\n    {\n      key: 'totalSales' as keyof CreditCustomerBreakdown,\n      title: 'Total Sales',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-green-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'averageTransaction' as keyof CreditCustomerBreakdown,\n      title: 'Avg Transaction',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'creditLimit' as keyof CreditCustomerBreakdown,\n      title: 'Credit Limit',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'currentBalance' as keyof CreditCustomerBreakdown,\n      title: 'Current Balance',\n      render: (value: unknown, row: CreditCustomerBreakdown) => {\n        const usagePercent = (row.currentBalance / row.creditLimit) * 100\n        return (\n          <div>\n            <span className=\"font-semibold\">\n              Rs. {(value as number).toLocaleString()}\n            </span>\n            <div className=\"text-xs text-muted-foreground\">\n              {usagePercent.toFixed(1)}% used\n            </div>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'paymentReceived' as keyof CreditCustomerBreakdown,\n      title: 'Payment Received',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-blue-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    }\n  ]\n\n  // Cheque columns\n  const chequeColumns: Column<ChequeBreakdown>[] = [\n    {\n      key: 'chequeNumber' as keyof ChequeBreakdown,\n      title: 'Cheque Number',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'receivedFrom' as keyof ChequeBreakdown,\n      title: 'Received From',\n      render: (value: unknown) => (\n        <div className=\"font-medium\">{value as string}</div>\n      )\n    },\n    {\n      key: 'amount' as keyof ChequeBreakdown,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-green-600\">\n          Rs. {(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'bankName' as keyof ChequeBreakdown,\n      title: 'Bank',\n      render: (value: unknown, row: ChequeBreakdown) => (\n        <div>\n          <div className=\"text-sm\">{value as string}</div>\n          {row.bankBranch && (\n            <div className=\"text-xs text-muted-foreground\">{row.bankBranch}</div>\n          )}\n        </div>\n      )\n    },\n    {\n      key: 'receivedDate' as keyof ChequeBreakdown,\n      title: 'Date',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">\n          {new Date(value as string).toLocaleDateString()}\n        </span>\n      )\n    },\n    {\n      key: 'status' as keyof ChequeBreakdown,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    }\n  ]\n\n  // Missing slip columns\n  const missingSlipColumns: Column<DailyReport['missingSlips'][0]>[] = [\n    {\n      key: 'time' as keyof DailyReport['missingSlips'][0],\n      title: 'Time',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string}</span>\n      )\n    },\n    {\n      key: 'terminalName' as keyof DailyReport['missingSlips'][0],\n      title: 'Terminal',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'amount' as keyof DailyReport['missingSlips'][0],\n      title: 'Amount',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-red-600 dark:text-red-400\">\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'lastFourDigits' as keyof DailyReport['missingSlips'][0],\n      title: 'Card Digits',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">****{value as string}</span>\n      )\n    },\n    {\n      key: 'reportedBy' as keyof DailyReport['missingSlips'][0],\n      title: 'Reported By',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string}</span>\n      )\n    },\n    {\n      key: 'status' as keyof DailyReport['missingSlips'][0],\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n            <BarChart3 className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n            Daily Sales Report\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Comprehensive daily sales analysis with detailed breakdowns\n          </p>\n        </div>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* Report Generator */}\n      <FormCard title=\"Generate Daily Report\" description=\"Select station and date to generate comprehensive daily report\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station *</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"date\">Date *</Label>\n            <input\n              id=\"date\"\n              type=\"date\"\n              value={selectedDate}\n              onChange={(e) => setSelectedDate(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !selectedStation || !selectedDate} className=\"w-full\">\n              {loading ? (\n                'Generating...'\n              ) : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {dailyReport && (\n        <div className=\"space-y-6\">\n          {/* Report Header */}\n          <Card className=\"border-2 border-primary\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"text-2xl flex items-center gap-2\">\n                    <FileText className=\"h-6 w-6\" />\n                    Daily Sales Report\n                  </CardTitle>\n                  <CardDescription className=\"mt-2 text-base\">\n                    {dailyReport.stationName}  {new Date(dailyReport.date).toLocaleDateString('en-US', {\n                      weekday: 'long',\n                      year: 'numeric',\n                      month: 'long',\n                      day: 'numeric'\n                    })}\n                  </CardDescription>\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button variant=\"outline\" onClick={exportToPDF}>\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    PDF\n                  </Button>\n                  <Button variant=\"outline\" onClick={exportToExcel}>\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    Excel\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n          </Card>\n\n          {/* Key Metrics Summary */}\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <DollarSign className=\"h-4 w-4 text-green-600\" />\n                  Total Sales\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-green-600\">\n                  Rs. {dailyReport.totalSales.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {dailyReport.transactionCount} transactions\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Clock className=\"h-4 w-4 text-blue-600\" />\n                  Shifts Closed\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-blue-600\">\n                  {dailyReport.shiftCount}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Active shifts\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <TrendingUp className=\"h-4 w-4 text-purple-600\" />\n                  Avg Transaction\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-purple-600\">\n                  Rs. {Math.round(dailyReport.averageTransaction).toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Per transaction\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Wallet className=\"h-4 w-4 text-orange-600\" />\n                  Net Profit\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className={`text-3xl font-bold ${dailyReport.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                  Rs. {dailyReport.netProfit.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  After expenses\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Fuel Sales Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Fuel className=\"h-5 w-5\" />\n                Fuel Sales Breakdown\n              </CardTitle>\n              <CardDescription>Sales by fuel type</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n                <div className=\"p-4 bg-blue-500/10 rounded-lg border border-blue-500/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Petrol 92</div>\n                  <div className=\"text-xl font-bold text-blue-600\">\n                    Rs. {dailyReport.petrolSales.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {((dailyReport.petrolSales / dailyReport.totalSales) * 100).toFixed(1)}%\n                  </div>\n                </div>\n                <div className=\"p-4 bg-green-500/10 rounded-lg border border-green-500/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Diesel</div>\n                  <div className=\"text-xl font-bold text-green-600\">\n                    Rs. {dailyReport.dieselSales.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {((dailyReport.dieselSales / dailyReport.totalSales) * 100).toFixed(1)}%\n                  </div>\n                </div>\n                <div className=\"p-4 bg-emerald-500/10 rounded-lg border border-emerald-500/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Super Diesel</div>\n                  <div className=\"text-xl font-bold text-emerald-600\">\n                    Rs. {dailyReport.superDieselSales.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {((dailyReport.superDieselSales / dailyReport.totalSales) * 100).toFixed(1)}%\n                  </div>\n                </div>\n                <div className=\"p-4 bg-purple-500/10 rounded-lg border border-purple-500/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Oil & Can</div>\n                  <div className=\"text-xl font-bold text-purple-600\">\n                    Rs. {(dailyReport.oilSales + dailyReport.canSales).toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {(((dailyReport.oilSales + dailyReport.canSales) / dailyReport.totalSales) * 100).toFixed(1)}%\n                  </div>\n                </div>\n                <div className=\"p-4 bg-primary/10 rounded-lg border border-primary/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Total Fuel</div>\n                  <div className=\"text-xl font-bold text-primary\">\n                    Rs. {dailyReport.totalFuelSales.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {((dailyReport.totalFuelSales / dailyReport.totalSales) * 100).toFixed(1)}%\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Tender Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <PieChart className=\"h-5 w-5\" />\n                Tender Breakdown\n              </CardTitle>\n              <CardDescription>Payment methods and amounts</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                <div className=\"p-4 bg-green-500/10 rounded-lg border border-green-500/20\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Banknote className=\"h-4 w-4 text-green-600\" />\n                    <span className=\"text-sm font-medium\">Cash</span>\n                  </div>\n                  <div className=\"text-2xl font-bold text-green-600\">\n                    Rs. {dailyReport.cashAmount.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {dailyReport.cashPercentage.toFixed(1)}% of total\n                  </div>\n                </div>\n                <div className=\"p-4 bg-blue-500/10 rounded-lg border border-blue-500/20\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <CreditCard className=\"h-4 w-4 text-blue-600\" />\n                    <span className=\"text-sm font-medium\">Card (POS)</span>\n                  </div>\n                  <div className=\"text-2xl font-bold text-blue-600\">\n                    Rs. {dailyReport.cardAmount.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {dailyReport.cardPercentage.toFixed(1)}% of total\n                  </div>\n                </div>\n                <div className=\"p-4 bg-orange-500/10 rounded-lg border border-orange-500/20\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Users className=\"h-4 w-4 text-orange-600\" />\n                    <span className=\"text-sm font-medium\">Credit</span>\n                  </div>\n                  <div className=\"text-2xl font-bold text-orange-600\">\n                    Rs. {dailyReport.creditAmount.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {dailyReport.creditPercentage.toFixed(1)}% of total\n                  </div>\n                </div>\n                <div className=\"p-4 bg-purple-500/10 rounded-lg border border-purple-500/20\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Receipt className=\"h-4 w-4 text-purple-600\" />\n                    <span className=\"text-sm font-medium\">Cheque</span>\n                  </div>\n                  <div className=\"text-2xl font-bold text-purple-600\">\n                    Rs. {dailyReport.chequeAmount.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {dailyReport.chequePercentage.toFixed(1)}% of total\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* POS Terminal Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <CreditCard className=\"h-5 w-5\" />\n                POS Terminal Breakdown\n              </CardTitle>\n              <CardDescription>Detailed card payment breakdown by terminal and card type</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={dailyReport.posTerminals}\n                columns={posTerminalColumns}\n                searchable={true}\n                searchPlaceholder=\"Search terminals...\"\n                pagination={false}\n              />\n\n              {/* POS Summary */}\n              <div className=\"mt-4 pt-4 border-t\">\n                <div className=\"grid grid-cols-2 md:grid-cols-6 gap-4\">\n                  <div className=\"text-center p-3 bg-blue-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Visa</div>\n                    <div className=\"font-bold text-blue-600\">\n                      Rs. {dailyReport.posTerminals.reduce((sum, t) => sum + t.visaAmount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-red-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Mastercard</div>\n                    <div className=\"font-bold text-red-600\">\n                      Rs. {dailyReport.posTerminals.reduce((sum, t) => sum + t.mastercardAmount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-green-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Amex</div>\n                    <div className=\"font-bold text-green-600\">\n                      Rs. {dailyReport.posTerminals.reduce((sum, t) => sum + t.amexAmount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-purple-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total QR</div>\n                    <div className=\"font-bold text-purple-600\">\n                      Rs. {dailyReport.posTerminals.reduce((sum, t) => sum + t.qrAmount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-orange-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Dialog Touch</div>\n                    <div className=\"font-bold text-orange-600\">\n                      Rs. {dailyReport.posTerminals.reduce((sum, t) => sum + t.dialogTouchAmount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-primary/10 rounded-lg border-2 border-primary\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total POS</div>\n                    <div className=\"font-bold text-primary text-lg\">\n                      Rs. {dailyReport.totalPOSAmount.toLocaleString()}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Credit Customer Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Users className=\"h-5 w-5\" />\n                Credit Customer Breakdown\n              </CardTitle>\n              <CardDescription>Sales and payment details for credit customers</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={dailyReport.creditCustomers}\n                columns={creditCustomerColumns}\n                searchable={true}\n                searchPlaceholder=\"Search customers...\"\n                pagination={false}\n              />\n\n              {/* Credit Summary */}\n              <div className=\"mt-4 pt-4 border-t\">\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div className=\"p-3 bg-orange-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Credit Sales</div>\n                    <div className=\"font-bold text-orange-600 text-lg\">\n                      Rs. {dailyReport.totalCreditSales.toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-blue-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Payments Received</div>\n                    <div className=\"font-bold text-blue-600 text-lg\">\n                      Rs. {dailyReport.creditCustomers.reduce((sum, c) => sum + c.paymentReceived, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-purple-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Active Customers</div>\n                    <div className=\"font-bold text-purple-600 text-lg\">\n                      {dailyReport.creditCustomers.length}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-red-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Outstanding</div>\n                    <div className=\"font-bold text-red-600 text-lg\">\n                      Rs. {dailyReport.creditCustomers.reduce((sum, c) => sum + c.currentBalance, 0).toLocaleString()}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Cheque Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Receipt className=\"h-5 w-5\" />\n                Cheque Breakdown\n              </CardTitle>\n              <CardDescription>All cheques received during the day</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={dailyReport.cheques}\n                columns={chequeColumns}\n                searchable={true}\n                searchPlaceholder=\"Search cheques...\"\n                pagination={false}\n              />\n\n              {/* Cheque Summary */}\n              <div className=\"mt-4 pt-4 border-t\">\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div className=\"p-3 bg-purple-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Total Cheques</div>\n                    <div className=\"font-bold text-purple-600 text-lg\">\n                      Rs. {dailyReport.totalChequeAmount.toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-green-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Cleared</div>\n                    <div className=\"font-bold text-green-600 text-lg\">\n                      Rs. {dailyReport.cheques.filter(c => c.status === 'CLEARED').reduce((sum, c) => sum + c.amount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-yellow-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Pending</div>\n                    <div className=\"font-bold text-yellow-600 text-lg\">\n                      Rs. {dailyReport.cheques.filter(c => c.status === 'PENDING').reduce((sum, c) => sum + c.amount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-red-500/10 rounded-lg\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Bounced</div>\n                    <div className=\"font-bold text-red-600 text-lg\">\n                      Rs. {dailyReport.cheques.filter(c => c.status === 'BOUNCED').reduce((sum, c) => sum + c.amount, 0).toLocaleString()}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Financial Summary */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <Card className=\"border-red-500/20 bg-red-500/5\">\n              <CardHeader>\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <TrendingDown className=\"h-4 w-4 text-red-600\" />\n                  Expenses\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-600\">\n                  Rs. {dailyReport.totalExpenses.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {((dailyReport.totalExpenses / dailyReport.totalSales) * 100).toFixed(1)}% of sales\n                </div>\n              </CardContent>\n            </Card>\n            <Card className=\"border-blue-500/20 bg-blue-500/5\">\n              <CardHeader>\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <Building2 className=\"h-4 w-4 text-blue-600\" />\n                  Bank Deposits\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-blue-600\">\n                  Rs. {dailyReport.totalDeposits.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {((dailyReport.totalDeposits / dailyReport.totalSales) * 100).toFixed(1)}% of sales\n                </div>\n              </CardContent>\n            </Card>\n            <Card className=\"border-orange-500/20 bg-orange-500/5\">\n              <CardHeader>\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <Banknote className=\"h-4 w-4 text-orange-600\" />\n                  Loans Given\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-orange-600\">\n                  Rs. {dailyReport.totalLoans.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  External & pumper loans\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Variance Analysis */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5\" />\n                Variance Analysis\n              </CardTitle>\n              <CardDescription>Difference between calculated and declared amounts</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"text-center p-4 bg-muted rounded-lg\">\n                  <div className=\"text-sm text-muted-foreground mb-2\">Total Variance</div>\n                  <div className={`text-3xl font-bold ${getVarianceColor(dailyReport.variancePercentage)}`}>\n                    {dailyReport.totalVariance >= 0 ? '+' : ''}Rs. {dailyReport.totalVariance.toLocaleString()}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-2\">\n                    {dailyReport.variancePercentage >= 0 ? '+' : ''}{dailyReport.variancePercentage.toFixed(2)}% of total sales\n                  </div>\n                </div>\n                <div className=\"text-center p-4 bg-muted rounded-lg\">\n                  <div className=\"text-sm text-muted-foreground mb-2\">Variance Status</div>\n                  <div className=\"mt-2\">\n                    {Math.abs(dailyReport.variancePercentage) <= 0.5 ? (\n                      <Badge className=\"bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300 text-base py-2 px-4\">\n                        <CheckCircle className=\"h-4 w-4 mr-1\" />\n                        Within Tolerance\n                      </Badge>\n                    ) : Math.abs(dailyReport.variancePercentage) <= 1.0 ? (\n                      <Badge className=\"bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300 text-base py-2 px-4\">\n                        <AlertTriangle className=\"h-4 w-4 mr-1\" />\n                        Needs Review\n                      </Badge>\n                    ) : (\n                      <Badge className=\"bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300 text-base py-2 px-4\">\n                        <AlertCircle className=\"h-4 w-4 mr-1\" />\n                        Requires Action\n                      </Badge>\n                    )}\n                  </div>\n                </div>\n                <div className=\"text-center p-4 bg-muted rounded-lg\">\n                  <div className=\"text-sm text-muted-foreground mb-2\">Impact</div>\n                  <div className=\"flex items-center justify-center gap-2 mt-2\">\n                    {dailyReport.totalVariance >= 0 ? (\n                      <>\n                        <ArrowUp className=\"h-5 w-5 text-green-600\" />\n                        <span className=\"text-green-600 font-semibold\">Surplus</span>\n                      </>\n                    ) : (\n                      <>\n                        <ArrowDown className=\"h-5 w-5 text-red-600\" />\n                        <span className=\"text-red-600 font-semibold\">Shortage</span>\n                      </>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Missing Slip Exceptions */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" />\n                Missing Slip Exceptions\n              </CardTitle>\n              <CardDescription>POS slips reported as missing</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {dailyReport.missingSlips.length > 0 ? (\n                <>\n                  <DataTable\n                    data={dailyReport.missingSlips}\n                    columns={missingSlipColumns}\n                    searchPlaceholder=\"Search missing slips...\"\n                    pagination={false}\n                    emptyMessage=\"No missing slips reported.\"\n                  />\n                  <div className=\"mt-4 pt-4 border-t\">\n                    <div className=\"flex items-center justify-between p-3 bg-yellow-500/10 rounded-lg border border-yellow-500/20\">\n                      <span className=\"font-medium\">Total Missing Slip Amount:</span>\n                      <span className=\"font-bold text-yellow-600 text-lg\">\n                        Rs. {dailyReport.missingSlips.reduce((sum, s) => sum + s.amount, 0).toLocaleString()}\n                      </span>\n                    </div>\n                  </div>\n                </>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <CheckCircle className=\"h-12 w-12 mx-auto mb-4 text-green-600\" />\n                  <p>No missing slips reported for this date.</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* High Variance Alert */}\n          {Math.abs(dailyReport.variancePercentage) > 1.0 && (\n            <Alert variant=\"destructive\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>High Variance Detected</AlertTitle>\n              <AlertDescription>\n                Daily variance of {dailyReport.variancePercentage.toFixed(2)}% exceeds acceptable limits (1.0%).\n                Please review transactions and investigate discrepancies immediately.\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FormCard' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'quickStats' is assigned a value but never used.","line":172,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":172,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getRoleStyle' is assigned a value but never used.","line":199,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":199,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  FileText,\n  Calendar,\n  BarChart3,\n  TrendingUp,\n  Users,\n  Fuel,\n  Building2,\n  Clock,\n  DollarSign,\n  AlertTriangle,\n  GitCompare\n} from 'lucide-react'\n\ninterface ReportCard {\n  title: string\n  description: string\n  icon: React.ReactNode\n  href: string\n  features: string[]\n  color: string\n  minRole?: 'OWNER' | 'DEVELOPER'\n}\n\nexport default function ReportsPage() {\n  const router = useRouter()\n  // specific state for role not needed if we derive from localStorage directly for initial render \n  // but to avoid hydration mismatch we use state or useEffect. \n  // simpler here:\n  const [userRole, setUserRole] = useState<string>('')\n\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      setUserRole(localStorage.getItem('userRole') || '')\n    }\n  }, [])\n\n  const isDeveloper = userRole === 'DEVELOPER'\n  const isOwner = userRole === 'OWNER' || isDeveloper\n\n  const allReports: ReportCard[] = [\n    {\n      title: 'Daily Sales Report (Rs)',\n      description: 'Daily fuel sales revenue (Rupees) for each fuel type',\n      icon: <BarChart3 className=\"h-8 w-8\" />,\n      href: '/reports/daily-sales',\n      features: [\n        'Sales revenue by fuel type',\n        'Daily revenue totals',\n        'Fuel type comparison',\n        'Revenue trend analysis',\n        'Export to PDF/Excel'\n      ],\n      color: 'text-purple-600 dark:text-purple-400'\n    },\n    {\n      title: 'Daily Sales Report (Liters)',\n      description: 'Daily fuel sales volume (Liters) for each fuel type',\n      icon: <Fuel className=\"h-8 w-8\" />,\n      href: '/reports/daily-sales-liters',\n      features: [\n        'Sales volume in liters by fuel type',\n        'Total volume sold per day',\n        'Fuel type comparison',\n        'Volume trend analysis',\n        'Export to PDF/Excel'\n      ],\n      color: 'text-blue-600 dark:text-blue-400'\n    },\n    {\n      title: 'Daily Profit Report',\n      description: 'Daily profit analysis with revenue and expense breakdown',\n      icon: <TrendingUp className=\"h-8 w-8\" />,\n      href: '/reports/profit',\n      features: [\n        'Daily profit calculations',\n        'Revenue breakdown by source',\n        'Expense categorization',\n        'Profit margin analysis',\n        'Monthly trends'\n      ],\n      color: 'text-green-600 dark:text-green-400'\n    },\n    {\n      title: 'POS Sales Report',\n      description: 'POS machine sales with bank reconciliation and transaction summary',\n      icon: <DollarSign className=\"h-8 w-8\" />,\n      href: '/reports/pos-sales',\n      features: [\n        'POS terminal sales breakdown',\n        'Bank-wise transaction summary',\n        'Card payment reconciliation',\n        'Missing slip tracking',\n        'Daily settlement report'\n      ],\n      color: 'text-purple-600 dark:text-purple-400'\n    },\n    {\n      title: 'Credit Customer Reports',\n      description: 'Credit sales, payments, and outstanding balance analysis',\n      icon: <Users className=\"h-8 w-8\" />,\n      href: '/reports/credit',\n      features: [\n        'Outstanding balances',\n        'Credit sales summary',\n        'Payment collection tracking',\n        'Aging analysis',\n        'Customer-wise breakdown'\n      ],\n      color: 'text-orange-600 dark:text-orange-400'\n    },\n    {\n      title: 'Shift Reports & Variance',\n      description: 'Shift performance with variance analysis and pumper tracking',\n      icon: <Clock className=\"h-8 w-8\" />,\n      href: '/reports/shift',\n      features: [\n        'Per-shift sales analysis',\n        'Variance by pumper',\n        'Tender reconciliation',\n        'Nozzle-wise breakdown',\n        'Print shift summary'\n      ],\n      color: 'text-yellow-600 dark:text-yellow-400'\n    },\n    {\n      title: 'Pumper Details Report',\n      description: 'Comprehensive pumper performance, salary, and loan information',\n      icon: <Users className=\"h-8 w-8\" />,\n      href: '/reports/pumper-details',\n      features: [\n        'Complete pumper profile',\n        'Shift performance & variance',\n        'Salary payments history',\n        'Active loans & deductions',\n        'Fuel type breakdown'\n      ],\n      color: 'text-teal-600 dark:text-teal-400'\n    },\n    {\n      title: 'Station Comparison Report',\n      description: 'Compare performance metrics across all stations',\n      icon: <GitCompare className=\"h-8 w-8\" />,\n      href: '/reports/station-comparison',\n      features: [\n        'Side-by-side station comparison',\n        'Sales & revenue analysis',\n        'Profitability metrics',\n        'Pumper performance comparison',\n        'Best & worst performers',\n        'Monthly trends comparison'\n      ],\n      color: 'text-indigo-600 dark:text-indigo-400',\n      minRole: 'OWNER'\n    }\n  ]\n\n  // Filter reports based on user role\n  const reports = allReports.filter(report => {\n    if (report.minRole === 'DEVELOPER') return isDeveloper\n    if (report.minRole === 'OWNER') return isOwner\n    return true\n  })\n\n  const quickStats = [\n    {\n      title: 'Reports Available',\n      value: '5',\n      description: 'Comprehensive reporting modules',\n      icon: <FileText className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Data Sources',\n      value: '12+',\n      description: 'Integrated data points',\n      icon: <BarChart3 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n    },\n    {\n      title: 'Export Formats',\n      value: '4',\n      description: 'PDF, Excel, Print, Email',\n      icon: <DollarSign className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n    },\n    {\n      title: 'Real-time',\n      value: 'Live',\n      description: 'Up-to-date information',\n      icon: <AlertTriangle className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n    }\n  ]\n\n  const getRoleStyle = (minRole?: string) => {\n    switch (minRole) {\n      case 'DEVELOPER':\n        return 'border-rose-500/20 dark:border-rose-500/30 bg-rose-500/10 dark:bg-rose-500/20'\n      case 'OWNER':\n        return 'border-orange-500/20 dark:border-orange-500/30 bg-orange-500/10 dark:bg-orange-500/20'\n      default:\n        return ''\n    }\n  }\n\n  const getRoleBadge = (minRole?: string) => {\n    switch (minRole) {\n      case 'DEVELOPER':\n        return (\n          <span className=\"text-xs bg-rose-500/20 text-rose-600 dark:text-rose-400 px-2 py-1 rounded-full font-medium border border-rose-500/20\">\n            DEVELOPER ONLY\n          </span>\n        )\n      case 'OWNER':\n        return (\n          <span className=\"text-xs bg-orange-500/20 text-orange-600 dark:text-orange-400 px-2 py-1 rounded-full font-medium border border-orange-500/20\">\n            OWNER ONLY\n          </span>\n        )\n      default:\n        return null\n    }\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Reports & Analytics</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Comprehensive reporting suite for business intelligence and operational insights\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Building2 className=\"h-6 w-6 text-muted-foreground\" />\n          <span className=\"text-sm text-muted-foreground\">Multi-station reporting</span>\n        </div>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"text-2xl font-bold text-foreground\">{reports.length}</div>\n                <div className=\"text-sm font-medium text-foreground\">Reports Available</div>\n                <div className=\"text-xs text-muted-foreground\">Comprehensive reporting modules</div>\n              </div>\n              <div className=\"flex-shrink-0\">\n                <FileText className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"text-2xl font-bold text-foreground\">12+</div>\n                <div className=\"text-sm font-medium text-foreground\">Data Sources</div>\n                <div className=\"text-xs text-muted-foreground\">Integrated data points</div>\n              </div>\n              <div className=\"flex-shrink-0\">\n                <BarChart3 className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"text-2xl font-bold text-foreground\">2</div>\n                <div className=\"text-sm font-medium text-foreground\">Export Formats</div>\n                <div className=\"text-xs text-muted-foreground\">PDF, Excel</div>\n              </div>\n              <div className=\"flex-shrink-0\">\n                <DollarSign className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"text-2xl font-bold text-foreground\">Live</div>\n                <div className=\"text-sm font-medium text-foreground\">Real-time</div>\n                <div className=\"text-xs text-muted-foreground\">Up-to-date information</div>\n              </div>\n              <div className=\"flex-shrink-0\">\n                <AlertTriangle className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Report Cards */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {reports.map((report, index) => (\n          <Card key={index} className=\"hover:shadow-lg transition-shadow cursor-pointer\" onClick={() => router.push(report.href)}>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <div className={report.color}>\n                    {report.icon}\n                  </div>\n                  <div>\n                    <h3 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n                      {report.title}\n                      {getRoleBadge(report.minRole)}\n                    </h3>\n                    <p className=\"text-sm text-muted-foreground font-normal\">{report.description}</p>\n                  </div>\n                </div>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                <div className=\"text-sm font-medium text-foreground mb-2\">Key Features:</div>\n                <ul className=\"space-y-1\">\n                  {report.features.map((feature, featureIndex) => (\n                    <li key={featureIndex} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <div className=\"w-1.5 h-1.5 bg-muted-foreground rounded-full flex-shrink-0\"></div>\n                      {feature}\n                    </li>\n                  ))}\n                </ul>\n                <div className=\"pt-3\">\n                  <Button\n                    className=\"w-full\"\n                    onClick={(e) => {\n                      e.stopPropagation()\n                      router.push(report.href)\n                    }}\n                  >\n                    Open Report\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Quick Access */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Quick Access</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-wrap gap-3\">\n            <Button variant=\"outline\" onClick={() => router.push('/reports/daily')}>\n              <Calendar className=\"mr-2 h-4 w-4\" />\n              Today&apos;s Report\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/reports/shift')}>\n              <Clock className=\"mr-2 h-4 w-4\" />\n              Latest Shift\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/reports/profit')}>\n              <TrendingUp className=\"mr-2 h-4 w-4\" />\n              Monthly Profit\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/reports/daily-sales')}>\n              <BarChart3 className=\"mr-2 h-4 w-4\" />\n              Daily Sales (Rs)\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/reports/daily-sales-liters')}>\n              <Fuel className=\"mr-2 h-4 w-4\" />\n              Daily Sales (Liters)\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/reports/pumper-variance')}>\n              <Users className=\"mr-2 h-4 w-4\" />\n              Pumper Variance\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/reports/pumper-details')}>\n              <Users className=\"mr-2 h-4 w-4\" />\n              Pumper Details\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\pos-sales\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BarChart' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Bar' is defined but never used.","line":34,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":6},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchReport'. Either include it or remove the dependency array.","line":188,"column":6,"nodeType":"ArrayExpression","endLine":188,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, selectedYear, selectedMonth, fetchReport]","fix":{"range":[4832,4878],"text":"[selectedStation, selectedYear, selectedMonth, fetchReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { getCurrentBusinessMonth, formatBusinessMonthRange } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  BarChart,\n  Bar\n} from 'recharts'\nimport {\n  DollarSign,\n  CreditCard,\n  Building,\n  FileText,\n  ArrowLeft,\n  RefreshCw,\n  Download,\n  AlertTriangle,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { exportPOSSalesReportPDF, exportPOSSalesReportExcel } from '@/lib/exportUtils'\n\ninterface POSSalesReport {\n  summary: {\n    totalSales: number\n    totalTransactions: number\n    totalTerminals: number\n    totalBanks: number\n    missingSlipsCount: number\n    reconciledBatches: number\n    unreconciledBatches: number\n  }\n  dailyBreakdown: Array<{\n    date: string\n    totalAmount: number\n    transactionCount: number\n  }>\n  dailyByBank: Array<{\n    bankId: string\n    bankName: string\n    dailySales: Array<{\n      date: string\n      amount: number\n    }>\n  }>\n  dailyByTerminal: Array<{\n    terminalId: string\n    terminalName: string\n    terminalNumber: string\n    bankName: string\n    dailySales: Array<{\n      date: string\n      amount: number\n    }>\n  }>\n  bankBreakdown: Array<{\n    bankName: string\n    totalAmount: number\n    transactionCount: number\n    visa: number\n    master: number\n    amex: number\n    qr: number\n    dialogTouch: number\n  }>\n  terminalBreakdown: Array<{\n    terminalId: string\n    terminalName: string\n    terminalNumber: string\n    bankName: string\n    totalAmount: number\n    transactionCount: number\n    visa: number\n    master: number\n    amex: number\n    qr: number\n    dialogTouch: number\n  }>\n\n  missingSlips: Array<{\n    id: string\n    terminalName: string\n    lastFourDigits: string\n    amount: number\n    timestamp: string\n    reportedBy: string\n  }>\n  dateRange: {\n    start: string\n    end: string\n  }\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nexport default function POSSalesReportPage() {\n  const router = useRouter()\n  const { selectedStation, stations } = useStation()\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [reportData, setReportData] = useState<POSSalesReport | null>(null)\n  const [dailyViewMode, setDailyViewMode] = useState<'bank' | 'pos'>('bank')\n\n  // Month selection - using business month\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedYear, setSelectedYear] = useState(currentBusinessMonth.year.toString())\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n\n  // Generate years\n  const years = Array.from({ length: 3 }, (_, i) => {\n    const year = currentBusinessMonth.year - i\n    return { value: year.toString(), label: year.toString() }\n  })\n\n  const exportToPDF = () => {\n    if (!reportData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const exportData = {\n      summary: reportData.summary,\n      bankBreakdown: reportData.bankBreakdown,\n      terminalBreakdown: reportData.terminalBreakdown\n    }\n\n    exportPOSSalesReportPDF(exportData, stationName, monthLabel)\n  }\n\n  const exportToExcel = () => {\n    if (!reportData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const exportData = {\n      summary: reportData.summary,\n      bankBreakdown: reportData.bankBreakdown,\n      terminalBreakdown: reportData.terminalBreakdown\n    }\n\n    exportPOSSalesReportExcel(exportData, stationName, monthLabel)\n  }\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchReport()\n    }\n  }, [selectedStation, selectedYear, selectedMonth])\n\n  const fetchReport = async () => {\n    if (!selectedStation) {\n      setError('Please select a station')\n      return\n    }\n\n    try {\n      setLoading(true)\n      setError('')\n\n      // Calculate business month date range\n      const year = parseInt(selectedYear)\n      const month = parseInt(selectedMonth)\n      const startDate = new Date(year, month - 1, 7)\n      const endDate = new Date(year, month, 6, 23, 59, 59)\n\n      const res = await fetch(\n        `/api/reports/pos-sales?stationId=${selectedStation}&startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`\n      )\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        console.error('POS Sales API Error:', errorData)\n        throw new Error(errorData.details || errorData.error || 'Failed to fetch POS sales report')\n      }\n\n      const data = await res.json()\n      setReportData(data)\n    } catch (err) {\n      console.error('Error fetching POS sales report:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (loading && !reportData) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">POS/Bank Sales Report</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              ATM and POS machine sales with bank reconciliation\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={fetchReport}>\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" disabled={!reportData}>\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export Report\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-48\">\n              <DropdownMenuItem onClick={exportToPDF} className=\"cursor-pointer\">\n                <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                <span>Export as PDF</span>\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={exportToExcel} className=\"cursor-pointer\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                <span>Export as Excel</span>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filters</CardTitle>\n          <CardDescription>Select year and month to view POS sales data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"year\">Year</Label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger id=\"year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map(year => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"month\">Month</Label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger id=\"month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map(month => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {error && (\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-2 text-red-600\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              <span>{error}</span>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Summary Cards */}\n      {reportData && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <DollarSign className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Total POS Sales</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\n                  Rs. {reportData.summary.totalSales.toLocaleString()}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <CreditCard className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Card Transactions</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                  {reportData.summary.totalTransactions.toLocaleString()}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Building className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Banks</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                  {reportData.summary.totalBanks}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <FileText className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Missing Slips</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\n                  {reportData.summary.missingSlipsCount}\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Daily Trend Chart - Multiple Lines (One per Bank) */}\n          <FormCard\n            title=\"Daily POS Sales Trend by Bank\"\n            description={`Sales trends grouped by bank - Business Month: ${formatBusinessMonthRange({ startDate: new Date(reportData.dateRange.start), endDate: new Date(reportData.dateRange.end), month: parseInt(selectedMonth), year: parseInt(selectedYear), label: `${months.find(m => m.value === selectedMonth)?.label} ${selectedYear}` })}`}\n          >\n            <div className=\"w-full h-96 mt-4\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <LineChart data={(() => {\n                  // Merge all bank data into single data points per date\n                  interface ChartDataPoint {\n                    date: string\n                    totalAmount: number\n                    [key: string]: string | number\n                  }\n                  return reportData.dailyBreakdown.map(day => {\n                    const dataPoint: ChartDataPoint = { date: day.date, totalAmount: day.totalAmount }\n                    reportData.dailyByBank.forEach(bank => {\n                      const bankDay = bank.dailySales.find(s => s.date === day.date)\n                      dataPoint[bank.bankName] = bankDay?.amount || 0\n                    })\n                    return dataPoint\n                  })\n                })()}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis\n                    dataKey=\"date\"\n                    tickFormatter={(value) => {\n                      const d = new Date(value)\n                      return `${d.getDate()}/${d.getMonth() + 1}`\n                    }}\n                    tick={{ fontSize: 10 }}\n                  />\n                  <YAxis tickFormatter={(value) => `Rs. ${(value / 1000).toFixed(0)}k`} />\n                  <Tooltip\n                    formatter={(value: number) => `Rs. ${value.toLocaleString()}`}\n                    labelFormatter={(date) => new Date(date).toLocaleDateString()}\n                  />\n                  <Legend wrapperStyle={{ fontSize: '12px' }} />\n                  {/* Create a line for each POS terminal */}\n                  {reportData.dailyByBank.map((bank, index) => {\n                    // Generate different colors for each bank\n                    const colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899']\n                    const color = colors[index % colors.length]\n\n                    return (\n                      <Line\n                        key={bank.bankId}\n                        type=\"monotone\"\n                        dataKey={bank.bankName}\n                        stroke={color}\n                        strokeWidth={3}\n                        name={bank.bankName}\n                        dot={{ r: 4 }}\n                      />\n                    )\n                  })}\n                  {/* Total line removed as per user request */}\n                </LineChart>\n              </ResponsiveContainer>\n            </div>\n          </FormCard>\n\n          {/* Daily Sales View with Dropdown */}\n          <FormCard\n            title=\"Daily Sales Breakdown\"\n            description=\"View daily sales by bank or POS machine\"\n          >\n            <div className=\"mb-4\">\n              <Label htmlFor=\"daily-view-mode\" className=\"mb-2 block font-semibold\">\n                Group By:\n              </Label>\n              <Select value={dailyViewMode} onValueChange={(value) => setDailyViewMode(value as 'bank' | 'pos')}>\n                <SelectTrigger id=\"daily-view-mode\" className=\"w-64\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"bank\">Bank Wise Sales (Daily)</SelectItem>\n                  <SelectItem value=\"pos\">POS Machine Wise Sales (Daily)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full border-collapse\">\n                <thead>\n                  <tr className=\"border-b-2 bg-purple-100 dark:bg-purple-900/30\">\n                    <th className=\"text-left p-3 font-bold sticky left-0 bg-purple-100 dark:bg-purple-900/30\">Date</th>\n                    {dailyViewMode === 'bank' ? (\n                      reportData.dailyByBank.map(bank => (\n                        <th key={bank.bankId} className=\"text-right p-3 font-bold min-w-[150px]\">\n                          {bank.bankName}\n                        </th>\n                      ))\n                    ) : (\n                      reportData.dailyByTerminal.map(terminal => (\n                        <th key={terminal.terminalId} className=\"text-right p-3 font-bold min-w-[120px]\">\n                          {terminal.terminalNumber}\n                        </th>\n                      ))\n                    )}\n                    <th className=\"text-right p-3 font-bold text-purple-600 bg-purple-50 dark:bg-purple-900/40 min-w-[150px]\">\n                      Daily Total\n                    </th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {reportData.dailyBreakdown.map((day, index) => (\n                    <tr key={day.date} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                      <td className=\"p-3 font-semibold sticky left-0 bg-inherit\">{day.date}</td>\n                      {dailyViewMode === 'bank' ? (\n                        reportData.dailyByBank.map(bank => {\n                          const bankDay = bank.dailySales.find(s => s.date === day.date)\n                          return (\n                            <td key={bank.bankId} className=\"text-right p-3 text-sm\">\n                              Rs. {(bankDay?.amount || 0).toLocaleString()}\n                            </td>\n                          )\n                        })\n                      ) : (\n                        reportData.dailyByTerminal.map(terminal => {\n                          const terminalDay = terminal.dailySales.find(s => s.date === day.date)\n                          return (\n                            <td key={terminal.terminalId} className=\"text-right p-3 text-sm\">\n                              Rs. {(terminalDay?.amount || 0).toLocaleString()}\n                            </td>\n                          )\n                        })\n                      )}\n                      <td className=\"text-right p-3 font-bold text-purple-600 bg-purple-50 dark:bg-purple-900/20\">\n                        Rs. {day.totalAmount.toLocaleString()}\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </FormCard>\n\n          {/* Individual POS Machines - Summary Table */}\n          <FormCard title=\"POS Machine Summary\" description=\"Total sales by each POS terminal\">\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full border-collapse\">\n                <thead>\n                  <tr className=\"border-b-2 bg-purple-100 dark:bg-purple-900/30\">\n                    <th className=\"text-left p-3 font-bold\">POS Terminal</th>\n                    <th className=\"text-left p-3 font-bold\">Terminal #</th>\n                    <th className=\"text-left p-3 font-bold\">Bank</th>\n                    <th className=\"text-right p-3 font-bold\">Transactions</th>\n                    <th className=\"text-right p-3 font-bold\">Visa</th>\n                    <th className=\"text-right p-3 font-bold\">Master</th>\n                    <th className=\"text-right p-3 font-bold\">Amex</th>\n                    <th className=\"text-right p-3 font-bold\">QR</th>\n                    <th className=\"text-right p-3 font-bold\">Dialog</th>\n                    <th className=\"text-right p-3 font-bold text-purple-600\">Total Sales</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {reportData.terminalBreakdown.length === 0 ? (\n                    <tr>\n                      <td colSpan={10} className=\"p-8 text-center text-muted-foreground\">\n                        No POS sales data available for this period\n                      </td>\n                    </tr>\n                  ) : (\n                    reportData.terminalBreakdown.map((terminal, index) => (\n                      <tr key={terminal.terminalId} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                        <td className=\"p-3 font-bold text-purple-600\">{terminal.terminalName}</td>\n                        <td className=\"p-3 text-sm bg-gray-100 dark:bg-gray-800\">{terminal.terminalNumber}</td>\n                        <td className=\"p-3 text-sm\">{terminal.bankName}</td>\n                        <td className=\"text-right p-3 font-semibold\">{terminal.transactionCount}</td>\n                        <td className=\"text-right p-3 text-sm text-blue-600\">Rs. {terminal.visa.toLocaleString()}</td>\n                        <td className=\"text-right p-3 text-sm text-purple-600\">Rs. {terminal.master.toLocaleString()}</td>\n                        <td className=\"text-right p-3 text-sm text-green-600\">Rs. {terminal.amex.toLocaleString()}</td>\n                        <td className=\"text-right p-3 text-sm text-orange-600\">Rs. {terminal.qr.toLocaleString()}</td>\n                        <td className=\"text-right p-3 text-sm text-red-600\">Rs. {terminal.dialogTouch.toLocaleString()}</td>\n                        <td className=\"text-right p-3 font-bold text-lg text-purple-600 bg-purple-50 dark:bg-purple-900/20\">\n                          Rs. {terminal.totalAmount.toLocaleString()}\n                        </td>\n                      </tr>\n                    ))\n                  )}\n                </tbody>\n              </table>\n            </div>\n          </FormCard>\n\n          {/* Bank Totals */}\n          <FormCard title=\"Total by Bank\" description=\"Aggregated sales totals by bank\">\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full border-collapse\">\n                <thead>\n                  <tr className=\"border-b-2 bg-muted/30\">\n                    <th className=\"text-left p-3 font-semibold\">Bank</th>\n                    <th className=\"text-right p-3 font-semibold\">Transactions</th>\n                    <th className=\"text-right p-3 font-semibold\">Visa</th>\n                    <th className=\"text-right p-3 font-semibold\">Master</th>\n                    <th className=\"text-right p-3 font-semibold\">Amex</th>\n                    <th className=\"text-right p-3 font-semibold\">QR</th>\n                    <th className=\"text-right p-3 font-semibold\">Dialog Touch</th>\n                    <th className=\"text-right p-3 font-semibold text-purple-600\">Total</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {reportData.bankBreakdown.map((bank, index) => (\n                    <tr key={index} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                      <td className=\"p-3 font-medium\">{bank.bankName}</td>\n                      <td className=\"text-right p-3\">{bank.transactionCount}</td>\n                      <td className=\"text-right p-3 text-sm\">Rs. {bank.visa.toLocaleString()}</td>\n                      <td className=\"text-right p-3 text-sm\">Rs. {bank.master.toLocaleString()}</td>\n                      <td className=\"text-right p-3 text-sm\">Rs. {bank.amex.toLocaleString()}</td>\n                      <td className=\"text-right p-3 text-sm\">Rs. {bank.qr.toLocaleString()}</td>\n                      <td className=\"text-right p-3 text-sm\">Rs. {bank.dialogTouch.toLocaleString()}</td>\n                      <td className=\"text-right p-3 font-semibold text-purple-600\">\n                        Rs. {bank.totalAmount.toLocaleString()}\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </FormCard>\n\n\n          {/* Missing Slips */}\n          {reportData.missingSlips.length > 0 && (\n            <FormCard title=\"Missing Slips\" description=\"Unresolved missing POS slips\" className=\"border-orange-500/20\">\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse\">\n                  <thead>\n                    <tr className=\"border-b-2 bg-muted/30\">\n                      <th className=\"text-left p-3 font-semibold\">Terminal</th>\n                      <th className=\"text-left p-3 font-semibold\">Last 4 Digits</th>\n                      <th className=\"text-right p-3 font-semibold\">Amount</th>\n                      <th className=\"text-left p-3 font-semibold\">Timestamp</th>\n                      <th className=\"text-left p-3 font-semibold\">Reported By</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {reportData.missingSlips.map((slip) => (\n                      <tr key={slip.id} className=\"border-b\">\n                        <td className=\"p-3\">{slip.terminalName}</td>\n                        <td className=\"p-3\">****{slip.lastFourDigits}</td>\n                        <td className=\"text-right p-3\">Rs. {slip.amount.toLocaleString()}</td>\n                        <td className=\"p-3\">{new Date(slip.timestamp).toLocaleString()}</td>\n                        <td className=\"p-3\">{slip.reportedBy}</td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </FormCard>\n          )}\n        </>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\profit\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":24,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used.","line":41,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":41,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":160,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":160,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":255,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":255,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { getCurrentBusinessMonth, getBusinessMonth, formatBusinessMonthRange } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer\n} from 'recharts'\nimport {\n  Building2,\n  Calendar,\n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  AlertCircle,\n  Calculator,\n  Download,\n  FileText,\n  ArrowLeft,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { exportProfitReportPDF } from '@/lib/exportUtils'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface ProfitData {\n  day: number\n  date: string\n  revenue: number\n  expenses: number\n  profit: number\n  margin: number\n}\n\ninterface ProfitBreakdown {\n  category: string\n  amount: number\n  percentage: number\n  trend: 'UP' | 'DOWN' | 'STABLE'\n  previousMonth: number\n}\n\ninterface MonthlyProfitReport {\n  month: string\n  year: number\n  stationId: string\n  stationName: string\n\n  // Summary\n  totalRevenue: number\n  totalExpenses: number\n  totalProfit: number\n  averageMargin: number\n\n  // Daily data for chart\n  dailyData: ProfitData[]\n\n  // Breakdown\n  revenueBreakdown: ProfitBreakdown[]\n  expenseBreakdown: ProfitBreakdown[]\n\n  // Comparisons\n  previousMonthProfit: number\n  profitGrowth: number\n  bestDay: ProfitData\n  worstDay: ProfitData\n}\n\ninterface BreakdownItem {\n  category: string\n  amount: number\n  percentage: number\n}\n\ninterface ProfitReportResponse {\n  dailyData: ProfitData[]\n  breakdown: {\n    revenue: BreakdownItem[]\n    expenses: BreakdownItem[]\n  }\n  summary: {\n    totalRevenue: number\n    totalExpenses: number\n    totalProfit: number\n    averageMargin: number\n    bestDay?: ProfitData\n    worstDay?: ProfitData\n  }\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nconst currentYear = new Date().getFullYear()\nconst years = Array.from({ length: 5 }, (_, i) => currentYear - i)\n\nexport default function ProfitReportsPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [profitReport, setProfitReport] = useState<MonthlyProfitReport | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n  const [selectedYear, setSelectedYear] = useState(String(currentBusinessMonth.year))\n\n  // Load initial data\n  useEffect(() => {\n    const loadStations = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (_err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadStations()\n  }, [])\n\n  const generateReport = async () => {\n    if (!selectedStation || !selectedMonth || !selectedYear) {\n      setError('Please select month and year')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Get business month date range (7th to 6th)\n      const businessMonth = getBusinessMonth(parseInt(selectedMonth), parseInt(selectedYear))\n      const url = `/api/reports/profit?stationId=${selectedStation}&month=${selectedMonth}&year=${selectedYear}&startDate=${businessMonth.startDate.toISOString()}&endDate=${businessMonth.endDate.toISOString()}`\n\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n        cache: 'no-store'\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error((errorData as { error?: string }).error || `Failed to fetch profit report: ${response.status}`)\n      }\n\n      const reportData = await response.json() as ProfitReportResponse\n\n      const station = stations.find(s => s.id === selectedStation)\n      const monthName = businessMonth.label\n\n      // Transform API data to match frontend interface\n      const dailyData: ProfitData[] = reportData.dailyData || []\n\n      // Transform breakdown data\n      const revenueBreakdown: ProfitBreakdown[] = (reportData.breakdown?.revenue || []).map((item: BreakdownItem) => ({\n        category: item.category,\n        amount: item.amount,\n        percentage: item.percentage,\n        trend: 'STABLE' as const, // Would need previous month data to calculate trend\n        previousMonth: 0 // Would need to fetch previous month for comparison\n      }))\n\n      const expenseBreakdown: ProfitBreakdown[] = (reportData.breakdown?.expenses || []).map((item: BreakdownItem) => ({\n        category: item.category,\n        amount: item.amount,\n        percentage: item.percentage,\n        trend: 'STABLE' as const,\n        previousMonth: 0\n      }))\n\n      // Calculate totals from API data\n      const totalRevenue = reportData.summary?.totalRevenue || 0\n      const totalExpenses = reportData.summary?.totalExpenses || 0\n      const totalProfit = reportData.summary?.totalProfit || 0\n      const averageMargin = reportData.summary?.averageMargin || 0\n\n      // Use best and worst days from API (which excludes today)\n      const bestDay = reportData.summary.bestDay || dailyData[0] || { day: 0, date: '', profit: 0, revenue: 0, expenses: 0, margin: 0 }\n      const worstDay = reportData.summary.worstDay || dailyData[0] || { day: 0, date: '', profit: 0, revenue: 0, expenses: 0, margin: 0 }\n\n      console.log('[Profit Report Frontend] Using bestDay:', bestDay.date, 'Profit:', bestDay.profit)\n      console.log('[Profit Report Frontend] Using worstDay:', worstDay.date, 'Profit:', worstDay.profit)\n\n      // Mock previous month data\n      const previousMonthProfit = totalProfit * (0.9 + Math.random() * 0.2)\n      const profitGrowth = ((totalProfit - previousMonthProfit) / previousMonthProfit) * 100\n\n      const report: MonthlyProfitReport = {\n        month: monthName,\n        year: parseInt(selectedYear),\n        stationId: selectedStation,\n        stationName: station?.name || 'Unknown Station',\n        totalRevenue,\n        totalExpenses,\n        totalProfit,\n        averageMargin,\n        dailyData,\n        revenueBreakdown,\n        expenseBreakdown,\n        previousMonthProfit,\n        profitGrowth,\n        bestDay,\n        worstDay\n      }\n\n      setProfitReport(report)\n\n    } catch (_err) {\n      setError('Failed to generate profit report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const exportToPDF = () => {\n    if (!profitReport || !selectedStation) {\n      alert('Please select a station and generate a report first')\n      return\n    }\n\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'Unknown Station'\n    const monthStr = `${selectedYear}-${selectedMonth}`\n\n    exportProfitReportPDF(profitReport, stationName, monthStr)\n  }\n\n  const exportToExcel = () => {\n    // Excel export for profit reports - can be implemented similarly\n    alert('Excel export for profit reports - to be implemented')\n  }\n\n  const getTrendIcon = (trend: string) => {\n    switch (trend) {\n      case 'UP': return <TrendingUp className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n      case 'DOWN': return <TrendingDown className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n      default: return <div className=\"h-4 w-4 bg-muted-foreground rounded-full\" />\n    }\n  }\n\n  const getTrendColor = (trend: string) => {\n    switch (trend) {\n      case 'UP': return 'text-green-600 dark:text-green-400'\n      case 'DOWN': return 'text-red-600 dark:text-red-400'\n      default: return 'text-muted-foreground'\n    }\n  }\n\n  const revenueColumns: Column<ProfitBreakdown>[] = [\n    {\n      key: 'category' as keyof ProfitBreakdown,\n      title: 'Revenue Source',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'amount' as keyof ProfitBreakdown,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-green-600 dark:text-green-400\">\n          Rs. {Math.floor(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'percentage' as keyof ProfitBreakdown,\n      title: 'Percentage',\n      render: (value: unknown) => (\n        <span className=\"\">{value as number}%</span>\n      )\n    },\n    {\n      key: 'trend' as keyof ProfitBreakdown,\n      title: 'Trend',\n      render: (value: unknown, row: ProfitBreakdown) => (\n        <div className=\"flex items-center gap-2\">\n          {getTrendIcon(value as string)}\n          <span className={`text-sm ${getTrendColor(value as string)}`}>\n            {((row.amount - row.previousMonth) / row.previousMonth * 100).toFixed(1)}%\n          </span>\n        </div>\n      )\n    }\n  ]\n\n  const expenseColumns: Column<ProfitBreakdown>[] = [\n    {\n      key: 'category' as keyof ProfitBreakdown,\n      title: 'Expense Category',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'amount' as keyof ProfitBreakdown,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-red-600 dark:text-red-400\">\n          Rs. {Math.floor(value as number).toLocaleString()}\n        </span>\n      )\n    },\n    {\n      key: 'percentage' as keyof ProfitBreakdown,\n      title: 'Percentage',\n      render: (value: unknown) => (\n        <span className=\"\">{value as number}%</span>\n      )\n    },\n    {\n      key: 'trend' as keyof ProfitBreakdown,\n      title: 'Trend',\n      render: (value: unknown, row: ProfitBreakdown) => (\n        <div className=\"flex items-center gap-2\">\n          {getTrendIcon(value as string)}\n          <span className={`text-sm ${getTrendColor(value as string)}`}>\n            {((row.amount - row.previousMonth) / row.previousMonth * 100).toFixed(1)}%\n          </span>\n        </div>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">Profit Reports</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Generate Monthly Profit Report\" description=\"Business month runs from 7th to 6th of next month\">\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"month\">Month</Label>\n            <Select value={selectedMonth} onValueChange={setSelectedMonth} disabled={loading}>\n              <SelectTrigger id=\"month\">\n                <SelectValue placeholder=\"Select month\" />\n              </SelectTrigger>\n              <SelectContent>\n                {months.map((month) => (\n                  <SelectItem key={month.value} value={month.value}>\n                    {month.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"year\">Year</Label>\n            <Select value={selectedYear} onValueChange={setSelectedYear} disabled={loading}>\n              <SelectTrigger id=\"year\">\n                <SelectValue placeholder=\"Select year\" />\n              </SelectTrigger>\n              <SelectContent>\n                {years.map((year) => (\n                  <SelectItem key={year} value={String(year)}>\n                    {year}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !selectedStation || !selectedMonth || !selectedYear}>\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {profitReport && (\n        <div className=\"space-y-6\">\n          {/* Header */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <TrendingUp className=\"h-5 w-5\" />\n                  Profit Report - {profitReport.stationName}\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Calendar className=\"h-4 w-4\" />\n                  {profitReport.month} {profitReport.year}\n                </div>\n              </CardTitle>\n            </CardHeader>\n          </Card>\n\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-green-600 dark:text-green-400\">Total Revenue</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-700\">\n                  Rs. {profitReport.totalRevenue.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  Daily avg: Rs. {Math.floor(profitReport.totalRevenue / profitReport.dailyData.length).toLocaleString()}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-red-600 dark:text-red-400\">Total Expenses</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-700\">\n                  Rs. {profitReport.totalExpenses.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {((profitReport.totalExpenses / profitReport.totalRevenue) * 100).toFixed(1)}% of revenue\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-blue-600 dark:text-blue-400\">Net Profit</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className={`text-2xl font-bold ${profitReport.totalProfit >= 0 ? 'text-blue-700' : 'text-red-700'}`}>\n                  Rs. {profitReport.totalProfit.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {profitReport.averageMargin.toFixed(1)}% margin\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-purple-600 dark:text-purple-400\">Growth</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className={`text-2xl font-bold ${profitReport.profitGrowth >= 0 ? 'text-green-700' : 'text-red-700'}`}>\n                  {profitReport.profitGrowth >= 0 ? '+' : ''}{profitReport.profitGrowth.toFixed(1)}%\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  vs previous month\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Profit Line Chart */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Daily Profit Trend</CardTitle>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Business Month: {formatBusinessMonthRange(getBusinessMonth(parseInt(selectedMonth), parseInt(selectedYear)))}\n              </p>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-80\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <LineChart data={profitReport.dailyData}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis\n                      dataKey=\"date\"\n                      tick={{ fontSize: 10 }}\n                      tickFormatter={(value) => {\n                        const d = new Date(value)\n                        return `${d.getDate()}/${d.getMonth() + 1}`\n                      }}\n                    />\n                    <YAxis\n                      tick={{ fontSize: 12 }}\n                      tickFormatter={(value) => `Rs. ${(value / 1000).toFixed(0)}K`}\n                    />\n                    <Tooltip\n                      formatter={(value: number, name: string) => [\n                        `Rs. ${value.toLocaleString()}`,\n                        name === 'profit' ? 'Profit' : name === 'revenue' ? 'Revenue' : 'Expenses'\n                      ]}\n                      labelFormatter={(date) => {\n                        const d = new Date(date)\n                        return `${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`\n                      }}\n                    />\n                    <Line\n                      type=\"monotone\"\n                      dataKey=\"revenue\"\n                      stroke=\"#10b981\"\n                      strokeWidth={2}\n                      name=\"revenue\"\n                    />\n                    <Line\n                      type=\"monotone\"\n                      dataKey=\"expenses\"\n                      stroke=\"#ef4444\"\n                      strokeWidth={2}\n                      name=\"expenses\"\n                    />\n                    <Line\n                      type=\"monotone\"\n                      dataKey=\"profit\"\n                      stroke=\"#3b82f6\"\n                      strokeWidth={3}\n                      name=\"profit\"\n                    />\n                  </LineChart>\n                </ResponsiveContainer>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Best/Worst Days */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-green-600 dark:text-green-400\">Best Performing Day</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span>Date:</span>\n                    <span className=\"font-medium\">{new Date(profitReport.bestDay.date).toLocaleDateString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Revenue:</span>\n                    <span className=\"text-green-600 dark:text-green-400\">Rs. {profitReport.bestDay.revenue.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Expenses:</span>\n                    <span className=\"text-red-600 dark:text-red-400\">Rs. {profitReport.bestDay.expenses.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between border-t pt-2\">\n                    <span className=\"font-semibold\">Profit:</span>\n                    <span className=\"font-bold text-blue-600 dark:text-blue-400\">Rs. {profitReport.bestDay.profit.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Margin:</span>\n                    <span className=\"\">{profitReport.bestDay.margin.toFixed(1)}%</span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-red-600 dark:text-red-400\">Lowest Performing Day</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span>Date:</span>\n                    <span className=\"font-medium\">{new Date(profitReport.worstDay.date).toLocaleDateString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Revenue:</span>\n                    <span className=\"text-green-600 dark:text-green-400\">Rs. {profitReport.worstDay.revenue.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Expenses:</span>\n                    <span className=\"text-red-600 dark:text-red-400\">Rs. {profitReport.worstDay.expenses.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between border-t pt-2\">\n                    <span className=\"font-semibold\">Profit:</span>\n                    <span className=\"font-bold text-blue-600 dark:text-blue-400\">Rs. {profitReport.worstDay.profit.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Margin:</span>\n                    <span className=\"\">{profitReport.worstDay.margin.toFixed(1)}%</span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Revenue Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Revenue Breakdown</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={profitReport.revenueBreakdown}\n                columns={revenueColumns}\n                searchPlaceholder=\"Search revenue sources...\"\n                pagination={false}\n                emptyMessage=\"No revenue breakdown available.\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Expense Breakdown */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Expense Breakdown</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={profitReport.expenseBreakdown}\n                columns={expenseColumns}\n                searchPlaceholder=\"Search expense categories...\"\n                pagination={false}\n                emptyMessage=\"No expense breakdown available.\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Export Actions */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Export Report</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-4\">\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"outline\" disabled={!profitReport}>\n                      <Download className=\"mr-2 h-4 w-4\" />\n                      Export Report\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" className=\"w-48\">\n                    <DropdownMenuItem onClick={exportToPDF} className=\"cursor-pointer\">\n                      <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                      <span>Export as PDF</span>\n                    </DropdownMenuItem>\n                    <DropdownMenuItem onClick={exportToExcel} className=\"cursor-pointer\">\n                      <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                      <span>Export as Excel</span>\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n                <Button variant=\"outline\">\n                  <FileText className=\"mr-2 h-4 w-4\" />\n                  Email Report\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\pumper-details\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatBusinessMonthRange' is defined but never used.","line":6,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":59},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":33,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CreditCard' is defined but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":13},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchReport'. Either include it or remove the dependency array.","line":196,"column":6,"nodeType":"ArrayExpression","endLine":196,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, selectedYear, selectedMonth, fetchReport]","fix":{"range":[5502,5548],"text":"[selectedStation, selectedYear, selectedMonth, fetchReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useRouter } from 'next/navigation'\nimport { getCurrentBusinessMonth, formatBusinessMonthRange } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Users,\n  TrendingUp,\n  Fuel,\n  AlertCircle,\n  ArrowLeft,\n  RefreshCw,\n  Download,\n  AlertTriangle,\n  Clock,\n  DollarSign,\n  Award,\n  CreditCard,\n  FileText,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { Badge } from '@/components/ui/badge'\nimport { exportPumperDetailsReportPDF, exportPumperDetailsReportExcel } from '@/lib/exportUtils'\n\ninterface ActiveLoan {\n  id: string\n  description?: string\n  amount: number\n  balance: number\n  monthlyRental: number\n  createdAt: string\n}\n\ninterface PumperReport {\n  summary: {\n    // ... (unchanged)\n    totalPumpers: number\n    totalShifts: number\n    totalSales: number\n    totalLiters: number\n    averageSalesPerPumper: number\n    excellentPerformers: number\n    goodPerformers: number\n    needsImprovement: number\n    criticalPerformers: number\n    totalActiveLoans: number\n    totalLoanBalance: number\n    totalSalaryPaid: number\n  }\n  pumperDetails: Array<{\n    id: string\n    name: string\n    employeeId: string\n    phoneNumber: string\n    address: string\n    nic: string\n    baseSalary: number\n    holidayAllowance: number\n    epfNumber: string\n    totalShifts: number\n    totalSales: number\n    totalLiters: number\n    averageSalesPerShift: number\n    averageLitersPerShift: number\n    totalVariance: number\n    shiftsWithVariance: number\n    varianceRate: number\n    performanceRating: 'EXCELLENT' | 'GOOD' | 'NEEDS_IMPROVEMENT' | 'CRITICAL'\n    totalLoanBalance: number\n    totalMonthlyRental: number\n    advanceLimit: number\n    activeLoansCount: number\n    totalSalaryPaid: number\n    totalAdvances: number\n    totalLoanDeductions: number\n    recentSalaryPayments: Array<{\n      id: string\n      paymentDate: string\n      baseSalary: number\n      varianceAdd: number\n      varianceDeduct: number\n      advances: number\n      loans: number\n      netSalary: number\n    }>\n    activeLoans: Array<ActiveLoan>\n    fuelTypeBreakdown: Array<{\n      fuelName: string\n      liters: number\n      shifts: number\n    }>\n  }>\n  dateRange: {\n    start: string\n    end: string\n  }\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nconst performanceColors = {\n  EXCELLENT: 'bg-green-100 text-green-700 dark:bg-green-950 dark:text-green-400',\n  GOOD: 'bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-400',\n  NEEDS_IMPROVEMENT: 'bg-orange-100 text-orange-700 dark:bg-orange-950 dark:text-orange-400',\n  CRITICAL: 'bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-400'\n}\n\nconst formatFuelName = (fuelName: string): string => {\n  return fuelName\n    .split('_')\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n    .join(' ')\n}\n\nexport default function PumperDetailsReportPage() {\n  const router = useRouter()\n  const { selectedStation, stations } = useStation()\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [reportData, setReportData] = useState<PumperReport | null>(null)\n  const [selectedPumper, setSelectedPumper] = useState<string>('all')\n\n  // Month selection\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedYear, setSelectedYear] = useState(currentBusinessMonth.year.toString())\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n\n  const years = Array.from({ length: 3 }, (_, i) => {\n    const year = currentBusinessMonth.year - i\n    return { value: year.toString(), label: year.toString() }\n  })\n\n  const exportToPDF = () => {\n    if (!reportData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const exportData = {\n      summary: reportData.summary,\n      pumperDetails: reportData.pumperDetails\n    }\n\n    exportPumperDetailsReportPDF(exportData, stationName, monthLabel)\n  }\n\n  const exportToExcel = () => {\n    if (!reportData) return\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'All Stations'\n    const monthLabel = `${selectedYear}-${selectedMonth}`\n\n    const exportData = {\n      summary: reportData.summary,\n      pumperDetails: reportData.pumperDetails\n    }\n\n    exportPumperDetailsReportExcel(exportData, stationName, monthLabel)\n  }\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchReport()\n    }\n  }, [selectedStation, selectedYear, selectedMonth])\n\n  const fetchReport = async () => {\n    if (!selectedStation) {\n      setError('Please select a station')\n      return\n    }\n\n    try {\n      setLoading(true)\n      setError('')\n\n      const year = parseInt(selectedYear)\n      const month = parseInt(selectedMonth)\n      const startDate = new Date(year, month - 1, 7)\n      const endDate = new Date(year, month, 6, 23, 59, 59)\n\n      const res = await fetch(\n        `/api/reports/pumper-details?stationId=${selectedStation}&startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`\n      )\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        console.error('API Error:', errorData)\n        throw new Error(errorData.details || errorData.error || 'Failed to fetch pumper report')\n      }\n\n      const data = await res.json()\n      setReportData(data)\n    } catch (err) {\n      console.error('Error fetching pumper report:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (loading && !reportData) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 dark:border-blue-400\"></div>\n      </div>\n    )\n  }\n\n  const selectedPumperData = selectedPumper && selectedPumper !== 'all'\n    ? reportData?.pumperDetails.find(p => p.id === selectedPumper)\n    : null\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Pumper Details Report</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Comprehensive pumper performance, salary, and loan information\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={fetchReport}>\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" disabled={!reportData}>\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export Report\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-48\">\n              <DropdownMenuItem onClick={exportToPDF} className=\"cursor-pointer\">\n                <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                <span>Export as PDF</span>\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={exportToExcel} className=\"cursor-pointer\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                <span>Export as Excel</span>\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filters</CardTitle>\n          <CardDescription>Select parameters to view pumper data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"year\">Year</Label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger id=\"year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map(year => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"month\">Month</Label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger id=\"month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map(month => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"pumper\">Select Pumper (Optional)</Label>\n              <Select value={selectedPumper} onValueChange={setSelectedPumper}>\n                <SelectTrigger id=\"pumper\">\n                  <SelectValue placeholder=\"All Pumpers\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Pumpers</SelectItem>\n                  {reportData?.pumperDetails.map(pumper => (\n                    <SelectItem key={pumper.id} value={pumper.id}>\n                      {pumper.name} ({pumper.employeeId})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {error && (\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-2 text-red-600\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              <span>{error}</span>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Summary Cards */}\n      {reportData && selectedPumper === 'all' && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Users className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Total Pumpers</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                  {reportData.summary.totalPumpers}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {reportData.summary.totalShifts} total shifts\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <TrendingUp className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Total Sales</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                  Rs. {reportData.summary.totalSales.toLocaleString()}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {reportData.summary.totalLiters.toLocaleString()} L sold\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Award className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Performance</h3>\n                </div>\n                <div className=\"flex gap-1 mt-2\">\n                  <Badge className=\"bg-green-100 text-green-700 text-xs\">\n                    {reportData.summary.excellentPerformers} Excellent\n                  </Badge>\n                  <Badge className=\"bg-blue-100 text-blue-700 text-xs\">\n                    {reportData.summary.goodPerformers} Good\n                  </Badge>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <DollarSign className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n                  <h3 className=\"text-sm font-semibold text-muted-foreground\">Active Loans</h3>\n                </div>\n                <p className=\"text-2xl font-bold text-orange-600 dark:text-orange-400\">\n                  {reportData.summary.totalActiveLoans}\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Rs. {reportData.summary.totalLoanBalance.toLocaleString()} balance\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </>\n      )}\n\n      {/* Individual Pumper View */}\n      {selectedPumperData && (\n        <div className=\"space-y-6\">\n          {/* Pumper Info Card */}\n          <FormCard title={`${selectedPumperData.name} - Details`} description={`Employee ID: ${selectedPumperData.employeeId}`}>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4\">\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Phone Number</Label>\n                <p className=\"font-medium\">{selectedPumperData.phoneNumber}</p>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">NIC</Label>\n                <p className=\"font-medium\">{selectedPumperData.nic}</p>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">EPF Number</Label>\n                <p className=\"font-medium\">{selectedPumperData.epfNumber}</p>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Base Salary</Label>\n                <p className=\"font-medium\">Rs. {selectedPumperData.baseSalary.toLocaleString()}</p>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Holiday Allowance</Label>\n                <p className=\"font-medium\">Rs. {selectedPumperData.holidayAllowance.toLocaleString()}</p>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Advance Limit</Label>\n                <p className=\"font-medium text-blue-600\">Rs. {selectedPumperData.advanceLimit.toLocaleString()}</p>\n              </div>\n            </div>\n          </FormCard>\n\n          {/* Performance Metrics */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Total Shifts</h3>\n                <p className=\"text-3xl font-bold\">{selectedPumperData.totalShifts}</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardContent className=\"p-4\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Total Sales</h3>\n                <p className=\"text-3xl font-bold text-green-600\">Rs. {selectedPumperData.totalSales.toLocaleString()}</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Avg: Rs. {selectedPumperData.averageSalesPerShift.toLocaleString()}/shift\n                </p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardContent className=\"p-4\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Total Liters</h3>\n                <p className=\"text-3xl font-bold text-blue-600\">{selectedPumperData.totalLiters.toLocaleString()} L</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Avg: {selectedPumperData.averageLitersPerShift.toLocaleString()} L/shift\n                </p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardContent className=\"p-4\">\n                <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Performance</h3>\n                <Badge className={performanceColors[selectedPumperData.performanceRating]}>\n                  {selectedPumperData.performanceRating}\n                </Badge>\n                <p className=\"text-xs text-muted-foreground mt-2\">\n                  Variance Rate: {selectedPumperData.varianceRate}%\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Fuel Type Breakdown */}\n          <FormCard title=\"Fuel Type Breakdown\" description=\"Sales by fuel type\">\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4\">\n              {selectedPumperData.fuelTypeBreakdown.map((fuel) => (\n                <Card key={fuel.fuelName}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <Fuel className=\"h-4 w-4 text-purple-600\" />\n                      <h3 className=\"text-sm font-semibold\">{formatFuelName(fuel.fuelName)}</h3>\n                    </div>\n                    <p className=\"text-2xl font-bold\">{fuel.liters.toLocaleString()} L</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">{fuel.shifts} shifts</p>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </FormCard>\n\n          {/* Financial Summary */}\n          <FormCard title=\"Financial Summary\" description=\"Salary, loans, and deductions\">\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4\">\n              <Card>\n                <CardContent className=\"p-4\">\n                  <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Salary Paid</h3>\n                  <p className=\"text-2xl font-bold text-green-600\">Rs. {selectedPumperData.totalSalaryPaid.toLocaleString()}</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">This period</p>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Total Advances</h3>\n                  <p className=\"text-2xl font-bold text-orange-600\">Rs. {selectedPumperData.totalAdvances.toLocaleString()}</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">Deducted</p>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardContent className=\"p-4\">\n                  <h3 className=\"text-sm font-semibold text-muted-foreground mb-2\">Loan Balance</h3>\n                  <p className=\"text-2xl font-bold text-red-600\">Rs. {selectedPumperData.totalLoanBalance.toLocaleString()}</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {selectedPumperData.activeLoansCount} active loans\n                  </p>\n                </CardContent>\n              </Card>\n            </div>\n          </FormCard>\n\n          {/* Active Loans */}\n          {selectedPumperData.activeLoans.length > 0 && (\n            <FormCard title=\"Active Loans\" description=\"Current outstanding loans\">\n              <div className=\"overflow-x-auto mt-4\">\n                <table className=\"w-full border-collapse\">\n                  <thead>\n                    <tr className=\"border-b-2 bg-muted/30\">\n                      <th className=\"text-left p-3 font-semibold\">Description</th>\n                      <th className=\"text-right p-3 font-semibold\">Original Amount</th>\n                      <th className=\"text-right p-3 font-semibold\">Balance</th>\n                      <th className=\"text-right p-3 font-semibold\">Monthly Rental</th>\n                      <th className=\"text-left p-3 font-semibold\">Date</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {selectedPumperData.activeLoans.map((loan) => (\n                      <tr key={loan.id} className=\"border-b\">\n                        <td className=\"p-3\">{loan.description || 'N/A'}</td>\n                        <td className=\"text-right p-3\">Rs. {loan.amount.toLocaleString()}</td>\n                        <td className=\"text-right p-3 text-red-600 font-semibold\">\n                          Rs. {loan.balance.toLocaleString()}\n                        </td>\n                        <td className=\"text-right p-3\">Rs. {(loan.monthlyRental || 0).toLocaleString()}</td>\n                        <td className=\"p-3\">{new Date(loan.createdAt).toLocaleDateString()}</td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </FormCard>\n          )}\n\n          {/* Recent Salary Payments */}\n          {selectedPumperData.recentSalaryPayments.length > 0 && (\n            <FormCard title=\"Recent Salary Payments\" description=\"Last 5 salary payments\">\n              <div className=\"overflow-x-auto mt-4\">\n                <table className=\"w-full border-collapse text-sm\">\n                  <thead>\n                    <tr className=\"border-b-2 bg-muted/30\">\n                      <th className=\"text-left p-3 font-semibold\">Date</th>\n                      <th className=\"text-right p-3 font-semibold\">Base Salary</th>\n                      <th className=\"text-right p-3 font-semibold\">Variance (+)</th>\n                      <th className=\"text-right p-3 font-semibold\">Variance (-)</th>\n                      <th className=\"text-right p-3 font-semibold\">Advances</th>\n                      <th className=\"text-right p-3 font-semibold\">Loan Deduction</th>\n                      <th className=\"text-right p-3 font-semibold\">Net Salary</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {selectedPumperData.recentSalaryPayments.map((payment) => (\n                      <tr key={payment.id} className=\"border-b\">\n                        <td className=\"p-3\">{new Date(payment.paymentDate).toLocaleDateString()}</td>\n                        <td className=\"text-right p-3\">Rs. {payment.baseSalary.toLocaleString()}</td>\n                        <td className=\"text-right p-3 text-green-600\">\n                          +Rs. {payment.varianceAdd.toLocaleString()}\n                        </td>\n                        <td className=\"text-right p-3 text-orange-600\">\n                          -Rs. {payment.varianceDeduct.toLocaleString()}\n                        </td>\n                        <td className=\"text-right p-3 text-orange-600\">\n                          -Rs. {payment.advances.toLocaleString()}\n                        </td>\n                        <td className=\"text-right p-3 text-red-600\">\n                          -Rs. {payment.loans.toLocaleString()}\n                        </td>\n                        <td className=\"text-right p-3 font-semibold text-blue-600\">\n                          Rs. {payment.netSalary.toLocaleString()}\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </FormCard>\n          )}\n        </div>\n      )}\n\n      {/* All Pumpers Table */}\n      {reportData && selectedPumper === 'all' && (\n        <FormCard title=\"Pumper Overview\" description=\"Complete pumper performance summary\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full border-collapse text-sm\">\n              <thead>\n                <tr className=\"border-b-2 bg-muted/30\">\n                  <th className=\"text-left p-3 font-semibold\">Pumper</th>\n                  <th className=\"text-right p-3 font-semibold\">Shifts</th>\n                  <th className=\"text-right p-3 font-semibold\">Sales</th>\n                  <th className=\"text-right p-3 font-semibold\">Liters</th>\n                  <th className=\"text-right p-3 font-semibold\">Variance %</th>\n                  <th className=\"text-left p-3 font-semibold\">Performance</th>\n                  <th className=\"text-right p-3 font-semibold\">Loans</th>\n                  <th className=\"text-right p-3 font-semibold\">Salary Paid</th>\n                  <th className=\"text-center p-3 font-semibold\">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                {reportData.pumperDetails.map((pumper, index) => (\n                  <tr key={pumper.id} className={index % 2 === 0 ? 'bg-muted/50' : ''}>\n                    <td className=\"p-3\">\n                      <div>\n                        <p className=\"font-medium\">{pumper.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">{pumper.employeeId}</p>\n                      </div>\n                    </td>\n                    <td className=\"text-right p-3\">{pumper.totalShifts}</td>\n                    <td className=\"text-right p-3\">Rs. {pumper.totalSales.toLocaleString()}</td>\n                    <td className=\"text-right p-3\">{pumper.totalLiters.toLocaleString()} L</td>\n                    <td className=\"text-right p-3\">\n                      <span className={pumper.varianceRate > 15 ? 'text-red-600 font-semibold' : ''}>\n                        {pumper.varianceRate}%\n                      </span>\n                    </td>\n                    <td className=\"p-3\">\n                      <Badge className={performanceColors[pumper.performanceRating]}>\n                        {pumper.performanceRating}\n                      </Badge>\n                    </td>\n                    <td className=\"text-right p-3\">\n                      {pumper.activeLoansCount > 0 && (\n                        <div>\n                          <p className=\"text-red-600\">Rs. {pumper.totalLoanBalance.toLocaleString()}</p>\n                          <p className=\"text-xs text-muted-foreground\">{pumper.activeLoansCount} loans</p>\n                        </div>\n                      )}\n                    </td>\n                    <td className=\"text-right p-3\">Rs. {pumper.totalSalaryPaid.toLocaleString()}</td>\n                    <td className=\"text-center p-3\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => setSelectedPumper(pumper.id)}\n                      >\n                        View Details\n                      </Button>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </FormCard>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\pumper-variance\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XAxis' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'YAxis' is defined but never used.","line":25,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":31,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingDown' is defined but never used.","line":32,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":132,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":132,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'station' is assigned a value but never used.","line":166,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":166,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":229,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":229,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { getCurrentBusinessMonth } from '@/lib/businessMonth'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  ResponsiveContainer\n} from 'recharts'\nimport {\n  Building2,\n  User,\n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  AlertCircle,\n  Calculator,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  Calendar,\n  ArrowLeft\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface PumperVariance {\n  pumperId: string\n  pumperName: string\n  nozzleAssignments: string[]\n\n  // Monthly statistics\n  totalShifts: number\n  shiftsWithVariance: number\n  varianceCount: number\n\n  // Financial impact\n  totalVarianceAmount: number\n  averageVariancePerShift: number\n  maxSingleVariance: number\n\n  // Performance metrics\n  varianceRate: number // percentage of shifts with variance\n  performanceRating: 'EXCELLENT' | 'GOOD' | 'NEEDS_IMPROVEMENT' | 'CRITICAL'\n\n  // Trend data for sparkline (last 30 days)\n  dailyVariances: { day: number; variance: number }[]\n\n  // Additional details\n  lastVarianceDate?: string\n  consecutiveDaysWithoutVariance: number\n  totalDueAmount: number\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nconst currentYear = new Date().getFullYear()\nconst years = Array.from({ length: 3 }, (_, i) => currentYear - i)\n\n// Simple sparkline component\nconst Sparkline = ({ data }: { data: { day: number; variance: number }[] }) => (\n  <div className=\"w-24 h-8\">\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <LineChart data={data}>\n        <Line\n          type=\"monotone\"\n          dataKey=\"variance\"\n          stroke=\"#3b82f6\"\n          strokeWidth={1}\n          dot={false}\n        />\n      </LineChart>\n    </ResponsiveContainer>\n  </div>\n)\n\nexport default function PumperVariancePage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [pumperVariances, setPumperVariances] = useState<PumperVariance[]>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const currentBusinessMonth = getCurrentBusinessMonth()\n  const [selectedMonth, setSelectedMonth] = useState(String(currentBusinessMonth.month).padStart(2, '0'))\n  const [selectedYear, setSelectedYear] = useState(String(currentBusinessMonth.year))\n\n  // Load initial data\n  useEffect(() => {\n    const loadStations = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadStations()\n  }, [])\n\n  const generateReport = async () => {\n    if (!selectedStation || !selectedMonth || !selectedYear) {\n      setError('Please select station, month, and year')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call API endpoint to get real pumper variance data\n      const monthStr = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}`\n      const url = `/api/reports/pumper-variance?stationId=${selectedStation}&month=${monthStr}`\n\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n        cache: 'no-store'\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error(errorData.error || `Failed to fetch pumper variance report: ${response.status}`)\n      }\n\n      const reportData = await response.json()\n      const station = stations.find(s => s.id === selectedStation)\n\n      // Transform API data to match frontend interface\n      interface ApiDailyVariance {\n        day?: number\n        variance?: number\n      }\n\n      interface ApiPumperVariance {\n        pumperId: string\n        pumperName: string\n        dailyVariances?: ApiDailyVariance[]\n        totalShifts: number\n        shiftsWithVariance: number\n        varianceCount: number\n        totalVarianceAmount: number\n        maxSingleVariance?: number\n        varianceRate: number\n        performanceRating: 'EXCELLENT' | 'GOOD' | 'NEEDS_IMPROVEMENT' | 'CRITICAL'\n      }\n\n      const pumperVariances: PumperVariance[] = (reportData.pumperVariances || []).map((pumper: ApiPumperVariance) => {\n        // Transform daily variances from API (which uses day of month) to match expected format\n        const dailyVariances = (pumper.dailyVariances || []).map((dv) => ({\n          day: dv.day || 1,\n          variance: dv.variance || 0\n        }))\n\n        // Calculate additional fields\n        const averageVariancePerShift = pumper.varianceCount > 0\n          ? pumper.totalVarianceAmount / pumper.varianceCount\n          : 0\n\n        // Estimate total due amount (70% of total variance - this would need to be calculated from actual advance/loan records)\n        const totalDueAmount = Math.floor(pumper.totalVarianceAmount * 0.7)\n\n        // Get nozzle assignments - would need to fetch from assignments, using placeholder for now\n        const nozzleAssignments: string[] = [] // Would need to fetch from shift assignments\n\n        return {\n          pumperId: pumper.pumperId,\n          pumperName: pumper.pumperName,\n          nozzleAssignments,\n          totalShifts: pumper.totalShifts,\n          shiftsWithVariance: pumper.shiftsWithVariance,\n          varianceCount: pumper.varianceCount,\n          totalVarianceAmount: pumper.totalVarianceAmount,\n          averageVariancePerShift,\n          maxSingleVariance: pumper.maxSingleVariance || 0,\n          varianceRate: pumper.varianceRate,\n          performanceRating: pumper.performanceRating,\n          dailyVariances,\n          lastVarianceDate: undefined, // Would need to calculate from shift data\n          consecutiveDaysWithoutVariance: 0, // Would need to calculate from shift data\n          totalDueAmount\n        }\n      })\n\n      // API already sorts by variance rate, but ensure it's sorted\n      pumperVariances.sort((a, b) => b.varianceRate - a.varianceRate)\n\n      setPumperVariances(pumperVariances)\n\n    } catch (err) {\n      setError('Failed to generate pumper variance report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getPerformanceColor = (rating: string) => {\n    switch (rating) {\n      case 'EXCELLENT': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'GOOD': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'NEEDS_IMPROVEMENT': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'CRITICAL': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getPerformanceIcon = (rating: string) => {\n    switch (rating) {\n      case 'EXCELLENT': return <CheckCircle className=\"h-4 w-4\" />\n      case 'GOOD': return <CheckCircle className=\"h-4 w-4\" />\n      case 'NEEDS_IMPROVEMENT': return <AlertTriangle className=\"h-4 w-4\" />\n      case 'CRITICAL': return <XCircle className=\"h-4 w-4\" />\n      default: return <AlertCircle className=\"h-4 w-4\" />\n    }\n  }\n\n  const getVarianceRateColor = (rate: number) => {\n    if (rate <= 5) return 'text-green-600 dark:text-green-400'\n    if (rate <= 15) return 'text-blue-600 dark:text-blue-400'\n    if (rate <= 30) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-red-600 dark:text-red-400'\n  }\n\n  const pumperColumns: Column<PumperVariance>[] = [\n    {\n      key: 'pumperName' as keyof PumperVariance,\n      title: 'Pumper',\n      render: (value: unknown, row: PumperVariance) => (\n        <div className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            <div className=\"text-xs text-muted-foreground\">\n              {row.nozzleAssignments.join(', ')}\n            </div>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'totalShifts' as keyof PumperVariance,\n      title: 'Total Shifts',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as number}</span>\n      )\n    },\n    {\n      key: 'varianceCount' as keyof PumperVariance,\n      title: 'Variance Count',\n      render: (value: unknown, row: PumperVariance) => (\n        <div className=\"text-center\">\n          <div className=\"font-semibold text-red-600 dark:text-red-400\">\n            {value as number}\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.shiftsWithVariance} shifts affected\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'totalVarianceAmount' as keyof PumperVariance,\n      title: 'Total Variance',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-red-600 dark:text-red-400\">\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'totalDueAmount' as keyof PumperVariance,\n      title: 'Amount Due',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-orange-600 dark:text-orange-400\">\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'maxSingleVariance' as keyof PumperVariance,\n      title: 'Max Shortage',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-red-700\">\n          Rs. {(value as number)?.toLocaleString() || 0}\n        </span>\n      )\n    },\n    {\n      key: 'varianceRate' as keyof PumperVariance,\n      title: 'Variance Rate',\n      render: (value: unknown) => (\n        <div className=\"text-center\">\n          <div className={`font-semibold ${getVarianceRateColor(value as number)}`}>\n            {(value as number)?.toFixed(1) || 0}%\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'dailyVariances' as keyof PumperVariance,\n      title: 'Trend (30 days)',\n      render: (value: unknown) => (\n        <div className=\"flex justify-center\">\n          <Sparkline data={value as { day: number; variance: number }[]} />\n        </div>\n      )\n    },\n    {\n      key: 'performanceRating' as keyof PumperVariance,\n      title: 'Performance',\n      render: (value: unknown) => (\n        <Badge className={getPerformanceColor(value as string)}>\n          <div className=\"flex items-center gap-1\">\n            {getPerformanceIcon(value as string)}\n            <span>{(value as string)?.replace('_', ' ') || 'Unknown'}</span>\n          </div>\n        </Badge>\n      )\n    }\n  ]\n\n  // Calculate summary statistics\n  const totalPumpers = pumperVariances.length\n  const excellentPumpers = pumperVariances.filter(p => p.performanceRating === 'EXCELLENT').length\n  const criticalPumpers = pumperVariances.filter(p => p.performanceRating === 'CRITICAL').length\n  const totalVarianceAmount = pumperVariances.reduce((sum, p) => sum + p.totalVarianceAmount, 0)\n  const totalDueAmount = pumperVariances.reduce((sum, p) => sum + p.totalDueAmount, 0)\n  const averageVarianceRate = totalPumpers > 0 ? pumperVariances.reduce((sum, p) => sum + p.varianceRate, 0) / totalPumpers : 0\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">Pumper Variance Report</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Generate Pumper Variance Report\">\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"month\">Month</Label>\n            <Select value={selectedMonth} onValueChange={setSelectedMonth} disabled={loading}>\n              <SelectTrigger id=\"month\">\n                <SelectValue placeholder=\"Select month\" />\n              </SelectTrigger>\n              <SelectContent>\n                {months.map((month) => (\n                  <SelectItem key={month.value} value={month.value}>\n                    {month.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"year\">Year</Label>\n            <Select value={selectedYear} onValueChange={setSelectedYear} disabled={loading}>\n              <SelectTrigger id=\"year\">\n                <SelectValue placeholder=\"Select year\" />\n              </SelectTrigger>\n              <SelectContent>\n                {years.map((year) => (\n                  <SelectItem key={year} value={String(year)}>\n                    {year}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !selectedStation || !selectedMonth || !selectedYear}>\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {pumperVariances.length > 0 && (\n        <div className=\"space-y-6\">\n          {/* Header */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <User className=\"h-5 w-5\" />\n                  Pumper Variance Report - {stations.find(s => s.id === selectedStation)?.name}\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Calendar className=\"h-4 w-4\" />\n                  {months.find(m => m.value === selectedMonth)?.label} {selectedYear}\n                </div>\n              </CardTitle>\n            </CardHeader>\n          </Card>\n\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-blue-600 dark:text-blue-400\">Total Pumpers</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-blue-700\">{totalPumpers}</div>\n                <div className=\"text-xs text-muted-foreground\">Active this month</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-green-600 dark:text-green-400\">Excellent</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-700\">{excellentPumpers}</div>\n                <div className=\"text-xs text-muted-foreground\">5% variance rate</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-red-600 dark:text-red-400\">Critical</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-700\">{criticalPumpers}</div>\n                <div className=\"text-xs text-muted-foreground\">30% variance rate</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-purple-600 dark:text-purple-400\">Total Variance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-purple-700\">\n                  Rs. {totalVarianceAmount.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">All pumpers combined</div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-orange-600 dark:text-orange-400\">Amount Due</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-orange-700\">\n                  Rs. {totalDueAmount.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">From pumpers</div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Average Performance */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Overall Performance Summary</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-semibold text-muted-foreground\">Average Variance Rate</div>\n                  <div className={`text-3xl font-bold ${getVarianceRateColor(averageVarianceRate)}`}>\n                    {averageVarianceRate.toFixed(1)}%\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Across all pumpers</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-semibold text-muted-foreground\">Performance Distribution</div>\n                  <div className=\"flex justify-center gap-2 mt-2\">\n                    <Badge className=\"bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300\">\n                      {excellentPumpers} Excellent\n                    </Badge>\n                    <Badge className=\"bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300\">\n                      {pumperVariances.filter(p => p.performanceRating === 'GOOD').length} Good\n                    </Badge>\n                    <Badge className=\"bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300\">\n                      {pumperVariances.filter(p => p.performanceRating === 'NEEDS_IMPROVEMENT').length} Needs Improvement\n                    </Badge>\n                    <Badge className=\"bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300\">\n                      {criticalPumpers} Critical\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-semibold text-muted-foreground\">Recovery Rate</div>\n                  <div className=\"text-3xl font-bold text-blue-600 dark:text-blue-400\">\n                    {((totalDueAmount / totalVarianceAmount) * 100).toFixed(0)}%\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Expected recovery</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Pumper Variance Table */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Pumper Variance Details</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={pumperVariances}\n                columns={pumperColumns}\n                searchPlaceholder=\"Search pumpers...\"\n                emptyMessage=\"No pumper variance data available.\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Critical Alerts */}\n          {criticalPumpers > 0 && (\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Critical Performance Alert</AlertTitle>\n              <AlertDescription>\n                {criticalPumpers} pumper{criticalPumpers > 1 ? 's have' : ' has'} critical variance rates exceeding 30%.\n                Immediate training and monitoring required to reduce losses.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {totalDueAmount > 10000 && (\n            <Alert>\n              <DollarSign className=\"h-4 w-4\" />\n              <AlertTitle>High Recovery Amount</AlertTitle>\n              <AlertDescription>\n                Total amount due from pumpers is Rs. {totalDueAmount.toLocaleString()}.\n                Consider implementing stricter controls and recovery procedures.\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\shift\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Printer' is defined but never used.","line":34,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingDown' is defined but never used.","line":37,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":152,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":152,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":330,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":330,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useCallback } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Building2,\n  DollarSign,\n  Clock,\n  User,\n  Fuel,\n  AlertCircle,\n  FileText,\n  Printer,\n  Calculator,\n  TrendingUp,\n  TrendingDown,\n  AlertTriangle,\n  ArrowLeft,\n  Download,\n  FileSpreadsheet\n} from 'lucide-react'\nimport { exportShiftReportPDF } from '@/lib/exportUtils'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface DeclaredAmounts {\n  cash: number\n  card: number\n  credit: number\n  cheque: number\n  pumperBreakdown: Array<{\n    pumperName: string\n    declaredAmount: number\n  }>\n}\n\ninterface Shift {\n  id: string\n  stationId: string\n  stationName: string\n  templateName: string\n  startTime: string\n  endTime: string\n  status: 'ACTIVE' | 'CLOSED'\n  declaredAmounts?: DeclaredAmounts\n}\n\ninterface ApiShift {\n  id: string\n  stationId: string\n  station?: { name: string }\n  template?: { name: string }\n  startTime: string\n  endTime?: string\n  status: 'ACTIVE' | 'CLOSED'\n  declaredAmounts?: DeclaredAmounts\n}\n\ninterface ApiAssignment {\n  id: string\n  nozzleId?: string\n  nozzleNumber?: string\n  pumperName?: string\n  sales?: number\n  fuelId?: string\n  fuel?: { name: string; icon?: React.ReactNode }\n  startMeterReading?: number\n  endMeterReading?: number\n  litersSold?: number\n  pricePerLiter?: number\n}\n\ninterface ShiftReport {\n  shift: Shift\n  nozzleReports: NozzleReport[]\n  tenderSummary: TenderSummary\n  totalVariance: number\n  variancePercentage: number\n  overallStatus: 'BALANCED' | 'MINOR_VARIANCE' | 'MAJOR_VARIANCE'\n}\n\ninterface NozzleReport {\n  nozzleId: string\n  nozzleName: string\n  fuel?: { name: string; icon?: React.ReactNode }\n  fuelId?: string\n  pumperName: string\n  startMeter: number\n  endMeter: number\n  litersSold: number\n  salesAmount: number\n  pricePerLiter: number\n  variance: number\n  variancePercentage: number\n  status: 'BALANCED' | 'MINOR_VARIANCE' | 'MAJOR_VARIANCE'\n}\n\ninterface TenderSummary {\n  cashTotal: number\n  cardTotals: { [bank: string]: number }\n  creditTotal: number\n  chequeTotal: number\n  totalDeclared: number\n  totalCalculated: number\n  variance: number\n}\n\nexport default function ShiftReportsPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [shifts, setShifts] = useState<Shift[]>([])\n  const [shiftReport, setShiftReport] = useState<ShiftReport | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedShift, setSelectedShift] = useState('')\n\n  // Load initial data\n  useEffect(() => {\n    const loadStations = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadStations()\n  }, [])\n\n  // Load shifts from API\n  const loadShifts = useCallback(async () => {\n    try {\n      const response = await fetch(`/api/shifts?stationId=${selectedStation}&status=CLOSED&limit=10`)\n      if (!response.ok) {\n        throw new Error('Failed to fetch shifts')\n      }\n      const data = await response.json()\n      // API returns { shifts: [], pagination: {}, summary: {} }\n      const shiftsArray = Array.isArray(data) ? data : (data.shifts || [])\n\n      // Transform API response to match expected interface\n      const transformedShifts: Shift[] = shiftsArray.map((shift: ApiShift) => ({\n        id: shift.id,\n        stationId: shift.stationId,\n        stationName: shift.station?.name || 'Unknown Station',\n        templateName: shift.template?.name || 'Unknown Template',\n        startTime: shift.startTime,\n        endTime: shift.endTime || shift.startTime, // Use startTime as fallback if endTime is null\n        status: shift.status,\n        declaredAmounts: shift.declaredAmounts\n      }))\n\n      setShifts(transformedShifts)\n    } catch (err) {\n      console.error('Error loading shifts:', err)\n      setError('Failed to load shifts')\n      setShifts([])\n    }\n  }, [selectedStation])\n\n  // Load shifts when station changes\n  useEffect(() => {\n    if (selectedStation) {\n      loadShifts()\n    } else {\n      setShifts([])\n      setSelectedShift('')\n    }\n  }, [selectedStation, loadShifts])\n\n  const generateReport = async () => {\n    if (!selectedShift) {\n      setError('Please select a shift')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call API endpoint to get real shift report data\n      const response = await fetch(`/api/shifts/${selectedShift}/report`, {\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n        cache: 'no-store'\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error(errorData.error || `Failed to fetch shift report: ${response.status}`)\n      }\n\n      const apiData = await response.json()\n      const reportData = apiData.data || apiData\n\n      // Transform API data to match frontend interface\n      const shift = shifts.find(s => s.id === selectedShift)\n      if (!shift) {\n        throw new Error('Shift not found in local data')\n      }\n\n      // Transform assignments to nozzle reports\n      const nozzleReports: NozzleReport[] = (reportData.assignments || []).map((assignment: ApiAssignment): NozzleReport => {\n        const declared = shift.declaredAmounts?.pumperBreakdown || []\n        const pumperBreakdown = declared.find((b) => b.pumperName === assignment.pumperName)\n        const calculatedSales = assignment.sales || 0\n        const declaredAmount = pumperBreakdown?.declaredAmount || 0\n        const variance = declaredAmount - calculatedSales\n        const variancePercentage = calculatedSales > 0 ? (variance / calculatedSales) * 100 : 0\n\n        let status: 'BALANCED' | 'MINOR_VARIANCE' | 'MAJOR_VARIANCE' = 'BALANCED'\n        if (Math.abs(variancePercentage) > 1.0) {\n          status = 'MAJOR_VARIANCE'\n        } else if (Math.abs(variancePercentage) > 0.3) {\n          status = 'MINOR_VARIANCE'\n        }\n\n        return {\n          nozzleId: assignment.nozzleId || assignment.id,\n          nozzleName: `Nozzle ${assignment.nozzleNumber || assignment.nozzleId || 'Unknown'}`,\n          fuelId: assignment.fuelId || '',\n          fuel: assignment.fuel,\n          pumperName: assignment.pumperName || 'Unknown',\n          startMeter: assignment.startMeterReading || 0,\n          endMeter: assignment.endMeterReading || 0,\n          litersSold: assignment.litersSold || 0,\n          salesAmount: calculatedSales,\n          pricePerLiter: assignment.pricePerLiter || 0,\n          variance: variance,\n          variancePercentage: variancePercentage,\n          status: status\n        }\n      })\n\n      // Get tender summary from shift declared amounts\n      const declaredAmounts = shift.declaredAmounts || {\n        cash: 0,\n        card: 0,\n        credit: 0,\n        cheque: 0,\n        pumperBreakdown: []\n      }\n      const cashTotal = declaredAmounts.cash || 0\n      const cardTotal = declaredAmounts.card || 0\n      const creditTotal = declaredAmounts.credit || 0\n      const chequeTotal = declaredAmounts.cheque || 0\n\n      // Get POS batches for card breakdown\n      const posBatchesResponse = await fetch(`/api/pos/batches?shiftId=${selectedShift}`).catch(() => null)\n      const cardTotals: Record<string, number> = {}\n      if (posBatchesResponse && posBatchesResponse.ok) {\n        const batches = await posBatchesResponse.json()\n        for (const batch of batches) {\n          if (batch.terminalEntries) {\n            for (const entry of batch.terminalEntries) {\n              const bankName = entry.terminal?.bank?.name || 'Unknown Bank'\n              const amount = (entry.visaAmount || 0) + (entry.masterAmount || 0) + (entry.amexAmount || 0) + (entry.qrAmount || 0) + (entry.dialogTouchAmount || 0)\n              cardTotals[bankName] = (cardTotals[bankName] || 0) + amount\n            }\n          }\n        }\n      }\n\n      const totalDeclared = cashTotal + cardTotal + creditTotal + chequeTotal\n      const totalCalculated = reportData.summary?.totalSales || nozzleReports.reduce((sum, r) => sum + r.salesAmount, 0)\n      const tenderVariance = totalDeclared - totalCalculated\n\n      const tenderSummary: TenderSummary = {\n        cashTotal,\n        cardTotals,\n        creditTotal,\n        chequeTotal,\n        totalDeclared,\n        totalCalculated,\n        variance: tenderVariance\n      }\n\n      const totalVariance = nozzleReports.reduce((sum, report) => sum + report.variance, 0) + tenderSummary.variance\n      const totalSales = totalCalculated\n      const variancePercentage = totalSales > 0 ? (totalVariance / totalSales) * 100 : 0\n\n      let overallStatus: 'BALANCED' | 'MINOR_VARIANCE' | 'MAJOR_VARIANCE' = 'BALANCED'\n      if (Math.abs(variancePercentage) > 1.0) {\n        overallStatus = 'MAJOR_VARIANCE'\n      } else if (Math.abs(variancePercentage) > 0.3) {\n        overallStatus = 'MINOR_VARIANCE'\n      }\n\n      const report: ShiftReport = {\n        shift,\n        nozzleReports,\n        tenderSummary,\n        totalVariance,\n        variancePercentage,\n        overallStatus\n      }\n\n      setShiftReport(report)\n\n    } catch (err) {\n      setError('Failed to generate shift report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const printShiftPDF = () => {\n    if (!shiftReport || !selectedShift) {\n      alert('Please select a shift and generate a report first')\n      return\n    }\n\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'Unknown Station'\n\n    const exportData = {\n      nozzlePerformance: shiftReport.nozzleReports.map(nr => ({\n        nozzleName: nr.nozzleName,\n        pumperName: nr.pumperName,\n        litresSold: nr.litersSold,\n        amount: nr.salesAmount,\n        variancePercentage: nr.variancePercentage\n      })),\n      totalSales: shiftReport.tenderSummary.totalCalculated,\n      totalDeclared: shiftReport.tenderSummary.totalDeclared,\n      variance: shiftReport.totalVariance,\n      overallStatus: shiftReport.overallStatus\n    }\n\n    exportShiftReportPDF(exportData, stationName, selectedShift)\n  }\n\n  const getVarianceColor = (percentage: number) => {\n    if (Math.abs(percentage) <= 0.3) return 'text-green-600 dark:text-green-400'\n    if (Math.abs(percentage) <= 1.0) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-red-600 dark:text-red-400'\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'BALANCED': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'MINOR_VARIANCE': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'MAJOR_VARIANCE': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const nozzleColumns: Column<NozzleReport>[] = [\n    {\n      key: 'nozzleName' as keyof NozzleReport,\n      title: 'Nozzle',\n      render: (value: unknown, row: NozzleReport) => (\n        <div className=\"flex items-center gap-2\">\n          <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            <div className=\"text-xs text-muted-foreground\">{row.fuel?.icon} {row.fuel?.name || 'Unknown'}</div>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'pumperName' as keyof NozzleReport,\n      title: 'Pumper',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'startMeter' as keyof NozzleReport,\n      title: 'Start Meter',\n      render: (value: unknown) => {\n        const numValue = typeof value === 'number' ? value : 0\n        return <span className=\"text-sm\">{numValue.toFixed(1)}</span>\n      }\n    },\n    {\n      key: 'endMeter' as keyof NozzleReport,\n      title: 'End Meter',\n      render: (value: unknown) => {\n        const numValue = typeof value === 'number' ? value : 0\n        return <span className=\"text-sm\">{numValue.toFixed(1)}</span>\n      }\n    },\n    {\n      key: 'litersSold' as keyof NozzleReport,\n      title: 'Litres Sold',\n      render: (value: unknown) => {\n        const numValue = typeof value === 'number' ? value : 0\n        return (\n          <span className=\"font-semibold text-blue-600 dark:text-blue-400\">\n            {numValue.toFixed(1)}L\n          </span>\n        )\n      }\n    },\n    {\n      key: 'salesAmount' as keyof NozzleReport,\n      title: 'Sales Amount',\n      render: (value: unknown) => {\n        const numValue = typeof value === 'number' ? value : 0\n        return (\n          <span className=\"font-semibold text-green-600 dark:text-green-400\">\n            Rs. {numValue.toLocaleString()}\n          </span>\n        )\n      }\n    },\n    {\n      key: 'variance' as keyof NozzleReport,\n      title: 'Variance',\n      render: (value: unknown, row: NozzleReport) => {\n        const numValue = typeof value === 'number' ? value : 0\n        return (\n          <div className=\"text-center\">\n            <div className={`font-semibold ${getVarianceColor(row.variancePercentage)}`}>\n              {numValue >= 0 ? '+' : ''}Rs. {numValue.toLocaleString()}\n            </div>\n            <div className={`text-xs ${getVarianceColor(row.variancePercentage)}`}>\n              {row.variancePercentage >= 0 ? '+' : ''}{row.variancePercentage.toFixed(3)}%\n            </div>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'status' as keyof NozzleReport,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {(value as string)?.replace('_', ' ') || 'Unknown'}\n        </Badge>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"outline\" onClick={() => router.push('/reports')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">Shift Reports</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Generate Shift Report\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"shift\">Shift</Label>\n            <Select value={selectedShift} onValueChange={setSelectedShift} disabled={loading || !selectedStation}>\n              <SelectTrigger id=\"shift\">\n                <SelectValue placeholder=\"Select a shift\" />\n              </SelectTrigger>\n              <SelectContent>\n                {shifts.map((shift) => (\n                  <SelectItem key={shift.id} value={shift.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Clock className=\"h-4 w-4\" />\n                      <div>\n                        <div>{shift.templateName}</div>\n                        <div className=\"text-xs text-muted-foreground\">\n                          {new Date(shift.startTime).toLocaleDateString()} - {new Date(shift.startTime).toLocaleTimeString()}\n                        </div>\n                      </div>\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !selectedShift}>\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {shiftReport && (\n        <div className=\"space-y-6\">\n          {/* Header */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <FileText className=\"h-5 w-5\" />\n                  Shift Report - {shiftReport.shift.stationName}\n                </div>\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    {shiftReport.shift.templateName}\n                  </div>\n                  <Badge className={getStatusColor(shiftReport.overallStatus)}>\n                    {shiftReport.overallStatus.replace('_', ' ')}\n                  </Badge>\n                </div>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Start Time</div>\n                  <div className=\"font-medium\">\n                    {new Date(shiftReport.shift.startTime).toLocaleString()}\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">End Time</div>\n                  <div className=\"font-medium\">\n                    {new Date(shiftReport.shift.endTime).toLocaleString()}\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Duration</div>\n                  <div className=\"font-medium\">\n                    {Math.round((new Date(shiftReport.shift.endTime).getTime() - new Date(shiftReport.shift.startTime).getTime()) / (1000 * 60 * 60))} hours\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-blue-600 dark:text-blue-400\">Total Sales</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-blue-700\">\n                  Rs. {shiftReport.nozzleReports.reduce((sum, report) => sum + report.salesAmount, 0).toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {shiftReport.nozzleReports.reduce((sum, report) => sum + report.litersSold, 0).toFixed(1)}L total\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-green-600 dark:text-green-400\">Declared Total</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-700\">\n                  Rs. {shiftReport.tenderSummary.totalDeclared.toLocaleString()}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  All payment methods\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-purple-600 dark:text-purple-400\">Total Variance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className={`text-2xl font-bold ${getVarianceColor(shiftReport.variancePercentage)}`}>\n                  {shiftReport.totalVariance >= 0 ? '+' : ''}Rs. {shiftReport.totalVariance.toLocaleString()}\n                </div>\n                <div className={`text-xs ${getVarianceColor(shiftReport.variancePercentage)}`}>\n                  {shiftReport.variancePercentage >= 0 ? '+' : ''}{shiftReport.variancePercentage.toFixed(3)}%\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Nozzles Active</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\">\n                  {shiftReport.nozzleReports.length}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {shiftReport.nozzleReports.filter(r => r.status === 'BALANCED').length} balanced\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Per-Nozzle/Pumper Sales */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Per-Nozzle/Pumper Sales</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={shiftReport.nozzleReports}\n                columns={nozzleColumns}\n                searchPlaceholder=\"Search nozzles...\"\n                pagination={false}\n                emptyMessage=\"No nozzle data available.\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Tender Summary */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Tender Summary</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                <div className=\"space-y-3\">\n                  <div className=\"font-semibold text-foreground\">Cash Payments</div>\n                  <div className=\"flex justify-between\">\n                    <span>Cash Total:</span>\n                    <span className=\"font-semibold\">Rs. {shiftReport.tenderSummary.cashTotal.toLocaleString()}</span>\n                  </div>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <div className=\"font-semibold text-foreground\">Card Payments</div>\n                  {Object.entries(shiftReport.tenderSummary.cardTotals).map(([bank, amount]) => (\n                    <div key={bank} className=\"flex justify-between\">\n                      <span>{bank}:</span>\n                      <span className=\"font-semibold\">Rs. {amount.toLocaleString()}</span>\n                    </div>\n                  ))}\n                  <div className=\"flex justify-between border-t pt-2\">\n                    <span className=\"font-semibold\">Card Total:</span>\n                    <span className=\"font-semibold\">\n                      Rs. {Object.values(shiftReport.tenderSummary.cardTotals).reduce((sum, amount) => sum + amount, 0).toLocaleString()}\n                    </span>\n                  </div>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <div className=\"font-semibold text-foreground\">Other Payments</div>\n                  <div className=\"flex justify-between\">\n                    <span>Credit:</span>\n                    <span className=\"font-semibold\">Rs. {shiftReport.tenderSummary.creditTotal.toLocaleString()}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Cheques:</span>\n                    <span className=\"font-semibold\">Rs. {shiftReport.tenderSummary.chequeTotal.toLocaleString()}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"mt-6 pt-4 border-t\">\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div className=\"text-center\">\n                    <div className=\"text-sm text-muted-foreground\">Total Declared</div>\n                    <div className=\"text-xl font-bold text-blue-600 dark:text-blue-400\">\n                      Rs. {shiftReport.tenderSummary.totalDeclared.toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"text-sm text-muted-foreground\">Total Calculated</div>\n                    <div className=\"text-xl font-bold text-green-600 dark:text-green-400\">\n                      Rs. {shiftReport.tenderSummary.totalCalculated.toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"text-sm text-muted-foreground\">Tender Variance</div>\n                    <div className={`text-xl font-bold ${getVarianceColor((shiftReport.tenderSummary.variance / shiftReport.tenderSummary.totalDeclared) * 100)}`}>\n                      {shiftReport.tenderSummary.variance >= 0 ? '+' : ''}Rs. {shiftReport.tenderSummary.variance.toLocaleString()}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Print Action */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Export & Print</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex gap-4\">\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"outline\" disabled={!shiftReport}>\n                      <Download className=\"mr-2 h-4 w-4\" />\n                      Export Report\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" className=\"w-48\">\n                    <DropdownMenuItem onClick={printShiftPDF} className=\"cursor-pointer\">\n                      <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\n                      <span>Export as PDF</span>\n                    </DropdownMenuItem>\n                    <DropdownMenuItem className=\"cursor-pointer\">\n                      <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\n                      <span>Export as Excel</span>\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Variance Alert */}\n          {shiftReport.overallStatus === 'MAJOR_VARIANCE' && (\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Major Variance Detected</AlertTitle>\n              <AlertDescription>\n                This shift has a variance of {shiftReport.variancePercentage.toFixed(3)}% which exceeds acceptable limits.\n                Please review all transactions and investigate discrepancies before finalizing.\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\station-comparison\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":8},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchStationData'. Either include it or remove the dependency array.","line":77,"column":6,"nodeType":"ArrayExpression","endLine":77,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [fetchStationData, router]","fix":{"range":[2024,2032],"text":"[fetchStationData, router]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { FormCard } from '@/components/ui/FormCard'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Label } from '@/components/ui/label'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu'\r\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\r\nimport {\r\n  ArrowLeft,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  Building2,\r\n  DollarSign,\r\n  Fuel,\r\n  Users,\r\n  Award,\r\n  AlertCircle,\r\n  Download,\r\n  RefreshCw,\r\n  FileText,\r\n  FileSpreadsheet\r\n} from 'lucide-react'\r\nimport jsPDF from 'jspdf'\r\nimport autoTable from 'jspdf-autotable'\r\nimport * as XLSX from 'xlsx'\r\n\r\ninterface StationStats {\r\n  id: string\r\n  name: string\r\n  totalSales: number\r\n  totalVolume: number\r\n  totalProfit: number\r\n  avgDailySales: number\r\n  pumperCount: number\r\n  shiftsCount: number\r\n  profitMargin: number\r\n}\r\n\r\nexport default function StationComparisonPage() {\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(true)\r\n  const [stations, setStations] = useState<StationStats[]>([])\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  // Date range state - default last 30 days\r\n  const [startDate, setStartDate] = useState<Date>(() => {\r\n    const date = new Date()\r\n    date.setDate(date.getDate() - 30)\r\n    date.setHours(0, 0, 0, 0)\r\n    return date\r\n  })\r\n  const [endDate, setEndDate] = useState<Date>(() => {\r\n    const date = new Date()\r\n    date.setHours(23, 59, 59, 999)\r\n    return date\r\n  })\r\n\r\n  useEffect(() => {\r\n    // Check if user is owner\r\n    if (typeof window !== 'undefined') {\r\n      const role = localStorage.getItem('userRole')\r\n      if (role !== 'OWNER') {\r\n        router.push('/reports')\r\n        return\r\n      }\r\n    }\r\n    fetchStationData()\r\n  }, [router])\r\n\r\n  const fetchStationData = async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n\r\n      const startDateStr = startDate.toISOString().split('T')[0]\r\n      const endDateStr = endDate.toISOString().split('T')[0]\r\n\r\n      console.log('Fetching station data for:', { startDate: startDateStr, endDate: endDateStr })\r\n\r\n      const response = await fetch(\r\n        `/api/reports/station-comparison?startDate=${startDateStr}&endDate=${endDateStr}`\r\n      )\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({}))\r\n        throw new Error(errorData.details || errorData.error || 'Failed to fetch data')\r\n      }\r\n\r\n      const data = await response.json()\r\n      console.log('Received station data:', data)\r\n      setStations(data)\r\n      setError(null)\r\n    } catch (error) {\r\n      console.error('Failed to fetch station data:', error)\r\n      setError(error instanceof Error ? error.message : 'Failed to load report data')\r\n      setStations([])\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleApplyFilters = () => {\r\n    fetchStationData()\r\n  }\r\n\r\n  const handleExportPDF = () => {\r\n    if (stations.length === 0) {\r\n      alert('No data to export')\r\n      return\r\n    }\r\n\r\n    const doc = new jsPDF()\r\n\r\n    // Add title\r\n    doc.setFontSize(18)\r\n    doc.text('Station Comparison Report', 14, 20)\r\n\r\n    // Add date range\r\n    doc.setFontSize(11)\r\n    doc.text(`Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`, 14, 28)\r\n    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 34)\r\n\r\n    // Calculate totals\r\n    const totals = stations.reduce((acc, station) => ({\r\n      totalSales: acc.totalSales + station.totalSales,\r\n      totalVolume: acc.totalVolume + station.totalVolume,\r\n      totalProfit: acc.totalProfit + station.totalProfit,\r\n      avgDailySales: acc.avgDailySales + station.avgDailySales,\r\n      shiftsCount: acc.shiftsCount + station.shiftsCount\r\n    }), { totalSales: 0, totalVolume: 0, totalProfit: 0, avgDailySales: 0, shiftsCount: 0 })\r\n\r\n    // Add summary section\r\n    doc.setFontSize(12)\r\n    doc.text('Summary', 14, 44)\r\n    doc.setFontSize(10)\r\n    doc.text(`Total Stations: ${stations.length}`, 14, 50)\r\n    doc.text(`Total Sales: Rs. ${totals.totalSales.toLocaleString()}`, 14, 56)\r\n    doc.text(`Total Volume: ${totals.totalVolume.toLocaleString()} L`, 14, 62)\r\n    doc.text(`Total Profit: Rs. ${totals.totalProfit.toLocaleString()}`, 14, 68)\r\n\r\n    // Prepare table data\r\n    const tableData = stations.map(station => [\r\n      station.name,\r\n      `Rs. ${station.totalSales.toLocaleString()}`,\r\n      `${station.totalVolume.toLocaleString()} L`,\r\n      `Rs. ${station.totalProfit.toLocaleString()}`,\r\n      `Rs. ${station.avgDailySales.toLocaleString()}`,\r\n      station.pumperCount.toString(),\r\n      station.shiftsCount.toString(),\r\n      `${station.profitMargin.toFixed(2)}%`\r\n    ])\r\n\r\n    // Add totals row\r\n    tableData.push([\r\n      'TOTAL',\r\n      `Rs. ${totals.totalSales.toLocaleString()}`,\r\n      `${totals.totalVolume.toLocaleString()} L`,\r\n      `Rs. ${totals.totalProfit.toLocaleString()}`,\r\n      `Rs. ${totals.avgDailySales.toLocaleString()}`,\r\n      '-',\r\n      totals.shiftsCount.toString(),\r\n      '-'\r\n    ])\r\n\r\n    // Add table\r\n    autoTable(doc, {\r\n      startY: 75,\r\n      head: [['Station', 'Total Sales', 'Volume', 'Profit', 'Avg Daily', 'Pumpers', 'Shifts', 'Margin %']],\r\n      body: tableData,\r\n      theme: 'striped',\r\n      headStyles: { fillColor: [59, 130, 246] },\r\n      footStyles: { fillColor: [229, 231, 235], textColor: [0, 0, 0], fontStyle: 'bold' },\r\n      styles: { fontSize: 9 }\r\n    })\r\n\r\n    // Save PDF\r\n    const startDateStr = startDate.toISOString().split('T')[0]\r\n    const endDateStr = endDate.toISOString().split('T')[0]\r\n    doc.save(`Station_Comparison_${startDateStr}_to_${endDateStr}.pdf`)\r\n  }\r\n\r\n  const handleExportExcel = () => {\r\n    if (stations.length === 0) {\r\n      alert('No data to export')\r\n      return\r\n    }\r\n\r\n    // Calculate totals\r\n    const totals = stations.reduce((acc, station) => ({\r\n      totalSales: acc.totalSales + station.totalSales,\r\n      totalVolume: acc.totalVolume + station.totalVolume,\r\n      totalProfit: acc.totalProfit + station.totalProfit,\r\n      avgDailySales: acc.avgDailySales + station.avgDailySales,\r\n      shiftsCount: acc.shiftsCount + station.shiftsCount\r\n    }), { totalSales: 0, totalVolume: 0, totalProfit: 0, avgDailySales: 0, shiftsCount: 0 })\r\n\r\n    // Prepare data for Excel\r\n    const excelData = [\r\n      ['Station Comparison Report'],\r\n      [`Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`],\r\n      [`Generated: ${new Date().toLocaleString()}`],\r\n      [],\r\n      ['Summary'],\r\n      [`Total Stations: ${stations.length}`],\r\n      [`Total Sales: Rs. ${totals.totalSales.toLocaleString()}`],\r\n      [`Total Volume: ${totals.totalVolume.toLocaleString()} L`],\r\n      [`Total Profit: Rs. ${totals.totalProfit.toLocaleString()}`],\r\n      [],\r\n      ['Station', 'Total Sales (Rs.)', 'Volume (L)', 'Profit (Rs.)', 'Avg Daily Sales (Rs.)', 'Pumpers', 'Shifts', 'Profit Margin (%)'],\r\n      ...stations.map(station => [\r\n        station.name,\r\n        station.totalSales,\r\n        station.totalVolume,\r\n        station.totalProfit,\r\n        station.avgDailySales,\r\n        station.pumperCount,\r\n        station.shiftsCount,\r\n        station.profitMargin\r\n      ]),\r\n      [\r\n        'TOTAL',\r\n        totals.totalSales,\r\n        totals.totalVolume,\r\n        totals.totalProfit,\r\n        totals.avgDailySales,\r\n        '',\r\n        totals.shiftsCount,\r\n        ''\r\n      ]\r\n    ]\r\n\r\n    // Create workbook and worksheet\r\n    const ws = XLSX.utils.aoa_to_sheet(excelData)\r\n    const wb = XLSX.utils.book_new()\r\n    XLSX.utils.book_append_sheet(wb, ws, 'Station Comparison')\r\n\r\n    // Auto-size columns\r\n    const colWidths = [\r\n      { wch: 20 }, // Station\r\n      { wch: 18 }, // Total Sales\r\n      { wch: 15 }, // Volume\r\n      { wch: 18 }, // Profit\r\n      { wch: 20 }, // Avg Daily\r\n      { wch: 10 }, // Pumpers\r\n      { wch: 10 }, // Shifts\r\n      { wch: 18 }  // Margin\r\n    ]\r\n    ws['!cols'] = colWidths\r\n\r\n    // Save Excel file\r\n    const startDateStr = startDate.toISOString().split('T')[0]\r\n    const endDateStr = endDate.toISOString().split('T')[0]\r\n    XLSX.writeFile(wb, `Station_Comparison_${startDateStr}_to_${endDateStr}.xlsx`)\r\n  }\r\n\r\n  const bestPerformer = stations.length > 0\r\n    ? stations.reduce((best, station) => station.totalSales > best.totalSales ? station : best, stations[0])\r\n    : null\r\n\r\n  const totalAcrossStations = {\r\n    sales: stations.reduce((sum, s) => sum + s.totalSales, 0),\r\n    volume: stations.reduce((sum, s) => sum + s.totalVolume, 0),\r\n    profit: stations.reduce((sum, s) => sum + s.totalProfit, 0)\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6 p-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <Button variant=\"outline\" size=\"icon\" onClick={() => router.back()}>\r\n            <ArrowLeft className=\"h-4 w-4\" />\r\n          </Button>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-foreground\">Station Comparison Report</h1>\r\n            <p className=\"text-muted-foreground mt-1\">\r\n              Compare performance metrics across all stations\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <Badge variant=\"default\" className=\"bg-indigo-600\">Owner Only</Badge>\r\n      </div>\r\n\r\n      {/* Error Display */}\r\n      {error && (\r\n        <Card className=\"bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-800\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <AlertCircle className=\"h-5 w-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5\" />\r\n              <div className=\"text-sm text-red-900 dark:text-red-100\">\r\n                <p className=\"font-semibold mb-1\">Error Loading Report:</p>\r\n                <p>{error}</p>\r\n                <Button\r\n                  onClick={fetchStationData}\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  className=\"mt-2\"\r\n                >\r\n                  <RefreshCw className=\"mr-2 h-4 w-4\" />\r\n                  Retry\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Filters Section */}\r\n      <FormCard title=\"Filters & Date Range\">\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n          <div className=\"space-y-1\">\r\n            <Label className=\"text-sm font-semibold\">Start Date</Label>\r\n            <DateTimePicker\r\n              value={startDate}\r\n              onChange={(date) => {\r\n                if (date) {\r\n                  date.setHours(0, 0, 0, 0)\r\n                  setStartDate(date)\r\n                  console.log('Start date changed to:', date)\r\n                }\r\n              }}\r\n              placeholder=\"Select start date\"\r\n              showTime={false}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-1\">\r\n            <Label className=\"text-sm font-semibold\">End Date</Label>\r\n            <DateTimePicker\r\n              value={endDate}\r\n              onChange={(date) => {\r\n                if (date) {\r\n                  date.setHours(23, 59, 59, 999)\r\n                  setEndDate(date)\r\n                  console.log('End date changed to:', date)\r\n                }\r\n              }}\r\n              placeholder=\"Select end date\"\r\n              showTime={false}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"flex items-end\">\r\n            <Button\r\n              onClick={handleApplyFilters}\r\n              className=\"w-full\"\r\n              disabled={loading}\r\n            >\r\n              <RefreshCw className={`mr-2 h-4 w-4 ${loading ? 'animate-spin' : ''}`} />\r\n              {loading ? 'Loading...' : 'Apply Filters'}\r\n            </Button>\r\n          </div>\r\n\r\n          <div className=\"flex items-end\">\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"w-full\"\r\n                  disabled={stations.length === 0}\r\n                >\r\n                  <Download className=\"mr-2 h-4 w-4\" />\r\n                  Export Report\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent align=\"end\" className=\"w-48\">\r\n                <DropdownMenuItem onClick={handleExportPDF} className=\"cursor-pointer\">\r\n                  <FileText className=\"mr-2 h-4 w-4 text-red-600\" />\r\n                  <span>Export as PDF</span>\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={handleExportExcel} className=\"cursor-pointer\">\r\n                  <FileSpreadsheet className=\"mr-2 h-4 w-4 text-green-600\" />\r\n                  <span>Export as Excel</span>\r\n                </DropdownMenuItem>\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n          </div>\r\n        </div>\r\n        <p className=\"text-xs text-muted-foreground mt-3\">\r\n           Showing data from <span className=\"font-semibold\">{startDate.toLocaleDateString()}</span> to <span className=\"font-semibold\">{endDate.toLocaleDateString()}</span>\r\n        </p>\r\n      </FormCard>\r\n\r\n      {/* Summary Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Total Stations</p>\r\n                <p className=\"text-2xl font-bold\">{stations.length}</p>\r\n              </div>\r\n              <Building2 className=\"h-8 w-8 text-blue-600 dark:text-blue-400\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Total Sales</p>\r\n                <p className=\"text-2xl font-bold\">Rs. {totalAcrossStations.sales.toLocaleString()}</p>\r\n              </div>\r\n              <DollarSign className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Total Volume</p>\r\n                <p className=\"text-2xl font-bold\">{totalAcrossStations.volume.toLocaleString()} L</p>\r\n              </div>\r\n              <Fuel className=\"h-8 w-8 text-orange-600 dark:text-orange-400\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Total Profit</p>\r\n                <p className=\"text-2xl font-bold\">Rs. {totalAcrossStations.profit.toLocaleString()}</p>\r\n              </div>\r\n              <TrendingUp className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Best Performer */}\r\n      {bestPerformer && (\r\n        <Card className=\"bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-950/20 dark:to-emerald-950/20 border-green-200 dark:border-green-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2 text-green-700 dark:text-green-400\">\r\n              <Award className=\"h-5 w-5\" />\r\n              Best Performing Station\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-2xl font-bold text-green-900 dark:text-green-100\">{bestPerformer.name}</p>\r\n                <p className=\"text-sm text-green-700 dark:text-green-300 mt-1\">\r\n                  Total Sales: Rs. {bestPerformer.totalSales.toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <Badge className=\"bg-green-600 text-white\">Top Performer</Badge>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Station Comparison Table */}\r\n      <FormCard title=\"Station Performance Comparison\">\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center py-12\">\r\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\r\n          </div>\r\n        ) : stations.length === 0 ? (\r\n          <div className=\"text-center py-12 text-muted-foreground\">\r\n            <Building2 className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\r\n            <p>No station data available</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"border-b\">\r\n                  <th className=\"text-left p-3 font-semibold\">Station</th>\r\n                  <th className=\"text-right p-3 font-semibold\">Total Sales</th>\r\n                  <th className=\"text-right p-3 font-semibold\">Volume (L)</th>\r\n                  <th className=\"text-right p-3 font-semibold\">Profit</th>\r\n                  <th className=\"text-right p-3 font-semibold\">Avg Daily Sales</th>\r\n                  <th className=\"text-center p-3 font-semibold\">Pumpers</th>\r\n                  <th className=\"text-center p-3 font-semibold\">Shifts</th>\r\n                  <th className=\"text-right p-3 font-semibold\">Profit Margin</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {stations.map((station, index) => (\r\n                  <tr key={station.id} className={`border-b ${index % 2 === 0 ? 'bg-muted/50' : ''}`}>\r\n                    <td className=\"p-3 font-medium\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Building2 className=\"h-4 w-4 text-muted-foreground\" />\r\n                        {station.name}\r\n                        {station.id === bestPerformer?.id && (\r\n                          <Award className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"p-3 text-right\">\r\n                      Rs. {station.totalSales.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"p-3 text-right\">\r\n                      {station.totalVolume.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"p-3 text-right text-green-600 dark:text-green-400\">\r\n                      Rs. {station.totalProfit.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"p-3 text-right\">\r\n                      Rs. {station.avgDailySales.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"p-3 text-center\">\r\n                      <Badge variant=\"outline\">{station.pumperCount}</Badge>\r\n                    </td>\r\n                    <td className=\"p-3 text-center\">\r\n                      <Badge variant=\"outline\">{station.shiftsCount}</Badge>\r\n                    </td>\r\n                    <td className=\"p-3 text-right\">\r\n                      <div className=\"flex items-center justify-end gap-1\">\r\n                        <span className=\"\">{station.profitMargin}%</span>\r\n                        {station.profitMargin >= 10 ? (\r\n                          <TrendingUp className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\r\n                        ) : (\r\n                          <TrendingDown className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\r\n                        )}\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n              <tfoot>\r\n                <tr className=\"border-t-2 font-bold bg-muted\">\r\n                  <td className=\"p-3\">TOTAL</td>\r\n                  <td className=\"p-3 text-right\">\r\n                    Rs. {totalAcrossStations.sales.toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right\">\r\n                    {totalAcrossStations.volume.toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right text-green-600 dark:text-green-400\">\r\n                    Rs. {totalAcrossStations.profit.toLocaleString()}\r\n                  </td>\r\n                  <td colSpan={4}></td>\r\n                </tr>\r\n              </tfoot>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </FormCard>\r\n\r\n      {/* Info Box */}\r\n      <Card className=\"bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800\">\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"flex items-start gap-3\">\r\n            <AlertCircle className=\"h-5 w-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5\" />\r\n            <div className=\"text-sm text-blue-900 dark:text-blue-100\">\r\n              <p className=\"font-semibold mb-1\">About This Report:</p>\r\n              <ul className=\"list-disc list-inside space-y-1\">\r\n                <li>Shows real-time data from your database</li>\r\n                <li>Compares all active stations in the selected date range</li>\r\n                <li>Includes only CLOSED shifts for accurate reporting</li>\r\n                <li>Profit = Total Sales - Total Expenses</li>\r\n                <li>Use filters above to customize the date range</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\reports\\tanks\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":23,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingDown' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BarChart3' is defined but never used.","line":35,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowUp' is defined but never used.","line":37,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowDown' is defined but never used.","line":38,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":163,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":163,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'station' is assigned a value but never used.","line":197,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":197,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":279,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":279,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Building2,\n  Calendar,\n  Fuel,\n  TrendingUp,\n  TrendingDown,\n  AlertCircle,\n  Download,\n  FileText,\n  Calculator,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  Droplets,\n  Package,\n  ShoppingCart,\n  BarChart3,\n  Activity,\n  ArrowUp,\n  ArrowDown,\n  Clock,\n  Truck\n} from 'lucide-react'\nimport { exportTankReportPDF } from '@/lib/exportUtils'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface DeliveryDetail {\n  id: string\n  deliveryNumber: string\n  supplier: string\n  quantity: number\n  deliveryTime: string\n  invoiceNumber?: string\n  driverName?: string\n}\n\ninterface TestPourDetail {\n  id: string\n  nozzleNumber: string\n  pumpNumber: string\n  amount: number\n  returned: boolean\n  time: string\n  performedBy: string\n}\n\ninterface TankMovement {\n  id: string\n  tankId: string\n  tankNumber: string\n  tankName: string\n  fuelName: string\n  capacity: number\n  date: string\n\n  // Opening balances\n  openingDip: number\n  openingBook: number\n  openingPercentage: number\n\n  // Movements\n  deliveries: number\n  deliveryCount: number\n  deliveryDetails: DeliveryDetail[]\n  sales: number\n  salesTransactionCount: number\n  testReturns: number\n  testPourDetails: TestPourDetail[]\n  adjustments: number\n\n  // Closing balances\n  closingBook: number\n  closingDip: number\n  closingPercentage: number\n\n  // Variance analysis\n  variance: number\n  variancePercentage: number\n  varianceStatus: 'WITHIN_TOLERANCE' | 'NEEDS_REVIEW' | 'CRITICAL'\n\n  // Additional metrics\n  averageDailySales: number\n  daysUntilEmpty: number\n  lastDeliveryDate?: string\n  lastDeliveryQuantity?: number\n  recommendedDeliveryDate?: string\n}\n\ninterface TankReportSummary {\n  totalTanks: number\n  totalCapacity: number\n  totalOpeningStock: number\n  totalDeliveries: number\n  totalSales: number\n  totalTestReturns: number\n  totalClosingStock: number\n  totalVariance: number\n  averageVariancePercentage: number\n  tanksWithinTolerance: number\n  tanksNeedingReview: number\n  criticalTanks: number\n  lowFillTanks: number\n  tanksNeedingDelivery: number\n}\n\ninterface TankApiResponse {\n  tankId: string\n  tankNumber: string\n  fuel?: { name: string }\n  capacity: number\n  openingStock: number\n  closingBookStock: number\n  closingDipStock: number\n  deliveries: number\n  sales: number\n  testReturns: number\n  variance: number\n  variancePercentage: number\n  toleranceStatus: 'NORMAL' | 'WARNING' | 'CRITICAL'\n}\n\nexport default function TanksReportsPage() {\n  const [stations, setStations] = useState<Station[]>([])\n  const [tankMovements, setTankMovements] = useState<TankMovement[]>([])\n  const [summary, setSummary] = useState<TankReportSummary | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0])\n\n  // Load initial data\n  useEffect(() => {\n    const loadStations = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (_err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadStations()\n  }, [])\n\n  const generateReport = async () => {\n    if (!selectedStation || !selectedDate) {\n      setError('Please select both station and date')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call API endpoint to get real tank report data\n      const url = `/api/tanks/report?stationId=${selectedStation}&date=${selectedDate}`\n\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n        cache: 'no-store'\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error((errorData as { error?: string }).error || `Failed to fetch tank report: ${response.status}`)\n      }\n\n      const reportData = await response.json()\n\n      const station = stations.find(s => s.id === selectedStation)\n\n      // Transform API data to match frontend interface\n      const tankMovements: TankMovement[] = (reportData.tanks || []).map((tank: TankApiResponse, idx: number) => {\n        const openingStock = tank.openingStock || 0\n        const closingBookStock = tank.closingBookStock || 0\n        const closingDipStock = tank.closingDipStock || 0\n        const capacity = tank.capacity || 10000\n\n        return {\n          id: tank.tankId || `tank-${idx}`,\n          tankId: tank.tankId,\n          tankNumber: tank.tankNumber || `T-${String(idx + 1).padStart(3, '0')}`,\n          tankName: `Tank ${tank.tankNumber || idx + 1}`,\n          fuelName: tank.fuel?.name || 'UNKNOWN',\n          capacity,\n          date: selectedDate,\n          openingDip: closingDipStock, // Use closing dip as approximation for opening (API limitation)\n          openingBook: openingStock,\n          openingPercentage: capacity > 0 ? (openingStock / capacity) * 100 : 0,\n          deliveries: tank.deliveries || 0,\n          deliveryCount: 0, // Would need to fetch deliveries separately\n          deliveryDetails: [],\n          sales: tank.sales || 0,\n          salesTransactionCount: 0,\n          testReturns: tank.testReturns || 0,\n          testPourDetails: [],\n          adjustments: 0,\n          closingBook: closingBookStock,\n          closingDip: closingDipStock,\n          closingPercentage: capacity > 0 ? (closingBookStock / capacity) * 100 : 0,\n          variance: tank.variance || 0,\n          variancePercentage: tank.variancePercentage || 0,\n          varianceStatus: (tank.toleranceStatus === 'NORMAL' ? 'WITHIN_TOLERANCE' :\n            tank.toleranceStatus === 'WARNING' ? 'NEEDS_REVIEW' :\n              tank.toleranceStatus === 'CRITICAL' ? 'CRITICAL' : 'NORMAL') as TankMovement['varianceStatus'],\n          averageDailySales: tank.sales || 0,\n          daysUntilEmpty: (tank.sales || 0) > 0 ? (closingBookStock / tank.sales) : 0,\n          lastDeliveryDate: selectedDate,\n          lastDeliveryQuantity: tank.deliveries || 0,\n          recommendedDeliveryDate: new Date(new Date(selectedDate).getTime() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n        }\n      })\n\n      // Calculate summary statistics from real data\n      const totalTanks = tankMovements.length\n      const totalCapacity = tankMovements.reduce((sum, t) => sum + t.capacity, 0)\n      const totalOpeningStock = tankMovements.reduce((sum, t) => sum + t.openingDip, 0)\n      const totalDeliveries = tankMovements.reduce((sum, t) => sum + t.deliveries, 0)\n      const totalSales = tankMovements.reduce((sum, t) => sum + t.sales, 0)\n      const totalTestReturns = tankMovements.reduce((sum, t) => sum + t.testReturns, 0)\n      const totalClosingStock = tankMovements.reduce((sum, t) => sum + t.closingDip, 0)\n      const totalVariance = tankMovements.reduce((sum, t) => sum + Math.abs(t.variance), 0)\n      const averageVariancePercentage = tankMovements.length > 0\n        ? tankMovements.reduce((sum, t) => sum + Math.abs(t.variancePercentage), 0) / tankMovements.length\n        : 0\n      const tanksWithinTolerance = tankMovements.filter(t => t.varianceStatus === 'WITHIN_TOLERANCE').length\n      const tanksNeedingReview = tankMovements.filter(t => t.varianceStatus === 'NEEDS_REVIEW').length\n      const criticalTanks = tankMovements.filter(t => t.varianceStatus === 'CRITICAL').length\n      const lowFillTanks = tankMovements.filter(t => t.closingPercentage < 30).length\n      const tanksNeedingDelivery = tankMovements.filter(t => t.closingPercentage < 20 || t.daysUntilEmpty < 2).length\n\n      const reportSummary: TankReportSummary = {\n        totalTanks,\n        totalCapacity,\n        totalOpeningStock,\n        totalDeliveries,\n        totalSales,\n        totalTestReturns,\n        totalClosingStock,\n        totalVariance,\n        averageVariancePercentage,\n        tanksWithinTolerance,\n        tanksNeedingReview,\n        criticalTanks,\n        lowFillTanks,\n        tanksNeedingDelivery\n      }\n\n      setTankMovements(tankMovements)\n      setSummary(reportSummary)\n\n    } catch (_err) {\n      setError('Failed to generate tank movement report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const exportToPDF = () => {\n    if (!selectedStation || tankMovements.length === 0) {\n      alert('Please select a station and generate a report first')\n      return\n    }\n\n    const station = stations.find(s => s.id === selectedStation)\n    const stationName = station?.name || 'Unknown Station'\n    const dateStr = selectedDate\n\n    const exportData = tankMovements.map(tm => ({\n      ...tm,\n      openingStock: tm.openingBook, // Using book stock as primary opening stock\n      status: tm.varianceStatus\n    }))\n\n    exportTankReportPDF(exportData, stationName, dateStr)\n  }\n\n  const getVarianceColor = (percentage: number) => {\n    if (Math.abs(percentage) <= 1.0) return 'text-green-600 dark:text-green-400'\n    if (Math.abs(percentage) <= 3.0) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-red-600 dark:text-red-400'\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'WITHIN_TOLERANCE': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'NEEDS_REVIEW': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'CRITICAL': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'WITHIN_TOLERANCE': return <CheckCircle className=\"h-4 w-4\" />\n      case 'NEEDS_REVIEW': return <AlertTriangle className=\"h-4 w-4\" />\n      case 'CRITICAL': return <XCircle className=\"h-4 w-4\" />\n      default: return <AlertCircle className=\"h-4 w-4\" />\n    }\n  }\n\n  const getFillColor = (percentage: number) => {\n    if (percentage >= 80) return 'text-green-600 dark:text-green-400'\n    if (percentage >= 30) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-red-600 dark:text-red-400'\n  }\n\n  const getFillBarColor = (percentage: number) => {\n    if (percentage >= 80) return 'bg-green-500'\n    if (percentage >= 30) return 'bg-yellow-500'\n    return 'bg-red-500'\n  }\n\n  // Main tank columns\n  const tankColumns: Column<TankMovement>[] = [\n    {\n      key: 'tankName' as keyof TankMovement,\n      title: 'Tank',\n      render: (value: unknown, row: TankMovement) => (\n        <div className=\"flex items-center gap-2\">\n          <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            <div className=\"text-xs text-muted-foreground\">{row.tankNumber}  {row.fuelName}</div>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'capacity' as keyof TankMovement,\n      title: 'Capacity',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{(value as number)?.toLocaleString() || 0}L</span>\n      )\n    },\n    {\n      key: 'openingDip' as keyof TankMovement,\n      title: 'Opening Stock',\n      render: (value: unknown, row: TankMovement) => (\n        <div>\n          <div className=\"text-sm font-semibold\">{(value as number)?.toLocaleString() || 0}L</div>\n          <div className=\"text-xs text-muted-foreground\">\n            Book: {row.openingBook?.toLocaleString() || 0}L\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.openingPercentage?.toFixed(1) || 0}%\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'deliveries' as keyof TankMovement,\n      title: 'Deliveries',\n      render: (value: unknown, row: TankMovement) => (\n        <div>\n          <div className=\"font-semibold text-green-600 dark:text-green-400\">\n            +{(value as number)?.toLocaleString() || 0}L\n          </div>\n          {row.deliveryCount > 0 && (\n            <div className=\"text-xs text-muted-foreground\">\n              {row.deliveryCount} delivery{row.deliveryCount > 1 ? 's' : ''}\n            </div>\n          )}\n        </div>\n      )\n    },\n    {\n      key: 'sales' as keyof TankMovement,\n      title: 'Sales',\n      render: (value: unknown, row: TankMovement) => (\n        <div>\n          <div className=\"font-semibold text-red-600 dark:text-red-400\">\n            -{(value as number)?.toLocaleString() || 0}L\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.salesTransactionCount} transactions\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'testReturns' as keyof TankMovement,\n      title: 'Test Returns',\n      render: (value: unknown) => (\n        <div className=\"font-semibold text-blue-600 dark:text-blue-400\">\n          +{(value as number)?.toLocaleString() || 0}L\n        </div>\n      )\n    },\n    {\n      key: 'closingDip' as keyof TankMovement,\n      title: 'Closing Stock',\n      render: (value: unknown, row: TankMovement) => (\n        <div>\n          <div className=\"text-sm font-semibold\">{(value as number)?.toLocaleString() || 0}L</div>\n          <div className=\"text-xs text-muted-foreground\">\n            Book: {row.closingBook?.toLocaleString() || 0}L\n          </div>\n          <div className=\"text-xs text-muted-foreground\">\n            {row.closingPercentage?.toFixed(1) || 0}%\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'variance' as keyof TankMovement,\n      title: 'Variance',\n      render: (value: unknown, row: TankMovement) => (\n        <div>\n          <div className={`font-semibold ${getVarianceColor(row.variancePercentage)}`}>\n            {(value as number) >= 0 ? '+' : ''}{(value as number)?.toLocaleString() || 0}L\n          </div>\n          <div className={`text-xs ${getVarianceColor(row.variancePercentage)}`}>\n            {row.variancePercentage >= 0 ? '+' : ''}{row.variancePercentage.toFixed(2)}%\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'closingPercentage' as keyof TankMovement,\n      title: 'Fill Level',\n      render: (value: unknown, row: TankMovement) => {\n        const percentage = value as number\n        return (\n          <div className=\"min-w-[100px]\">\n            <div className={`font-semibold mb-1 ${getFillColor(percentage)}`}>\n              {percentage?.toFixed(1) || 0}%\n            </div>\n            <div className=\"w-full bg-muted rounded-full h-2\">\n              <div\n                className={`h-2 rounded-full ${getFillBarColor(percentage)}`}\n                style={{ width: `${Math.min(100, Math.max(0, percentage))}%` }}\n              ></div>\n            </div>\n            {row.daysUntilEmpty && (\n              <div className=\"text-xs text-muted-foreground mt-1\">\n                ~{row.daysUntilEmpty.toFixed(1)} days left\n              </div>\n            )}\n          </div>\n        )\n      }\n    },\n    {\n      key: 'varianceStatus' as keyof TankMovement,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          <div className=\"flex items-center gap-1\">\n            {getStatusIcon(value as string)}\n            <span>{(value as string)?.replace('_', ' ') || 'Unknown'}</span>\n          </div>\n        </Badge>\n      )\n    }\n  ]\n\n  // Delivery detail columns\n  const deliveryColumns: Column<DeliveryDetail>[] = [\n    {\n      key: 'deliveryNumber' as keyof DeliveryDetail,\n      title: 'Delivery #',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'supplier' as keyof DeliveryDetail,\n      title: 'Supplier',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'quantity' as keyof DeliveryDetail,\n      title: 'Quantity',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-green-600\">\n          +{(value as number)?.toLocaleString() || 0}L\n        </span>\n      )\n    },\n    {\n      key: 'deliveryTime' as keyof DeliveryDetail,\n      title: 'Time',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">\n          {new Date(value as string).toLocaleTimeString()}\n        </span>\n      )\n    },\n    {\n      key: 'invoiceNumber' as keyof DeliveryDetail,\n      title: 'Invoice',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">{value as string || 'N/A'}</span>\n      )\n    },\n    {\n      key: 'driverName' as keyof DeliveryDetail,\n      title: 'Driver',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string || 'N/A'}</span>\n      )\n    }\n  ]\n\n  // Test pour detail columns\n  const testPourColumns: Column<TestPourDetail>[] = [\n    {\n      key: 'nozzleNumber' as keyof TestPourDetail,\n      title: 'Nozzle',\n      render: (value: unknown, row: TestPourDetail) => (\n        <div>\n          <div className=\"font-medium\">P-{row.pumpNumber} N-{value as string}</div>\n        </div>\n      )\n    },\n    {\n      key: 'amount' as keyof TestPourDetail,\n      title: 'Amount',\n      render: (value: unknown) => (\n        <span className=\"font-semibold text-blue-600\">\n          {(value as number)?.toLocaleString() || 0}L\n        </span>\n      )\n    },\n    {\n      key: 'returned' as keyof TestPourDetail,\n      title: 'Returned',\n      render: (value: unknown) => (\n        <Badge variant={value ? \"outline\" : \"destructive\"}>\n          {value ? 'Yes' : 'No'}\n        </Badge>\n      )\n    },\n    {\n      key: 'time' as keyof TestPourDetail,\n      title: 'Time',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">\n          {new Date(value as string).toLocaleTimeString()}\n        </span>\n      )\n    },\n    {\n      key: 'performedBy' as keyof TestPourDetail,\n      title: 'Performed By',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string}</span>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n            <Droplets className=\"h-8 w-8 text-blue-600 dark:text-blue-400\" />\n            Tank Movement & Variance Report\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Comprehensive daily tank inventory analysis with variance tracking\n          </p>\n        </div>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* Report Generator */}\n      <FormCard title=\"Generate Tank Report\" description=\"Select station and date to generate comprehensive tank movement report\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station *</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"date\">Date *</Label>\n            <input\n              id=\"date\"\n              type=\"date\"\n              value={selectedDate}\n              onChange={(e) => setSelectedDate(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !selectedStation || !selectedDate} className=\"w-full\">\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {summary && tankMovements.length > 0 && (\n        <div className=\"space-y-6\">\n          {/* Report Header */}\n          <Card className=\"border-2 border-primary\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"text-2xl flex items-center gap-2\">\n                    <FileText className=\"h-6 w-6\" />\n                    Tank Movement Report\n                  </CardTitle>\n                  <CardDescription className=\"mt-2 text-base\">\n                    {stations.find(s => s.id === selectedStation)?.name}  {new Date(selectedDate).toLocaleDateString('en-US', {\n                      weekday: 'long',\n                      year: 'numeric',\n                      month: 'long',\n                      day: 'numeric'\n                    })}\n                  </CardDescription>\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button variant=\"outline\" onClick={exportToPDF}>\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    PDF\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n          </Card>\n\n          {/* Key Metrics Summary */}\n          <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Droplets className=\"h-4 w-4 text-blue-600\" />\n                  Total Tanks\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-blue-600\">\n                  {summary.totalTanks}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {summary.totalCapacity.toLocaleString()}L capacity\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Package className=\"h-4 w-4 text-green-600\" />\n                  Total Deliveries\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-green-600\">\n                  {summary.totalDeliveries.toLocaleString()}L\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {tankMovements.filter(t => t.deliveryCount > 0).length} tanks\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <ShoppingCart className=\"h-4 w-4 text-red-600\" />\n                  Total Sales\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-red-600\">\n                  {summary.totalSales.toLocaleString()}L\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {tankMovements.reduce((sum, t) => sum + t.salesTransactionCount, 0)} transactions\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Activity className=\"h-4 w-4 text-purple-600\" />\n                  Total Variance\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-purple-600\">\n                  {summary.totalVariance.toLocaleString()}L\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Avg: {summary.averageVariancePercentage.toFixed(2)}%\n                </div>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                  <Droplets className=\"h-4 w-4 text-orange-600\" />\n                  Closing Stock\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-3xl font-bold text-orange-600\">\n                  {summary.totalClosingStock.toLocaleString()}L\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {((summary.totalClosingStock / summary.totalCapacity) * 100).toFixed(1)}% of capacity\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Status Summary */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card className=\"border-green-500/20 bg-green-500/5\">\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                  Within Tolerance\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-600\">\n                  {summary.tanksWithinTolerance}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {summary.totalTanks > 0 ? ((summary.tanksWithinTolerance / summary.totalTanks) * 100).toFixed(0) : 0}% of tanks\n                </div>\n              </CardContent>\n            </Card>\n            <Card className=\"border-yellow-500/20 bg-yellow-500/5\">\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\n                  Needs Review\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-yellow-600\">\n                  {summary.tanksNeedingReview}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Variance 1-3%\n                </div>\n              </CardContent>\n            </Card>\n            <Card className=\"border-red-500/20 bg-red-500/5\">\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <XCircle className=\"h-4 w-4 text-red-600\" />\n                  Critical\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-600\">\n                  {summary.criticalTanks}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Variance {'>'}3%\n                </div>\n              </CardContent>\n            </Card>\n            <Card className=\"border-orange-500/20 bg-orange-500/5\">\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <AlertCircle className=\"h-4 w-4 text-orange-600\" />\n                  Low Fill\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-orange-600\">\n                  {summary.lowFillTanks}\n                </div>\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  Below 30% capacity\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Tank Movement Table */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Fuel className=\"h-5 w-5\" />\n                Tank Movement & Variance Details\n              </CardTitle>\n              <CardDescription>Complete daily movement and variance analysis for all tanks</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <DataTable\n                data={tankMovements}\n                columns={tankColumns}\n                searchable={true}\n                searchPlaceholder=\"Search tanks...\"\n                pagination={false}\n                emptyMessage=\"No tank movement data available.\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Detailed Breakdowns by Tank */}\n          {tankMovements.map((tank) => (\n            <Card key={tank.id} className=\"border-l-4\" style={{ borderLeftColor: getFillBarColor(tank.closingPercentage) }}>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Fuel className=\"h-5 w-5\" />\n                      {tank.tankName} - {tank.fuelName}\n                    </CardTitle>\n                    <CardDescription>\n                      {tank.tankNumber}  Capacity: {tank.capacity.toLocaleString()}L\n                    </CardDescription>\n                  </div>\n                  <Badge className={getStatusColor(tank.varianceStatus)}>\n                    {getStatusIcon(tank.varianceStatus)}\n                    <span className=\"ml-1\">{tank.varianceStatus.replace('_', ' ')}</span>\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {/* Tank Level Visualization */}\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div className=\"p-4 bg-muted rounded-lg\">\n                    <div className=\"text-sm text-muted-foreground mb-2\">Opening Stock</div>\n                    <div className=\"text-2xl font-bold\">{tank.openingDip.toLocaleString()}L</div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">\n                      {tank.openingPercentage.toFixed(1)}%  Book: {tank.openingBook.toLocaleString()}L\n                    </div>\n                  </div>\n                  <div className=\"p-4 bg-muted rounded-lg\">\n                    <div className=\"text-sm text-muted-foreground mb-2\">Closing Stock</div>\n                    <div className=\"text-2xl font-bold\">{tank.closingDip.toLocaleString()}L</div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">\n                      {tank.closingPercentage.toFixed(1)}%  Book: {tank.closingBook.toLocaleString()}L\n                    </div>\n                  </div>\n                  <div className=\"p-4 bg-muted rounded-lg\">\n                    <div className=\"text-sm text-muted-foreground mb-2\">Variance</div>\n                    <div className={`text-2xl font-bold ${getVarianceColor(tank.variancePercentage)}`}>\n                      {tank.variance >= 0 ? '+' : ''}{tank.variance.toLocaleString()}L\n                    </div>\n                    <div className={`text-xs mt-1 ${getVarianceColor(tank.variancePercentage)}`}>\n                      {tank.variancePercentage >= 0 ? '+' : ''}{tank.variancePercentage.toFixed(2)}%\n                    </div>\n                  </div>\n                </div>\n\n                {/* Movements Summary */}\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div className=\"p-3 bg-green-500/10 rounded-lg border border-green-500/20\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <Truck className=\"h-4 w-4 text-green-600\" />\n                      <span className=\"text-sm font-medium\">Deliveries</span>\n                    </div>\n                    <div className=\"text-xl font-bold text-green-600\">\n                      +{tank.deliveries.toLocaleString()}L\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {tank.deliveryCount} delivery{tank.deliveryCount !== 1 ? 's' : ''}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-red-500/10 rounded-lg border border-red-500/20\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <ShoppingCart className=\"h-4 w-4 text-red-600\" />\n                      <span className=\"text-sm font-medium\">Sales</span>\n                    </div>\n                    <div className=\"text-xl font-bold text-red-600\">\n                      -{tank.sales.toLocaleString()}L\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {tank.salesTransactionCount} transactions\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-blue-500/10 rounded-lg border border-blue-500/20\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <Activity className=\"h-4 w-4 text-blue-600\" />\n                      <span className=\"text-sm font-medium\">Test Returns</span>\n                    </div>\n                    <div className=\"text-xl font-bold text-blue-600\">\n                      +{tank.testReturns.toLocaleString()}L\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {tank.testPourDetails.length} test{tank.testPourDetails.length !== 1 ? 's' : ''}\n                    </div>\n                  </div>\n                  <div className=\"p-3 bg-purple-500/10 rounded-lg border border-purple-500/20\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <Clock className=\"h-4 w-4 text-purple-600\" />\n                      <span className=\"text-sm font-medium\">Days Left</span>\n                    </div>\n                    <div className=\"text-xl font-bold text-purple-600\">\n                      {tank.daysUntilEmpty.toFixed(1)}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      Avg sales: {tank.averageDailySales.toLocaleString()}L/day\n                    </div>\n                  </div>\n                </div>\n\n                {/* Delivery Details */}\n                {tank.deliveryDetails.length > 0 && (\n                  <div>\n                    <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                      <Truck className=\"h-4 w-4\" />\n                      Delivery Details\n                    </h4>\n                    <DataTable\n                      data={tank.deliveryDetails}\n                      columns={deliveryColumns}\n                      pagination={false}\n                      searchable={false}\n                    />\n                  </div>\n                )}\n\n                {/* Test Pour Details */}\n                {tank.testPourDetails.length > 0 && (\n                  <div>\n                    <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                      <Activity className=\"h-4 w-4\" />\n                      Test Pour Details\n                    </h4>\n                    <DataTable\n                      data={tank.testPourDetails}\n                      columns={testPourColumns}\n                      pagination={false}\n                      searchable={false}\n                    />\n                  </div>\n                )}\n\n                {/* Recommendations */}\n                {tank.recommendedDeliveryDate && (\n                  <Alert>\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertTitle>Delivery Recommendation</AlertTitle>\n                    <AlertDescription>\n                      Recommended delivery date: <strong>{new Date(tank.recommendedDeliveryDate).toLocaleDateString()}</strong>\n                      {tank.lastDeliveryDate && (\n                        <>  Last delivery: {new Date(tank.lastDeliveryDate).toLocaleDateString()} ({tank.lastDeliveryQuantity?.toLocaleString()}L)</>\n                      )}\n                    </AlertDescription>\n                  </Alert>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n\n          {/* Critical Alerts */}\n          {summary.criticalTanks > 0 && (\n            <Alert variant=\"destructive\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Critical Variance Alert</AlertTitle>\n              <AlertDescription>\n                {summary.criticalTanks} tank{summary.criticalTanks > 1 ? 's have' : ' has'} critical variance levels exceeding 3%.\n                Immediate investigation and corrective action required.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {summary.lowFillTanks > 0 && (\n            <Alert>\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertTitle>Low Fill Level Warning</AlertTitle>\n              <AlertDescription>\n                {summary.lowFillTanks} tank{summary.lowFillTanks > 1 ? 's are' : ' is'} below 30% capacity.\n                Consider scheduling fuel deliveries to prevent stock-outs.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {summary.tanksNeedingDelivery > 0 && (\n            <Alert>\n              <Truck className=\"h-4 w-4\" />\n              <AlertTitle>Delivery Scheduling Required</AlertTitle>\n              <AlertDescription>\n                {summary.tanksNeedingDelivery} tank{summary.tanksNeedingDelivery > 1 ? 's require' : ' requires'} immediate delivery scheduling\n                (below 20% capacity or less than 2 days of stock remaining).\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\safe\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":262,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":262,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":442,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":442,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":508,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":508,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":554,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":554,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":669,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":669,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":745,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":745,"endColumn":17}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchPumpersAndBanks' and 'fetchSafe'. Either include them or remove the dependency array.","line":307,"column":6,"nodeType":"ArrayExpression","endLine":307,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchPumpersAndBanks, fetchSafe, selectedStation]","fix":{"range":[9338,9355],"text":"[fetchPumpersAndBanks, fetchSafe, selectedStation]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSafe'. Either include it or remove the dependency array.","line":346,"column":6,"nodeType":"ArrayExpression","endLine":346,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchSafe, selectedStation]","fix":{"range":[10431,10448],"text":"[fetchSafe, selectedStation]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { useToast } from '@/hooks/use-toast'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent } from '@/components/ui/card'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  Wallet,\n  Plus,\n  Minus,\n  DollarSign,\n  CreditCard,\n  FileText,\n  Clock,\n  ArrowUpRight,\n  ArrowDownRight,\n  Users,\n  ShoppingCart,\n  TrendingUp,\n  Building2,\n  Calendar,\n  AlertCircle,\n  ArrowUpCircle\n} from 'lucide-react'\n\ninterface Safe {\n  id: string\n  stationId: string\n  openingBalance: number\n  currentBalance: number\n  lastCounted?: string\n  countedBy?: string\n}\n\ninterface SafeTransaction {\n  id: string\n  type: string\n  amount: number\n  balanceBefore: number\n  balanceAfter: number\n  description: string\n  performedBy: string\n  timestamp: string\n  shiftId?: string\n  batchId?: string\n  expenseId?: string\n  loanId?: string\n  shift?: {\n    id: string\n    template?: {\n      name: string\n    }\n    assignments?: Array<{\n      pumper?: {\n        name: string\n      }\n      pumperName?: string\n    }>\n    declaredAmounts?: {\n      cash?: number\n      card?: number\n      credit?: number\n      cheque?: number\n      total?: number\n      pumperBreakdown?: Array<{\n        pumperName: string\n        calculatedSales: number\n        declaredAmount: number\n        declaredCash: number\n        declaredCardAmounts: Record<string, number>\n        declaredCreditAmounts: Record<string, number>\n        declaredCheque: number\n        cheques: Array<{\n          chequeNumber: string\n          amount: number\n          receivedFrom: string\n          bankName?: string\n        }>\n        advanceTaken: number\n        expenses: Array<{\n          type: string\n          amount: number\n          description?: string\n          bankName?: string\n          loanGivenToName?: string\n        }>\n        variance: number\n        varianceStatus: string\n      }>\n    }\n  }\n  batch?: {\n    id: string\n    totalAmount: number\n    terminalEntries?: Array<{\n      id: string\n      terminal: {\n        id: string\n        name: string\n        terminalNumber: string\n        bank?: {\n          name: string\n        }\n      }\n      startNumber: string\n      endNumber: string\n      transactionCount: number\n      visaAmount: number\n      masterAmount: number\n      amexAmount: number\n      qrAmount: number\n      dialogTouchAmount: number\n    }>\n  }\n  cheque?: {\n    id: string\n    chequeNumber: string\n    amount: number\n    bank?: {\n      name: string\n    }\n  }\n}\n\ninterface GroupedTransaction extends SafeTransaction {\n  isGrouped: boolean\n  breakdown?: {\n    cash: number\n    card: number\n    credit: number\n    cheque: number\n    total: number\n  }\n  transactions?: SafeTransaction[]\n}\n\n\nconst INCOME_TYPES = [\n  'CASH_FUEL_SALES',\n  'POS_CARD_PAYMENT',\n  'CREDIT_PAYMENT',\n  'CHEQUE_RECEIVED',\n  'LOAN_REPAID',\n  'OPENING_BALANCE'\n]\n\n// Group transactions by shift closure\nfunction groupTransactionsByShift(transactions: SafeTransaction[]): (SafeTransaction | GroupedTransaction)[] {\n  const shiftGroups = new Map<string, SafeTransaction[]>()\n  const standalone: SafeTransaction[] = []\n\n  // Separate shift transactions from standalone transactions\n  transactions.forEach(tx => {\n    if (tx.shiftId) {\n      if (!shiftGroups.has(tx.shiftId)) {\n        shiftGroups.set(tx.shiftId, [])\n      }\n      shiftGroups.get(tx.shiftId)!.push(tx)\n    } else {\n      standalone.push(tx)\n    }\n  })\n\n  // Create grouped entries for shift closures\n  const grouped: (SafeTransaction | GroupedTransaction)[] = []\n\n  shiftGroups.forEach((shiftTxs, shiftId) => {\n    // Sort by timestamp to get the first transaction (for display)\n    shiftTxs.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime())\n    const firstTx = shiftTxs[0]\n\n    // Get shift info from first transaction\n    const shift = firstTx.shift\n    const declaredAmounts = shift?.declaredAmounts\n\n    // Use shift's declaredAmounts if available (more reliable), otherwise calculate from transactions\n    let cashAmount = 0\n    let cardAmount = 0\n    let creditAmount = 0\n    let chequeAmount = 0\n    let totalAmount = 0\n\n    if (declaredAmounts) {\n      // Use declared amounts from shift (most accurate)\n      cashAmount = declaredAmounts.cash || 0\n      cardAmount = declaredAmounts.card || 0\n      creditAmount = declaredAmounts.credit || 0\n      chequeAmount = declaredAmounts.cheque || 0\n      totalAmount = declaredAmounts.total || (cashAmount + cardAmount + creditAmount + chequeAmount)\n    } else {\n      // Fallback: Calculate from transactions\n      totalAmount = shiftTxs.reduce((sum, tx) => sum + tx.amount, 0)\n      cashAmount = shiftTxs.find(tx => tx.type === 'CASH_FUEL_SALES')?.amount || 0\n      cardAmount = shiftTxs.find(tx => tx.type === 'POS_CARD_PAYMENT')?.amount || 0\n      creditAmount = shiftTxs.find(tx => tx.type === 'CREDIT_PAYMENT')?.amount || 0\n      chequeAmount = shiftTxs.filter(tx => tx.type === 'CHEQUE_RECEIVED').reduce((sum, tx) => sum + tx.amount, 0)\n    }\n\n    const shiftName = shift?.template?.name || 'Shift'\n\n    grouped.push({\n      id: `shift-${shiftId}`,\n      type: 'SHIFT_CLOSURE',\n      timestamp: firstTx.timestamp,\n      amount: totalAmount, // Total amount from shift closure\n      balanceBefore: firstTx.balanceBefore,\n      balanceAfter: shiftTxs[shiftTxs.length - 1].balanceAfter, // Last transaction's balance\n      performedBy: firstTx.performedBy,\n      description: `Shift Closure: ${shiftName}`,\n      shiftId,\n      shift,\n      breakdown: {\n        cash: cashAmount,\n        card: cardAmount,\n        credit: creditAmount,\n        cheque: chequeAmount,\n        total: totalAmount\n      },\n      transactions: shiftTxs, // Keep reference to all transactions\n      isGrouped: true\n    })\n  })\n\n  // Add standalone transactions\n  standalone.forEach(tx => {\n    grouped.push({\n      ...tx,\n      isGrouped: false\n    })\n  })\n\n  // Sort by timestamp (newest first)\n  grouped.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\n\n  return grouped\n}\n\nexport default function SafePage() {\n  const router = useRouter()\n  const { selectedStation, setSelectedStation, stations } = useStation()\n  const [safe, setSafe] = useState<Safe | null>(null)\n  const [groupedTransactions, setGroupedTransactions] = useState<(SafeTransaction | GroupedTransaction)[]>([])\n  const [outstandingCredit, setOutstandingCredit] = useState(0)\n  const [loading, setLoading] = useState(true)\n  const { toast } = useToast()\n\n\n  // Dialog states\n  const [addDialogOpen, setAddDialogOpen] = useState(false)\n  const [removeDialogOpen, setRemoveDialogOpen] = useState(false)\n  const [balanceDialogOpen, setBalanceDialogOpen] = useState(false)\n  const [loanDialogOpen, setLoanDialogOpen] = useState(false)\n  const [bankDepositDialogOpen, setBankDepositDialogOpen] = useState(false)\n\n  // Form states\n  const [amount, setAmount] = useState<number | undefined>(undefined)\n  const [description, setDescription] = useState('')\n  const [sourceOfIncome, setSourceOfIncome] = useState('')\n  const [responsiblePerson, setResponsiblePerson] = useState('')\n  const [expenseCategory, setExpenseCategory] = useState('EXPENSE')\n  const [customExpense, setCustomExpense] = useState('')\n  const [transactionDate, setTransactionDate] = useState<Date>(new Date())\n  const [openingBalance, setOpeningBalance] = useState<number | undefined>(undefined)\n\n  // Loan form states\n  const [loanCategory, setLoanCategory] = useState<'PUMPER' | 'EXTERNAL' | 'OFFICE'>('PUMPER')\n  const [loanPumperId, setLoanPumperId] = useState('')\n  const [loanRecipientName, setLoanRecipientName] = useState('')\n  const [loanAmount, setLoanAmount] = useState<number | undefined>(undefined)\n  const [loanMonthlyRental, setLoanMonthlyRental] = useState<number | undefined>(undefined)\n  const [loanNotes, setLoanNotes] = useState('')\n\n  // Bank deposit form states\n  const [depositAmount, setDepositAmount] = useState<number | undefined>(undefined)\n  const [depositBankId, setDepositBankId] = useState('')\n  const [depositPerformedBy, setDepositPerformedBy] = useState('')\n  const [depositNotes, setDepositNotes] = useState('')\n\n  // Data states\n  const [pumpers, setPumpers] = useState<Array<{ id: string; name: string; employeeId?: string }>>([])\n  const [banks, setBanks] = useState<Array<{ id: string; name: string; branch?: string; accountNumber?: string }>>([])\n\n  useEffect(() => {\n    if (selectedStation && selectedStation !== 'all') {\n      fetchSafe()\n      fetchPumpersAndBanks()\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedStation])\n\n  const fetchPumpersAndBanks = async () => {\n    if (!selectedStation || selectedStation === 'all') return\n\n    try {\n      const [pumpersRes, banksRes] = await Promise.all([\n        fetch(`/api/pumpers?active=true`),\n        fetch(`/api/banks?active=true`)\n      ])\n\n      if (pumpersRes.ok) {\n        const pumpersData = await pumpersRes.json()\n        setPumpers(Array.isArray(pumpersData) ? pumpersData : [])\n      }\n\n      if (banksRes.ok) {\n        const banksData = await banksRes.json()\n        setBanks(Array.isArray(banksData) ? banksData : [])\n      }\n    } catch (error) {\n      console.error('Failed to fetch pumpers/banks:', error)\n    }\n  }\n\n  // Refresh when page is focused (e.g., when navigating from close shift)\n  useEffect(() => {\n    const handleFocus = () => {\n      if (selectedStation && selectedStation !== 'all') {\n        fetchSafe()\n      }\n    }\n\n    window.addEventListener('focus', handleFocus)\n\n    return () => {\n      window.removeEventListener('focus', handleFocus)\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedStation])\n\n  const fetchSafe = async () => {\n    if (!selectedStation) return\n\n    try {\n      setLoading(true)\n\n      // Build API URLs with station filter\n      const stationParam = selectedStation === 'all' ? '' : `stationId=${selectedStation}`\n      const stationQuery = stationParam ? `?${stationParam}` : ''\n      const stationQueryAmp = stationParam ? `${stationParam}&` : ''\n\n      const [safeRes, transactionsRes, creditRes] = await Promise.all([\n        fetch(`/api/safe${stationQuery}`),\n        fetch(`/api/safe/transactions?${stationQueryAmp}limit=50`),\n        fetch(`/api/safe/outstanding-credit${stationQuery}`)\n      ])\n\n      if (!safeRes.ok || !transactionsRes.ok) {\n        throw new Error('Failed to fetch safe data')\n      }\n\n      const safeData = await safeRes.json()\n      const transactionsData = await transactionsRes.json()\n\n      // Outstanding credit endpoint\n      let creditData = { totalOutstanding: 0 }\n      if (creditRes.ok) {\n        creditData = await creditRes.json()\n      }\n\n      setSafe(safeData)\n      setOutstandingCredit(creditData.totalOutstanding || 0)\n\n      // Group transactions by shift closure for better display\n      const grouped = groupTransactionsByShift(transactionsData)\n      setGroupedTransactions(grouped)\n    } catch (err) {\n      console.error('Failed to fetch safe:', err)\n      toast({\n        title: \"Error\",\n        description: \"Failed to load safe data\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleAddTransaction = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!selectedStation || selectedStation === 'all' || amount === undefined || !sourceOfIncome || !responsiblePerson) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const finalDescription = description\n        ? `${sourceOfIncome} - ${description}`\n        : sourceOfIncome\n\n      const response = await fetch('/api/safe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          type: 'CASH_FUEL_SALES', // Default income type for API\n          amount: amount || 0,\n          description: finalDescription,\n          performedBy: responsiblePerson,\n          timestamp: transactionDate.toISOString()\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to create transaction')\n      }\n\n      setAddDialogOpen(false)\n      setAmount(undefined)\n      setSourceOfIncome('')\n      setResponsiblePerson('')\n      setDescription('')\n      setTransactionDate(new Date())\n\n      toast({\n        title: \"Success\",\n        description: \"Transaction added successfully!\"\n      })\n\n      fetchSafe()\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to add transaction\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleRemoveTransaction = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!selectedStation || selectedStation === 'all' || amount === undefined || !responsiblePerson) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (expenseCategory === 'OTHER' && !customExpense) {\n      toast({\n        title: \"Error\",\n        description: \"Please specify the expense type\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const expenseType = expenseCategory === 'OTHER' ? customExpense : 'General Expense'\n      const finalDescription = description\n        ? `${expenseType} - ${description}`\n        : expenseType\n\n      const response = await fetch('/api/safe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          type: 'EXPENSE',\n          amount: amount || 0,\n          description: finalDescription,\n          performedBy: responsiblePerson,\n          timestamp: transactionDate.toISOString()\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to create transaction')\n      }\n\n      setRemoveDialogOpen(false)\n      setAmount(undefined)\n      setExpenseCategory('EXPENSE')\n      setCustomExpense('')\n      setResponsiblePerson('')\n      setDescription('')\n      setTransactionDate(new Date())\n\n      toast({\n        title: \"Success\",\n        description: \"Transaction recorded successfully!\"\n      })\n\n      fetchSafe()\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to record transaction\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleSetOpeningBalance = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!selectedStation || selectedStation === 'all' || openingBalance === undefined) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter opening balance\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const username = typeof window !== 'undefined' ? localStorage.getItem('username') || 'System' : 'System'\n\n      const response = await fetch('/api/safe/balance', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          openingBalance: openingBalance || 0,\n          countedBy: username\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to set opening balance')\n      }\n\n      setBalanceDialogOpen(false)\n      setOpeningBalance(undefined)\n\n      toast({\n        title: \"Success\",\n        description: \"Opening balance set successfully!\"\n      })\n\n      fetchSafe()\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to set opening balance\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n\n  const handleGiveLoan = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!selectedStation || selectedStation === 'all' || loanAmount === undefined) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (loanCategory === 'PUMPER' && !loanPumperId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a pumper\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if ((loanCategory === 'EXTERNAL' || loanCategory === 'OFFICE') && !loanRecipientName) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter recipient name\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const username = typeof window !== 'undefined' ? localStorage.getItem('username') || 'System' : 'System'\n\n      let apiUrl = ''\n      let bodyData: {\n        stationId: string\n        amount: number\n        monthlyRental: number\n        givenBy: string\n        dueDate: string\n        fromSafe: boolean\n        pumperName?: string\n        staffName?: string\n        borrowerName?: string\n        borrowerPhone?: string\n        reason?: string\n        notes?: string\n      } = {\n        stationId: selectedStation,\n        amount: loanAmount || 0,\n        monthlyRental: loanMonthlyRental || 0,\n        givenBy: username,\n        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now\n        fromSafe: true\n      }\n\n      if (loanCategory === 'PUMPER') {\n        const selectedPumper = pumpers.find(p => p.id === loanPumperId)\n        const pumperName = selectedPumper?.name || 'Unknown Pumper'\n        apiUrl = '/api/loans/pumper'\n        bodyData = {\n          ...bodyData,\n          pumperName: pumperName,\n          reason: loanNotes || 'Loan given from safe'\n        }\n      } else if (loanCategory === 'OFFICE') {\n        apiUrl = '/api/loans/office'\n        bodyData = {\n          ...bodyData,\n          staffName: loanRecipientName,\n          reason: loanNotes || 'Loan given from safe'\n        }\n      } else if (loanCategory === 'EXTERNAL') {\n        apiUrl = '/api/loans/external'\n        bodyData = {\n          ...bodyData,\n          borrowerName: loanRecipientName,\n          borrowerPhone: 'N/A',\n          notes: loanNotes || 'Loan given from safe'\n        }\n      }\n\n      const loanResponse = await fetch(apiUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(bodyData)\n      })\n\n      if (!loanResponse.ok) {\n        throw new Error('Failed to record loan')\n      }\n\n      setLoanDialogOpen(false)\n      setLoanCategory('PUMPER')\n      setLoanPumperId('')\n      setLoanRecipientName('')\n      setLoanAmount(undefined)\n      setLoanMonthlyRental(undefined)\n      setLoanNotes('')\n\n      toast({\n        title: \"Success\",\n        description: \"Loan recorded successfully!\"\n      })\n\n      fetchSafe()\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to record loan\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleBankDeposit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!selectedStation || selectedStation === 'all' || !depositBankId || depositAmount === undefined || !depositPerformedBy) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    // Validate deposit amount doesn't exceed safe balance\n    const currentBalance = safe?.currentBalance || 0\n    if (depositAmount > currentBalance) {\n      toast({\n        title: \"Error\",\n        description: `Cannot deposit more than available cash. Current: Rs. ${currentBalance.toLocaleString()}`,\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (depositAmount <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Deposit amount must be greater than zero\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const selectedBank = banks.find(b => b.id === depositBankId)\n      const bankName = selectedBank?.name || 'Unknown Bank'\n      const bankAccount = selectedBank?.accountNumber ? ` (${selectedBank.accountNumber})` : ''\n\n      const response = await fetch('/api/safe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          type: 'BANK_DEPOSIT',\n          amount: depositAmount || 0,\n          description: `Bank deposit to ${bankName}${bankAccount}${depositNotes ? `: ${depositNotes}` : ''}`,\n          performedBy: depositPerformedBy,\n          timestamp: new Date().toISOString(),\n          bankId: depositBankId, // Pass bank ID for bank transaction tracking\n          bankDepositNotes: depositNotes\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to record bank deposit')\n      }\n\n      setBankDepositDialogOpen(false)\n      setDepositBankId('')\n      setDepositAmount(undefined)\n      setDepositPerformedBy('')\n      setDepositNotes('')\n\n      toast({\n        title: \"Success\",\n        description: \"Bank deposit recorded successfully!\"\n      })\n\n      fetchSafe()\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to record bank deposit\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n\n  const getTypeLabel = (type: string) => {\n    const labels: Record<string, string> = {\n      CASH_FUEL_SALES: 'Cash from Sales',\n      POS_CARD_PAYMENT: 'POS Card Payment',\n      CREDIT_PAYMENT: 'Credit Payment',\n      CHEQUE_RECEIVED: 'Cheque Received',\n      LOAN_REPAID: 'Loan Repaid',\n      OPENING_BALANCE: 'Opening Balance',\n      EXPENSE: 'Expense',\n      LOAN_GIVEN: 'Loan Given',\n      BANK_DEPOSIT: 'Bank Deposit',\n      CASH_TRANSFER: 'Cash Transfer',\n      COUNT_ADJUSTMENT: 'Count Adjustment'\n    }\n    return labels[type] || type\n  }\n\n  const getTypeIcon = (type: string) => {\n    if (INCOME_TYPES.includes(type)) {\n      return <ArrowDownRight className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n    }\n    return <ArrowUpRight className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n  }\n\n  const getTypeColor = (type: string) => {\n    if (INCOME_TYPES.includes(type)) {\n      return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n    }\n    return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n  }\n\n  const transactionColumns: Column<SafeTransaction | GroupedTransaction>[] = [\n    {\n      key: 'timestamp',\n      title: 'Date & Time',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{new Date(value as string).toLocaleString()}</span>\n        </div>\n      )\n    },\n    {\n      key: 'type',\n      title: 'Type',\n      render: (value: unknown) => {\n        const type = value as string\n        if (type === 'SHIFT_CLOSURE') {\n          return (\n            <div className=\"flex items-center gap-2\">\n              <ShoppingCart className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n              <Badge className=\"bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300\">\n                Shift Closure\n              </Badge>\n            </div>\n          )\n        }\n        return (\n          <div className=\"flex items-center gap-2\">\n            {getTypeIcon(type)}\n            <Badge className={getTypeColor(type)}>\n              {getTypeLabel(type)}\n            </Badge>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'description',\n      title: 'Details',\n      render: (value: unknown, row: SafeTransaction | GroupedTransaction) => {\n        const description = value as string\n\n        // Show shift closure breakdown\n        if ('isGrouped' in row && row.isGrouped && row.type === 'SHIFT_CLOSURE') {\n          const pumpers = row.shift?.assignments\n            ?.map((a) => a.pumper?.name || a.pumperName)\n            .filter((name, index, arr) => name && arr.indexOf(name) === index)\n            .join(', ') || 'Unknown'\n\n          const breakdown = row.breakdown\n          const parts: string[] = []\n          if (breakdown && breakdown.cash > 0) parts.push(`Cash: Rs. ${breakdown.cash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`)\n          if (breakdown && breakdown.card > 0) parts.push(`Card: Rs. ${breakdown.card.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`)\n          if (breakdown && breakdown.credit > 0) parts.push(`Credit: Rs. ${breakdown.credit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`)\n          if (breakdown && breakdown.cheque > 0) parts.push(`Cheque: Rs. ${breakdown.cheque.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`)\n\n          return (\n            <div className=\"space-y-1\">\n              <div className=\"text-sm font-medium\">{description}</div>\n              <div className=\"text-xs text-muted-foreground flex items-center gap-2\">\n                <Users className=\"h-3 w-3\" />\n                <span>{pumpers}</span>\n              </div>\n              {parts.length > 0 && (\n                <div className=\"text-xs text-muted-foreground mt-1\">\n                  {parts.join('  ')}\n                  {breakdown && breakdown.total > 0 && (\n                    <span className=\"ml-2 font-semibold text-foreground\">\n                       Total: Rs. {breakdown.total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </span>\n                  )}\n                </div>\n              )}\n            </div>\n          )\n        }\n\n        // Show shift info for individual shift transactions (shouldn't happen in grouped view, but fallback)\n        if (row.shift) {\n          const shiftName = row.shift.template?.name || 'Shift'\n          const pumpers = row.shift.assignments\n            ?.map((a) => a.pumper?.name || a.pumperName)\n            .filter((name, index, arr) => name && arr.indexOf(name) === index)\n            .join(', ') || 'Unknown'\n\n          return (\n            <div className=\"space-y-1\">\n              <div className=\"text-sm font-medium\">{description}</div>\n              <div className=\"text-xs text-muted-foreground flex items-center gap-2\">\n                <ShoppingCart className=\"h-3 w-3\" />\n                <span>{shiftName}  {pumpers}</span>\n              </div>\n            </div>\n          )\n        }\n\n        // Show POS batch details\n        if (row.batch && row.type === 'POS_CARD_PAYMENT') {\n          const terminals = row.batch.terminalEntries?.map((entry) =>\n            `${entry.terminal.terminalNumber} (${entry.terminal.name})`\n          ).join(', ') || 'Unknown Terminal'\n\n          return (\n            <div className=\"space-y-1\">\n              <div className=\"text-sm font-medium\">{description}</div>\n              <div className=\"text-xs text-muted-foreground flex items-center gap-2\">\n                <CreditCard className=\"h-3 w-3\" />\n                <span>{terminals}</span>\n              </div>\n            </div>\n          )\n        }\n\n        // Show cheque details\n        if (row.cheque) {\n          return (\n            <div className=\"space-y-1\">\n              <div className=\"text-sm font-medium\">{description}</div>\n              <div className=\"text-xs text-muted-foreground flex items-center gap-2\">\n                <FileText className=\"h-3 w-3\" />\n                <span>Cheque #{row.cheque.chequeNumber}{row.cheque.bank ? `  ${row.cheque.bank.name}` : ''}</span>\n              </div>\n            </div>\n          )\n        }\n\n        return <span className=\"text-sm\">{description}</span>\n      }\n    },\n    {\n      key: 'amount',\n      title: 'Amount',\n      render: (value: unknown, row: SafeTransaction | GroupedTransaction) => {\n        const isIncome = row.type === 'SHIFT_CLOSURE' || INCOME_TYPES.includes(row.type)\n        return (\n          <div className={`flex items-center gap-2 font-mono ${isIncome ? 'text-green-700' : 'text-red-700'}`}>\n            {isIncome ? <Plus className=\"h-4 w-4\" /> : <Minus className=\"h-4 w-4\" />}\n            <span className=\"font-semibold\">\n              Rs. {Math.abs(value as number).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'balanceAfter',\n      title: 'Balance',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2 font-mono\">\n          <Wallet className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-semibold\">Rs. {(value as number).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n        </div>\n      )\n    },\n    {\n      key: 'performedBy',\n      title: 'By',\n      render: (value: unknown) => <span className=\"text-sm text-muted-foreground\">{value as string}</span>\n    }\n  ]\n\n  if (!selectedStation || selectedStation === 'all') {\n    return (\n      <div className=\"space-y-6 p-6\">\n        <h1 className=\"text-3xl font-bold text-foreground\">Safe Management</h1>\n        <Alert>\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>No Station Selected</AlertTitle>\n          <AlertDescription>Please select a station to view safe details.</AlertDescription>\n        </Alert>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Safe Management</h1>\n          <p className=\"text-muted-foreground mt-2\">Track all cash in and out of the safe</p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Dialog open={balanceDialogOpen} onOpenChange={setBalanceDialogOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\">\n                <Calendar className=\"mr-2 h-4 w-4\" />\n                Set Opening Balance\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Set Opening Balance</DialogTitle>\n              </DialogHeader>\n              <form onSubmit={handleSetOpeningBalance} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"openingBalance\">Opening Balance (Rs.)</Label>\n                  <MoneyInput\n                    id=\"openingBalance\"\n                    value={openingBalance}\n                    onChange={setOpeningBalance}\n                    placeholder=\"0.00\"\n                  />\n                </div>\n                <div className=\"flex justify-end gap-3\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setBalanceDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\">Set Balance</Button>\n                </div>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      {/* Station Selector */}\n      <Card>\n        <CardContent className=\"p-4 flex items-center gap-4\">\n          <Building2 className=\"h-5 w-5 text-muted-foreground\" />\n          <div className=\"flex-1\">\n            <Label htmlFor=\"station-select\" className=\"sr-only\">Select Station</Label>\n            <Select\n              value={selectedStation || ''}\n              onValueChange={setSelectedStation}\n            >\n              <SelectTrigger id=\"station-select\" className=\"w-[300px]\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Stations</SelectItem>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    {station.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <Button variant=\"outline\" onClick={fetchSafe}>\n            <TrendingUp className=\"mr-2 h-4 w-4\" />\n            Refresh Data\n          </Button>\n        </CardContent>\n      </Card>\n\n      {/* Safe Balance Cards */},\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Opening Balance</h3>\n              <p className=\"text-2xl font-bold text-foreground mt-1\">\n                Rs. {safe?.openingBalance.toLocaleString() || '0'}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Starting cash at beginning of period\n              </p>\n            </div>\n            <Wallet className=\"h-8 w-8 text-muted-foreground ml-2\" />\n          </div>\n        </div>\n\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Physical Cash</h3>\n              <p className=\"text-2xl font-bold text-green-600 dark:text-green-400 mt-1\">\n                Rs. {safe?.currentBalance.toLocaleString() || '0'}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Actual cash in safe\n              </p>\n            </div>\n            <TrendingUp className=\"h-8 w-8 text-green-600 dark:text-green-400 ml-2\" />\n          </div>\n        </div>\n\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Outstanding Credit</h3>\n              <p className=\"text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1\">\n                Rs. {outstandingCredit.toLocaleString()}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Credit slips (not cash)\n              </p>\n            </div>\n            <CreditCard className=\"h-8 w-8 text-orange-600 dark:text-orange-400 ml-2\" />\n          </div>\n        </div>\n\n        <div className=\"p-4 border rounded-lg bg-card border-purple-500/50\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Total Assets</h3>\n              <p className=\"text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1\">\n                Rs. {((safe?.currentBalance || 0) + outstandingCredit).toLocaleString()}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Cash + Outstanding Credit\n              </p>\n            </div>\n            <DollarSign className=\"h-8 w-8 text-purple-600 dark:text-purple-400 ml-2\" />\n          </div>\n        </div>\n      </div>\n\n      {/* Key Metrics - More Valuable Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        {/* Outstanding Loans */}\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Outstanding Loans</h3>\n              <p className=\"text-2xl font-bold text-amber-600 dark:text-amber-400 mt-1\">\n                Rs. {(() => {\n                  const loanGiven = groupedTransactions\n                    .filter(t => !('isGrouped' in t && t.isGrouped) && t.type === 'LOAN_GIVEN')\n                    .reduce((sum, t) => sum + t.amount, 0)\n                  const loanRepaid = groupedTransactions\n                    .filter(t => !('isGrouped' in t && t.isGrouped) && t.type === 'LOAN_REPAID')\n                    .reduce((sum, t) => sum + t.amount, 0)\n                  return (loanGiven - loanRepaid).toLocaleString()\n                })()}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Money to be collected\n              </p>\n            </div>\n            <CreditCard className=\"h-8 w-8 text-amber-600 dark:text-amber-400 ml-2\" />\n          </div>\n        </div>\n\n        {/* Today's Collections */}\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Today&apos;s Collections</h3>\n              <p className=\"text-2xl font-bold text-green-600 dark:text-green-400 mt-1\">\n                Rs. {(() => {\n                  const today = new Date()\n                  today.setHours(0, 0, 0, 0)\n                  const todayCollections = groupedTransactions\n                    .filter(t => {\n                      const txDate = new Date(t.timestamp)\n                      txDate.setHours(0, 0, 0, 0)\n                      return txDate.getTime() === today.getTime() &&\n                        ['CASH_FUEL_SALES', 'POS_CARD_PAYMENT', 'CREDIT_PAYMENT', 'CHEQUE_RECEIVED', 'LOAN_REPAID'].includes(t.type)\n                    })\n                    .reduce((sum, t) => sum + t.amount, 0)\n                  return todayCollections.toLocaleString()\n                })()}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {groupedTransactions.filter(t => {\n                  const today = new Date()\n                  today.setHours(0, 0, 0, 0)\n                  const txDate = new Date(t.timestamp)\n                  txDate.setHours(0, 0, 0, 0)\n                  return txDate.getTime() === today.getTime()\n                }).length} transactions today\n              </p>\n            </div>\n            <TrendingUp className=\"h-8 w-8 text-green-600 dark:text-green-400 ml-2\" />\n          </div>\n        </div>\n\n        {/* Bank Deposits This Week */}\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Bank Deposits (7d)</h3>\n              <p className=\"text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1\">\n                Rs. {(() => {\n                  const weekAgo = new Date()\n                  weekAgo.setDate(weekAgo.getDate() - 7)\n                  const deposits = groupedTransactions\n                    .filter(t => !('isGrouped' in t && t.isGrouped) && t.type === 'BANK_DEPOSIT' && new Date(t.timestamp) >= weekAgo)\n                    .reduce((sum, t) => sum + t.amount, 0)\n                  return deposits.toLocaleString()\n                })()}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Banked last 7 days\n              </p>\n            </div>\n            <Building2 className=\"h-8 w-8 text-blue-600 dark:text-blue-400 ml-2\" />\n          </div>\n        </div>\n\n        {/* Largest Transaction Today */}\n        <div className=\"p-4 border rounded-lg bg-card\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">Largest Transaction</h3>\n              <p className=\"text-2xl font-bold text-red-600 dark:text-red-400 mt-1\">\n                Rs. {(() => {\n                  const today = new Date()\n                  today.setHours(0, 0, 0, 0)\n                  const todayTx = groupedTransactions.filter(t => {\n                    const txDate = new Date(t.timestamp)\n                    txDate.setHours(0, 0, 0, 0)\n                    return txDate.getTime() === today.getTime()\n                  })\n                  const largest = todayTx.length > 0\n                    ? Math.max(...todayTx.map(t => t.amount))\n                    : 0\n                  return largest.toLocaleString()\n                })()}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Today&apos;s peak transaction\n              </p>\n            </div>\n            <ArrowUpCircle className=\"h-8 w-8 text-red-600 dark:text-red-400 ml-2\" />\n          </div>\n        </div>\n      </div>\n\n      {/* Quick Actions */}\n      <div className=\"flex flex-wrap gap-4\">\n        <Dialog open={addDialogOpen} onOpenChange={setAddDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={() => { }}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Money\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2 text-green-700 dark:text-green-400\">\n                <ArrowDownRight className=\"h-5 w-5\" />\n                Add Money to Safe\n              </DialogTitle>\n              <p className=\"text-sm text-muted-foreground\">Record incoming cash to the safe</p>\n            </DialogHeader>\n            <form onSubmit={handleAddTransaction} className=\"space-y-4\">\n              <div className=\"p-3 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-900 rounded-lg\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Plus className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                  <span className=\"text-sm font-semibold text-green-900 dark:text-green-100\">Incoming Transaction</span>\n                </div>\n                <p className=\"text-xs text-green-700 dark:text-green-300\">\n                  This will increase the safe balance\n                </p>\n              </div>\n              <div>\n                <Label htmlFor=\"sourceOfIncome\" className=\"text-base font-semibold\">Source of Income *</Label>\n                <Input\n                  id=\"sourceOfIncome\"\n                  value={sourceOfIncome}\n                  onChange={(e) => setSourceOfIncome(e.target.value)}\n                  placeholder=\"E.g., Fuel Sales, Card Payment, Loan Repayment, etc.\"\n                  className=\"mt-1\"\n                  required\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Enter the source of this income\n                </p>\n              </div>\n              <div>\n                <Label htmlFor=\"addAmount\" className=\"text-base font-semibold\">Amount (Rs.) *</Label>\n                <MoneyInput\n                  id=\"addAmount\"\n                  value={amount}\n                  onChange={setAmount}\n                  placeholder=\"0.00\"\n                  className=\"mt-1\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"responsiblePersonAdd\" className=\"text-base font-semibold\">Responsible Person *</Label>\n                <Input\n                  id=\"responsiblePersonAdd\"\n                  value={responsiblePerson}\n                  onChange={(e) => setResponsiblePerson(e.target.value)}\n                  placeholder=\"Name of person responsible\"\n                  className=\"mt-1\"\n                  required\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"addDescription\" className=\"text-base font-semibold\">Additional Notes (Optional)</Label>\n                <Input\n                  id=\"addDescription\"\n                  value={description}\n                  onChange={(e) => setDescription(e.target.value)}\n                  placeholder=\"Enter additional details\"\n                  className=\"mt-1\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"addDate\" className=\"text-base font-semibold\">Date & Time</Label>\n                <DateTimePicker\n                  value={transactionDate}\n                  onChange={(date) => setTransactionDate(date || new Date())}\n                />\n              </div>\n              <div className=\"flex justify-end gap-3\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => {\n                  setAddDialogOpen(false)\n                  setSourceOfIncome('')\n                  setResponsiblePerson('')\n                  setDescription('')\n                  setAmount(undefined)\n                }}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">Add to Safe</Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Continue with Remove Money, Give Loan, Bank Deposit buttons... */}\n        <Dialog open={removeDialogOpen} onOpenChange={setRemoveDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"outline\" onClick={() => { }}>\n              <Minus className=\"mr-2 h-4 w-4\" />\n              Remove Money\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2 text-red-700 dark:text-red-400\">\n                <ArrowUpRight className=\"h-5 w-5\" />\n                Remove Money from Safe\n              </DialogTitle>\n              <p className=\"text-sm text-muted-foreground\">Record outgoing cash from the safe</p>\n            </DialogHeader>\n            <form onSubmit={handleRemoveTransaction} className=\"space-y-4\">\n              <div className=\"p-3 bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-900 rounded-lg\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Minus className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n                  <span className=\"text-sm font-semibold text-red-900 dark:text-red-100\">Outgoing Transaction</span>\n                </div>\n                <p className=\"text-xs text-red-700 dark:text-red-300\">\n                  This will decrease the safe balance\n                </p>\n              </div>\n              <div>\n                <Label htmlFor=\"expenseCategory\" className=\"text-base font-semibold\">Expense Category *</Label>\n                <Select value={expenseCategory} onValueChange={setExpenseCategory}>\n                  <SelectTrigger id=\"expenseCategory\" className=\"mt-1\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"EXPENSE\">General Expense</SelectItem>\n                    <SelectItem value=\"OTHER\">Other (Specify below)</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {expenseCategory === 'OTHER' && (\n                <div>\n                  <Label htmlFor=\"customExpense\" className=\"text-base font-semibold\">Specify Expense Type *</Label>\n                  <Input\n                    id=\"customExpense\"\n                    value={customExpense}\n                    onChange={(e) => setCustomExpense(e.target.value)}\n                    placeholder=\"Enter expense type\"\n                    className=\"mt-1\"\n                    required\n                  />\n                </div>\n              )}\n\n              <div>\n                <Label htmlFor=\"removeAmount\" className=\"text-base font-semibold\">Amount (Rs.) *</Label>\n                <MoneyInput\n                  id=\"removeAmount\"\n                  value={amount}\n                  onChange={setAmount}\n                  placeholder=\"0.00\"\n                  className=\"mt-1\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"responsiblePersonRemove\" className=\"text-base font-semibold\">Responsible Person *</Label>\n                <Input\n                  id=\"responsiblePersonRemove\"\n                  value={responsiblePerson}\n                  onChange={(e) => setResponsiblePerson(e.target.value)}\n                  placeholder=\"Name of person responsible\"\n                  className=\"mt-1\"\n                  required\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"removeDescription\" className=\"text-base font-semibold\">Additional Notes (Optional)</Label>\n                <Input\n                  id=\"removeDescription\"\n                  value={description}\n                  onChange={(e) => setDescription(e.target.value)}\n                  placeholder=\"Enter additional details\"\n                  className=\"mt-1\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"removeDate\" className=\"text-base font-semibold\">Date & Time</Label>\n                <DateTimePicker\n                  value={transactionDate}\n                  onChange={(date) => setTransactionDate(date || new Date())}\n                />\n              </div>\n              <div className=\"flex justify-end gap-3\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => {\n                  setRemoveDialogOpen(false)\n                  setExpenseCategory('EXPENSE')\n                  setCustomExpense('')\n                  setResponsiblePerson('')\n                  setDescription('')\n                  setAmount(undefined)\n                }}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" variant=\"destructive\">Remove from Safe</Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        {/* Loan Dialog */}\n        <Dialog open={loanDialogOpen} onOpenChange={setLoanDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"outline\">\n              <Users className=\"mr-2 h-4 w-4\" />\n              Give Loan\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Users className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                Give Loan from Safe\n              </DialogTitle>\n              <p className=\"text-sm text-muted-foreground\">Record a loan given from safe cash</p>\n            </DialogHeader>\n            <form onSubmit={handleGiveLoan} className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"loanCategory\" className=\"text-base font-semibold\">Loan Category</Label>\n                <Select value={loanCategory} onValueChange={(value) => {\n                  setLoanCategory(value as 'PUMPER' | 'EXTERNAL' | 'OFFICE')\n                  setLoanPumperId('')\n                  setLoanRecipientName('')\n                }}>\n                  <SelectTrigger id=\"loanCategory\" className=\"mt-1\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"PUMPER\">Pumper Loan</SelectItem>\n                    <SelectItem value=\"EXTERNAL\">External Loan (Customer/Supplier)</SelectItem>\n                    <SelectItem value=\"OFFICE\">Office/Staff Loan</SelectItem>\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {loanCategory === 'PUMPER' && 'Loan to a pumper employee'}\n                  {loanCategory === 'EXTERNAL' && 'Loan to external party (customer, supplier, etc.)'}\n                  {loanCategory === 'OFFICE' && 'Loan to office staff or management'}\n                </p>\n              </div>\n\n              {loanCategory === 'PUMPER' ? (\n                <div>\n                  <Label htmlFor=\"loanPumper\" className=\"text-base font-semibold\">Select Pumper</Label>\n                  <Select value={loanPumperId} onValueChange={setLoanPumperId}>\n                    <SelectTrigger id=\"loanPumper\" className=\"mt-1\">\n                      <SelectValue placeholder=\"Choose a pumper...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {pumpers.length === 0 ? (\n                        <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">No pumpers available</div>\n                      ) : (\n                        pumpers.map((pumper) => (\n                          <SelectItem key={pumper.id} value={pumper.id}>\n                            {pumper.name}{pumper.employeeId ? ` (${pumper.employeeId})` : ''}\n                          </SelectItem>\n                        ))\n                      )}\n                    </SelectContent>\n                  </Select>\n                </div>\n              ) : (\n                <div>\n                  <Label htmlFor=\"loanRecipient\" className=\"text-base font-semibold\">Recipient Name</Label>\n                  <Input\n                    id=\"loanRecipient\"\n                    value={loanRecipientName}\n                    onChange={(e) => setLoanRecipientName(e.target.value)}\n                    placeholder={loanCategory === 'EXTERNAL' ? 'E.g., Customer Name, Supplier Name' : 'E.g., Office Manager, Accountant'}\n                    className=\"mt-1\"\n                  />\n                </div>\n              )}\n\n              <div>\n                <Label htmlFor=\"loanAmount\">Loan Amount (Rs.)</Label>\n                <MoneyInput\n                  id=\"loanAmount\"\n                  value={loanAmount}\n                  onChange={setLoanAmount}\n                  placeholder=\"0.00\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"loanMonthlyRental\">Monthly Rental (Rs.)</Label>\n                <MoneyInput\n                  id=\"loanMonthlyRental\"\n                  value={loanMonthlyRental}\n                  onChange={setLoanMonthlyRental}\n                  placeholder=\"0.00\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Amount to deduct monthly (default: 0)\n                </p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"loanNotes\">Notes (Optional)</Label>\n                <Input\n                  id=\"loanNotes\"\n                  value={loanNotes}\n                  onChange={(e) => setLoanNotes(e.target.value)}\n                  placeholder=\"Additional notes\"\n                />\n              </div>\n\n              <div className=\"flex justify-end gap-3\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setLoanDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">Give Loan</Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n\n        <Dialog open={bankDepositDialogOpen} onOpenChange={setBankDepositDialogOpen}>\n          <DialogTrigger asChild>\n            <Button variant=\"outline\">\n              <DollarSign className=\"mr-2 h-4 w-4\" />\n              Bank Deposit\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Bank Deposit</DialogTitle>\n              <DialogDescription>\n                Record money deposited to bank from safe\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleBankDeposit} className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"depositBank\" className=\"text-base font-semibold\">Bank Account *</Label>\n                <Select value={depositBankId} onValueChange={setDepositBankId}>\n                  <SelectTrigger id=\"depositBank\" className=\"mt-1\">\n                    <SelectValue placeholder=\"Select bank account\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {banks.length === 0 ? (\n                      <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">No bank accounts available</div>\n                    ) : (\n                      banks.map((bank) => (\n                        <SelectItem key={bank.id} value={bank.id}>\n                          <div className=\"flex flex-col\">\n                            <span className=\"font-medium\">{bank.name}</span>\n                            {bank.accountNumber && (\n                              <span className=\"text-xs text-muted-foreground\">A/C: {bank.accountNumber}</span>\n                            )}\n                          </div>\n                        </SelectItem>\n                      ))\n                    )}\n                  </SelectContent>\n                </Select>\n                {depositBankId && banks.find(b => b.id === depositBankId)?.accountNumber && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Account Number: <span className=\"font-mono font-medium\">{banks.find(b => b.id === depositBankId)?.accountNumber}</span>\n                  </p>\n                )}\n              </div>\n\n              <div>\n                <Label htmlFor=\"depositAmount\" className=\"text-base font-semibold\">Deposit Amount (Rs.) *</Label>\n                <MoneyInput\n                  id=\"depositAmount\"\n                  value={depositAmount}\n                  onChange={setDepositAmount}\n                  placeholder=\"Enter amount\"\n                  className=\"mt-1\"\n                />\n                {safe && (\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Available in safe: Rs. {(safe.currentBalance || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </p>\n                )}\n              </div>\n\n              <div>\n                <Label htmlFor=\"depositPerformedBy\" className=\"text-base font-semibold\">Performed By *</Label>\n                <Input\n                  id=\"depositPerformedBy\"\n                  value={depositPerformedBy}\n                  onChange={(e) => setDepositPerformedBy(e.target.value)}\n                  placeholder=\"Name of person making deposit\"\n                  className=\"mt-1\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"depositNotes\" className=\"text-base font-semibold\">Notes (Optional)</Label>\n                <Input\n                  id=\"depositNotes\"\n                  value={depositNotes}\n                  onChange={(e) => setDepositNotes(e.target.value)}\n                  placeholder=\"Additional notes\"\n                  className=\"mt-1\"\n                />\n              </div>\n\n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setBankDepositDialogOpen(false)\n                    setDepositBankId('')\n                    setDepositAmount(undefined)\n                    setDepositPerformedBy('')\n                    setDepositNotes('')\n                  }}\n                >\n                  Cancel\n                </Button>\n                <Button type=\"submit\">\n                  Record Deposit\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n\n      {/* Removed: All POS verification/reconciliation - Now handled in Close Shift page */}\n      {/* Removed: Unprocessed Shifts section - All verification now happens in Close Shift page */}\n\n      {/* Transactions Table */}\n      <FormCard title=\"Recent Transactions\" className=\"p-6\">\n        <DataTable\n          data={groupedTransactions}\n          columns={transactionColumns}\n          searchPlaceholder=\"Search transactions...\"\n          emptyMessage=\"No transactions found.\"\n          onRowClick={(row) => {\n            // For shift closures, navigate to the first transaction's details page\n            // The details page will show all related transactions\n            if ('isGrouped' in row && row.isGrouped && row.transactions && row.transactions.length > 0) {\n              router.push(`/safe/transactions/${row.transactions[0].id}`)\n            } else {\n              router.push(`/safe/transactions/${row.id}`)\n            }\n          }}\n        />\n      </FormCard>\n\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\safe\\summary\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":117,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":117,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from '@/components/ui/collapsible'\nimport {\n  Shield,\n  Calendar,\n  TrendingUp,\n  TrendingDown,\n  AlertCircle,\n  CheckCircle,\n  Building2,\n  DollarSign,\n  Calculator,\n  ChevronDown,\n  ChevronRight,\n  Plus,\n  Minus,\n  AlertTriangle\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface SafeSummary {\n  stationId: string\n  stationName: string\n  date: string\n  openingBalance: number\n\n  // Inflows\n  cashSales: number\n  creditPayments: number\n  loanReceipts: number\n  otherInflows: number\n  totalInflows: number\n\n  // Outflows\n  expenses: number\n  loanPayments: number\n  deposits: number\n  otherOutflows: number\n  totalOutflows: number\n\n  // Calculated\n  expectedBalance: number\n  actualBalance: number\n  variance: number\n  isBalanced: boolean\n\n  // Details for expanders\n  inflowDetails: InflowDetail[]\n  outflowDetails: OutflowDetail[]\n}\n\ninterface InflowDetail {\n  id: string\n  type: 'CASH_SALES' | 'CREDIT_PAYMENT' | 'LOAN_RECEIPT' | 'OTHER'\n  description: string\n  amount: number\n  time: string\n  reference?: string\n}\n\ninterface OutflowDetail {\n  id: string\n  type: 'EXPENSE' | 'LOAN_PAYMENT' | 'DEPOSIT' | 'OTHER'\n  description: string\n  amount: number\n  time: string\n  reference?: string\n  approvedBy?: string\n}\n\nexport default function SafeSummaryPage() {\n  const [stations, setStations] = useState<Station[]>([])\n  const [safeSummary, setSafeSummary] = useState<SafeSummary | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0])\n\n  // Expander state\n  const [inflowsExpanded, setInflowsExpanded] = useState(false)\n  const [outflowsExpanded, setOutflowsExpanded] = useState(false)\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  const generateSummary = async () => {\n    if (!selectedStation || !selectedDate) {\n      setError('Please select both station and date')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call the API endpoint to get real safe summary data\n      const response = await fetch(`/api/safe/summary?stationId=${selectedStation}&date=${selectedDate}`)\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch safe summary')\n      }\n\n      const apiData = await response.json()\n\n      // Transform API response to match frontend interface\n      const summary: SafeSummary = {\n        stationId: apiData.stationId || selectedStation,\n        stationName: apiData.stationName || stations.find(s => s.id === selectedStation)?.name || 'Unknown Station',\n        date: apiData.date || selectedDate,\n        openingBalance: apiData.openingBalance || 0,\n        cashSales: apiData.cashSales || 0,\n        creditPayments: apiData.creditPayments || 0,\n        loanReceipts: apiData.loanReceipts || 0,\n        otherInflows: apiData.otherInflows || 0,\n        totalInflows: apiData.totalInflows || 0,\n        expenses: apiData.expenses || 0,\n        loanPayments: apiData.loanPayments || 0,\n        deposits: apiData.deposits || 0,\n        otherOutflows: apiData.otherOutflows || 0,\n        totalOutflows: apiData.totalOutflows || 0,\n        expectedBalance: apiData.expectedBalance || 0,\n        actualBalance: apiData.actualBalance || 0,\n        variance: apiData.variance || 0,\n        isBalanced: apiData.isBalanced || false,\n        inflowDetails: apiData.inflowDetails || [],\n        outflowDetails: apiData.outflowDetails || []\n      }\n\n      setSafeSummary(summary)\n\n    } catch (err) {\n      console.error('Error fetching safe summary:', err)\n      setError('Failed to generate safe summary: ' + (err instanceof Error ? err.message : 'Unknown error'))\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getVarianceColor = (variance: number) => {\n    if (Math.abs(variance) <= 500) return 'text-green-600 dark:text-green-400'\n    if (Math.abs(variance) <= 1000) return 'text-yellow-600 dark:text-yellow-400'\n    return 'text-red-600 dark:text-red-400'\n  }\n\n  const getTypeIcon = (type: string) => {\n    switch (type) {\n      case 'CASH_SALES':\n      case 'CREDIT_PAYMENT':\n        return <TrendingUp className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n      case 'EXPENSE':\n      case 'LOAN_PAYMENT':\n      case 'DEPOSIT':\n        return <TrendingDown className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n      default:\n        return <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n    }\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Safe Summary</h1>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Generate Safe Summary\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"date\">Date</Label>\n            <input\n              id=\"date\"\n              type=\"date\"\n              value={selectedDate}\n              onChange={(e) => setSelectedDate(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateSummary} disabled={loading || !selectedStation || !selectedDate}>\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Summary\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {safeSummary && (\n        <div className=\"space-y-6\">\n          {/* Header */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <Shield className=\"h-5 w-5\" />\n                  Safe Summary - {safeSummary.stationName}\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Calendar className=\"h-4 w-4\" />\n                  {new Date(safeSummary.date).toLocaleDateString()}\n                </div>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"text-center\">\n                  <div className=\"text-3xl font-bold text-blue-600 dark:text-blue-400\">\n                    Rs. {safeSummary.actualBalance.toLocaleString()}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Actual Balance</div>\n                </div>\n                <div className=\"text-center\">\n                  <Badge\n                    className={`text-lg py-2 px-4 ${safeSummary.isBalanced\n                        ? 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n                        : 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n                      }`}\n                  >\n                    {safeSummary.isBalanced ? (\n                      <>\n                        <CheckCircle className=\"h-5 w-5 mr-2\" />\n                        Balanced\n                      </>\n                    ) : (\n                      <>\n                        <AlertCircle className=\"h-5 w-5 mr-2\" />\n                        Not Balanced\n                      </>\n                    )}\n                  </Badge>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Formula Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\">Opening Balance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\">\n                  Rs. {safeSummary.openingBalance.toLocaleString()}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-green-600 dark:text-green-400\">Total Inflows</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-green-700\">\n                  + Rs. {safeSummary.totalInflows.toLocaleString()}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-red-600 dark:text-red-400\">Total Outflows</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-red-700\">\n                  - Rs. {safeSummary.totalOutflows.toLocaleString()}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm font-medium text-blue-600 dark:text-blue-400\">Expected Balance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-blue-700\">\n                  Rs. {safeSummary.expectedBalance.toLocaleString()}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Variance */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Variance Analysis</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-semibold text-muted-foreground\">Expected</div>\n                  <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                    Rs. {safeSummary.expectedBalance.toLocaleString()}\n                  </div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-semibold text-muted-foreground\">Actual</div>\n                  <div className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\n                    Rs. {safeSummary.actualBalance.toLocaleString()}\n                  </div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"text-lg font-semibold text-muted-foreground\">Variance</div>\n                  <div className={`text-2xl font-bold ${getVarianceColor(safeSummary.variance)}`}>\n                    {safeSummary.variance >= 0 ? '+' : ''}Rs. {safeSummary.variance.toLocaleString()}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Inflows Expander */}\n          <Card>\n            <Collapsible open={inflowsExpanded} onOpenChange={setInflowsExpanded}>\n              <CollapsibleTrigger asChild>\n                <CardHeader className=\"cursor-pointer hover:bg-muted\">\n                  <CardTitle className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <Plus className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n                      Inflows - Rs. {safeSummary.totalInflows.toLocaleString()}\n                    </div>\n                    {inflowsExpanded ? (\n                      <ChevronDown className=\"h-4 w-4\" />\n                    ) : (\n                      <ChevronRight className=\"h-4 w-4\" />\n                    )}\n                  </CardTitle>\n                </CardHeader>\n              </CollapsibleTrigger>\n              <CollapsibleContent>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    {safeSummary.inflowDetails.map((inflow) => (\n                      <div key={inflow.id} className=\"flex items-center justify-between p-3 bg-green-500/10 dark:bg-green-500/20 rounded-lg\">\n                        <div className=\"flex items-center gap-3\">\n                          {getTypeIcon(inflow.type)}\n                          <div>\n                            <div className=\"font-medium\">{inflow.description}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {inflow.time} {inflow.reference && ` ${inflow.reference}`}\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"font-semibold text-green-700\">\n                          Rs. {inflow.amount.toLocaleString()}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </CollapsibleContent>\n            </Collapsible>\n          </Card>\n\n          {/* Outflows Expander */}\n          <Card>\n            <Collapsible open={outflowsExpanded} onOpenChange={setOutflowsExpanded}>\n              <CollapsibleTrigger asChild>\n                <CardHeader className=\"cursor-pointer hover:bg-muted\">\n                  <CardTitle className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <Minus className=\"h-5 w-5 text-red-600 dark:text-red-400\" />\n                      Outflows - Rs. {safeSummary.totalOutflows.toLocaleString()}\n                    </div>\n                    {outflowsExpanded ? (\n                      <ChevronDown className=\"h-4 w-4\" />\n                    ) : (\n                      <ChevronRight className=\"h-4 w-4\" />\n                    )}\n                  </CardTitle>\n                </CardHeader>\n              </CollapsibleTrigger>\n              <CollapsibleContent>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    {safeSummary.outflowDetails.map((outflow) => (\n                      <div key={outflow.id} className=\"flex items-center justify-between p-3 bg-red-500/10 dark:bg-red-500/20 rounded-lg\">\n                        <div className=\"flex items-center gap-3\">\n                          {getTypeIcon(outflow.type)}\n                          <div>\n                            <div className=\"font-medium\">{outflow.description}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {outflow.time} {outflow.reference && ` ${outflow.reference}`}\n                              {outflow.approvedBy && `  Approved by ${outflow.approvedBy}`}\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"font-semibold text-red-700\">\n                          Rs. {outflow.amount.toLocaleString()}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </CollapsibleContent>\n            </Collapsible>\n          </Card>\n\n          {/* Recommendations */}\n          {!safeSummary.isBalanced && (\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Action Required</AlertTitle>\n              <AlertDescription>\n                The safe is not balanced. Variance of Rs. {Math.abs(safeSummary.variance).toLocaleString()}\n                {safeSummary.variance > 0 ? ' excess' : ' shortage'} detected.\n                Please verify all transactions and investigate the discrepancy.\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\safe\\transactions\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":17,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":19,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'relatedTransactions' is assigned a value but never used.","line":130,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":130,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useMemo } from 'react'\nimport { useParams, useRouter } from 'next/navigation'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport { Label } from '@/components/ui/label'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport {\n  Clock,\n  Users,\n  DollarSign,\n  ArrowLeft,\n  ShoppingCart,\n  CreditCard,\n  FileText,\n  AlertCircle,\n  CheckCircle\n} from 'lucide-react'\n\ninterface SafeTransaction {\n  id: string\n  type: string\n  amount: number\n  balanceBefore: number\n  balanceAfter: number\n  description: string\n  performedBy: string\n  timestamp: string\n  shiftId?: string\n  batchId?: string\n  expenseId?: string\n  loanId?: string\n  shift?: {\n    id: string\n    template?: {\n      name: string\n    }\n    assignments?: Array<{\n      pumper?: {\n        name: string\n      }\n      pumperName?: string\n    }>\n    declaredAmounts?: {\n      cash?: number\n      card?: number\n      credit?: number\n      cheque?: number\n      total?: number\n      pumperBreakdown?: Array<{\n        pumperName: string\n        calculatedSales: number\n        declaredAmount: number\n        declaredCash: number\n        declaredCardAmounts: Record<string, number>\n        declaredCreditAmounts: Record<string, number>\n        declaredCheque: number\n        cheques: Array<{\n          chequeNumber: string\n          amount: number\n          receivedFrom: string\n          bankName?: string\n        }>\n        advanceTaken: number\n        expenses: Array<{\n          type: string\n          amount: number\n          description?: string\n          bankName?: string\n          loanGivenToName?: string\n        }>\n        variance: number\n        varianceStatus: string\n        declaredCardAmountsWithNames?: Record<string, { amount: number; terminalName: string }>\n        declaredCreditAmountsWithNames?: Record<string, { amount: number; customerName: string }>\n      }>\n    }\n  }\n  batch?: {\n    id: string\n    totalAmount: number\n    terminalEntries?: Array<{\n      id: string\n      terminal: {\n        id: string\n        name: string\n        terminalNumber: string\n        bank?: {\n          name: string\n        }\n      }\n      startNumber: string\n      endNumber: string\n      transactionCount: number\n      visaAmount: number\n      masterAmount: number\n      amexAmount: number\n      qrAmount: number\n      dialogTouchAmount?: number\n    }>\n  }\n  cheque?: {\n    id: string\n    chequeNumber: string\n    amount: number\n    bank?: {\n      name: string\n    }\n  }\n}\n\nconst INCOME_TYPES = [\n  'CASH_FUEL_SALES',\n  'POS_CARD_PAYMENT',\n  'CREDIT_PAYMENT',\n  'CHEQUE_RECEIVED',\n  'LOAN_REPAID',\n  'OPENING_BALANCE'\n]\n\nexport default function TransactionDetailsPage() {\n  const params = useParams()\n  const router = useRouter()\n  // Extract id immediately using useMemo to avoid Next.js 15 enumeration issues\n  const transactionId = useMemo(() => (params?.id as string) || '', [params])\n\n  const [transaction, setTransaction] = useState<SafeTransaction | null>(null)\n  const [relatedTransactions, setRelatedTransactions] = useState<SafeTransaction[]>([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState('')\n\n  useEffect(() => {\n    const fetchTransaction = async () => {\n      try {\n        setLoading(true)\n\n        // Fetch transaction details\n        const response = await fetch(`/api/safe/transactions?id=${transactionId}`)\n        if (!response.ok) {\n          throw new Error('Failed to load transaction')\n        }\n\n        const transactions = await response.json()\n        if (!transactions || transactions.length === 0) {\n          throw new Error('Transaction not found')\n        }\n\n        const currentTransaction = transactions[0]\n        setTransaction(currentTransaction)\n\n        // If this transaction is part of a shift closure, fetch all related transactions\n        if (currentTransaction.shiftId) {\n          try {\n            // Fetch all transactions for this shift\n            const relatedResponse = await fetch(`/api/safe/transactions?shiftId=${currentTransaction.shiftId}`)\n            if (relatedResponse.ok) {\n              const allShiftTransactions = await relatedResponse.json()\n              // Exclude the current transaction from the list\n              const related = allShiftTransactions.filter((tx: SafeTransaction) =>\n                tx.id !== currentTransaction.id\n              )\n              setRelatedTransactions(related)\n            }\n          } catch (err) {\n            console.warn('Failed to fetch related transactions:', err)\n          }\n        }\n      } catch (err) {\n        console.error('Error fetching transaction:', err)\n        setError(err instanceof Error ? err.message : 'Failed to load transaction')\n      } finally {\n        setLoading(false)\n      }\n    }\n\n    if (transactionId) {\n      fetchTransaction()\n    }\n  }, [transactionId])\n\n  const getTypeLabel = (type: string) => {\n    const labels: Record<string, string> = {\n      CASH_FUEL_SALES: 'Cash from Sales',\n      POS_CARD_PAYMENT: 'POS Card Payment',\n      CREDIT_PAYMENT: 'Credit Payment',\n      CHEQUE_RECEIVED: 'Cheque Received',\n      LOAN_REPAID: 'Loan Repaid',\n      OPENING_BALANCE: 'Opening Balance',\n      EXPENSE: 'Expense',\n      LOAN_GIVEN: 'Loan Given',\n      BANK_DEPOSIT: 'Bank Deposit',\n      CASH_TRANSFER: 'Cash Transfer',\n      COUNT_ADJUSTMENT: 'Count Adjustment'\n    }\n    return labels[type] || type\n  }\n\n  const getTypeIcon = (type: string) => {\n    if (INCOME_TYPES.includes(type)) {\n      return <DollarSign className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n    }\n    return <DollarSign className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n  }\n\n  const getTypeColor = (type: string) => {\n    if (INCOME_TYPES.includes(type)) {\n      return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n    }\n    return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n  }\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  if (error || !transaction) {\n    return (\n      <div className=\"space-y-6 p-6\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.back()}>\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Button>\n          <h1 className=\"text-3xl font-bold text-foreground\">Transaction Details</h1>\n        </div>\n\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>{error || 'Transaction not found'}</AlertDescription>\n        </Alert>\n      </div>\n    )\n  }\n\n  // For shift closures, show a completely redesigned layout\n  if (transaction.shiftId && transaction.shift) {\n    interface BreakdownExpense {\n      type: string\n      amount: number\n      description?: string\n      bankName?: string\n      loanGivenToName?: string\n    }\n\n    interface BreakdownCheque {\n      chequeNumber: string\n      amount: number\n      receivedFrom: string\n      bankName?: string\n    }\n\n    interface PumperBreakdown {\n      pumperName: string\n      calculatedSales: number\n      declaredCash: number\n      declaredAmount: number\n      variance: number\n      varianceStatus: 'ADD_TO_SALARY' | 'DEDUCT_FROM_SALARY' | 'NORMAL'\n      declaredCardAmounts: Record<string, number>\n      declaredCreditAmounts: Record<string, number>\n      declaredCardAmountsWithNames?: Record<string, { terminalName: string }>\n      declaredCreditAmountsWithNames?: Record<string, { customerName: string }>\n      cheques: BreakdownCheque[]\n      expenses: BreakdownExpense[]\n      advanceTaken: number\n    }\n\n    interface DeclaredAmounts {\n      cash: number\n      card: number\n      credit: number\n      cheque: number\n      pumperBreakdown: PumperBreakdown[]\n    }\n\n    const declaredAmounts = transaction.shift.declaredAmounts as unknown as DeclaredAmounts\n    const pumperBreakdowns = declaredAmounts?.pumperBreakdown || []\n\n    // Calculate totals\n    let totalCash = 0\n    let totalCard = 0\n    let totalCredit = 0\n    let totalCheque = 0\n    let totalCalculatedSales = 0\n    let totalDeclared = 0\n    let totalVariance = 0\n\n    if (declaredAmounts) {\n      totalCash = declaredAmounts.cash || 0\n      totalCard = declaredAmounts.card || 0\n      totalCredit = declaredAmounts.credit || 0\n      totalCheque = declaredAmounts.cheque || 0\n    }\n\n    pumperBreakdowns.forEach((bd) => {\n      totalCalculatedSales += bd.calculatedSales || 0\n      totalDeclared += bd.declaredAmount || 0\n      totalVariance += bd.variance || 0\n    })\n\n    const shiftName = transaction.shift.template?.name || 'Shift'\n    const pumpers = transaction.shift.assignments\n      ?.map(a => a.pumper?.name || a.pumperName)\n      .filter((name, index, arr) => name && arr.indexOf(name) === index)\n      .join(', ') || 'Unknown'\n\n    return (\n      <div className=\"space-y-6 p-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <Button variant=\"outline\" onClick={() => router.back()}>\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              Back\n            </Button>\n            <div>\n              <h1 className=\"text-3xl font-bold text-foreground\">Shift Closure Report</h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                {shiftName}  Closed on {new Date(transaction.timestamp).toLocaleDateString()} at {new Date(transaction.timestamp).toLocaleTimeString()}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        {/* Shift Information Card */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <ShoppingCart className=\"h-5 w-5\" />\n              Shift Information\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Shift Name</Label>\n                <div className=\"text-sm font-medium mt-1\">{shiftName}</div>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Pumpers</Label>\n                <div className=\"text-sm font-medium mt-1 flex items-center gap-1\">\n                  <Users className=\"h-3 w-3\" />\n                  {pumpers}\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Closed By</Label>\n                <div className=\"text-sm font-medium mt-1\">{transaction.performedBy}</div>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Date & Time</Label>\n                <div className=\"text-sm font-medium mt-1 flex items-center gap-1\">\n                  <Clock className=\"h-3 w-3\" />\n                  {new Date(transaction.timestamp).toLocaleString()}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Total Money Collected */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <DollarSign className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n              Total Money Collected\n            </CardTitle>\n            <CardDescription>All money collected during this shift and added to safe</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n              <div className=\"p-4 bg-green-500/10 dark:bg-green-500/20 rounded-lg border border-green-500/30\">\n                <div className=\"text-xs text-muted-foreground mb-1\">Cash</div>\n                <div className=\"text-xl font-bold text-green-600 dark:text-green-400 font-mono\">\n                  Rs. {totalCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n              <div className=\"p-4 bg-blue-500/10 dark:bg-blue-500/20 rounded-lg border border-blue-500/30\">\n                <div className=\"text-xs text-muted-foreground mb-1\">Card (POS)</div>\n                <div className=\"text-xl font-bold text-blue-600 dark:text-blue-400 font-mono\">\n                  Rs. {totalCard.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n              <div className=\"p-4 bg-purple-500/10 dark:bg-purple-500/20 rounded-lg border border-purple-500/30\">\n                <div className=\"text-xs text-muted-foreground mb-1\">Credit</div>\n                <div className=\"text-xl font-bold text-purple-600 dark:text-purple-400 font-mono\">\n                  Rs. {totalCredit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n              <div className=\"p-4 bg-orange-500/10 dark:bg-orange-500/20 rounded-lg border border-orange-500/30\">\n                <div className=\"text-xs text-muted-foreground mb-1\">Cheques</div>\n                <div className=\"text-xl font-bold text-orange-600 dark:text-orange-400 font-mono\">\n                  Rs. {totalCheque.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex items-center justify-between p-4 bg-primary/10 dark:bg-primary/20 border-2 border-primary/30 rounded-lg\">\n              <span className=\"text-lg font-bold\">Total Added to Safe:</span>\n              <span className=\"font-mono text-2xl font-bold text-primary\">\n                Rs. {(totalCash + totalCard + totalCredit + totalCheque).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Pumper-wise Breakdown */}\n        {pumperBreakdowns.length > 0 && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Users className=\"h-5 w-5\" />\n                Pumper-wise Breakdown\n              </CardTitle>\n              <CardDescription>Detailed breakdown of sales and collections by each pumper</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {pumperBreakdowns.map((breakdown, idx) => {\n                const totalCard = Object.values(breakdown.declaredCardAmounts || {}).reduce((sum: number, amt) => sum + (amt || 0), 0)\n                const totalCredit = Object.values(breakdown.declaredCreditAmounts || {}).reduce((sum: number, amt) => sum + (amt || 0), 0)\n                const totalCheques = (breakdown.cheques || []).reduce((sum, chq) => sum + (chq.amount || 0), 0)\n                const bankDeposits = (breakdown.expenses || []).filter(exp => exp.type === 'BANK_DEPOSIT')\n                const loans = (breakdown.expenses || []).filter(exp => exp.type === 'LOAN_GIVEN')\n                const otherExpenses = (breakdown.expenses || []).filter(exp => exp.type !== 'BANK_DEPOSIT' && exp.type !== 'LOAN_GIVEN')\n\n                return (\n                  <div key={idx} className=\"border rounded-lg p-5 space-y-4 bg-card\">\n                    {/* Pumper Header */}\n                    <div className=\"flex items-center justify-between border-b pb-3\">\n                      <div>\n                        <h3 className=\"text-lg font-bold\">{breakdown.pumperName}</h3>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Pumper Performance Summary</p>\n                      </div>\n                      <Badge variant={breakdown.varianceStatus === 'ADD_TO_SALARY' ? 'default' : breakdown.varianceStatus === 'DEDUCT_FROM_SALARY' ? 'destructive' : 'outline'}>\n                        {breakdown.varianceStatus === 'ADD_TO_SALARY' ? 'Add to Salary' :\n                          breakdown.varianceStatus === 'DEDUCT_FROM_SALARY' ? 'Deduct from Salary' :\n                            'Normal'}\n                      </Badge>\n                    </div>\n\n                    {/* Sales and Collections */}\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      {/* Left Column - Sales */}\n                      <div className=\"space-y-3\">\n                        <div className=\"text-sm font-semibold text-muted-foreground uppercase border-b pb-2\">Sales</div>\n\n                        <div className=\"space-y-2\">\n                          <div className=\"flex justify-between items-center\">\n                            <span className=\"text-sm text-muted-foreground\">Calculated Sales (from meters):</span>\n                            <span className=\"font-mono font-semibold\">Rs. {breakdown.calculatedSales.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Right Column - Collections */}\n                      <div className=\"space-y-3\">\n                        <div className=\"text-sm font-semibold text-muted-foreground uppercase border-b pb-2\">Money Collected</div>\n\n                        <div className=\"space-y-2\">\n                          {breakdown.declaredCash > 0 && (\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-sm text-muted-foreground\">Cash:</span>\n                              <span className=\"font-mono font-semibold text-green-600 dark:text-green-400\">\n                                Rs. {breakdown.declaredCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          )}\n\n                          {totalCard > 0 && (\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-sm text-muted-foreground\">Card (POS):</span>\n                              <span className=\"font-mono font-semibold text-blue-600 dark:text-blue-400\">\n                                Rs. {totalCard.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          )}\n\n                          {totalCredit > 0 && (\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-sm text-muted-foreground\">Credit:</span>\n                              <span className=\"font-mono font-semibold text-purple-600 dark:text-purple-400\">\n                                Rs. {totalCredit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          )}\n\n                          {totalCheques > 0 && (\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-sm text-muted-foreground\">Cheques:</span>\n                              <span className=\"font-mono font-semibold text-orange-600 dark:text-orange-400\">\n                                Rs. {totalCheques.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Card Details by Terminal */}\n                    {totalCard > 0 && Object.keys(breakdown.declaredCardAmounts || {}).length > 0 && (\n                      <div className=\"border-t pt-3 space-y-2\">\n                        <div className=\"text-sm font-semibold text-muted-foreground\">Card Payments by Terminal</div>\n                        <div className=\"bg-muted/50 rounded p-3 space-y-1\">\n                          {Object.entries(breakdown.declaredCardAmounts || {}).map(([terminalId, amount]) => {\n                            const terminalInfo = breakdown.declaredCardAmountsWithNames?.[terminalId]\n                            const terminalName = terminalInfo?.terminalName || `Terminal ${terminalId}`\n                            return (\n                              <div key={terminalId} className=\"flex justify-between text-sm\">\n                                <span className=\"text-muted-foreground\">{terminalName}:</span>\n                                <span className=\"font-mono\">Rs. {(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                              </div>\n                            )\n                          })}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Credit Details by Customer */}\n                    {totalCredit > 0 && Object.keys(breakdown.declaredCreditAmounts || {}).length > 0 && (\n                      <div className=\"border-t pt-3 space-y-2\">\n                        <div className=\"text-sm font-semibold text-muted-foreground\">Credit Sales by Customer</div>\n                        <div className=\"bg-muted/50 rounded p-3 space-y-1\">\n                          {Object.entries(breakdown.declaredCreditAmounts || {}).map(([customerId, amount]) => {\n                            const customerInfo = breakdown.declaredCreditAmountsWithNames?.[customerId]\n                            const customerName = customerInfo?.customerName || `Customer ${customerId}`\n                            return (\n                              <div key={customerId} className=\"flex justify-between text-sm\">\n                                <span className=\"text-muted-foreground\">{customerName}:</span>\n                                <span className=\"font-mono\">Rs. {(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                              </div>\n                            )\n                          })}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Cheque Details */}\n                    {totalCheques > 0 && breakdown.cheques && breakdown.cheques.length > 0 && (\n                      <div className=\"border-t pt-3 space-y-2\">\n                        <div className=\"text-sm font-semibold text-muted-foreground\">Cheques Received</div>\n                        <div className=\"bg-muted/50 rounded p-3 space-y-1\">\n                          {breakdown.cheques.map((cheque, chqIdx) => (\n                            <div key={chqIdx} className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">\n                                Cheque #{cheque.chequeNumber} from {cheque.receivedFrom}{cheque.bankName ? ` (${cheque.bankName})` : ''}:\n                              </span>\n                              <span className=\"font-mono\">Rs. {(cheque.amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Deductions */}\n                    {(breakdown.advanceTaken > 0 || loans.length > 0 || bankDeposits.length > 0 || otherExpenses.length > 0) && (\n                      <div className=\"border-t pt-3 space-y-2\">\n                        <div className=\"text-sm font-semibold text-muted-foreground text-orange-600 dark:text-orange-400\">Deductions</div>\n                        <div className=\"bg-orange-500/10 dark:bg-orange-500/20 rounded p-3 space-y-1\">\n                          {breakdown.advanceTaken > 0 && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Advance Taken:</span>\n                              <span className=\"font-mono text-orange-600 dark:text-orange-400\">\n                                - Rs. {breakdown.advanceTaken.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          )}\n\n                          {loans.map((loan, loanIdx) => (\n                            <div key={loanIdx} className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Loan to {loan.loanGivenToName || 'Pumper'}:</span>\n                              <span className=\"font-mono text-orange-600 dark:text-orange-400\">\n                                - Rs. {(loan.amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          ))}\n\n                          {otherExpenses.map((expense, expIdx) => (\n                            <div key={expIdx} className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">{expense.description || 'Other Expense'}:</span>\n                              <span className=\"font-mono text-orange-600 dark:text-orange-400\">\n                                - Rs. {(expense.amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Bank Deposits (Additions) */}\n                    {bankDeposits.length > 0 && (\n                      <div className=\"border-t pt-3 space-y-2\">\n                        <div className=\"text-sm font-semibold text-muted-foreground text-blue-600 dark:text-blue-400\">Bank Deposits</div>\n                        <div className=\"bg-blue-500/10 dark:bg-blue-500/20 rounded p-3 space-y-1\">\n                          {bankDeposits.map((deposit, depIdx) => (\n                            <div key={depIdx} className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Bank Deposit ({deposit.bankName || 'Bank'}):</span>\n                              <span className=\"font-mono text-blue-600 dark:text-blue-400\">\n                                + Rs. {(deposit.amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </span>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Summary */}\n                    <div className=\"border-t pt-3 bg-muted/50 rounded-lg p-4\">\n                      <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                        <div className=\"font-semibold\">Total Declared:</div>\n                        <div className=\"font-mono text-right font-semibold\">\n                          Rs. {breakdown.declaredAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                        </div>\n                        <div className=\"font-semibold\">Variance:</div>\n                        <div className={`font-mono text-right font-semibold ${breakdown.variance > 20 ? 'text-red-600 dark:text-red-400' :\n                          breakdown.variance < -20 ? 'text-green-600 dark:text-green-400' :\n                            'text-foreground'\n                          }`}>\n                          {breakdown.variance >= 0 ? '+' : ''}Rs. {breakdown.variance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )\n              })}\n\n              {/* Overall Summary */}\n              <div className=\"border-2 border-primary/30 rounded-lg p-5 bg-primary/10 dark:bg-primary/20\">\n                <div className=\"text-base font-bold uppercase text-primary mb-4\">Overall Shift Summary</div>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div className=\"font-semibold\">Total Calculated Sales:</div>\n                  <div className=\"font-mono text-right font-semibold\">\n                    Rs. {totalCalculatedSales.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n\n                  <div className=\"font-semibold\">Total Cash Collected:</div>\n                  <div className=\"font-mono text-right text-green-600 dark:text-green-400\">\n                    Rs. {totalCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n\n                  <div className=\"font-semibold\">Total Card Collected:</div>\n                  <div className=\"font-mono text-right text-blue-600 dark:text-blue-400\">\n                    Rs. {totalCard.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n\n                  <div className=\"font-semibold\">Total Credit:</div>\n                  <div className=\"font-mono text-right text-purple-600 dark:text-purple-400\">\n                    Rs. {totalCredit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n\n                  <div className=\"font-semibold\">Total Cheques:</div>\n                  <div className=\"font-mono text-right text-orange-600 dark:text-orange-400\">\n                    Rs. {totalCheque.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n\n                  <div className=\"font-bold text-base pt-2 border-t\">Total Declared:</div>\n                  <div className=\"font-mono text-right font-bold text-base pt-2 border-t\">\n                    Rs. {totalDeclared.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n\n                  <div className=\"font-bold text-base\">Total Variance:</div>\n                  <div className={`font-mono text-right font-bold text-base ${totalVariance > 20 ? 'text-red-600 dark:text-red-400' :\n                    totalVariance < -20 ? 'text-green-600 dark:text-green-400' :\n                      'text-foreground'\n                    }`}>\n                    {totalVariance >= 0 ? '+' : ''}Rs. {totalVariance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* POS Batch Details */}\n        {transaction.batch && transaction.type === 'POS_CARD_PAYMENT' && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <CreditCard className=\"h-5 w-5\" />\n                POS Terminal Details\n              </CardTitle>\n              <CardDescription>Card payment breakdown by terminal and card type</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                <div className=\"p-3 bg-blue-500/10 dark:bg-blue-500/20 rounded-lg border\">\n                  <div className=\"text-base font-bold mb-3\">Total POS Amount: Rs. {transaction.batch.totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                  {transaction.batch.terminalEntries && transaction.batch.terminalEntries.length > 0 && (\n                    <div className=\"space-y-3 mt-4\">\n                      {transaction.batch.terminalEntries.map((entry, idx) => {\n                        const terminalTotal = entry.visaAmount + entry.masterAmount + entry.amexAmount + entry.qrAmount + (entry.dialogTouchAmount || 0)\n                        return (\n                          <div key={entry.id} className=\"bg-card p-3 rounded border space-y-2\">\n                            <div className=\"font-semibold text-sm border-b pb-2\">\n                              {idx + 1}. {entry.terminal.name} ({entry.terminal.terminalNumber})\n                              {entry.terminal.bank && `  ${entry.terminal.bank.name}`}\n                            </div>\n\n                            <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                              <div className=\"text-muted-foreground\">Slip Numbers:</div>\n                              <div className=\"font-mono text-right\">{entry.startNumber} - {entry.endNumber}</div>\n\n                              <div className=\"text-muted-foreground\">Transaction Count:</div>\n                              <div className=\"font-mono text-right\">{entry.transactionCount}</div>\n                            </div>\n\n                            <div className=\"pt-2 border-t space-y-1\">\n                              <div className=\"text-xs font-semibold text-muted-foreground uppercase mb-1\">Card Types</div>\n                              {entry.visaAmount > 0 && (\n                                <div className=\"flex justify-between text-sm\">\n                                  <span className=\"text-muted-foreground\">Visa:</span>\n                                  <span className=\"font-mono\">Rs. {entry.visaAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                </div>\n                              )}\n                              {entry.masterAmount > 0 && (\n                                <div className=\"flex justify-between text-sm\">\n                                  <span className=\"text-muted-foreground\">Master:</span>\n                                  <span className=\"font-mono\">Rs. {entry.masterAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                </div>\n                              )}\n                              {entry.amexAmount > 0 && (\n                                <div className=\"flex justify-between text-sm\">\n                                  <span className=\"text-muted-foreground\">Amex:</span>\n                                  <span className=\"font-mono\">Rs. {entry.amexAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                </div>\n                              )}\n                              {entry.qrAmount > 0 && (\n                                <div className=\"flex justify-between text-sm\">\n                                  <span className=\"text-muted-foreground\">QR:</span>\n                                  <span className=\"font-mono\">Rs. {entry.qrAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                </div>\n                              )}\n                            </div>\n\n                            <div className=\"flex justify-between text-sm font-semibold pt-2 border-t\">\n                              <span>Terminal Total:</span>\n                              <span className=\"font-mono\">Rs. {terminalTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Safe Balance Impact */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <DollarSign className=\"h-5 w-5\" />\n              Safe Balance Impact\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-3 gap-4\">\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Balance Before</Label>\n                <div className=\"text-lg font-mono font-semibold mt-1\">\n                  Rs. {transaction.balanceBefore.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Amount Added</Label>\n                <div className=\"text-lg font-mono font-semibold text-green-600 dark:text-green-400 mt-1\">\n                  + Rs. {(totalCash + totalCard + totalCredit + totalCheque).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-xs text-muted-foreground\">Balance After</Label>\n                <div className=\"text-lg font-mono font-semibold mt-1\">\n                  Rs. {transaction.balanceAfter.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    )\n  }\n\n  // For non-shift transactions, show simple transaction details\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"outline\" onClick={() => router.back()}>\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">Transaction Details</h1>\n      </div>\n\n      {/* Transaction Info */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Transaction Information</CardTitle>\n          <CardDescription>Basic transaction details</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label className=\"text-xs text-muted-foreground\">Transaction Type</Label>\n              <div className=\"flex items-center gap-2 mt-1\">\n                {getTypeIcon(transaction.type)}\n                <Badge className={getTypeColor(transaction.type)}>\n                  {getTypeLabel(transaction.type)}\n                </Badge>\n              </div>\n            </div>\n            <div>\n              <Label className=\"text-xs text-muted-foreground\">Date & Time</Label>\n              <div className=\"flex items-center gap-2 mt-1\">\n                <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-sm\">\n                  {new Date(transaction.timestamp).toLocaleString()}\n                </span>\n              </div>\n            </div>\n            <div>\n              <Label className=\"text-xs text-muted-foreground\">Amount</Label>\n              <div className={`text-lg font-bold mt-1 ${INCOME_TYPES.includes(transaction.type) ? 'text-green-700' : 'text-red-700'}`}>\n                {INCOME_TYPES.includes(transaction.type) ? '+' : '-'} Rs. {Math.abs(transaction.amount).toLocaleString()}\n              </div>\n            </div>\n            <div>\n              <Label className=\"text-xs text-muted-foreground\">Performed By</Label>\n              <div className=\"text-sm font-medium mt-1\">{transaction.performedBy}</div>\n            </div>\n            <div>\n              <Label className=\"text-xs text-muted-foreground\">Balance Before</Label>\n              <div className=\"text-sm font-mono mt-1\">\n                Rs. {transaction.balanceBefore.toLocaleString()}\n              </div>\n            </div>\n            <div>\n              <Label className=\"text-xs text-muted-foreground\">Balance After</Label>\n              <div className=\"text-sm font-mono mt-1\">\n                Rs. {transaction.balanceAfter.toLocaleString()}\n              </div>\n            </div>\n          </div>\n\n          {/* Description */}\n          <div>\n            <Label className=\"text-xs text-muted-foreground\">Description</Label>\n            <div className=\"text-sm mt-1 p-3 bg-muted rounded-lg\">\n              {transaction.description}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* POS Batch Details */}\n      {transaction.batch && transaction.type === 'POS_CARD_PAYMENT' && (\n        <Card>\n          <CardHeader>\n            <CardTitle>POS Batch Details</CardTitle>\n            <CardDescription>POS terminal entries and card type breakdown</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"bg-blue-500/10 dark:bg-blue-500/20 p-4 rounded-lg border\">\n              <div className=\"text-base font-bold mb-3\">Total Batch Amount: Rs. {transaction.batch.totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n              {transaction.batch.terminalEntries && transaction.batch.terminalEntries.length > 0 && (\n                <div className=\"space-y-3 mt-4\">\n                  <div className=\"text-xs font-semibold text-muted-foreground uppercase\">Terminal Breakdown</div>\n                  {transaction.batch.terminalEntries.map((entry, idx) => {\n                    const terminalTotal = entry.visaAmount + entry.masterAmount + entry.amexAmount + entry.qrAmount + (entry.dialogTouchAmount || 0)\n                    return (\n                      <div key={entry.id} className=\"bg-card p-3 rounded border space-y-2\">\n                        <div className=\"font-semibold text-sm border-b pb-2\">\n                          {idx + 1}. {entry.terminal.name} ({entry.terminal.terminalNumber})\n                          {entry.terminal.bank && `  ${entry.terminal.bank.name}`}\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                          <div className=\"text-muted-foreground\">Slip Numbers:</div>\n                          <div className=\"font-mono text-right\">{entry.startNumber} - {entry.endNumber}</div>\n\n                          <div className=\"text-muted-foreground\">Transaction Count:</div>\n                          <div className=\"font-mono text-right\">{entry.transactionCount}</div>\n                        </div>\n\n                        <div className=\"pt-2 border-t space-y-1\">\n                          <div className=\"text-xs font-semibold text-muted-foreground uppercase mb-1\">Card Types</div>\n                          {entry.visaAmount > 0 && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Visa:</span>\n                              <span className=\"font-mono\">Rs. {entry.visaAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          )}\n                          {entry.masterAmount > 0 && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Master:</span>\n                              <span className=\"font-mono\">Rs. {entry.masterAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          )}\n                          {entry.amexAmount > 0 && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Amex:</span>\n                              <span className=\"font-mono\">Rs. {entry.amexAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          )}\n                          {entry.qrAmount > 0 && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">QR:</span>\n                              <span className=\"font-mono\">Rs. {entry.qrAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          )}\n                          {(entry.dialogTouchAmount || 0) > 0 && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-muted-foreground\">Dialog Touch:</span>\n                              <span className=\"font-mono\">Rs. {(entry.dialogTouchAmount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                            </div>\n                          )}\n                        </div>\n\n                        <div className=\"flex justify-between text-sm font-semibold pt-2 border-t\">\n                          <span>Terminal Total:</span>\n                          <span className=\"font-mono\">Rs. {terminalTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Cheque Details */}\n      {transaction.cheque && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Cheque Details</CardTitle>\n            <CardDescription>Cheque information</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"bg-orange-500/10 dark:bg-orange-500/20 p-3 rounded-lg space-y-1 text-sm\">\n              <div><span className=\"font-medium\">Cheque Number:</span> {transaction.cheque.chequeNumber}</div>\n              <div><span className=\"font-medium\">Amount:</span> Rs. {transaction.cheque.amount.toLocaleString()}</div>\n              {transaction.cheque.bank && (\n                <div><span className=\"font-medium\">Bank:</span> {transaction.cheque.bank.name}</div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\salary\\[pumperId]\\loans\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Edit' is defined but never used.","line":12,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'router' is assigned a value but never used.","line":25,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":47,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoading' is assigned a value but never used.","line":47,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":29},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchPumperLoans'. Either include it or remove the dependency array.","line":64,"column":6,"nodeType":"ArrayExpression","endLine":64,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, pumperName, fetchPumperLoans]","fix":{"range":[2533,2562],"text":"[selectedStation, pumperName, fetchPumperLoans]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalLoanAmount' is assigned a value but never used.","line":196,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":196,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect, useMemo } from 'react'\r\nimport { useParams, useSearchParams, useRouter } from 'next/navigation'\r\nimport { useStation } from '@/contexts/StationContext'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport {\r\n  ArrowLeft,\r\n  CreditCard,\r\n  Edit,\r\n  DollarSign\r\n} from 'lucide-react'\r\nimport Link from 'next/link'\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Textarea } from '@/components/ui/textarea'\r\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\r\n\r\nexport default function PumperLoansPage() {\r\n  const params = useParams()\r\n  const searchParams = useSearchParams()\r\n  const router = useRouter()\r\n  const { selectedStation } = useStation()\r\n\r\n  const pumperId = useMemo(() => (params?.pumperId as string) || '', [params])\r\n  const pumperName = useMemo(() => searchParams?.get('pumperName') || 'Unknown', [searchParams])\r\n\r\n  interface Loan {\r\n    id: string\r\n    stationId: string\r\n    pumperId: string\r\n    pumperName: string\r\n    amount: number\r\n    monthlyRental?: number\r\n    paidAmount?: number\r\n    status: 'ACTIVE' | 'PAID' | 'DEFAULTED'\r\n    reason: string\r\n    givenBy?: string\r\n    dueDate: string\r\n    createdAt: string\r\n    updatedAt: string\r\n  }\r\n\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState('')\r\n  const [success, setSuccess] = useState('')\r\n  const [pumperLoans, setPumperLoans] = useState<Loan[]>([])\r\n  const [loadingLoans, setLoadingLoans] = useState(false)\r\n  const [editingLoanId, setEditingLoanId] = useState<string | null>(null)\r\n  const [editingMonthlyRental, setEditingMonthlyRental] = useState<number | undefined>(undefined)\r\n  const [loanPaymentDialogOpen, setLoanPaymentDialogOpen] = useState(false)\r\n  const [selectedLoanForPayment, setSelectedLoanForPayment] = useState<Loan | null>(null)\r\n  const [loanPaymentAmount, setLoanPaymentAmount] = useState<number | undefined>(undefined)\r\n  const [loanPaymentNotes, setLoanPaymentNotes] = useState('')\r\n  const [processingLoanPayment, setProcessingLoanPayment] = useState(false)\r\n\r\n  useEffect(() => {\r\n    if (selectedStation && pumperName) {\r\n      fetchPumperLoans()\r\n    }\r\n  }, [selectedStation, pumperName])\r\n\r\n  const fetchPumperLoans = async () => {\r\n    if (!selectedStation || !pumperName) return\r\n\r\n    try {\r\n      setLoadingLoans(true)\r\n      setError('')\r\n      // Fetch all loans (not just active) to show history\r\n      const res = await fetch(`/api/loans/pumper?stationId=${selectedStation}&pumperName=${encodeURIComponent(pumperName)}`)\r\n      if (res.ok) {\r\n        const data = await res.json()\r\n        setPumperLoans(data)\r\n      } else {\r\n        const errorData = await res.json().catch(() => ({}))\r\n        setError(errorData.error || 'Failed to fetch loans')\r\n      }\r\n    } catch (err) {\r\n      console.error('Error fetching pumper loans:', err)\r\n      setError('Failed to fetch loans')\r\n    } finally {\r\n      setLoadingLoans(false)\r\n    }\r\n  }\r\n\r\n  const handleUpdateMonthlyRental = async (loanId: string, newMonthlyRental: number) => {\r\n    try {\r\n      setError('')\r\n      const res = await fetch(`/api/loans/pumper/${loanId}`, {\r\n        method: 'PUT',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          monthlyRental: newMonthlyRental\r\n        })\r\n      })\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}))\r\n        throw new Error(errorData.error || 'Failed to update monthly rental')\r\n      }\r\n\r\n      await fetchPumperLoans()\r\n\r\n      setEditingLoanId(null)\r\n      setEditingMonthlyRental(undefined)\r\n      setSuccess('Monthly rental updated successfully!')\r\n      setTimeout(() => {\r\n        setSuccess('')\r\n      }, 3000)\r\n    } catch (err) {\r\n      setSuccess('')\r\n      setError(err instanceof Error ? err.message : 'Failed to update monthly rental')\r\n      setTimeout(() => {\r\n        setError('')\r\n      }, 5000)\r\n    }\r\n  }\r\n\r\n  const handleCancelEdit = () => {\r\n    setEditingLoanId(null)\r\n    setEditingMonthlyRental(undefined)\r\n  }\r\n\r\n  const handleStartEdit = (loan: Loan) => {\r\n    setEditingLoanId(loan.id)\r\n    setEditingMonthlyRental(loan.monthlyRental || 0)\r\n  }\r\n\r\n  const handlePayLoan = (loan: Loan) => {\r\n    const remainingAmount = loan.amount - (loan.paidAmount || 0)\r\n    setSelectedLoanForPayment(loan)\r\n    setLoanPaymentAmount(remainingAmount > 0 ? remainingAmount : loan.amount)\r\n    setLoanPaymentNotes('')\r\n    setLoanPaymentDialogOpen(true)\r\n  }\r\n\r\n  const handleProcessLoanPayment = async () => {\r\n    if (!selectedLoanForPayment || loanPaymentAmount === undefined || loanPaymentAmount <= 0) {\r\n      setError('Please enter a valid payment amount')\r\n      return\r\n    }\r\n\r\n    if (!selectedStation) {\r\n      setError('Please select a station')\r\n      return\r\n    }\r\n\r\n    try {\r\n      setProcessingLoanPayment(true)\r\n      setError('')\r\n\r\n      const username = typeof window !== 'undefined' ? localStorage.getItem('username') || 'System' : 'System'\r\n\r\n      const res = await fetch(`/api/loans/pumper/${selectedLoanForPayment.id}/pay`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          stationId: selectedStation,\r\n          amount: loanPaymentAmount,\r\n          notes: loanPaymentNotes || undefined,\r\n          performedBy: username\r\n        })\r\n      })\r\n\r\n      if (!res.ok) {\r\n        const errorData = await res.json().catch(() => ({}))\r\n        throw new Error(errorData.error || 'Failed to process loan payment')\r\n      }\r\n\r\n      // Refresh loans list to show updated status\r\n      await fetchPumperLoans()\r\n\r\n      setLoanPaymentDialogOpen(false)\r\n      setSelectedLoanForPayment(null)\r\n      setLoanPaymentAmount(undefined)\r\n      setLoanPaymentNotes('')\r\n      setSuccess('Loan payment processed successfully! Money has been added to safe.')\r\n      setTimeout(() => {\r\n        setSuccess('')\r\n      }, 5000)\r\n    } catch (err) {\r\n      setSuccess('')\r\n      setError(err instanceof Error ? err.message : 'Failed to process loan payment')\r\n      setTimeout(() => setError(''), 5000)\r\n    } finally {\r\n      setProcessingLoanPayment(false)\r\n    }\r\n  }\r\n\r\n  const activeLoans = pumperLoans.filter(loan => loan.status === 'ACTIVE')\r\n  const paidLoans = pumperLoans.filter(loan => loan.status === 'PAID')\r\n  const totalMonthlyRental = activeLoans.reduce((sum, loan) => sum + (loan.monthlyRental || 0), 0)\r\n  const totalLoanAmount = pumperLoans.reduce((sum, loan) => sum + loan.amount, 0)\r\n  const totalPaidAmount = pumperLoans.reduce((sum, loan) => sum + (loan.paidAmount || 0), 0)\r\n  const totalOutstanding = activeLoans.reduce((sum, loan) => {\r\n    const paidAmount = loan.paidAmount || 0\r\n    return sum + (loan.amount - paidAmount)\r\n  }, 0)\r\n\r\n  return (\r\n    <div className=\"container mx-auto py-6 space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <div className=\"flex items-center gap-2 mb-2\">\r\n            <Link href={`/salary/${pumperId}`}>\r\n              <Button variant=\"ghost\" size=\"sm\">\r\n                <ArrowLeft className=\"h-4 w-4 mr-2\" />\r\n                Back to Salary\r\n              </Button>\r\n            </Link>\r\n          </div>\r\n          <h1 className=\"text-3xl font-bold\">Loan Management - {pumperName}</h1>\r\n          <p className=\"text-muted-foreground mt-1\">View and manage all loans and payments</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Summary Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Active Loans</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{activeLoans.length}</div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Outstanding</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold text-orange-600\">\r\n              Rs. {totalOutstanding.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Monthly Rental</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold text-red-600\">\r\n              Rs. {totalMonthlyRental.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Paid</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold text-green-600\">\r\n              Rs. {totalPaidAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Messages */}\r\n      {success && (\r\n        <div className=\"p-4 bg-green-500/10 border border-green-500/20 rounded-lg\">\r\n          <p className=\"text-sm text-green-600 font-medium\">{success}</p>\r\n        </div>\r\n      )}\r\n      {error && (\r\n        <div className=\"p-4 bg-red-500/10 border border-red-500/20 rounded-lg\">\r\n          <p className=\"text-sm text-red-600\">{error}</p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Active Loans */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-xl flex items-center gap-2\">\r\n            <CreditCard className=\"h-5 w-5\" />\r\n            Active Loans\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Loans currently active and being deducted from salary\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {loadingLoans ? (\r\n            <div className=\"flex items-center justify-center py-8\">\r\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600\"></div>\r\n            </div>\r\n          ) : activeLoans.length === 0 ? (\r\n            <div className=\"text-center py-8 text-muted-foreground\">\r\n              <CreditCard className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\r\n              <p>No active loans found</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Loan Amount</TableHead>\r\n                    <TableHead>Monthly Rental</TableHead>\r\n                    <TableHead>Status</TableHead>\r\n                    <TableHead>Created Date</TableHead>\r\n                    <TableHead>Due Date</TableHead>\r\n                    <TableHead>Reason</TableHead>\r\n                    <TableHead className=\"text-right\">Actions</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {activeLoans.map((loan) => {\r\n                    const paidAmount = loan.paidAmount || 0\r\n                    const remainingAmount = loan.amount - paidAmount\r\n                    return (\r\n                      <TableRow key={loan.id}>\r\n                        <TableCell className=\"font-mono\">\r\n                          Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                        </TableCell>\r\n                        <TableCell className=\"font-mono text-green-600\">\r\n                          Rs. {paidAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                        </TableCell>\r\n                        <TableCell className=\"font-mono font-semibold text-orange-600\">\r\n                          Rs. {remainingAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          {editingLoanId === loan.id ? (\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <MoneyInput\r\n                                value={editingMonthlyRental}\r\n                                onChange={(value) => setEditingMonthlyRental(value)}\r\n                                className=\"w-32\"\r\n                              />\r\n                              <Button\r\n                                size=\"sm\"\r\n                                onClick={() => editingMonthlyRental !== undefined && handleUpdateMonthlyRental(loan.id, editingMonthlyRental)}\r\n                              >\r\n                                Save\r\n                              </Button>\r\n                              <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                onClick={handleCancelEdit}\r\n                              >\r\n                                Cancel\r\n                              </Button>\r\n                            </div>\r\n                          ) : (\r\n                            <span\r\n                              className=\"font-mono cursor-pointer hover:text-orange-600 hover:underline\"\r\n                              onClick={() => handleStartEdit(loan)}\r\n                              title=\"Click to edit monthly rental\"\r\n                            >\r\n                              Rs. {(loan.monthlyRental || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                            </span>\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Badge variant={loan.status === 'ACTIVE' ? 'default' : loan.status === 'PAID' ? 'secondary' : 'destructive'}>\r\n                            {loan.status}\r\n                          </Badge>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          {new Date(loan.createdAt).toLocaleDateString()}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          {new Date(loan.dueDate).toLocaleDateString()}\r\n                        </TableCell>\r\n                        <TableCell className=\"max-w-xs\">\r\n                          <div className=\"space-y-1\">\r\n                            <div className=\"font-medium\">{loan.reason}</div>\r\n                            {loan.reason?.toLowerCase().includes('loan given from safe') && loan.givenBy && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Given by: {loan.givenBy}\r\n                              </div>\r\n                            )}\r\n                            {loan.reason?.toLowerCase().includes('shift close') && loan.givenBy && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Given by: {loan.givenBy} | Taken by: {loan.pumperName}\r\n                              </div>\r\n                            )}\r\n                            {loan.reason?.toLowerCase().includes('shift close') && !loan.givenBy && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Taken by: {loan.pumperName}\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          {editingLoanId === loan.id ? (\r\n                            <span className=\"text-xs text-muted-foreground\">Editing...</span>\r\n                          ) : (\r\n                            <Button\r\n                              size=\"sm\"\r\n                              variant=\"default\"\r\n                              onClick={() => handlePayLoan(loan)}\r\n                            >\r\n                              <DollarSign className=\"h-4 w-4 mr-1\" />\r\n                              Pay Loan\r\n                            </Button>\r\n                          )}\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    )\r\n                  })}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Paid Loans */}\r\n      {paidLoans.length > 0 && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-xl flex items-center gap-2\">\r\n              <CreditCard className=\"h-5 w-5\" />\r\n              Paid Loans\r\n            </CardTitle>\r\n            <CardDescription>\r\n              Loans that have been fully paid\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Loan Amount</TableHead>\r\n                  <TableHead>Paid</TableHead>\r\n                  <TableHead>Remaining</TableHead>\r\n                  <TableHead>Monthly Rental</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead>Created Date</TableHead>\r\n                  <TableHead>Due Date</TableHead>\r\n                  <TableHead>Reason</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {paidLoans.map((loan) => {\r\n                  const paidAmount = loan.paidAmount || 0\r\n                  const remainingAmount = loan.amount - paidAmount\r\n                  return (\r\n                    <TableRow key={loan.id}>\r\n                      <TableCell className=\"font-mono\">\r\n                        Rs. {loan.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                      </TableCell>\r\n                      <TableCell className=\"font-mono text-green-600\">\r\n                        Rs. {paidAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                      </TableCell>\r\n                      <TableCell className=\"font-mono font-semibold text-muted-foreground\">\r\n                        Rs. {remainingAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                      </TableCell>\r\n                      <TableCell className=\"font-mono\">\r\n                        Rs. {(loan.monthlyRental || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"secondary\">\r\n                          {loan.status}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {new Date(loan.createdAt).toLocaleDateString()}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {new Date(loan.dueDate).toLocaleDateString()}\r\n                      </TableCell>\r\n                      <TableCell className=\"max-w-xs\">\r\n                        <div className=\"space-y-1\">\r\n                          <div className=\"font-medium\">{loan.reason}</div>\r\n                          {loan.givenBy && (\r\n                            <div className=\"text-xs text-muted-foreground\">\r\n                              Given by: {loan.givenBy}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  )\r\n                })}\r\n              </TableBody>\r\n            </Table>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Loan Payment Dialog */}\r\n      <Dialog open={loanPaymentDialogOpen} onOpenChange={setLoanPaymentDialogOpen}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Pay Loan - {selectedLoanForPayment?.pumperName}</DialogTitle>\r\n            <DialogDescription>\r\n              Record a loan payment. This will add money to the safe and update the loan status.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          {selectedLoanForPayment && (\r\n            <div className=\"space-y-4 py-4\">\r\n              <div className=\"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg\">\r\n                <div className=\"text-sm font-medium mb-2\">Loan Details</div>\r\n                <div className=\"text-sm space-y-1 text-muted-foreground\">\r\n                  <div>Loan Amount: Rs. {selectedLoanForPayment.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\r\n                  <div>Paid: Rs. {(selectedLoanForPayment.paidAmount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\r\n                  <div>Remaining: Rs. {(selectedLoanForPayment.amount - (selectedLoanForPayment.paidAmount || 0)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\r\n                  <div>Monthly Rental: Rs. {(selectedLoanForPayment.monthlyRental || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\r\n                  <div>Reason: {selectedLoanForPayment.reason}</div>\r\n                </div>\r\n              </div>\r\n              <div>\r\n                <Label>Payment Amount (Rs.)</Label>\r\n                <MoneyInput\r\n                  value={loanPaymentAmount}\r\n                  onChange={(value) => setLoanPaymentAmount(value)}\r\n                  placeholder=\"Enter payment amount\"\r\n                />\r\n                <p className=\"text-xs text-muted-foreground mt-1\">\r\n                  Remaining: Rs. {(selectedLoanForPayment.amount - (selectedLoanForPayment.paidAmount || 0)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                </p>\r\n              </div>\r\n              <div>\r\n                <Label>Notes (Optional)</Label>\r\n                <Textarea\r\n                  value={loanPaymentNotes}\r\n                  onChange={(e) => setLoanPaymentNotes(e.target.value)}\r\n                  placeholder=\"Add any notes about this payment\"\r\n                  rows={3}\r\n                />\r\n              </div>\r\n              <div className=\"flex justify-end gap-2 pt-4\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => {\r\n                    setLoanPaymentDialogOpen(false)\r\n                    setSelectedLoanForPayment(null)\r\n                    setLoanPaymentAmount(undefined)\r\n                    setLoanPaymentNotes('')\r\n                  }}\r\n                  disabled={processingLoanPayment}\r\n                >\r\n                  Cancel\r\n                </Button>\r\n                <Button\r\n                  onClick={handleProcessLoanPayment}\r\n                  disabled={processingLoanPayment || loanPaymentAmount === undefined || loanPaymentAmount <= 0}\r\n                >\r\n                  {processingLoanPayment ? 'Processing...' : 'Pay Loan'}\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\salary\\[pumperId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'success' is assigned a value but never used.","line":92,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSuccess' is assigned a value but never used.","line":92,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loanRepayDialogOpen' is assigned a value but never used.","line":95,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoanRepayDialogOpen' is assigned a value but never used.","line":95,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":53},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchPaymentHistory' and 'fetchSalaryData'. Either include them or remove the dependency array.","line":122,"column":6,"nodeType":"ArrayExpression","endLine":122,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, pumperId, month, fetchSalaryData, fetchPaymentHistory]","fix":{"range":[3786,3820],"text":"[selectedStation, pumperId, month, fetchSalaryData, fetchPaymentHistory]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchPaymentHistory', 'isProcessingPayment', 'month', 'pumperId', and 'selectedStation'. Either include them or remove the dependency array.","line":129,"column":6,"nodeType":"ArrayExpression","endLine":129,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [fetchPaymentHistory, isProcessingPayment, month, paymentDialogOpen, pumperId, selectedStation]","fix":{"range":[4050,4069],"text":"[fetchPaymentHistory, isProcessingPayment, month, paymentDialogOpen, pumperId, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useMemo } from 'react'\nimport { useParams, useSearchParams, useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  DollarSign,\n  Clock,\n  TrendingUp,\n  User,\n  Calendar,\n  ArrowLeft,\n  Download,\n  CheckCircle,\n  XCircle,\n  CreditCard,\n  Settings,\n  FileText\n} from 'lucide-react'\nimport Link from 'next/link'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\n\ninterface SalaryData {\n  pumperId: string\n  pumperName: string\n  employeeId?: string\n  baseSalary: number\n  holidayAllowance?: number\n  restDaysTaken?: number\n  daysWorked?: number\n  shiftCount: number\n  totalHours: number\n  totalOvertimeHours?: number\n  totalOvertimeAmount?: number\n  commission?: number\n  totalSales: number\n  totalAdvances: number\n  totalLoans: number\n  totalLoanAmount?: number\n  varianceAdd: number\n  varianceDeduct: number\n  epf?: number\n  netSalary: number\n  shiftDetails: Array<{\n    shiftId: string\n    date: string\n    hours: number\n    sales: number\n    advance: number\n    variance: number\n    varianceStatus: string\n    overtimeHours?: number\n    overtimeAmount?: number\n  }>\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nexport default function PumperSalaryDetailsPage() {\n  const params = useParams()\n  const searchParams = useSearchParams()\n  const router = useRouter()\n  const { selectedStation } = useStation()\n\n  // Extract values immediately using useMemo to avoid Next.js 15 enumeration issues\n  const pumperId = useMemo(() => (params?.pumperId as string) || '', [params])\n  const month = useMemo(() => searchParams?.get('month') || '', [searchParams])\n  const pumperName = useMemo(() => searchParams?.get('pumperName') || 'Unknown', [searchParams])\n\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n  const [salaryData, setSalaryData] = useState<SalaryData | null>(null)\n  const [paymentDialogOpen, setPaymentDialogOpen] = useState(false)\n  const [loanRepayDialogOpen, setLoanRepayDialogOpen] = useState(false)\n  interface PaymentHistoryItem {\n    id: string\n    paymentDate: string\n    paymentMethod: string\n    paymentReference?: string\n    notes?: string\n    status: string\n    netSalary: number\n    paidBy: string\n  }\n  const [paymentHistory, setPaymentHistory] = useState<PaymentHistoryItem[]>([])\n  const [isProcessingPayment, setIsProcessingPayment] = useState(false)\n  const [paymentForm, setPaymentForm] = useState({\n    paymentMethod: 'CASH' as 'CASH' | 'CHEQUE' | 'BANK_TRANSFER',\n    paymentReference: '',\n    notes: ''\n  })\n\n  // Check if payment already exists and is paid\n  const hasPaidPayment = paymentHistory.some(p => p.status === 'PAID')\n\n  useEffect(() => {\n    if (selectedStation && pumperId && month) {\n      fetchSalaryData()\n      fetchPaymentHistory()\n    }\n  }, [selectedStation, pumperId, month])\n\n  // Re-fetch payment history when dialog closes to update hasPaidPayment\n  useEffect(() => {\n    if (!paymentDialogOpen && selectedStation && pumperId && month && !isProcessingPayment) {\n      fetchPaymentHistory()\n    }\n  }, [paymentDialogOpen])\n\n  const fetchPaymentHistory = async () => {\n    if (!selectedStation || !pumperId || !month) return\n\n    try {\n      const res = await fetch(`/api/salary/payments?stationId=${selectedStation}&pumperId=${pumperId}&month=${month}`)\n      if (res.ok) {\n        const data = await res.json()\n        setPaymentHistory(data)\n      }\n    } catch (err) {\n      console.error('Error fetching payment history:', err)\n    }\n  }\n\n  const handleMarkAsPaid = async () => {\n    // Prevent multiple clicks\n    if (isProcessingPayment || !selectedStation || !salaryData || !month || hasPaidPayment) {\n      return\n    }\n\n    try {\n      setIsProcessingPayment(true)\n      setLoading(true)\n      setError('')\n      const username = typeof window !== 'undefined' ? localStorage.getItem('username') || 'System User' : 'System User'\n\n      const response = await fetch('/api/salary/payments', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          pumperId: salaryData.pumperId,\n          paymentMonth: month,\n          baseSalary: salaryData.baseSalary,\n          varianceAdd: salaryData.varianceAdd,\n          varianceDeduct: salaryData.varianceDeduct,\n          advances: salaryData.totalAdvances,\n          loans: salaryData.totalLoans,\n          netSalary: salaryData.netSalary,\n          paymentDate: new Date().toISOString(),\n          paymentMethod: paymentForm.paymentMethod,\n          paymentReference: paymentForm.paymentReference || undefined,\n          paidBy: username,\n          notes: paymentForm.notes || undefined,\n          status: 'PAID'\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        const errorMessage = errorData.error || 'Failed to record payment'\n\n        // Handle \"already paid\" case gracefully\n        if (errorMessage.includes('already recorded and paid')) {\n          await fetchPaymentHistory() // Refresh to get the existing payment\n          setPaymentDialogOpen(false)\n          setPaymentForm({ paymentMethod: 'CASH', paymentReference: '', notes: '' })\n          setError('Payment has already been recorded for this month.')\n          return\n        }\n\n        throw new Error(errorMessage)\n      }\n\n      await fetchPaymentHistory()\n      setPaymentDialogOpen(false)\n      setPaymentForm({ paymentMethod: 'CASH', paymentReference: '', notes: '' })\n      setError('') // Clear any previous errors\n      // Use a better notification method instead of alert\n      if (typeof window !== 'undefined') {\n        // You can replace this with a toast notification if available\n        console.log('Salary payment recorded successfully!')\n      }\n    } catch (err) {\n      console.error('Error marking salary as paid:', err)\n      const errorMessage = err instanceof Error ? err.message : 'Failed to record payment'\n      setError(errorMessage)\n\n      // If it's an \"already paid\" error, refresh payment history\n      if (errorMessage.includes('already') || errorMessage.includes('recorded')) {\n        await fetchPaymentHistory()\n      }\n    } finally {\n      setLoading(false)\n      setIsProcessingPayment(false)\n    }\n  }\n\n  const fetchSalaryData = async () => {\n    if (!selectedStation || !pumperId || !month) return\n\n    try {\n      setLoading(true)\n      setError('')\n\n      const res = await fetch(`/api/salary?stationId=${selectedStation}&month=${month}&pumperId=${pumperId}`)\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to fetch salary data')\n      }\n\n      const data = await res.json()\n\n      // If pumperId is specified, the API should return data for that pumper\n      // If not found in array, check if it's an empty result\n      let pumperData = data.salaryData?.find((p: SalaryData) => p.pumperId === pumperId)\n\n      // If not found and salaryData exists, it might be the first (and only) item\n      if (!pumperData && data.salaryData && data.salaryData.length > 0) {\n        pumperData = data.salaryData[0]\n      }\n\n      // If still not found, create empty data structure\n      if (!pumperData) {\n        pumperData = {\n          pumperId: pumperId,\n          pumperName: pumperName || 'Unknown',\n          employeeId: undefined,\n          baseSalary: 0,\n          shiftCount: 0,\n          totalHours: 0,\n          totalSales: 0,\n          totalAdvances: 0,\n          totalLoans: 0,\n          varianceAdd: 0,\n          varianceDeduct: 0,\n          netSalary: 0,\n          shiftDetails: []\n        }\n      }\n\n      setSalaryData(pumperData)\n    } catch (err) {\n      console.error('Error fetching salary data:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load salary data')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Parse month safely (format: YYYY-MM)\n  const monthParts = month.split('-')\n  const year = monthParts[0] || new Date().getFullYear().toString()\n  const monthNum = monthParts[1] || String(new Date().getMonth() + 1).padStart(2, '0')\n  const monthLabel = months.find(m => m.value === monthNum)?.label || monthNum\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  if (error || !salaryData) {\n    return (\n      <div className=\"space-y-6 p-6\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.back()}>\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Monthly Salary Report</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              {pumperName} - {monthLabel} {year}\n            </p>\n          </div>\n        </div>\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-red-600\">{error || 'Salary data not found'}</p>\n          </CardContent>\n        </Card>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.back()}>\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n              <User className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n              Monthly Salary Report\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              {salaryData.pumperName} {salaryData.employeeId && `(${salaryData.employeeId})`} - {monthLabel} {year}\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Dialog open={paymentDialogOpen} onOpenChange={(open) => {\n            // Prevent closing dialog while processing\n            if (isProcessingPayment) {\n              return\n            }\n            setPaymentDialogOpen(open)\n            if (!open) {\n              setError('')\n              // Reset form if canceled\n              if (!hasPaidPayment) {\n                setPaymentForm({ paymentMethod: 'CASH', paymentReference: '', notes: '' })\n              }\n            }\n          }}>\n            <DialogTrigger asChild>\n              <Button\n                variant=\"default\"\n                disabled={!salaryData || salaryData.netSalary <= 0 || hasPaidPayment || isProcessingPayment}\n              >\n                <CheckCircle className=\"h-4 w-4 mr-2\" />\n                {hasPaidPayment ? 'Already Paid' : isProcessingPayment ? 'Processing...' : 'Mark as Paid'}\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Record Salary Payment</DialogTitle>\n                <DialogDescription>\n                  Record that salary has been paid to {salaryData?.pumperName}\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                {hasPaidPayment && (\n                  <div className=\"p-3 bg-green-500/10 border border-green-500/20 rounded-lg\">\n                    <p className=\"text-sm text-green-600 font-medium\">\n                       Payment already recorded for this month\n                    </p>\n                  </div>\n                )}\n                {error && (\n                  <div className=\"p-3 bg-red-500/10 border border-red-500/20 rounded-lg\">\n                    <p className=\"text-sm text-red-600\">{error}</p>\n                  </div>\n                )}\n                <div>\n                  <Label>Net Salary Amount</Label>\n                  <Input\n                    value={`Rs. ${salaryData?.netSalary.toLocaleString() || 0}`}\n                    disabled\n                    className=\"bg-muted\"\n                  />\n                </div>\n                <div>\n                  <Label>Payment Method</Label>\n                  <Select\n                    value={paymentForm.paymentMethod}\n                    disabled={isProcessingPayment || hasPaidPayment}\n                    onValueChange={(value: 'CASH' | 'CHEQUE' | 'BANK_TRANSFER') =>\n                      setPaymentForm({ ...paymentForm, paymentMethod: value })\n                    }\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"CASH\">Cash</SelectItem>\n                      <SelectItem value=\"CHEQUE\">Cheque</SelectItem>\n                      <SelectItem value=\"BANK_TRANSFER\">Bank Transfer</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                {(paymentForm.paymentMethod === 'CHEQUE' || paymentForm.paymentMethod === 'BANK_TRANSFER') && (\n                  <div>\n                    <Label>Reference Number</Label>\n                    <Input\n                      placeholder={paymentForm.paymentMethod === 'CHEQUE' ? 'Cheque number' : 'Transfer reference'}\n                      value={paymentForm.paymentReference}\n                      disabled={isProcessingPayment || hasPaidPayment}\n                      onChange={(e) => setPaymentForm({ ...paymentForm, paymentReference: e.target.value })}\n                    />\n                  </div>\n                )}\n                <div>\n                  <Label>Notes (Optional)</Label>\n                  <Textarea\n                    placeholder=\"Additional notes...\"\n                    value={paymentForm.notes}\n                    disabled={isProcessingPayment || hasPaidPayment}\n                    onChange={(e) => setPaymentForm({ ...paymentForm, notes: e.target.value })}\n                  />\n                </div>\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setPaymentDialogOpen(false)\n                      setError('')\n                    }}\n                    disabled={isProcessingPayment}\n                  >\n                    {hasPaidPayment ? 'Close' : 'Cancel'}\n                  </Button>\n                  {!hasPaidPayment && (\n                    <Button\n                      onClick={handleMarkAsPaid}\n                      disabled={loading || isProcessingPayment || hasPaidPayment}\n                    >\n                      {isProcessingPayment ? 'Processing...' : 'Record Payment'}\n                    </Button>\n                  )}\n                </div>\n              </div>\n            </DialogContent>\n          </Dialog>\n          <Button variant=\"outline\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export PDF\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={() => router.push(`/settings/pumpers`)}\n          >\n            <Settings className=\"h-4 w-4 mr-2\" />\n            Edit Base Salary\n          </Button>\n        </div>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <Clock className=\"h-4 w-4 text-blue-600\" />\n              Total OT\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\">\n              Rs. {(salaryData.totalOvertimeAmount || 0).toLocaleString()}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {(salaryData.totalOvertimeHours || 0).toFixed(1)} hours\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <TrendingUp className=\"h-4 w-4 text-green-600\" />\n              Total Commission\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\">\n              Rs. {(salaryData.commission || 0).toLocaleString()}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              From Rs. {salaryData.totalSales.toLocaleString()} sales\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <Calendar className=\"h-4 w-4\" />\n              Days Worked\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {salaryData.daysWorked || 0} days\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {salaryData.shiftCount} shifts\n            </p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <DollarSign className=\"h-4 w-4\" />\n              Net Salary\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${salaryData.netSalary >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              Rs. {salaryData.netSalary.toLocaleString()}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Deductions and Additions */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <Card className=\"border-red-500/20 bg-red-500/5\">\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Deductions</CardTitle>\n            <CardDescription>Amounts deducted from salary</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {salaryData.epf && salaryData.epf > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n                <span className=\"text-sm font-medium\">EPF (8%):</span>\n                <span className=\"font-semibold text-red-600 text-lg\">\n                  -Rs. {salaryData.epf.toLocaleString()}\n                </span>\n              </div>\n            )}\n            <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n              <span className=\"text-sm font-medium\">Advances Taken:</span>\n              <span className=\"font-semibold text-red-600 text-lg\">\n                -Rs. {salaryData.totalAdvances.toLocaleString()}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n              <span className=\"text-sm font-medium\">Loans:</span>\n              <span className=\"font-semibold text-red-600 text-lg\">\n                -Rs. {salaryData.totalLoans.toLocaleString()}\n              </span>\n            </div>\n            {salaryData.varianceDeduct > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-red-500/30\">\n                <span className=\"text-sm font-medium\">Variance Deductions:</span>\n                <span className=\"font-semibold text-red-600 text-lg\">\n                  -Rs. {salaryData.varianceDeduct.toLocaleString()}\n                </span>\n              </div>\n            )}\n            <div className=\"pt-2 border-t\">\n              <div className=\"flex justify-between items-center\">\n                <span className=\"font-semibold\">Total Deductions:</span>\n                <span className=\"font-bold text-red-600 text-xl\">\n                  -Rs. {((salaryData.epf || 0) + salaryData.totalAdvances + salaryData.totalLoans + salaryData.varianceDeduct).toLocaleString()}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-green-500/20 bg-green-500/5\">\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Additions</CardTitle>\n            <CardDescription>Amounts added to salary</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {salaryData.holidayAllowance !== undefined && salaryData.holidayAllowance > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Holiday Allowance:</span>\n                <span className=\"font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.holidayAllowance.toLocaleString()}\n                </span>\n                {salaryData.restDaysTaken !== undefined && salaryData.restDaysTaken > 0 && (\n                  <span className=\"text-xs text-muted-foreground ml-2\">\n                    ({salaryData.restDaysTaken} rest days deducted)\n                  </span>\n                )}\n              </div>\n            )}\n            {salaryData.totalOvertimeAmount && salaryData.totalOvertimeAmount > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Overtime:</span>\n                <span className=\"font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.totalOvertimeAmount.toLocaleString()}\n                </span>\n                {salaryData.totalOvertimeHours && (\n                  <span className=\"text-xs text-muted-foreground ml-2\">\n                    ({salaryData.totalOvertimeHours.toFixed(1)}h)\n                  </span>\n                )}\n              </div>\n            )}\n            {salaryData.commission !== undefined && salaryData.commission > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Commission:</span>\n                <span className=\"font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.commission.toLocaleString()}\n                </span>\n              </div>\n            )}\n            {salaryData.varianceAdd > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Variance Bonuses:</span>\n                <span className=\"font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.varianceAdd.toLocaleString()}\n                </span>\n              </div>\n            )}\n            <div className=\"pt-2 border-t\">\n              <div className=\"flex justify-between items-center\">\n                <span className=\"font-semibold\">Total Additions:</span>\n                <span className=\"font-bold text-green-600 text-xl\">\n                  +Rs. {((salaryData.holidayAllowance || 0) + (salaryData.totalOvertimeAmount || 0) + (salaryData.commission || 0) + salaryData.varianceAdd).toLocaleString()}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Net Salary Card */}\n      <Card className=\"border-2 border-primary bg-primary/5\">\n        <CardHeader>\n          <CardTitle className=\"text-2xl\">Net Salary Calculation</CardTitle>\n          <CardDescription>Final amount after all adjustments</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border\">\n              <span className=\"text-lg font-medium\">Base Salary:</span>\n              <span className=\"font-semibold text-lg\">\n                Rs. {salaryData.baseSalary.toLocaleString()}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border border-green-500/30\">\n              <span className=\"text-lg font-medium\">Additions:</span>\n              <span className=\"font-semibold text-green-600 text-lg\">\n                +Rs. {((salaryData.holidayAllowance || 0) + (salaryData.totalOvertimeAmount || 0) + (salaryData.commission || 0) + salaryData.varianceAdd).toLocaleString()}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border border-red-500/30\">\n              <span className=\"text-lg font-medium\">Deductions:</span>\n              <span className=\"font-semibold text-red-600 text-lg\">\n                -Rs. {((salaryData.epf || 0) + salaryData.totalAdvances + salaryData.totalLoans + salaryData.varianceDeduct).toLocaleString()}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-6 bg-primary/10 rounded-lg border-2 border-primary\">\n              <span className=\"text-xl font-bold\">Net Salary:</span>\n              <div className=\"flex items-center gap-2\">\n                <DollarSign className={`h-8 w-8 ${salaryData.netSalary >= 0 ? 'text-green-600' : 'text-red-600'}`} />\n                <span className={`text-4xl font-bold ${salaryData.netSalary >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                  Rs. {salaryData.netSalary.toLocaleString()}\n                </span>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Shift Details */}\n      {salaryData.shiftDetails.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-xl\">Shift-by-Shift Breakdown</CardTitle>\n            <CardDescription>\n              Detailed breakdown of all shifts worked in {monthLabel} {year}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {salaryData.shiftDetails.map((shift, idx) => (\n                <div key={idx} className=\"border rounded-lg p-4 space-y-3 hover:bg-muted/50 transition-colors\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 bg-primary/10 rounded-lg\">\n                        <Calendar className=\"h-5 w-5 text-primary\" />\n                      </div>\n                      <div>\n                        <div className=\"font-semibold text-lg\">\n                          {new Date(shift.date).toLocaleDateString('en-US', {\n                            weekday: 'long',\n                            year: 'numeric',\n                            month: 'long',\n                            day: 'numeric'\n                          })}\n                        </div>\n                        <Link\n                          href={`/shifts/${shift.shiftId}`}\n                          className=\"text-sm text-primary hover:underline\"\n                        >\n                          View Shift Details \n                        </Link>\n                      </div>\n                    </div>\n                    <Badge variant=\"outline\" className=\"text-lg px-3 py-1\">\n                      <Clock className=\"h-4 w-4 mr-1\" />\n                      {shift.hours.toFixed(1)}h\n                      {shift.overtimeHours && shift.overtimeHours > 0 && (\n                        <span className=\"ml-2 text-blue-600\">\n                          (OT: {shift.overtimeHours.toFixed(1)}h)\n                        </span>\n                      )}\n                    </Badge>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-5 gap-3\">\n                    {shift.overtimeAmount && shift.overtimeAmount > 0 && (\n                      <div className=\"p-3 bg-blue-500/10 rounded-lg border border-blue-500/20\">\n                        <div className=\"text-xs text-muted-foreground mb-1\">Overtime</div>\n                        <div className=\"flex items-center gap-1\">\n                          <Clock className=\"h-4 w-4 text-blue-600\" />\n                          <span className=\"font-semibold text-blue-600 text-lg\">\n                            Rs. {shift.overtimeAmount.toLocaleString()}\n                          </span>\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          {shift.overtimeHours?.toFixed(1)}h @ 1.5x rate\n                        </div>\n                      </div>\n                    )}\n                    <div className=\"p-3 bg-green-500/10 rounded-lg border border-green-500/20\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Sales</div>\n                      <div className=\"flex items-center gap-1\">\n                        <TrendingUp className=\"h-4 w-4 text-green-600\" />\n                        <span className=\"font-semibold text-green-600 text-lg\">\n                          Rs. {shift.sales.toLocaleString()}\n                        </span>\n                      </div>\n                      <div className=\"text-xs text-muted-foreground mt-1\">\n                        Commission: Rs. {Math.floor(shift.sales / 1000).toLocaleString()}\n                      </div>\n                    </div>\n\n                    <div className=\"p-3 bg-orange-500/10 rounded-lg border border-orange-500/20\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Advance Taken</div>\n                      <span className=\"font-semibold text-orange-600 text-lg\">\n                        Rs. {shift.advance.toLocaleString()}\n                      </span>\n                    </div>\n\n                    <div className={`p-3 rounded-lg border ${shift.varianceStatus === 'ADD_TO_SALARY'\n                      ? 'bg-green-500/10 border-green-500/20'\n                      : shift.varianceStatus === 'DEDUCT_FROM_SALARY'\n                        ? 'bg-red-500/10 border-red-500/20'\n                        : 'bg-muted border-border'\n                      }`}>\n                      <div className=\"text-xs text-muted-foreground mb-1\">Variance</div>\n                      <div className=\"flex items-center gap-1\">\n                        {shift.varianceStatus === 'ADD_TO_SALARY' && (\n                          <>\n                            <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                            <span className=\"font-semibold text-green-600 text-lg\">\n                              +Rs. {Math.abs(shift.variance).toLocaleString()}\n                            </span>\n                          </>\n                        )}\n                        {shift.varianceStatus === 'DEDUCT_FROM_SALARY' && (\n                          <>\n                            <XCircle className=\"h-4 w-4 text-red-600\" />\n                            <span className=\"font-semibold text-red-600 text-lg\">\n                              -Rs. {shift.variance.toLocaleString()}\n                            </span>\n                          </>\n                        )}\n                        {shift.varianceStatus === 'NORMAL' && (\n                          <span className=\"text-muted-foreground text-sm\">No variance</span>\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"p-3 bg-blue-500/10 rounded-lg border border-blue-500/20\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Shift Impact</div>\n                      <span className=\"font-semibold text-blue-600 text-lg\">\n                        {(() => {\n                          // Calculate net impact: variance adjustment + advance deduction\n                          let impact = -shift.advance // Advance is always deducted\n                          if (shift.varianceStatus === 'ADD_TO_SALARY') {\n                            impact += Math.abs(shift.variance) // Add variance bonus\n                          } else if (shift.varianceStatus === 'DEDUCT_FROM_SALARY') {\n                            impact -= Math.abs(shift.variance) // Deduct variance penalty\n                          }\n                          // impact is negative = deduction, positive = addition\n                          return impact >= 0\n                            ? `+Rs. ${impact.toLocaleString()}`\n                            : `-Rs. ${Math.abs(impact).toLocaleString()}`\n                        })()}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {salaryData.shiftDetails.length === 0 && (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n              <p>No shifts worked during this period</p>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Payment History */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-xl flex items-center gap-2\">\n            <CreditCard className=\"h-5 w-5\" />\n            Payment History\n          </CardTitle>\n          <CardDescription>\n            Record of salary payments for {monthLabel} {year}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {paymentHistory.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <FileText className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n              <p>No payment records found for this month</p>\n              <p className=\"text-sm mt-2\">Click &quot;Mark as Paid&quot; above to record a payment</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              {paymentHistory.map((payment, idx) => (\n                <div key={idx} className=\"border rounded-lg p-4\">\n                  <div className=\"flex justify-between items-start\">\n                    <div>\n                      <div className=\"font-semibold\">Payment Record #{idx + 1}</div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        Paid on: {new Date(payment.paymentDate).toLocaleDateString()}\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        Method: {payment.paymentMethod}\n                        {payment.paymentReference && ` - Ref: ${payment.paymentReference}`}\n                      </div>\n                      {payment.notes && (\n                        <div className=\"text-sm text-muted-foreground mt-1\">\n                          Notes: {payment.notes}\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"text-right\">\n                      <Badge\n                        className={\n                          payment.status === 'PAID'\n                            ? 'bg-green-500/20 text-green-600'\n                            : payment.status === 'PARTIAL'\n                              ? 'bg-yellow-500/20 text-yellow-600'\n                              : 'bg-muted'\n                        }\n                      >\n                        {payment.status}\n                      </Badge>\n                      <div className=\"font-mono font-bold text-lg mt-2\">\n                        Rs. {payment.netSalary.toLocaleString()}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">\n                        Paid by: {payment.paidBy}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Loan Management Section */}\n      <Card className=\"border-orange-500/20 bg-orange-500/5\">\n        <CardHeader>\n          <CardTitle className=\"text-xl flex items-center gap-2 text-orange-600\">\n            <CreditCard className=\"h-5 w-5\" />\n            Outstanding Loans\n          </CardTitle>\n          <CardDescription>\n            {salaryData.totalLoanAmount && salaryData.totalLoanAmount > 0 ? (\n              <div className=\"space-y-1\">\n                <div>Total loan amount: Rs. {salaryData.totalLoanAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                {salaryData.totalLoans > 0 && (\n                  <div>Total monthly rental deduction: Rs. {salaryData.totalLoans.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                )}\n              </div>\n            ) : salaryData.totalLoans > 0 ? (\n              `Total monthly rental deduction: Rs. ${salaryData.totalLoans.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`\n            ) : (\n              'No active loans with monthly rental deduction'\n            )}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            <p className=\"text-sm text-muted-foreground\">\n              Loans are automatically deducted from salary each month based on monthly rental amount. You can update the monthly rental below.\n            </p>\n            <Button\n              variant=\"outline\"\n              className=\"w-full\"\n              onClick={() => router.push(`/salary/${pumperId}/loans?pumperName=${encodeURIComponent(pumperName)}`)}\n            >\n              <CreditCard className=\"h-4 w-4 mr-2\" />\n              Manage Loans\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\salary\\office-staff\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Dialog' is defined but never used.","line":18,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogContent' is defined but never used.","line":18,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogDescription' is defined but never used.","line":18,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogHeader' is defined but never used.","line":18,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":64},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTitle' is defined but never used.","line":18,"column":66,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":77},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTrigger' is defined but never used.","line":18,"column":79,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":92},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Input' is defined but never used.","line":19,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Label' is defined but never used.","line":20,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Textarea' is defined but never used.","line":21,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Select' is defined but never used.","line":22,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectContent' is defined but never used.","line":22,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectItem' is defined but never used.","line":22,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectTrigger' is defined but never used.","line":22,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectValue' is defined but never used.","line":22,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":71},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSuccess' is assigned a value but never used.","line":75,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":75,"endColumn":29},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSalaryData'. Either include it or remove the dependency array.","line":82,"column":6,"nodeType":"ArrayExpression","endLine":82,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, staffId, month, fetchSalaryData]","fix":{"range":[2726,2759],"text":"[selectedStation, staffId, month, fetchSalaryData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useMemo } from 'react'\nimport { useParams, useSearchParams, useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  DollarSign,\n  Briefcase,\n  ArrowLeft,\n  Download,\n  CheckCircle,\n  CreditCard,\n  Settings\n} from 'lucide-react'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\n\ninterface OfficeStaffSalaryData {\n  id: string\n  name: string\n  employeeId: string | null\n  role: string\n  baseSalary: number\n  specialAllowance: number\n  otherAllowances: number\n  medicalAllowance: number\n  holidayAllowance: number\n  fuelAllowance: number\n  totalAllowances: number\n  advances: number\n  loans: number\n  absentDays: number\n  absentDeduction: number\n  epf: number\n  totalDeductions: number\n  grossSalary: number\n  netSalary: number\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nexport default function OfficeStaffSalaryDetailsPage() {\n  const params = useParams()\n  const searchParams = useSearchParams()\n  const router = useRouter()\n  const { selectedStation } = useStation()\n\n  // Extract values immediately using useMemo to avoid Next.js 15 enumeration issues\n  const staffId = useMemo(() => (params?.id as string) || '', [params])\n  const month = useMemo(() => searchParams?.get('month') || '', [searchParams])\n  const staffName = useMemo(() => searchParams?.get('staffName') || 'Unknown', [searchParams])\n  const employeeId = useMemo(() => searchParams?.get('employeeId') || '', [searchParams])\n\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n  const [salaryData, setSalaryData] = useState<OfficeStaffSalaryData | null>(null)\n\n  useEffect(() => {\n    if (selectedStation && staffId && month) {\n      fetchSalaryData()\n    }\n  }, [selectedStation, staffId, month])\n\n  const fetchSalaryData = async () => {\n    if (!selectedStation || !staffId || !month) return\n\n    try {\n      setLoading(true)\n      setError('')\n\n      const res = await fetch(`/api/office-staff/salary?stationId=${selectedStation}&month=${month}`)\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to fetch salary data')\n      }\n\n      const data = await res.json()\n\n      // Find the specific office staff member\n      const staffData = data.salaryData?.find((s: OfficeStaffSalaryData) => s.id === staffId)\n\n      // If not found, create empty data structure\n      if (!staffData) {\n        setSalaryData({\n          id: staffId,\n          name: staffName || 'Unknown',\n          employeeId: employeeId || null,\n          role: '',\n          baseSalary: 0,\n\n          // OfficeStaffSalaryData properties:\n          specialAllowance: 0,\n          otherAllowances: 0,\n          medicalAllowance: 0,\n          holidayAllowance: 0,\n          fuelAllowance: 0,\n          totalAllowances: 0,\n          advances: 0,\n          loans: 0,\n          absentDays: 0,\n          absentDeduction: 0,\n          epf: 0,\n          totalDeductions: 0,\n          grossSalary: 0,\n          netSalary: 0\n        })\n        return\n      }\n\n      setSalaryData(staffData)\n    } catch (err) {\n      console.error('Error fetching office staff salary data:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load salary data')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Parse month safely (format: YYYY-MM)\n  const monthParts = month.split('-')\n  const year = monthParts[0] || new Date().getFullYear().toString()\n  const monthNum = monthParts[1] || String(new Date().getMonth() + 1).padStart(2, '0')\n  const monthLabel = months.find(m => m.value === monthNum)?.label || monthNum\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  if (error || !salaryData) {\n    return (\n      <div className=\"space-y-6 p-6\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.back()}>\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Monthly Salary Report</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              {staffName} - {monthLabel} {year}\n            </p>\n          </div>\n        </div>\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-red-600\">{error || 'Salary data not found'}</p>\n          </CardContent>\n        </Card>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.back()}>\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n              <Briefcase className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n              Monthly Salary Report\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              {salaryData.name} {salaryData.employeeId && `(${salaryData.employeeId})`} - {monthLabel} {year}\n            </p>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              Role: <Badge variant=\"outline\">{salaryData.role.replace('_', ' ')}</Badge>\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\">\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export PDF\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={() => router.push(`/settings/office-staff`)}\n          >\n            <Settings className=\"h-4 w-4 mr-2\" />\n            Edit Base Salary\n          </Button>\n        </div>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <DollarSign className=\"h-4 w-4 text-blue-600\" />\n              Base Salary\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\">\n              Rs. {salaryData.baseSalary.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <CreditCard className=\"h-4 w-4 text-green-600\" />\n              Total Allowances\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\">\n              Rs. {salaryData.totalAllowances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <CreditCard className=\"h-4 w-4 text-orange-600\" />\n              Total Deductions\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\">\n              Rs. {salaryData.totalDeductions.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n              <DollarSign className=\"h-4 w-4\" />\n              Net Salary\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className={`text-2xl font-bold ${salaryData.netSalary >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              Rs. {salaryData.netSalary.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Allowances and Deductions */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        <Card className=\"border-green-500/20 bg-green-500/5\">\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Allowances</CardTitle>\n            <CardDescription>Amounts added to base salary</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {salaryData.specialAllowance > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Special Allowance:</span>\n                <span className=\"font-mono font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.specialAllowance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.otherAllowances > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Other Allowances:</span>\n                <span className=\"font-mono font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.otherAllowances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.medicalAllowance > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Medical Allowance:</span>\n                <span className=\"font-mono font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.medicalAllowance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.holidayAllowance > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Holiday Allowance:</span>\n                <span className=\"font-mono font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.holidayAllowance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.fuelAllowance > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border border-green-500/30\">\n                <span className=\"text-sm font-medium\">Fuel Allowance:</span>\n                <span className=\"font-mono font-semibold text-green-600 text-lg\">\n                  +Rs. {salaryData.fuelAllowance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n                <span className=\"text-xs text-muted-foreground ml-2\">(Manager only)</span>\n              </div>\n            )}\n            {salaryData.totalAllowances === 0 && (\n              <div className=\"text-center py-4 text-muted-foreground\">\n                <p>No allowances for this month</p>\n              </div>\n            )}\n            <div className=\"pt-2 border-t\">\n              <div className=\"flex justify-between items-center\">\n                <span className=\"font-semibold\">Total Allowances:</span>\n                <span className=\"font-mono font-bold text-green-600 text-xl\">\n                  +Rs. {salaryData.totalAllowances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-red-500/20 bg-red-500/5\">\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Deductions</CardTitle>\n            <CardDescription>Amounts deducted from gross salary</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            {salaryData.advances > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n                <span className=\"text-sm font-medium\">Advances Taken:</span>\n                <span className=\"font-mono font-semibold text-red-600 text-lg\">\n                  -Rs. {salaryData.advances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.loans > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n                <span className=\"text-sm font-medium\">Loans:</span>\n                <span className=\"font-mono font-semibold text-red-600 text-lg\">\n                  -Rs. {salaryData.loans.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.absentDays > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n                <span className=\"text-sm font-medium\">Absent Days ({salaryData.absentDays} days):</span>\n                <span className=\"font-mono font-semibold text-red-600 text-lg\">\n                  -Rs. {salaryData.absentDeduction.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.epf > 0 && (\n              <div className=\"flex justify-between items-center p-3 bg-card rounded-lg border\">\n                <span className=\"text-sm font-medium\">EPF (8%):</span>\n                <span className=\"font-mono font-semibold text-red-600 text-lg\">\n                  -Rs. {salaryData.epf.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            )}\n            {salaryData.totalDeductions === 0 && (\n              <div className=\"text-center py-4 text-muted-foreground\">\n                <p>No deductions for this month</p>\n              </div>\n            )}\n            <div className=\"pt-2 border-t\">\n              <div className=\"flex justify-between items-center\">\n                <span className=\"font-semibold\">Total Deductions:</span>\n                <span className=\"font-mono font-bold text-red-600 text-xl\">\n                  -Rs. {salaryData.totalDeductions.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Net Salary Calculation */}\n      <Card className=\"border-2 border-primary bg-primary/5\">\n        <CardHeader>\n          <CardTitle className=\"text-2xl\">Net Salary Calculation</CardTitle>\n          <CardDescription>Final amount after all additions and deductions</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border\">\n              <span className=\"text-lg font-medium\">Base Salary:</span>\n              <span className=\"font-mono font-semibold text-lg\">\n                Rs. {salaryData.baseSalary.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border border-green-500/30\">\n              <span className=\"text-lg font-medium\">Additions (Allowances):</span>\n              <span className=\"font-mono font-semibold text-green-600 text-lg\">\n                +Rs. {salaryData.totalAllowances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border\">\n              <span className=\"text-lg font-medium\">Gross Salary:</span>\n              <span className=\"font-mono font-semibold text-lg\">\n                Rs. {salaryData.grossSalary.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-4 bg-card rounded-lg border border-red-500/30\">\n              <span className=\"text-lg font-medium\">Deductions:</span>\n              <span className=\"font-mono font-semibold text-red-600 text-lg\">\n                -Rs. {salaryData.totalDeductions.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n              </span>\n            </div>\n            <div className=\"flex justify-between items-center p-6 bg-primary/10 rounded-lg border-2 border-primary\">\n              <span className=\"text-xl font-bold\">Net Salary:</span>\n              <div className=\"flex items-center gap-2\">\n                <DollarSign className={`h-8 w-8 ${salaryData.netSalary >= 0 ? 'text-green-600' : 'text-red-600'}`} />\n                <span className={`text-4xl font-bold ${salaryData.netSalary >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                  Rs. {salaryData.netSalary.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </span>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Messages */}\n      {success && (\n        <Card className=\"border-green-500/20 bg-green-500/10\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-green-600 font-medium\">{success}</p>\n          </CardContent>\n        </Card>\n      )}\n      {error && (\n        <Card className=\"border-red-500/20 bg-red-500/10\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-red-600\">{error}</p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  )\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\salary\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":20,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchOfficeStaffSalaryData' and 'fetchSalaryData'. Either include them or remove the dependency array.","line":136,"column":6,"nodeType":"ArrayExpression","endLine":136,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [selectedStation, selectedYear, selectedMonth, fetchSalaryData, fetchOfficeStaffSalaryData]","fix":{"range":[3773,3819],"text":"[selectedStation, selectedYear, selectedMonth, fetchSalaryData, fetchOfficeStaffSalaryData]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'row' is defined but never used.","line":330,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":330,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Label } from '@/components/ui/label'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport {\n  DollarSign,\n  Clock,\n  TrendingUp,\n  User,\n  Download,\n  RefreshCw,\n  AlertCircle,\n  Briefcase,\n  Users\n} from 'lucide-react'\nimport { useRouter } from 'next/navigation'\nimport { exportSalaryReportPDF } from '@/lib/exportUtils'\nimport { useToast } from '@/hooks/use-toast'\n\ninterface SalaryData {\n  pumperId: string\n  pumperName: string\n  employeeId?: string\n  baseSalary: number\n  holidayAllowance?: number\n  restDaysTaken?: number\n  daysWorked?: number\n  shiftCount: number\n  totalHours: number\n  totalOvertimeHours?: number\n  totalOvertimeAmount?: number\n  commission?: number\n  totalSales: number\n  totalAdvances: number\n  totalLoans: number\n  varianceAdd: number\n  varianceDeduct: number\n  epf?: number\n  netSalary: number\n  shiftDetails: Array<{\n    shiftId: string\n    date: string\n    hours: number\n    sales: number\n    advance: number\n    variance: number\n    varianceStatus: string\n    overtimeHours?: number\n    overtimeAmount?: number\n  }>\n}\n\ninterface SalaryResponse {\n  month: string\n  startDate: string\n  endDate: string\n  salaryData: SalaryData[]\n}\n\ninterface OfficeStaffSalaryData {\n  id: string\n  name: string\n  employeeId: string | null\n  role: string\n  baseSalary: number\n  specialAllowance: number\n  otherAllowances: number\n  medicalAllowance: number\n  holidayAllowance: number\n  fuelAllowance: number\n  totalAllowances: number\n  advances: number\n  loans: number\n  absentDays: number\n  absentDeduction: number\n  epf: number\n  totalDeductions: number\n  grossSalary: number\n  netSalary: number\n}\n\ninterface OfficeStaffSalaryResponse {\n  month: string\n  stationId: string\n  salaryData: OfficeStaffSalaryData[]\n}\n\nconst months = [\n  { value: '01', label: 'January' },\n  { value: '02', label: 'February' },\n  { value: '03', label: 'March' },\n  { value: '04', label: 'April' },\n  { value: '05', label: 'May' },\n  { value: '06', label: 'June' },\n  { value: '07', label: 'July' },\n  { value: '08', label: 'August' },\n  { value: '09', label: 'September' },\n  { value: '10', label: 'October' },\n  { value: '11', label: 'November' },\n  { value: '12', label: 'December' }\n]\n\nexport default function SalaryPage() {\n  const router = useRouter()\n  const { selectedStation } = useStation()\n  const [loading, setLoading] = useState(false)\n  const { toast } = useToast()\n  const [salaryData, setSalaryData] = useState<SalaryResponse | null>(null)\n  const [officeStaffSalaryData, setOfficeStaffSalaryData] = useState<OfficeStaffSalaryResponse | null>(null)\n  const [loadingOfficeStaff, setLoadingOfficeStaff] = useState(false)\n\n  // Month selection\n  const currentDate = new Date()\n  const [selectedYear, setSelectedYear] = useState(currentDate.getFullYear().toString())\n  const [selectedMonth, setSelectedMonth] = useState(String(currentDate.getMonth() + 1).padStart(2, '0'))\n\n  // Generate years (current year and previous 2 years)\n  const years = Array.from({ length: 3 }, (_, i) => {\n    const year = currentDate.getFullYear() - i\n    return { value: year.toString(), label: year.toString() }\n  })\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchSalaryData()\n      fetchOfficeStaffSalaryData()\n    }\n  }, [selectedStation, selectedYear, selectedMonth])\n\n  const fetchSalaryData = async () => {\n    if (!selectedStation) return\n\n    try {\n      setLoading(true)\n\n\n      // Format month for API (API expects YYYY-MM format, but will calculate 7th-6th period)\n      const month = `${selectedYear}-${selectedMonth}`\n      const res = await fetch(`/api/salary?stationId=${selectedStation}&month=${month}`)\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to fetch salary data')\n      }\n\n      const data = await res.json()\n      setSalaryData(data)\n    } catch (err) {\n      console.error('Error fetching salary data:', err)\n      toast({\n        title: \"Error\",\n        description: err instanceof Error ? err.message : 'Failed to load salary data',\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const fetchOfficeStaffSalaryData = async () => {\n    if (!selectedStation) return\n\n    try {\n      setLoadingOfficeStaff(true)\n\n      // Format month for API (API expects YYYY-MM format)\n      const month = `${selectedYear}-${selectedMonth}`\n      const res = await fetch(`/api/office-staff/salary?stationId=${selectedStation}&month=${month}`)\n\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}))\n        console.error('Error fetching office staff salary:', errorData.error || 'Failed to fetch office staff salary data')\n        setOfficeStaffSalaryData(null)\n        return\n      }\n\n      const data = await res.json()\n      setOfficeStaffSalaryData(data)\n    } catch (err) {\n      console.error('Error fetching office staff salary data:', err)\n      setOfficeStaffSalaryData(null)\n    } finally {\n      setLoadingOfficeStaff(false)\n    }\n  }\n\n  const handleRowClick = (row: SalaryData) => {\n    // Navigate to pumper details page with month and pumper info\n    const month = `${selectedYear}-${selectedMonth}`\n    router.push(`/salary/${encodeURIComponent(row.pumperId)}?month=${month}&pumperName=${encodeURIComponent(row.pumperName)}`)\n  }\n\n  const handleOfficeStaffRowClick = (row: OfficeStaffSalaryData) => {\n    // Navigate to office staff details page with month and staff info\n    const month = `${selectedYear}-${selectedMonth}`\n    router.push(`/salary/office-staff/${encodeURIComponent(row.id)}?month=${month}&staffName=${encodeURIComponent(row.name)}&employeeId=${encodeURIComponent(row.employeeId || '')}`)\n  }\n\n  const handleExport = () => {\n    if (!salaryData || salaryData.salaryData.length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"No data to export\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const monthLabel = months.find(m => m.value === selectedMonth)?.label || selectedMonth\n      exportSalaryReportPDF(salaryData.salaryData, `${monthLabel} ${selectedYear}`)\n    } catch (err) {\n      console.error('Error exporting salary report:', err)\n      toast({\n        title: \"Error\",\n        description: \"Failed to export report\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const salaryColumns = [\n    {\n      key: 'pumperName' as keyof SalaryData,\n      title: 'Pumper',\n      render: (value: unknown, row: SalaryData) => (\n        <div className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            {row.employeeId && (\n              <div className=\"text-xs text-muted-foreground\">ID: {row.employeeId}</div>\n            )}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'shiftCount' as keyof SalaryData,\n      title: 'Shifts',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{value as number}</Badge>\n      )\n    },\n    {\n      key: 'totalHours' as keyof SalaryData,\n      title: 'Hours',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span>{(value as number).toFixed(1)}h</span>\n        </div>\n      )\n    },\n    {\n      key: 'totalSales' as keyof SalaryData,\n      title: 'Total Sales',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <TrendingUp className=\"h-4 w-4 text-green-600\" />\n          <span className=\"font-semibold text-green-600\">\n            Rs. {(value as number).toLocaleString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'baseSalary' as keyof SalaryData,\n      title: 'Base Salary',\n      render: (value: unknown) => (\n        <span>Rs. {(value as number).toLocaleString()}</span>\n      )\n    },\n    {\n      key: 'totalAdvances' as keyof SalaryData,\n      title: 'Advances',\n      render: (value: unknown) => {\n        const advances = value as number\n        return advances > 0 ? (\n          <span className=\"text-orange-600\">-Rs. {advances.toLocaleString()}</span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      }\n    },\n    {\n      key: 'totalLoans' as keyof SalaryData,\n      title: 'Loans',\n      render: (value: unknown) => {\n        const loans = value as number\n        return loans > 0 ? (\n          <span className=\"text-red-600\">-Rs. {loans.toLocaleString()}</span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      }\n    },\n    {\n      key: 'varianceAdd' as keyof SalaryData,\n      title: 'Variance (+/-)',\n      render: (value: unknown, row: SalaryData) => {\n        const add = row.varianceAdd || 0\n        const deduct = row.varianceDeduct || 0\n        if (add > 0 && deduct > 0) {\n          return (\n            <div className=\"flex flex-col gap-0.5\">\n              <span className=\"text-xs text-green-600\">+Rs. {add.toLocaleString()}</span>\n              <span className=\"text-xs text-red-600\">-Rs. {deduct.toLocaleString()}</span>\n            </div>\n          )\n        } else if (add > 0) {\n          return <span className=\"text-green-600\">+Rs. {add.toLocaleString()}</span>\n        } else if (deduct > 0) {\n          return <span className=\"text-red-600\">-Rs. {deduct.toLocaleString()}</span>\n        }\n        return <span className=\"text-muted-foreground\">-</span>\n      }\n    },\n    {\n      key: 'netSalary' as keyof SalaryData,\n      title: 'Net Salary',\n      render: (value: unknown, row: SalaryData) => {\n        const net = value as number\n        return (\n          <div className=\"flex items-center gap-2\">\n            <DollarSign className={`h-4 w-4 ${net >= 0 ? 'text-green-600' : 'text-red-600'}`} />\n            <span className={`font-bold ${net >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              Rs. {net.toLocaleString()}\n            </span>\n          </div>\n        )\n      }\n    }\n  ]\n\n  const officeStaffSalaryColumns = [\n    {\n      key: 'name' as keyof OfficeStaffSalaryData,\n      title: 'Name',\n      render: (value: unknown, row: OfficeStaffSalaryData) => (\n        <div className=\"flex items-center gap-2\">\n          <Briefcase className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            {row.employeeId && (\n              <div className=\"text-xs text-muted-foreground\">ID: {row.employeeId}</div>\n            )}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'role' as keyof OfficeStaffSalaryData,\n      title: 'Role',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{String(value).replace('_', ' ')}</Badge>\n      )\n    },\n    {\n      key: 'baseSalary' as keyof OfficeStaffSalaryData,\n      title: 'Base Salary',\n      render: (value: unknown) => (\n        <span>Rs. {(value as number).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n      )\n    },\n    {\n      key: 'totalAllowances' as keyof OfficeStaffSalaryData,\n      title: 'Allowances',\n      render: (value: unknown) => {\n        const allowances = value as number\n        return allowances > 0 ? (\n          <span className=\"text-green-600\">+Rs. {allowances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      }\n    },\n    {\n      key: 'totalDeductions' as keyof OfficeStaffSalaryData,\n      title: 'Deductions',\n      render: (value: unknown) => {\n        const deductions = value as number\n        return deductions > 0 ? (\n          <span className=\"text-red-600\">-Rs. {deductions.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n        ) : (\n          <span className=\"text-muted-foreground\">-</span>\n        )\n      }\n    },\n    {\n      key: 'netSalary' as keyof OfficeStaffSalaryData,\n      title: 'Net Salary',\n      render: (value: unknown) => {\n        const net = value as number\n        return (\n          <div className=\"flex items-center gap-2\">\n            <DollarSign className={`h-4 w-4 ${net >= 0 ? 'text-green-600' : 'text-red-600'}`} />\n            <span className={`font-bold ${net >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n              Rs. {net.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </span>\n          </div>\n        )\n      }\n    }\n  ]\n\n  if (loading && !salaryData) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n            <DollarSign className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n            Salary Management\n          </h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Monthly salary calculation based on shifts, sales, advances, and variance adjustments\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={fetchSalaryData}>\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Refresh\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={handleExport}\n            disabled={!salaryData || salaryData.salaryData.length === 0}\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export PDF\n          </Button>\n        </div>\n      </div>\n\n      {/* Month Selection */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Select Salary Period</CardTitle>\n          <CardDescription>Salary periods run from 7th of each month to 6th of next month</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4\">\n            <div className=\"flex-1\">\n              <Label htmlFor=\"year\">Year</Label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger id=\"year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {years.map(year => (\n                    <SelectItem key={year.value} value={year.value}>\n                      {year.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex-1\">\n              <Label htmlFor=\"month\">Month</Label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger id=\"month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {months.map(month => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n\n\n      {/* Summary Cards */}\n      {salaryData && salaryData.salaryData.length > 0 && (\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Pumpers</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{salaryData.salaryData.length}</div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Shifts</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                {salaryData.salaryData.reduce((sum, p) => sum + p.shiftCount, 0)}\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Salary</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-green-600\">\n                Rs. {salaryData.salaryData.reduce((sum, p) => sum + p.netSalary, 0).toLocaleString()}\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Advances</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-orange-600\">\n                Rs. {salaryData.salaryData.reduce((sum, p) => sum + p.totalAdvances, 0).toLocaleString()}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Salary Tabs */}\n      <Tabs defaultValue=\"pumpers\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"pumpers\">\n            <Users className=\"h-4 w-4 mr-2\" />\n            Pumpers\n          </TabsTrigger>\n          <TabsTrigger value=\"office-staff\">\n            <Briefcase className=\"h-4 w-4 mr-2\" />\n            Office Staff\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Pumpers Tab */}\n        <TabsContent value=\"pumpers\" className=\"space-y-4\">\n          <FormCard\n            title=\"Monthly Salary Report for Pumpers\"\n            description={`Salary breakdown for ${months.find(m => m.value === selectedMonth)?.label} ${selectedYear}`}\n          >\n            {!salaryData || salaryData.salaryData.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <DollarSign className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n                <p>No salary data found for this month</p>\n                <p className=\"text-sm\">No shifts were closed during this period</p>\n              </div>\n            ) : (\n              <DataTable\n                data={salaryData.salaryData}\n                columns={salaryColumns}\n                searchable={true}\n                searchPlaceholder=\"Search pumpers...\"\n                pagination={true}\n                pageSize={10}\n                onRowClick={handleRowClick}\n              />\n            )}\n          </FormCard>\n        </TabsContent>\n\n        {/* Office Staff Tab */}\n        <TabsContent value=\"office-staff\" className=\"space-y-4\">\n          <FormCard\n            title=\"Monthly Salary Report for Office Staff\"\n            description={`Salary breakdown for Manager, Supervisor, and Office Staff - ${months.find(m => m.value === selectedMonth)?.label} ${selectedYear}`}\n          >\n            {loadingOfficeStaff ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n              </div>\n            ) : !officeStaffSalaryData || officeStaffSalaryData.salaryData.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Briefcase className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n                <p>No office staff found for this station</p>\n                <p className=\"text-sm\">Add office staff members in Settings to calculate their salaries</p>\n              </div>\n            ) : (\n              <DataTable\n                data={officeStaffSalaryData.salaryData}\n                columns={officeStaffSalaryColumns}\n                searchable={true}\n                searchPlaceholder=\"Search office staff...\"\n                pagination={true}\n                pageSize={10}\n                onRowClick={handleOfficeStaffRowClick}\n              />\n            )}\n          </FormCard>\n        </TabsContent>\n      </Tabs>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\banks\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":10,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":10,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":36,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchBanks'. Either include it or remove the dependency array.","line":55,"column":6,"nodeType":"ArrayExpression","endLine":55,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchBanks]","fix":{"range":[1627,1629],"text":"[fetchBanks]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":73,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":73,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":159,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":159,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { CreditCard, Plus, Edit, Trash2, Building, Phone } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { ArrowLeft } from 'lucide-react'\n\ninterface Bank {\n  id: string\n  code: string\n  name: string\n  accountNumber: string\n  accountName: string\n  branch: string\n  swiftCode: string\n  contactPerson: string\n  phone: string\n  email: string\n  status: 'active' | 'inactive'\n  createdAt: string\n  updatedAt: string\n}\n\nexport default function BanksPage() {\n  const router = useRouter()\n  const [banks, setBanks] = useState<Bank[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingBank, setEditingBank] = useState<Bank | null>(null)\n  const [formData, setFormData] = useState({\n    code: '',\n    name: '',\n    accountNumber: '',\n    accountName: '',\n    branch: '',\n    swiftCode: '',\n    contactPerson: '',\n    phone: '',\n    email: '',\n    status: 'active' as Bank['status']\n  })\n  const { toast } = useToast()\n\n  useEffect(() => {\n    fetchBanks()\n  }, [])\n\n  const fetchBanks = async () => {\n    try {\n      const response = await fetch('/api/banks')\n      const data = await response.json()\n      console.log('Fetched banks data:', data)\n      interface ApiBank extends Omit<Bank, 'status'> {\n        isActive: boolean\n      }\n\n      // Map isActive to status for the UI\n      const mappedData = data.map((bank: ApiBank) => ({\n        ...bank,\n        status: (bank.isActive ? 'active' : 'inactive') as 'active' | 'inactive'\n      }))\n      console.log('Mapped banks data:', mappedData)\n      setBanks(mappedData)\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch banks\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    try {\n      const url = editingBank ? `/api/banks/${editingBank.id}` : '/api/banks'\n      const method = editingBank ? 'PUT' : 'POST'\n\n      console.log('Submitting bank data:', formData)\n      console.log('URL:', url, 'Method:', method)\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(formData)\n      })\n\n      const responseData = await response.json()\n      console.log('Response:', responseData)\n\n      if (!response.ok) throw new Error('Failed to save bank')\n\n      toast({\n        title: \"Success\",\n        description: `Bank ${editingBank ? 'updated' : 'created'} successfully`\n      })\n\n      setDialogOpen(false)\n      resetForm()\n      fetchBanks()\n    } catch (error) {\n      console.error('Error saving bank:', error)\n      toast({\n        title: \"Error\",\n        description: `Failed to ${editingBank ? 'update' : 'create'} bank`,\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleEdit = (bank: Bank) => {\n    console.log('Editing bank:', bank)\n    setEditingBank(bank)\n    const formDataToSet = {\n      code: bank.code || '',\n      name: bank.name || '',\n      accountNumber: bank.accountNumber || '',\n      accountName: bank.accountName || '',\n      branch: bank.branch || '',\n      swiftCode: bank.swiftCode || '',\n      contactPerson: bank.contactPerson || '',\n      phone: bank.phone || '',\n      email: bank.email || '',\n      status: bank.status\n    }\n    console.log('Setting form data:', formDataToSet)\n    setFormData(formDataToSet)\n    setDialogOpen(true)\n  }\n\n  const handleDelete = async (bank: Bank) => {\n    if (!confirm(`Are you sure you want to delete bank \"${bank.name}\"?`)) return\n\n    try {\n      const response = await fetch(`/api/banks/${bank.id}`, {\n        method: 'DELETE'\n      })\n\n      if (!response.ok) throw new Error('Failed to delete bank')\n\n      toast({\n        title: \"Success\",\n        description: \"Bank deleted successfully\"\n      })\n\n      fetchBanks()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete bank\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const resetForm = () => {\n    setEditingBank(null)\n    setFormData({\n      code: '',\n      name: '',\n      accountNumber: '',\n      accountName: '',\n      branch: '',\n      swiftCode: '',\n      contactPerson: '',\n      phone: '',\n      email: '',\n      status: 'active'\n    })\n  }\n\n  const getStatusColor = (status: Bank['status']) => {\n    switch (status) {\n      case 'active': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'inactive': return 'bg-muted text-foreground'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const columns = [\n    {\n      key: 'code' as keyof Bank,\n      title: 'Code',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value ? (value as string) : '-'}</span>\n      )\n    },\n    {\n      key: 'name' as keyof Bank,\n      title: 'Bank Name',\n      render: (value: unknown) => (\n        <div className=\"font-medium\">{value as string}</div>\n      )\n    },\n    {\n      key: 'accountNumber' as keyof Bank,\n      title: 'Account Number',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value ? (value as string) : '-'}</span>\n      )\n    },\n    {\n      key: 'accountName' as keyof Bank,\n      title: 'Account Name',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value ? (value as string) : '-'}</span>\n      )\n    },\n    {\n      key: 'branch' as keyof Bank,\n      title: 'Branch',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n          <Building className=\"h-3 w-3\" />\n          {value as string}\n        </div>\n      )\n    },\n    {\n      key: 'contactPerson' as keyof Bank,\n      title: 'Contact',\n      render: (value: unknown, row: Bank) => (\n        <div className=\"text-sm\">\n          {value || row.phone ? (\n            <>\n              <div className=\"font-medium\">{value ? (value as string) : '-'}</div>\n              <div className=\"flex items-center gap-1 text-muted-foreground\">\n                <Phone className=\"h-3 w-3\" />\n                {row.phone || '-'}\n              </div>\n            </>\n          ) : (\n            <span className=\"text-muted-foreground\">-</span>\n          )}\n        </div>\n      )\n    },\n    {\n      key: 'status' as keyof Bank,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = value as string\n        if (!status) return <Badge className=\"bg-muted text-foreground\">Unknown</Badge>\n        return (\n          <Badge className={getStatusColor(status as Bank['status'])}>\n            {status.charAt(0).toUpperCase() + status.slice(1)}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'id' as keyof Bank,\n      title: 'Actions',\n      render: (value: unknown, row: Bank) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleDelete(row)}\n            className=\"text-red-600 dark:text-red-400 hover:text-red-700\"\n          >\n            <Trash2 className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      )\n    }\n  ]\n\n  const stats = [\n    {\n      title: 'Total Banks',\n      value: banks.length.toString(),\n      description: 'Registered banks',\n      icon: <CreditCard className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Active',\n      value: banks.filter(b => b.status === 'active').length.toString(),\n      description: 'Currently active',\n      icon: <div className=\"h-5 w-5 bg-green-500/10 dark:bg-green-500/200 rounded-full\" />\n    },\n    {\n      title: 'Inactive',\n      value: banks.filter(b => b.status === 'inactive').length.toString(),\n      description: 'Not in use',\n      icon: <div className=\"h-5 w-5 bg-muted0 rounded-full\" />\n    },\n    {\n      title: 'Accounts',\n      value: banks.filter(b => b.accountNumber).length.toString(),\n      description: 'With account details',\n      icon: <Building className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Bank Management</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Manage bank accounts and payment processing configurations\n            </p>\n          </div>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={resetForm}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Bank\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\" aria-describedby={undefined}>\n            <DialogHeader>\n              <DialogTitle>\n                {editingBank ? 'Edit Bank' : 'Add New Bank'}\n              </DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"code\">Bank Code</Label>\n                  <Input\n                    id=\"code\"\n                    value={formData.code}\n                    onChange={(e) => setFormData({ ...formData, code: e.target.value })}\n                    placeholder=\"e.g., BOC, COM, HNB\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"name\">Bank Name</Label>\n                  <Input\n                    id=\"name\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    placeholder=\"e.g., Bank of Ceylon\"\n                    required\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"accountNumber\">Account Number</Label>\n                  <Input\n                    id=\"accountNumber\"\n                    value={formData.accountNumber}\n                    onChange={(e) => setFormData({ ...formData, accountNumber: e.target.value })}\n                    placeholder=\"Bank account number\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"accountName\">Account Name</Label>\n                  <Input\n                    id=\"accountName\"\n                    value={formData.accountName}\n                    onChange={(e) => setFormData({ ...formData, accountName: e.target.value })}\n                    placeholder=\"Account holder name\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"branch\">Branch</Label>\n                  <Input\n                    id=\"branch\"\n                    value={formData.branch}\n                    onChange={(e) => setFormData({ ...formData, branch: e.target.value })}\n                    placeholder=\"Branch name/location\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"swiftCode\">SWIFT Code</Label>\n                  <Input\n                    id=\"swiftCode\"\n                    value={formData.swiftCode}\n                    onChange={(e) => setFormData({ ...formData, swiftCode: e.target.value })}\n                    placeholder=\"International transfer code\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"contactPerson\">Contact Person</Label>\n                  <Input\n                    id=\"contactPerson\"\n                    value={formData.contactPerson}\n                    onChange={(e) => setFormData({ ...formData, contactPerson: e.target.value })}\n                    placeholder=\"Bank contact person\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"phone\">Phone</Label>\n                  <Input\n                    id=\"phone\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                    placeholder=\"Contact number\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={formData.email}\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                    placeholder=\"Contact email\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"status\">Status</Label>\n                  <select\n                    id=\"status\"\n                    value={formData.status}\n                    onChange={(e) => setFormData({ ...formData, status: e.target.value as Bank['status'] })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    <option value=\"active\">Active</option>\n                    <option value=\"inactive\">Inactive</option>\n                  </select>\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-3 pt-4\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">\n                  {editingBank ? 'Update Bank' : 'Create Bank'}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {stats.map((stat, index) => (\n          <Card key={index}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-2xl font-bold text-foreground\">{stat.value}</div>\n                  <div className=\"text-sm font-medium text-foreground\">{stat.title}</div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.description}</div>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {stat.icon}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Banks Table */}\n      <FormCard title=\"Banks\" description=\"Manage bank accounts and payment processing settings\">\n        <DataTable\n          data={banks}\n          columns={columns}\n          searchPlaceholder=\"Search banks...\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\office-staff\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchOfficeStaff'. Either include it or remove the dependency array.","line":77,"column":6,"nodeType":"ArrayExpression","endLine":77,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchOfficeStaff, selectedStation]","fix":{"range":[2543,2560],"text":"[fetchOfficeStaff, selectedStation]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_error' is defined but never used.","line":88,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":88,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Badge } from '@/components/ui/badge'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { Briefcase, Plus, Edit, Trash2, Phone, Mail, Building2, DollarSign, ArrowLeft } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\n\ninterface OfficeStaff {\n  id: string\n  name: string\n  employeeId: string | null\n  stationId: string\n  role: 'MANAGER' | 'SUPERVISOR' | 'OFFICE_STAFF' | 'ACCOUNTANT' | 'CASHIER'\n  phone: string | null\n  email: string | null\n  baseSalary: number\n  specialAllowance?: number\n  otherAllowances?: number\n  medicalAllowance?: number\n  holidayAllowance?: number\n  fuelAllowance?: number\n  hireDate: string | null\n  isActive: boolean\n  createdAt: string\n  updatedAt: string\n  station?: {\n    id: string\n    name: string\n  }\n}\n\nexport default function OfficeStaffPage() {\n  const router = useRouter()\n  const { selectedStation, stations } = useStation()\n  const [officeStaff, setOfficeStaff] = useState<OfficeStaff[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingStaff, setEditingStaff] = useState<OfficeStaff | null>(null)\n  const [deletingStaffId, setDeletingStaffId] = useState<string | null>(null)\n  const [formData, setFormData] = useState({\n    name: '',\n    employeeId: '',\n    stationId: selectedStation || '',\n    role: 'OFFICE_STAFF' as OfficeStaff['role'],\n    phone: '',\n    email: '',\n    baseSalary: 0,\n    specialAllowance: 0,\n    otherAllowances: 0,\n    medicalAllowance: 0,\n    holidayAllowance: 0,\n    fuelAllowance: 0,\n    hireDate: new Date().toISOString().split('T')[0],\n    isActive: true\n  })\n  const { toast } = useToast()\n\n  useEffect(() => {\n    if (selectedStation) {\n      fetchOfficeStaff()\n      // Update formData stationId when selectedStation changes\n      setFormData(prev => ({\n        ...prev,\n        stationId: selectedStation\n      }))\n    }\n  }, [selectedStation])\n\n  const fetchOfficeStaff = async () => {\n    if (!selectedStation) return\n\n    try {\n      setLoading(true)\n      const response = await fetch(`/api/office-staff?stationId=${selectedStation}`)\n      if (!response.ok) throw new Error('Failed to fetch office staff')\n      const data = await response.json()\n      setOfficeStaff(data)\n    } catch (_error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch office staff\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const [isSubmitting, setIsSubmitting] = useState(false)\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (isSubmitting) return\n\n    // Ensure stationId is set from selectedStation\n    if (!selectedStation) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a station first\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    setIsSubmitting(true)\n\n    try {\n      const url = editingStaff ? `/api/office-staff/${editingStaff.id}` : '/api/office-staff'\n      const method = editingStaff ? 'PUT' : 'POST'\n\n      // Always use current selectedStation for stationId\n      const submitData = {\n        ...formData,\n        stationId: selectedStation, // Always use current selectedStation\n        ...(editingStaff ? {} : { employeeId: undefined }) // Remove employeeId when creating (auto-generated)\n      }\n\n      console.log(' Submitting office staff data:', submitData)\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(submitData)\n      })\n\n      console.log(' Response status:', response.status, response.statusText)\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        const errorMessage = errorData.details || errorData.error || `Failed to ${editingStaff ? 'update' : 'create'} office staff`\n        throw new Error(errorMessage)\n      }\n\n      await fetchOfficeStaff()\n      handleCloseDialog()\n\n      toast({\n        title: \"Success\",\n        description: `Office staff ${editingStaff ? 'updated' : 'created'} successfully`\n      })\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : `Failed to ${editingStaff ? 'update' : 'create'} office staff`,\n        variant: \"destructive\"\n      })\n    } finally {\n      setIsSubmitting(false)\n    }\n  }\n\n  const handleDelete = async (id: string) => {\n    if (!confirm('Are you sure you want to delete this office staff member?')) return\n\n    try {\n      const response = await fetch(`/api/office-staff/${id}`, {\n        method: 'DELETE'\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to delete office staff')\n      }\n\n      await fetchOfficeStaff()\n      setDeletingStaffId(null)\n\n      toast({\n        title: \"Success\",\n        description: \"Office staff deleted successfully\"\n      })\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Failed to delete office staff\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleEdit = (staff: OfficeStaff) => {\n    setEditingStaff(staff)\n    setFormData({\n      name: staff.name || '',\n      employeeId: staff.employeeId || '',\n      stationId: staff.stationId || '',\n      role: staff.role,\n      phone: staff.phone || '',\n      email: staff.email || '',\n      baseSalary: staff.baseSalary || 0,\n      specialAllowance: staff.specialAllowance || 0,\n      otherAllowances: staff.otherAllowances || 0,\n      medicalAllowance: staff.medicalAllowance || 0,\n      holidayAllowance: staff.holidayAllowance || 0,\n      fuelAllowance: staff.fuelAllowance || 0,\n      hireDate: staff.hireDate ? new Date(staff.hireDate).toISOString().split('T')[0] : '',\n      isActive: staff.isActive\n    })\n    setDialogOpen(true)\n  }\n\n  const handleCloseDialog = () => {\n    setDialogOpen(false)\n    setEditingStaff(null)\n    setFormData({\n      name: '',\n      employeeId: '',\n      stationId: selectedStation || '',\n      role: 'OFFICE_STAFF',\n      phone: '',\n      email: '',\n      baseSalary: 0,\n      specialAllowance: 0,\n      otherAllowances: 0,\n      medicalAllowance: 0,\n      holidayAllowance: 0,\n      fuelAllowance: 0,\n      hireDate: new Date().toISOString().split('T')[0],\n      isActive: true\n    })\n  }\n\n  const columns = [\n    {\n      key: 'name' as keyof OfficeStaff,\n      title: 'Name',\n      render: (value: unknown, row: OfficeStaff) => (\n        <div className=\"flex items-center gap-2\">\n          <Briefcase className=\"h-4 w-4 text-muted-foreground\" />\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            {row.employeeId && (\n              <div className=\"text-xs text-muted-foreground\">ID: {row.employeeId}</div>\n            )}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'role' as keyof OfficeStaff,\n      title: 'Role',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{String(value).replace('_', ' ')}</Badge>\n      )\n    },\n    {\n      key: 'phone' as keyof OfficeStaff,\n      title: 'Phone',\n      render: (value: unknown) => value ? (\n        <div className=\"flex items-center gap-1\">\n          <Phone className=\"h-3 w-3 text-muted-foreground\" />\n          <span>{value as string}</span>\n        </div>\n      ) : (\n        <span className=\"text-muted-foreground\">-</span>\n      )\n    },\n    {\n      key: 'email' as keyof OfficeStaff,\n      title: 'Email',\n      render: (value: unknown) => value ? (\n        <div className=\"flex items-center gap-1\">\n          <Mail className=\"h-3 w-3 text-muted-foreground\" />\n          <span>{value as string}</span>\n        </div>\n      ) : (\n        <span className=\"text-muted-foreground\">-</span>\n      )\n    },\n    {\n      key: 'baseSalary' as keyof OfficeStaff,\n      title: 'Base Salary',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          <DollarSign className=\"h-4 w-4 text-green-600\" />\n          <span>Rs. {(value as number).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n        </div>\n      )\n    },\n    {\n      key: 'isActive' as keyof OfficeStaff,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge variant={value ? 'default' : 'secondary'}>\n          {value ? 'Active' : 'Inactive'}\n        </Badge>\n      )\n    },\n    {\n      key: 'id' as keyof OfficeStaff,\n      title: 'Actions',\n      render: (value: unknown, row: OfficeStaff) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleDelete(row.id)}\n            disabled={deletingStaffId === row.id}\n            className=\"text-red-600 dark:text-red-400 hover:text-red-700 disabled:opacity-50\"\n          >\n            {deletingStaffId === row.id ? (\n              <span className=\"text-xs\">Deleting...</span>\n            ) : (\n              <Trash2 className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </div>\n      )\n    }\n  ]\n\n  if (!selectedStation) {\n    return (\n      <div className=\"space-y-6 p-6\">\n        <FormCard title=\"Office Staff Management\" description=\"Manage office staff members\">\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Building2 className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n            <p>Please select a station to manage office staff</p>\n          </div>\n        </FormCard>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n              <Briefcase className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n              Office Staff Management\n            </h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Manage office employees (Managers, Supervisors, Office Staff, Accountants, Cashiers)\n            </p>\n          </div>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={handleCloseDialog}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Office Staff\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>{editingStaff ? 'Edit Office Staff' : 'Add New Office Staff'}</DialogTitle>\n              <DialogDescription>\n                {editingStaff ? 'Update office staff information' : 'Enter details for the new office staff member'}\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"name\">Name *</Label>\n                  <Input\n                    id=\"name\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    placeholder=\"John Doe\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"employeeId\">Employee ID</Label>\n                  <Input\n                    id=\"employeeId\"\n                    value={formData.employeeId}\n                    onChange={(e) => setFormData({ ...formData, employeeId: e.target.value })}\n                    placeholder={editingStaff ? formData.employeeId : \"Auto-generated (OFC001)\"}\n                    disabled={!editingStaff}\n                  />\n                  {!editingStaff && (\n                    <p className=\"text-xs text-muted-foreground mt-1\">Auto-generated on creation</p>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"role\">Role *</Label>\n                  <Select\n                    value={formData.role}\n                    onValueChange={(value) => {\n                      const newRole = value as OfficeStaff['role']\n                      // Reset fuel allowance if role changes from MANAGER\n                      setFormData({\n                        ...formData,\n                        role: newRole,\n                        fuelAllowance: newRole === 'MANAGER' ? formData.fuelAllowance : 0\n                      })\n                    }}\n                  >\n                    <SelectTrigger id=\"role\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"MANAGER\">Manager</SelectItem>\n                      <SelectItem value=\"SUPERVISOR\">Supervisor</SelectItem>\n                      <SelectItem value=\"OFFICE_STAFF\">Office Staff</SelectItem>\n                      <SelectItem value=\"ACCOUNTANT\">Accountant</SelectItem>\n                      <SelectItem value=\"CASHIER\">Cashier</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label htmlFor=\"baseSalary\">Base Salary (Rs.) *</Label>\n                  <MoneyInput\n                    value={formData.baseSalary}\n                    onChange={(value) => setFormData({ ...formData, baseSalary: value || 0 })}\n                    placeholder=\"0.00\"\n                  />\n                </div>\n              </div>\n\n              {/* Allowances Section */}\n              <div className=\"space-y-3 pt-2 border-t\">\n                <h4 className=\"text-sm font-semibold\">Allowances (Rs.)</h4>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"specialAllowance\">Special Allowance</Label>\n                    <MoneyInput\n                      value={formData.specialAllowance}\n                      onChange={(value) => setFormData({ ...formData, specialAllowance: value || 0 })}\n                      placeholder=\"0.00\"\n                    />\n                    <p className=\"text-xs text-muted-foreground mt-1\">Different for each staff member</p>\n                  </div>\n                  <div>\n                    <Label htmlFor=\"otherAllowances\">Other Allowances</Label>\n                    <MoneyInput\n                      value={formData.otherAllowances}\n                      onChange={(value) => setFormData({ ...formData, otherAllowances: value || 0 })}\n                      placeholder=\"0.00\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"medicalAllowance\">Medical Allowance</Label>\n                    <MoneyInput\n                      value={formData.medicalAllowance}\n                      onChange={(value) => setFormData({ ...formData, medicalAllowance: value || 0 })}\n                      placeholder=\"0.00\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"holidayAllowance\">Holiday Allowance</Label>\n                    <MoneyInput\n                      value={formData.holidayAllowance}\n                      onChange={(value) => setFormData({ ...formData, holidayAllowance: value || 0 })}\n                      placeholder=\"0.00\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"fuelAllowance\">Fuel Allowance</Label>\n                    <MoneyInput\n                      value={formData.fuelAllowance}\n                      onChange={(value) => setFormData({ ...formData, fuelAllowance: value || 0 })}\n                      placeholder=\"0.00\"\n                      disabled={formData.role !== 'MANAGER'}\n                    />\n                    {formData.role === 'MANAGER' ? (\n                      <p className=\"text-xs text-muted-foreground mt-1\">Only for managers</p>\n                    ) : (\n                      <p className=\"text-xs text-muted-foreground mt-1 text-orange-600\">Only available for Manager role</p>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"phone\">Phone</Label>\n                  <Input\n                    id=\"phone\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                    placeholder=\"0712345678\"\n                    type=\"tel\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    value={formData.email}\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                    placeholder=\"john@example.com\"\n                    type=\"email\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"hireDate\">Hire Date</Label>\n                  <Input\n                    id=\"hireDate\"\n                    value={formData.hireDate}\n                    onChange={(e) => setFormData({ ...formData, hireDate: e.target.value })}\n                    type=\"date\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"isActive\">Status</Label>\n                  <Select\n                    value={formData.isActive ? 'true' : 'false'}\n                    onValueChange={(value) => setFormData({ ...formData, isActive: value === 'true' })}\n                  >\n                    <SelectTrigger id=\"isActive\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"true\">Active</SelectItem>\n                      <SelectItem value=\"false\">Inactive</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button type=\"button\" variant=\"outline\" onClick={handleCloseDialog} disabled={isSubmitting}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={isSubmitting}>\n                  {isSubmitting ? 'Saving...' : editingStaff ? 'Update' : 'Create'}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <FormCard\n        title=\"Office Staff List\"\n        description={`Office staff members for ${stations.find(s => s.id === selectedStation)?.name || 'selected station'}`}\n      >\n        {loading ? (\n          <div className=\"flex items-center justify-center py-8\">\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n          </div>\n        ) : officeStaff.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Briefcase className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n            <p>No office staff found</p>\n            <p className=\"text-sm\">Click &quot;Add Office Staff&quot; to create a new office staff member</p>\n          </div>\n        ) : (\n          <DataTable\n            data={officeStaff}\n            columns={columns}\n            searchPlaceholder=\"Search office staff...\"\n          />\n        )}\n      </FormCard>\n    </div>\n  )\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used.","line":10,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isManager' is assigned a value but never used.","line":39,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useRouter } from 'next/navigation'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport {\n  Building2,\n  CreditCard,\n  Clock,\n  DollarSign,\n  Monitor,\n  Users,\n  Settings as SettingsIcon,\n  ChevronRight,\n  Database,\n  Gauge,\n  Shield,\n  Fuel,\n  Briefcase\n} from 'lucide-react'\n\ninterface SettingCard {\n  title: string\n  description: string\n  icon: React.ReactNode\n  href: string\n  features: string[]\n  color: string\n  minRole?: 'OWNER' | 'DEVELOPER'\n}\n\nexport default function SettingsPage() {\n  const router = useRouter()\n\n  // Get user role from localStorage\n  const userRole = typeof window !== 'undefined' ? localStorage.getItem('userRole') : null\n  const isDeveloper = userRole === 'DEVELOPER'\n  const isOwner = userRole === 'OWNER' || isDeveloper // Developer provides Owner access too\n  const isManager = userRole === 'MANAGER' || isOwner\n\n  const settings: SettingCard[] = [\n    {\n      title: 'Stations',\n      description: 'Manage petrol stations, locations, and basic information',\n      icon: <Building2 className=\"h-8 w-8\" />,\n      href: '/settings/stations',\n      features: [\n        // Only DEVELOPER can Add/Delete, others can only Edit\n        isDeveloper ? 'Add/Edit/Delete stations' : 'Edit stations',\n        'Station codes and names',\n        'Location and contact details',\n        'Operating hours configuration'\n      ],\n      color: 'text-blue-600 dark:text-blue-400',\n      minRole: 'DEVELOPER'\n    },\n    {\n      title: 'Pumpers',\n      description: 'Manage pumper employees, shifts, and specializations',\n      icon: <Users className=\"h-8 w-8\" />,\n      href: '/settings/pumpers',\n      features: [\n        'Add/Edit/Delete pumpers',\n        'Employee details and contact',\n        'Shift preferences and assignments',\n        'Performance ratings and specializations'\n      ],\n      color: 'text-indigo-600'\n    },\n    {\n      title: 'Office Staff',\n      description: 'Manage office employees (managers, supervisors, office staff)',\n      icon: <Briefcase className=\"h-8 w-8\" />,\n      href: '/settings/office-staff',\n      features: [\n        'Add/Edit/Delete office staff',\n        'Employee details and contact',\n        'Role management (Manager, Supervisor, etc.)',\n        'Base salary configuration'\n      ],\n      color: 'text-teal-600 dark:text-teal-400'\n    },\n    {\n      title: 'Banks',\n      description: 'Configure bank accounts and payment processing settings',\n      icon: <CreditCard className=\"h-8 w-8\" />,\n      href: '/settings/banks',\n      features: [\n        'Bank account management',\n        'Account numbers and details',\n        'Payment processing setup',\n        'Integration configurations'\n      ],\n      color: 'text-green-600 dark:text-green-400'\n    },\n    {\n      title: 'Shift Templates',\n      description: 'Define shift patterns and working hour templates',\n      icon: <Clock className=\"h-8 w-8\" />,\n      href: '/settings/shift-templates',\n      features: [\n        'Create shift patterns',\n        'Start/End time templates',\n        'Break configurations',\n        'Template assignments'\n      ],\n      color: 'text-purple-600 dark:text-purple-400'\n    },\n    {\n      title: 'Fuels',\n      description: 'Manage fuel types, pricing, inventory, and price history',\n      icon: <Fuel className=\"h-8 w-8\" />,\n      href: '/settings/prices',\n      features: [\n        'Add new fuel types to system',\n        'Current price management',\n        'Price history tracking',\n        'Inventory monitoring by fuel type'\n      ],\n      color: 'text-orange-600 dark:text-orange-400'\n    },\n    {\n      title: 'POS Terminals',\n      description: 'Configure point-of-sale terminals and payment devices',\n      icon: <Monitor className=\"h-8 w-8\" />,\n      href: '/settings/pos-terminals',\n      features: [\n        'Terminal registration',\n        'Device configurations',\n        'Bank associations',\n        'Status monitoring'\n      ],\n      color: 'text-cyan-600'\n    },\n    {\n      title: 'Users',\n      description: 'Manage system users, roles, and access permissions',\n      icon: <Users className=\"h-8 w-8\" />,\n      href: '/settings/users',\n      features: [\n        'User account management',\n        'Role assignments',\n        'Access control',\n        'Profile management'\n      ],\n      color: 'text-red-600 dark:text-red-400',\n      minRole: 'OWNER'\n    },\n    {\n      title: 'Tolerance Settings',\n      description: 'Configure variance tolerance levels and thresholds',\n      icon: <Gauge className=\"h-8 w-8\" />,\n      href: '/settings/tolerance',\n      features: [\n        'Percentage tolerance setup',\n        'Flat amount thresholds',\n        'Combined tolerance rules',\n        'Alert configurations'\n      ],\n      color: 'text-indigo-600',\n      minRole: 'OWNER'\n    },\n    {\n      title: 'Tanks & Infrastructure',\n      description: 'Manage fuel tanks, pumps, and nozzle infrastructure',\n      icon: <Fuel className=\"h-8 w-8\" />,\n      href: '/settings/tanks',\n      features: [\n        'Add/Edit/Delete tanks',\n        'Create pumps and nozzles',\n        'Infrastructure setup',\n        'Tank capacity management'\n      ],\n      color: 'text-orange-600 dark:text-orange-400'\n    }\n  ]\n\n  const getRoleStyle = (minRole?: string) => {\n    switch (minRole) {\n      case 'DEVELOPER':\n        return 'border-rose-500/20 dark:border-rose-500/30 bg-rose-500/10 dark:bg-rose-500/20'\n      case 'OWNER':\n        return 'border-orange-500/20 dark:border-orange-500/30 bg-orange-500/10 dark:bg-orange-500/20'\n      default:\n        return ''\n    }\n  }\n\n  const getRoleBadge = (minRole?: string) => {\n    switch (minRole) {\n      case 'DEVELOPER':\n        return (\n          <span className=\"text-xs bg-rose-500/20 text-rose-600 dark:text-rose-400 px-2 py-1 rounded-full font-medium border border-rose-500/20\">\n            DEVELOPER ONLY\n          </span>\n        )\n      case 'OWNER':\n        return (\n          <span className=\"text-xs bg-orange-500/20 text-orange-600 dark:text-orange-400 px-2 py-1 rounded-full font-medium border border-orange-500/20\">\n            OWNER ONLY\n          </span>\n        )\n      default:\n        return null\n    }\n  }\n\n  // Filter settings based on role\n  const visibleSettings = settings.filter(setting => {\n    if (setting.minRole === 'DEVELOPER') return isDeveloper\n    if (setting.minRole === 'OWNER') return isOwner\n    return true\n  })\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">System Settings</h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Configure system parameters, manage master data, and control access permissions\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <SettingsIcon className=\"h-6 w-6 text-muted-foreground\" />\n          <span className=\"text-sm text-muted-foreground\">Configuration Management</span>\n        </div>\n      </div>\n\n      {/* Settings Cards */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {visibleSettings.map((setting, index) => (\n          <Card\n            key={index}\n            className={`hover:shadow-lg transition-shadow cursor-pointer ${getRoleStyle(setting.minRole)}`}\n            onClick={() => router.push(setting.href)}\n          >\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <div className={setting.color}>\n                    {setting.icon}\n                  </div>\n                  <div>\n                    <h3 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n                      {setting.title}\n                      {getRoleBadge(setting.minRole)}\n                    </h3>\n                    <p className=\"text-sm text-muted-foreground font-normal\">{setting.description}</p>\n                  </div>\n                </div>\n                <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                <div className=\"text-sm font-medium text-foreground mb-2\">Features:</div>\n                <ul className=\"space-y-1\">\n                  {setting.features.map((feature, featureIndex) => (\n                    <li key={featureIndex} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <div className=\"w-1.5 h-1.5 bg-muted-foreground rounded-full flex-shrink-0\"></div>\n                      {feature}\n                    </li>\n                  ))}\n                </ul>\n                <div className=\"pt-3\">\n                  <Button\n                    className=\"w-full\"\n                    onClick={(e) => {\n                      e.stopPropagation()\n                      router.push(setting.href)\n                    }}\n                  >\n                    Configure\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* System Information */}\n      <Card>\n        <CardHeader>\n          <CardTitle>System Information</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-2 flex items-center gap-2\">\n                <Database className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                Data Management\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\n                <li> Master data configuration</li>\n                <li> Reference data management</li>\n                <li> Data validation rules</li>\n                <li> Backup and restore</li>\n              </ul>\n            </div>\n\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-2 flex items-center gap-2\">\n                <Users className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                Access Control\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\n                <li> Role-based permissions</li>\n                <li> Feature-level access</li>\n                <li> Audit trail logging</li>\n                <li> Session management</li>\n              </ul>\n            </div>\n\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-2 flex items-center gap-2\">\n                <SettingsIcon className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n                Configuration\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\n                <li> System parameters</li>\n                <li> Business rules</li>\n                <li> Integration settings</li>\n                <li> Notification preferences</li>\n              </ul>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Quick Actions */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Quick Actions</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-wrap gap-3\">\n            <Button variant=\"outline\" onClick={() => router.push('/settings/stations')}>\n              <Building2 className=\"mr-2 h-4 w-4\" />\n              Manage Stations\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/settings/pumpers')}>\n              <Users className=\"mr-2 h-4 w-4\" />\n              Manage Pumpers\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/settings/office-staff')}>\n              <Briefcase className=\"mr-2 h-4 w-4\" />\n              Manage Office Staff\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/settings/prices')}>\n              <Fuel className=\"mr-2 h-4 w-4\" />\n              Manage Fuels\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/settings/users')}>\n              <Shield className=\"mr-2 h-4 w-4\" />\n              User Management\n            </Button>\n            <Button variant=\"outline\" onClick={() => router.push('/settings/tolerance')}>\n              <Gauge className=\"mr-2 h-4 w-4\" />\n              Tolerance Config\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\pos-terminals\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":10,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":10,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":54,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":54,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTerminals'. Either include it or remove the dependency array.","line":70,"column":6,"nodeType":"ArrayExpression","endLine":70,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTerminals, selectedStation]","fix":{"range":[1959,1976],"text":"[fetchTerminals, selectedStation]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":82,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":82,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":137,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":137,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":174,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":174,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Monitor, Plus, Edit, Trash2, Building2, Wifi, CreditCard } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { ArrowLeft } from 'lucide-react'\nimport { useStation } from '@/contexts/StationContext'\n\ninterface POSTerminal {\n  id: string\n  terminalNumber: string\n  name: string\n  stationId: string\n  station?: {\n    id: string\n    name: string\n  }\n  bankId?: string\n  bank?: {\n    id: string\n    name: string\n  }\n  isActive: boolean\n  createdAt: string\n  updatedAt: string\n}\n\ninterface Station {\n  id: string\n  name: string\n}\n\ninterface Bank {\n  id: string\n  name: string\n  accountNumber?: string | null\n}\n\nexport default function POSTerminalsPage() {\n  const router = useRouter()\n  const { selectedStation, isAllStations } = useStation()\n  const [terminals, setTerminals] = useState<POSTerminal[]>([])\n  const [stations, setStations] = useState<Station[]>([])\n  const [banks, setBanks] = useState<Bank[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingTerminal, setEditingTerminal] = useState<POSTerminal | null>(null)\n  const [formData, setFormData] = useState({\n    terminalNumber: '',\n    name: '',\n    stationId: '',\n    bankId: '',\n    isActive: true\n  })\n  const { toast } = useToast()\n\n  useEffect(() => {\n    fetchTerminals()\n    fetchStations()\n    fetchBanks()\n  }, [selectedStation]) // Re-fetch when station changes\n\n  const fetchTerminals = async () => {\n    try {\n      // Build URL with stationId filter\n      const url = isAllStations\n        ? '/api/pos/terminals'\n        : `/api/pos/terminals?stationId=${selectedStation}`\n\n      const response = await fetch(url)\n      const data = await response.json()\n      setTerminals(data)\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch POS terminals\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const fetchStations = async () => {\n    try {\n      const response = await fetch('/api/stations')\n      const data = await response.json()\n      setStations(data)\n    } catch (error) {\n      console.error('Failed to fetch stations:', error)\n    }\n  }\n\n  const fetchBanks = async () => {\n    try {\n      const response = await fetch('/api/banks')\n      const data = await response.json()\n      setBanks(Array.isArray(data) ? data : [])\n    } catch (error) {\n      console.error('Failed to fetch banks:', error)\n      setBanks([])\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    try {\n      const url = editingTerminal ? `/api/pos/terminals/${editingTerminal.id}` : '/api/pos/terminals'\n      const method = editingTerminal ? 'PUT' : 'POST'\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(formData)\n      })\n\n      if (!response.ok) throw new Error('Failed to save POS terminal')\n\n      toast({\n        title: \"Success\",\n        description: `POS terminal ${editingTerminal ? 'updated' : 'created'} successfully`\n      })\n\n      setDialogOpen(false)\n      resetForm()\n      fetchTerminals()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: `Failed to ${editingTerminal ? 'update' : 'create'} POS terminal`,\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleEdit = (terminal: POSTerminal) => {\n    setEditingTerminal(terminal)\n    setFormData({\n      terminalNumber: terminal.terminalNumber || '',\n      name: terminal.name || '',\n      stationId: terminal.stationId || '',\n      bankId: terminal.bankId || '',\n      isActive: terminal.isActive\n    })\n    setDialogOpen(true)\n  }\n\n  const handleDelete = async (terminal: POSTerminal) => {\n    if (!confirm(`Are you sure you want to delete POS terminal \"${terminal.name}\"?`)) return\n\n    try {\n      const response = await fetch(`/api/pos/terminals/${terminal.id}`, {\n        method: 'DELETE'\n      })\n\n      if (!response.ok) throw new Error('Failed to delete POS terminal')\n\n      toast({\n        title: \"Success\",\n        description: \"POS terminal deleted successfully\"\n      })\n\n      fetchTerminals()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete POS terminal\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const resetForm = () => {\n    setEditingTerminal(null)\n    setFormData({\n      terminalNumber: '',\n      name: '',\n      stationId: !isAllStations && selectedStation ? selectedStation : '',\n      bankId: '',\n      isActive: true\n    })\n  }\n\n  const getStatusColor = (isActive: boolean) => {\n    return isActive ? 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300' : 'bg-muted text-foreground'\n  }\n\n  const getStatusIcon = (isActive: boolean) => {\n    return isActive ? <Wifi className=\"h-3 w-3 text-green-600 dark:text-green-400\" /> : <Monitor className=\"h-3 w-3 text-muted-foreground\" />\n  }\n\n  const getStatusText = (isActive: boolean) => {\n    return isActive ? 'Active' : 'Inactive'\n  }\n\n  const columns = [\n    {\n      key: 'terminalNumber' as keyof POSTerminal,\n      title: 'Terminal Number',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'name' as keyof POSTerminal,\n      title: 'Terminal Name',\n      render: (value: unknown) => (\n        <div className=\"font-medium\">{value as string}</div>\n      )\n    },\n    {\n      key: 'station' as keyof POSTerminal,\n      title: 'Station',\n      render: (value: unknown) => {\n        const station = value as { name: string } | undefined\n        return (\n          <div className=\"flex items-center gap-1 text-sm\">\n            <Building2 className=\"h-3 w-3 text-muted-foreground\" />\n            {station?.name || 'Unknown'}\n          </div>\n        )\n      }\n    },\n    {\n      key: 'bank' as keyof POSTerminal,\n      title: 'Bank',\n      render: (value: unknown) => {\n        const bank = value as { name: string } | undefined\n        return (\n          <div className=\"flex items-center gap-1 text-sm\">\n            <CreditCard className=\"h-3 w-3 text-muted-foreground\" />\n            {bank?.name || '-'}\n          </div>\n        )\n      }\n    },\n    {\n      key: 'isActive' as keyof POSTerminal,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as boolean)}>\n          <div className=\"flex items-center gap-1\">\n            {getStatusIcon(value as boolean)}\n            {getStatusText(value as boolean)}\n          </div>\n        </Badge>\n      )\n    },\n    {\n      key: 'id' as keyof POSTerminal,\n      title: 'Actions',\n      render: (value: unknown, row: POSTerminal) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleDelete(row)}\n            className=\"text-red-600 dark:text-red-400 hover:text-red-700\"\n          >\n            <Trash2 className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      )\n    }\n  ]\n\n  const safeTerminals = Array.isArray(terminals) ? terminals : []\n\n  const stats = [\n    {\n      title: 'Total Terminals',\n      value: safeTerminals.length.toString(),\n      description: 'Registered terminals',\n      icon: <Monitor className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Active',\n      value: safeTerminals.filter(t => t.isActive).length.toString(),\n      description: 'Currently active',\n      icon: <div className=\"h-5 w-5 bg-green-500/10 dark:bg-green-500/200 rounded-full\" />\n    },\n    {\n      title: 'Inactive',\n      value: safeTerminals.filter(t => !t.isActive).length.toString(),\n      description: 'Not active',\n      icon: <div className=\"h-5 w-5 bg-muted0 rounded-full\" />\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">POS Terminal Management</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Configure point-of-sale terminals and payment processing devices\n            </p>\n          </div>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={resetForm}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Terminal\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingTerminal ? 'Edit POS Terminal' : 'Add New POS Terminal'}\n              </DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"terminalNumber\">Terminal Number</Label>\n                <Input\n                  id=\"terminalNumber\"\n                  value={formData.terminalNumber}\n                  onChange={(e) => setFormData({ ...formData, terminalNumber: e.target.value })}\n                  placeholder=\"e.g., POS001\"\n                  required\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"name\">Terminal Name</Label>\n                <Input\n                  id=\"name\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  placeholder=\"e.g., Main Counter POS\"\n                  required\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"stationId\">Station</Label>\n                <select\n                  id=\"stationId\"\n                  value={formData.stationId}\n                  onChange={(e) => setFormData({ ...formData, stationId: e.target.value })}\n                  className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                  required\n                >\n                  <option value=\"\">Select Station</option>\n                  {stations.map((station) => (\n                    <option key={station.id} value={station.id}>\n                      {station.name}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              <div>\n                <Label htmlFor=\"bankId\">Bank</Label>\n                <select\n                  id=\"bankId\"\n                  value={formData.bankId}\n                  onChange={(e) => setFormData({ ...formData, bankId: e.target.value })}\n                  className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                >\n                  <option value=\"\">Select Bank (Optional)</option>\n                  {banks && banks.length > 0 ? (\n                    banks.map((bank) => (\n                      <option key={bank.id} value={bank.id}>\n                        {bank.name}{bank.accountNumber ? ` - ${bank.accountNumber}` : ''}\n                      </option>\n                    ))\n                  ) : (\n                    <option disabled>Loading banks...</option>\n                  )}\n                </select>\n              </div>\n\n              {editingTerminal && (\n                <div>\n                  <Label htmlFor=\"isActive\">Status</Label>\n                  <select\n                    id=\"isActive\"\n                    value={formData.isActive ? 'true' : 'false'}\n                    onChange={(e) => setFormData({ ...formData, isActive: e.target.value === 'true' })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    <option value=\"true\">Active</option>\n                    <option value=\"false\">Inactive</option>\n                  </select>\n                </div>\n              )}\n\n              <div className=\"flex justify-end gap-3 pt-4\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">\n                  {editingTerminal ? 'Update Terminal' : 'Create Terminal'}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        {stats.map((stat, index) => (\n          <Card key={index}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-2xl font-bold text-foreground\">{stat.value}</div>\n                  <div className=\"text-sm font-medium text-foreground\">{stat.title}</div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.description}</div>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {stat.icon}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Terminals Table */}\n      <FormCard title=\"POS Terminals\" description=\"Manage point-of-sale terminals and payment processing devices\">\n        <DataTable\n          data={safeTerminals}\n          columns={columns}\n          searchPlaceholder=\"Search terminals...\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\prices\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":13,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":13,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Zap' is defined but never used.","line":13,"column":89,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":92},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Package' is defined but never used.","line":13,"column":94,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":101},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'newFuelDialogOpen' is assigned a value but never used.","line":70,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchFuels', 'fetchPrices', and 'fetchTanks'. Either include them or remove the dependency array.","line":91,"column":6,"nodeType":"ArrayExpression","endLine":91,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchFuels, fetchPrices, fetchTanks, selectedStation]","fix":{"range":[2659,2676],"text":"[fetchFuels, fetchPrices, fetchTanks, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogTrigger } from '@/components/ui/dialog'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { DollarSign, Plus, TrendingUp, Calendar, AlertCircle, Fuel, BarChart3, Droplet, Zap, Package } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { useRouter } from 'next/navigation'\nimport { ArrowLeft } from 'lucide-react'\n\ninterface Fuel {\n  id: string\n  code: string\n  name: string\n  category: string\n  description?: string | null\n  icon?: string | null\n  isActive: boolean\n  sortOrder: number\n  _count?: {\n    tanks: number\n    prices: number\n  }\n}\n\ninterface Price {\n  id: string\n  stationId: string\n  fuelId: string\n  fuel?: Fuel\n  price: number\n  effectiveDate: string\n  isActive: boolean\n  createdAt: string\n  station?: {\n    name: string\n  }\n}\n\ninterface Tank {\n  id: string\n  tankNumber: string\n  fuelId: string\n  fuel?: Fuel\n  capacity: number\n  currentLevel: number\n  station: {\n    name: string\n  }\n}\n\nexport default function FuelsPage() {\n  const router = useRouter()\n  const [prices, setPrices] = useState<Price[]>([])\n  const [tanks, setTanks] = useState<Tank[]>([])\n  const [fuels, setFuels] = useState<Fuel[]>([])\n  const [loading, setLoading] = useState(true)\n  const [priceDialogOpen, setPriceDialogOpen] = useState(false)\n  const [fuelTypeDialogOpen, setFuelTypeDialogOpen] = useState(false)\n  const [newFuelDialogOpen, setNewFuelDialogOpen] = useState(false)\n  const [activeTab, setActiveTab] = useState('overview')\n  const [formData, setFormData] = useState({\n    fuelId: '',\n    price: 0,\n    effectiveDate: new Date().toISOString().slice(0, 16)\n  })\n  const [newFuelData, setNewFuelData] = useState({\n    code: '',\n    name: '',\n    category: 'PETROL',\n    description: '',\n    icon: ''\n  })\n  const { selectedStation } = useStation()\n  const { toast } = useToast()\n\n  useEffect(() => {\n    fetchFuels()\n    fetchPrices()\n    fetchTanks()\n  }, [selectedStation])\n\n  const fetchFuels = async () => {\n    try {\n      const response = await fetch('/api/fuels')\n      if (!response.ok) throw new Error('Failed to fetch fuels')\n\n      const data = await response.json()\n      setFuels(Array.isArray(data) ? data : [])\n\n      // Set default fuel if not set\n      if (data.length > 0 && !formData.fuelId) {\n        setFormData(prev => ({ ...prev, fuelId: data[0].id }))\n      }\n    } catch (error) {\n      console.error('Error fetching fuels:', error)\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch fuel types\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const fetchPrices = async () => {\n    setLoading(true)\n    try {\n      const url = selectedStation && selectedStation !== 'all'\n        ? `/api/prices?stationId=${selectedStation}`\n        : '/api/prices'\n\n      const response = await fetch(url)\n      if (!response.ok) throw new Error('Failed to fetch prices')\n\n      const data = await response.json()\n      setPrices(Array.isArray(data) ? data : [])\n    } catch (error) {\n      console.error('Error fetching prices:', error)\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch prices\",\n        variant: \"destructive\"\n      })\n      setPrices([])\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const fetchTanks = async () => {\n    try {\n      const url = selectedStation && selectedStation !== 'all'\n        ? `/api/tanks?stationId=${selectedStation}`\n        : '/api/tanks'\n\n      const response = await fetch(url)\n      if (!response.ok) throw new Error('Failed to fetch tanks')\n\n      const data = await response.json()\n      setTanks(Array.isArray(data) ? data : [])\n    } catch (error) {\n      console.error('Error fetching tanks:', error)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || selectedStation === 'all') {\n      toast({\n        title: \"Error\",\n        description: \"Please select a specific station\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (!formData.fuelId) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a fuel type\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (formData.price <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Price must be greater than 0\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const response = await fetch('/api/prices', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          fuelId: formData.fuelId,\n          price: parseFloat(formData.price.toString()),\n          effectiveDate: new Date(formData.effectiveDate).toISOString()\n        })\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || 'Failed to add price')\n      }\n\n      toast({\n        title: \"Success\",\n        description: \"New price added successfully\"\n      })\n\n      setPriceDialogOpen(false)\n      setFormData({\n        fuelId: fuels[0]?.id || '',\n        price: 0,\n        effectiveDate: new Date().toISOString().slice(0, 16)\n      })\n      fetchPrices()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : 'Failed to add price',\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleAddFuel = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!newFuelData.code || !newFuelData.name) {\n      toast({\n        title: \"Error\",\n        description: \"Code and name are required\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const response = await fetch('/api/fuels', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(newFuelData)\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.error || 'Failed to add fuel type')\n      }\n\n      const newFuel = await response.json()\n\n      toast({\n        title: \"Success\",\n        description: `${newFuelData.name} added successfully!`\n      })\n\n      setNewFuelDialogOpen(false)\n      setNewFuelData({\n        code: '',\n        name: '',\n        category: 'PETROL',\n        description: '',\n        icon: ''\n      })\n\n      // Refresh fuels list\n      await fetchFuels()\n\n      // Open price dialog with new fuel selected\n      setFormData(prev => ({ ...prev, fuelId: newFuel.id }))\n      setFuelTypeDialogOpen(false)\n      setPriceDialogOpen(true)\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : 'Failed to add fuel type',\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  // Get current prices (most recent for each fuel type)\n  const getCurrentPrices = () => {\n    const currentPricesMap = new Map<string, Price>()\n\n    // Filter out any invalid prices and sort by date\n    const validPrices = prices.filter(p => p && p.fuelId && p.effectiveDate && p.price !== undefined)\n\n    const sortedPrices = [...validPrices].sort((a, b) =>\n      new Date(b.effectiveDate).getTime() - new Date(a.effectiveDate).getTime()\n    )\n\n    // Get the most recent price for each fuel type\n    for (const price of sortedPrices) {\n      if (!currentPricesMap.has(price.fuelId)) {\n        currentPricesMap.set(price.fuelId, price)\n      }\n    }\n\n    return Array.from(currentPricesMap.values())\n  }\n\n  const currentPrices = getCurrentPrices()\n  const activePricesCount = currentPrices.filter(p =>\n    p && p.effectiveDate && new Date(p.effectiveDate) <= new Date()\n  ).length\n\n  // Get valid prices for history table\n  const validPricesForHistory = prices.filter(p =>\n    p && p.fuelId && p.effectiveDate !== undefined && p.price !== undefined\n  )\n\n  // Calculate fuel statistics\n  const getFuelStats = () => {\n    const stats = new Map<string, {\n      totalCapacity: number,\n      currentStock: number,\n      tankCount: number,\n      currentPrice: number\n    }>()\n\n    // Initialize stats for all fuel types\n    fuels.forEach(fuel => {\n      stats.set(fuel.id, {\n        totalCapacity: 0,\n        currentStock: 0,\n        tankCount: 0,\n        currentPrice: 0\n      })\n    })\n\n    // Aggregate tank data\n    tanks.forEach(tank => {\n      const stat = stats.get(tank.fuelId)\n      if (stat) {\n        stat.totalCapacity += tank.capacity\n        stat.currentStock += tank.currentLevel\n        stat.tankCount += 1\n      }\n    })\n\n    // Add price data\n    currentPrices.forEach(price => {\n      const stat = stats.get(price.fuelId)\n      if (stat) {\n        stat.currentPrice = price.price || 0\n      }\n    })\n\n    return stats\n  }\n\n  const fuelStats = getFuelStats()\n\n  // Helper function to determine if a price is the current active one\n  const isCurrentPrice = (price: Price): boolean => {\n    const now = new Date()\n    const priceDate = new Date(price.effectiveDate)\n\n    // If price is in the future, it's not current\n    if (priceDate > now) return false\n\n    // Find all prices for the same fuel type and station\n    const sameFuelPrices = prices.filter(p =>\n      p.fuelId === price.fuelId &&\n      p.stationId === price.stationId &&\n      new Date(p.effectiveDate) <= now\n    )\n\n    // Sort by date descending to find the most recent\n    const sortedPrices = sameFuelPrices.sort((a, b) =>\n      new Date(b.effectiveDate).getTime() - new Date(a.effectiveDate).getTime()\n    )\n\n    // This price is current if it's the most recent one\n    return sortedPrices.length > 0 && sortedPrices[0].id === price.id\n  }\n\n  const columns: Column<Price>[] = [\n    {\n      key: 'fuelId',\n      title: 'Fuel Type',\n      render: (value, row) => (\n        <div className=\"flex items-center gap-2\">\n          <span className=\"text-xl\">{row.fuel?.icon || ''}</span>\n          <span className=\"font-medium\">{row.fuel?.name || 'Unknown'}</span>\n        </div>\n      )\n    },\n    {\n      key: 'price',\n      title: 'Price (LKR/L)',\n      render: (value, row) => (\n        <div className=\"font-semibold text-lg\">\n          Rs. {row.price.toFixed(2)}\n        </div>\n      )\n    },\n    {\n      key: 'effectiveDate',\n      title: 'Effective From',\n      render: (value, row) => (\n        <div className=\"text-sm\">\n          {new Date(row.effectiveDate).toLocaleString('en-US', {\n            year: 'numeric',\n            month: 'short',\n            day: 'numeric',\n            hour: '2-digit',\n            minute: '2-digit'\n          })}\n        </div>\n      )\n    },\n    {\n      key: 'stationId',\n      title: 'Station',\n      render: (value, row) => (\n        <div className=\"text-sm text-muted-foreground\">\n          {row.station?.name || 'Unknown'}\n        </div>\n      )\n    },\n    {\n      key: 'isActive',\n      title: 'Status',\n      render: (value, row) => {\n        const priceDate = new Date(row.effectiveDate)\n        const now = new Date()\n\n        // Future price\n        if (priceDate > now) {\n          return (\n            <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300\">\n              Scheduled\n            </Badge>\n          )\n        }\n\n        // Check if this is the current active price\n        const isCurrent = isCurrentPrice(row)\n\n        if (isCurrent) {\n          return (\n            <Badge variant=\"default\" className=\"bg-green-600 text-white\">\n              Active\n            </Badge>\n          )\n        }\n\n        // Historical/superseded price\n        return (\n          <Badge variant=\"secondary\" className=\"bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300\">\n            Historical\n          </Badge>\n        )\n      }\n    }\n  ]\n\n\n  const totalCapacity = Array.from(fuelStats.values()).reduce((sum, stat) => sum + stat.totalCapacity, 0)\n  const totalStock = Array.from(fuelStats.values()).reduce((sum, stat) => sum + stat.currentStock, 0)\n  const stockPercentage = totalCapacity > 0 ? (totalStock / totalCapacity) * 100 : 0\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight\">Fuels</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Comprehensive fuel management - types, pricing, and inventory\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Dialog open={fuelTypeDialogOpen} onOpenChange={setFuelTypeDialogOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add New Fuel Type\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-3xl max-h-[85vh] overflow-hidden flex flex-col\">\n              <DialogHeader>\n                <DialogTitle>Add New Fuel Type</DialogTitle>\n                <DialogDescription>\n                  Add a completely new fuel or oil type to your system.\n                </DialogDescription>\n              </DialogHeader>\n\n              <div className=\"overflow-y-auto flex-1 pr-2\">\n                <form onSubmit={handleAddFuel} className=\"space-y-4 mt-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"newFuelName\">Fuel Name *</Label>\n                      <Input\n                        id=\"newFuelName\"\n                        value={newFuelData.name}\n                        onChange={(e) => setNewFuelData({ ...newFuelData, name: e.target.value })}\n                        placeholder=\"e.g., Bio Diesel, Hydrogen\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"newFuelCode\">Code *</Label>\n                      <Input\n                        id=\"newFuelCode\"\n                        value={newFuelData.code}\n                        onChange={(e) => setNewFuelData({ ...newFuelData, code: e.target.value.toUpperCase().replace(/\\s+/g, '_') })}\n                        placeholder=\"e.g., BIO_DIESEL\"\n                        required\n                      />\n                      <p className=\"text-xs text-muted-foreground mt-1\">Unique identifier (auto-formatted)</p>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"newFuelCategory\">Category *</Label>\n                      <Select\n                        value={newFuelData.category}\n                        onValueChange={(value) => setNewFuelData({ ...newFuelData, category: value })}\n                      >\n                        <SelectTrigger>\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"PETROL\">Petrol</SelectItem>\n                          <SelectItem value=\"DIESEL\">Diesel</SelectItem>\n                          <SelectItem value=\"OIL\">Oil</SelectItem>\n                          <SelectItem value=\"GAS\">Gas (LPG/CNG)</SelectItem>\n                          <SelectItem value=\"ELECTRIC\">Electric</SelectItem>\n                          <SelectItem value=\"HYDROGEN\">Hydrogen</SelectItem>\n                          <SelectItem value=\"OTHER\">Other</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"newFuelIcon\">Icon (Emoji)</Label>\n                      <Input\n                        id=\"newFuelIcon\"\n                        value={newFuelData.icon}\n                        onChange={(e) => setNewFuelData({ ...newFuelData, icon: e.target.value })}\n                        placeholder=\"\"\n                        maxLength={2}\n                      />\n                      <p className=\"text-xs text-muted-foreground mt-1\">Single emoji character</p>\n                    </div>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"newFuelDescription\">Description (Optional)</Label>\n                    <Input\n                      id=\"newFuelDescription\"\n                      value={newFuelData.description}\n                      onChange={(e) => setNewFuelData({ ...newFuelData, description: e.target.value })}\n                      placeholder=\"e.g., Environmentally friendly bio-diesel blend\"\n                    />\n                  </div>\n\n                  <div className=\"bg-blue-50 dark:bg-blue-950/30 p-4 rounded-lg\">\n                    <h4 className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                      <AlertCircle className=\"h-4 w-4 text-blue-600\" />\n                      Preview\n                    </h4>\n                    <div className=\"flex items-center gap-3 bg-white dark:bg-gray-900 p-3 rounded border\">\n                      <span className=\"text-2xl\">{newFuelData.icon || ''}</span>\n                      <div>\n                        <p className=\"font-medium\">{newFuelData.name || 'Fuel Name'}</p>\n                        <p className=\"text-xs text-muted-foreground\">{newFuelData.code || 'FUEL_CODE'}  {newFuelData.category}</p>\n                        {newFuelData.description && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">{newFuelData.description}</p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"flex justify-end gap-2 pt-4 border-t\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setFuelTypeDialogOpen(false)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\">\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Add Fuel Type\n                    </Button>\n                  </div>\n                </form>\n\n                <div className=\"mt-6 pt-6 border-t\">\n                  <h4 className=\"font-semibold text-sm mb-3\">Existing Fuel Types ({fuels.length})</h4>\n                  <div className=\"grid grid-cols-2 gap-2 max-h-40 overflow-y-auto\">\n                    {fuels.map((fuel) => (\n                      <div\n                        key={fuel.id}\n                        className=\"flex items-center gap-2 p-2 rounded border bg-gray-50 dark:bg-gray-900\"\n                      >\n                        <span className=\"text-lg\">{fuel.icon}</span>\n                        <span className=\"flex-1 text-xs font-medium\">{fuel.name}</span>\n                        {fuel.isActive && <Badge variant=\"default\" className=\"text-xs\">Active</Badge>}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </DialogContent>\n          </Dialog>\n\n          <Dialog open={priceDialogOpen} onOpenChange={setPriceDialogOpen}>\n            <DialogTrigger asChild>\n              <Button>\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add New Price\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Add New Fuel Price</DialogTitle>\n                <DialogDescription>\n                  Add a new price for a fuel type. This will be effective from the date you specify.\n                </DialogDescription>\n              </DialogHeader>\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"fuelId\">Fuel Type</Label>\n                  <Select\n                    value={formData.fuelId}\n                    onValueChange={(value) => setFormData({ ...formData, fuelId: value })}\n                  >\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select fuel type\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {fuels.filter(f => f.isActive).map(fuel => (\n                        <SelectItem key={fuel.id} value={fuel.id}>\n                          {fuel.icon} {fuel.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"price\">Price (LKR per Liter)</Label>\n                  <MoneyInput\n                    id=\"price\"\n                    value={formData.price}\n                    onChange={(value) => setFormData({ ...formData, price: value })}\n                    placeholder=\"0.00\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"effectiveDate\">Effective From</Label>\n                  <Input\n                    type=\"datetime-local\"\n                    id=\"effectiveDate\"\n                    value={formData.effectiveDate}\n                    onChange={(e) => setFormData({ ...formData, effectiveDate: e.target.value })}\n                    required\n                  />\n                </div>\n\n                {selectedStation === 'all' && (\n                  <div className=\"bg-yellow-50 dark:bg-yellow-950 p-3 rounded-lg flex items-start gap-2\">\n                    <AlertCircle className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400 mt-0.5\" />\n                    <p className=\"text-sm text-yellow-800 dark:text-yellow-200\">\n                      Please select a specific station to add prices\n                    </p>\n                  </div>\n                )}\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setPriceDialogOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={selectedStation === 'all'}>\n                    Add Price\n                  </Button>\n                </div>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full max-w-md grid-cols-3\">\n          <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n          <TabsTrigger value=\"prices\">Prices</TabsTrigger>\n          <TabsTrigger value=\"inventory\">Inventory</TabsTrigger>\n        </TabsList>\n\n        {/* Overview Tab */}\n        <TabsContent value=\"overview\" className=\"space-y-6\">\n          {/* Stats Cards */}\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Fuel Types</CardTitle>\n                <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{fuels.length}</div>\n                <p className=\"text-xs text-muted-foreground\">Available types</p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Total Capacity</CardTitle>\n                <Droplet className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{totalCapacity.toLocaleString()}</div>\n                <p className=\"text-xs text-muted-foreground\">Liters across all tanks</p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Current Stock</CardTitle>\n                <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{totalStock.toLocaleString()}</div>\n                <p className=\"text-xs text-muted-foreground\">{stockPercentage.toFixed(1)}% capacity</p>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">Active Prices</CardTitle>\n                <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{activePricesCount}</div>\n                <p className=\"text-xs text-muted-foreground\">Currently effective</p>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Fuel Type Details */}\n          <FormCard\n            title=\"Fuel Types & Statistics\"\n            description=\"Detailed breakdown by fuel type\"\n          >\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {fuels.map(fuel => {\n                const stats = fuelStats.get(fuel.id)\n                if (!stats) return null\n\n                const stockPerc = stats.totalCapacity > 0\n                  ? (stats.currentStock / stats.totalCapacity) * 100\n                  : 0\n\n                return (\n                  <Card key={fuel.id} className=\"overflow-hidden\">\n                    <CardHeader className=\"pb-3 bg-muted/30\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"text-2xl\">{fuel.icon}</span>\n                          <CardTitle className=\"text-sm font-medium\">\n                            {fuel.name}\n                          </CardTitle>\n                        </div>\n                        <Badge variant=\"outline\">{stats.tankCount} tanks</Badge>\n                      </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3 pt-4\">\n                      {/* Price */}\n                      <div>\n                        <p className=\"text-xs text-muted-foreground mb-1\">Current Price</p>\n                        <p className=\"text-2xl font-bold\">\n                          Rs. {stats.currentPrice.toFixed(2)}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">per liter</p>\n                      </div>\n\n                      {/* Inventory */}\n                      <div className=\"pt-3 border-t space-y-1\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Capacity:</span>\n                          <span className=\"font-medium\">{stats.totalCapacity.toLocaleString()} L</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Stock:</span>\n                          <span className=\"font-medium\">{stats.currentStock.toLocaleString()} L</span>\n                        </div>\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-muted-foreground\">Fill Level:</span>\n                          <span className={`font-medium ${stockPerc < 20 ? 'text-red-600' :\n                            stockPerc < 50 ? 'text-yellow-600' :\n                              'text-green-600'\n                            }`}>\n                            {stockPerc.toFixed(1)}%\n                          </span>\n                        </div>\n                      </div>\n\n                      {/* Progress Bar */}\n                      <div className=\"w-full bg-muted rounded-full h-2\">\n                        <div\n                          className={`h-2 rounded-full transition-all ${stockPerc < 20 ? 'bg-red-500' :\n                            stockPerc < 50 ? 'bg-yellow-500' :\n                              'bg-green-500'\n                            }`}\n                          style={{ width: `${Math.min(stockPerc, 100)}%` }}\n                        />\n                      </div>\n                    </CardContent>\n                  </Card>\n                )\n              })}\n            </div>\n          </FormCard>\n        </TabsContent>\n\n        {/* Prices Tab */}\n        <TabsContent value=\"prices\" className=\"space-y-6\">\n          {/* Current Prices */}\n          <FormCard\n            title=\"Current Prices\"\n            description=\"Latest effective prices for each fuel type\"\n          >\n            {currentPrices.length > 0 ? (\n              <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                {currentPrices.map(price => (\n                  <Card key={price.id}>\n                    <CardHeader className=\"pb-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-xl\">{price.fuel?.icon || ''}</span>\n                        <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                          {price.fuel?.name || 'Unknown Fuel'}\n                        </CardTitle>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-3xl font-bold\">\n                        Rs. {price.price ? price.price.toFixed(2) : '0.00'}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        per liter\n                      </p>\n                      <div className=\"mt-3 pt-3 border-t\">\n                        <p className=\"text-xs text-muted-foreground\">\n                          Effective: {price.effectiveDate ? new Date(price.effectiveDate).toLocaleDateString() : 'N/A'}\n                        </p>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No current prices available\n              </div>\n            )}\n          </FormCard>\n\n          {/* Price History */}\n          <FormCard\n            title=\"Price History\"\n            description={`All ${validPricesForHistory.length} price records (view only)`}\n          >\n            {validPricesForHistory.length > 0 ? (\n              <DataTable\n                data={validPricesForHistory}\n                columns={columns}\n                loading={loading}\n              />\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                {loading ? 'Loading...' : 'No price history available'}\n              </div>\n            )}\n          </FormCard>\n        </TabsContent>\n\n        {/* Inventory Tab */}\n        <TabsContent value=\"inventory\" className=\"space-y-6\">\n          <FormCard\n            title=\"Tank Inventory by Fuel Type\"\n            description={`Current stock levels across ${tanks.length} tanks`}\n          >\n            {tanks.length > 0 ? (\n              <div className=\"space-y-6\">\n                {fuels.map(fuel => {\n                  const fuelTanks = tanks.filter(t => t && t.fuelId === fuel.id)\n                  const stats = fuelStats.get(fuel.id)\n\n                  // Show all fuel types, even if no tanks\n                  const totalCap = stats?.totalCapacity || 0\n                  const currentStock = stats?.currentStock || 0\n                  const fillPercentage = totalCap > 0 ? (currentStock / totalCap) * 100 : 0\n\n                  return (\n                    <div key={fuel.id} className=\"border rounded-lg p-4 space-y-3\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"text-xl\">{fuel.icon}</span>\n                          <h3 className=\"font-semibold\">{fuel.name}</h3>\n                        </div>\n                        <Badge variant={fuelTanks.length > 0 ? 'default' : 'secondary'}>\n                          {fuelTanks.length} {fuelTanks.length === 1 ? 'tank' : 'tanks'}\n                        </Badge>\n                      </div>\n\n                      {fuelTanks.length > 0 ? (\n                        <>\n                          <div className=\"grid gap-3 md:grid-cols-4 text-sm\">\n                            <div>\n                              <p className=\"text-muted-foreground\">Total Capacity</p>\n                              <p className=\"text-lg font-semibold\">{totalCap.toLocaleString()} L</p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">Current Stock</p>\n                              <p className=\"text-lg font-semibold\">{currentStock.toLocaleString()} L</p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">Available Space</p>\n                              <p className=\"text-lg font-semibold\">\n                                {(totalCap - currentStock).toLocaleString()} L\n                              </p>\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground\">Fill Level</p>\n                              <p className={`text-lg font-semibold ${fillPercentage < 20 ? 'text-red-600' :\n                                fillPercentage < 50 ? 'text-yellow-600' :\n                                  'text-green-600'\n                                }`}>\n                                {fillPercentage.toFixed(1)}%\n                              </p>\n                            </div>\n                          </div>\n\n                          {/* Progress Bar */}\n                          <div className=\"w-full bg-muted rounded-full h-2\">\n                            <div\n                              className={`h-2 rounded-full transition-all ${fillPercentage < 20 ? 'bg-red-500' :\n                                fillPercentage < 50 ? 'bg-yellow-500' :\n                                  'bg-green-500'\n                                }`}\n                              style={{ width: `${Math.min(fillPercentage, 100)}%` }}\n                            />\n                          </div>\n\n                          {/* Individual Tank Details */}\n                          <div className=\"pt-3 border-t\">\n                            <p className=\"text-sm font-medium text-muted-foreground mb-2\">Individual Tanks:</p>\n                            <div className=\"grid gap-2 md:grid-cols-2 lg:grid-cols-3\">\n                              {fuelTanks.map(tank => {\n                                const tankFill = tank.capacity > 0 ? (tank.currentLevel / tank.capacity) * 100 : 0\n                                return (\n                                  <div key={tank.id} className=\"text-sm bg-muted/30 p-2 rounded\">\n                                    <div className=\"flex justify-between items-center mb-1\">\n                                      <span className=\"font-medium\">{tank.tankNumber}</span>\n                                      <span className=\"text-xs text-muted-foreground\">\n                                        {tank.station?.name || 'Unknown'}\n                                      </span>\n                                    </div>\n                                    <div className=\"flex justify-between text-xs\">\n                                      <span>Stock: {tank.currentLevel.toLocaleString()} L</span>\n                                      <span>Cap: {tank.capacity.toLocaleString()} L</span>\n                                    </div>\n                                    <div className=\"w-full bg-background rounded-full h-1 mt-1\">\n                                      <div\n                                        className={`h-1 rounded-full ${tankFill < 20 ? 'bg-red-500' :\n                                          tankFill < 50 ? 'bg-yellow-500' :\n                                            'bg-green-500'\n                                          }`}\n                                        style={{ width: `${Math.min(tankFill, 100)}%` }}\n                                      />\n                                    </div>\n                                  </div>\n                                )\n                              })}\n                            </div>\n                          </div>\n                        </>\n                      ) : (\n                        <p className=\"text-sm text-muted-foreground py-2\">No tanks configured for this fuel type</p>\n                      )}\n                    </div>\n                  )\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                {loading ? 'Loading tank data...' : 'No tanks found'}\n              </div>\n            )}\n          </FormCard>\n        </TabsContent>\n      </Tabs>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\profile\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":11,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":168,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":168,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":234,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":234,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { Badge } from '@/components/ui/badge'\nimport { Loader2, User, Lock, Shield, ArrowLeft } from 'lucide-react'\nimport { useRouter } from 'next/navigation'\n\ninterface UserProfile {\n  id: string\n  username: string\n  email: string\n  role: string\n  station_id?: string\n  is_active: boolean\n}\n\nexport default function ProfilePage() {\n  const router = useRouter()\n  const [profile, setProfile] = useState<UserProfile | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [updating, setUpdating] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Profile update form\n  const [profileForm, setProfileForm] = useState({\n    username: ''\n  })\n\n  // Password change form\n  const [passwordForm, setPasswordForm] = useState({\n    current_password: '',\n    new_password: '',\n    confirm_password: ''\n  })\n\n  useEffect(() => {\n    fetchProfile()\n  }, [])\n\n  const fetchProfile = async () => {\n    try {\n      setLoading(true)\n      setError('')\n\n      // Get user data from localStorage first (fallback)\n      const userId = localStorage.getItem('userId')\n      const username = localStorage.getItem('username')\n      const userRole = localStorage.getItem('userRole')\n      const token = localStorage.getItem('accessToken')\n\n      if (!token) {\n        setError('Not logged in. Redirecting to login...')\n        setTimeout(() => {\n          window.location.href = '/login'\n        }, 1500)\n        setLoading(false)\n        return\n      }\n\n      // Try to fetch from API\n      const response = await fetch('/api/auth/me', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (response.ok) {\n        const data = await response.json()\n        setProfile(data)\n        setProfileForm({\n          username: data.username\n        })\n      } else {\n        // If API fails but we have localStorage data, use that as fallback\n        if (userId && username && userRole) {\n          console.warn('Using localStorage fallback for profile data')\n          const fallbackProfile = {\n            id: userId,\n            username: username,\n            email: '',\n            role: userRole,\n            station_id: localStorage.getItem('stationId') || undefined,\n            is_active: true\n          }\n          setProfile(fallbackProfile)\n          setProfileForm({\n            username: username\n          })\n          setError('Could not verify session with server, using cached profile data')\n        } else {\n          const errorData = await response.json().catch(() => ({}))\n          console.error('Profile fetch error:', response.status, errorData)\n          setError(errorData.detail || errorData.error || `Failed to load profile (${response.status})`)\n        }\n      }\n    } catch (error) {\n      console.error('Profile fetch exception:', error)\n\n      // Use localStorage fallback on network error\n      const userId = localStorage.getItem('userId')\n      const username = localStorage.getItem('username')\n      const userRole = localStorage.getItem('userRole')\n\n      if (userId && username && userRole) {\n        const fallbackProfile = {\n          id: userId,\n          username: username,\n          email: '',\n          role: userRole,\n          station_id: localStorage.getItem('stationId') || undefined,\n          is_active: true\n        }\n        setProfile(fallbackProfile)\n        setProfileForm({\n          username: username\n        })\n        setError('Could not connect to server, using cached profile data')\n      } else {\n        setError('Unable to load profile. Please try logging in again.')\n      }\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleProfileUpdate = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setUpdating(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const token = localStorage.getItem('accessToken')\n\n      if (!token) {\n        setError('No authentication token found. Please log in again.')\n        setUpdating(false)\n        return\n      }\n\n      const response = await fetch('/api/profile', {\n        method: 'PUT',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(profileForm)\n      })\n\n      if (response.ok) {\n        const data = await response.json()\n        setProfile(data)\n        setSuccess('Profile updated successfully')\n        // Update localStorage with new username\n        localStorage.setItem('username', data.username)\n      } else {\n        const errorData = await response.json()\n        setError(errorData.detail || 'Failed to update profile')\n      }\n    } catch (error) {\n      setError('Unable to connect to server')\n    } finally {\n      setUpdating(false)\n    }\n  }\n\n  const handlePasswordChange = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setUpdating(true)\n    setError('')\n    setSuccess('')\n\n    if (passwordForm.new_password !== passwordForm.confirm_password) {\n      setError('New passwords do not match')\n      setUpdating(false)\n      return\n    }\n\n    if (passwordForm.new_password.length < 6) {\n      setError('New password must be at least 6 characters')\n      setUpdating(false)\n      return\n    }\n\n    try {\n      const token = localStorage.getItem('accessToken')\n\n      if (!token) {\n        setError('No authentication token found. Please log in again.')\n        setUpdating(false)\n        return\n      }\n\n      const response = await fetch('/api/profile/change-password', {\n        method: 'PUT',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          current_password: passwordForm.current_password,\n          new_password: passwordForm.new_password\n        })\n      })\n\n      if (response.ok) {\n        setSuccess('Password updated successfully. Please log in again with your new password.')\n        setPasswordForm({\n          current_password: '',\n          new_password: '',\n          confirm_password: ''\n        })\n        // Clear the current session since password changed\n        localStorage.removeItem('accessToken')\n        localStorage.removeItem('userRole')\n        localStorage.removeItem('userId')\n        localStorage.removeItem('username')\n        // Redirect to login after a short delay\n        setTimeout(() => {\n          window.location.href = '/login'\n        }, 2000)\n      } else {\n        const errorData = await response.json()\n        setError(errorData.detail || 'Failed to change password')\n      }\n    } catch (error) {\n      setError('Unable to connect to server')\n    } finally {\n      setUpdating(false)\n    }\n  }\n\n  const getRoleColor = (role: string) => {\n    switch (role) {\n      case 'OWNER': return 'bg-purple-500/20 text-purple-400 dark:bg-purple-600/30 dark:text-purple-300'\n      case 'MANAGER': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'ACCOUNTS': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Profile Settings</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            Manage your account information and security settings\n          </p>\n        </div>\n      </div>\n\n      {/* Profile Information */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <User className=\"h-5 w-5\" />\n            Profile Information\n          </CardTitle>\n          <CardDescription>\n            Your current account details and role information\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {profile && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-sm font-medium text-muted-foreground\">Username</Label>\n                  <p className=\"text-lg font-semibold\">{profile.username}</p>\n                </div>\n                <div>\n                  <Label className=\"text-sm font-medium text-muted-foreground\">Role</Label>\n                  <div className=\"mt-1\">\n                    <Badge className={getRoleColor(profile.role)}>\n                      {profile.role}\n                    </Badge>\n                  </div>\n                </div>\n                <div>\n                  <Label className=\"text-sm font-medium text-muted-foreground\">Status</Label>\n                  <div className=\"mt-1\">\n                    <Badge variant={profile.is_active ? 'default' : 'secondary'}>\n                      {profile.is_active ? 'Active' : 'Inactive'}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Settings Tabs */}\n      <Tabs defaultValue=\"profile\" className=\"space-y-6\">\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"profile\" className=\"flex items-center gap-2\">\n            <User className=\"h-4 w-4\" />\n            Profile Settings\n          </TabsTrigger>\n          <TabsTrigger value=\"password\" className=\"flex items-center gap-2\">\n            <Lock className=\"h-4 w-4\" />\n            Change Password\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Profile Settings Tab */}\n        <TabsContent value=\"profile\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5\" />\n                Update Profile\n              </CardTitle>\n              <CardDescription>\n                Update your username\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {error && (\n                <Alert variant=\"destructive\" className=\"mb-4\">\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n              {success && (\n                <Alert className=\"mb-4 border-green-500/20 dark:border-green-500/30 bg-green-500/10 dark:bg-green-500/20\">\n                  <AlertDescription className=\"text-green-700 dark:text-green-300\">{success}</AlertDescription>\n                </Alert>\n              )}\n\n              <form onSubmit={handleProfileUpdate} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"username\">Username</Label>\n                  <Input\n                    id=\"username\"\n                    type=\"text\"\n                    value={profileForm.username}\n                    onChange={(e) => setProfileForm({ ...profileForm, username: e.target.value })}\n                    placeholder=\"Enter your username\"\n                    disabled={updating}\n                    required\n                  />\n                </div>\n\n\n                <Button type=\"submit\" disabled={updating} className=\"w-full\">\n                  {updating ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Updating...\n                    </>\n                  ) : (\n                    'Update Profile'\n                  )}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Change Password Tab */}\n        <TabsContent value=\"password\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Lock className=\"h-5 w-5\" />\n                Change Password\n              </CardTitle>\n              <CardDescription>\n                Update your password for better security\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {error && (\n                <Alert variant=\"destructive\" className=\"mb-4\">\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n              {success && (\n                <Alert className=\"mb-4 border-green-500/20 dark:border-green-500/30 bg-green-500/10 dark:bg-green-500/20\">\n                  <AlertDescription className=\"text-green-700 dark:text-green-300\">{success}</AlertDescription>\n                </Alert>\n              )}\n\n              <form onSubmit={handlePasswordChange} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"current_password\">Current Password</Label>\n                  <Input\n                    id=\"current_password\"\n                    type=\"password\"\n                    value={passwordForm.current_password}\n                    onChange={(e) => setPasswordForm({ ...passwordForm, current_password: e.target.value })}\n                    placeholder=\"Enter your current password\"\n                    disabled={updating}\n                    required\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"new_password\">New Password</Label>\n                  <Input\n                    id=\"new_password\"\n                    type=\"password\"\n                    value={passwordForm.new_password}\n                    onChange={(e) => setPasswordForm({ ...passwordForm, new_password: e.target.value })}\n                    placeholder=\"Enter your new password\"\n                    disabled={updating}\n                    required\n                    minLength={6}\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"confirm_password\">Confirm New Password</Label>\n                  <Input\n                    id=\"confirm_password\"\n                    type=\"password\"\n                    value={passwordForm.confirm_password}\n                    onChange={(e) => setPasswordForm({ ...passwordForm, confirm_password: e.target.value })}\n                    placeholder=\"Confirm your new password\"\n                    disabled={updating}\n                    required\n                    minLength={6}\n                  />\n                </div>\n\n                <Button type=\"submit\" disabled={updating} className=\"w-full\">\n                  {updating ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Updating...\n                    </>\n                  ) : (\n                    'Change Password'\n                  )}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\pumpers\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":10,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":10,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Award' is defined but never used.","line":12,"column":68,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":73},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":46,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchPumpers' and 'isAllStations'. Either include them or remove the dependency array.","line":76,"column":6,"nodeType":"ArrayExpression","endLine":76,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchPumpers, isAllStations, selectedStation]","fix":{"range":[2488,2505],"text":"[fetchPumpers, isAllStations, selectedStation]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":127,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":127,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Users, Plus, Edit, Trash2, Phone, Star, Building2, Clock, Award, ArrowLeft } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\n\ninterface Pumper {\n  id: string\n  name: string\n  employeeId: string\n  stationId: string\n  stationName?: string\n  status: 'ACTIVE' | 'INACTIVE' | 'ON_LEAVE'\n  shift: 'MORNING' | 'EVENING' | 'NIGHT' | 'ANY'\n  phoneNumber: string\n  hireDate: string\n  experience: number\n  rating: number\n  specializations: string[]\n  createdAt: string\n  updatedAt: string\n  baseSalary?: number\n  holidayAllowance?: number\n}\n\ninterface Station {\n  id: string\n  name: string\n}\n\nexport default function PumpersPage() {\n  const router = useRouter()\n  const { selectedStation, isAllStations } = useStation()\n  const [pumpers, setPumpers] = useState<Pumper[]>([])\n  const [stations, setStations] = useState<Station[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingPumper, setEditingPumper] = useState<Pumper | null>(null)\n  const [deletingPumperId, setDeletingPumperId] = useState<string | null>(null)\n  const [formData, setFormData] = useState({\n    name: '',\n    employeeId: '',\n    stationId: !isAllStations && selectedStation ? selectedStation : '',\n    status: 'ACTIVE' as Pumper['status'],\n    shift: 'MORNING' as Pumper['shift'],\n    phoneNumber: '',\n    hireDate: new Date().toISOString().split('T')[0],\n    experience: 0,\n    rating: 5,\n    specializations: [] as string[],\n    baseSalary: 0,\n    holidayAllowance: 4500\n  })\n  const { toast } = useToast()\n\n  useEffect(() => {\n    fetchPumpers()\n    fetchStations()\n    // Update formData stationId when selectedStation changes\n    if (selectedStation && !isAllStations) {\n      setFormData(prev => ({\n        ...prev,\n        stationId: selectedStation\n      }))\n    }\n  }, [selectedStation])\n\n  const fetchPumpers = async () => {\n    try {\n      const url = isAllStations\n        ? '/api/pumpers'\n        : `/api/pumpers?stationId=${selectedStation}`\n\n      const response = await fetch(url)\n      const data = await response.json()\n\n      // Map station names to pumpers\n      const stationsResponse = await fetch('/api/stations')\n      const stationsData = await stationsResponse.json()\n\n      interface ApiPumper {\n        id: string\n        name: string\n        employeeId: string\n        stationId: string\n        shift: string\n        status: string\n        phone?: string\n        phoneNumber?: string\n        hireDate?: string\n        experience?: number\n        rating?: number\n        specializations?: string[] | string\n        baseSalary?: number\n        holidayAllowance?: number\n        createdAt: string\n        updatedAt: string\n      }\n\n      const pumpersWithStations = data.map((pumper: ApiPumper) => ({\n        ...pumper,\n        stationName: stationsData.find((s: Station) => s.id === pumper.stationId)?.name || 'Unknown Station',\n        // Map phone to phoneNumber for frontend compatibility\n        phoneNumber: pumper.phone || pumper.phoneNumber || '',\n        // Ensure specializations is always an array (handle null, undefined, or string)\n        specializations: Array.isArray(pumper.specializations)\n          ? pumper.specializations\n          : (pumper.specializations ? [pumper.specializations] : []),\n        shift: (pumper.shift as Pumper['shift']) || 'MORNING',\n        status: (pumper.status as Pumper['status']) || 'ACTIVE',\n        hireDate: pumper.hireDate || new Date().toISOString().split('T')[0],\n        experience: pumper.experience || 0,\n        rating: pumper.rating || 0\n      }))\n\n      setPumpers(pumpersWithStations)\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch pumpers\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const fetchStations = async () => {\n    try {\n      const response = await fetch('/api/stations')\n      const data = await response.json()\n      setStations(data)\n    } catch (error) {\n      console.error('Failed to fetch stations:', error)\n    }\n  }\n\n  const [isSubmitting, setIsSubmitting] = useState(false)\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    // Prevent double submission\n    if (isSubmitting) {\n      return\n    }\n\n    setIsSubmitting(true)\n\n    try {\n      const url = editingPumper ? `/api/pumpers/${editingPumper.id}` : '/api/pumpers'\n      const method = editingPumper ? 'PUT' : 'POST'\n\n      // Remove employeeId from formData when creating (always auto-generated)\n      const submitData = editingPumper\n        ? formData // Keep employeeId when editing (display only)\n        : { ...formData, employeeId: undefined } // Remove employeeId when creating\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(submitData)\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        const errorMessage = errorData.details || errorData.error || `Failed to ${editingPumper ? 'update' : 'create'} pumper`\n        throw new Error(errorMessage)\n      }\n\n      const result = await response.json()\n\n      // Verify ID matches when editing\n      if (editingPumper && result.id !== editingPumper.id) {\n        throw new Error('Update failed: Returned pumper ID does not match')\n      }\n\n      toast({\n        title: \"Success\",\n        description: `Pumper ${editingPumper ? 'updated' : 'created'} successfully`\n      })\n\n      // Close dialog and reset\n      setDialogOpen(false)\n      setEditingPumper(null)\n      resetForm()\n\n      // Refresh list\n      fetchPumpers()\n    } catch (error) {\n      console.error(' Error submitting pumper:', error)\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : 'Failed to save pumper',\n        variant: \"destructive\"\n      })\n    } finally {\n      setIsSubmitting(false)\n    }\n  }\n\n  const handleEdit = (pumper: Pumper) => {\n    setEditingPumper(pumper)\n    setFormData({\n      name: pumper.name || '',\n      employeeId: pumper.employeeId || '',\n      stationId: pumper.stationId || '',\n      status: pumper.status || 'ACTIVE',\n      shift: pumper.shift || 'MORNING',\n      // Use phoneNumber if available, otherwise fallback to phone property\n      phoneNumber: pumper.phoneNumber || '',\n      hireDate: pumper.hireDate ? (new Date(pumper.hireDate).toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],\n      experience: typeof pumper.experience === 'number' ? pumper.experience : (pumper.experience ? parseFloat(String(pumper.experience)) : 0),\n      rating: typeof pumper.rating === 'number' ? pumper.rating : (pumper.rating ? parseFloat(String(pumper.rating)) : 5),\n      specializations: Array.isArray(pumper.specializations) ? pumper.specializations : [],\n      baseSalary: pumper.baseSalary || 0,\n      holidayAllowance: pumper.holidayAllowance || 4500\n    })\n    setDialogOpen(true)\n  }\n\n  const handleDelete = async (pumper: Pumper) => {\n    if (!confirm(`Are you sure you want to delete pumper \"${pumper.name}\"?`)) return\n\n    // Prevent double deletion\n    if (deletingPumperId === pumper.id) {\n      console.log('  Already deleting this pumper, ignoring duplicate request')\n      return\n    }\n\n    setDeletingPumperId(pumper.id)\n\n    try {\n      console.log(' Deleting pumper:', { id: pumper.id, name: pumper.name })\n\n      const response = await fetch(`/api/pumpers/${pumper.id}`, {\n        method: 'DELETE'\n      })\n\n      if (!response.ok) {\n        interface ErrorResponse {\n          error?: string\n          details?: string\n          [key: string]: unknown\n        }\n        let errorData: ErrorResponse = {}\n        try {\n          const text = await response.text()\n          console.log(' Raw error response text:', text)\n\n          if (text && text.trim()) {\n            try {\n              errorData = JSON.parse(text)\n              console.log(' Parsed error data:', errorData)\n            } catch (jsonError) {\n              console.error(' Failed to parse JSON:', jsonError)\n              // If not JSON, treat as plain text error\n              errorData = {\n                error: text || `HTTP ${response.status} ${response.statusText}`,\n                details: text || `Server returned status ${response.status}`\n              }\n            }\n          } else {\n            // Empty response body\n            errorData = {\n              error: `HTTP ${response.status} ${response.statusText}`,\n              details: `Server returned status ${response.status} with no error details`\n            }\n            console.warn('  Empty response body from server')\n          }\n        } catch (parseError) {\n          console.error(' Failed to parse error response:', parseError)\n          errorData = {\n            error: `HTTP ${response.status} ${response.statusText}`,\n            details: 'Failed to parse error response from server'\n          }\n        }\n\n        console.error(' Delete error:', {\n          status: response.status,\n          statusText: response.statusText,\n          errorData: errorData,\n          headers: Object.fromEntries(response.headers.entries())\n        })\n\n        const errorMessage = errorData.details || errorData.error || `Failed to delete pumper (${response.status})`\n\n        toast({\n          title: \"Error\",\n          description: errorMessage,\n          variant: \"destructive\"\n        })\n        setDeletingPumperId(null)\n        return\n      }\n\n      const result = await response.json()\n      console.log(' Delete success:', result)\n\n      // Optimistically remove from UI immediately\n      setPumpers(prevPumpers => prevPumpers.filter(p => p.id !== pumper.id))\n\n      toast({\n        title: \"Success\",\n        description: result.message || \"Pumper deleted successfully\"\n      })\n\n      // Refresh the list to ensure we have latest data\n      setTimeout(() => {\n        fetchPumpers()\n        setDeletingPumperId(null)\n      }, 300)\n    } catch (error) {\n      console.error(' Error deleting pumper:', error)\n      const errorMessage = error instanceof Error\n        ? error.message\n        : 'Failed to delete pumper'\n\n      // Restore the pumper in UI if deletion failed\n      fetchPumpers()\n\n      toast({\n        title: \"Error\",\n        description: errorMessage,\n        variant: \"destructive\"\n      })\n      setDeletingPumperId(null)\n    }\n  }\n\n\n  const resetForm = () => {\n    setEditingPumper(null)\n    setFormData({\n      name: '',\n      employeeId: '',\n      stationId: !isAllStations && selectedStation ? selectedStation : '',\n      status: 'ACTIVE',\n      shift: 'MORNING',\n      phoneNumber: '',\n      hireDate: new Date().toISOString().split('T')[0],\n      experience: 0,\n      rating: 5,\n      specializations: [],\n      baseSalary: 0,\n      holidayAllowance: 4500\n    })\n  }\n\n  const getStatusColor = (status: Pumper['status']) => {\n    switch (status) {\n      case 'ACTIVE': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'INACTIVE': return 'bg-muted text-foreground'\n      case 'ON_LEAVE': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getShiftColor = (shift: Pumper['shift']) => {\n    switch (shift) {\n      case 'MORNING': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'EVENING': return 'bg-orange-500/20 text-orange-400 dark:bg-orange-600/30 dark:text-orange-300'\n      case 'NIGHT': return 'bg-purple-500/20 text-purple-400 dark:bg-purple-600/30 dark:text-purple-300'\n      case 'ANY': return 'bg-muted text-foreground'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const renderStars = (rating: number) => {\n    return Array.from({ length: 5 }, (_, i) => (\n      <Star\n        key={i}\n        className={`h-3 w-3 ${i < rating ? 'text-yellow-400 fill-current' : 'text-muted-foreground'}`}\n      />\n    ))\n  }\n\n  const handleSpecializationChange = (specialization: string, checked: boolean) => {\n    if (checked) {\n      setFormData({\n        ...formData,\n        specializations: [...formData.specializations, specialization]\n      })\n    } else {\n      setFormData({\n        ...formData,\n        specializations: formData.specializations.filter(s => s !== specialization)\n      })\n    }\n  }\n\n  const columns = [\n    {\n      key: 'employeeId' as keyof Pumper,\n      title: 'Employee ID',\n      render: (value: unknown) => (\n        <span className=\"font-medium\">{value as string}</span>\n      )\n    },\n    {\n      key: 'name' as keyof Pumper,\n      title: 'Name',\n      render: (value: unknown, row: Pumper) => (\n        <div>\n          <div className=\"font-medium\">{value as string}</div>\n          <div className=\"text-sm text-muted-foreground flex items-center gap-1\">\n            <Phone className=\"h-3 w-3\" />\n            {row.phoneNumber || 'N/A'}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'stationName' as keyof Pumper,\n      title: 'Station',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1 text-sm\">\n          <Building2 className=\"h-3 w-3 text-muted-foreground\" />\n          {value as string}\n        </div>\n      )\n    },\n    {\n      key: 'shift' as keyof Pumper,\n      title: 'Shift',\n      render: (value: unknown) => (\n        <Badge className={getShiftColor(value as Pumper['shift'])}>\n          <Clock className=\"h-3 w-3 mr-1\" />\n          {value as string}\n        </Badge>\n      )\n    },\n    {\n      key: 'experience' as keyof Pumper,\n      title: 'Experience',\n      render: (value: unknown) => (\n        <div className=\"text-sm\">\n          <div className=\"font-medium\">{value as number} years</div>\n        </div>\n      )\n    },\n    {\n      key: 'rating' as keyof Pumper,\n      title: 'Rating',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1\">\n          {renderStars(value as number)}\n          <span className=\"text-sm text-muted-foreground ml-1\">{value as number}</span>\n        </div>\n      )\n    },\n    {\n      key: 'specializations' as keyof Pumper,\n      title: 'Specializations',\n      render: (value: unknown) => {\n        // Ensure value is an array before mapping\n        const specializations = Array.isArray(value) ? value : (value ? [value] : [])\n\n        if (specializations.length === 0) {\n          return <span className=\"text-muted-foreground text-sm\">None</span>\n        }\n\n        return (\n          <div className=\"flex flex-wrap gap-1\">\n            {specializations.map((spec, index) => (\n              <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                {spec}\n              </Badge>\n            ))}\n          </div>\n        )\n      }\n    },\n    {\n      key: 'status' as keyof Pumper,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = value as string\n        if (!status) return <Badge className=\"bg-muted text-foreground\">Unknown</Badge>\n        return (\n          <Badge className={getStatusColor(status as Pumper['status'])}>\n            {status}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'id' as keyof Pumper,\n      title: 'Actions',\n      render: (value: unknown, row: Pumper) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleDelete(row)}\n            disabled={deletingPumperId === row.id}\n            className=\"text-red-600 dark:text-red-400 hover:text-red-700 disabled:opacity-50\"\n          >\n            {deletingPumperId === row.id ? (\n              <span className=\"text-xs\">Deleting...</span>\n            ) : (\n              <Trash2 className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </div>\n      )\n    }\n  ]\n\n  const stats = [\n    {\n      title: 'Total Pumpers',\n      value: pumpers.length.toString(),\n      description: 'Registered pumpers',\n      icon: <Users className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Active',\n      value: pumpers.filter(p => p.status === 'ACTIVE').length.toString(),\n      description: 'Currently active',\n      icon: <div className=\"h-5 w-5 bg-green-500/10 dark:bg-green-500/200 rounded-full\" />\n    },\n    {\n      title: 'On Leave',\n      value: pumpers.filter(p => p.status === 'ON_LEAVE').length.toString(),\n      description: 'Currently on leave',\n      icon: <div className=\"h-5 w-5 bg-yellow-500/10 dark:bg-yellow-500/200 rounded-full\" />\n    },\n    {\n      title: 'Avg Rating',\n      value: pumpers.length > 0\n        ? (pumpers.reduce((acc, p) => acc + p.rating, 0) / pumpers.length).toFixed(1)\n        : '0.0',\n      description: 'Average performance',\n      icon: <Star className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400\" />\n    }\n  ]\n\n  const specializationOptions = ['PETROL', 'DIESEL', 'MAINTENANCE', 'CUSTOMER_SERVICE', 'CASHIER']\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Pumper Management</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Manage pumper employees, their shifts, and specializations\n            </p>\n          </div>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={resetForm}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Pumper\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingPumper ? 'Edit Pumper' : 'Add New Pumper'}\n              </DialogTitle>\n              <DialogDescription>\n                {editingPumper ? 'Update pumper information and details' : 'Add a new pumper to the system'}\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"name\">Full Name</Label>\n                  <Input\n                    id=\"name\"\n                    value={formData.name || ''}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    placeholder=\"e.g., John Silva\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"employeeId\">\n                    Employee ID\n                    <span className=\"text-xs text-muted-foreground ml-2\">(Auto-generated)</span>\n                  </Label>\n                  <Input\n                    id=\"employeeId\"\n                    value={editingPumper ? (formData.employeeId || '') : 'Auto-generated on save'}\n                    disabled\n                    className=\"bg-muted cursor-not-allowed\"\n                    placeholder={editingPumper ? \"Employee ID (read-only)\" : \"Will be auto-generated (e.g., EMP001)\"}\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"stationId\">Station</Label>\n                  <select\n                    id=\"stationId\"\n                    value={formData.stationId}\n                    onChange={(e) => setFormData({ ...formData, stationId: e.target.value })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    <option value=\"\">Select Station</option>\n                    {stations.map((station) => (\n                      <option key={station.id} value={station.id}>\n                        {station.name}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <Label htmlFor=\"phoneNumber\">Phone Number</Label>\n                  <Input\n                    id=\"phoneNumber\"\n                    value={formData.phoneNumber || ''}\n                    onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n                    placeholder=\"+94771234567\"\n                    required\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div>\n                  <Label htmlFor=\"shift\">Preferred Shift</Label>\n                  <select\n                    id=\"shift\"\n                    value={formData.shift}\n                    onChange={(e) => setFormData({ ...formData, shift: e.target.value as Pumper['shift'] })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    <option value=\"MORNING\">Morning</option>\n                    <option value=\"EVENING\">Evening</option>\n                    <option value=\"NIGHT\">Night</option>\n                    <option value=\"ANY\">Any Shift</option>\n                  </select>\n                </div>\n                <div>\n                  <Label htmlFor=\"status\">Status</Label>\n                  <select\n                    id=\"status\"\n                    value={formData.status}\n                    onChange={(e) => setFormData({ ...formData, status: e.target.value as Pumper['status'] })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    <option value=\"ACTIVE\">Active</option>\n                    <option value=\"INACTIVE\">Inactive</option>\n                    <option value=\"ON_LEAVE\">On Leave</option>\n                  </select>\n                </div>\n                <div>\n                  <Label htmlFor=\"hireDate\">Hire Date</Label>\n                  <Input\n                    id=\"hireDate\"\n                    type=\"date\"\n                    value={formData.hireDate || new Date().toISOString().split('T')[0]}\n                    onChange={(e) => setFormData({ ...formData, hireDate: e.target.value })}\n                    required\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"experience\">Experience (Years)</Label>\n                  <Input\n                    id=\"experience\"\n                    type=\"number\"\n                    min=\"0\"\n                    max=\"50\"\n                    value={formData.experience || 0}\n                    onChange={(e) => setFormData({ ...formData, experience: parseInt(e.target.value) || 0 })}\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"rating\">Performance Rating (1-5)</Label>\n                  <Input\n                    id=\"rating\"\n                    type=\"number\"\n                    min=\"1\"\n                    max=\"5\"\n                    step=\"0.1\"\n                    value={formData.rating || 5}\n                    onChange={(e) => setFormData({ ...formData, rating: parseFloat(e.target.value) || 5 })}\n                    required\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"baseSalary\">Base Monthly Salary (LKR)</Label>\n                  <Input\n                    id=\"baseSalary\"\n                    type=\"number\"\n                    min=\"0\"\n                    step=\"0.01\"\n                    value={formData.baseSalary || 0}\n                    onChange={(e) => setFormData({ ...formData, baseSalary: parseFloat(e.target.value) || 0 })}\n                    placeholder=\"27000\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Base monthly salary (default: 27000)\n                  </p>\n                </div>\n                <div>\n                  <Label htmlFor=\"holidayAllowance\">Holiday Allowance (LKR)</Label>\n                  <Input\n                    id=\"holidayAllowance\"\n                    type=\"number\"\n                    min=\"0\"\n                    step=\"0.01\"\n                    value={formData.holidayAllowance || 4500}\n                    onChange={(e) => setFormData({ ...formData, holidayAllowance: parseFloat(e.target.value) || 4500 })}\n                    placeholder=\"4500\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Monthly holiday allowance (default: 4500). Deduct 900rs per rest day taken (up to 5 rest days)\n                  </p>\n                </div>\n              </div>\n\n              <div>\n                <Label>Specializations</Label>\n                <div className=\"grid grid-cols-2 gap-2 mt-2\">\n                  {specializationOptions.map((spec) => (\n                    <div key={spec} className=\"flex items-center space-x-2\">\n                      <input\n                        type=\"checkbox\"\n                        id={spec}\n                        checked={formData.specializations.includes(spec)}\n                        onChange={(e) => handleSpecializationChange(spec, e.target.checked)}\n                        className=\"rounded border-border\"\n                      />\n                      <Label htmlFor={spec} className=\"text-sm font-normal\">\n                        {spec.replace('_', ' ')}\n                      </Label>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-3 pt-4\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)} disabled={isSubmitting}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={isSubmitting}>\n                  {isSubmitting ? 'Saving...' : (editingPumper ? 'Update Pumper' : 'Create Pumper')}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {stats.map((stat, index) => (\n          <Card key={index}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-2xl font-bold text-foreground\">{stat.value}</div>\n                  <div className=\"text-sm font-medium text-foreground\">{stat.title}</div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.description}</div>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {stat.icon}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Pumpers Table */}\n      <FormCard title=\"Pumpers\" description=\"Manage pumper employees and their assignments\">\n        <DataTable\n          data={pumpers}\n          columns={columns}\n          searchPlaceholder=\"Search pumpers...\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\shift-templates\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":10,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":10,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":35,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTemplates'. Either include it or remove the dependency array.","line":53,"column":6,"nodeType":"ArrayExpression","endLine":53,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTemplates, selectedStation]","fix":{"range":[1789,1806],"text":"[fetchTemplates, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Clock, Plus, Edit, Trash2, Coffee, Moon, Sun, ArrowLeft } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\n\ninterface ShiftTemplate {\n  id: string\n  stationId: string\n  name: string\n  startTime: string\n  endTime: string\n  breakDuration: number // minutes\n  breakStartTime: string\n  description: string\n  icon?: string // \"sun\", \"coffee\", or \"moon\"\n  status: 'active' | 'inactive'\n  createdAt: string\n  updatedAt: string\n}\n\nexport default function ShiftTemplatesPage() {\n  const router = useRouter()\n  const [templates, setTemplates] = useState<ShiftTemplate[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingTemplate, setEditingTemplate] = useState<ShiftTemplate | null>(null)\n  const [formData, setFormData] = useState({\n    name: '',\n    startTime: '06:00',\n    endTime: '14:00',\n    breakDuration: 30,\n    breakStartTime: '',\n    description: '',\n    icon: 'sun',\n    status: 'active' as ShiftTemplate['status']\n  })\n  const { toast } = useToast()\n  const { selectedStation, isAllStations } = useStation()\n\n  useEffect(() => {\n    fetchTemplates()\n  }, [selectedStation])\n\n  const fetchTemplates = async () => {\n    try {\n      console.log('Fetching templates for station:', selectedStation)\n\n      // Build URL with stationId filter\n      const url = isAllStations\n        ? '/api/shift-templates?t=' + Date.now()\n        : `/api/shift-templates?stationId=${selectedStation}&t=${Date.now()}`\n\n      const response = await fetch(url)\n      const data = await response.json()\n      console.log('Fetched templates:', data)\n      console.log('Is array?', Array.isArray(data))\n\n      // Handle error response or non-array data\n      if (!Array.isArray(data)) {\n        console.error('API returned non-array:', data)\n        setTemplates([])\n        return\n      }\n\n      interface ApiShiftTemplate extends Omit<ShiftTemplate, 'status'> {\n        isActive: boolean\n      }\n\n      // Map isActive to status for the UI\n      const mappedData = data.map((template: ApiShiftTemplate) => ({\n        ...template,\n        status: (template.isActive ? 'active' : 'inactive') as 'active' | 'inactive'\n      }))\n      console.log('Mapped templates:', mappedData)\n      setTemplates(mappedData)\n    } catch (error) {\n      console.error('Error fetching templates:', error)\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch shift templates\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    // Only validate station selection for new templates\n    // For editing, use the template's existing stationId\n    if (!editingTemplate && (isAllStations || !selectedStation)) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a specific station to create a shift template\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    try {\n      const url = editingTemplate ? `/api/shift-templates/${editingTemplate.id}` : '/api/shift-templates'\n      const method = editingTemplate ? 'PUT' : 'POST'\n\n      // Include stationId in the request body\n      // For editing, preserve the original stationId from the template\n      const requestBody = {\n        ...formData,\n        stationId: editingTemplate ? editingTemplate.stationId : selectedStation\n      }\n\n      console.log('Submitting shift template:', { url, method, requestBody })\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(requestBody)\n      })\n\n      const responseData = await response.json()\n      console.log('Response:', response.status, responseData)\n\n      if (!response.ok) {\n        throw new Error(responseData.error || 'Failed to save shift template')\n      }\n\n      toast({\n        title: \"Success\",\n        description: `Shift template ${editingTemplate ? 'updated' : 'created'} successfully`\n      })\n\n      setDialogOpen(false)\n      resetForm()\n      fetchTemplates()\n    } catch (error) {\n      console.error('Error saving shift template:', error)\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : `Failed to ${editingTemplate ? 'update' : 'create'} shift template`,\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleEdit = (template: ShiftTemplate) => {\n    setEditingTemplate(template)\n    setFormData({\n      name: template.name || '',\n      startTime: template.startTime || '',\n      endTime: template.endTime || '',\n      breakDuration: template.breakDuration || 0,\n      breakStartTime: template.breakStartTime || '',\n      description: template.description || '',\n      icon: template.icon || 'sun',\n      status: template.status\n    })\n    setDialogOpen(true)\n  }\n\n  const handleDelete = async (template: ShiftTemplate) => {\n    if (!confirm(`Are you sure you want to delete shift template \"${template.name}\"?`)) return\n\n    try {\n      console.log('Deleting shift template:', template.id)\n\n      const response = await fetch(`/api/shift-templates/${template.id}`, {\n        method: 'DELETE'\n      })\n\n      const responseData = await response.json()\n      console.log('Delete response:', response.status, responseData)\n\n      if (!response.ok) {\n        throw new Error(responseData.error || 'Failed to delete shift template')\n      }\n\n      toast({\n        title: \"Success\",\n        description: \"Shift template deleted successfully\"\n      })\n\n      fetchTemplates()\n    } catch (error) {\n      console.error('Error deleting shift template:', error)\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Failed to delete shift template\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const resetForm = () => {\n    setEditingTemplate(null)\n    setFormData({\n      name: '',\n      startTime: '06:00',\n      endTime: '14:00',\n      breakDuration: 30,\n      breakStartTime: '',\n      description: '',\n      icon: 'sun',\n      status: 'active'\n    })\n  }\n\n  const getStatusColor = (status: ShiftTemplate['status']) => {\n    switch (status) {\n      case 'active': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'inactive': return 'bg-muted text-foreground'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getShiftIcon = (icon?: string, startTime?: string) => {\n    // Use provided icon, or fall back to time-based logic\n    const iconType = icon || (() => {\n      if (!startTime) return 'sun'\n      const hour = parseInt(startTime.split(':')[0])\n      if (hour >= 6 && hour < 14) return 'sun'\n      if (hour >= 14 && hour < 22) return 'coffee'\n      return 'moon'\n    })()\n\n    switch (iconType) {\n      case 'sun':\n        return <Sun className=\"h-4 w-4 text-yellow-600 dark:text-yellow-400\" />\n      case 'coffee':\n        return <Coffee className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n      case 'moon':\n        return <Moon className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n      default:\n        return <Sun className=\"h-4 w-4 text-yellow-600 dark:text-yellow-400\" />\n    }\n  }\n\n  const calculateDuration = (start: string, end: string) => {\n    const [startHour, startMin] = start.split(':').map(Number)\n    const [endHour, endMin] = end.split(':').map(Number)\n\n    const startMinutes = startHour * 60 + startMin\n    let endMinutes = endHour * 60 + endMin\n\n    // Handle overnight shifts\n    if (endMinutes < startMinutes) {\n      endMinutes += 24 * 60\n    }\n\n    const duration = endMinutes - startMinutes\n    const hours = Math.floor(duration / 60)\n    const minutes = duration % 60\n\n    return `${hours}h ${minutes > 0 ? `${minutes}m` : ''}`\n  }\n\n  const columns = [\n    {\n      key: 'name' as keyof ShiftTemplate,\n      title: 'Template Name',\n      render: (value: unknown, row: ShiftTemplate) => (\n        <div className=\"flex items-center gap-2\">\n          {getShiftIcon(row.icon, row.startTime)}\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'startTime' as keyof ShiftTemplate,\n      title: 'Shift Hours',\n      render: (value: unknown, row: ShiftTemplate) => (\n        <div className=\"text-sm\">\n          <div className=\"\">{value as string} - {row.endTime}</div>\n          <div className=\"text-muted-foreground\">\n            {calculateDuration(value as string, row.endTime)}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'breakDuration' as keyof ShiftTemplate,\n      title: 'Break',\n      render: (value: unknown, row: ShiftTemplate) => (\n        <div className=\"text-sm\">\n          <div className=\"flex items-center gap-1\">\n            <Coffee className=\"h-3 w-3 text-muted-foreground\" />\n            {value as number} minutes\n          </div>\n          <div className=\"text-muted-foreground text-xs\">\n            {row.breakStartTime ? `@ ${row.breakStartTime}` : ''}\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'description' as keyof ShiftTemplate,\n      title: 'Description',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">\n          {(value as string) || 'No description'}\n        </span>\n      )\n    },\n    {\n      key: 'status' as keyof ShiftTemplate,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = value as string\n        if (!status) return <Badge className=\"bg-muted text-foreground\">Unknown</Badge>\n        return (\n          <Badge className={getStatusColor(status as ShiftTemplate['status'])}>\n            {status.charAt(0).toUpperCase() + status.slice(1)}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'id' as keyof ShiftTemplate,\n      title: 'Actions',\n      render: (value: unknown, row: ShiftTemplate) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleDelete(row)}\n            className=\"text-red-600 dark:text-red-400 hover:text-red-700\"\n          >\n            <Trash2 className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      )\n    }\n  ]\n\n  const stats = [\n    {\n      title: 'Total Templates',\n      value: templates.length.toString(),\n      description: 'Shift templates',\n      icon: <Clock className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Active',\n      value: templates.filter(t => t.status === 'active').length.toString(),\n      description: 'Currently active',\n      icon: <div className=\"h-5 w-5 bg-green-500/10 dark:bg-green-500/200 rounded-full\" />\n    },\n    {\n      title: 'Avg Duration',\n      value: templates.length > 0\n        ? `${Math.round(templates.reduce((acc, t) => {\n          const [startHour, startMin] = t.startTime.split(':').map(Number)\n          const [endHour, endMin] = t.endTime.split(':').map(Number)\n          let duration = (endHour * 60 + endMin) - (startHour * 60 + startMin)\n          if (duration < 0) duration += 24 * 60\n          return acc + duration\n        }, 0) / templates.length / 60)}h`\n        : '0h',\n      description: 'Average shift length',\n      icon: <Coffee className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Shift Templates</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Manage shift patterns and working hour templates\n            </p>\n          </div>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={resetForm}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Template\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingTemplate ? 'Edit Shift Template' : 'Add New Shift Template'}\n              </DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"name\">Template Name</Label>\n                <Input\n                  id=\"name\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  placeholder=\"e.g., Morning Shift, Night Shift\"\n                  required\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"startTime\">Start Time</Label>\n                  <Input\n                    id=\"startTime\"\n                    type=\"time\"\n                    value={formData.startTime}\n                    onChange={(e) => setFormData({ ...formData, startTime: e.target.value })}\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"endTime\">End Time</Label>\n                  <Input\n                    id=\"endTime\"\n                    type=\"time\"\n                    value={formData.endTime}\n                    onChange={(e) => setFormData({ ...formData, endTime: e.target.value })}\n                    required\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"breakDuration\">Break Duration (minutes)</Label>\n                  <Input\n                    id=\"breakDuration\"\n                    type=\"number\"\n                    min=\"0\"\n                    max=\"120\"\n                    value={formData.breakDuration}\n                    onChange={(e) => setFormData({ ...formData, breakDuration: parseInt(e.target.value) || 0 })}\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"breakStartTime\">Break Start Time (Optional)</Label>\n                  <Input\n                    id=\"breakStartTime\"\n                    type=\"time\"\n                    value={formData.breakStartTime}\n                    onChange={(e) => setFormData({ ...formData, breakStartTime: e.target.value })}\n                  />\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"description\">Description</Label>\n                <Input\n                  id=\"description\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  placeholder=\"Optional description\"\n                />\n              </div>\n\n              <div>\n                <Label>Shift Icon</Label>\n                <div className=\"grid grid-cols-3 gap-3 mt-2\">\n                  <button\n                    type=\"button\"\n                    onClick={() => setFormData({ ...formData, icon: 'sun' })}\n                    className={`flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all ${formData.icon === 'sun'\n                      ? 'border-yellow-600 bg-yellow-600/10 dark:border-yellow-400 dark:bg-yellow-400/10'\n                      : 'border-border hover:border-yellow-600/50 dark:hover:border-yellow-400/50'\n                      }`}\n                  >\n                    <Sun className=\"h-6 w-6 text-yellow-600 dark:text-yellow-400\" />\n                    <span className=\"text-xs font-medium\">Morning</span>\n                  </button>\n\n                  <button\n                    type=\"button\"\n                    onClick={() => setFormData({ ...formData, icon: 'coffee' })}\n                    className={`flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all ${formData.icon === 'coffee'\n                      ? 'border-orange-600 bg-orange-600/10 dark:border-orange-400 dark:bg-orange-400/10'\n                      : 'border-border hover:border-orange-600/50 dark:hover:border-orange-400/50'\n                      }`}\n                  >\n                    <Coffee className=\"h-6 w-6 text-orange-600 dark:text-orange-400\" />\n                    <span className=\"text-xs font-medium\">Evening</span>\n                  </button>\n\n                  <button\n                    type=\"button\"\n                    onClick={() => setFormData({ ...formData, icon: 'moon' })}\n                    className={`flex flex-col items-center gap-2 p-4 rounded-lg border-2 transition-all ${formData.icon === 'moon'\n                      ? 'border-blue-600 bg-blue-600/10 dark:border-blue-400 dark:bg-blue-400/10'\n                      : 'border-border hover:border-blue-600/50 dark:hover:border-blue-400/50'\n                      }`}\n                  >\n                    <Moon className=\"h-6 w-6 text-blue-600 dark:text-blue-400\" />\n                    <span className=\"text-xs font-medium\">Night</span>\n                  </button>\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"status\">Status</Label>\n                <select\n                  id=\"status\"\n                  value={formData.status}\n                  onChange={(e) => setFormData({ ...formData, status: e.target.value as ShiftTemplate['status'] })}\n                  className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                  required\n                >\n                  <option value=\"active\">Active</option>\n                  <option value=\"inactive\">Inactive</option>\n                </select>\n              </div>\n\n              <div className=\"flex justify-end gap-3 pt-4\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">\n                  {editingTemplate ? 'Update Template' : 'Create Template'}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {stats.map((stat, index) => (\n          <Card key={index}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-2xl font-bold text-foreground\">{stat.value}</div>\n                  <div className=\"text-sm font-medium text-foreground\">{stat.title}</div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.description}</div>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {stat.icon}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Templates Table */}\n      <FormCard title=\"Shift Templates\" description=\"Manage shift patterns and working hour configurations\">\n        <DataTable\n          data={templates}\n          columns={columns}\n          searchPlaceholder=\"Search templates...\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\stations\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTrigger' is defined but never used.","line":9,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":73},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":11,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":11,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":34,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchStations'. Either include it or remove the dependency array.","line":54,"column":6,"nodeType":"ArrayExpression","endLine":54,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchStations]","fix":{"range":[1815,1817],"text":"[fetchStations]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":61,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":61,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":95,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":134,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":134,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Building2, Plus, Edit, Trash2, MapPin, Phone, Clock } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { ArrowLeft } from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  address: string\n  city: string\n  phone?: string\n  email?: string\n  openingHours?: string\n  isActive: boolean\n  createdAt: string\n  updatedAt: string\n}\n\nexport default function StationsPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingStation, setEditingStation] = useState<Station | null>(null)\n  const [formData, setFormData] = useState({\n    name: '',\n    address: '',\n    city: '',\n    phone: '',\n    email: '',\n    openingHours: '',\n    isActive: true\n  })\n  const { toast } = useToast()\n\n  // Check if user is DEVELOPER (only role that can add/delete stations)\n  const userRole = typeof window !== 'undefined' ? localStorage.getItem('userRole') : null\n  const isDeveloper = userRole === 'DEVELOPER'\n\n  useEffect(() => {\n    fetchStations()\n  }, [])\n\n  const fetchStations = async () => {\n    try {\n      const response = await fetch('/api/stations')\n      const data = await response.json()\n      setStations(data)\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch stations\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    try {\n      const url = editingStation ? `/api/stations/${editingStation.id}` : '/api/stations'\n      const method = editingStation ? 'PUT' : 'POST'\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(formData)\n      })\n\n      if (!response.ok) throw new Error('Failed to save station')\n\n      toast({\n        title: \"Success\",\n        description: `Station ${editingStation ? 'updated' : 'created'} successfully`\n      })\n\n      setDialogOpen(false)\n      resetForm()\n      fetchStations()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: `Failed to ${editingStation ? 'update' : 'create'} station`,\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleEdit = (station: Station) => {\n    setEditingStation(station)\n    setFormData({\n      name: station.name,\n      address: station.address,\n      city: station.city,\n      phone: station.phone || '',\n      email: station.email || '',\n      openingHours: station.openingHours || '',\n      isActive: station.isActive\n    })\n    setDialogOpen(true)\n  }\n\n  const handleDelete = async (station: Station) => {\n    if (!confirm(`Are you sure you want to delete station \"${station.name}\"?`)) return\n\n    try {\n      const response = await fetch(`/api/stations/${station.id}`, {\n        method: 'DELETE'\n      })\n\n      if (!response.ok) throw new Error('Failed to delete station')\n\n      toast({\n        title: \"Success\",\n        description: \"Station deleted successfully\"\n      })\n\n      fetchStations()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete station\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const resetForm = () => {\n    setEditingStation(null)\n    setFormData({\n      name: '',\n      address: '',\n      city: '',\n      phone: '',\n      email: '',\n      openingHours: '',\n      isActive: true\n    })\n  }\n\n  const getStatusColor = (isActive: boolean) => {\n    return isActive ? 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300' : 'bg-muted text-foreground'\n  }\n\n  const columns = [\n    {\n      key: 'name' as keyof Station,\n      title: 'Station Name',\n      render: (value: unknown) => (\n        <div className=\"font-medium\">{value as string}</div>\n      )\n    },\n    {\n      key: 'address' as keyof Station,\n      title: 'Address',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n          <MapPin className=\"h-3 w-3\" />\n          {value as string}\n        </div>\n      )\n    },\n    {\n      key: 'city' as keyof Station,\n      title: 'City',\n      render: (value: unknown) => (\n        <span className=\"text-sm\">{value as string}</span>\n      )\n    },\n    {\n      key: 'phone' as keyof Station,\n      title: 'Phone',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Phone className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value ? (value as string) : '-'}</span>\n        </div>\n      )\n    },\n    {\n      key: 'openingHours' as keyof Station,\n      title: 'Opening Hours',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value ? (value as string) : '-'}</span>\n        </div>\n      )\n    },\n    {\n      key: 'isActive' as keyof Station,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as boolean)}>\n          {(value as boolean) ? 'Active' : 'Inactive'}\n        </Badge>\n      )\n    },\n    {\n      key: 'id' as keyof Station,\n      title: 'Actions',\n      render: (value: unknown, row: Station) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          {/* Only DEVELOPER can delete stations */}\n          {isDeveloper && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => handleDelete(row)}\n              className=\"text-red-600 dark:text-red-400 hover:text-red-700\"\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n          )}\n        </div>\n      )\n    }\n  ]\n\n  const stationsList = Array.isArray(stations) ? stations : []\n\n  const stats = [\n    {\n      title: 'Total Stations',\n      value: stationsList.length.toString(),\n      description: 'Registered stations',\n      icon: <Building2 className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Active',\n      value: stationsList.filter(s => s.isActive).length.toString(),\n      description: 'Currently operational',\n      icon: <div className=\"h-5 w-5 bg-green-500/10 dark:bg-green-500/200 rounded-full\" />\n    },\n    {\n      title: 'Inactive',\n      value: stationsList.filter(s => !s.isActive).length.toString(),\n      description: 'Not operational',\n      icon: <div className=\"h-5 w-5 bg-red-500/10 dark:bg-red-500/200 rounded-full\" />\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Station Management</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Manage petrol stations, locations, and operational details\n            </p>\n          </div>\n        </div>\n\n        {/* Only DEVELOPER can see Add Station button */}\n        {isDeveloper && (\n          <Button onClick={() => { resetForm(); setDialogOpen(true); }}>\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Add Station\n          </Button>\n        )}\n      </div>\n\n      {/* Dialog for both Add and Edit - visible to all roles */}\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingStation ? 'Edit Station' : 'Add New Station'}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"name\">Station Name</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"e.g., Main Street Station\"\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"address\">Address</Label>\n              <Input\n                id=\"address\"\n                value={formData.address}\n                onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n                placeholder=\"Full address\"\n                required\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"city\">City</Label>\n              <Input\n                id=\"city\"\n                value={formData.city}\n                onChange={(e) => setFormData({ ...formData, city: e.target.value })}\n                placeholder=\"City name\"\n                required\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"phone\">Phone Number</Label>\n                <Input\n                  id=\"phone\"\n                  value={formData.phone}\n                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                  placeholder=\"e.g., +1 234 567 8900\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"email\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  value={formData.email}\n                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                  placeholder=\"station@example.com\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <Label htmlFor=\"openingHours\">Opening Hours</Label>\n              <Input\n                id=\"openingHours\"\n                value={formData.openingHours}\n                onChange={(e) => setFormData({ ...formData, openingHours: e.target.value })}\n                placeholder=\"e.g., Mon-Fri: 6AM-10PM, Sat-Sun: 7AM-9PM\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"isActive\">Status</Label>\n              <Select\n                value={formData.isActive ? 'active' : 'inactive'}\n                onValueChange={(value) => setFormData({ ...formData, isActive: value === 'active' })}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"active\">Active</SelectItem>\n                  <SelectItem value=\"inactive\">Inactive</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex justify-end gap-3 pt-4\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button type=\"submit\">\n                {editingStation ? 'Update Station' : 'Create Station'}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {stats.map((stat, index) => (\n          <Card key={index}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-2xl font-bold text-foreground\">{stat.value}</div>\n                  <div className=\"text-sm font-medium text-foreground\">{stat.title}</div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.description}</div>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {stat.icon}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Stations Table */}\n      <FormCard title=\"Stations\" description=\"Manage all petrol station locations and details\">\n        <DataTable\n          data={stations}\n          columns={columns}\n          searchPlaceholder=\"Search stations...\"\n        />\n      </FormCard>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\tanks\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadNozzles', 'loadPumps', and 'loadTanks'. Either include them or remove the dependency array.","line":126,"column":6,"nodeType":"ArrayExpression","endLine":126,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [loadNozzles, loadPumps, loadTanks, selectedStation]","fix":{"range":[3455,3472],"text":"[loadNozzles, loadPumps, loadTanks, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { useStation } from '@/contexts/StationContext'\r\nimport { FormCard } from '@/components/ui/FormCard'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { useToast } from '@/hooks/use-toast'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport { DataTable, Column } from '@/components/ui/DataTable'\r\nimport {\r\n  Fuel,\r\n  Plus,\r\n  AlertCircle,\r\n  Droplets,\r\n  Wrench,\r\n  ArrowLeft,\r\n  Settings,\r\n  Trash2,\r\n  Edit\r\n} from 'lucide-react'\r\n\r\ninterface Pump {\r\n  id: string\r\n  pumpNumber: string\r\n  station: { name: string }\r\n  nozzles: { id: string; nozzleNumber: string; tank: { fuelId: string; fuel?: Fuel } }[]\r\n}\r\n\r\ninterface Nozzle {\r\n  id: string\r\n  nozzleNumber: string\r\n  pump: { pumpNumber: string }\r\n  tank: { fuelId: string; fuel?: Fuel }\r\n  isActive: boolean\r\n}\r\n\r\ninterface Fuel {\r\n  id: string\r\n  code: string\r\n  name: string\r\n  icon?: string | null\r\n  isActive?: boolean\r\n}\r\n\r\ninterface Tank {\r\n  id: string\r\n  fuelId: string\r\n  fuel?: Fuel\r\n  capacity: number\r\n  currentLevel: number\r\n  tankNumber: string\r\n}\r\n\r\nexport default function TanksSettingsPage() {\r\n  const router = useRouter()\r\n  const { stations, selectedStation: globalSelectedStation } = useStation()\r\n  const { toast } = useToast()\r\n\r\n  // Common state\r\n  const [selectedStation, setSelectedStation] = useState('')\r\n\r\n  // Sync with global station selection\r\n  useEffect(() => {\r\n    if (globalSelectedStation) {\r\n      setSelectedStation(globalSelectedStation)\r\n    }\r\n  }, [globalSelectedStation])\r\n\r\n  // Tank creation/editing dialog state\r\n  const [showTankDialog, setShowTankDialog] = useState(false)\r\n  const [tankLoading, setTankLoading] = useState(false)\r\n  const [editingTankId, setEditingTankId] = useState<string | null>(null)\r\n\r\n  // Tank form state\r\n  const [selectedStationForTank, setSelectedStationForTank] = useState('')\r\n  const [fuelId, setFuelId] = useState('')\r\n  const [fuels, setFuels] = useState<Fuel[]>([])\r\n  const [capacity, setCapacity] = useState('')\r\n  const [tankNumber, setTankNumber] = useState('')\r\n\r\n  // Pump state\r\n  const [pumps, setPumps] = useState<Pump[]>([])\r\n  const [pumpNumber, setPumpNumber] = useState('')\r\n  const [pumpLoading, setPumpLoading] = useState(false)\r\n\r\n  // Nozzle state\r\n  const [nozzles, setNozzles] = useState<Nozzle[]>([])\r\n  const [tanks, setTanks] = useState<Tank[]>([])\r\n  const [selectedPump, setSelectedPump] = useState('')\r\n  const [selectedTank, setSelectedTank] = useState('')\r\n  const [nozzleNumber, setNozzleNumber] = useState('')\r\n  const [nozzleLoading, setNozzleLoading] = useState(false)\r\n\r\n  // Load pumps, nozzles, and fuels when station changes\r\n  useEffect(() => {\r\n    loadFuels()\r\n    if (selectedStation) {\r\n      loadPumps()\r\n      loadNozzles()\r\n      loadTanks()\r\n    } else {\r\n      setPumps([])\r\n      setNozzles([])\r\n      setTanks([])\r\n    }\r\n  }, [selectedStation])\r\n\r\n  const loadFuels = async () => {\r\n    try {\r\n      const response = await fetch('/api/fuels')\r\n      const data = await response.json()\r\n      setFuels(data.filter((f: Fuel) => f.isActive))\r\n    } catch (err) {\r\n      console.error('Failed to load fuels:', err)\r\n    }\r\n  }\r\n\r\n  const loadPumps = async () => {\r\n    try {\r\n      const response = await fetch(`/api/pumps?stationId=${selectedStation}`)\r\n      const data = await response.json()\r\n      setPumps(data)\r\n    } catch (err) {\r\n      console.error('Failed to load pumps:', err)\r\n    }\r\n  }\r\n\r\n  const loadNozzles = async () => {\r\n    try {\r\n      const response = await fetch(`/api/nozzles?stationId=${selectedStation}`)\r\n      const data = await response.json()\r\n      setNozzles(data)\r\n    } catch (err) {\r\n      console.error('Failed to load nozzles:', err)\r\n    }\r\n  }\r\n\r\n  const loadTanks = async () => {\r\n    try {\r\n      const response = await fetch(`/api/tanks?stationId=${selectedStation}&type=tanks`)\r\n      const data = await response.json()\r\n      setTanks(data)\r\n    } catch (err) {\r\n      console.error('Failed to load tanks:', err)\r\n    }\r\n  }\r\n\r\n  const resetTankForm = () => {\r\n    setEditingTankId(null)\r\n    setSelectedStationForTank(selectedStation || '')\r\n    setFuelId('')\r\n    setCapacity('')\r\n    setTankNumber('')\r\n  }\r\n\r\n  const handleEditTank = (tank: Tank) => {\r\n    setEditingTankId(tank.id)\r\n    setSelectedStationForTank(selectedStation) // Assuming tanks belong to current selected station\r\n    setFuelId(tank.fuelId)\r\n    setCapacity(tank.capacity.toString())\r\n    setTankNumber(tank.tankNumber.replace('TANK-', '')) // effective editing\r\n    setShowTankDialog(true)\r\n  }\r\n\r\n  const handleSaveTank = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n\r\n    if (!selectedStationForTank || !fuelId || !capacity) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Please fill in all required fields\",\r\n        variant: \"destructive\"\r\n      })\r\n      return\r\n    }\r\n\r\n    setTankLoading(true)\r\n\r\n    try {\r\n      const url = editingTankId ? `/api/tanks/${editingTankId}` : '/api/tanks'\r\n      const method = editingTankId ? 'PUT' : 'POST'\r\n\r\n      // Auto-format tank number if provided\r\n      let formattedTankNumber = undefined\r\n      if (tankNumber && tankNumber.trim()) {\r\n        const rawNumber = tankNumber.trim()\r\n        if (/^\\d+$/.test(rawNumber)) {\r\n          formattedTankNumber = `TANK-${rawNumber.padStart(2, '0')}`\r\n        } else {\r\n          formattedTankNumber = rawNumber\r\n        }\r\n      }\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          stationId: selectedStationForTank,\r\n          fuelId,\r\n          capacity: parseFloat(capacity),\r\n          tankNumber: formattedTankNumber,\r\n          ...(editingTankId ? {} : { currentLevel: 0 }) // Only set initial level for new tanks\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json()\r\n        throw new Error(errorData.error || `Failed to ${editingTankId ? 'update' : 'create'} tank`)\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: `Tank ${editingTankId ? 'updated' : 'created'} successfully!`\r\n      })\r\n      setShowTankDialog(false)\r\n      resetTankForm()\r\n\r\n      // Refresh tanks if viewing a station\r\n      if (selectedStation) {\r\n        loadTanks()\r\n      }\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: err instanceof Error ? err.message : `Failed to ${editingTankId ? 'update' : 'create'} tank`,\r\n        variant: \"destructive\"\r\n      })\r\n    } finally {\r\n      setTankLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleDeleteTank = async (tankId: string) => {\r\n    if (!confirm('Are you sure you want to delete this tank? This action cannot be undone.')) return\r\n\r\n    try {\r\n      const response = await fetch(`/api/tanks/${tankId}`, {\r\n        method: 'DELETE'\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json()\r\n        throw new Error(data.details || data.error || 'Failed to delete tank')\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Tank deleted successfully\"\r\n      })\r\n      loadTanks()\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: err instanceof Error ? err.message : \"Failed to delete tank\",\r\n        variant: \"destructive\"\r\n      })\r\n    }\r\n  }\r\n\r\n  const handleCreatePump = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n\r\n    if (!selectedStation || !pumpNumber) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Please fill in all required fields\",\r\n        variant: \"destructive\"\r\n      })\r\n      return\r\n    }\r\n\r\n    setPumpLoading(true)\r\n\r\n    try {\r\n      // Auto-format pump number\r\n      let formattedPumpNumber = pumpNumber.trim()\r\n\r\n      // If it's just a number (e.g. \"1\" or \"01\"), format it as \"PUMP-01\"\r\n      if (/^\\d+$/.test(formattedPumpNumber)) {\r\n        formattedPumpNumber = `PUMP-${formattedPumpNumber.padStart(2, '0')}`\r\n      }\r\n\r\n      const response = await fetch('/api/pumps', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          stationId: selectedStation,\r\n          pumpNumber: formattedPumpNumber,\r\n          isActive: true\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json()\r\n        throw new Error(errorData.error || 'Failed to create pump')\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Pump created successfully!\"\r\n      })\r\n      setPumpNumber('')\r\n      loadPumps()\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: err instanceof Error ? err.message : 'Failed to create pump',\r\n        variant: \"destructive\"\r\n      })\r\n    } finally {\r\n      setPumpLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleCreateNozzle = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n\r\n    if (!selectedStation || !selectedPump || !selectedTank || !nozzleNumber) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Please fill in all required fields\",\r\n        variant: \"destructive\"\r\n      })\r\n      return\r\n    }\r\n\r\n    setNozzleLoading(true)\r\n\r\n    try {\r\n      // Auto-format nozzle number\r\n      let formattedNozzleNumber = nozzleNumber.trim()\r\n\r\n      // If it's just a number (e.g. \"1\" or \"01\"), format it as \"NOZZLE-01\"\r\n      if (/^\\d+$/.test(formattedNozzleNumber)) {\r\n        formattedNozzleNumber = `NOZZLE-${formattedNozzleNumber.padStart(2, '0')}`\r\n      }\r\n\r\n      const response = await fetch('/api/nozzles', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          pumpId: selectedPump,\r\n          tankId: selectedTank,\r\n          nozzleNumber: formattedNozzleNumber,\r\n          isActive: true\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json()\r\n        throw new Error(errorData.error || 'Failed to create nozzle')\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Nozzle created successfully!\"\r\n      })\r\n      setSelectedPump('')\r\n      setSelectedTank('')\r\n      setNozzleNumber('')\r\n      loadNozzles()\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: err instanceof Error ? err.message : 'Failed to create nozzle',\r\n        variant: \"destructive\"\r\n      })\r\n    } finally {\r\n      setNozzleLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleDeletePump = async (pumpId: string) => {\r\n    if (!confirm('Are you sure you want to delete this pump? This action cannot be undone.')) return\r\n\r\n    try {\r\n      const response = await fetch(`/api/pumps/${pumpId}`, {\r\n        method: 'DELETE'\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json()\r\n        throw new Error(data.details || data.error || 'Failed to delete pump')\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Pump deleted successfully\"\r\n      })\r\n      loadPumps()\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: err instanceof Error ? err.message : \"Failed to delete pump\",\r\n        variant: \"destructive\"\r\n      })\r\n    }\r\n  }\r\n\r\n  const handleDeleteNozzle = async (nozzleId: string) => {\r\n    if (!confirm('Are you sure you want to delete this nozzle? This action cannot be undone.')) return\r\n\r\n    try {\r\n      const response = await fetch(`/api/nozzles/${nozzleId}`, {\r\n        method: 'DELETE'\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json()\r\n        throw new Error(data.details || data.error || 'Failed to delete nozzle')\r\n      }\r\n\r\n      toast({\r\n        title: \"Success\",\r\n        description: \"Nozzle deleted successfully\"\r\n      })\r\n      loadNozzles()\r\n    } catch (err) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: err instanceof Error ? err.message : \"Failed to delete nozzle\",\r\n        variant: \"destructive\"\r\n      })\r\n    }\r\n  }\r\n\r\n  const tankColumns: Column<Tank>[] = [\r\n    {\r\n      key: 'tankNumber' as keyof Tank,\r\n      title: 'Tank Number',\r\n      render: (value: unknown) => <span className=\"font-semibold\">{value as string}</span>\r\n    },\r\n    {\r\n      key: 'fuel' as keyof Tank,\r\n      title: 'Fuel Type',\r\n      render: (value: unknown) => (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Fuel className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\r\n          <span>{(value as Fuel)?.name || 'Unknown'}</span>\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'capacity' as keyof Tank,\r\n      title: 'Capacity',\r\n      render: (value: unknown) => (\r\n        <Badge variant=\"outline\">{(value as number).toLocaleString()} L</Badge>\r\n      )\r\n    },\r\n    {\r\n      key: 'currentLevel' as keyof Tank,\r\n      title: 'Current Level',\r\n      render: (value: unknown, row: Tank) => (\r\n        <div className=\"space-y-1\">\r\n          <div className=\"flex justify-between text-xs\">\r\n            <span>{(value as number).toLocaleString()} L</span>\r\n            <span className=\"text-muted-foreground\">{Math.round(((value as number) / row.capacity) * 100)}%</span>\r\n          </div>\r\n          <div className=\"h-2 w-full bg-secondary rounded-full overflow-hidden\">\r\n            <div\r\n              className=\"h-full bg-orange-500 rounded-full\"\r\n              style={{ width: `${Math.min(100, Math.max(0, ((value as number) / row.capacity) * 100))}%` }}\r\n            />\r\n          </div>\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'id' as keyof Tank,\r\n      title: 'Actions',\r\n      render: (value: unknown, row: Tank) => (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => handleEditTank(row)}\r\n            className=\"text-blue-500 hover:text-blue-700 hover:bg-blue-50 dark:hover:bg-blue-950/20\"\r\n          >\r\n            <Edit className=\"h-4 w-4\" />\r\n          </Button>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => handleDeleteTank(row.id)}\r\n            className=\"text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/20\"\r\n          >\r\n            <Trash2 className=\"h-4 w-4\" />\r\n          </Button>\r\n        </div>\r\n      )\r\n    }\r\n  ]\r\n\r\n  const pumpColumns: Column<Pump>[] = [\r\n    {\r\n      key: 'pumpNumber' as keyof Pump,\r\n      title: 'Pump Number',\r\n      render: (value: unknown) => (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Wrench className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\r\n          <span className=\"font-semibold\">{value as string}</span>\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'station' as keyof Pump,\r\n      title: 'Station',\r\n      render: (value: unknown) => (\r\n        <span className=\"text-sm text-muted-foreground\">{(value as { name: string }).name}</span>\r\n      )\r\n    },\r\n    {\r\n      key: 'nozzles' as keyof Pump,\r\n      title: 'Nozzles',\r\n      render: (value: unknown) => (\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          {(value as { nozzleNumber: string; tank: { fuelId: string; fuel?: Fuel } }[]).map((nozzle) => (\r\n            <Badge key={nozzle.nozzleNumber} variant=\"outline\">\r\n              {nozzle.nozzleNumber}  {nozzle.tank.fuel?.name || 'Unknown'}\r\n            </Badge>\r\n          ))}\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'id' as keyof Pump,\r\n      title: 'Actions',\r\n      render: (value: unknown, row: Pump) => (\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => handleDeletePump(row.id)}\r\n          className=\"text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/20\"\r\n        >\r\n          <Trash2 className=\"h-4 w-4\" />\r\n        </Button>\r\n      )\r\n    }\r\n  ]\r\n\r\n  const nozzleColumns: Column<Nozzle>[] = [\r\n    {\r\n      key: 'pump' as keyof Nozzle,\r\n      title: 'Pump',\r\n      render: (value: unknown) => (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Wrench className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\r\n          <span className=\"font-semibold\">{(value as { pumpNumber: string }).pumpNumber}</span>\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'nozzleNumber' as keyof Nozzle,\r\n      title: 'Nozzle',\r\n      render: (value: unknown) => (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Droplets className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\r\n          <span className=\"font-semibold\">#{value as string}</span>\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'tank' as keyof Nozzle,\r\n      title: 'Tank / Fuel Type',\r\n      render: (value: unknown) => (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Fuel className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\r\n          <Badge variant=\"outline\">{(value as { fuelId: string; fuel?: Fuel }).fuel?.name || 'Unknown'}</Badge>\r\n        </div>\r\n      )\r\n    },\r\n    {\r\n      key: 'isActive' as keyof Nozzle,\r\n      title: 'Status',\r\n      render: (value: unknown) => (\r\n        <Badge variant={value ? 'default' : 'secondary'}>\r\n          {value ? 'Active' : 'Inactive'}\r\n        </Badge>\r\n      )\r\n    },\r\n    {\r\n      key: 'id' as keyof Nozzle,\r\n      title: 'Actions',\r\n      render: (value: unknown, row: Nozzle) => (\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => handleDeleteNozzle(row.id)}\r\n          className=\"text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/20\"\r\n        >\r\n          <Trash2 className=\"h-4 w-4\" />\r\n        </Button>\r\n      )\r\n    }\r\n  ]\r\n\r\n  return (\r\n    <div className=\"space-y-6 p-6\">\r\n      <div className=\"flex items-center gap-4\">\r\n        <Button variant=\"outline\" onClick={() => router.push('/settings')}>\r\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n          Back to Settings\r\n        </Button>\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\r\n            <Fuel className=\"h-8 w-8 text-orange-600 dark:text-orange-400\" />\r\n            Tank Settings\r\n          </h1>\r\n          <p className=\"text-muted-foreground\">Manage tanks, pumps, and infrastructure</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Tank Dialog */}\r\n      <Dialog open={showTankDialog} onOpenChange={(open) => {\r\n        setShowTankDialog(open)\r\n        if (!open) resetTankForm()\r\n      }}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>{editingTankId ? 'Edit Tank' : 'Create New Tank'}</DialogTitle>\r\n            <DialogDescription>\r\n              {editingTankId ? 'Update tank details' : 'Add a new fuel storage tank to a station'}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <form onSubmit={handleSaveTank} className=\"space-y-4\">\r\n            <div>\r\n              <Label htmlFor=\"tank-station\">Station *</Label>\r\n              <Select\r\n                value={selectedStationForTank}\r\n                onValueChange={setSelectedStationForTank}\r\n                required\r\n                disabled={!!editingTankId} // Prevent changing station when editing\r\n              >\r\n                <SelectTrigger id=\"tank-station\" className=\"mt-2\">\r\n                  <SelectValue placeholder=\"Select station\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {stations.map((station) => (\r\n                    <SelectItem key={station.id} value={station.id}>\r\n                      {station.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"tankNumber\">Tank Number (Optional)</Label>\r\n              <Input\r\n                id=\"tankNumber\"\r\n                value={tankNumber}\r\n                onChange={(e) => setTankNumber(e.target.value)}\r\n                placeholder=\"01\"\r\n                className=\"mt-2\"\r\n                disabled={tankLoading}\r\n              />\r\n              <p className=\"text-xs text-muted-foreground mt-1\">Leave blank to auto-generate (e.g. TANK-01)</p>\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"fuelId\">Fuel Type *</Label>\r\n              <Select value={fuelId} onValueChange={setFuelId} required>\r\n                <SelectTrigger id=\"fuelId\" className=\"mt-2\">\r\n                  <SelectValue placeholder=\"Select fuel type\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {fuels.map(fuel => (\r\n                    <SelectItem key={fuel.id} value={fuel.id}>\r\n                      {fuel.icon} {fuel.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"capacity\">Capacity (Liters) *</Label>\r\n              <Input\r\n                id=\"capacity\"\r\n                type=\"number\"\r\n                step=\"0.01\"\r\n                min=\"0\"\r\n                value={capacity}\r\n                onChange={(e) => setCapacity(e.target.value)}\r\n                placeholder=\"10000\"\r\n                className=\"mt-2\"\r\n                disabled={tankLoading}\r\n                required\r\n              />\r\n            </div>\r\n            <DialogFooter>\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                onClick={() => setShowTankDialog(false)}\r\n                disabled={tankLoading}\r\n              >\r\n                Cancel\r\n              </Button>\r\n              <Button type=\"submit\" disabled={tankLoading}>\r\n                {tankLoading ? 'Saving...' : (editingTankId ? 'Update Tank' : 'Create Tank')}\r\n              </Button>\r\n            </DialogFooter>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      <FormCard\r\n        title=\"Infrastructure Setup\"\r\n        description=\"Manage pumps and nozzles for stations\"\r\n        actions={<Settings className=\"h-5 w-5 text-muted-foreground\" />}\r\n        className=\"p-4\"\r\n      >\r\n\r\n        <div>\r\n          <Label htmlFor=\"infra-station\">Select Station</Label>\r\n          <Select value={selectedStation} onValueChange={setSelectedStation}>\r\n            <SelectTrigger id=\"infra-station\" className=\"mt-2\">\r\n              <SelectValue placeholder=\"Select a station to manage\" />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              {stations.map((station) => (\r\n                <SelectItem key={station.id} value={station.id}>\r\n                  {station.name}\r\n                </SelectItem>\r\n              ))}\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n      </FormCard>\r\n\r\n      {selectedStation && (\r\n        <Tabs defaultValue=\"tanks\" className=\"space-y-6\">\r\n          <TabsList>\r\n            <TabsTrigger value=\"tanks\">\r\n              <Fuel className=\"mr-2 h-4 w-4\" />\r\n              Tanks\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"pumps\">\r\n              <Wrench className=\"mr-2 h-4 w-4\" />\r\n              Pumps\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"nozzles\">\r\n              <Droplets className=\"mr-2 h-4 w-4\" />\r\n              Nozzles\r\n            </TabsTrigger>\r\n          </TabsList>\r\n\r\n          <TabsContent value=\"tanks\" className=\"space-y-4\">\r\n            <div className=\"flex justify-end\">\r\n              <Button onClick={() => {\r\n                resetTankForm()\r\n                setShowTankDialog(true)\r\n              }}>\r\n                <Plus className=\"mr-2 h-4 w-4\" />\r\n                Add New Tank\r\n              </Button>\r\n            </div>\r\n            <FormCard title=\"Existing Tanks\">\r\n              <DataTable\r\n                data={tanks}\r\n                columns={tankColumns}\r\n                searchPlaceholder=\"Search tanks...\"\r\n                emptyMessage=\"No tanks found. Create one to get started!\"\r\n              />\r\n            </FormCard>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"pumps\" className=\"space-y-4\">\r\n            <FormCard title=\"Create New Pump\">\r\n              <form onSubmit={handleCreatePump} className=\"space-y-4\">\r\n                <div>\r\n                  <Label htmlFor=\"pumpNumber\">Pump Number *</Label>\r\n                  <Input\r\n                    id=\"pumpNumber\"\r\n                    value={pumpNumber}\r\n                    onChange={(e) => setPumpNumber(e.target.value)}\r\n                    placeholder=\"P-01\"\r\n                    disabled={pumpLoading}\r\n                    required\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">Unique identifier for this pump</p>\r\n                </div>\r\n\r\n                <Button type=\"submit\" disabled={pumpLoading}>\r\n                  {pumpLoading ? 'Creating...' : (\r\n                    <>\r\n                      <Plus className=\"mr-2 h-4 w-4\" />\r\n                      Create Pump\r\n                    </>\r\n                  )}\r\n                </Button>\r\n              </form>\r\n            </FormCard>\r\n\r\n            <FormCard title=\"Existing Pumps\">\r\n              <DataTable\r\n                data={pumps}\r\n                columns={pumpColumns}\r\n                searchPlaceholder=\"Search pumps...\"\r\n                emptyMessage=\"No pumps found. Create one to get started!\"\r\n              />\r\n            </FormCard>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"nozzles\" className=\"space-y-4\">\r\n            <FormCard title=\"Create New Nozzle\">\r\n              <form onSubmit={handleCreateNozzle} className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  <div>\r\n                    <Label htmlFor=\"nozzlePump\">Pump *</Label>\r\n                    <Select value={selectedPump} onValueChange={setSelectedPump} disabled={nozzleLoading}>\r\n                      <SelectTrigger id=\"nozzlePump\">\r\n                        <SelectValue placeholder=\"Select pump\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {pumps.map((pump) => (\r\n                          <SelectItem key={pump.id} value={pump.id}>\r\n                            {pump.pumpNumber}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label htmlFor=\"nozzleTank\">Tank / Fuel Type *</Label>\r\n                    <Select value={selectedTank} onValueChange={setSelectedTank} disabled={nozzleLoading}>\r\n                      <SelectTrigger id=\"nozzleTank\">\r\n                        <SelectValue placeholder=\"Select tank\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {tanks.map((tank) => (\r\n                          <SelectItem key={tank.id} value={tank.id}>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Fuel className=\"h-4 w-4\" />\r\n                              <span className=\"font-semibold\">{tank.tankNumber}</span>\r\n                              <span className=\"text-muted-foreground\">-</span>\r\n                              <span>{tank.fuel?.name || 'Unknown'}</span>\r\n                              <span className=\"text-xs text-muted-foreground\">\r\n                                ({tank.capacity.toLocaleString()}L)\r\n                              </span>\r\n                            </div>\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label htmlFor=\"nozzleNumber\">Nozzle Number *</Label>\r\n                    <Input\r\n                      id=\"nozzleNumber\"\r\n                      value={nozzleNumber}\r\n                      onChange={(e) => setNozzleNumber(e.target.value)}\r\n                      placeholder=\"01\"\r\n                      disabled={nozzleLoading}\r\n                      required\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <Button type=\"submit\" disabled={nozzleLoading}>\r\n                  {nozzleLoading ? 'Creating...' : (\r\n                    <>\r\n                      <Plus className=\"mr-2 h-4 w-4\" />\r\n                      Create Nozzle\r\n                    </>\r\n                  )}\r\n                </Button>\r\n              </form>\r\n            </FormCard>\r\n\r\n            <FormCard title=\"Existing Nozzles\">\r\n              <DataTable\r\n                data={nozzles}\r\n                columns={nozzleColumns}\r\n                searchPlaceholder=\"Search nozzles...\"\r\n                emptyMessage=\"No nozzles found. Create one to connect pumps to tanks!\"\r\n              />\r\n            </FormCard>\r\n          </TabsContent>\r\n        </Tabs>\r\n      )}\r\n\r\n      {!selectedStation && (\r\n        <Alert>\r\n          <AlertCircle className=\"h-4 w-4\" />\r\n          <AlertTitle>No Station Selected</AlertTitle>\r\n          <AlertDescription>Please select a station to view and manage its infrastructure.</AlertDescription>\r\n        </Alert>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\tolerance\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NumberInput' is defined but never used.","line":13,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":38,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchConfig'. Either include it or remove the dependency array.","line":51,"column":6,"nodeType":"ArrayExpression","endLine":51,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchConfig]","fix":{"range":[1859,1861],"text":"[fetchConfig]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'calculateExamples'. Either include it or remove the dependency array.","line":55,"column":6,"nodeType":"ArrayExpression","endLine":55,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [calculateExamples, formData]","fix":{"range":[1913,1923],"text":"[calculateExamples, formData]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":70,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":100,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":100,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateTolerance' is assigned a value but never used.","line":122,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":122,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_salesAmount' is defined but never used.","line":122,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":122,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatPercentage' is assigned a value but never used.","line":150,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":150,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport { Gauge, Save, RotateCcw, AlertTriangle, CheckCircle, Info, Calculator, ArrowLeft } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { NumberInput } from '@/components/inputs/NumberInput'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { useRouter } from 'next/navigation'\n\ninterface ToleranceConfig {\n  id: string\n  percentageTolerance: number // e.g., 0.3 for 0.3%\n  flatAmountTolerance: number // e.g., 200 for Rs. 200\n  useMaximum: boolean // true = max(%, Rs), false = min(%, Rs)\n  description: string\n  updatedBy: string\n  updatedAt: string\n}\n\ninterface ToleranceExample {\n  salesAmount: number\n  percentageAmount: number\n  flatAmount: number\n  finalTolerance: number\n  classification: 'within' | 'exceeded'\n}\n\nexport default function TolerancePage() {\n  const router = useRouter()\n  const [config, setConfig] = useState<ToleranceConfig | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [saving, setSaving] = useState(false)\n  const [formData, setFormData] = useState({\n    percentageTolerance: 0, // Not used - flat amount only\n    flatAmountTolerance: 20, // Rs. 20 flat tolerance\n    useMaximum: false, // Not used - flat amount only\n    description: 'Flat Rs. 20 tolerance for any sale amount'\n  })\n  const [examples, setExamples] = useState<ToleranceExample[]>([])\n  const { toast } = useToast()\n\n  useEffect(() => {\n    fetchConfig()\n  }, [])\n\n  useEffect(() => {\n    calculateExamples()\n  }, [formData])\n\n  const fetchConfig = async () => {\n    try {\n      const response = await fetch('/api/settings/tolerance')\n      const data = await response.json()\n      if (data) {\n        setConfig(data)\n        setFormData({\n          percentageTolerance: data.percentageTolerance,\n          flatAmountTolerance: data.flatAmountTolerance,\n          useMaximum: data.useMaximum,\n          description: data.description\n        })\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch tolerance configuration\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setSaving(true)\n\n    try {\n      const response = await fetch('/api/settings/tolerance', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(formData)\n      })\n\n      if (!response.ok) throw new Error('Failed to save tolerance configuration')\n\n      toast({\n        title: \"Success\",\n        description: \"Tolerance configuration saved successfully\"\n      })\n\n      fetchConfig()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to save tolerance configuration\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  const handleReset = () => {\n    if (config) {\n      setFormData({\n        percentageTolerance: config.percentageTolerance,\n        flatAmountTolerance: config.flatAmountTolerance,\n        useMaximum: config.useMaximum,\n        description: config.description\n      })\n    }\n  }\n\n  const calculateTolerance = (_salesAmount: number) => {\n    // Always return flat amount - no percentage calculation\n    return formData.flatAmountTolerance\n  }\n\n  const calculateExamples = () => {\n    const salesAmounts = [1000, 5000, 10000, 25000, 50000, 100000]\n\n    const newExamples = salesAmounts.map(salesAmount => {\n      const flatAmount = formData.flatAmountTolerance\n      const finalTolerance = flatAmount // Always flat amount\n\n      return {\n        salesAmount,\n        percentageAmount: 0, // Not used\n        flatAmount,\n        finalTolerance,\n        classification: 'within' as 'within' | 'exceeded'\n      }\n    })\n\n    setExamples(newExamples)\n  }\n\n  const formatCurrency = (amount: number) => {\n    return `Rs. ${amount.toFixed(2)}`\n  }\n\n  const formatPercentage = (value: number) => {\n    return `${value}%`\n  }\n\n  const hasChanges = config && (\n    config.flatAmountTolerance !== formData.flatAmountTolerance ||\n    config.description !== formData.description\n  )\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">Tolerance Configuration</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Configure variance tolerance levels and thresholds for sales reconciliation\n            </p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Gauge className=\"h-6 w-6 text-muted-foreground\" />\n          <span className=\"text-sm text-muted-foreground\">System-wide settings</span>\n        </div>\n      </div>\n\n      {/* Current Configuration Alert */}\n      {config && (\n        <Alert className=\"border-blue-500/20 dark:border-blue-500/30 bg-blue-500/10 dark:bg-blue-500/20\">\n          <Info className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          <AlertDescription>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <strong className=\"text-blue-700 dark:text-blue-300\">Current Tolerance:</strong>\n                <span className=\"ml-2 text-blue-700 dark:text-blue-300\">\n                  Flat {formatCurrency(config.flatAmountTolerance)} for any sale\n                </span>\n              </div>\n              <div className=\"text-xs text-blue-600 dark:text-blue-400\">\n                Last updated: {new Date(config.updatedAt).toLocaleString()} by {config.updatedBy}\n              </div>\n            </div>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Configuration Form */}\n        <FormCard title=\"Tolerance Settings\" description=\"Configure the tolerance calculation parameters\">\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"flatAmountTolerance\">Flat Amount Tolerance (Rs.) *</Label>\n                <MoneyInput\n                  id=\"flatAmountTolerance\"\n                  value={formData.flatAmountTolerance}\n                  onChange={(value) => setFormData({ ...formData, flatAmountTolerance: value })}\n                  placeholder=\"20.00\"\n                  required\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Fixed Rs. 20 tolerance for any sale amount (as per manager requirement)\n                </p>\n              </div>\n\n              <Alert className=\"border-blue-500/20 dark:border-blue-500/30 bg-blue-500/10 dark:bg-blue-500/20\">\n                <Info className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                <AlertDescription className=\"text-blue-700 dark:text-blue-300\">\n                  <strong>Note:</strong> The system now uses a flat tolerance amount only.\n                  Percentage tolerance is no longer used. Any variance within Rs. {formData.flatAmountTolerance.toLocaleString()}\n                  is considered normal.\n                </AlertDescription>\n              </Alert>\n\n              <div>\n                <Label htmlFor=\"description\">Description</Label>\n                <Input\n                  id=\"description\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  placeholder=\"Configuration description\"\n                  required\n                />\n              </div>\n            </div>\n\n            {/* Formula Display */}\n            <div className=\"bg-muted p-4 rounded-lg\">\n              <h4 className=\"font-medium text-foreground mb-2 flex items-center gap-2\">\n                <Calculator className=\"h-4 w-4\" />\n                Tolerance Formula\n              </h4>\n              <div className=\"text-sm text-foreground bg-card p-3 rounded border\">\n                Tolerance = Rs. {formData.flatAmountTolerance.toFixed(2)}\n                <br />\n                <span className=\"text-xs text-muted-foreground mt-2 block\">\n                  (Flat amount for any sale - no percentage calculation)\n                </span>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleReset}\n                disabled={!hasChanges}\n              >\n                <RotateCcw className=\"mr-2 h-4 w-4\" />\n                Reset\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={saving || !hasChanges}\n              >\n                <Save className=\"mr-2 h-4 w-4\" />\n                {saving ? 'Saving...' : 'Save Configuration'}\n              </Button>\n            </div>\n          </form>\n        </FormCard>\n\n        {/* Examples */}\n        <FormCard title=\"Tolerance Examples\" description=\"See how tolerance is calculated for different sales amounts\">\n          <div className=\"space-y-4\">\n            {examples.map((example, index) => (\n              <div key={index} className=\"border rounded-lg p-4\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <div className=\"font-medium\">\n                    Sales: {formatCurrency(example.salesAmount)}\n                  </div>\n                  <Badge className=\"bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300\">\n                    <CheckCircle className=\"h-3 w-3 mr-1\" />\n                    Within Tolerance\n                  </Badge>\n                </div>\n\n                <div className=\"text-sm text-muted-foreground\">\n                  <div className=\"font-medium text-foreground mb-1\">Tolerance Amount:</div>\n                  <div className=\"text-lg font-bold text-green-600 dark:text-green-400\">\n                    {formatCurrency(example.finalTolerance)}\n                  </div>\n                  <p className=\"text-xs mt-1\">Same for all sale amounts</p>\n                </div>\n              </div>\n            ))}\n          </div>\n        </FormCard>\n      </div>\n\n      {/* Usage Information */}\n      <Card>\n        <CardHeader>\n          <CardTitle>How Tolerance Works</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-2 flex items-center gap-2\">\n                <Calculator className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                Calculation Method\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\n                <li> Calculate percentage of sales amount</li>\n                <li> Compare with flat amount threshold</li>\n                <li> Use maximum or minimum based on setting</li>\n                <li> Apply to variance classification</li>\n              </ul>\n            </div>\n\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-2 flex items-center gap-2\">\n                <CheckCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                Usage Areas\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\n                <li> Shift reconciliation</li>\n                <li> Tank variance analysis</li>\n                <li> POS batch reconciliation</li>\n                <li> Daily summary reports</li>\n              </ul>\n            </div>\n\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-2 flex items-center gap-2\">\n                <AlertTriangle className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n                Best Practices\n              </h4>\n              <ul className=\"text-sm text-muted-foreground space-y-1\">\n                <li> Review tolerance regularly</li>\n                <li> Consider seasonal variations</li>\n                <li> Monitor exception rates</li>\n                <li> Document changes with reasons</li>\n              </ul>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\settings\\users\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":31,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchUsers'. Either include it or remove the dependency array.","line":72,"column":6,"nodeType":"ArrayExpression","endLine":72,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchUsers]","fix":{"range":[2571,2573],"text":"[fetchUsers]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":86,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":166,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":166,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Users, Plus, Edit, Trash2, Mail, Shield, User, Crown, UserCheck, ArrowLeft, Key } from 'lucide-react'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { TempPasswordModal } from '@/components/admin/TempPasswordModal'\n\ninterface SystemUser {\n  id: string\n  name: string\n  email: string\n  role: 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS'\n  status: 'active' | 'inactive' | 'suspended'\n  lastLogin: string\n  createdAt: string\n  updatedAt: string\n}\n\nexport default function UsersPage() {\n  const router = useRouter()\n  const [users, setUsers] = useState<SystemUser[]>([])\n  const [loading, setLoading] = useState(true)\n  const [dialogOpen, setDialogOpen] = useState(false)\n  const [editingUser, setEditingUser] = useState<SystemUser | null>(null)\n  const [formData, setFormData] = useState({\n    name: '',\n    email: '',\n    password: '',\n    role: 'MANAGER' as SystemUser['role'],\n    status: 'active' as SystemUser['status']\n  })\n  const { toast } = useToast()\n  const [resetPasswordUser, setResetPasswordUser] = useState<{ username: string; tempPassword: string } | null>(null)\n  const [showTempPasswordModal, setShowTempPasswordModal] = useState(false)\n\n  // Get current user role\n  const userRole = typeof window !== 'undefined' ? localStorage.getItem('userRole') : null\n  const isDeveloper = userRole === 'DEVELOPER'\n  const isOwner = userRole === 'OWNER'\n  const isManager = userRole === 'MANAGER'\n\n  // Define role hierarchy - who can manage whom\n  const getRoleHierarchy = () => {\n    if (isDeveloper) {\n      return ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n    }\n    if (isOwner) {\n      return ['OWNER', 'MANAGER', 'ACCOUNTS']\n    }\n    if (isManager) {\n      return ['MANAGER', 'ACCOUNTS']\n    }\n    return [] // ACCOUNTS can't manage users\n  }\n\n  const manageableRoles = getRoleHierarchy()\n\n  // Filter users based on current user's role\n  const filteredUsers = users.filter(user => manageableRoles.includes(user.role))\n\n  useEffect(() => {\n    fetchUsers()\n  }, [])\n\n  const fetchUsers = async () => {\n    try {\n      const response = await fetch('/api/users')\n      if (!response.ok) throw new Error('Failed to fetch users')\n      const data = await response.json()\n\n      if (Array.isArray(data)) {\n        setUsers(data)\n      } else {\n        console.error('Invalid users data:', data)\n        setUsers([])\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to fetch users\",\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    try {\n      const url = editingUser ? `/api/users/${editingUser.id}` : '/api/users'\n      const method = editingUser ? 'PUT' : 'POST'\n\n      // Prepare request body with username field\n      const requestBody = {\n        ...formData,\n        username: formData.name // API expects 'username' field\n      }\n\n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(requestBody)\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to save user')\n      }\n\n      toast({\n        title: \"Success\",\n        description: `User ${editingUser ? 'updated' : 'created'} successfully`\n      })\n\n      setDialogOpen(false)\n      resetForm()\n      fetchUsers()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : `Failed to ${editingUser ? 'update' : 'create'} user`,\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleEdit = (user: SystemUser) => {\n    setEditingUser(user)\n    setFormData({\n      name: user.name || '',\n      email: user.email || '',\n      password: '', // Don't populate password when editing\n      role: user.role,\n      status: user.status\n    })\n    setDialogOpen(true)\n  }\n\n  const handleDelete = async (user: SystemUser) => {\n    if (!confirm(`Are you sure you want to delete user \"${user.name}\"?`)) return\n\n    try {\n      const response = await fetch(`/api/users/${user.id}`, {\n        method: 'DELETE'\n      })\n\n      if (!response.ok) throw new Error('Failed to delete user')\n\n      toast({\n        title: \"Success\",\n        description: \"User deleted successfully\"\n      })\n\n      fetchUsers()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete user\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const handleResetPassword = async (user: SystemUser) => {\n    // Prevent resetting own password\n    const currentUserId = localStorage.getItem('userId')\n    if (user.id === currentUserId) {\n      toast({\n        title: \"Error\",\n        description: \"You cannot reset your own password using this method\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    // Confirm action\n    if (!confirm(`Are you sure you want to reset the password for ${user.name}? They will be logged out and required to change their password on next login.`)) {\n      return\n    }\n\n    try {\n      const response = await fetch('/api/admin/reset-password', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ userId: user.id })\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.detail || 'Failed to reset password')\n      }\n\n      const data = await response.json()\n\n      // Show temp password modal\n      setResetPasswordUser({\n        username: data.username,\n        tempPassword: data.tempPassword\n      })\n      setShowTempPasswordModal(true)\n\n      toast({\n        title: \"Success\",\n        description: \"Password reset successfully\"\n      })\n\n      fetchUsers()\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Failed to reset password\",\n        variant: \"destructive\"\n      })\n    }\n  }\n\n  const resetForm = () => {\n    setEditingUser(null)\n    setFormData({\n      name: '',\n      email: '',\n      password: '',\n      role: 'MANAGER',\n      status: 'active'\n    })\n  }\n\n  const getStatusColor = (status: SystemUser['status']) => {\n    switch (status) {\n      case 'active': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'inactive': return 'bg-muted text-foreground'\n      case 'suspended': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getRoleColor = (role: SystemUser['role']) => {\n    switch (role) {\n      case 'DEVELOPER': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      case 'OWNER': return 'bg-purple-500/20 text-purple-400 dark:bg-purple-600/30 dark:text-purple-300'\n      case 'MANAGER': return 'bg-blue-500/20 text-blue-400 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'ACCOUNTS': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getRoleIcon = (role: SystemUser['role']) => {\n    switch (role) {\n      case 'DEVELOPER': return <Shield className=\"h-3 w-3 fill-current\" />\n      case 'OWNER': return <Crown className=\"h-3 w-3\" />\n      case 'MANAGER': return <Shield className=\"h-3 w-3\" />\n      case 'ACCOUNTS': return <UserCheck className=\"h-3 w-3\" />\n      default: return <User className=\"h-3 w-3\" />\n    }\n  }\n\n  const formatLastLogin = (dateString: string) => {\n    if (!dateString) return 'Never'\n    const date = new Date(dateString)\n    if (isNaN(date.getTime())) return 'Never'\n\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))\n\n    if (diffDays === 0) return 'Today'\n    if (diffDays === 1) return 'Yesterday'\n    if (diffDays < 7) return `${diffDays} days ago`\n    return date.toLocaleDateString()\n  }\n\n  const columns = [\n    {\n      key: 'name' as keyof SystemUser,\n      title: 'Name',\n      render: (value: unknown, row: SystemUser) => (\n        <div className=\"flex items-center gap-2\">\n          <div className=\"w-8 h-8 bg-muted rounded-full flex items-center justify-center\">\n            <User className=\"h-4 w-4 text-muted-foreground\" />\n          </div>\n          <div>\n            <div className=\"font-medium\">{value as string}</div>\n            <div className=\"text-sm text-muted-foreground flex items-center gap-1\">\n              <Mail className=\"h-3 w-3\" />\n              {row.email}\n            </div>\n          </div>\n        </div>\n      )\n    },\n    {\n      key: 'role' as keyof SystemUser,\n      title: 'Role',\n      render: (value: unknown) => (\n        <Badge className={getRoleColor(value as SystemUser['role'])}>\n          <div className=\"flex items-center gap-1\">\n            {getRoleIcon(value as SystemUser['role'])}\n            {value as string}\n          </div>\n        </Badge>\n      )\n    },\n    {\n      key: 'status' as keyof SystemUser,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = value as string\n        if (!status) return <Badge className=\"bg-muted text-foreground\">Unknown</Badge>\n        return (\n          <Badge className={getStatusColor(status as SystemUser['status'])}>\n            {status.charAt(0).toUpperCase() + status.slice(1)}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'lastLogin' as keyof SystemUser,\n      title: 'Last Login',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">\n          {formatLastLogin(value as string)}\n        </span>\n      )\n    },\n    {\n      key: 'createdAt' as keyof SystemUser,\n      title: 'Created',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">\n          {new Date(value as string).toLocaleDateString()}\n        </span>\n      )\n    },\n    {\n      key: 'id' as keyof SystemUser,\n      title: 'Actions',\n      render: (value: unknown, row: SystemUser) => (\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleEdit(row)}\n          >\n            <Edit className=\"h-4 w-4\" />\n          </Button>\n          {(isDeveloper || isOwner) && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => handleResetPassword(row)}\n              className=\"text-orange-600 dark:text-orange-400 hover:text-orange-700\"\n              title=\"Reset Password\"\n            >\n              <Key className=\"h-4 w-4\" />\n            </Button>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => handleDelete(row)}\n            className=\"text-red-600 dark:text-red-400 hover:text-red-700\"\n            disabled={row.role === 'OWNER'}\n          >\n            <Trash2 className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      )\n    }\n  ]\n\n  const stats = [\n    {\n      title: 'Total Users',\n      value: filteredUsers.length.toString(),\n      description: 'System users',\n      icon: <Users className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    },\n    {\n      title: 'Active',\n      value: filteredUsers.filter(u => u.status === 'active').length.toString(),\n      description: 'Currently active',\n      icon: <div className=\"h-5 w-5 bg-green-500/10 dark:bg-green-500/200 rounded-full\" />\n    },\n    {\n      title: 'Owners',\n      value: filteredUsers.filter(u => u.role === 'OWNER').length.toString(),\n      description: 'System owners',\n      icon: <Crown className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n    },\n    {\n      title: 'Managers',\n      value: filteredUsers.filter(u => u.role === 'MANAGER').length.toString(),\n      description: 'Station managers',\n      icon: <Shield className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n    }\n  ]\n\n  const rolePermissions = {\n    DEVELOPER: [\n      'FULL system access',\n      'Add/Delete stations',\n      'All OWNER permissions',\n      'System configuration',\n      'Database management'\n    ],\n    OWNER: [\n      'Full system access',\n      'User management',\n      'Settings configuration',\n      'Financial reports',\n      'All station operations'\n    ],\n    MANAGER: [\n      'Station operations',\n      'Shift management',\n      'Tank operations',\n      'POS management',\n      'Credit management'\n    ],\n    ACCOUNTS: [\n      'Financial management',\n      'POS reconciliation',\n      'Credit management',\n      'Reports access',\n      'Safe operations'\n    ]\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/settings')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground\">User Management</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Manage system users, roles, and access permissions\n            </p>\n          </div>\n        </div>\n        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n          <DialogTrigger asChild>\n            <Button onClick={resetForm}>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add User\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingUser ? 'Edit User' : 'Add New User'}\n              </DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"name\">Full Name</Label>\n                  <Input\n                    id=\"name\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    placeholder=\"e.g., John Doe\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"email\">Email Address</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={formData.email}\n                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                    placeholder=\"e.g., john@example.com\"\n                    required\n                  />\n                </div>\n              </div>\n\n              {/* Password field - required for new users, optional for editing */}\n              <div>\n                <Label htmlFor=\"password\">\n                  Password {editingUser ? '(leave blank to keep current)' : ''}\n                </Label>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  value={formData.password}\n                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                  placeholder=\"Enter password\"\n                  required={!editingUser}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"role\">Role</Label>\n                  <select\n                    id=\"role\"\n                    value={formData.role}\n                    onChange={(e) => setFormData({ ...formData, role: e.target.value as SystemUser['role'] })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    {/* Show roles based on current user's permissions */}\n                    {isDeveloper && <option value=\"DEVELOPER\">Developer</option>}\n                    {(isDeveloper || isOwner) && <option value=\"OWNER\">Owner</option>}\n                    {(isDeveloper || isOwner || isManager) && <option value=\"MANAGER\">Manager</option>}\n                    {(isDeveloper || isOwner || isManager) && <option value=\"ACCOUNTS\">Accounts</option>}\n                  </select>\n                </div>\n                <div>\n                  <Label htmlFor=\"status\">Status</Label>\n                  <select\n                    id=\"status\"\n                    value={formData.status}\n                    onChange={(e) => setFormData({ ...formData, status: e.target.value as SystemUser['status'] })}\n                    className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                    required\n                  >\n                    <option value=\"active\">Active</option>\n                    <option value=\"inactive\">Inactive</option>\n                    <option value=\"suspended\">Suspended</option>\n                  </select>\n                </div>\n              </div>\n\n              {/* Role Permissions Preview */}\n              <div className=\"bg-muted p-4 rounded-lg\">\n                <h4 className=\"font-medium text-foreground mb-2 flex items-center gap-2\">\n                  {getRoleIcon(formData.role)}\n                  {formData.role} Permissions\n                </h4>\n                <ul className=\"text-sm text-muted-foreground space-y-1\">\n                  {rolePermissions[formData.role].map((permission, index) => (\n                    <li key={index} className=\"flex items-center gap-2\">\n                      <div className=\"w-1.5 h-1.5 bg-muted-foreground rounded-full flex-shrink-0\"></div>\n                      {permission}\n                    </li>\n                  ))}\n                </ul>\n              </div>\n\n              <div className=\"flex justify-end gap-3 pt-4\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                  Cancel\n                </Button>\n                <Button type=\"submit\">\n                  {editingUser ? 'Update User' : 'Create User'}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {stats.map((stat, index) => (\n          <Card key={index}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-2xl font-bold text-foreground\">{stat.value}</div>\n                  <div className=\"text-sm font-medium text-foreground\">{stat.title}</div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.description}</div>\n                </div>\n                <div className=\"flex-shrink-0\">\n                  {stat.icon}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Role Permissions Overview */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n        {Object.entries(rolePermissions)\n          .filter(([role]) => !isOwner || role !== 'DEVELOPER')\n          .map(([role, permissions]) => (\n            <Card key={role}>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-lg\">\n                  {getRoleIcon(role as SystemUser['role'])}\n                  {role}\n                  <Badge className={getRoleColor(role as SystemUser['role'])} variant=\"secondary\">\n                    {filteredUsers.filter(u => u.role === role).length} users\n                  </Badge>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <ul className=\"space-y-2\">\n                  {permissions.map((permission, index) => (\n                    <li key={index} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <div className=\"w-1.5 h-1.5 bg-muted-foreground rounded-full flex-shrink-0\"></div>\n                      {permission}\n                    </li>\n                  ))}\n                </ul>\n              </CardContent>\n            </Card>\n          ))}\n      </div>\n\n      {/* Users Table */}\n      <FormCard title=\"System Users\" description=\"Manage user accounts and access permissions\">\n        <DataTable\n          data={filteredUsers}\n          columns={columns}\n          searchPlaceholder=\"Search users...\"\n        />\n      </FormCard>\n\n      {/* Temp Password Modal */}\n      {resetPasswordUser && (\n        <TempPasswordModal\n          isOpen={showTempPasswordModal}\n          onClose={() => {\n            setShowTempPasswordModal(false)\n            setResetPasswordUser(null)\n          }}\n          tempPassword={resetPasswordUser.tempPassword}\n          username={resetPasswordUser.username}\n        />\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\shifts\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\shifts\\close\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setNozzles' is assigned a value but never used.","line":194,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":194,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tenderSummary' is assigned a value but never used.","line":205,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":205,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setPumperDeclaredCardAmounts' is assigned a value but never used.","line":209,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":209,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":278,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":278,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":386,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":386,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalDeclared' is assigned a value but never used.","line":650,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":650,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'checkDuplicateCard' is assigned a value but never used.","line":875,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":875,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentSlip' is assigned a value but never used.","line":989,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":989,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":1154,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":1154,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalCash' is assigned a value but never used.","line":1319,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":1319,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalCheque' is assigned a value but never used.","line":1326,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":1326,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":1559,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":1559,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'allTerminalIds' is assigned a value but never used.","line":2322,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":2322,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport { MoneyInput } from '@/components/inputs/MoneyInput'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { Clock, Fuel, DollarSign, CreditCard, FileText, Plus, Trash2, Printer, Wallet, ExternalLink, Building2, Check, ChevronDown, ChevronUp } from 'lucide-react'\nimport { Checkbox } from '@/components/ui/checkbox'\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport { getCurrentUserName } from '@/lib/auth'\nimport { getNozzleDisplayWithBadge } from '@/lib/nozzleUtils'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface Shift {\n  id: string\n  stationId: string\n  templateId: string\n  startTime: string\n  endTime?: string\n  status: string\n  openedBy: string\n  assignments?: Assignment[]\n}\n\ninterface Assignment {\n  id: string | number\n  nozzleId: string\n  pumperName: string\n  startMeterReading: number\n  endMeterReading?: number\n  status: string\n  canSales?: number // Can sales in litres\n  pumpSales?: number // Pump sales in litres (calculated)\n  nozzle?: {\n    id: string\n    nozzleNumber: string\n    pump?: {\n      pumpNumber: string\n    }\n    tank?: {\n      fuelId: string\n      fuel?: {\n        id: string\n        name: string\n        icon?: string | null\n      }\n    }\n  }\n}\n\ninterface PosTerminal {\n  id: string\n  name: string\n  terminalNumber: string\n  bank?: {\n    id: string\n    name: string\n  }\n}\n\ninterface TenderSummary {\n  totalSales: number\n  totalDeclared: number\n  variance: number\n  varianceClassification: {\n    variance: number\n    variancePercentage: number\n    isNormal: boolean\n    tolerance: number\n  }\n  salesBreakdown?: {\n    totalPumpSales: number\n    totalCanSales: number\n    totalLitres: number\n    oilSales?: {\n      totalAmount: number\n      salesCount: number\n    }\n  }\n}\n\ninterface PumperCheque {\n  id: string\n  chequeNumber: string\n  amount: number\n  bankId?: string\n  bankName?: string\n  status?: 'PENDING' | 'CLEARED' | 'BOUNCED' // Cheque status\n  receivedFrom: string // Person/company who gave the cheque\n}\n\ninterface POSSlipEntry {\n  id: string\n  terminalId: string\n  amount: number\n  lastFourDigits: string\n  cardType: 'VISA' | 'MASTER' | 'AMEX' | 'QR' | 'DIALOG_TOUCH'\n  timestamp: Date\n  notes?: string\n}\n\ninterface MissingSlipEntry {\n  id: string\n  terminalId: string\n  amount: number\n  lastFourDigits: string\n  timestamp: Date\n  notes?: string\n}\n\ninterface PumperExpense {\n  id: string\n  type: 'BANK_DEPOSIT' | 'LOAN_GIVEN' | 'OTHER'\n  amount: number\n  description?: string // For \"OTHER\" type\n  // For BANK_DEPOSIT\n  bankId?: string\n  bankName?: string\n  accountNumber?: string // Can be from bank or manually entered\n  depositedBy?: string\n  // For LOAN_GIVEN\n  loanGivenTo?: string // Pumper ID who received the loan\n  loanGivenToName?: string // Pumper name (for display)\n  loanGivenBy?: string // Person who authorized/gave the loan\n  monthlyRental?: number // Monthly rental amount to deduct from salary\n}\n\ninterface PumperTestPour {\n  id: string\n  nozzleId: string\n  nozzleNumber?: string\n  pumpNumber?: string\n  fuelType?: string\n  amount: number // in liters\n  reason: string // reason for test pour\n  returned: boolean\n  notes?: string\n  timestamp?: Date\n}\n\ninterface PumperBreakdown {\n  pumperName: string\n  calculatedSales: number\n  declaredAmount: number\n  declaredCash: number\n  declaredCardAmounts: Record<string, number> // terminalId -> amount\n  declaredCreditAmounts: Record<string, number> // customerId -> amount\n  declaredCheque: number\n  cheques: PumperCheque[]\n  advanceTaken: number\n  expenses: PumperExpense[]\n  totalExpenses: number\n  variance: number\n  varianceStatus: 'NORMAL' | 'ADD_TO_SALARY' | 'DEDUCT_FROM_SALARY'\n  assignments: Assignment[]\n}\n\ninterface Pumper {\n  id: string\n  name: string\n  employeeId?: string\n  isActive?: boolean\n}\n\nexport default function CloseShiftPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [shifts, setShifts] = useState<Shift[]>([])\n  const [assignments, setAssignments] = useState<Assignment[]>([])\n  const [posTerminals, setPosTerminals] = useState<PosTerminal[]>([])\n  const [creditCustomers, setCreditCustomers] = useState<Array<{ id: string; name: string; creditLimit: number; currentBalance: number }>>([])\n  const [banks, setBanks] = useState<Array<{ id: string; name: string; branch?: string; accountNumber?: string }>>([])\n  const [pumpers, setPumpers] = useState<Pumper[]>([])\n  const [nozzles, setNozzles] = useState<Array<{ id: string; nozzleNumber: string; pumpNumber?: string; fuelType?: string; pumpId?: string; tankId?: string }>>([])\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const { selectedStation } = useStation()\n  const [selectedShift, setSelectedShift] = useState('')\n  const [endTime, setEndTime] = useState<Date>(new Date())\n\n  // Tender summary (calculated from pumper-wise data)\n  const [tenderSummary, setTenderSummary] = useState<TenderSummary | null>(null)\n\n  // Pumper-wise breakdown\n  const [pumperDeclaredCash, setPumperDeclaredCash] = useState<Record<string, number>>({}) // pumperName -> cash amount\n  const [pumperDeclaredCardAmounts, setPumperDeclaredCardAmounts] = useState<Record<string, Record<string, number>>>({}) // pumperName -> {terminalId -> amount}\n  const [pumperDeclaredCreditAmounts, setPumperDeclaredCreditAmounts] = useState<Record<string, Record<string, number>>>({}) // pumperName -> {customerId -> amount}\n  const [pumperDeclaredCheques, setPumperDeclaredCheques] = useState<Record<string, PumperCheque[]>>({}) // pumperName -> cheques array\n  const [pumperAdvances, setPumperAdvances] = useState<Record<string, number>>({}) // pumperName -> advance amount\n  const [otherPumperAdvances, setOtherPumperAdvances] = useState<Record<string, Array<{ pumperId: string; pumperName: string; amount: number }>>>({}) // pumperName -> array of advances given to other pumpers\n  const [pumperExpenses, setPumperExpenses] = useState<Record<string, PumperExpense[]>>({}) // pumperName -> expenses array\n  const [pumperTestPours, setPumperTestPours] = useState<Record<string, PumperTestPour[]>>({}) // pumperName -> test pours array\n  const [pumperBreakdowns, setPumperBreakdowns] = useState<PumperBreakdown[]>([])\n  const [pumperMonthlyRentals, setPumperMonthlyRentals] = useState<Record<string, number>>({}) // pumperId -> total monthly rental from active loans\n\n  // POS Terminal Verification (individual slips per pumper)\n  const [posSlips, setPosSlips] = useState<Record<string, POSSlipEntry[]>>({}) // pumperName -> array of slips\n  const [posVerificationOpen, setPosVerificationOpen] = useState<Record<string, boolean>>({}) // pumperName -> is open\n  const [missingSlips, setMissingSlips] = useState<Record<string, MissingSlipEntry[]>>({}) // pumperName-terminalId -> missing slips array\n  // Track duplicate card errors per slip\n  const [duplicateCardErrors, setDuplicateCardErrors] = useState<Record<string, { cardNumber: string; duplicateSlip: POSSlipEntry }>>({}) // slipId -> error details\n  // Track minimized slips\n  const [minimizedPOSSlips, setMinimizedPOSSlips] = useState<Record<string, boolean>>({}) // slipId -> is minimized\n  const [minimizedMissingSlips, setMinimizedMissingSlips] = useState<Record<string, boolean>>({}) // slipId -> is minimized\n\n  // Add Bank Dialog State\n  const [addBankDialogOpen, setAddBankDialogOpen] = useState(false)\n  const [newBank, setNewBank] = useState({ name: '', branch: '', accountNumber: '' })\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const [stationsRes, customersRes, banksRes, pumpersRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/credit/customers?active=true'),\n          fetch('/api/banks?active=true'),\n          fetch('/api/pumpers?active=true&status=ACTIVE')\n        ])\n\n        if (!stationsRes.ok) {\n          console.error('Failed to load stations:', stationsRes.status)\n          setStations([])\n        } else {\n          const stationsData = await stationsRes.json()\n          setStations(Array.isArray(stationsData) ? stationsData : [])\n        }\n\n        if (!customersRes.ok) {\n          console.error('Failed to load credit customers:', customersRes.status)\n          setCreditCustomers([])\n        } else {\n          const customersData = await customersRes.json()\n          setCreditCustomers(Array.isArray(customersData) ? customersData : [])\n        }\n\n        if (!banksRes.ok) {\n          console.error('Failed to load banks:', banksRes.status)\n          setBanks([])\n        } else {\n          const banksData = await banksRes.json()\n          setBanks(Array.isArray(banksData) ? banksData : [])\n        }\n\n        if (!pumpersRes.ok) {\n          console.error('Failed to load pumpers:', pumpersRes.status)\n          setPumpers([])\n        } else {\n          const pumpersData = await pumpersRes.json()\n          setPumpers(Array.isArray(pumpersData) ? pumpersData : [])\n\n          // Fetch monthly loan rentals for all pumpers\n          await fetchPumperMonthlyRentals(pumpersData)\n        }\n      } catch (err) {\n        setError('Failed to load data')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  // Fetch monthly rental totals for all pumpers\n  const fetchPumperMonthlyRentals = async (pumpersData: Pumper[]) => {\n    try {\n      const rentals: Record<string, number> = {}\n\n      for (const pumper of pumpersData) {\n        // Fetch active loans for this pumper\n        const loansRes = await fetch(`/api/loans/pumper?pumperName=${encodeURIComponent(pumper.name)}&status=ACTIVE`)\n\n        if (loansRes.ok) {\n          const loans = await loansRes.json()\n          // Sum up monthly rental amounts from all active loans\n          const totalMonthlyRental = loans.reduce((sum: number, loan: { monthlyRental: number }) => {\n            return sum + (loan.monthlyRental || 0)\n          }, 0)\n\n          rentals[pumper.id] = totalMonthlyRental\n        } else {\n          rentals[pumper.id] = 0\n        }\n      }\n\n      setPumperMonthlyRentals(rentals)\n    } catch (err) {\n      console.error('Failed to fetch pumper monthly rentals:', err)\n    }\n  }\n\n  // Load POS terminals when station changes\n  useEffect(() => {\n    if (selectedStation) {\n      const loadPosTerminals = async () => {\n        try {\n          const res = await fetch(`/api/pos/terminals?stationId=${selectedStation}`)\n          if (res.ok) {\n            const terminalsData = await res.json()\n            // Debug: Log to check if bank data is included\n            if (Array.isArray(terminalsData) && terminalsData.length > 0) {\n              console.log('POS Terminals loaded:', terminalsData.map((t: PosTerminal) => ({\n                id: t.id,\n                name: t.name,\n                terminalNumber: t.terminalNumber,\n                bank: t.bank\n              })))\n            }\n            setPosTerminals(Array.isArray(terminalsData) ? terminalsData : [])\n          } else {\n            setPosTerminals([])\n          }\n        } catch (err) {\n          console.error('Failed to load POS terminals:', err)\n          setPosTerminals([])\n        }\n      }\n\n      loadPosTerminals()\n    } else {\n      setPosTerminals([])\n    }\n  }, [selectedStation])\n\n  // Load shifts when station changes\n  useEffect(() => {\n    if (selectedStation) {\n      const loadShifts = async () => {\n        try {\n          const res = await fetch(`/api/shifts?stationId=${selectedStation}&active=true`)\n          const shiftsData = await res.json()\n\n          // Handle both old format (array) and new format (object with shifts property)\n          let shiftsArray: Shift[] = []\n          if (Array.isArray(shiftsData)) {\n            shiftsArray = shiftsData\n          } else if (shiftsData.shifts && Array.isArray(shiftsData.shifts)) {\n            shiftsArray = shiftsData.shifts\n          } else {\n            shiftsArray = []\n          }\n\n          // Fetch assignments for each shift since they're not included in the initial response\n          const shiftsWithAssignments = await Promise.all(\n            shiftsArray.map(async (shift) => {\n              try {\n                const assignmentsRes = await fetch(`/api/shifts/${shift.id}/assignments`)\n                if (assignmentsRes.ok) {\n                  const assignments = await assignmentsRes.json()\n                  return {\n                    ...shift,\n                    assignments: Array.isArray(assignments) ? assignments : []\n                  }\n                }\n                return { ...shift, assignments: [] }\n              } catch (err) {\n                console.error(`Error fetching assignments for shift ${shift.id}:`, err)\n                return { ...shift, assignments: [] }\n              }\n            })\n          )\n\n          setShifts(shiftsWithAssignments)\n        } catch (err) {\n          setError('Failed to load shifts')\n        }\n      }\n\n      loadShifts()\n    }\n  }, [selectedStation])\n\n  // Load assignments when shift changes\n  useEffect(() => {\n    if (selectedShift) {\n      const loadAssignments = async () => {\n        try {\n          setError('')\n          const res = await fetch(`/api/shifts/${selectedShift}/assignments`)\n\n          if (!res.ok) {\n            const errorData = await res.json().catch(() => ({}))\n            console.error('Failed to load assignments:', res.status, errorData)\n            setAssignments([])\n            return\n          }\n\n          const assignmentsData = await res.json()\n          console.log('Assignments API response:', assignmentsData)\n\n          // Ensure assignmentsData is an array\n          if (Array.isArray(assignmentsData)) {\n            // Transform assignments to include nozzle info if not present\n            const transformedAssignments = assignmentsData.map((assignment: Assignment) => ({\n              ...assignment,\n              // Extract nozzle info from API response structure\n              nozzle: assignment.nozzle || undefined\n            }))\n            setAssignments(transformedAssignments)\n\n            // Also update the shift in the shifts array with assignments so dropdown shows pumper names\n            setShifts(prevShifts =>\n              prevShifts.map(shift =>\n                shift.id === selectedShift\n                  ? { ...shift, assignments: transformedAssignments }\n                  : shift\n              )\n            )\n          } else {\n            console.error('Assignments data is not an array:', assignmentsData)\n            setAssignments([])\n          }\n        } catch (err) {\n          console.error('Error loading assignments:', err)\n          setError('Failed to load assignments')\n          setAssignments([])\n        }\n      }\n\n      loadAssignments()\n    } else {\n      setAssignments([])\n    }\n  }, [selectedShift])\n\n  // Calculate pumper-wise breakdown\n  useEffect(() => {\n    if (selectedShift && assignments.length > 0 && selectedStation) {\n      const calculatePumperBreakdown = async () => {\n        try {\n          // Get prices for fuel types\n          const fuelTypes = [...new Set(assignments.map(a => a.nozzle?.tank?.fuelId).filter(Boolean))]\n          const prices = await Promise.all(\n            fuelTypes.map(async (fuelType) => {\n              try {\n                const res = await fetch(`/api/prices?stationId=${selectedStation}&fuelId=${fuelType}`)\n                if (res.ok) {\n                  const priceData = await res.json()\n                  // API returns single price object when fuelType is specified\n                  if (priceData && !Array.isArray(priceData) && priceData.price) {\n                    return { fuelType, price: priceData.price }\n                  }\n                  // If array, get most recent active price\n                  if (Array.isArray(priceData) && priceData.length > 0) {\n                    const activePrices = priceData.filter((p: { isActive: boolean; effectiveDate: string }) => p.isActive)\n                      .sort((a: { effectiveDate: string }, b: { effectiveDate: string }) => new Date(b.effectiveDate).getTime() - new Date(a.effectiveDate).getTime())\n                    return { fuelType, price: activePrices[0]?.price || 470 }\n                  }\n                }\n              } catch (err) {\n                console.error(`Error fetching price for ${fuelType}:`, err)\n              }\n              return { fuelType, price: 470 }\n            })\n          )\n          const priceMap = Object.fromEntries(prices.map(p => [p.fuelType, p.price]))\n\n          // Group assignments by pumper\n          const pumperMap = new Map<string, Assignment[]>()\n          assignments.forEach(assignment => {\n            if (assignment.endMeterReading && assignment.pumperName) {\n              if (!pumperMap.has(assignment.pumperName)) {\n                pumperMap.set(assignment.pumperName, [])\n              }\n              pumperMap.get(assignment.pumperName)!.push(assignment)\n            }\n          })\n\n          // Calculate sales per pumper\n          const breakdowns: PumperBreakdown[] = []\n          pumperMap.forEach((pumperAssignments, pumperName) => {\n            let calculatedSales = 0\n\n            pumperAssignments.forEach(assignment => {\n              if (assignment.endMeterReading && assignment.startMeterReading) {\n                const delta = Math.max(0, assignment.endMeterReading - assignment.startMeterReading)\n                const canSales = assignment.canSales || 0\n                const pumpSales = assignment.pumpSales || Math.max(0, delta - canSales)\n                const fuelId = assignment.nozzle?.tank?.fuelId\n                const price = fuelId ? (priceMap[fuelId] || 470) : 470\n                calculatedSales += pumpSales * price\n              }\n            })\n\n            const cash = pumperDeclaredCash[pumperName] || 0\n            const creditAmounts = pumperDeclaredCreditAmounts[pumperName] || {}\n            const cheques = pumperDeclaredCheques[pumperName] || []\n            const cheque = cheques.reduce((sum, chq) => sum + chq.amount, 0)\n            const advance = pumperAdvances[pumperName] || 0\n            const expenses = pumperExpenses[pumperName] || []\n\n            // Separate bank deposits from other expenses\n            const bankDeposits = expenses.filter(exp => exp.type === 'BANK_DEPOSIT')\n            const otherExpenses = expenses.filter(exp => exp.type !== 'BANK_DEPOSIT')\n            const totalBankDeposits = bankDeposits.reduce((sum, exp) => sum + exp.amount, 0)\n            const totalOtherExpenses = otherExpenses.reduce((sum, exp) => sum + exp.amount, 0)\n\n            // Calculate card total from POS slips instead of manual entry\n            const pumperSlips = posSlips[pumperName] || []\n            const totalCardFromSlips = pumperSlips.reduce((sum, slip) => {\n              if (slip.terminalId && slip.amount > 0) {\n                return sum + slip.amount\n              }\n              return sum\n            }, 0)\n\n            // Include missing slips in card total (they represent transactions that happened but slip wasn't provided)\n            const key = `${pumperName}-unified`\n            const pumperMissingSlips = missingSlips[key] || []\n            const totalCardFromMissing = pumperMissingSlips.reduce((sum, slip) => {\n              if (slip.terminalId && slip.amount > 0 && slip.lastFourDigits.length === 4) {\n                return sum + slip.amount\n              }\n              return sum\n            }, 0)\n\n            // Total card amount = regular slips + missing slips\n            const totalCard = totalCardFromSlips + totalCardFromMissing\n\n            // Build card amounts map from slips for compatibility (include missing slips)\n            const cardAmounts: Record<string, number> = {}\n            pumperSlips.forEach(slip => {\n              if (slip.terminalId && slip.amount > 0) {\n                cardAmounts[slip.terminalId] = (cardAmounts[slip.terminalId] || 0) + slip.amount\n              }\n            })\n            // Add missing slips to card amounts map\n            pumperMissingSlips.forEach(slip => {\n              if (slip.terminalId && slip.amount > 0 && slip.lastFourDigits.length === 4) {\n                cardAmounts[slip.terminalId] = (cardAmounts[slip.terminalId] || 0) + slip.amount\n              }\n            })\n            const totalCredit = Object.values(creditAmounts).reduce((sum, amount) => sum + amount, 0)\n\n            // CORRECT LOGIC:\n            // - Cash declared = FULL cash amount they received from sales (NOT already deducted)\n            // - Advance is money taken FROM the cash declared (will be deducted from salary later, NOT from variance)\n            // - Advance can ONLY come from cash, not from card/credit/cheque\n            // - Bank deposits are cash that was deposited to bank (included in declared amount)\n            // \n            // MATHEMATICAL LOGIC:\n            // Cash Declared = Full cash received from sales (e.g., Rs. 20,100)\n            // Advance Taken = Amount taken from cash (e.g., Rs. 10,000) - NOT part of variance!\n            // Bank Deposits = Amount deposited from cash (e.g., Rs. 0) - included in declared\n            // \n            // Example: \n            //   - Cash declared = Rs. 20,100 (FULL amount received)\n            //   - Advance taken = Rs. 10,000 (taken from cash, will be deducted from salary)\n            //   - Bank deposits = Rs. 0 (cash that was deposited, included in declared)\n            //   - Cash actually handed over = 20,100 - 10,000 - 0 = Rs. 10,100\n            // \n            // Total Declared Amount = Cash Declared + Card + Credit + Cheque + Bank Deposits\n            //                       = Cash + Card + Credit + Cheque + Bank Deposits\n            // \n            // IMPORTANT: Advance is NOT deducted from variance calculation!\n            // Variance = Calculated Sales - (Total Declared - Other Expenses)\n            //          = Calculated Sales - (Cash + Card + Credit + Cheque + Bank Deposits - Other Expenses)\n            // \n            // Why? Advance is not a variance - it's money the pumper took and will be deducted from salary.\n            // Variance only measures if they're declaring the correct amount vs calculated sales.\n            // \n            // Effective Declared (for variance) = Total Declared - Other Expenses (loans, etc.)\n            //                                    = Cash + Card + Credit + Cheque + Bank Deposits - Other Expenses\n            //                                    (Advance is NOT included - it's handled separately in salary)\n            const declaredAmount = cash + totalCard + totalCredit + cheque + totalBankDeposits\n\n            // Effective declared for variance calculation - does NOT include advance\n            // Advance will be deducted from salary separately, not from variance\n            // Other expenses (loans, etc.) reduce the effective declared amount\n            // Bank deposits are already included in declared amount (they're cash that was deposited)\n            const effectiveDeclaredAmount = declaredAmount - totalOtherExpenses\n            const variance = calculatedSales - effectiveDeclaredAmount\n\n            // Variance logic: If |variance| > 20, add/deduct FULL variance amount\n            // If |variance| <= 20, ignore (NORMAL - no adjustment)\n            // If variance > 20: sales > effective declared (SHORTAGE)  DEDUCT FULL variance from salary\n            // If variance < -20: effective declared > sales (SURPLUS)  ADD FULL variance to salary\n            const varianceStatus = Math.abs(variance) > 20\n              ? (variance > 20 ? 'DEDUCT_FROM_SALARY' : 'ADD_TO_SALARY')\n              : 'NORMAL'\n\n            breakdowns.push({\n              pumperName,\n              calculatedSales,\n              declaredAmount,\n              declaredCash: cash,\n              declaredCardAmounts: cardAmounts,\n              declaredCreditAmounts: creditAmounts,\n              declaredCheque: cheque,\n              cheques: cheques,\n              advanceTaken: advance,\n              expenses: expenses,\n              totalExpenses: totalBankDeposits + totalOtherExpenses, // Total for display\n              variance,\n              varianceStatus,\n              assignments: pumperAssignments\n            })\n          })\n\n          setPumperBreakdowns(breakdowns.sort((a, b) => a.pumperName.localeCompare(b.pumperName)))\n        } catch (err) {\n          console.error('Failed to calculate pumper breakdown:', err)\n        }\n      }\n\n      calculatePumperBreakdown()\n    } else {\n      setPumperBreakdowns([])\n    }\n  }, [selectedShift, assignments, selectedStation, pumperDeclaredCash, pumperDeclaredCardAmounts, pumperDeclaredCreditAmounts, pumperDeclaredCheques, pumperAdvances, otherPumperAdvances, pumperExpenses, posSlips, missingSlips])\n\n  // Calculate tender summary from pumper-wise data\n  useEffect(() => {\n    if (selectedShift && assignments.length > 0 && pumperBreakdowns.length > 0) {\n      const calculateSummary = async () => {\n        try {\n          // Aggregate totals from pumper-wise breakdown\n          const totalCash = pumperBreakdowns.reduce((sum, b) => sum + b.declaredCash, 0)\n          const totalCard = pumperBreakdowns.reduce((sum: number, b: PumperBreakdown) => {\n            const amounts = Object.values(b.declaredCardAmounts) as number[]\n            return sum + amounts.reduce((cardSum: number, amount: number) => cardSum + amount, 0)\n          }, 0)\n          const totalCredit = pumperBreakdowns.reduce((sum: number, b: PumperBreakdown) => {\n            const amounts = Object.values(b.declaredCreditAmounts) as number[]\n            return sum + amounts.reduce((creditSum: number, amount: number) => creditSum + amount, 0)\n          }, 0)\n          const totalCheque = pumperBreakdowns.reduce((sum, b) => sum + b.declaredCheque, 0)\n          const totalDeclared = totalCash + totalCard + totalCredit + totalCheque\n\n          // Prepare assignments with all required data for API calculation\n          const assignmentsForApi = assignments.map((assignment) => ({\n            id: assignment.id,\n            nozzleId: assignment.nozzleId,\n            startMeterReading: assignment.startMeterReading,\n            endMeterReading: assignment.endMeterReading,\n            canSales: assignment.canSales || 0,\n            pumpSales: assignment.pumpSales || 0,\n            fuelType: assignment.nozzle?.tank?.fuel?.name || null\n          }))\n\n          const assignmentsParam = encodeURIComponent(JSON.stringify(assignmentsForApi))\n          const res = await fetch(\n            `/api/tenders/shift/${selectedShift}?cashAmount=${totalCash}&cardAmount=${totalCard}&creditAmount=${totalCredit}&chequeAmount=${totalCheque}&assignments=${assignmentsParam}`\n          )\n\n          if (!res.ok) {\n            const errorData = await res.json().catch(() => ({ error: 'Unknown error' }))\n            console.error('Failed to fetch summary:', res.status, errorData)\n            return\n          }\n\n          const summary = await res.json()\n          setTenderSummary(summary)\n        } catch (err) {\n          console.error('Failed to calculate summary:', err)\n        }\n      }\n\n      const timeoutId = setTimeout(calculateSummary, 100)\n      return () => clearTimeout(timeoutId)\n    } else {\n      setTenderSummary(null)\n    }\n  }, [selectedShift, assignments, pumperBreakdowns])\n\n  const handleUpdateAssignment = (assignmentId: string | number, field: 'endMeterReading' | 'canSales', value: number) => {\n    setAssignments(prev =>\n      prev.map(assignment => {\n        if (assignment.id === assignmentId) {\n          const updated = { ...assignment, [field]: value }\n\n          // Calculate pump sales when meter reading or can sales change\n          if (field === 'endMeterReading' || field === 'canSales') {\n            const meterDelta = (updated.endMeterReading || 0) - updated.startMeterReading\n            const canSales = updated.canSales || 0\n            updated.pumpSales = Math.max(0, meterDelta - canSales)\n          }\n\n          return updated\n        }\n        return assignment\n      })\n    )\n    // Trigger summary recalculation immediately when assignments change\n    // This ensures the sales amount is updated as soon as meter readings change\n  }\n\n\n  const handleUpdatePumperCash = (pumperName: string, amount: number) => {\n    setPumperDeclaredCash(prev => ({ ...prev, [pumperName]: amount }))\n  }\n\n\n\n  const handleAddPumperCreditRow = (pumperName: string, customerId: string) => {\n    setPumperDeclaredCreditAmounts(prev => ({\n      ...prev,\n      [pumperName]: {\n        ...(prev[pumperName] || {}),\n        [customerId]: 0\n      }\n    }))\n  }\n\n  const handleRemovePumperCreditRow = (pumperName: string, customerId: string) => {\n    setPumperDeclaredCreditAmounts(prev => {\n      const newAmounts = { ...prev }\n      if (newAmounts[pumperName]) {\n        const updated = { ...newAmounts[pumperName] }\n        delete updated[customerId]\n        newAmounts[pumperName] = updated\n      }\n      return newAmounts\n    })\n  }\n\n  const handleUpdatePumperCreditAmount = (pumperName: string, customerId: string, amount: number) => {\n    setPumperDeclaredCreditAmounts(prev => ({\n      ...prev,\n      [pumperName]: {\n        ...(prev[pumperName] || {}),\n        [customerId]: amount\n      }\n    }))\n  }\n\n  const handleAddPumperCheque = (pumperName: string) => {\n    const newCheque: PumperCheque = {\n      id: `cheque-${Date.now()}-${Math.random()}`,\n      chequeNumber: '',\n      amount: 0,\n      receivedFrom: ''\n    }\n    setPumperDeclaredCheques(prev => ({\n      ...prev,\n      [pumperName]: [...(prev[pumperName] || []), newCheque]\n    }))\n  }\n\n  const handleRemovePumperCheque = (pumperName: string, chequeId: string) => {\n    setPumperDeclaredCheques(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).filter(chq => chq.id !== chequeId)\n    }))\n  }\n\n  const handleUpdatePumperCheque = (pumperName: string, chequeId: string, field: keyof PumperCheque, value: string | number) => {\n    setPumperDeclaredCheques(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).map(chq =>\n        chq.id === chequeId ? { ...chq, [field]: value } : chq\n      )\n    }))\n  }\n\n  const handleUpdatePumperAdvance = (pumperName: string, amount: number) => {\n    // Find pumper ID\n    const pumper = pumpers.find(p => p.name === pumperName)\n    const pumperId = pumper?.id\n\n    // Check advance limit: monthly rental + advance cannot exceed 50,000\n    const ADVANCE_LIMIT = 50000\n    const monthlyRental = pumperId ? (pumperMonthlyRentals[pumperId] || 0) : 0\n    const availableAdvanceLimit = ADVANCE_LIMIT - monthlyRental\n\n    if (amount > availableAdvanceLimit) {\n      setError(`Advance limit exceeded for ${pumperName}! Monthly loan rental: Rs. ${monthlyRental.toLocaleString()}, Available advance limit: Rs. ${availableAdvanceLimit.toLocaleString()}. Total (rental + advance) cannot exceed Rs. ${ADVANCE_LIMIT.toLocaleString()}.`)\n      setTimeout(() => setError(''), 7000)\n      return\n    }\n\n    // Validate: Total advances (taken + given) cannot exceed cash declared\n    const currentCash = pumperDeclaredCash[pumperName] || 0\n    const otherAdvances = otherPumperAdvances[pumperName] || []\n    const otherAdvancesTotal = otherAdvances.reduce((sum, a) => sum + a.amount, 0)\n    const totalAdvances = amount + otherAdvancesTotal\n\n    if (totalAdvances > currentCash && currentCash > 0) {\n      setError(`Total advances (taken: Rs. ${amount.toLocaleString()} + given: Rs. ${otherAdvancesTotal.toLocaleString()}) cannot exceed cash declared (Rs. ${currentCash.toLocaleString()}). Advances can only come from cash.`)\n      setTimeout(() => setError(''), 5000)\n      return\n    }\n    setPumperAdvances(prev => ({ ...prev, [pumperName]: amount }))\n  }\n\n  // Handle adding/updating advance for other pumpers (not assigned to shift) - per pumper\n  const handleAddOtherPumperAdvance = (pumperName: string) => {\n    setOtherPumperAdvances(prev => ({\n      ...prev,\n      [pumperName]: [...(prev[pumperName] || []), { pumperId: '', pumperName: '', amount: 0 }]\n    }))\n  }\n\n  const handleUpdateOtherPumperAdvance = (pumperName: string, index: number, field: 'pumperId' | 'pumperName' | 'amount', value: string | number) => {\n    setOtherPumperAdvances(prev => {\n      const advances = [...(prev[pumperName] || [])]\n      if (field === 'pumperId') {\n        // When pumper is selected, update both id and name\n        // value is the pumper name (from pumperBreakdowns)\n        const selectedPumperName = value as string\n        advances[index] = { ...advances[index], pumperId: selectedPumperName, pumperName: selectedPumperName }\n      } else if (field === 'amount') {\n        // Find the receiving pumper ID to check their advance limit\n        const receivingPumperName = advances[index].pumperName\n        const receivingPumper = pumpers.find(p => p.name === receivingPumperName)\n        const receivingPumperId = receivingPumper?.id\n\n        // Check advance limit for receiving pumper: monthly rental + advance cannot exceed 50,000\n        const ADVANCE_LIMIT = 50000\n        const monthlyRental = receivingPumperId ? (pumperMonthlyRentals[receivingPumperId] || 0) : 0\n        const availableAdvanceLimit = ADVANCE_LIMIT - monthlyRental\n        const newAmount = value as number\n\n        if (newAmount > availableAdvanceLimit) {\n          setError(`Advance limit exceeded for ${receivingPumperName}! Monthly loan rental: Rs. ${monthlyRental.toLocaleString()}, Available advance limit: Rs. ${availableAdvanceLimit.toLocaleString()}. Total (rental + advance) cannot exceed Rs. ${ADVANCE_LIMIT.toLocaleString()}.`)\n          setTimeout(() => setError(''), 7000)\n          return prev // Don't update if validation fails\n        }\n\n        // Validate: Total advances (taken + given) cannot exceed cash declared\n        const currentCash = pumperDeclaredCash[pumperName] || 0\n        const advanceTaken = pumperAdvances[pumperName] || 0\n        const otherAdvancesTotal = advances.reduce((sum, a, i) => i !== index ? sum + a.amount : sum, 0)\n        const totalAdvances = advanceTaken + otherAdvancesTotal + newAmount\n\n        if (totalAdvances > currentCash && currentCash > 0) {\n          setError(`Total advances (taken: Rs. ${advanceTaken.toLocaleString()} + given: Rs. ${(otherAdvancesTotal + newAmount).toLocaleString()}) cannot exceed cash declared (Rs. ${currentCash.toLocaleString()}). Advances can only come from cash.`)\n          setTimeout(() => setError(''), 5000)\n          return prev // Don't update if validation fails\n        }\n\n        advances[index] = { ...advances[index], [field]: newAmount }\n      } else {\n        advances[index] = { ...advances[index], [field]: value as string }\n      }\n\n      return {\n        ...prev,\n        [pumperName]: advances\n      }\n    })\n  }\n\n  const handleRemoveOtherPumperAdvance = (pumperName: string, index: number) => {\n    setOtherPumperAdvances(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).filter((_, i) => i !== index)\n    }))\n  }\n\n  // POS Terminal Verification Handlers\n  // Check if a card was already used on the same day with SAME card type AND terminal\n  const checkDuplicateCard = (pumperName: string, lastFourDigits: string, cardType: string, terminalId: string, slipIdToExclude?: string): boolean => {\n    const today = new Date()\n    today.setHours(0, 0, 0, 0)\n\n    const slips = posSlips[pumperName] || []\n    return slips.some(slip => {\n      if (slip.id === slipIdToExclude) return false\n      const slipDate = new Date(slip.timestamp)\n      slipDate.setHours(0, 0, 0, 0)\n\n      // Check for duplicate: same last 4 digits + same card type + same terminal + same day\n      return slip.lastFourDigits === lastFourDigits\n        && slip.cardType === cardType\n        && slip.terminalId === terminalId\n        && slipDate.getTime() === today.getTime()\n    })\n  }\n\n  // Get duplicate card details (returns the existing slip if duplicate found)\n  const getDuplicateCardDetails = (pumperName: string, lastFourDigits: string, cardType: string, terminalId: string, slipIdToExclude?: string): POSSlipEntry | null => {\n    const today = new Date()\n    today.setHours(0, 0, 0, 0)\n\n    const slips = posSlips[pumperName] || []\n    const duplicate = slips.find(slip => {\n      if (slip.id === slipIdToExclude) return false\n      const slipDate = new Date(slip.timestamp)\n      slipDate.setHours(0, 0, 0, 0)\n\n      // Check for duplicate: same last 4 digits + same card type + same terminal + same day\n      return slip.lastFourDigits === lastFourDigits\n        && slip.cardType === cardType\n        && slip.terminalId === terminalId\n        && slipDate.getTime() === today.getTime()\n    })\n\n    return duplicate || null\n  }\n\n  // Check if POS slip has all required fields filled\n  const isPOSSlipComplete = (slip: POSSlipEntry): boolean => {\n    return !!(\n      slip.terminalId &&\n      slip.lastFourDigits &&\n      slip.lastFourDigits.length === 4 &&\n      slip.cardType &&\n      slip.amount > 0 &&\n      slip.timestamp\n    )\n  }\n\n  // Check if Missing slip has all required fields filled\n  const isMissingSlipComplete = (slip: MissingSlipEntry): boolean => {\n    return !!(\n      slip.terminalId &&\n      slip.lastFourDigits &&\n      slip.lastFourDigits.length === 4 &&\n      slip.amount > 0 &&\n      slip.timestamp\n    )\n  }\n\n  const handleMinimizePOSSlip = (slipId: string) => {\n    setMinimizedPOSSlips(prev => ({\n      ...prev,\n      [slipId]: true\n    }))\n  }\n\n  const handleExpandPOSSlip = (slipId: string) => {\n    setMinimizedPOSSlips(prev => ({\n      ...prev,\n      [slipId]: false\n    }))\n  }\n\n  const handleMinimizeMissingSlip = (slipId: string) => {\n    setMinimizedMissingSlips(prev => ({\n      ...prev,\n      [slipId]: true\n    }))\n  }\n\n  const handleExpandMissingSlip = (slipId: string) => {\n    setMinimizedMissingSlips(prev => ({\n      ...prev,\n      [slipId]: false\n    }))\n  }\n\n  const handleAddPOSSlip = (pumperName: string) => {\n    const newSlip: POSSlipEntry = {\n      id: `slip-${Date.now()}-${Math.random()}`,\n      terminalId: '',\n      amount: 0,\n      lastFourDigits: '',\n      cardType: 'VISA',\n      timestamp: new Date(),\n      notes: ''\n    }\n    setPosSlips(prev => ({\n      ...prev,\n      [pumperName]: [...(prev[pumperName] || []), newSlip]\n    }))\n    // New slips start expanded (not minimized)\n    setMinimizedPOSSlips(prev => ({\n      ...prev,\n      [newSlip.id]: false\n    }))\n  }\n\n  const handleUpdatePOSSlip = (pumperName: string, slipId: string, field: keyof POSSlipEntry, value: string | number | Date) => {\n    // Get current slip to check against\n    const currentSlips = posSlips[pumperName] || []\n    const currentSlip = currentSlips.find(s => s.id === slipId)\n\n    // Update the slip first to get the new values\n    const updatedSlips = currentSlips.map(slip =>\n      slip.id === slipId ? { ...slip, [field]: value } : slip\n    )\n    const updatedSlip = updatedSlips.find(s => s.id === slipId)!\n\n    // Check for duplicate card if updating lastFourDigits, cardType, or terminalId\n    // Only check if we have all required fields (last4, cardType, terminalId)\n    if ((field === 'lastFourDigits' || field === 'cardType' || field === 'terminalId')\n      && updatedSlip.lastFourDigits\n      && updatedSlip.lastFourDigits.length === 4\n      && updatedSlip.cardType\n      && updatedSlip.terminalId) {\n\n      const duplicateSlip = getDuplicateCardDetails(\n        pumperName,\n        updatedSlip.lastFourDigits,\n        updatedSlip.cardType,\n        updatedSlip.terminalId,\n        slipId\n      )\n\n      if (duplicateSlip) {\n        // Show error with details about the duplicate slip\n        setDuplicateCardErrors(prev => ({\n          ...prev,\n          [slipId]: {\n            cardNumber: updatedSlip.lastFourDigits,\n            duplicateSlip\n          }\n        }))\n\n        // Also show a global error message\n        const terminal = posTerminals.find(t => t.id === duplicateSlip.terminalId)\n        const duplicateTime = new Date(duplicateSlip.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })\n        setError(` FRAUD ALERT: Card ending in ${updatedSlip.lastFourDigits} (${updatedSlip.cardType}) was already added today at ${duplicateTime} for Rs. ${duplicateSlip.amount.toLocaleString()} on ${terminal?.name || 'same terminal'}. The same card with same type cannot be used twice on the same terminal in the same day!`)\n        setTimeout(() => setError(''), 8000)\n      } else {\n        // Clear error if card number is valid\n        setDuplicateCardErrors(prev => {\n          const newErrors = { ...prev }\n          delete newErrors[slipId]\n          return newErrors\n        })\n      }\n    } else if (field === 'lastFourDigits' || field === 'cardType' || field === 'terminalId') {\n      // Clear error if required fields are not complete yet\n      setDuplicateCardErrors(prev => {\n        const newErrors = { ...prev }\n        delete newErrors[slipId]\n        return newErrors\n      })\n    }\n\n    // Apply the update\n    setPosSlips(prev => ({\n      ...prev,\n      [pumperName]: updatedSlips\n    }))\n  }\n\n  const handleRemovePOSSlip = (pumperName: string, slipId: string) => {\n    setPosSlips(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).filter(slip => slip.id !== slipId)\n    }))\n    // Clear any duplicate card errors for this slip\n    setDuplicateCardErrors(prev => {\n      const newErrors = { ...prev }\n      delete newErrors[slipId]\n      return newErrors\n    })\n    // Clear minimized state\n    setMinimizedPOSSlips(prev => {\n      const newState = { ...prev }\n      delete newState[slipId]\n      return newState\n    })\n    // Re-check all remaining slips for duplicates after removing this one\n    const remainingSlips = posSlips[pumperName]?.filter(slip => slip.id !== slipId) || []\n    remainingSlips.forEach(slip => {\n      if (slip.lastFourDigits && slip.lastFourDigits.length === 4 && slip.cardType && slip.terminalId) {\n        const duplicateSlip = getDuplicateCardDetails(pumperName, slip.lastFourDigits, slip.cardType, slip.terminalId, slip.id)\n        if (duplicateSlip) {\n          setDuplicateCardErrors(prev => ({\n            ...prev,\n            [slip.id]: {\n              cardNumber: slip.lastFourDigits,\n              duplicateSlip\n            }\n          }))\n        } else {\n          setDuplicateCardErrors(prev => {\n            const newErrors = { ...prev }\n            delete newErrors[slip.id]\n            return newErrors\n          })\n        }\n      }\n    })\n  }\n\n  const togglePOSVerification = (pumperName: string) => {\n    setPosVerificationOpen(prev => ({\n      ...prev,\n      [pumperName]: !prev[pumperName]\n    }))\n  }\n\n  const handleAddMissingSlip = (pumperName: string, defaultTerminalId: string = '') => {\n    // Use a unified key for all missing slips per pumper (not per terminal)\n    const key = `${pumperName}-unified`\n    const newSlip: MissingSlipEntry = {\n      id: `missing-slip-${Date.now()}-${Math.random()}`,\n      terminalId: defaultTerminalId,\n      amount: 0,\n      lastFourDigits: '',\n      timestamp: new Date(),\n      notes: ''\n    }\n    setMissingSlips(prev => ({\n      ...prev,\n      [key]: [...(prev[key] || []), newSlip]\n    }))\n    // New slips start expanded\n    setMinimizedMissingSlips(prev => ({\n      ...prev,\n      [newSlip.id]: false\n    }))\n  }\n\n  const handleRemoveMissingSlip = (pumperName: string, terminalId: string, slipId: string) => {\n    // Use unified key for all missing slips per pumper\n    const key = `${pumperName}-unified`\n    setMissingSlips(prev => ({\n      ...prev,\n      [key]: (prev[key] || []).filter(slip => slip.id !== slipId)\n    }))\n    // Clear minimized state\n    setMinimizedMissingSlips(prev => {\n      const newState = { ...prev }\n      delete newState[slipId]\n      return newState\n    })\n  }\n\n  const handleUpdateMissingSlip = (pumperName: string, terminalId: string, slipId: string, field: keyof MissingSlipEntry, value: string | number | Date) => {\n    // Use unified key for all missing slips per pumper\n    const key = `${pumperName}-unified`\n    setMissingSlips(prev => ({\n      ...prev,\n      [key]: (prev[key] || []).map(slip =>\n        slip.id === slipId ? { ...slip, [field]: value } : slip\n      )\n    }))\n  }\n\n  const handleAddPumperExpense = async (pumperName: string, type: 'BANK_DEPOSIT' | 'LOAN_GIVEN' | 'OTHER') => {\n    // Auto-fill loan given by with current user\n    let loanGivenBy = ''\n    if (type === 'LOAN_GIVEN') {\n      try {\n        loanGivenBy = await getCurrentUserName()\n      } catch (err) {\n        loanGivenBy = 'Manager'\n      }\n    }\n\n    const newExpense: PumperExpense = {\n      id: `${Date.now()}-${Math.random()}`,\n      type,\n      amount: 0,\n      description: type === 'OTHER' ? '' : undefined,\n      bankId: type === 'BANK_DEPOSIT' ? '' : undefined,\n      bankName: type === 'BANK_DEPOSIT' ? '' : undefined,\n      accountNumber: type === 'BANK_DEPOSIT' ? '' : undefined,\n      depositedBy: type === 'BANK_DEPOSIT' ? '' : undefined,\n      loanGivenTo: type === 'LOAN_GIVEN' ? '' : undefined,\n      loanGivenBy: type === 'LOAN_GIVEN' ? loanGivenBy : undefined\n    }\n    setPumperExpenses(prev => ({\n      ...prev,\n      [pumperName]: [...(prev[pumperName] || []), newExpense]\n    }))\n  }\n\n  const handleRemovePumperExpense = (pumperName: string, expenseId: string) => {\n    setPumperExpenses(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).filter(exp => exp.id !== expenseId)\n    }))\n  }\n\n  const handleUpdatePumperExpense = (pumperName: string, expenseId: string, field: keyof PumperExpense, value: number | string) => {\n    setPumperExpenses(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).map(exp =>\n        exp.id === expenseId\n          ? { ...exp, [field]: value }\n          : exp\n      )\n    }))\n  }\n\n  // Add Bank Handler\n  const handleAddBank = async () => {\n    if (!newBank.name.trim()) {\n      setError('Bank name is required')\n      return\n    }\n\n    try {\n      const response = await fetch('/api/banks', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          name: newBank.name.trim(),\n          branch: newBank.branch?.trim() || null,\n          accountNumber: newBank.accountNumber?.trim() || null\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        throw new Error(errorData.error || 'Failed to add bank')\n      }\n\n      const addedBank = await response.json()\n      setBanks([...banks, addedBank])\n      setNewBank({ name: '', branch: '', accountNumber: '' })\n      setAddBankDialogOpen(false)\n      setSuccess(`Bank \"${addedBank.name}\" added successfully! You can now select it from the dropdown.`)\n      setTimeout(() => setSuccess(''), 5000)\n    } catch (err) {\n      console.error('Error adding bank:', err)\n      setError(err instanceof Error ? err.message : 'Failed to add bank. Please try again.')\n      setTimeout(() => setError(''), 5000)\n    }\n  }\n\n  // Test Pour Handlers\n  const handleAddPumperTestPour = (pumperName: string) => {\n    const newTestPour: PumperTestPour = {\n      id: `testpour-${Date.now()}-${Math.random()}`,\n      nozzleId: '',\n      amount: 0,\n      reason: '',\n      returned: true\n    }\n    setPumperTestPours(prev => ({\n      ...prev,\n      [pumperName]: [...(prev[pumperName] || []), newTestPour]\n    }))\n  }\n\n  const handleRemovePumperTestPour = (pumperName: string, testPourId: string) => {\n    setPumperTestPours(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).filter(tp => tp.id !== testPourId)\n    }))\n  }\n\n  const handleUpdatePumperTestPour = (pumperName: string, testPourId: string, field: keyof PumperTestPour, value: string | number | boolean | undefined) => {\n    setPumperTestPours(prev => ({\n      ...prev,\n      [pumperName]: (prev[pumperName] || []).map(tp => {\n        if (tp.id === testPourId) {\n          const updated = { ...tp, [field]: value }\n          // If nozzle changed, update nozzle info\n          if (field === 'nozzleId' && value) {\n            const selectedNozzle = nozzles.find(n => n.id === value)\n            if (selectedNozzle) {\n              updated.nozzleNumber = selectedNozzle.nozzleNumber\n              updated.pumpNumber = selectedNozzle.pumpNumber\n              updated.fuelType = selectedNozzle.fuelType\n            }\n          }\n          return updated\n        }\n        return tp\n      })\n    }))\n  }\n\n  const handleCloseShiftAndPrint = async () => {\n    if (!selectedShift) {\n      setError('Please select a shift to close')\n      return\n    }\n\n    if (!Array.isArray(assignments) || assignments.length === 0) {\n      setError('No assignments found. Cannot close shift without assignments.')\n      return\n    }\n\n    // Validate all assignments have end meter readings\n    const incompleteAssignments = assignments.filter(a => !a.endMeterReading || a.endMeterReading === null)\n    if (incompleteAssignments.length > 0) {\n      setError(`Please fill in all end meter readings. ${incompleteAssignments.length} assignment(s) missing end readings.`)\n      return\n    }\n\n    // Validate end meter readings are >= start readings\n    const invalidReadings = assignments.filter(a =>\n      a.endMeterReading !== null &&\n      a.endMeterReading !== undefined &&\n      a.startMeterReading !== null &&\n      a.startMeterReading !== undefined &&\n      a.endMeterReading < a.startMeterReading\n    )\n    if (invalidReadings.length > 0) {\n      setError(`Invalid meter readings detected. End reading must be greater than or equal to start reading.`)\n      return\n    }\n\n    // Validate end time is after start time\n    if (!endTime) {\n      setError('Please select an end time')\n      return\n    }\n\n    // Validate pumper-wise data exists\n    if (pumperBreakdowns.length === 0) {\n      setError('Please enter declared amounts for at least one pumper.')\n      return\n    }\n\n    // Aggregate totals from pumper-wise breakdown\n    const totalCash = pumperBreakdowns.reduce((sum, b) => sum + b.declaredCash, 0)\n    const totalCard = pumperBreakdowns.reduce((sum, b) =>\n      sum + Object.values(b.declaredCardAmounts).reduce((cardSum, amount) => cardSum + amount, 0), 0\n    )\n    const totalCredit = pumperBreakdowns.reduce((sum, b) =>\n      sum + Object.values(b.declaredCreditAmounts).reduce((creditSum, amount) => creditSum + amount, 0), 0\n    )\n    const totalCheque = pumperBreakdowns.reduce((sum, b) => sum + b.declaredCheque, 0)\n\n    // Validate credit limits for all customers across all pumpers\n    if (totalCredit > 0) {\n      for (const breakdown of pumperBreakdowns) {\n        for (const [customerId, amount] of Object.entries(breakdown.declaredCreditAmounts)) {\n          if (amount > 0) {\n            const customer = creditCustomers.find(c => c.id === customerId)\n            if (customer) {\n              const availableCredit = customer.creditLimit - customer.currentBalance\n              if (amount > availableCredit) {\n                setError(`Credit amount for ${customer.name} (Rs. ${amount.toLocaleString()}) exceeds available credit (Rs. ${availableCredit.toLocaleString()})`)\n                return\n              }\n            }\n          }\n        }\n      }\n    }\n\n    // Validate POS terminal verification for all terminals with card amounts\n    if (totalCard > 0) {\n      const terminalsWithAmounts = new Set<string>()\n      pumperBreakdowns.forEach(breakdown => {\n        Object.keys(breakdown.declaredCardAmounts).forEach(terminalId => {\n          if (breakdown.declaredCardAmounts[terminalId] > 0) {\n            terminalsWithAmounts.add(terminalId)\n          }\n        })\n      })\n\n      // Validate that slips are added for terminals with card amounts\n      // We'll check if the totals match - this is done per pumper now\n      // The validation will be done when we calculate totals\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      // Use the selected end time, or current time if not set\n      const finalEndTime = endTime || new Date()\n\n      // Aggregate totals from pumper-wise breakdown\n      const totalCash = pumperBreakdowns.reduce((sum, b) => sum + b.declaredCash, 0)\n      const totalCard = pumperBreakdowns.reduce((sum, b) =>\n        sum + Object.values(b.declaredCardAmounts).reduce((cardSum, amount) => cardSum + amount, 0), 0\n      )\n      const totalCredit = pumperBreakdowns.reduce((sum, b) =>\n        sum + Object.values(b.declaredCreditAmounts).reduce((creditSum, amount) => creditSum + amount, 0), 0\n      )\n      const totalCheque = pumperBreakdowns.reduce((sum, b) => sum + b.declaredCheque, 0)\n\n      console.log('Closing shift:', selectedShift)\n      console.log('Assignments to close:', assignments)\n\n      // Update assignments with end meter readings\n      for (const assignment of assignments) {\n        console.log('Closing assignment:', assignment.id, 'with end reading:', assignment.endMeterReading)\n        const res = await fetch(`/api/shifts/${selectedShift}/assignments/${assignment.id}/close`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            endMeterReading: assignment.endMeterReading,\n            endTime: finalEndTime.toISOString()\n          })\n        })\n\n        if (!res.ok) {\n          const error = await res.json()\n          throw new Error(`Failed to close assignment ${assignment.id}: ${error.error}`)\n        }\n\n        const result = await res.json()\n        console.log('Assignment closed successfully:', result)\n      }\n\n      // Close shift\n      console.log('Closing shift:', selectedShift)\n\n      // Ensure end time is after start time\n      // Get shift data to check start time\n      const shiftResponse = await fetch(`/api/shifts/${selectedShift}`)\n      const shiftData = await shiftResponse.json()\n      const shiftStartTime = new Date(shiftData.startTime)\n      const validatedEndTime = finalEndTime > shiftStartTime ? finalEndTime : new Date()\n\n      console.log(' FRONTEND DEBUG:')\n      console.log('  Shift start time:', shiftStartTime)\n      console.log('  Selected end time:', finalEndTime)\n      console.log('  Validated end time:', validatedEndTime)\n      console.log('  Final end time ISO:', validatedEndTime.toISOString())\n\n      // Prepare pumper-wise breakdown data to save\n      // Map terminal IDs to names and customer IDs to names for better display\n      const terminalIdToName = new Map(posTerminals.map(t => [t.id, `${t.name} (${t.terminalNumber})`]))\n      const customerIdToName = new Map(creditCustomers.map(c => [c.id, c.name]))\n\n      const pumperBreakdownData = pumperBreakdowns.map(breakdown => {\n        // Convert terminal IDs to terminal names in card amounts\n        const cardAmountsWithNames: Record<string, { amount: number; terminalName: string }> = {}\n        Object.entries(breakdown.declaredCardAmounts).forEach(([terminalId, amount]) => {\n          cardAmountsWithNames[terminalId] = {\n            amount,\n            terminalName: terminalIdToName.get(terminalId) || `Terminal ${terminalId}`\n          }\n        })\n\n        // Convert customer IDs to customer names in credit amounts\n        const creditAmountsWithNames: Record<string, { amount: number; customerName: string }> = {}\n        Object.entries(breakdown.declaredCreditAmounts).forEach(([customerId, amount]) => {\n          creditAmountsWithNames[customerId] = {\n            amount,\n            customerName: customerIdToName.get(customerId) || `Customer ${customerId}`\n          }\n        })\n\n        return {\n          pumperName: breakdown.pumperName,\n          calculatedSales: breakdown.calculatedSales,\n          declaredAmount: breakdown.declaredAmount,\n          declaredCash: breakdown.declaredCash,\n          declaredCardAmounts: breakdown.declaredCardAmounts, // Keep original for calculations\n          declaredCardAmountsWithNames: cardAmountsWithNames, // Add names for display\n          declaredCreditAmounts: breakdown.declaredCreditAmounts, // Keep original for calculations\n          declaredCreditAmountsWithNames: creditAmountsWithNames, // Add names for display\n          declaredCheque: breakdown.declaredCheque,\n          cheques: breakdown.cheques,\n          advanceTaken: breakdown.advanceTaken,\n          otherPumperAdvances: otherPumperAdvances[breakdown.pumperName] || [], // Include other pumper advances for this pumper\n          expenses: breakdown.expenses,\n          variance: breakdown.variance,\n          varianceStatus: breakdown.varianceStatus\n        }\n      })\n\n      const shiftRes = await fetch(`/api/shifts/${selectedShift}/close`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          endTime: validatedEndTime.toISOString(),\n          closedBy: getCurrentUserName(),\n          cashAmount: totalCash,\n          cardAmount: totalCard,\n          creditAmount: totalCredit,\n          chequeAmount: totalCheque,\n          pumperBreakdown: pumperBreakdownData, // Send pumper-wise breakdown\n          otherPumperAdvances: Object.entries(otherPumperAdvances).reduce((acc, [pumperName, advances]) => {\n            const validAdvances = advances.filter(a => a.pumperId && a.amount > 0)\n            if (validAdvances.length > 0) {\n              acc[pumperName] = validAdvances\n            }\n            return acc\n          }, {} as Record<string, Array<{ pumperId: string; pumperName: string; amount: number }>>) // Send other pumper advances per pumper\n        })\n      })\n\n      if (!shiftRes.ok) {\n        const errorData = await shiftRes.json().catch(() => ({}))\n        const errorMessage = errorData.error || errorData.message || `Failed to close shift (${shiftRes.status})`\n\n        // Provide specific error messages\n        if (errorMessage.includes('open assignments')) {\n          throw new Error('Cannot close shift with open assignments. Please close all assignments first.')\n        } else if (errorMessage.includes('already closed')) {\n          throw new Error('This shift has already been closed.')\n        } else if (errorMessage.includes('not found')) {\n          throw new Error('Shift not found. It may have been deleted.')\n        }\n\n        throw new Error(errorMessage)\n      }\n\n      const shiftResult = await shiftRes.json()\n      console.log('Shift closed successfully:', shiftResult)\n\n      // Create credit sales for all customers with credit entries (from pumper-wise data)\n      if (totalCredit > 0) {\n        try {\n          // Get the first assignment's nozzleId for credit sales\n          if (assignments.length === 0 || !assignments[0].nozzleId) {\n            throw new Error('No assignments found. Cannot create credit sale without a nozzle.')\n          }\n\n          const firstAssignment = assignments[0]\n          const nozzleId = firstAssignment.nozzleId\n\n          // Get fuel ID from assignment's nozzle data\n          const fuelId = firstAssignment.nozzle?.tank?.fuelId\n          if (!fuelId) {\n            throw new Error('Cannot determine fuel ID for credit sale')\n          }\n\n          // Get shift data to get stationId and startTime\n          const shiftData = shiftResult || await (await fetch(`/api/shifts/${selectedShift}`)).json()\n          const stationId = shiftData.station?.id || shiftData.stationId\n          const shiftStartTime = new Date(shiftData.startTime || validatedEndTime)\n\n          // Fetch current price for the fuel type\n          const fuelType = firstAssignment.nozzle?.tank?.fuel?.name\n          if (!fuelType) {\n            throw new Error('Cannot determine fuel type for credit sale')\n          }\n          const priceRes = await fetch(`/api/prices?stationId=${stationId}&fuelType=${fuelType}&isActive=true`)\n          let pricePerLiter = 470 // Default fallback price\n          if (priceRes.ok) {\n            const prices = await priceRes.json()\n            if (Array.isArray(prices) && prices.length > 0) {\n              // Get the most recent active price that's effective before or on shift start\n              const activePrices = prices.filter((p: { isActive: boolean; effectiveDate: string }) =>\n                p.isActive && new Date(p.effectiveDate) <= shiftStartTime\n              ).sort((a: { effectiveDate: string }, b: { effectiveDate: string }) =>\n                new Date(b.effectiveDate).getTime() - new Date(a.effectiveDate).getTime()\n              )\n              if (activePrices.length > 0) {\n                pricePerLiter = activePrices[0].price\n              }\n            }\n          }\n\n          // Collect all credit entries from all pumpers\n          const allCreditEntries: Record<string, number> = {}\n          for (const breakdown of pumperBreakdowns) {\n            for (const [customerId, amount] of Object.entries(breakdown.declaredCreditAmounts)) {\n              if (amount > 0) {\n                allCreditEntries[customerId] = (allCreditEntries[customerId] || 0) + amount\n              }\n            }\n          }\n\n          // Create credit sale for each customer with amount > 0\n          const creditSalePromises = Object.entries(allCreditEntries)\n            .filter(([_, amount]) => amount > 0)\n            .map(async ([customerId, amount]) => {\n              // Calculate liters from amount and price\n              const liters = pricePerLiter > 0 ? amount / pricePerLiter : 0\n\n              // Create credit sale\n              const creditSaleRes = await fetch('/api/credit/sales', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                  customerId: customerId,\n                  shiftId: selectedShift,\n                  nozzleId: nozzleId,\n                  amount: amount,\n                  liters: liters,\n                  price: pricePerLiter,\n                  signedBy: getCurrentUserName(),\n                  timestamp: validatedEndTime.toISOString()\n                })\n              })\n\n              if (!creditSaleRes.ok) {\n                const errorData = await creditSaleRes.json().catch(() => ({}))\n                throw new Error(errorData.error || `Failed to create credit sale for customer ${customerId}`)\n              }\n\n              return creditSaleRes.json()\n            })\n\n          const creditSaleResults = await Promise.all(creditSalePromises)\n          console.log('Credit sales created successfully:', creditSaleResults)\n        } catch (creditErr) {\n          console.error('Error creating credit sales:', creditErr)\n          const errorMessage = creditErr instanceof Error ? creditErr.message : 'Failed to create credit sales'\n          console.warn('Credit sale creation failed:', errorMessage)\n        }\n      }\n\n      // Create POS batches and add to safe\n      if (totalCard > 0) {\n        try {\n          // Get terminals with amounts from POS slips and missing slips\n          const terminalsWithAmounts = new Set<string>()\n          Object.values(posSlips).forEach(pumperSlips => {\n            pumperSlips.forEach(slip => {\n              if (slip.terminalId && slip.amount > 0) {\n                terminalsWithAmounts.add(slip.terminalId)\n              }\n            })\n          })\n          // Also include terminals from missing slips\n          Object.values(missingSlips).forEach(pumperMissingSlips => {\n            pumperMissingSlips.forEach(slip => {\n              if (slip.terminalId && slip.amount > 0 && slip.lastFourDigits.length === 4) {\n                terminalsWithAmounts.add(slip.terminalId)\n              }\n            })\n          })\n\n          // Get shift data for stationId\n          const shiftData = shiftResult || await (await fetch(`/api/shifts/${selectedShift}`)).json()\n          const stationId = shiftData.station?.id || shiftData.stationId\n\n          // Collect all POS slips from all pumpers (including missing slips for batch totals)\n          const allSlips: POSSlipEntry[] = []\n          pumperBreakdowns.forEach(breakdown => {\n            const pumperSlips = posSlips[breakdown.pumperName] || []\n            allSlips.push(...pumperSlips.filter(slip => slip.terminalId && slip.amount > 0))\n\n            // Also include missing slips in the batch totals calculation\n            const key = `${breakdown.pumperName}-unified`\n            const pumperMissingSlips = missingSlips[key] || []\n            pumperMissingSlips.forEach(missingSlip => {\n              if (missingSlip.terminalId && missingSlip.amount > 0 && missingSlip.lastFourDigits.length === 4) {\n                // Convert missing slip to POS slip format for batch calculation\n                // Use a default card type (VISA) since missing slips don't have card type\n                allSlips.push({\n                  id: missingSlip.id,\n                  terminalId: missingSlip.terminalId,\n                  amount: missingSlip.amount,\n                  lastFourDigits: missingSlip.lastFourDigits,\n                  cardType: 'VISA', // Default card type for missing slips\n                  timestamp: missingSlip.timestamp,\n                  notes: missingSlip.notes\n                })\n              }\n            })\n          })\n\n          // Calculate totals by terminal for batch creation\n          const terminalTotals: Record<string, { visaAmount: number; masterAmount: number; amexAmount: number; qrAmount: number; dialogTouchAmount: number; count: number }> = {}\n          allSlips.forEach(slip => {\n            if (!terminalTotals[slip.terminalId]) {\n              terminalTotals[slip.terminalId] = { visaAmount: 0, masterAmount: 0, amexAmount: 0, qrAmount: 0, dialogTouchAmount: 0, count: 0 }\n            }\n            terminalTotals[slip.terminalId].count++\n            switch (slip.cardType) {\n              case 'VISA':\n                terminalTotals[slip.terminalId].visaAmount += slip.amount\n                break\n              case 'MASTER':\n                terminalTotals[slip.terminalId].masterAmount += slip.amount\n                break\n              case 'AMEX':\n                terminalTotals[slip.terminalId].amexAmount += slip.amount\n                break\n              case 'QR':\n                terminalTotals[slip.terminalId].qrAmount += slip.amount\n                break\n              case 'DIALOG_TOUCH':\n                terminalTotals[slip.terminalId].dialogTouchAmount += slip.amount\n                break\n            }\n          })\n\n          // Create terminal entries array for batch creation\n          const terminalEntries = Array.from(terminalsWithAmounts).map(terminalId => {\n            const totals = terminalTotals[terminalId] || { visaAmount: 0, masterAmount: 0, amexAmount: 0, qrAmount: 0, dialogTouchAmount: 0, count: 0 }\n            return {\n              terminalId,\n              startNumber: '', // Not used in slip-based system\n              endNumber: '', // Not used in slip-based system\n              transactionCount: totals.count,\n              visaAmount: totals.visaAmount,\n              masterAmount: totals.masterAmount,\n              amexAmount: totals.amexAmount,\n              qrAmount: totals.qrAmount,\n              dialogTouchAmount: totals.dialogTouchAmount\n            }\n          })\n\n          // Calculate total amount\n          const batchTotalAmount = terminalEntries.reduce((sum, entry) =>\n            sum + entry.visaAmount + entry.masterAmount + entry.amexAmount + entry.qrAmount + (entry.dialogTouchAmount || 0), 0\n          )\n\n          // Create POS batch\n          const batchRes = await fetch('/api/pos/batches', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              stationId,\n              shiftId: selectedShift,\n              terminalEntries,\n              totalAmount: batchTotalAmount,\n              notes: `POS batch created during shift close`\n            })\n          })\n\n          if (!batchRes.ok) {\n            const errorData = await batchRes.json().catch(() => ({}))\n            throw new Error(errorData.error || 'Failed to create POS batch')\n          }\n\n          const batchResult = await batchRes.json()\n          const createdBatchId = batchResult.id\n\n          // Report missing slips if any (collect from all pumpers)\n          for (const terminalId of terminalsWithAmounts) {\n            // Get missing slips for this terminal from all pumpers\n            const terminalMissingSlips: MissingSlipEntry[] = []\n            pumperBreakdowns.forEach(breakdown => {\n              // Use unified key for missing slips per pumper\n              const key = `${breakdown.pumperName}-unified`\n              const slips = missingSlips[key] || []\n              terminalMissingSlips.push(...slips.filter(slip => slip.terminalId === terminalId))\n            })\n\n            for (const slip of terminalMissingSlips) {\n              if (slip.amount > 0 && slip.lastFourDigits.length === 4) {\n                try {\n                  const username = getCurrentUserName()\n                  await fetch('/api/pos/missing-slip', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({\n                      batchId: createdBatchId,\n                      terminalId: slip.terminalId,\n                      shiftId: selectedShift,\n                      amount: slip.amount,\n                      lastFourDigits: slip.lastFourDigits,\n                      timestamp: slip.timestamp.toISOString(),\n                      notes: slip.notes,\n                      reportedBy: username\n                    })\n                  })\n                } catch (slipErr) {\n                  console.warn(`Failed to report missing slip for terminal ${slip.terminalId}:`, slipErr)\n                  // Don't fail the entire operation if missing slip reporting fails\n                }\n              }\n            }\n          }\n\n          console.log('POS batch created successfully with missing slips')\n        } catch (posErr) {\n          console.error('Error creating POS batch:', posErr)\n          const errorMessage = posErr instanceof Error ? posErr.message : 'Failed to create POS batch'\n          console.warn('POS batch creation failed:', errorMessage)\n          // Don't fail the entire shift close if POS batch fails\n        }\n      }\n\n      // Cash will be added to safe manually by pumpers after shift end\n      // Cheques are still automatically tracked for record-keeping\n\n      // Add cheques to safe (for tracking purposes - pumpers handle physical cheques)\n      if (totalCheque > 0) {\n        try {\n          const shiftData = shiftResult || await (await fetch(`/api/shifts/${selectedShift}`)).json()\n          const stationId = shiftData.station?.id || shiftData.stationId\n\n          // Get all cheques from all pumpers\n          const allCheques: PumperCheque[] = []\n          pumperBreakdowns.forEach(breakdown => {\n            allCheques.push(...breakdown.cheques)\n          })\n\n          // Add each cheque to safe ONLY if it's cleared\n          // Cheques should not be counted as cash until they clear the bank\n          for (const cheque of allCheques) {\n            // Only add cleared cheques to safe - pending/bounced cheques should not be counted as cash\n            // Default to CLEARED if status is not specified (for backward compatibility)\n            const chequeStatus = cheque.status || 'CLEARED'\n            if (cheque.amount > 0 && chequeStatus === 'CLEARED') {\n              const safeRes = await fetch('/api/safe/transactions', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                  stationId,\n                  type: 'CHEQUE_RECEIVED',\n                  amount: cheque.amount,\n                  description: `Cleared Cheque #${cheque.chequeNumber} from ${cheque.receivedFrom}${cheque.bankName ? ` (${cheque.bankName})` : ''}`,\n                  timestamp: validatedEndTime.toISOString(),\n                  shiftId: selectedShift,\n                  chequeId: cheque.id, // Store reference if needed\n                  performedBy: getCurrentUserName()\n                })\n              })\n\n              if (!safeRes.ok) {\n                console.warn(`Failed to add cleared cheque ${cheque.chequeNumber} to safe`)\n              }\n            } else {\n              const chequeStatus = cheque.status || 'CLEARED'\n              if (chequeStatus !== 'CLEARED') {\n                console.log(`Skipping cheque ${cheque.chequeNumber} - status is ${chequeStatus}, not CLEARED`)\n              }\n            }\n          }\n\n          console.log('Cleared cheques added to safe successfully')\n        } catch (chequeErr) {\n          console.error('Error adding cheques to safe:', chequeErr)\n          // Don't fail the entire shift close if cheque addition fails\n        }\n      }\n\n      // Create test pours\n      try {\n        // Get all test pours with their pumper names\n        const allTestPoursWithPumper: Array<{ testPour: PumperTestPour; pumperName: string }> = []\n        Object.entries(pumperTestPours).forEach(([pumperName, testPours]) => {\n          testPours.forEach(testPour => {\n            allTestPoursWithPumper.push({ testPour, pumperName })\n          })\n        })\n\n        if (allTestPoursWithPumper.length > 0) {\n          for (const { testPour, pumperName } of allTestPoursWithPumper) {\n            if (testPour.nozzleId && testPour.amount > 0) {\n              // Validate reason is provided\n              if (!testPour.reason || testPour.reason.trim() === '') {\n                console.warn(`Skipping test pour - reason is required for test pour with amount ${testPour.amount}L`)\n                continue\n              }\n\n              // Get tank ID from assignment's nozzle data (assignments already have nozzle with tank info)\n              const assignment = assignments.find(a => a.nozzleId === testPour.nozzleId)\n              // Try to get tankId from nozzles state first, then fallback to API\n              let tankId: string | undefined = undefined\n\n              if (assignment?.nozzle?.id) {\n                const nozzleFromState = nozzles.find(n => n.id === assignment.nozzle?.id)\n                if (nozzleFromState?.tankId) {\n                  tankId = nozzleFromState.tankId\n                }\n              }\n\n              if (!tankId) {\n                console.warn(`Skipping test pour - nozzle ${testPour.nozzleId} not found in assignments or has no tank. Available assignments:`, assignments.map(a => ({ nozzleId: a.nozzleId, hasNozzle: !!a.nozzle, hasTank: !!a.nozzle?.tank })))\n                // Try to fetch tankId from API as fallback\n                try {\n                  const nozzleRes = await fetch(`/api/nozzles/${testPour.nozzleId}`)\n                  if (nozzleRes.ok) {\n                    const nozzleData = await nozzleRes.json()\n                    const fallbackTankId = nozzleData.tankId || nozzleData.tank?.id\n                    if (fallbackTankId) {\n                      console.log(`Found tankId via API fallback: ${fallbackTankId}`)\n                      const testPourPayload = {\n                        shiftId: selectedShift,\n                        nozzleId: testPour.nozzleId,\n                        tankId: fallbackTankId,\n                        litres: testPour.amount.toString(),\n                        reason: testPour.reason || undefined,\n                        testTime: validatedEndTime.toISOString(),\n                        testedBy: pumperName,\n                        returned: testPour.returned,\n                        notes: testPour.notes || undefined\n                      }\n\n                      console.log(`Creating test pour:`, testPourPayload)\n\n                      const testPourRes = await fetch('/api/tests', {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify(testPourPayload)\n                      })\n\n                      if (!testPourRes.ok) {\n                        const errorData = await testPourRes.json().catch(() => ({}))\n                        console.error(`Failed to create test pour for nozzle ${testPour.nozzleId}:`, errorData)\n                        setError(prev => prev ? `${prev}\\nFailed to create test pour: ${errorData.error || 'Unknown error'}` : `Failed to create test pour: ${errorData.error || 'Unknown error'}`)\n                      } else {\n                        const createdTestPour = await testPourRes.json()\n                        console.log(` Test pour created successfully:`, createdTestPour)\n                      }\n                      continue\n                    }\n                  }\n                } catch (apiErr) {\n                  console.error(`Failed to fetch nozzle data:`, apiErr)\n                }\n                continue\n              }\n\n              const testPourPayload = {\n                shiftId: selectedShift,\n                nozzleId: testPour.nozzleId,\n                tankId: tankId,\n                litres: testPour.amount.toString(),\n                reason: testPour.reason || undefined,\n                testTime: validatedEndTime.toISOString(),\n                testedBy: pumperName,\n                returned: testPour.returned,\n                notes: testPour.notes || undefined\n              }\n\n              console.log(`Creating test pour:`, testPourPayload)\n\n              const testPourRes = await fetch('/api/tests', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify(testPourPayload)\n              })\n\n              if (!testPourRes.ok) {\n                const errorData = await testPourRes.json().catch(() => ({}))\n                console.error(`Failed to create test pour for nozzle ${testPour.nozzleId}:`, errorData)\n                // Show error to user but don't fail the entire shift close\n                setError(prev => prev ? `${prev}\\nFailed to create test pour: ${errorData.error || 'Unknown error'}` : `Failed to create test pour: ${errorData.error || 'Unknown error'}`)\n              } else {\n                const createdTestPour = await testPourRes.json()\n                console.log(` Test pour created successfully:`, createdTestPour)\n              }\n            }\n          }\n          console.log('Test pours created successfully')\n        }\n      } catch (testPourErr) {\n        console.error('Error creating test pours:', testPourErr)\n        // Don't fail the entire shift close if test pour creation fails\n      }\n\n      // Create LoanPumper records for any LOAN_GIVEN expenses\n      try {\n        const shiftData = shiftResult || await (await fetch(`/api/shifts/${selectedShift}`)).json()\n        const stationId = shiftData.station?.id || shiftData.stationId\n\n        // Collect all loan expenses from all pumpers\n        const allLoanExpenses: Array<{ expense: PumperExpense; pumperName: string }> = []\n        pumperBreakdowns.forEach(breakdown => {\n          const loanExpenses = breakdown.expenses.filter(exp => exp.type === 'LOAN_GIVEN' && exp.loanGivenTo && exp.amount > 0)\n          loanExpenses.forEach(expense => {\n            allLoanExpenses.push({ expense, pumperName: breakdown.pumperName })\n          })\n        })\n\n        // Create LoanPumper records for each loan expense\n        if (allLoanExpenses.length > 0) {\n          for (const { expense, pumperName } of allLoanExpenses) {\n            try {\n              // Get the pumper who received the loan\n              const receivingPumper = pumpers.find(p => p.id === expense.loanGivenTo)\n              if (!receivingPumper) {\n                console.warn(`Skipping loan - pumper with ID ${expense.loanGivenTo} not found`)\n                continue\n              }\n\n              // Create LoanPumper record\n              const loanRes = await fetch('/api/loans/pumper', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                  stationId,\n                  pumperName: receivingPumper.name,\n                  amount: expense.amount,\n                  monthlyRental: expense.monthlyRental || 0,\n                  reason: expense.description || 'Loan given during shift close',\n                  givenBy: expense.loanGivenBy || pumperName,\n                  dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now\n                  fromSafe: false // This is not from safe, it's from shift expenses\n                })\n              })\n\n              if (!loanRes.ok) {\n                const errorData = await loanRes.json().catch(() => ({}))\n                console.warn(`Failed to create loan record for ${receivingPumper.name}:`, errorData)\n              } else {\n                console.log(` Loan record created for ${receivingPumper.name}`)\n              }\n            } catch (loanErr) {\n              console.error(`Error creating loan record:`, loanErr)\n              // Don't fail the entire shift close if loan creation fails\n            }\n          }\n          console.log('Loan records created successfully')\n        }\n      } catch (loanErr) {\n        console.error('Error creating loan records:', loanErr)\n        // Don't fail the entire shift close if loan creation fails\n      }\n\n      setSuccess('Shift closed successfully! Redirecting...')\n\n      // Redirect to shifts page after successful closure\n      setTimeout(() => {\n        router.push('/shifts')\n      }, 2000)\n    } catch (err) {\n      console.error('Error closing shift:', err)\n      const errorMessage = err instanceof Error ? err.message : 'Failed to close shift. Please try again.'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const assignmentColumns = [\n    {\n      key: 'nozzleId' as keyof Assignment,\n      title: 'Nozzle',\n      render: (_value: unknown, row: Assignment) => {\n        if (row.nozzle) {\n          const display = getNozzleDisplayWithBadge({\n            id: row.nozzle.id,\n            pumpNumber: row.nozzle.pump?.pumpNumber || '?',\n            nozzleNumber: row.nozzle.nozzleNumber,\n            fuelType: row.nozzle.tank?.fuel?.name || 'Unknown'\n          })\n          return (\n            <div className=\"flex items-center gap-2\">\n              <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">{display.label}</span>\n              <Badge variant=\"outline\">{display.badge}</Badge>\n            </div>\n          )\n        }\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium text-muted-foreground\">Nozzle {row.nozzleId.slice(0, 8)}</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'pumperName' as keyof Assignment,\n      title: 'Pumper',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-medium\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'startMeterReading' as keyof Assignment,\n      title: 'Start Meter',\n      render: (value: unknown) => {\n        const numValue = value as number\n        return (\n          <span className=\"font-mono\">\n            {numValue != null ? numValue.toLocaleString() : '-'}\n          </span>\n        )\n      }\n    },\n    {\n      key: 'endMeterReading' as keyof Assignment,\n      title: 'End Meter',\n      render: (value: unknown, row: Assignment) => (\n        <Input\n          type=\"number\"\n          value={(value as number) || ''}\n          onChange={(e) => handleUpdateAssignment(row.id, 'endMeterReading', parseInt(e.target.value) || 0)}\n          placeholder=\"Enter end reading\"\n          className=\"w-full\"\n        />\n      )\n    },\n    {\n      key: 'canSales' as keyof Assignment,\n      title: 'Can Sales (L)',\n      render: (value: unknown, row: Assignment) => (\n        <Input\n          type=\"number\"\n          value={(value as number) || ''}\n          onChange={(e) => handleUpdateAssignment(row.id, 'canSales', parseInt(e.target.value) || 0)}\n          placeholder=\"0\"\n          className=\"w-full\"\n        />\n      )\n    },\n    {\n      key: 'pumpSales' as keyof Assignment,\n      title: 'Pump Sales (L)',\n      render: (_value: unknown, row: Assignment) => {\n        const pumpSales = row.pumpSales ?? 0\n        return (\n          <span className=\"font-mono text-blue-600 dark:text-blue-400\">\n            {pumpSales.toLocaleString()}\n          </span>\n        )\n      }\n    },\n    {\n      key: 'delta' as keyof Assignment,\n      title: 'Total Delta (L)',\n      render: (_value: unknown, row: Assignment) => {\n        const endReading = row.endMeterReading ?? 0\n        const startReading = row.startMeterReading ?? 0\n        const delta = endReading - startReading\n        return (\n          <span className={`font-mono ${delta >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n            {delta.toLocaleString()}\n          </span>\n        )\n      }\n    }\n  ]\n\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-2\">\n        <Clock className=\"h-6 w-6 text-purple-600 dark:text-purple-400\" />\n        <h1 className=\"text-2xl font-bold\">Close Shift</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert className=\"border-green-500/20 dark:border-green-500/30 bg-green-500/10 dark:bg-green-500/20\">\n          <AlertDescription className=\"text-green-700 dark:text-green-300\">{success}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Shift Selection\" description=\"Select the station and shift to close\">\n        {/* Display current station */}\n        <div className=\"mb-4 p-3 bg-blue-500/10 dark:bg-blue-500/20 border border-blue-500/20 dark:border-blue-500/30 rounded-lg\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full\"></div>\n            <span className=\"text-sm font-medium text-blue-700 dark:text-blue-300\">\n              Station: {stations.find(s => s.id === selectedStation)?.name || 'No station selected'}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"shift\">Shift *</Label>\n            <Select value={selectedShift} onValueChange={setSelectedShift}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select shift\" />\n              </SelectTrigger>\n              <SelectContent>\n                {Array.isArray(shifts) && shifts.length > 0 ? (\n                  shifts.map((shift) => {\n                    // Extract unique pumper names from assignments\n                    let pumperDisplay = 'No pumpers'\n\n                    // Check if assignments exist and are an array\n                    const assignments = shift.assignments\n                    if (assignments && Array.isArray(assignments) && assignments.length > 0) {\n                      // Extract pumper names, handling both direct field access and nested structures\n                      const pumperNames = Array.from(new Set(\n                        assignments\n                          .map((a: Assignment) => {\n                            // Try different possible field paths\n                            return a.pumperName || ''\n                          })\n                          .filter((name: string) => name && typeof name === 'string' && name.trim() !== '')\n                      ))\n\n                      if (pumperNames.length > 0) {\n                        pumperDisplay = pumperNames.join(', ')\n                      }\n                    }\n\n                    return (\n                      <SelectItem key={shift.id} value={shift.id}>\n                        {new Date(shift.startTime).toLocaleString()} - {pumperDisplay}\n                      </SelectItem>\n                    )\n                  })\n                ) : (\n                  <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">\n                    No active shifts found\n                  </div>\n                )}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"endTime\">End Time *</Label>\n            <DateTimePicker\n              value={endTime}\n              onChange={(date) => setEndTime(date || new Date())}\n              placeholder=\"Select end time\"\n            />\n          </div>\n        </div>\n      </FormCard>\n\n      {selectedShift && (\n        <FormCard title=\"Meter Readings\" description=\"Enter end meter readings for each assignment\">\n          {assignments.length > 0 ? (\n            <DataTable\n              data={assignments}\n              columns={assignmentColumns}\n              searchable={false}\n              pagination={false}\n            />\n          ) : (\n            <p className=\"text-sm text-muted-foreground py-4\">No assignments found for this shift. Assignments will appear here once added.</p>\n          )}\n        </FormCard>\n      )}\n\n      {/* Pumper-wise Sales Breakdown */}\n      {selectedShift && pumperBreakdowns.length > 0 && (\n        <FormCard\n          title=\"Pumper-wise Sales & Variance\"\n          description=\"Enter declared amounts per pumper to calculate variance and salary adjustments\"\n        >\n          <div className=\"space-y-4\">\n            <Alert className=\"border-blue-500/20 dark:border-blue-500/30 bg-blue-500/10 dark:bg-blue-500/20\">\n              <AlertDescription className=\"text-blue-700 dark:text-blue-300\">\n                <strong>Salary Adjustment Rules:</strong> If variance is more than Rs. 20, add to pumper&apos;s salary.\n                If variance is less than -Rs. 20, deduct from pumper&apos;s salary. Variance within Rs. 20 is normal.\n              </AlertDescription>\n            </Alert>\n\n            <div className=\"space-y-4\">\n              {pumperBreakdowns.map((breakdown) => (\n                <div\n                  key={breakdown.pumperName}\n                  className={`border rounded-lg p-4 ${breakdown.varianceStatus === 'ADD_TO_SALARY'\n                    ? 'border-green-500/30 bg-green-500/5'\n                    : breakdown.varianceStatus === 'DEDUCT_FROM_SALARY'\n                      ? 'border-red-500/30 bg-red-500/5'\n                      : 'border-border'\n                    }`}\n                >\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <div>\n                      <h4 className=\"font-semibold text-lg\">{breakdown.pumperName}</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {breakdown.assignments.length} assignment{breakdown.assignments.length > 1 ? 's' : ''}\n                      </p>\n                    </div>\n                    <Badge\n                      variant={\n                        breakdown.varianceStatus === 'ADD_TO_SALARY'\n                          ? 'default'\n                          : breakdown.varianceStatus === 'DEDUCT_FROM_SALARY'\n                            ? 'destructive'\n                            : 'outline'\n                      }\n                      className={\n                        breakdown.varianceStatus === 'ADD_TO_SALARY'\n                          ? 'bg-green-600 text-white'\n                          : breakdown.varianceStatus === 'DEDUCT_FROM_SALARY'\n                            ? 'bg-red-600 text-white'\n                            : ''\n                      }\n                    >\n                      {breakdown.varianceStatus === 'ADD_TO_SALARY'\n                        ? 'Add to Salary'\n                        : breakdown.varianceStatus === 'DEDUCT_FROM_SALARY'\n                          ? 'Deduct from Salary'\n                          : 'Normal'}\n                    </Badge>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    {/* Calculated Sales */}\n                    <div>\n                      <Label className=\"text-sm text-muted-foreground mb-1 block\">\n                        Calculated Sales (from meter)\n                      </Label>\n                      <div className=\"font-mono font-semibold text-lg\">\n                        Rs. {breakdown.calculatedSales.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                      </div>\n                    </div>\n\n                    {/* Declared Amount Breakdown */}\n                    <div className=\"space-y-4\">\n                      <Label className=\"text-sm font-medium mb-3 block\">Declared Amount Breakdown:</Label>\n\n                      {/* Cash Amount */}\n                      <div className=\"space-y-2\">\n                        <Label className=\"flex items-center gap-2\">\n                          <DollarSign className=\"h-4 w-4\" />\n                          Cash Amount\n                        </Label>\n                        <MoneyInput\n                          value={breakdown.declaredCash}\n                          onChange={(value) => handleUpdatePumperCash(breakdown.pumperName, value)}\n                          placeholder=\"0.00\"\n                          className=\"w-full\"\n                        />\n                      </div>\n\n                      {/* POS Terminal Verification & Slip Entry (for this pumper) */}\n                      {(() => {\n                        const pumperSlips = posSlips[breakdown.pumperName] || []\n                        const isOpen = posVerificationOpen[breakdown.pumperName] || false\n\n                        // Calculate totals by terminal and card type from slips\n                        const totalsByTerminal: Record<string, number> = {}\n                        const totalsByCardType: Record<string, number> = { VISA: 0, MASTER: 0, AMEX: 0, QR: 0, DIALOG_TOUCH: 0 }\n                        let grandTotal = 0\n\n                        pumperSlips.forEach(slip => {\n                          if (slip.terminalId && slip.amount > 0) {\n                            totalsByTerminal[slip.terminalId] = (totalsByTerminal[slip.terminalId] || 0) + slip.amount\n                            totalsByCardType[slip.cardType] = (totalsByCardType[slip.cardType] || 0) + slip.amount\n                            grandTotal += slip.amount\n                          }\n                        })\n\n                        // Get all unique terminals used in slips\n                        const usedTerminalIds = Array.from(new Set(pumperSlips.filter(s => s.terminalId).map(s => s.terminalId)))\n\n                        // Get all available terminals (show all, not just ones with amounts)\n                        const allTerminalIds = posTerminals.map(t => t.id)\n\n                        return (\n                          <div className=\"space-y-4 pt-4 border-t mt-4\">\n                            <div className=\"flex items-center justify-between mb-2\">\n                              <Label className=\"flex items-center gap-2 text-sm font-semibold\">\n                                <CreditCard className=\"h-4 w-4\" />\n                                POS Terminal Verification & Slip Entry\n                              </Label>\n                              <Button\n                                type=\"button\"\n                                variant={isOpen ? \"default\" : \"outline\"}\n                                size=\"sm\"\n                                onClick={() => togglePOSVerification(breakdown.pumperName)}\n                              >\n                                {isOpen ? 'Hide Details' : 'Show Verification'}\n                              </Button>\n                            </div>\n                            <Alert className=\"mb-4 border-blue-500/20 dark:border-blue-500/30 bg-blue-500/10 dark:bg-blue-500/20\">\n                              <AlertDescription className=\"text-blue-700 dark:text-blue-300 text-xs\">\n                                <strong>Required:</strong> Add individual POS slips one by one. System will automatically calculate totals by terminal and card type. Prevent duplicate card payments on the same day.\n                              </AlertDescription>\n                            </Alert>\n\n                            {isOpen && (\n                              <>\n                                {/* Add Slip Button */}\n                                <div className=\"flex justify-end mb-4\">\n                                  <Button\n                                    type=\"button\"\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={() => handleAddPOSSlip(breakdown.pumperName)}\n                                  >\n                                    <Plus className=\"h-4 w-4 mr-1\" />\n                                    Add POS Slip\n                                  </Button>\n                                </div>\n\n                                {/* POS Slips List */}\n                                <div className=\"space-y-3\">\n                                  {pumperSlips.length === 0 ? (\n                                    <p className=\"text-xs text-muted-foreground text-center py-4 border rounded-lg\">\n                                      No POS slips added yet. Click &quot;Add POS Slip&quot; to start.\n                                    </p>\n                                  ) : (\n                                    pumperSlips.map((slip) => {\n                                      const isMinimized = minimizedPOSSlips[slip.id] || false\n                                      const isComplete = isPOSSlipComplete(slip)\n                                      const terminal = posTerminals.find(t => t.id === slip.terminalId)\n\n                                      return (\n                                        <div key={slip.id} className={`border rounded-lg p-3 space-y-3 bg-blue-500/5 dark:bg-blue-500/10 ${isMinimized ? 'cursor-pointer hover:bg-blue-500/10 dark:hover:bg-blue-500/15' : ''}`}>\n                                          <div className=\"flex items-center justify-between\">\n                                            {isMinimized ? (\n                                              <div\n                                                className=\"flex-1 cursor-pointer\"\n                                                onClick={() => handleExpandPOSSlip(slip.id)}\n                                              >\n                                                <div className=\"flex items-center gap-2\">\n                                                  <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                                                  <Label className=\"text-sm font-medium\">POS Slip - {slip.lastFourDigits || 'Incomplete'}</Label>\n                                                  {terminal && <span className=\"text-xs text-muted-foreground\">({terminal.name})</span>}\n                                                  <span className=\"text-xs text-green-600 dark:text-green-400\">Rs. {slip.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                                </div>\n                                              </div>\n                                            ) : (\n                                              <Label className=\"text-sm font-medium\">POS Slip</Label>\n                                            )}\n                                            <div className=\"flex items-center gap-2\">\n                                              {!isMinimized && isComplete && (\n                                                <Button\n                                                  type=\"button\"\n                                                  variant=\"outline\"\n                                                  size=\"sm\"\n                                                  onClick={(e) => {\n                                                    e.stopPropagation()\n                                                    handleMinimizePOSSlip(slip.id)\n                                                  }}\n                                                  title=\"Minimize slip\"\n                                                >\n                                                  <Check className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                                                </Button>\n                                              )}\n                                              {isMinimized && (\n                                                <Button\n                                                  type=\"button\"\n                                                  variant=\"outline\"\n                                                  size=\"sm\"\n                                                  onClick={(e) => {\n                                                    e.stopPropagation()\n                                                    handleExpandPOSSlip(slip.id)\n                                                  }}\n                                                  title=\"Expand slip\"\n                                                >\n                                                  <ChevronUp className=\"h-4 w-4\" />\n                                                </Button>\n                                              )}\n                                              <Button\n                                                type=\"button\"\n                                                variant=\"outline\"\n                                                size=\"sm\"\n                                                onClick={(e) => {\n                                                  e.stopPropagation()\n                                                  handleRemovePOSSlip(breakdown.pumperName, slip.id)\n                                                }}\n                                              >\n                                                <Trash2 className=\"h-4 w-4\" />\n                                              </Button>\n                                            </div>\n                                          </div>\n\n                                          {!isMinimized && (\n                                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground mb-1 block\">POS Machine *</Label>\n                                                <Select\n                                                  value={slip.terminalId}\n                                                  onValueChange={(value) => handleUpdatePOSSlip(breakdown.pumperName, slip.id, 'terminalId', value)}\n                                                >\n                                                  <SelectTrigger className=\"w-full\">\n                                                    <SelectValue placeholder=\"Select POS machine\" />\n                                                  </SelectTrigger>\n                                                  <SelectContent>\n                                                    {posTerminals.map(terminal => (\n                                                      <SelectItem key={terminal.id} value={terminal.id}>\n                                                        {terminal.name} ({terminal.terminalNumber})\n                                                        {terminal.bank && (\n                                                          <span className=\"ml-2 text-xs text-muted-foreground\">- {terminal.bank.name}</span>\n                                                        )}\n                                                      </SelectItem>\n                                                    ))}\n                                                  </SelectContent>\n                                                </Select>\n                                              </div>\n\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground mb-1 block\">Card Sale Time *</Label>\n                                                <DateTimePicker\n                                                  value={slip.timestamp}\n                                                  onChange={(date) => handleUpdatePOSSlip(breakdown.pumperName, slip.id, 'timestamp', date || new Date())}\n                                                />\n                                              </div>\n\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground mb-1 block\">Card Number (Last 4 Digits) *</Label>\n                                                <Input\n                                                  value={slip.lastFourDigits}\n                                                  onChange={(e) => {\n                                                    const value = e.target.value.replace(/\\D/g, '').slice(0, 4)\n                                                    handleUpdatePOSSlip(breakdown.pumperName, slip.id, 'lastFourDigits', value)\n                                                  }}\n                                                  placeholder=\"1234\"\n                                                  maxLength={4}\n                                                  className={`w-full ${duplicateCardErrors[slip.id] ? 'border-red-500 dark:border-red-500 focus-visible:ring-red-500' : ''}`}\n                                                />\n                                                {duplicateCardErrors[slip.id] && (() => {\n                                                  const error = duplicateCardErrors[slip.id]\n                                                  const duplicateSlip = error.duplicateSlip\n                                                  const terminal = posTerminals.find(t => t.id === duplicateSlip.terminalId)\n                                                  const duplicateTime = new Date(duplicateSlip.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })\n                                                  return (\n                                                    <Alert className=\"mt-2 border-red-500 dark:border-red-500 bg-red-50 dark:bg-red-950/50\">\n                                                      <AlertDescription className=\"text-red-700 dark:text-red-400 text-xs\">\n                                                        <div className=\"font-semibold mb-1\"> DUPLICATE CARD DETECTED - FRAUD ALERT!</div>\n                                                        <div>This card (ending in {error.cardNumber}, {slip.cardType}) was already added today:</div>\n                                                        <div className=\"mt-1 ml-2\">\n                                                           Time: {duplicateTime}<br />\n                                                           Amount: Rs. {duplicateSlip.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}<br />\n                                                           Card Type: {duplicateSlip.cardType}<br />\n                                                          {terminal && <span> Terminal: {terminal.name} ({terminal.terminalNumber})</span>}\n                                                        </div>\n                                                        <div className=\"mt-2 font-semibold\"> The same card with the same type cannot be used twice on the same terminal in the same day!</div>\n                                                        <div className=\"mt-1 text-xs\">\n                                                          <strong>Note:</strong> Different cards can have the same last 4 digits. If this is a different card,\n                                                          change the card type (VISA/MASTER/AMEX) or use a different terminal.\n                                                        </div>\n                                                      </AlertDescription>\n                                                    </Alert>\n                                                  )\n                                                })()}\n                                              </div>\n\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground mb-1 block\">Card Type *</Label>\n                                                <Select\n                                                  value={slip.cardType}\n                                                  onValueChange={(value) => handleUpdatePOSSlip(breakdown.pumperName, slip.id, 'cardType', value)}\n                                                >\n                                                  <SelectTrigger className=\"w-full\">\n                                                    <SelectValue />\n                                                  </SelectTrigger>\n                                                  <SelectContent>\n                                                    <SelectItem value=\"VISA\">Visa</SelectItem>\n                                                    <SelectItem value=\"MASTER\">Master</SelectItem>\n                                                    <SelectItem value=\"AMEX\">Amex</SelectItem>\n                                                    <SelectItem value=\"QR\">QR</SelectItem>\n                                                    <SelectItem value=\"DIALOG_TOUCH\">Dialog Touch ID Card</SelectItem>\n                                                  </SelectContent>\n                                                </Select>\n                                              </div>\n\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground mb-1 block\">Amount *</Label>\n                                                <MoneyInput\n                                                  value={slip.amount}\n                                                  onChange={(value) => handleUpdatePOSSlip(breakdown.pumperName, slip.id, 'amount', value)}\n                                                  placeholder=\"0.00\"\n                                                  className=\"w-full\"\n                                                />\n                                              </div>\n\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground mb-1 block\">Notes (Optional)</Label>\n                                                <Input\n                                                  value={slip.notes || ''}\n                                                  onChange={(e) => handleUpdatePOSSlip(breakdown.pumperName, slip.id, 'notes', e.target.value)}\n                                                  placeholder=\"Additional notes\"\n                                                  className=\"w-full\"\n                                                />\n                                              </div>\n                                            </div>\n                                          )}\n                                        </div>\n                                      )\n                                    })\n                                  )}\n                                </div>\n\n                                {/* Totals Summary */}\n                                {pumperSlips.length > 0 && (\n                                  <div className=\"mt-6 pt-4 border-t space-y-4\">\n                                    <div className=\"p-4 bg-muted/30 dark:bg-muted/20 rounded-lg\">\n                                      <h5 className=\"font-semibold text-sm mb-3\">Totals Summary</h5>\n\n                                      {/* Totals by Terminal */}\n                                      <div className=\"mb-4\">\n                                        <Label className=\"text-xs font-medium mb-2 block\">By POS Terminal:</Label>\n                                        <div className=\"space-y-1\">\n                                          {usedTerminalIds.map(terminalId => {\n                                            const terminal = posTerminals.find(t => t.id === terminalId)\n                                            const terminalTotal = totalsByTerminal[terminalId] || 0\n                                            return (\n                                              <div key={terminalId} className=\"flex justify-between text-xs\">\n                                                <span className=\"text-muted-foreground\">\n                                                  {terminal?.name || 'Unknown'}:\n                                                </span>\n                                                <span className=\"font-mono text-green-600 dark:text-green-400\">\n                                                  Rs. {terminalTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                                </span>\n                                              </div>\n                                            )\n                                          })}\n                                        </div>\n                                      </div>\n\n                                      {/* Totals by Card Type */}\n                                      <div className=\"mb-4\">\n                                        <Label className=\"text-xs font-medium mb-2 block\">By Card Type:</Label>\n                                        <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                                          {Object.entries(totalsByCardType).map(([type, amount]) => (\n                                            <div key={type} className=\"flex justify-between\">\n                                              <span className=\"text-muted-foreground\">{type}:</span>\n                                              <span className=\"font-mono\">Rs. {amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                            </div>\n                                          ))}\n                                        </div>\n                                      </div>\n\n                                      {/* Grand Total */}\n                                      {grandTotal > 0 && (\n                                        <div className=\"pt-2 border-t\">\n                                          <div className=\"flex justify-between items-center\">\n                                            <Label className=\"text-sm font-semibold\">Total Card Sales (from slips):</Label>\n                                            <div className=\"font-mono font-bold text-base text-green-600 dark:text-green-400\">\n                                              Rs. {grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                            </div>\n                                          </div>\n                                        </div>\n                                      )}\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* Missing Slips Section */}\n                                {isOpen && (\n                                  <div className=\"mt-6 pt-4 border-t\">\n                                    <div className=\"flex items-center justify-between mb-2\">\n                                      <Label className=\"flex items-center gap-2 text-sm font-semibold\">\n                                        <FileText className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n                                        Missing Slips (Optional)\n                                      </Label>\n                                    </div>\n                                    <Alert className=\"mb-4 border-orange-500/20 dark:border-orange-500/30 bg-orange-500/10 dark:bg-orange-500/20\">\n                                      <AlertDescription className=\"text-orange-700 dark:text-orange-300 text-xs\">\n                                        <strong>Optional:</strong> Report missing POS slips that were not provided by customers. This helps track discrepancies in card transactions.\n                                      </AlertDescription>\n                                    </Alert>\n\n                                    {/* Add Missing Slip Button */}\n                                    <div className=\"flex justify-end mb-4\">\n                                      <Button\n                                        type=\"button\"\n                                        variant=\"outline\"\n                                        size=\"sm\"\n                                        onClick={() => handleAddMissingSlip(breakdown.pumperName)}\n                                      >\n                                        <Plus className=\"h-4 w-4 mr-1\" />\n                                        Add Missing Slip\n                                      </Button>\n                                    </div>\n\n                                    {/* Missing Slips List */}\n                                    {(() => {\n                                      // Get all missing slips for this pumper using unified key\n                                      const key = `${breakdown.pumperName}-unified`\n                                      const pumperMissingSlips = missingSlips[key] || []\n                                      const allMissingSlips: Array<{ slip: MissingSlipEntry; terminalId: string }> = pumperMissingSlips.map(slip => ({\n                                        slip,\n                                        terminalId: slip.terminalId\n                                      }))\n\n                                      return (\n                                        <div className=\"space-y-3\">\n                                          {allMissingSlips.length === 0 ? (\n                                            <p className=\"text-xs text-muted-foreground text-center py-4 border rounded-lg\">\n                                              No missing slips reported yet. Click &quot;Add Missing Slip&quot; to start.\n                                            </p>\n                                          ) : (\n                                            allMissingSlips.map(({ slip, terminalId }) => {\n                                              const isMinimized = minimizedMissingSlips[slip.id] || false\n                                              const isComplete = isMissingSlipComplete(slip)\n                                              const terminal = posTerminals.find(t => t.id === slip.terminalId)\n\n                                              return (\n                                                <div key={slip.id} className={`border rounded-lg p-3 space-y-3 bg-orange-500/5 dark:bg-orange-500/10 ${isMinimized ? 'cursor-pointer hover:bg-orange-500/10 dark:hover:bg-orange-500/15' : ''}`}>\n                                                  <div className=\"flex items-center justify-between\">\n                                                    {isMinimized ? (\n                                                      <div\n                                                        className=\"flex-1 cursor-pointer\"\n                                                        onClick={() => handleExpandMissingSlip(slip.id)}\n                                                      >\n                                                        <div className=\"flex items-center gap-2\">\n                                                          <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                                                          <Label className=\"text-sm font-medium\">Missing Slip - {slip.lastFourDigits || 'Incomplete'}</Label>\n                                                          {terminal && <span className=\"text-xs text-muted-foreground\">({terminal.name})</span>}\n                                                          <span className=\"text-xs text-orange-600 dark:text-orange-400\">Rs. {slip.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                                        </div>\n                                                      </div>\n                                                    ) : (\n                                                      <Label className=\"text-sm font-medium\">Missing Slip</Label>\n                                                    )}\n                                                    <div className=\"flex items-center gap-2\">\n                                                      {!isMinimized && isComplete && (\n                                                        <Button\n                                                          type=\"button\"\n                                                          variant=\"outline\"\n                                                          size=\"sm\"\n                                                          onClick={(e) => {\n                                                            e.stopPropagation()\n                                                            handleMinimizeMissingSlip(slip.id)\n                                                          }}\n                                                          title=\"Minimize slip\"\n                                                        >\n                                                          <Check className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                                                        </Button>\n                                                      )}\n                                                      {isMinimized && (\n                                                        <Button\n                                                          type=\"button\"\n                                                          variant=\"outline\"\n                                                          size=\"sm\"\n                                                          onClick={(e) => {\n                                                            e.stopPropagation()\n                                                            handleExpandMissingSlip(slip.id)\n                                                          }}\n                                                          title=\"Expand slip\"\n                                                        >\n                                                          <ChevronUp className=\"h-4 w-4\" />\n                                                        </Button>\n                                                      )}\n                                                      <Button\n                                                        type=\"button\"\n                                                        variant=\"outline\"\n                                                        size=\"sm\"\n                                                        onClick={(e) => {\n                                                          e.stopPropagation()\n                                                          handleRemoveMissingSlip(breakdown.pumperName, terminalId, slip.id)\n                                                        }}\n                                                      >\n                                                        <Trash2 className=\"h-4 w-4\" />\n                                                      </Button>\n                                                    </div>\n                                                  </div>\n\n                                                  {!isMinimized && (\n                                                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                                      <div>\n                                                        <Label className=\"text-xs text-muted-foreground mb-1 block\">POS Machine *</Label>\n                                                        <Select\n                                                          value={slip.terminalId}\n                                                          onValueChange={(value) => handleUpdateMissingSlip(breakdown.pumperName, terminalId, slip.id, 'terminalId', value)}\n                                                        >\n                                                          <SelectTrigger className=\"w-full\">\n                                                            <SelectValue placeholder=\"Select POS machine\" />\n                                                          </SelectTrigger>\n                                                          <SelectContent>\n                                                            {posTerminals.map(terminal => (\n                                                              <SelectItem key={terminal.id} value={terminal.id}>\n                                                                {terminal.name} ({terminal.terminalNumber})\n                                                                {terminal.bank && (\n                                                                  <span className=\"ml-2 text-xs text-muted-foreground\">- {terminal.bank.name}</span>\n                                                                )}\n                                                              </SelectItem>\n                                                            ))}\n                                                          </SelectContent>\n                                                        </Select>\n                                                      </div>\n\n                                                      <div>\n                                                        <Label className=\"text-xs text-muted-foreground mb-1 block\">Transaction Time *</Label>\n                                                        <DateTimePicker\n                                                          value={slip.timestamp}\n                                                          onChange={(date) => handleUpdateMissingSlip(breakdown.pumperName, terminalId, slip.id, 'timestamp', date || new Date())}\n                                                        />\n                                                      </div>\n\n                                                      <div>\n                                                        <Label className=\"text-xs text-muted-foreground mb-1 block\">Card Number (Last 4 Digits) *</Label>\n                                                        <Input\n                                                          value={slip.lastFourDigits}\n                                                          onChange={(e) => {\n                                                            const value = e.target.value.replace(/\\D/g, '').slice(0, 4)\n                                                            handleUpdateMissingSlip(breakdown.pumperName, terminalId, slip.id, 'lastFourDigits', value)\n                                                          }}\n                                                          placeholder=\"1234\"\n                                                          maxLength={4}\n                                                          className=\"w-full\"\n                                                        />\n                                                      </div>\n\n                                                      <div>\n                                                        <Label className=\"text-xs text-muted-foreground mb-1 block\">Amount *</Label>\n                                                        <MoneyInput\n                                                          value={slip.amount}\n                                                          onChange={(value) => handleUpdateMissingSlip(breakdown.pumperName, terminalId, slip.id, 'amount', value)}\n                                                          placeholder=\"0.00\"\n                                                          className=\"w-full\"\n                                                        />\n                                                      </div>\n\n                                                      <div>\n                                                        <Label className=\"text-xs text-muted-foreground mb-1 block\">Notes (Optional)</Label>\n                                                        <Input\n                                                          value={slip.notes || ''}\n                                                          onChange={(e) => handleUpdateMissingSlip(breakdown.pumperName, terminalId, slip.id, 'notes', e.target.value)}\n                                                          placeholder=\"Additional notes\"\n                                                          className=\"w-full\"\n                                                        />\n                                                      </div>\n                                                    </div>\n                                                  )}\n                                                </div>\n                                              )\n                                            })\n                                          )}\n                                        </div>\n                                      )\n                                    })()}\n                                  </div>\n                                )}\n                              </>\n                            )}\n                          </div>\n                        )\n                      })()}\n\n                      {/* Credit Amounts by Customer */}\n                      <div className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4\" />\n                            Credit Amounts by Customer\n                          </Label>\n                          <div className=\"flex items-center gap-2\">\n                            <Select onValueChange={(customerId) => handleAddPumperCreditRow(breakdown.pumperName, customerId)}>\n                              <SelectTrigger className=\"w-64\">\n                                <SelectValue placeholder=\"Add customer\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {creditCustomers\n                                  .filter(customer => !breakdown.declaredCreditAmounts.hasOwnProperty(customer.id))\n                                  .map((customer) => (\n                                    <SelectItem key={customer.id} value={customer.id}>\n                                      {customer.name}\n                                    </SelectItem>\n                                  ))}\n                              </SelectContent>\n                            </Select>\n                            <Button\n                              size=\"sm\"\n                              disabled={creditCustomers.filter(c => !breakdown.declaredCreditAmounts.hasOwnProperty(c.id)).length === 0}\n                            >\n                              <Plus className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </div>\n\n                        {Object.entries(breakdown.declaredCreditAmounts).map(([customerId, amount]) => {\n                          const customer = creditCustomers.find(c => c.id === customerId)\n                          const availableCredit = customer ? (customer.creditLimit - customer.currentBalance) : 0\n                          return (\n                            <div key={customerId} className=\"flex items-center gap-2\">\n                              <div className=\"flex-1\">\n                                <Label className=\"text-sm text-muted-foreground\">\n                                  {customer?.name}\n                                </Label>\n                                <MoneyInput\n                                  value={amount}\n                                  onChange={(value) => handleUpdatePumperCreditAmount(breakdown.pumperName, customerId, value)}\n                                  placeholder=\"0.00\"\n                                  className=\"w-full\"\n                                />\n                                {amount > 0 && amount > availableCredit && (\n                                  <p className=\"text-xs text-red-600 dark:text-red-400 ml-1\">\n                                    Warning: Amount exceeds available credit by Rs. {(amount - availableCredit).toLocaleString()}\n                                  </p>\n                                )}\n                                {amount > 0 && amount <= availableCredit && (\n                                  <p className=\"text-xs text-muted-foreground ml-1\">\n                                    Available credit: Rs. {availableCredit.toLocaleString()}\n                                  </p>\n                                )}\n                              </div>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => handleRemovePumperCreditRow(breakdown.pumperName, customerId)}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          )\n                        })}\n                      </div>\n\n                      {/* Cheque Details */}\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4\" />\n                            Cheques Received\n                          </Label>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleAddPumperCheque(breakdown.pumperName)}\n                          >\n                            <Plus className=\"h-4 w-4 mr-1\" />\n                            Add Cheque\n                          </Button>\n                        </div>\n\n                        {breakdown.cheques.length === 0 ? (\n                          <p className=\"text-xs text-muted-foreground text-center py-4 border rounded-lg\">\n                            No cheques received\n                          </p>\n                        ) : (\n                          <div className=\"space-y-3\">\n                            {breakdown.cheques.map((cheque) => (\n                              <div key={cheque.id} className=\"border rounded-lg p-3 space-y-3\">\n                                <div className=\"flex items-center justify-between\">\n                                  <Label className=\"text-sm font-medium\">Cheque Details</Label>\n                                  <Button\n                                    type=\"button\"\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={() => handleRemovePumperCheque(breakdown.pumperName, cheque.id)}\n                                  >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Cheque Number *</Label>\n                                  <Input\n                                    value={cheque.chequeNumber}\n                                    onChange={(e) => handleUpdatePumperCheque(breakdown.pumperName, cheque.id, 'chequeNumber', e.target.value)}\n                                    placeholder=\"Enter cheque number\"\n                                    className=\"w-full\"\n                                  />\n                                </div>\n\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Received From (Who Gave the Cheque) *</Label>\n                                  <Input\n                                    value={cheque.receivedFrom}\n                                    onChange={(e) => handleUpdatePumperCheque(breakdown.pumperName, cheque.id, 'receivedFrom', e.target.value)}\n                                    placeholder=\"Enter name of person/company who gave the cheque\"\n                                    className=\"w-full\"\n                                  />\n                                </div>\n\n                                <div>\n                                  <div>\n                                    <div className=\"flex items-center justify-between mb-1\">\n                                      <Label className=\"text-xs text-muted-foreground\">Bank</Label>\n                                      <Dialog open={addBankDialogOpen} onOpenChange={setAddBankDialogOpen}>\n                                        <DialogTrigger asChild>\n                                          <Button\n                                            variant=\"ghost\"\n                                            size=\"sm\"\n                                            className=\"h-6 text-xs\"\n                                            type=\"button\"\n                                            onClick={(e) => {\n                                              e.preventDefault()\n                                              setAddBankDialogOpen(true)\n                                            }}\n                                          >\n                                            <Plus className=\"h-3 w-3 mr-1\" />\n                                            Add Bank\n                                          </Button>\n                                        </DialogTrigger>\n                                      </Dialog>\n                                    </div>\n                                    <Select\n                                      value={cheque.bankId || ''}\n                                      onValueChange={(value) => {\n                                        const selectedBank = banks.find(b => b.id === value)\n                                        handleUpdatePumperCheque(breakdown.pumperName, cheque.id, 'bankId', value)\n                                        if (selectedBank) {\n                                          handleUpdatePumperCheque(breakdown.pumperName, cheque.id, 'bankName', selectedBank.name)\n                                        }\n                                      }}\n                                    >\n                                      <SelectTrigger className=\"w-full\">\n                                        <SelectValue placeholder=\"Select bank\" />\n                                      </SelectTrigger>\n                                      <SelectContent>\n                                        {banks.length === 0 ? (\n                                          <div className=\"px-2 py-1.5 text-xs text-muted-foreground text-center\">\n                                            No banks available. Click &quot;Add Bank&quot; above to create one.\n                                          </div>\n                                        ) : (\n                                          banks.map((bank) => (\n                                            <SelectItem key={bank.id} value={bank.id}>\n                                              <div className=\"flex items-center gap-2\">\n                                                <Building2 className=\"h-4 w-4\" />\n                                                <span className=\"font-medium\">{bank.name}</span>\n                                                {bank.branch && (\n                                                  <span className=\"text-xs text-muted-foreground\">- {bank.branch}</span>\n                                                )}\n                                              </div>\n                                            </SelectItem>\n                                          ))\n                                        )}\n                                        <div className=\"border-t mt-1 pt-1\">\n                                          <Button\n                                            variant=\"ghost\"\n                                            className=\"w-full justify-start text-xs\"\n                                            type=\"button\"\n                                            onClick={(e) => {\n                                              e.preventDefault()\n                                              setAddBankDialogOpen(true)\n                                            }}\n                                          >\n                                            <Plus className=\"h-3 w-3 mr-2\" />\n                                            Add New Bank\n                                          </Button>\n                                          <Button\n                                            variant=\"ghost\"\n                                            className=\"w-full justify-start text-xs text-blue-600 dark:text-blue-400\"\n                                            type=\"button\"\n                                            onClick={() => router.push('/settings/banks')}\n                                          >\n                                            <ExternalLink className=\"h-3 w-3 mr-2\" />\n                                            Manage All Banks\n                                          </Button>\n                                        </div>\n                                      </SelectContent>\n                                    </Select>\n                                    {banks.length > 0 && (\n                                      <p className=\"text-xs text-muted-foreground mt-1\">\n                                        Don&apos;t see your bank? Click &quot;Add Bank&quot; or{' '}\n                                        <Button variant=\"link\" className=\"h-auto p-0 text-xs\" onClick={() => router.push('/settings/banks')}>\n                                          manage all banks\n                                        </Button>\n                                      </p>\n                                    )}\n                                  </div>\n                                </div>\n\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Amount *</Label>\n                                  <MoneyInput\n                                    value={cheque.amount}\n                                    onChange={(value) => handleUpdatePumperCheque(breakdown.pumperName, cheque.id, 'amount', value)}\n                                    placeholder=\"0.00\"\n                                    className=\"w-full\"\n                                  />\n                                </div>\n                              </div>\n                            ))}\n\n                            <div className=\"flex justify-between items-center pt-2 border-t\">\n                              <Label className=\"text-sm font-medium\">Total Cheque Amount:</Label>\n                              <div className=\"font-mono font-semibold\">\n                                Rs. {breakdown.declaredCheque.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </div>\n                            </div>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Test Pours */}\n                      <div className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"flex items-center gap-2\">\n                            <Fuel className=\"h-4 w-4\" />\n                            Test Pours\n                            {breakdown.assignments.length > 0 && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({breakdown.assignments.length} nozzle{breakdown.assignments.length > 1 ? 's' : ''} assigned)\n                              </span>\n                            )}\n                          </Label>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleAddPumperTestPour(breakdown.pumperName)}\n                            disabled={breakdown.assignments.length === 0}\n                          >\n                            <Plus className=\"h-4 w-4 mr-1\" />\n                            Add Test Pour\n                          </Button>\n                        </div>\n\n                        {breakdown.assignments.length === 0 ? (\n                          <p className=\"text-xs text-muted-foreground text-center py-4 border rounded-lg\">\n                            No nozzles assigned to this pumper\n                          </p>\n                        ) : (!pumperTestPours[breakdown.pumperName] || pumperTestPours[breakdown.pumperName].length === 0) ? (\n                          <p className=\"text-xs text-muted-foreground text-center py-4 border rounded-lg\">\n                            No test pours recorded. Click &quot;Add Test Pour&quot; to record test pours for assigned nozzles.\n                          </p>\n                        ) : (\n                          <div className=\"space-y-3\">\n                            {pumperTestPours[breakdown.pumperName].map((testPour) => {\n                              // Get assigned nozzles for this pumper\n                              const assignedNozzles = breakdown.assignments\n                                .filter(a => a.nozzle)\n                                .map(a => a.nozzle!)\n                                .filter((nozzle, index, self) =>\n                                  index === self.findIndex(n => n.id === nozzle.id)\n                                ) // Remove duplicates\n\n                              return (\n                                <div key={testPour.id} className=\"border rounded-lg p-3 space-y-3\">\n                                  <div className=\"flex items-center justify-between\">\n                                    <Label className=\"text-sm font-medium\">Test Pour</Label>\n                                    <Button\n                                      variant=\"outline\"\n                                      size=\"sm\"\n                                      onClick={() => handleRemovePumperTestPour(breakdown.pumperName, testPour.id)}\n                                    >\n                                      <Trash2 className=\"h-4 w-4\" />\n                                    </Button>\n                                  </div>\n\n                                  <div>\n                                    <Label className=\"text-xs text-muted-foreground mb-1 block\">Nozzle *</Label>\n                                    <Select\n                                      value={testPour.nozzleId || ''}\n                                      onValueChange={(value) => handleUpdatePumperTestPour(breakdown.pumperName, testPour.id, 'nozzleId', value)}\n                                    >\n                                      <SelectTrigger className=\"w-full\">\n                                        <SelectValue placeholder=\"Select assigned nozzle\" />\n                                      </SelectTrigger>\n                                      <SelectContent>\n                                        {assignedNozzles.length === 0 ? (\n                                          <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">No nozzles assigned</div>\n                                        ) : (\n                                          assignedNozzles.map((nozzle) => {\n                                            const fuelType = nozzle.tank?.fuel?.name || 'Unknown'\n                                            const pumpNumber = nozzle.pump?.pumpNumber || '?'\n                                            return (\n                                              <SelectItem key={nozzle.id} value={nozzle.id}>\n                                                P-{pumpNumber} N-{nozzle.nozzleNumber} ({fuelType.replace(/_/g, ' ')})\n                                              </SelectItem>\n                                            )\n                                          })\n                                        )}\n                                      </SelectContent>\n                                    </Select>\n                                  </div>\n\n                                  <div>\n                                    <Label className=\"text-xs text-muted-foreground mb-1 block\">Amount (L) *</Label>\n                                    <Input\n                                      type=\"number\"\n                                      value={testPour.amount}\n                                      onChange={(e) => handleUpdatePumperTestPour(breakdown.pumperName, testPour.id, 'amount', parseFloat(e.target.value) || 0)}\n                                      placeholder=\"Enter amount in liters\"\n                                      min=\"0\"\n                                      step=\"0.1\"\n                                      className=\"w-full\"\n                                    />\n                                  </div>\n\n                                  <div>\n                                    <Label className=\"text-xs text-muted-foreground mb-1 block\">Reason *</Label>\n                                    <Select\n                                      value={testPour.reason || ''}\n                                      onValueChange={(value) => handleUpdatePumperTestPour(breakdown.pumperName, testPour.id, 'reason', value)}\n                                    >\n                                      <SelectTrigger className=\"w-full\">\n                                        <SelectValue placeholder=\"Select reason\" />\n                                      </SelectTrigger>\n                                      <SelectContent>\n                                        <SelectItem value=\"daily_check\">Daily Check</SelectItem>\n                                        <SelectItem value=\"customer_complaint\">Customer Complaint</SelectItem>\n                                        <SelectItem value=\"maintenance\">Maintenance</SelectItem>\n                                        <SelectItem value=\"calibration\">Calibration</SelectItem>\n                                        <SelectItem value=\"random_test\">Random Test</SelectItem>\n                                        <SelectItem value=\"other\">Other</SelectItem>\n                                      </SelectContent>\n                                    </Select>\n                                  </div>\n\n                                  <div className=\"flex items-center gap-2\">\n                                    <Checkbox\n                                      checked={testPour.returned}\n                                      onCheckedChange={(checked) => handleUpdatePumperTestPour(breakdown.pumperName, testPour.id, 'returned', checked === true)}\n                                    />\n                                    <Label className=\"text-xs text-muted-foreground cursor-pointer\">\n                                      Fuel returned to tank\n                                    </Label>\n                                  </div>\n\n                                  <div>\n                                    <Label className=\"text-xs text-muted-foreground mb-1 block\">Notes (Optional)</Label>\n                                    <Input\n                                      value={testPour.notes || ''}\n                                      onChange={(e) => handleUpdatePumperTestPour(breakdown.pumperName, testPour.id, 'notes', e.target.value)}\n                                      placeholder=\"Additional notes\"\n                                      className=\"w-full\"\n                                    />\n                                  </div>\n                                </div>\n                              )\n                            })}\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Advance Taken */}\n                      <div className=\"space-y-2\">\n                        <Label className=\"flex items-center gap-2\">\n                          <Wallet className=\"h-4 w-4\" />\n                          Advance Taken from Sales\n                        </Label>\n                        <MoneyInput\n                          value={breakdown.advanceTaken}\n                          onChange={(value) => handleUpdatePumperAdvance(breakdown.pumperName, value)}\n                          placeholder=\"0.00\"\n                          className=\"w-full\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\">\n                          Money taken as advance FROM CASH SALES (will be deducted from cash declared above).\n                          Advance can only be taken from cash, not from card/credit/cheque.\n                          {(() => {\n                            const pumper = pumpers.find(p => p.name === breakdown.pumperName)\n                            const pumperId = pumper?.id\n                            const monthlyRental = pumperId ? (pumperMonthlyRentals[pumperId] || 0) : 0\n                            const ADVANCE_LIMIT = 50000\n                            const availableLimit = ADVANCE_LIMIT - monthlyRental\n\n                            return (\n                              <>\n                                <span className=\"block mt-1 text-blue-600 dark:text-blue-400 font-medium\">\n                                   Advance Limit: Rs. {availableLimit.toLocaleString()}\n                                  {monthlyRental > 0 && ` (Limit: Rs. 50,000 - Monthly Rental: Rs. ${monthlyRental.toLocaleString()})`}\n                                </span>\n                                {breakdown.advanceTaken > 0 && breakdown.declaredCash >= 0 && (\n                                  <span className=\"block mt-1 text-orange-600 dark:text-orange-400\">\n                                    Cash after advance: Rs. {(breakdown.declaredCash - breakdown.advanceTaken).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    (Rs. {breakdown.declaredCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} declared - Rs. {breakdown.advanceTaken.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} advance)\n                                  </span>\n                                )}\n                                {breakdown.advanceTaken > (breakdown.declaredCash || 0) && (\n                                  <span className=\"block mt-1 text-red-600 dark:text-red-400 font-medium\">\n                                     Warning: Advance exceeds cash declared. Advance can only be taken from cash sales.\n                                  </span>\n                                )}\n                                {breakdown.advanceTaken > availableLimit && (\n                                  <span className=\"block mt-1 text-red-600 dark:text-red-400 font-medium\">\n                                     Limit Exceeded: Advance + Monthly Rental cannot exceed Rs. 50,000!\n                                  </span>\n                                )}\n                              </>\n                            )\n                          })()}\n                        </p>\n                      </div>\n\n                      {/* Other Pumper Advances (Given from this pumper's cash) */}\n                      <div className=\"space-y-3 pt-2 border-t\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"flex items-center gap-2 text-sm font-medium\">\n                            <Wallet className=\"h-4 w-4\" />\n                            Advances Given to Other Pumpers\n                          </Label>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleAddOtherPumperAdvance(breakdown.pumperName)}\n                            className=\"text-xs\"\n                          >\n                            <Plus className=\"h-3 w-3 mr-1\" />\n                            Add\n                          </Button>\n                        </div>\n\n                        {(() => {\n                          const otherAdvances = otherPumperAdvances[breakdown.pumperName] || []\n                          const advanceTaken = breakdown.advanceTaken || 0\n                          const otherAdvancesTotal = otherAdvances.reduce((sum, a) => sum + a.amount, 0)\n                          const totalAdvances = advanceTaken + otherAdvancesTotal\n                          const availableCash = breakdown.declaredCash || 0\n                          const cashAfterAllAdvances = availableCash - totalAdvances\n\n                          // Get all pumpers who worked the same shift, EXCEPT the current pumper\n                          // Show all other pumpers from this shift (breakdown.pumperName is excluded)\n                          const availablePumpers = pumperBreakdowns\n                            .filter(b => b.pumperName !== breakdown.pumperName)\n                            .map(b => ({\n                              id: b.pumperName, // Use pumperName as both ID and value\n                              name: b.pumperName\n                            }))\n\n                          return (\n                            <div className=\"space-y-3\">\n                              {otherAdvances.map((advance, index) => (\n                                <div key={index} className=\"border rounded-lg p-3 space-y-2 bg-muted/30\">\n                                  <div className=\"flex items-center justify-between mb-2\">\n                                    <Label className=\"text-xs font-medium\">Advance #{index + 1}</Label>\n                                    <Button\n                                      type=\"button\"\n                                      variant=\"ghost\"\n                                      size=\"sm\"\n                                      onClick={() => handleRemoveOtherPumperAdvance(breakdown.pumperName, index)}\n                                      className=\"h-6 w-6 p-0 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950\"\n                                    >\n                                      <Trash2 className=\"h-3 w-3\" />\n                                    </Button>\n                                  </div>\n\n                                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                                    <div className=\"space-y-1\">\n                                      <Label className=\"text-xs\">Pumper *</Label>\n                                      <Select\n                                        value={advance.pumperId}\n                                        onValueChange={(value) => handleUpdateOtherPumperAdvance(breakdown.pumperName, index, 'pumperId', value)}\n                                      >\n                                        <SelectTrigger className=\"h-8 text-xs\">\n                                          <SelectValue placeholder=\"Select pumper\" />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                          {availablePumpers.length === 0 ? (\n                                            <div className=\"px-2 py-1.5 text-xs text-muted-foreground\">\n                                              No other pumpers on this shift\n                                            </div>\n                                          ) : (\n                                            availablePumpers.map((pumper) => (\n                                              <SelectItem key={pumper.id} value={pumper.id} className=\"text-xs\">\n                                                {pumper.name}\n                                              </SelectItem>\n                                            ))\n                                          )}\n                                        </SelectContent>\n                                      </Select>\n                                    </div>\n\n                                    <div className=\"space-y-1\">\n                                      <Label className=\"text-xs\">Amount *</Label>\n                                      <MoneyInput\n                                        value={advance.amount}\n                                        onChange={(value) => handleUpdateOtherPumperAdvance(breakdown.pumperName, index, 'amount', value)}\n                                        placeholder=\"0.00\"\n                                        className=\"w-full h-8 text-xs\"\n                                      />\n                                    </div>\n                                  </div>\n\n                                  {advance.pumperName && (\n                                    <p className=\"text-xs text-muted-foreground\">\n                                      Given to <strong>{advance.pumperName}</strong>\n                                    </p>\n                                  )}\n                                </div>\n                              ))}\n\n                              {otherAdvances.length > 0 && (\n                                <div className=\"pt-2 border-t space-y-1\">\n                                  <div className=\"flex justify-between text-xs\">\n                                    <span className=\"text-muted-foreground\">Advance Taken:</span>\n                                    <span className=\"font-mono\">Rs. {advanceTaken.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                  </div>\n                                  <div className=\"flex justify-between text-xs\">\n                                    <span className=\"text-muted-foreground\">Advances Given:</span>\n                                    <span className=\"font-mono\">Rs. {otherAdvancesTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                  </div>\n                                  <div className=\"flex justify-between text-xs font-medium\">\n                                    <span>Total Advances:</span>\n                                    <span className=\"font-mono\">Rs. {totalAdvances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>\n                                  </div>\n                                  <div className=\"flex justify-between text-xs font-medium\">\n                                    <span>Cash After All Advances:</span>\n                                    <span className={`font-mono ${cashAfterAllAdvances < 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>\n                                      Rs. {cashAfterAllAdvances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                  </div>\n                                  {totalAdvances > availableCash && (\n                                    <p className=\"text-xs text-red-600 dark:text-red-400 font-medium mt-1\">\n                                       Warning: Total advances exceed cash declared. Advances can only come from cash.\n                                    </p>\n                                  )}\n                                </div>\n                              )}\n\n                              {otherAdvances.length === 0 && (\n                                <p className=\"text-xs text-muted-foreground italic\">\n                                  No advances given to other pumpers\n                                </p>\n                              )}\n                            </div>\n                          )\n                        })()}\n                      </div>\n\n                      {/* Expenses */}\n                      <div className=\"space-y-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4\" />\n                            Expenses (Money Used by Manager)\n                          </Label>\n                          <div className=\"flex items-center gap-2\">\n                            <Select onValueChange={(type) => handleAddPumperExpense(breakdown.pumperName, type as 'BANK_DEPOSIT' | 'LOAN_GIVEN' | 'OTHER')}>\n                              <SelectTrigger className=\"w-48\">\n                                <SelectValue placeholder=\"Add expense\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"BANK_DEPOSIT\">Bank Deposit (Owner&apos;s Account)</SelectItem>\n                                <SelectItem value=\"LOAN_GIVEN\">Loan to Pumper</SelectItem>\n                                <SelectItem value=\"OTHER\">Other Expense</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <Button size=\"sm\">\n                              <Plus className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </div>\n\n                        {breakdown.expenses.map((expense) => (\n                          <div key={expense.id} className=\"border rounded-lg p-3 space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <Label className=\"text-sm font-medium\">\n                                {expense.type === 'BANK_DEPOSIT' ? 'Bank Deposit (Owner&apos;s Account)' :\n                                  expense.type === 'LOAN_GIVEN' ? 'Loan to Pumper' :\n                                    'Other Expense'}\n                              </Label>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => handleRemovePumperExpense(breakdown.pumperName, expense.id)}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n\n                            {/* Bank Deposit Fields */}\n                            {expense.type === 'BANK_DEPOSIT' && (\n                              <>\n                                <div className=\"mb-2 p-2 bg-blue-500/10 dark:bg-blue-500/20 rounded border border-blue-500/20\">\n                                  <p className=\"text-xs text-blue-700 dark:text-blue-300\">\n                                    <strong>Note:</strong> Money taken from this pumper&apos;s sales and deposited to owner&apos;s bank account\n                                  </p>\n                                </div>\n                                <div>\n                                  <div>\n                                    <div className=\"flex items-center justify-between mb-1\">\n                                      <Label className=\"text-xs text-muted-foreground\">Owner&apos;s Bank Account *</Label>\n                                      <Dialog open={addBankDialogOpen} onOpenChange={setAddBankDialogOpen}>\n                                        <DialogTrigger asChild>\n                                          <Button\n                                            variant=\"ghost\"\n                                            size=\"sm\"\n                                            className=\"h-6 text-xs\"\n                                            type=\"button\"\n                                            onClick={(e) => {\n                                              e.preventDefault()\n                                              setAddBankDialogOpen(true)\n                                            }}\n                                          >\n                                            <Plus className=\"h-3 w-3 mr-1\" />\n                                            Add Bank\n                                          </Button>\n                                        </DialogTrigger>\n                                      </Dialog>\n                                    </div>\n                                    <Select\n                                      value={expense.bankId || ''}\n                                      onValueChange={(value) => {\n                                        const selectedBank = banks.find(b => b.id === value)\n                                        handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'bankId', value)\n                                        if (selectedBank) {\n                                          handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'bankName', selectedBank.name)\n                                          // Automatically set account number from selected bank\n                                          handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'accountNumber', selectedBank.accountNumber || '')\n                                        }\n                                      }}\n                                    >\n                                      <SelectTrigger className=\"w-full\">\n                                        <SelectValue placeholder=\"Select owner's bank account\" />\n                                      </SelectTrigger>\n                                      <SelectContent>\n                                        {banks.length === 0 ? (\n                                          <div className=\"px-2 py-1.5 text-xs text-muted-foreground text-center\">\n                                            No banks available. Click &quot;Add Bank&quot; above to create one.\n                                          </div>\n                                        ) : (\n                                          banks.map((bank) => (\n                                            <SelectItem key={bank.id} value={bank.id}>\n                                              <div className=\"flex flex-col\">\n                                                <div className=\"flex items-center gap-2\">\n                                                  <Building2 className=\"h-4 w-4\" />\n                                                  <span className=\"font-medium\">{bank.name}{bank.branch && ` - ${bank.branch}`}</span>\n                                                </div>\n                                                {bank.accountNumber && (\n                                                  <span className=\"text-xs text-muted-foreground ml-6\">Account: {bank.accountNumber}</span>\n                                                )}\n                                              </div>\n                                            </SelectItem>\n                                          ))\n                                        )}\n                                        <div className=\"border-t mt-1 pt-1\">\n                                          <Button\n                                            variant=\"ghost\"\n                                            className=\"w-full justify-start text-xs\"\n                                            type=\"button\"\n                                            onClick={(e) => {\n                                              e.preventDefault()\n                                              setAddBankDialogOpen(true)\n                                            }}\n                                          >\n                                            <Plus className=\"h-3 w-3 mr-2\" />\n                                            Add New Bank\n                                          </Button>\n                                          <Button\n                                            variant=\"ghost\"\n                                            className=\"w-full justify-start text-xs text-blue-600 dark:text-blue-400\"\n                                            type=\"button\"\n                                            onClick={() => router.push('/settings/banks')}\n                                          >\n                                            <ExternalLink className=\"h-3 w-3 mr-2\" />\n                                            Manage All Banks\n                                          </Button>\n                                        </div>\n                                      </SelectContent>\n                                    </Select>\n                                    {banks.length > 0 && (\n                                      <p className=\"text-xs text-muted-foreground mt-1\">\n                                        Don&apos;t see your bank? Click &quot;Add Bank&quot; or{' '}\n                                        <Button variant=\"link\" className=\"h-auto p-0 text-xs\" onClick={() => router.push('/settings/banks')}>\n                                          manage all banks\n                                        </Button>\n                                      </p>\n                                    )}\n                                  </div>\n                                  {expense.bankId && banks.find(b => b.id === expense.bankId)?.accountNumber && (\n                                    <p className=\"text-xs text-muted-foreground mt-1\">\n                                      Account: {banks.find(b => b.id === expense.bankId)?.accountNumber}\n                                    </p>\n                                  )}\n                                </div>\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Deposited By (Manager/Owner)</Label>\n                                  <Input\n                                    value={expense.depositedBy || ''}\n                                    onChange={(e) => handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'depositedBy', e.target.value)}\n                                    placeholder=\"Enter manager/owner name who deposited\"\n                                    className=\"w-full\"\n                                  />\n                                </div>\n                              </>\n                            )}\n\n                            {/* Loan Given Fields */}\n                            {expense.type === 'LOAN_GIVEN' && (\n                              <>\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Loan Given To (Pumper) *</Label>\n                                  <Select\n                                    value={expense.loanGivenTo || ''}\n                                    onValueChange={(value) => {\n                                      const selectedPumper = pumpers.find(p => p.id === value)\n                                      handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'loanGivenTo', value)\n                                      if (selectedPumper) {\n                                        handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'loanGivenToName', selectedPumper.name)\n                                      }\n                                    }}\n                                  >\n                                    <SelectTrigger className=\"w-full\">\n                                      <SelectValue placeholder=\"Select pumper\" />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                      {pumpers\n                                        .filter(p => p.isActive !== false)\n                                        .map((pumper) => (\n                                          <SelectItem key={pumper.id} value={pumper.id}>\n                                            {pumper.name}\n                                            {pumper.employeeId && ` (${pumper.employeeId})`}\n                                          </SelectItem>\n                                        ))}\n                                    </SelectContent>\n                                  </Select>\n                                  {expense.loanGivenTo && (\n                                    <p className=\"text-xs text-muted-foreground mt-1\">\n                                      {expense.loanGivenToName || pumpers.find(p => p.id === expense.loanGivenTo)?.name || 'Pumper selected'}\n                                    </p>\n                                  )}\n                                </div>\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Loan Given By (Manager) *</Label>\n                                  <Input\n                                    value={expense.loanGivenBy || ''}\n                                    onChange={(e) => handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'loanGivenBy', e.target.value)}\n                                    placeholder=\"Manager name\"\n                                    className=\"w-full\"\n                                  />\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    Manager who authorized the loan\n                                  </p>\n                                </div>\n                                <div>\n                                  <Label className=\"text-xs text-muted-foreground mb-1 block\">Monthly Rental (Rs.)</Label>\n                                  <MoneyInput\n                                    value={expense.monthlyRental || 0}\n                                    onChange={(value) => handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'monthlyRental', value || 0)}\n                                    placeholder=\"0.00\"\n                                    className=\"w-full\"\n                                  />\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    Amount to deduct monthly from pumper&apos;s salary (default: 0)\n                                  </p>\n                                </div>\n                              </>\n                            )}\n\n                            {/* Other Expense Fields */}\n                            {expense.type === 'OTHER' && (\n                              <div>\n                                <Label className=\"text-xs text-muted-foreground mb-1 block\">Description *</Label>\n                                <Input\n                                  value={expense.description || ''}\n                                  onChange={(e) => handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'description', e.target.value)}\n                                  placeholder=\"Enter expense description\"\n                                  className=\"w-full\"\n                                />\n                              </div>\n                            )}\n\n                            {/* Amount (for all types) */}\n                            <div>\n                              <Label className=\"text-xs text-muted-foreground mb-1 block\">Amount *</Label>\n                              <MoneyInput\n                                value={expense.amount}\n                                onChange={(value) => handleUpdatePumperExpense(breakdown.pumperName, expense.id, 'amount', value)}\n                                placeholder=\"0.00\"\n                                className=\"w-full\"\n                              />\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n\n                      {/* Calculation Summary */}\n                      <div className=\"pt-4 border-t space-y-2 bg-muted/30 dark:bg-muted/20 p-3 rounded-lg\">\n                        <div className=\"space-y-2\">\n                          <div className=\"flex justify-between items-center\">\n                            <Label className=\"text-sm font-medium\">Declared Amount Breakdown:</Label>\n                          </div>\n                          <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                            <div className=\"text-muted-foreground\">Cash (full amount):</div>\n                            <div className=\"font-mono text-right\">Rs. {breakdown.declaredCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n\n                            {(() => {\n                              const otherAdvances = otherPumperAdvances[breakdown.pumperName] || []\n                              const advanceTaken = breakdown.advanceTaken || 0\n                              const otherAdvancesTotal = otherAdvances.reduce((sum, a) => sum + a.amount, 0)\n                              const totalAdvances = advanceTaken + otherAdvancesTotal\n\n                              if (totalAdvances > 0) {\n                                return (\n                                  <>\n                                    <div className=\"text-muted-foreground text-orange-600 dark:text-orange-400\">Advance Taken (deducted from cash):</div>\n                                    <div className=\"font-mono text-right text-orange-600 dark:text-orange-400\">\n                                      - Rs. {advanceTaken.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </div>\n                                    {otherAdvancesTotal > 0 && (\n                                      <>\n                                        <div className=\"text-muted-foreground text-orange-600 dark:text-orange-400\">Advances Given (deducted from cash):</div>\n                                        <div className=\"font-mono text-right text-orange-600 dark:text-orange-400\">\n                                          - Rs. {otherAdvancesTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                        </div>\n                                      </>\n                                    )}\n                                    <div className=\"text-muted-foreground font-medium\">Total Advances:</div>\n                                    <div className=\"font-mono text-right font-medium text-orange-600 dark:text-orange-400\">\n                                      - Rs. {totalAdvances.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </div>\n                                    <div className=\"text-muted-foreground font-medium\">Cash After All Advances:</div>\n                                    <div className=\"font-mono text-right font-medium\">\n                                      Rs. {(breakdown.declaredCash - totalAdvances).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </div>\n                                  </>\n                                )\n                              }\n                              return null\n                            })()}\n\n                            <div className=\"text-muted-foreground\">Card:</div>\n                            <div className=\"font-mono text-right\">\n                              Rs. {Object.values(breakdown.declaredCardAmounts).reduce((sum, amount) => sum + amount, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </div>\n\n                            <div className=\"text-muted-foreground\">Credit:</div>\n                            <div className=\"font-mono text-right\">\n                              Rs. {Object.values(breakdown.declaredCreditAmounts).reduce((sum, amount) => sum + amount, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </div>\n\n                            <div className=\"text-muted-foreground\">Cheque:</div>\n                            <div className=\"font-mono text-right\">Rs. {breakdown.declaredCheque.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n\n                            {(() => {\n                              const bankDeposits = breakdown.expenses.filter(exp => exp.type === 'BANK_DEPOSIT')\n                              const totalBankDeposits = bankDeposits.reduce((sum, exp) => sum + exp.amount, 0)\n                              if (totalBankDeposits > 0) {\n                                return (\n                                  <>\n                                    <div className=\"text-muted-foreground\">Bank Deposits:</div>\n                                    <div className=\"font-mono text-right text-blue-600 dark:text-blue-400\">\n                                      + Rs. {totalBankDeposits.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </div>\n                                  </>\n                                )\n                              }\n                              return null\n                            })()}\n                          </div>\n\n                          <div className=\"flex justify-between items-center pt-2 border-t mt-2\">\n                            <Label className=\"text-sm font-semibold\">Total Declared:</Label>\n                            <div className=\"font-mono font-bold text-base\">\n                              Rs. {breakdown.declaredAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              (Cash {breakdown.declaredCash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} + Card + Credit + Cheque + Bank Deposits)\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Advance (shown for info, but NOT included in variance) and Other Expenses */}\n                        {(() => {\n                          const otherExpenses = breakdown.expenses.filter(exp => exp.type !== 'BANK_DEPOSIT')\n                          const totalOtherExpenses = otherExpenses.reduce((sum, exp) => sum + exp.amount, 0)\n                          const hasDeductions = breakdown.advanceTaken > 0 || totalOtherExpenses > 0\n\n                          if (!hasDeductions) return null\n\n                          return (\n                            <div className=\"space-y-2 pt-2 border-t mt-2\">\n                              {breakdown.advanceTaken > 0 && (\n                                <div className=\"mb-2 p-2 bg-blue-500/10 dark:bg-blue-500/20 rounded border border-blue-500/20\">\n                                  <div className=\"flex justify-between items-center text-xs\">\n                                    <span className=\"text-blue-700 dark:text-blue-300 font-medium\">Advance Taken (from cash):</span>\n                                    <span className=\"font-mono text-blue-700 dark:text-blue-300 font-semibold\">\n                                      Rs. {breakdown.advanceTaken.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                  </div>\n                                  <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\n                                     Note: Advance is tracked separately and will be deducted from salary. It does NOT affect variance calculation.\n                                  </p>\n                                </div>\n                              )}\n\n                              {totalOtherExpenses > 0 && (\n                                <>\n                                  <div className=\"text-xs text-muted-foreground mb-1\">Deductions (Other Expenses):</div>\n                                  <div className=\"flex justify-between items-center text-xs\">\n                                    <span className=\"text-muted-foreground\">Other Expenses (Loans/Other):</span>\n                                    <span className=\"font-mono text-orange-600 dark:text-orange-400\">\n                                      - Rs. {totalOtherExpenses.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                  </div>\n                                </>\n                              )}\n\n                              <div className=\"flex justify-between items-center pt-1 border-t mt-1\">\n                                <Label className=\"text-sm font-semibold\">Effective Declared Amount (for variance):</Label>\n                                <div className=\"font-mono font-bold text-base\">\n                                  Rs. {(breakdown.declaredAmount - totalOtherExpenses).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                </div>\n                                <div className=\"text-xs text-muted-foreground ml-2\">\n                                  (Advance excluded)\n                                </div>\n                              </div>\n                            </div>\n                          )\n                        })()}\n                      </div>\n                    </div>\n\n                    {/* Variance */}\n                    <div>\n                      <Label className=\"text-sm text-muted-foreground mb-1 block\">\n                        Variance\n                      </Label>\n                      <div className={`font-mono font-semibold text-lg ${breakdown.variance > 20\n                        ? 'text-red-600 dark:text-red-400'\n                        : breakdown.variance < -20\n                          ? 'text-green-600 dark:text-green-400'\n                          : 'text-foreground'\n                        }`}>\n                        {breakdown.variance >= 0 ? '+' : ''}Rs. {breakdown.variance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                      </div>\n                      {breakdown.varianceStatus !== 'NORMAL' && (\n                        <p className=\"text-xs mt-1\">\n                          {breakdown.varianceStatus === 'ADD_TO_SALARY'\n                            ? `Add Rs. ${Math.abs(breakdown.variance).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} to salary`\n                            : `Deduct Rs. ${Math.abs(breakdown.variance).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} from salary`}\n                        </p>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Assignment details */}\n                  <div className=\"mt-4 pt-4 border-t\">\n                    <Label className=\"text-sm font-medium mb-2 block\">Assignments:</Label>\n                    <div className=\"space-y-2\">\n                      {breakdown.assignments.map((assignment) => {\n                        const delta = assignment.endMeterReading && assignment.startMeterReading\n                          ? assignment.endMeterReading - assignment.startMeterReading\n                          : 0\n                        const canSales = assignment.canSales || 0\n                        const pumpSales = assignment.pumpSales || Math.max(0, delta - canSales)\n                        const fuelType = assignment.nozzle?.tank?.fuel?.name || 'Unknown'\n                        const nozzleDisplay = assignment.nozzle\n                          ? `P-${assignment.nozzle.pump?.pumpNumber || '?'} N-${assignment.nozzle.nozzleNumber}`\n                          : 'Unknown Nozzle'\n\n                        return (\n                          <div key={assignment.id} className=\"text-xs text-muted-foreground flex items-center justify-between\">\n                            <span>{nozzleDisplay} ({fuelType})</span>\n                            <span className=\"font-mono\">\n                              {pumpSales.toFixed(2)}L\n                            </span>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n\n            {/* Overall Shift Summary */}\n            <div className=\"mt-6 pt-6 border-t\">\n              <h4 className=\"font-semibold mb-4\">Overall Shift Summary</h4>\n\n              {/* Key Metrics */}\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\n                <div className=\"text-center p-4 bg-blue-500/10 dark:bg-blue-500/20 rounded-lg border border-blue-500/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Total Calculated Sales</div>\n                  <div className=\"font-mono font-bold text-lg text-blue-700 dark:text-blue-300\">\n                    Rs. {pumperBreakdowns.reduce((sum, b) => sum + b.calculatedSales, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n                </div>\n                <div className=\"text-center p-4 bg-green-500/10 dark:bg-green-500/20 rounded-lg border border-green-500/20\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Total Declared Amount</div>\n                  <div className=\"font-mono font-bold text-lg text-green-700 dark:text-green-300\">\n                    Rs. {pumperBreakdowns.reduce((sum, b) => sum + b.declaredAmount, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n                </div>\n                <div className={`text-center p-4 rounded-lg border ${pumperBreakdowns.reduce((sum, b) => sum + b.variance, 0) >= 0\n                  ? 'bg-red-500/10 dark:bg-red-500/20 border-red-500/20'\n                  : 'bg-green-500/10 dark:bg-green-500/20 border-green-500/20'\n                  }`}>\n                  <div className=\"text-sm text-muted-foreground mb-1\">Total Variance</div>\n                  <div className={`font-mono font-bold text-lg ${pumperBreakdowns.reduce((sum, b) => sum + b.variance, 0) >= 0\n                    ? 'text-red-700 dark:text-red-300'\n                    : 'text-green-700 dark:text-green-300'\n                    }`}>\n                    {pumperBreakdowns.reduce((sum, b) => sum + b.variance, 0) >= 0 ? '+' : ''}\n                    Rs. {pumperBreakdowns.reduce((sum, b) => sum + b.variance, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                  </div>\n                </div>\n              </div>\n\n              {/* Tender Type Breakdown */}\n              <div className=\"pt-4 border-t\">\n                <h5 className=\"font-semibold mb-3 text-sm\">Tender Type Breakdown (All Pumpers)</h5>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n                  <div className=\"text-center p-3 bg-blue-500/10 dark:bg-blue-500/20 rounded-lg border border-blue-500/20\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Cash</div>\n                    <div className=\"font-mono font-semibold text-blue-700 dark:text-blue-300\">\n                      Rs. {pumperBreakdowns.reduce((sum, b) => sum + b.declaredCash, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-green-500/10 dark:bg-green-500/20 rounded-lg border border-green-500/20\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Card</div>\n                    <div className=\"font-mono font-semibold text-green-700 dark:text-green-300\">\n                      Rs. {pumperBreakdowns.reduce((sum, b) =>\n                        sum + Object.values(b.declaredCardAmounts).reduce((cardSum, amount) => cardSum + amount, 0), 0\n                      ).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-orange-500/10 dark:bg-orange-500/20 rounded-lg border border-orange-500/20\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Credit</div>\n                    <div className=\"font-mono font-semibold text-orange-700 dark:text-orange-300\">\n                      Rs. {pumperBreakdowns.reduce((sum, b) =>\n                        sum + Object.values(b.declaredCreditAmounts).reduce((creditSum, amount) => creditSum + amount, 0), 0\n                      ).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </div>\n                  </div>\n                  <div className=\"text-center p-3 bg-purple-500/10 dark:bg-purple-500/20 rounded-lg border border-purple-500/20\">\n                    <div className=\"text-xs text-muted-foreground mb-1\">Cheque</div>\n                    <div className=\"font-mono font-semibold text-purple-700 dark:text-purple-300\">\n                      Rs. {pumperBreakdowns.reduce((sum, b) => sum + b.declaredCheque, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </FormCard>\n      )}\n\n      <div className=\"flex justify-end gap-4\">\n        <Button variant=\"outline\" onClick={() => router.back()}>\n          Cancel\n        </Button>\n        <Button\n          onClick={handleCloseShiftAndPrint}\n          disabled={loading || !selectedShift || !Array.isArray(assignments) || assignments.some(a => !a.endMeterReading)}\n          className=\"bg-purple-600 hover:bg-purple-700\"\n        >\n          <Printer className=\"h-4 w-4 mr-2\" />\n          {loading ? 'Closing...' : 'Close Shift & Print'}\n        </Button>\n      </div>\n\n      {/* Add Bank Dialog */}\n      <Dialog open={addBankDialogOpen} onOpenChange={setAddBankDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Add New Bank</DialogTitle>\n            <DialogDescription>\n              Add a bank that&apos;s not in the list. It will be available immediately after adding and can be used for cheques and bank deposits.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div>\n              <Label htmlFor=\"newBankName\">Bank Name *</Label>\n              <Input\n                id=\"newBankName\"\n                value={newBank.name}\n                onChange={(e) => setNewBank({ ...newBank, name: e.target.value })}\n                placeholder=\"e.g., Bank of Ceylon, Commercial Bank\"\n                required\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"newBankBranch\">Branch (Optional)</Label>\n              <Input\n                id=\"newBankBranch\"\n                value={newBank.branch}\n                onChange={(e) => setNewBank({ ...newBank, branch: e.target.value })}\n                placeholder=\"e.g., Colombo 07, Kandy\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"newBankAccount\">Account Number (Optional)</Label>\n              <Input\n                id=\"newBankAccount\"\n                value={newBank.accountNumber}\n                onChange={(e) => setNewBank({ ...newBank, accountNumber: e.target.value })}\n                placeholder=\"e.g., 1234567890\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2 pt-2\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => {\n                  setAddBankDialogOpen(false)\n                  setNewBank({ name: '', branch: '', accountNumber: '' })\n                }}\n              >\n                Cancel\n              </Button>\n              <Button type=\"button\" onClick={handleAddBank} disabled={!newBank.name.trim()}>\n                Add Bank\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\shifts\\open\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'availableNozzles' is assigned a value but never used.","line":674,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":674,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport Link from 'next/link'\nimport { useStation } from '@/contexts/StationContext'\nimport { auditLogger } from '@/lib/auditLogger'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport { Clock, Fuel, User, Plus } from 'lucide-react'\nimport { getCurrentUserName } from '@/lib/auth'\nimport { getNozzleShortName, getNozzleDisplayWithBadge } from '@/lib/nozzleUtils'\n\n// Component for Start Meter Reading cell with last reading display\nconst StartMeterCell = ({\n  row,\n  value,\n  onUpdate\n}: {\n  row: Assignment\n  value: number\n  onUpdate: (nozzleId: string, field: keyof Assignment, value: string | number) => void\n}) => {\n  const [lastReading, setLastReading] = useState<number | null>(null)\n  const [loading, setLoading] = useState(true)\n\n  useEffect(() => {\n    // Fetch last end meter reading for this nozzle\n    fetch(`/api/nozzles/${row.nozzleId}/last-reading`)\n      .then(res => res.json())\n      .then(data => {\n        if (data && typeof data.lastEndMeterReading === 'number') {\n          setLastReading(data.lastEndMeterReading)\n        }\n        setLoading(false)\n      })\n      .catch(() => setLoading(false))\n  }, [row.nozzleId])\n\n  const currentValue = value\n  const hasMismatch = lastReading !== null && currentValue > 0 && Math.abs(currentValue - lastReading) > 50\n\n  return (\n    <div className=\"space-y-1\">\n      <div className=\"flex items-center gap-2\">\n        <Input\n          id={`meter-${row.nozzleId}`}\n          type=\"number\"\n          min=\"0\"\n          value={currentValue}\n          onChange={(e) => {\n            const newValue = parseInt(e.target.value) || 0\n            onUpdate(row.nozzleId, 'startMeterReading', newValue)\n          }}\n          placeholder=\"0\"\n          className={`w-full ${hasMismatch ? 'border-amber-300 bg-amber-50' : ''}`}\n        />\n        {!loading && lastReading !== null && (\n          <span className=\"text-xs text-muted-foreground whitespace-nowrap\">\n            Last: {lastReading.toLocaleString()}\n          </span>\n        )}\n      </div>\n      {hasMismatch && (\n        <p className=\"text-xs text-amber-600\">\n           Differs from last reading ({lastReading?.toLocaleString()})\n        </p>\n      )}\n    </div>\n  )\n}\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface ShiftTemplate {\n  id: string\n  name: string\n  startTime: string\n  endTime: string\n  duration: number\n}\n\ninterface Fuel {\n  id: string\n  code: string\n  name: string\n  icon?: string | null\n}\n\n// Unified Nozzle interface used for both API responses and state\ninterface Nozzle {\n  id: string\n  pumpId: string\n  tankId: string\n  nozzleNumber: string\n  fuelId: string\n  fuel?: Fuel\n  pumpNumber: string\n  // Optional tank prop for mapping\n  tank?: { fuelId: string; fuel?: Fuel }\n}\n\n// Unified Pumper interface\ninterface Pumper {\n  id: string\n  name: string\n  employeeId: string\n  status: string\n  shift?: string\n  experience: number\n  rating: number\n}\n\ninterface Assignment {\n  nozzleId: string\n  nozzleNumber: string\n  fuelId: string\n  fuel?: Fuel\n  pumpNumber: string\n  pumperId: string\n  pumperName: string\n  startMeterReading: number\n}\n\ninterface ShiftAssignment {\n  id?: string\n  nozzleId: string\n  status?: string\n  pumperName?: string\n}\n\ninterface ActiveShift {\n  id: string\n  status: string\n  assignments?: ShiftAssignment[]\n}\n\nexport default function OpenShiftPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [shiftTemplates, setShiftTemplates] = useState<ShiftTemplate[]>([])\n  const [nozzles, setNozzles] = useState<Nozzle[]>([])\n  const [unavailableNozzles, setUnavailableNozzles] = useState<Nozzle[]>([])\n  const [pumpers, setPumpers] = useState<Pumper[]>([])\n  const [activeNozzleIds, setActiveNozzleIds] = useState<Set<string>>(new Set())\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  // Form state\n  const { selectedStation } = useStation()\n  const [selectedTemplate, setSelectedTemplate] = useState('')\n  const [startTime, setStartTime] = useState<Date>(new Date())\n  const [assignments, setAssignments] = useState<Assignment[]>([])\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        console.log('Loading stations and templates...')\n        const [stationsRes, templatesRes] = await Promise.all([\n          fetch('/api/stations?active=true'),\n          fetch('/api/shift-templates?active=true')\n        ])\n\n        console.log('Stations response:', stationsRes.status)\n        console.log('Templates response:', templatesRes.status)\n\n        if (!stationsRes.ok) {\n          throw new Error(`Stations API error: ${stationsRes.status}`)\n        }\n        if (!templatesRes.ok) {\n          throw new Error(`Templates API error: ${templatesRes.status}`)\n        }\n\n        const stationsData = await stationsRes.json()\n        const templatesData = await templatesRes.json()\n\n        console.log('Stations data:', stationsData)\n        console.log('Templates data:', templatesData)\n\n        setStations(stationsData)\n        setShiftTemplates(templatesData)\n      } catch (err) {\n        console.error('Error loading data:', err)\n        setError(`Failed to load data: ${err instanceof Error ? err.message : 'Unknown error'}`)\n      }\n    }\n\n    loadData()\n  }, [])\n\n  // Load nozzles and pumpers when station changes\n  useEffect(() => {\n    if (selectedStation) {\n      const loadStationData = async () => {\n        try {\n          console.log('Loading data for station:', selectedStation)\n          const [nozzlesRes, pumpersRes, activeShiftsRes] = await Promise.all([\n            fetch(`/api/tanks?stationId=${selectedStation}&type=nozzles`),\n            fetch(`/api/pumpers?stationId=${selectedStation}&active=true`),\n            fetch(`/api/shifts?active=true`) // Check ALL active shifts across all stations\n          ])\n\n          console.log('Nozzles response:', nozzlesRes.status)\n          console.log('Pumpers response:', pumpersRes.status)\n          console.log('Active shifts response:', activeShiftsRes.status)\n\n          // Handle responses - gracefully handle errors without throwing\n          let nozzlesData: Nozzle[] = []\n          let pumpersData: Pumper[] = []\n          let activeShiftsData: { shifts: ActiveShift[] } = { shifts: [] }\n\n          if (!nozzlesRes.ok) {\n            const errorData = await nozzlesRes.json().catch(() => ({}))\n            console.error('Nozzles API error:', nozzlesRes.status, errorData)\n            // Continue with empty array instead of throwing\n            nozzlesData = []\n          } else {\n            const rawNozzlesData = await nozzlesRes.json()\n            // Transform API response to flatten nested structure\n            nozzlesData = rawNozzlesData.map((nozzle: {\n              id: string\n              pumpId: string\n              tankId: string\n              nozzleNumber: string\n              fuelId?: string\n              tank?: { fuelId: string; fuel?: { id: string; code?: string; name: string; icon?: string | null } }\n              fuel?: { id: string; code?: string; name: string; icon?: string | null }\n              pump?: { pumpNumber: string }\n              pumpNumber?: string\n            }) => ({\n              id: nozzle.id,\n              pumpId: nozzle.pumpId,\n              tankId: nozzle.tankId,\n              nozzleNumber: nozzle.nozzleNumber,\n              fuelId: nozzle.tank?.fuelId || nozzle.fuelId || '',\n              // Ensure fuel has all required properties for Fuel interface\n              fuel: (nozzle.tank?.fuel || nozzle.fuel) ? {\n                id: (nozzle.tank?.fuel || nozzle.fuel)!.id,\n                code: (nozzle.tank?.fuel || nozzle.fuel)!.code || 'UNK', // Default code if missing\n                name: (nozzle.tank?.fuel || nozzle.fuel)!.name,\n                icon: (nozzle.tank?.fuel || nozzle.fuel)!.icon\n              } : undefined,\n              pumpNumber: nozzle.pump?.pumpNumber || nozzle.pumpNumber || '?'\n            }))\n          }\n\n          if (!pumpersRes.ok) {\n            const errorData = await pumpersRes.json().catch(() => ({}))\n            console.error('Pumpers API error:', pumpersRes.status, errorData)\n            // Continue with empty array instead of throwing\n            pumpersData = []\n          } else {\n            pumpersData = await pumpersRes.json()\n          }\n\n          if (!activeShiftsRes.ok) {\n            const errorData = await activeShiftsRes.json().catch(() => ({}))\n            console.error('Active shifts API error:', activeShiftsRes.status, errorData)\n            // Continue with empty array instead of throwing\n            activeShiftsData = { shifts: [] }\n          } else {\n            activeShiftsData = await activeShiftsRes.json()\n          }\n\n          // Ensure we have arrays\n          const nozzles = Array.isArray(nozzlesData) ? nozzlesData : []\n          const pumpers = Array.isArray(pumpersData) ? pumpersData : []\n          const activeShifts = activeShiftsData?.shifts || (Array.isArray(activeShiftsData) ? activeShiftsData : [])\n\n          console.log('Nozzles data:', nozzles)\n          console.log('Pumpers data:', pumpers)\n          console.log('Active shifts data:', activeShifts)\n\n          // Get all assigned nozzle IDs from ACTIVE assignments in active shifts\n          // Check ALL active shifts across ALL stations, not just current station\n          // Only nozzles with ACTIVE assignments should be excluded\n          // CLOSED assignments mean the nozzle is available again\n          const assignedNozzleIds = new Set<string>()\n          if (Array.isArray(activeShifts)) {\n            console.log(' Checking', activeShifts.length, 'active shift(s)')\n            for (const shift of activeShifts) {\n              console.log(' Shift:', shift.id, 'Status:', shift.status, 'Has assignments:', !!shift.assignments, 'Assignments type:', typeof shift.assignments, 'Is array:', Array.isArray(shift.assignments))\n\n              // Only check OPEN shifts\n              if (shift.status === 'OPEN') {\n                let assignments = shift.assignments\n\n                // If assignments are missing or empty, fetch them directly\n                if (!assignments || !Array.isArray(assignments) || assignments.length === 0) {\n                  console.log(' Assignments missing or empty, fetching directly from API...')\n                  try {\n                    const assignmentsRes = await fetch(`/api/shifts/${shift.id}/assignments`)\n                    if (assignmentsRes.ok) {\n                      const assignmentsData = await assignmentsRes.json()\n                      assignments = Array.isArray(assignmentsData) ? assignmentsData : []\n                      console.log(' Fetched', assignments.length, 'assignments directly from API')\n                    }\n                  } catch (err) {\n                    console.error(' Error fetching assignments:', err)\n                    assignments = []\n                  }\n                }\n\n                if (assignments && Array.isArray(assignments) && assignments.length > 0) {\n                  console.log(' Shift has', assignments.length, 'assignments')\n                  for (const assignment of assignments) {\n                    console.log(' Assignment:', {\n                      id: assignment.id,\n                      nozzleId: assignment.nozzleId,\n                      status: assignment.status,\n                      pumperName: assignment.pumperName\n                    })\n\n                    // Only exclude nozzles with ACTIVE assignments\n                    // If status is not provided, assume ACTIVE (backward compatibility)\n                    const assignmentStatus = assignment.status || 'ACTIVE'\n                    if (assignment.nozzleId && assignmentStatus === 'ACTIVE') {\n                      // Ensure we're using string IDs consistently\n                      const nozzleId = String(assignment.nozzleId)\n                      assignedNozzleIds.add(nozzleId)\n                      console.log(` Found ACTIVE assignment: nozzleId=${nozzleId}, shift=${shift.id}, status=${assignmentStatus}`)\n                    } else {\n                      console.log(` Skipping assignment: nozzleId=${assignment.nozzleId}, status=${assignmentStatus}`)\n                    }\n                  }\n                } else {\n                  console.log(' Shift has no assignments after fetch attempt')\n                }\n              } else {\n                console.log(' Shift status is not OPEN:', shift.status)\n              }\n            }\n          } else {\n            console.log(' Active shifts is not an array:', activeShifts)\n          }\n\n          console.log(' Total active nozzle IDs found:', assignedNozzleIds.size, Array.from(assignedNozzleIds))\n\n          console.log('Assigned nozzle IDs (ACTIVE only):', Array.from(assignedNozzleIds))\n          console.log('Total nozzles before filtering:', nozzles.length)\n          console.log('All nozzle IDs:', nozzles.map(n => n.id))\n\n          // Filter out already assigned nozzles (only those with ACTIVE assignments)\n          const availableNozzles = nozzles.filter((nozzle: Nozzle) => {\n            // Ensure we're comparing strings\n            const nozzleId = String(nozzle.id)\n            const isActive = assignedNozzleIds.has(nozzleId)\n            if (isActive) {\n              console.log(` FILTERING OUT ACTIVE NOZZLE: ${nozzleId} - ${nozzle.pumpNumber}-${nozzle.nozzleNumber}`)\n            } else {\n              console.log(` KEEPING AVAILABLE NOZZLE: ${nozzleId} - ${nozzle.pumpNumber}-${nozzle.nozzleNumber}`)\n            }\n            return !isActive\n          })\n\n          const unavailableNozzles = nozzles.filter((nozzle: Nozzle) =>\n            assignedNozzleIds.has(nozzle.id)\n          )\n\n          console.log(' Available nozzles after filtering:', availableNozzles.length, availableNozzles.map(n => `${n.pumpNumber}-${n.nozzleNumber} (${n.id})`))\n          console.log(' Unavailable nozzles:', unavailableNozzles.length, unavailableNozzles.map(n => `${n.pumpNumber}-${n.nozzleNumber} (${n.id})`))\n\n          // CRITICAL: Store ONLY available nozzles for dropdown (filter out active ones)\n          // This is the ONLY place we set nozzles state - it should ONLY contain available nozzles\n          setNozzles(availableNozzles)\n          setUnavailableNozzles(unavailableNozzles)\n          setPumpers(pumpers)\n\n          // Store assigned nozzle IDs for display message and validation\n          setActiveNozzleIds(assignedNozzleIds)\n\n          console.log(' State updated - nozzles state now has', availableNozzles.length, 'nozzles')\n\n          // Reset assignments when station changes\n          setAssignments([])\n\n          // Clear any previous errors since we handled API errors gracefully\n          setError('')\n        } catch (err) {\n          console.error('Error loading station data:', err)\n          // Only set error if it's a critical error, not API failures (they're handled above)\n          const errorMessage = err instanceof Error ? err.message : 'Unknown error'\n          // Don't show error if APIs failed gracefully - page will work with empty data\n          if (!errorMessage.includes('API error')) {\n            setError(`Failed to load station data: ${errorMessage}`)\n          }\n        }\n      }\n\n      loadStationData()\n    }\n  }, [selectedStation])\n\n  const handleAddAssignment = async (nozzleId: string) => {\n    // Check if nozzle is active (in activeNozzleIds)\n    if (activeNozzleIds.has(nozzleId)) {\n      setError('This nozzle is already assigned to an active shift and cannot be used.')\n      return\n    }\n\n    // Check if nozzle is already in unavailable list (active in another shift)\n    const isUnavailable = unavailableNozzles.some(n => n.id === nozzleId)\n    if (isUnavailable) {\n      setError('This nozzle is already assigned to an active shift and cannot be used.')\n      return\n    }\n\n    // Check if nozzle is already in current assignments\n    const alreadyAssigned = assignments.some(a => a.nozzleId === nozzleId)\n    if (alreadyAssigned) {\n      setError('This nozzle is already added to the current assignments.')\n      return\n    }\n\n    // Check if nozzle is in available nozzles list\n    const nozzle = nozzles.find(n => n.id === nozzleId)\n    if (!nozzle) {\n      setError('Nozzle not found or not available.')\n      return\n    }\n\n    // Real-time check: Verify nozzle is still available by checking active shifts\n    try {\n      const activeShiftsRes = await fetch('/api/shifts?active=true')\n      if (activeShiftsRes.ok) {\n        const activeShiftsData = await activeShiftsRes.json()\n        const activeShifts = activeShiftsData?.shifts || []\n\n        // Check if nozzle is assigned to any active shift\n        for (const shift of activeShifts) {\n          if (shift.status === 'OPEN' && shift.assignments && Array.isArray(shift.assignments)) {\n            const isAssigned = shift.assignments.some((a: ShiftAssignment) =>\n              a.nozzleId === nozzleId && (a.status === 'ACTIVE' || !a.status)\n            )\n            if (isAssigned) {\n              setError('This nozzle is currently assigned to an active shift. Please refresh the page.')\n              // Refresh the nozzle list\n              const station = stations.find(s => s.id === selectedStation)\n              if (station) {\n                // Trigger a reload by clearing and reloading\n                window.location.reload()\n              }\n              return\n            }\n          }\n        }\n      }\n    } catch (err) {\n      console.error('Error checking nozzle availability:', err)\n      // Continue anyway, server will validate\n    }\n\n    // Fetch the last end meter reading for this nozzle\n    let lastEndReading = 0\n    try {\n      const res = await fetch(`/api/nozzles/${nozzleId}/last-reading`)\n      if (res.ok) {\n        const data = await res.json()\n        lastEndReading = data.lastEndMeterReading || 0\n      }\n    } catch (err) {\n      console.error('Failed to fetch last meter reading:', err)\n      // Continue with 0 if fetch fails\n    }\n\n    const newAssignment: Assignment = {\n      nozzleId,\n      nozzleNumber: nozzle.nozzleNumber,\n      fuelId: nozzle.fuelId,\n      fuel: nozzle.fuel,\n      pumpNumber: nozzle.pumpNumber,\n      pumperId: '',\n      pumperName: '',\n      startMeterReading: lastEndReading\n    }\n\n    setAssignments(prev => [...prev, newAssignment])\n    setError('') // Clear any previous errors\n  }\n\n  const handleUpdateAssignment = (nozzleId: string, field: keyof Assignment, value: string | number) => {\n    setAssignments(prev =>\n      prev.map(assignment =>\n        assignment.nozzleId === nozzleId\n          ? { ...assignment, [field]: value }\n          : assignment\n      )\n    )\n  }\n\n  const handleRemoveAssignment = (nozzleId: string) => {\n    const assignment = assignments.find(a => a.nozzleId === nozzleId)\n    if (assignment && confirm(`Remove assignment for ${assignment.nozzleNumber}?`)) {\n      setAssignments(prev => prev.filter(a => a.nozzleId !== nozzleId))\n    }\n  }\n\n  const handleOpenShift = async () => {\n    if (!selectedTemplate || assignments.length === 0) {\n      setError('Please fill in all required fields and add at least one assignment')\n      return\n    }\n\n    // Validate start time is not in the future\n    const now = new Date()\n    if (startTime > now) {\n      setError('Start time cannot be in the future. Please select a valid start time.')\n      return\n    }\n\n    // Validate start time is not too old (more than 7 days ago)\n    const sevenDaysAgo = new Date()\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\n    if (startTime < sevenDaysAgo) {\n      setError('Start time cannot be more than 7 days ago. Please select a recent start time.')\n      return\n    }\n\n    // Validate that all assignments have pumpers selected\n    const incompleteAssignments = assignments.filter(a => !a.pumperId || !a.pumperName)\n    if (incompleteAssignments.length > 0) {\n      setError('Please select a pumper for all nozzle assignments')\n      return\n    }\n\n    // Validate that all assignments have valid start meter readings\n    const invalidMeterReadings = assignments.filter(a => !a.startMeterReading || a.startMeterReading < 0)\n    if (invalidMeterReadings.length > 0) {\n      setError('Please enter valid start meter readings for all assignments (must be >= 0)')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      // Create shift\n      const shiftData = {\n        stationId: selectedStation,\n        templateId: selectedTemplate,\n        startTime: startTime.toISOString(),\n        openedBy: getCurrentUserName()\n      }\n\n      console.log('Creating shift with data:', shiftData)\n\n      const shiftRes = await fetch('/api/shifts', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(shiftData)\n      })\n\n      if (!shiftRes.ok) {\n        const errorData = await shiftRes.json()\n        console.error('Shift creation error:', errorData)\n\n        // Handle specific error cases with user-friendly messages\n        if (errorData.error === 'Another shift is already active at this station') {\n          throw new Error('There is already an open shift at this station. Please close the existing shift before opening a new one.')\n        }\n\n        // Handle validation errors\n        if (errorData.error && errorData.error.includes('validation')) {\n          throw new Error(`Please check your input: ${errorData.error}`)\n        }\n\n        throw new Error(`Failed to create shift: ${errorData.error || 'Unknown error'}`)\n      }\n\n      const shift = await shiftRes.json()\n\n      // Get station and template names for audit logging\n      const station = stations.find(s => s.id === selectedStation)\n      const template = shiftTemplates.find(t => t.id === selectedTemplate)\n\n      // Log shift creation\n      if (station && template) {\n        await auditLogger.logShiftCreated(shift.id, station.id, station.name, template.name)\n      }\n\n      // Create assignments\n      for (const assignment of assignments) {\n        try {\n          const assignRes = await fetch(`/api/shifts/${shift.id}/assign`, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              nozzleId: assignment.nozzleId,\n              pumperId: assignment.pumperId,\n              pumperName: assignment.pumperName,\n              startMeterReading: assignment.startMeterReading\n            })\n          })\n\n          if (!assignRes.ok) {\n            const errorData = await assignRes.json().catch(() => ({}))\n            const errorMessage = errorData.error || `Failed to create assignment: ${assignRes.status}`\n            console.error(`Failed to create assignment for nozzle ${assignment.nozzleId}:`, assignRes.status, errorData)\n\n            // If nozzle is already assigned, this is a critical error - stop everything\n            if (errorMessage.includes('already assigned')) {\n              const nozzleDisplay = getNozzleShortName({\n                id: assignment.nozzleId,\n                pumpNumber: assignment.pumpNumber,\n                nozzleNumber: assignment.nozzleNumber,\n                fuelType: assignment.fuel?.name || 'Unknown'\n              })\n              throw new Error(`${nozzleDisplay} is already assigned to an active shift. Please refresh the page to see updated nozzle availability.`)\n            }\n\n            throw new Error(errorMessage)\n          }\n\n          // Log pumper assignment\n          if (station) {\n            const assignData = await assignRes.json()\n            // Format nozzle display name\n            const nozzleDisplayName = getNozzleShortName({\n              id: assignment.nozzleId,\n              pumpNumber: assignment.pumpNumber,\n              nozzleNumber: assignment.nozzleNumber,\n              fuelType: assignment.fuel?.name || 'Unknown'\n            })\n            await auditLogger.logPumperAssigned(\n              assignData.id,\n              assignment.pumperName,\n              nozzleDisplayName,\n              station.id,\n              station.name\n            )\n          }\n        } catch (assignError) {\n          console.error('Error creating assignment:', assignError)\n          throw new Error(`Failed to create assignment: ${assignError instanceof Error ? assignError.message : 'Unknown error'}`)\n        }\n      }\n\n      setSuccess('Shift created successfully! Redirecting to shifts page...')\n      setTimeout(() => {\n        router.push('/shifts')\n      }, 1500)\n    } catch (err) {\n      console.error('Shift creation failed:', err)\n      if (err instanceof Error) {\n        setError(err.message)\n      } else {\n        setError('Failed to open shift. Please try again.')\n      }\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const availableNozzles = nozzles.filter(nozzle =>\n    !assignments.some(assignment => assignment.nozzleId === nozzle.id) &&\n    !activeNozzleIds.has(nozzle.id)\n  )\n\n  const assignmentColumns = [\n    {\n      key: 'nozzleNumber' as keyof Assignment,\n      title: 'Nozzle',\n      render: (value: unknown, row: Assignment) => {\n        const display = getNozzleDisplayWithBadge({\n          id: row.nozzleId,\n          pumpNumber: row.pumpNumber,\n          nozzleNumber: row.nozzleNumber,\n          fuelType: row.fuel?.name || 'Unknown'\n        })\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{display.label}</span>\n            <Badge variant=\"outline\">{display.badge}</Badge>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'pumperName' as keyof Assignment,\n      title: 'Pumper',\n      render: (value: unknown, row: Assignment) => {\n        const selectedPumper = pumpers.find(p => p.id === row.pumperId)\n        return (\n          <Select\n            value={row.pumperId}\n            onValueChange={(pumperId) => {\n              const pumper = pumpers.find(p => p.id === pumperId)\n              handleUpdateAssignment(row.nozzleId, 'pumperId', pumperId)\n              handleUpdateAssignment(row.nozzleId, 'pumperName', pumper?.name || '')\n            }}\n          >\n            <SelectTrigger className=\"w-full\">\n              <SelectValue placeholder=\"Select pumper\">\n                {selectedPumper && (\n                  <div className=\"flex items-center gap-2\">\n                    <User className=\"h-4 w-4 text-muted-foreground\" />\n                    <span>{selectedPumper.name}</span>\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {selectedPumper.experience}y exp\n                    </Badge>\n                  </div>\n                )}\n              </SelectValue>\n            </SelectTrigger>\n            <SelectContent>\n              {pumpers.map((pumper) => (\n                <SelectItem key={pumper.id} value={pumper.id}>\n                  <div className=\"flex items-center gap-2\">\n                    <User className=\"h-4 w-4 text-muted-foreground\" />\n                    <div className=\"flex flex-col\">\n                      <span className=\"font-medium\">{pumper.name}</span>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {pumper.employeeId}  {pumper.experience}y exp  {pumper.rating}\n                      </span>\n                    </div>\n                  </div>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        )\n      }\n    },\n    {\n      key: 'startMeterReading' as keyof Assignment,\n      title: 'Start Meter',\n      render: (value: unknown, row: Assignment) => (\n        <StartMeterCell row={row} value={value as number} onUpdate={handleUpdateAssignment} />\n      )\n    },\n    {\n      key: 'actions' as keyof Assignment,\n      title: 'Actions',\n      render: (value: unknown, row: Assignment) => (\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => handleRemoveAssignment(row.nozzleId)}\n        >\n          Remove\n        </Button>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-2\">\n        <Clock className=\"h-6 w-6 text-purple-600 dark:text-purple-400\" />\n        <h1 className=\"text-2xl font-bold\">Open Shift</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertDescription>\n            <div className=\"flex items-center justify-between\">\n              <span>{error}</span>\n              {error.includes('already an open shift') && (\n                <Link href=\"/shifts/close\">\n                  <Button variant=\"outline\" size=\"sm\" className=\"ml-4\">\n                    Close Existing Shift\n                  </Button>\n                </Link>\n              )}\n            </div>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert className=\"border-green-500/20 dark:border-green-500/30 bg-green-500/10 dark:bg-green-500/20\">\n          <AlertDescription className=\"text-green-700 dark:text-green-300\">\n            {success}\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Shift Details\" description=\"Configure the shift parameters\">\n        {/* Display current station */}\n        <div className=\"mb-4 p-3 bg-blue-500/10 dark:bg-blue-500/20 border border-blue-500/20 dark:border-blue-500/30 rounded-lg\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full\"></div>\n            <span className=\"text-sm font-medium text-blue-700 dark:text-blue-300\">\n              Station: {stations.find(s => s.id === selectedStation)?.name || 'No station selected'}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"template\">Shift Template *</Label>\n            <Select value={selectedTemplate} onValueChange={setSelectedTemplate}>\n              <SelectTrigger id=\"template\">\n                <SelectValue placeholder=\"Select template\" />\n              </SelectTrigger>\n              <SelectContent>\n                {shiftTemplates.map((template) => (\n                  <SelectItem key={template.id} value={template.id}>\n                    {template.name} ({template.startTime} - {template.endTime})\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Start Time *</Label>\n            <DateTimePicker\n              value={startTime}\n              onChange={(date) => setStartTime(date || new Date())}\n              placeholder=\"Select start time\"\n            />\n          </div>\n        </div>\n      </FormCard>\n\n      {selectedStation ? (\n        <FormCard\n          title=\"Nozzle Assignments\"\n          description=\"Assign pumpers to nozzles and set start meter readings\"\n          actions={\n            <div className=\"flex items-center gap-2\">\n              <Select\n                onValueChange={handleAddAssignment}\n                disabled={nozzles.length === 0}\n              >\n                <SelectTrigger className=\"w-48\">\n                  <SelectValue placeholder={nozzles.length === 0 ? \"No nozzles available\" : \"Add nozzle\"} />\n                </SelectTrigger>\n                <SelectContent>\n                  {nozzles.length > 0 ? (\n                    nozzles.map((nozzle) => {\n                      // Safety check: if somehow an active nozzle got through, log it and skip it\n                      if (activeNozzleIds.has(nozzle.id)) {\n                        console.error(' ERROR: Active nozzle found in dropdown!', nozzle.id, nozzle.pumpNumber, nozzle.nozzleNumber)\n                        return null\n                      }\n\n                      const displayName = getNozzleShortName({\n                        id: nozzle.id,\n                        pumpNumber: nozzle.pumpNumber,\n                        nozzleNumber: nozzle.nozzleNumber,\n                        fuelType: nozzle.fuel?.name || 'Unknown'\n                      })\n                      return (\n                        <SelectItem key={nozzle.id} value={nozzle.id}>\n                          {displayName}\n                        </SelectItem>\n                      )\n                    }).filter(Boolean) // Remove any null entries from safety check\n                  ) : (\n                    <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">\n                      No nozzles available\n                    </div>\n                  )}\n                </SelectContent>\n              </Select>\n              <Button\n                size=\"sm\"\n                disabled={nozzles.length === 0}\n                onClick={() => {\n                  if (nozzles.length > 0) {\n                    handleAddAssignment(nozzles[0].id)\n                  }\n                }}\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add\n              </Button>\n            </div>\n          }\n        >\n          {/* Show active nozzles message */}\n          {unavailableNozzles.length > 0 && (\n            <div className=\"mb-4 p-2 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded text-xs\">\n              <span className=\"font-medium text-amber-900 dark:text-amber-200\">Active nozzles:</span>{' '}\n              <span className=\"text-amber-800 dark:text-amber-300\">\n                {unavailableNozzles.map((nozzle, index) => {\n                  const displayName = getNozzleShortName({\n                    id: nozzle.id,\n                    pumpNumber: nozzle.pumpNumber,\n                    nozzleNumber: nozzle.nozzleNumber,\n                    fuelType: nozzle.fuel?.name || 'Unknown'\n                  })\n                  return (\n                    <span key={nozzle.id}>\n                      {index > 0 && ', '}\n                      {displayName}\n                    </span>\n                  )\n                })}\n              </span>\n            </div>\n          )}\n          {assignments.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <User className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n              {nozzles.length === 0 ? (\n                <>\n                  <p>No nozzles available for assignment</p>\n                  <p className=\"text-sm\">All nozzles are currently in use by active shifts</p>\n                </>\n              ) : (\n                <>\n                  <p>No assignments added yet</p>\n                  <p className=\"text-sm\">Add nozzles and assign pumpers to start the shift</p>\n                </>\n              )}\n            </div>\n          ) : (\n            <DataTable\n              data={assignments}\n              columns={assignmentColumns}\n              searchable={false}\n              pagination={false}\n            />\n          )}\n        </FormCard>\n      ) : (\n        <FormCard\n          title=\"Nozzle Assignments\"\n          description=\"Please select a station to manage assignments\"\n        >\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <User className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n            <p>No station selected</p>\n            <p className=\"text-sm\">Select a station from the top navigation to continue</p>\n          </div>\n        </FormCard>\n      )}\n\n      <div className=\"flex justify-end gap-4\">\n        <Button variant=\"outline\" onClick={() => router.back()}>\n          Cancel\n        </Button>\n        <Button\n          onClick={handleOpenShift}\n          disabled={loading || !selectedTemplate || assignments.length === 0}\n          className=\"bg-purple-600 hover:bg-purple-700\"\n        >\n          {loading ? 'Opening...' : 'Open Shift'}\n        </Button>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\shifts\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used.","line":5,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":44},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchShifts'. Either include it or remove the dependency array.","line":202,"column":6,"nodeType":"ArrayExpression","endLine":202,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchShifts, selectedStation]","fix":{"range":[5837,5854],"text":"[fetchShifts, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { useStation } from '@/contexts/StationContext'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport { DataTable } from '@/components/ui/DataTable'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\nimport {\n  Clock,\n  Users,\n  PlayCircle,\n  StopCircle,\n  Calendar,\n  TrendingUp,\n  AlertCircle,\n  Filter,\n  X,\n  Power\n} from 'lucide-react'\nimport Link from 'next/link'\nimport { getCurrentUserName } from '@/lib/auth'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\n\n// Function to format duration in a more readable way\nconst formatDuration = (hours: number): string => {\n  if (hours === 0) return '0h'\n\n  const wholeHours = Math.floor(hours)\n  const minutes = Math.round((hours - wholeHours) * 60)\n\n  if (minutes === 0) {\n    return `${wholeHours}h`\n  } else if (wholeHours === 0) {\n    return `${minutes}m`\n  } else {\n    return `${wholeHours}h ${minutes}m`\n  }\n}\n\nimport { ShiftWithDetails, ShiftStatistics } from '@/types/db'\n\ninterface Shift extends ShiftWithDetails {\n  stationName: string\n  templateName: string\n  durationHours: number\n  totalSales: number\n  totalLiters: number\n  assignmentCount: number\n}\n\ninterface ShiftStats {\n  activeShifts: number\n  todayShifts: number\n  totalSales: number\n  averageShiftDuration: number\n}\n\nexport default function ShiftsPage() {\n  const router = useRouter()\n  const { selectedStation, isAllStations, getSelectedStation } = useStation()\n  const [shifts, setShifts] = useState<Shift[]>([])\n  const [stats, setStats] = useState<ShiftStats>({\n    activeShifts: 0,\n    todayShifts: 0,\n    totalSales: 0,\n    averageShiftDuration: 0\n  })\n  const [loading, setLoading] = useState(true)\n  const [filterOpen, setFilterOpen] = useState(false)\n  const [filters, setFilters] = useState({\n    status: 'all',\n    dateFrom: '',\n    dateTo: '',\n    openedBy: '',\n    minSales: '',\n    maxSales: ''\n  })\n  const [filteredShifts, setFilteredShifts] = useState<Shift[]>([])\n  const [closeAllDialogOpen, setCloseAllDialogOpen] = useState(false)\n  const [closingAll, setClosingAll] = useState(false)\n  const [closeAllError, setCloseAllError] = useState<string | null>(null)\n  const [closeAllSuccess, setCloseAllSuccess] = useState<string | null>(null)\n\n  // Handle row click to navigate to shift details\n  const handleRowClick = (shift: Shift) => {\n    router.push(`/shifts/${shift.id}`)\n  }\n\n  const handleCloseAllActiveShifts = async () => {\n    try {\n      setClosingAll(true)\n      setCloseAllError(null)\n      setCloseAllSuccess(null)\n\n      const url = isAllStations\n        ? '/api/shifts/bulk-close'\n        : `/api/shifts/bulk-close`\n\n      const response = await fetch(url, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          closedBy: getCurrentUserName(),\n          stationId: isAllStations ? undefined : selectedStation\n        })\n      })\n\n      const data = await response.json()\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to close shifts')\n      }\n\n      if (data.failed && data.failed > 0) {\n        setCloseAllError(`Closed ${data.closed} shift(s), but ${data.failed} failed. Check console for details.`)\n      } else {\n        setCloseAllSuccess(`Successfully closed ${data.closed} shift(s).`)\n      }\n\n      // Refresh shifts list\n      await fetchShifts()\n\n      // Close dialog after a short delay\n      setTimeout(() => {\n        setCloseAllDialogOpen(false)\n        setCloseAllSuccess(null)\n        setCloseAllError(null)\n      }, 2000)\n    } catch (error) {\n      console.error('Error closing all shifts:', error)\n      setCloseAllError(error instanceof Error ? error.message : 'Failed to close shifts')\n    } finally {\n      setClosingAll(false)\n    }\n  }\n\n  const handleFilterClick = () => {\n    setFilterOpen(true)\n  }\n\n  const applyFilters = () => {\n    let filtered = [...shifts]\n\n    // Status filter\n    if (filters.status && filters.status !== 'all') {\n      filtered = filtered.filter(shift => shift.status === filters.status)\n    }\n\n    // Date range filter\n    if (filters.dateFrom) {\n      filtered = filtered.filter(shift => new Date(shift.startTime) >= new Date(filters.dateFrom))\n    }\n    if (filters.dateTo) {\n      filtered = filtered.filter(shift => new Date(shift.startTime) <= new Date(filters.dateTo))\n    }\n\n    // Opened by filter\n    if (filters.openedBy) {\n      filtered = filtered.filter(shift =>\n        shift.openedBy.toLowerCase().includes(filters.openedBy.toLowerCase())\n      )\n    }\n\n    // Sales range filter\n    if (filters.minSales) {\n      filtered = filtered.filter(shift => (shift.totalSales || 0) >= parseInt(filters.minSales))\n    }\n    if (filters.maxSales) {\n      filtered = filtered.filter(shift => (shift.totalSales || 0) <= parseInt(filters.maxSales))\n    }\n\n    setFilteredShifts(filtered)\n    setFilterOpen(false)\n  }\n\n  const clearFilters = () => {\n    setFilters({\n      status: 'all',\n      dateFrom: '',\n      dateTo: '',\n      openedBy: '',\n      minSales: '',\n      maxSales: ''\n    })\n    setFilteredShifts(shifts)\n    setFilterOpen(false)\n  }\n\n  const getActiveFilterCount = () => {\n    return Object.values(filters).filter(value => value !== '' && value !== 'all').length\n  }\n\n  useEffect(() => {\n    fetchShifts()\n  }, [selectedStation])\n\n  useEffect(() => {\n    setFilteredShifts(shifts)\n  }, [shifts])\n\n  const fetchShifts = async () => {\n    try {\n      setLoading(true)\n      const url = isAllStations\n        ? '/api/shifts'\n        : `/api/shifts?stationId=${selectedStation}`\n\n      const response = await fetch(url)\n      const data = await response.json()\n\n      // Handle new API response format\n      const shiftsData = data.shifts || data // Support both old and new format\n      const summary = data.summary || {}\n\n      // Transform the data to include station names and use real statistics\n      const transformedShifts: Shift[] = shiftsData.map((shift: ShiftWithDetails) => {\n        // Calculate duration\n        const start = new Date(shift.startTime)\n        const end = shift.endTime ? new Date(shift.endTime) : new Date()\n        const durationHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60)\n\n        // Get actual station and template names from relations\n        const stationName = shift.station?.name || `Station ${shift.stationId}`\n        const templateName = shift.template?.name || `Template ${shift.templateId}`\n\n        // Parse statistics if needed\n        let stats: ShiftStatistics | null = null\n        if (shift.statistics) {\n          if (typeof shift.statistics === 'string') {\n            try { stats = JSON.parse(shift.statistics) } catch { }\n          } else {\n            stats = shift.statistics as unknown as ShiftStatistics\n          }\n        }\n\n        // Count assignments\n        const assignmentCount = shift._count?.assignments ?? 0\n\n        return {\n          ...shift,\n          stationName,\n          templateName,\n          assignmentCount,\n          totalSales: stats?.totalSales || 0,\n          durationHours: Math.round(durationHours * 100) / 100,\n          totalLiters: stats?.totalLiters || 0\n        }\n      })\n\n      setShifts(transformedShifts)\n\n      // Use API summary or calculate from real data\n      const activeShifts = summary.active || transformedShifts.filter((s: Shift) => s.status === 'OPEN').length\n      const today = new Date().toDateString()\n      const todayShifts = transformedShifts.filter((s: Shift) =>\n        new Date(s.startTime).toDateString() === today\n      ).length\n\n      // Calculate real sales from closed shifts with actual data\n      const closedShifts = transformedShifts.filter((s: Shift) => s.status === 'CLOSED' && s.totalSales > 0)\n      const totalSales = closedShifts.reduce((sum: number, s: Shift) => sum + s.totalSales, 0)\n\n      // Calculate average duration from closed shifts with real data\n      const closedShiftsWithDuration = transformedShifts.filter((s: Shift) => s.status === 'CLOSED' && s.durationHours > 0)\n      const averageDuration = closedShiftsWithDuration.length > 0\n        ? closedShiftsWithDuration.reduce((sum: number, s: Shift) => sum + s.durationHours, 0) / closedShiftsWithDuration.length\n        : 0\n\n      setStats({\n        activeShifts,\n        todayShifts,\n        totalSales,\n        averageShiftDuration: Math.round(averageDuration * 100) / 100\n      })\n    } catch (error) {\n      console.error('Error fetching shifts:', error)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const shiftColumns = [\n    {\n      key: 'stationName' as keyof Shift,\n      title: 'Station',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-2 w-2 bg-blue-600 dark:bg-blue-400 rounded-full\"></div>\n          <span className=\"font-medium\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'templateName' as keyof Shift,\n      title: 'Template',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{value as string}</Badge>\n      )\n    },\n    {\n      key: 'status' as keyof Shift,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = value as string\n        return (\n          <Badge variant={status === 'OPEN' ? 'default' : 'secondary'}>\n            {status === 'OPEN' ? (\n              <><PlayCircle className=\"h-3 w-3 mr-1\" /> Open</>\n            ) : (\n              <><StopCircle className=\"h-3 w-3 mr-1\" /> Closed</>\n            )}\n          </Badge>\n        )\n      }\n    },\n    {\n      key: 'startTime' as keyof Shift,\n      title: 'Start Time',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">\n            {new Date(value as string).toLocaleString()}\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'endTime' as keyof Shift,\n      title: 'End Time',\n      render: (value: unknown) => {\n        if (!value) {\n          return <span className=\"text-muted-foreground text-sm\">-</span>\n        }\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"text-sm\">\n              {new Date(value as string).toLocaleString()}\n            </span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'openedBy' as keyof Shift,\n      title: 'Opened By',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Users className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'assignmentCount' as keyof Shift,\n      title: 'Assignments',\n      render: (value: unknown) => (\n        <Badge variant=\"outline\">{value as number} pumpers</Badge>\n      )\n    },\n    {\n      key: 'totalSales' as keyof Shift,\n      title: 'Total Sales',\n      render: (value: unknown) => {\n        if (!value) {\n          return <span className=\"text-muted-foreground text-sm\">-</span>\n        }\n        return (\n          <div className=\"flex items-center gap-1\">\n            <TrendingUp className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n            <span className=\"font-semibold text-green-600 dark:text-green-400\">\n              Rs. {(value as number).toLocaleString()}\n            </span>\n          </div>\n        )\n      }\n    }\n  ]\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 dark:border-purple-400\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Shift Management</h1>\n          <p className=\"text-muted-foreground mt-1\">\n            {isAllStations\n              ? 'Manage shifts across all stations, assignments, and operations'\n              : `Manage shifts for ${getSelectedStation()?.name || 'selected station'}, assignments, and operations`\n            }\n          </p>\n        </div>\n        <div className=\"flex gap-3\">\n          <Link href=\"/shifts/open\">\n            <Button className=\"flex items-center gap-2\">\n              <PlayCircle className=\"h-4 w-4\" />\n              Open Shift\n            </Button>\n          </Link>\n          <Link href=\"/shifts/close\">\n            <Button variant=\"outline\" className=\"flex items-center gap-2\">\n              <StopCircle className=\"h-4 w-4\" />\n              Close Shift\n            </Button>\n          </Link>\n        </div>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Shifts</CardTitle>\n            <PlayCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">{stats.activeShifts}</div>\n            <p className=\"text-xs text-muted-foreground\">Currently running</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Today&apos;s Shifts</CardTitle>\n            <Calendar className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats.todayShifts}</div>\n            <p className=\"text-xs text-muted-foreground\">Started today</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Sales</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-purple-600 dark:text-purple-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">Rs. {stats.totalSales.toLocaleString()}</div>\n            <p className=\"text-xs text-muted-foreground\">Closed shifts today</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Avg Duration</CardTitle>\n            <Clock className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{formatDuration(stats.averageShiftDuration)}</div>\n            <p className=\"text-xs text-muted-foreground\">Per shift</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Active Shifts Alert */}\n      {stats.activeShifts > 0 && (\n        <div className=\"bg-green-500/10 dark:bg-green-500/20 border border-green-500/20 dark:border-green-500/30 rounded-lg p-4\">\n          <div className=\"flex items-center gap-3\">\n            <AlertCircle className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n            <div className=\"flex-1\">\n              <h3 className=\"font-medium text-green-700 dark:text-green-300\">\n                {stats.activeShifts} Active Shift{stats.activeShifts > 1 ? 's' : ''}\n              </h3>\n              <p className=\"text-sm text-green-700 dark:text-green-300\">\n                Monitor ongoing operations and close shifts when complete.\n              </p>\n            </div>\n            <div className=\"flex gap-2 ml-auto\">\n              <Link href=\"/shifts/close\">\n                <Button size=\"sm\" variant=\"outline\" className=\"border-green-500/30 dark:border-green-500/50 text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-500/20\">\n                  Manage Active Shifts\n                </Button>\n              </Link>\n              <Dialog open={closeAllDialogOpen} onOpenChange={setCloseAllDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button\n                    size=\"sm\"\n                    variant=\"destructive\"\n                    className=\"flex items-center gap-2\"\n                  >\n                    <Power className=\"h-4 w-4\" />\n                    Close All Active\n                  </Button>\n                </DialogTrigger>\n                <DialogContent>\n                  <DialogHeader>\n                    <DialogTitle>Close All Active Shifts</DialogTitle>\n                    <DialogDescription>\n                      This will close all {stats.activeShifts} active shift{stats.activeShifts > 1 ? 's' : ''}.\n                      Open assignments will be automatically closed. This action cannot be undone.\n                    </DialogDescription>\n                  </DialogHeader>\n\n                  {closeAllError && (\n                    <Alert variant=\"destructive\">\n                      <AlertCircle className=\"h-4 w-4\" />\n                      <AlertDescription>{closeAllError}</AlertDescription>\n                    </Alert>\n                  )}\n\n                  {closeAllSuccess && (\n                    <Alert className=\"bg-green-500/10 border-green-500/20\">\n                      <AlertCircle className=\"h-4 w-4 text-green-600\" />\n                      <AlertDescription className=\"text-green-700 dark:text-green-300\">\n                        {closeAllSuccess}\n                      </AlertDescription>\n                    </Alert>\n                  )}\n\n                  <div className=\"py-4\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      <strong>Note:</strong> This will:\n                    </p>\n                    <ul className=\"list-disc list-inside text-sm text-muted-foreground mt-2 space-y-1\">\n                      <li>Close all open assignments for each shift</li>\n                      <li>Set the end time to the current time</li>\n                      <li>Calculate statistics from meter readings</li>\n                      <li>Update tank levels based on sales</li>\n                      <li>Set declared amounts to zero (you can update these later if needed)</li>\n                    </ul>\n                  </div>\n\n                  <DialogFooter>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => {\n                        setCloseAllDialogOpen(false)\n                        setCloseAllError(null)\n                        setCloseAllSuccess(null)\n                      }}\n                      disabled={closingAll}\n                    >\n                      Cancel\n                    </Button>\n                    <Button\n                      variant=\"destructive\"\n                      onClick={handleCloseAllActiveShifts}\n                      disabled={closingAll}\n                    >\n                      {closingAll ? (\n                        <>\n                          <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\n                          Closing...\n                        </>\n                      ) : (\n                        <>\n                          <Power className=\"h-4 w-4 mr-2\" />\n                          Close All Shifts\n                        </>\n                      )}\n                    </Button>\n                  </DialogFooter>\n                </DialogContent>\n              </Dialog>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Shifts Table */}\n      <FormCard\n        title=\"Recent Shifts\"\n        description=\"View and manage all station shifts\"\n      >\n        <div className=\"space-y-4\">\n          {/* Filter Button with Count */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleFilterClick}\n                className=\"flex items-center gap-2\"\n              >\n                <Filter className=\"h-4 w-4\" />\n                Filters\n                {getActiveFilterCount() > 0 && (\n                  <Badge variant=\"secondary\" className=\"ml-1\">\n                    {getActiveFilterCount()}\n                  </Badge>\n                )}\n              </Button>\n              {getActiveFilterCount() > 0 && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={clearFilters}\n                  className=\"text-red-600 dark:text-red-400 hover:text-red-700\"\n                >\n                  <X className=\"h-4 w-4 mr-1\" />\n                  Clear\n                </Button>\n              )}\n            </div>\n          </div>\n\n          <DataTable\n            data={filteredShifts}\n            columns={shiftColumns}\n            searchable={true}\n            searchPlaceholder=\"Search shifts...\"\n            pagination={true}\n            pageSize={10}\n            emptyMessage=\"No shifts found\"\n            onRowClick={handleRowClick}\n          />\n        </div>\n      </FormCard>\n\n      {/* Filter Modal */}\n      <Dialog open={filterOpen} onOpenChange={setFilterOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Filter className=\"h-5 w-5\" />\n              Filter Shifts\n            </DialogTitle>\n            <DialogDescription>\n              Apply filters to find specific shifts based on your criteria.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 py-4\">\n            {/* Status Filter */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"status\">Status</Label>\n              <Select\n                value={filters.status}\n                onValueChange={(value) => setFilters(prev => ({ ...prev, status: value }))}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder=\"All statuses\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All statuses</SelectItem>\n                  <SelectItem value=\"OPEN\">Open</SelectItem>\n                  <SelectItem value=\"CLOSED\">Closed</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Opened By Filter */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"openedBy\">Opened By</Label>\n              <Input\n                id=\"openedBy\"\n                placeholder=\"Enter name...\"\n                value={filters.openedBy}\n                onChange={(e) => setFilters(prev => ({ ...prev, openedBy: e.target.value }))}\n              />\n            </div>\n\n            {/* Date From Filter */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"dateFrom\">From Date</Label>\n              <Input\n                id=\"dateFrom\"\n                type=\"date\"\n                value={filters.dateFrom}\n                onChange={(e) => setFilters(prev => ({ ...prev, dateFrom: e.target.value }))}\n              />\n            </div>\n\n            {/* Date To Filter */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"dateTo\">To Date</Label>\n              <Input\n                id=\"dateTo\"\n                type=\"date\"\n                value={filters.dateTo}\n                onChange={(e) => setFilters(prev => ({ ...prev, dateTo: e.target.value }))}\n              />\n            </div>\n\n            {/* Min Sales Filter */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"minSales\">Min Sales (Rs.)</Label>\n              <Input\n                id=\"minSales\"\n                type=\"number\"\n                placeholder=\"0\"\n                value={filters.minSales}\n                onChange={(e) => setFilters(prev => ({ ...prev, minSales: e.target.value }))}\n              />\n            </div>\n\n            {/* Max Sales Filter */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"maxSales\">Max Sales (Rs.)</Label>\n              <Input\n                id=\"maxSales\"\n                type=\"number\"\n                placeholder=\"No limit\"\n                value={filters.maxSales}\n                onChange={(e) => setFilters(prev => ({ ...prev, maxSales: e.target.value }))}\n              />\n            </div>\n          </div>\n\n          <DialogFooter className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={clearFilters}>\n              Clear All\n            </Button>\n            <Button variant=\"outline\" onClick={() => setFilterOpen(false)}>\n              Cancel\n            </Button>\n            <Button onClick={applyFilters}>\n              Apply Filters\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\tanks\\deliveries\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":192,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":192,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_err' is defined but never used.","line":212,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":212,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useCallback } from 'react'\nimport { useStation } from '@/contexts/StationContext'\nimport { useToast } from '@/hooks/use-toast'\nimport { useRouter } from 'next/navigation'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DateTimePicker } from '@/components/inputs/DateTimePicker'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { Truck, AlertCircle, CheckCircle, Plus, ArrowLeft, RefreshCw, Droplets, Clock } from 'lucide-react'\nimport { depthToVolume, getTankCapacityLabel, validateDepth, getMaxDepth, volumeToDepth, TankCapacity } from '@/lib/tank-calibration'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface Fuel {\n  id: string\n  code: string\n  name: string\n  icon?: string | null\n}\n\ninterface Tank {\n  id: string\n  stationId: string\n  tankNumber: string\n  fuelId: string\n  fuel?: Fuel\n  capacity: number\n  currentLevel: number\n}\n\ninterface Delivery {\n  id: string\n  tankId: string\n  tank?: {\n    tankNumber: string\n    fuelId: string\n    fuel?: Fuel\n    currentLevel: number\n    capacity: number\n  }\n  supplier: string\n  invoiceNumber?: string\n  invoiceQuantity: number\n  quantity: number\n  beforeDipReading?: number\n  afterDipReading?: number\n  actualReceived?: number\n  fuelSoldDuring?: number\n  beforeMeterReadings?: {\n    assignmentId: string\n    nozzleId: string\n    meterReading: number\n  }[]\n  verificationStatus: string\n  deliveryDate: string\n  receivedBy: string\n  verifiedBy?: string\n  createdAt: string\n  invoiceVariance?: number\n  dipVariance?: number\n}\n\ninterface ActiveShift {\n  id: string\n  startTime: string\n  template: { name: string }\n  assignments: Array<{\n    id: string\n    pumperName: string\n    nozzle: {\n      id: string\n      nozzleNumber: string\n      tank: { id: string; tankNumber: string; fuelId: string; fuel?: Fuel; name?: string }\n    }\n    startMeterReading: number\n  }>\n}\n\ninterface PumpReading {\n  assignmentId: string\n  nozzleId: string\n  tankId: string\n  startMeterReading: number\n  currentMeter: string\n  fuelUsed: number\n}\n\nconst suppliers = [\n  'Ceylon Petroleum Corporation (CPC)',\n  'Lanka IOC PLC',\n  'Shell Gas Lanka Ltd',\n  'Chevron Lubricants Lanka PLC',\n  'Mobil Lanka Lubricants Pvt Ltd',\n  'Other'\n]\n\nexport default function TankDeliveriesPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [tanks, setTanks] = useState<Tank[]>([])\n  const [deliveries, setDeliveries] = useState<Delivery[]>([])\n  const [loading, setLoading] = useState(false)\n\n  const { toast } = useToast()\n  const [activeTab, setActiveTab] = useState('new')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedTank, setSelectedTank] = useState('')\n  const [supplier, setSupplier] = useState('')\n  const [customSupplier, setCustomSupplier] = useState('')\n  const [invoiceNumber, setInvoiceNumber] = useState('')\n  const [invoiceQuantity, setInvoiceQuantity] = useState('')\n  const [deliveryTime, setDeliveryTime] = useState<Date>(new Date())\n  const [receivedBy, setReceivedBy] = useState('')\n  const [notes, setNotes] = useState('')\n\n  // Before dip state\n  const [beforeDipDepth, setBeforeDipDepth] = useState('')\n  const [beforeDipReading, setBeforeDipReading] = useState('')\n  const [beforeDipTime, setBeforeDipTime] = useState<Date>(new Date())\n  const [showBeforeDip, setShowBeforeDip] = useState(false)\n\n  // Active shifts state (for before dip)\n  const [activeShifts, setActiveShifts] = useState<ActiveShift[]>([])\n  const [loadingShifts, setLoadingShifts] = useState(false)\n  const [pumpReadings, setPumpReadings] = useState<PumpReading[]>([])\n\n  // Verification dialog state\n  const [verifyingDelivery, setVerifyingDelivery] = useState<Delivery | null>(null)\n  const [afterDipDepth, setAfterDipDepth] = useState('')\n  const [afterDipReading, setAfterDipReading] = useState('')\n  const [afterDipTime, setAfterDipTime] = useState<Date>(new Date())\n  const [afterActiveShifts, setAfterActiveShifts] = useState<ActiveShift[]>([])\n  const [afterPumpReadings, setAfterPumpReadings] = useState<PumpReading[]>([])\n  const [verifyLoading, setVerifyLoading] = useState(false)\n\n  // Details dialog state\n  const [selectedDelivery, setSelectedDelivery] = useState<Delivery | null>(null)\n  const [showDetails, setShowDetails] = useState(false)\n\n  const loadData = useCallback(async () => {\n    try {\n      const [stationsRes, deliveriesRes] = await Promise.all([\n        fetch('/api/stations?active=true'),\n        fetch('/api/deliveries')\n      ])\n\n      const stationsData = await stationsRes.json()\n      const deliveriesData = await deliveriesRes.json()\n\n      if (Array.isArray(stationsData)) {\n        setStations(stationsData)\n      } else {\n        console.error('Stations data mismatch:', stationsData)\n        setStations([])\n      }\n\n      if (Array.isArray(deliveriesData)) {\n        setDeliveries(deliveriesData)\n      } else {\n        console.error('Deliveries data mismatch:', deliveriesData)\n        setDeliveries([])\n      }\n    } catch (_err) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to load data\",\n        variant: \"destructive\"\n      })\n    }\n  }, [toast])\n\n  useEffect(() => {\n    loadData()\n  }, [loadData])\n\n  useEffect(() => {\n    if (selectedStation) {\n      const loadTanks = async () => {\n        try {\n          const response = await fetch(`/api/tanks?stationId=${selectedStation}&type=tanks`)\n          const tanksData = await response.json()\n          setTanks(tanksData)\n        } catch (_err) {\n          toast({\n            title: \"Error\",\n            description: \"Failed to load tanks\",\n            variant: \"destructive\"\n          })\n        }\n      }\n      loadTanks()\n    } else {\n      setTanks([])\n    }\n  }, [selectedStation, toast])\n\n  const loadActiveShifts = useCallback(async (time: Date, isBefore: boolean) => {\n    if (!selectedStation) return\n\n    try {\n      setLoadingShifts(true)\n      const timeISO = time.toISOString()\n\n      const response = await fetch(\n        `/api/shifts?stationId=${selectedStation}&activeAt=${timeISO}&includeAssignments=true`\n      )\n\n      if (response.ok) {\n        const data = await response.json()\n        const shiftsData = Array.isArray(data) ? data : data.shifts || []\n\n        if (isBefore) {\n          setActiveShifts(shiftsData)\n          const initialReadings: PumpReading[] = []\n          shiftsData.forEach((shift: ActiveShift) => {\n            shift.assignments.forEach(assignment => {\n              initialReadings.push({\n                assignmentId: assignment.id,\n                nozzleId: assignment.nozzle.id,\n                tankId: assignment.nozzle.tank.id,\n                startMeterReading: assignment.startMeterReading,\n                currentMeter: '',\n                fuelUsed: 0\n              })\n            })\n          })\n          setPumpReadings(initialReadings)\n        } else {\n          setAfterActiveShifts(shiftsData)\n          const initialReadings: PumpReading[] = []\n          shiftsData.forEach((shift: ActiveShift) => {\n            shift.assignments.forEach(assignment => {\n              initialReadings.push({\n                assignmentId: assignment.id,\n                nozzleId: assignment.nozzle.id,\n                tankId: assignment.nozzle.tank.id,\n                startMeterReading: assignment.startMeterReading,\n                currentMeter: '',\n                fuelUsed: 0\n              })\n            })\n          })\n          setAfterPumpReadings(initialReadings)\n        }\n      }\n    } catch (err) {\n      console.error('Failed to load active shifts:', err)\n    } finally {\n      setLoadingShifts(false)\n    }\n  }, [selectedStation])\n\n  useEffect(() => {\n    if (selectedStation && beforeDipTime && showBeforeDip) {\n      loadActiveShifts(beforeDipTime, true)\n    }\n  }, [selectedStation, beforeDipTime, showBeforeDip, loadActiveShifts])\n\n  useEffect(() => {\n    if (verifyingDelivery && afterDipTime) {\n      loadActiveShifts(afterDipTime, false)\n    }\n  }, [verifyingDelivery, afterDipTime, loadActiveShifts])\n\n  const handleMeterChange = (assignmentId: string, value: string, isBefore: boolean, beforeDipMeter?: number) => {\n    const setReadings = isBefore ? setPumpReadings : setAfterPumpReadings\n\n    setReadings(prev => prev.map(reading => {\n      if (reading.assignmentId === assignmentId) {\n        const currentMeter = parseFloat(value) || 0\n\n        // For after dip, use the provided beforeDipMeter parameter (from stored data)\n        let baselineMeter = reading.startMeterReading\n        if (!isBefore) {\n          if (beforeDipMeter !== undefined) {\n            // Use stored before dip meter from database\n            baselineMeter = beforeDipMeter\n          } else {\n            // Fallback: try to get from pumpReadings state (during initial recording)\n            const beforeReading = pumpReadings.find(r => r.assignmentId === assignmentId)\n            if (beforeReading && beforeReading.currentMeter) {\n              baselineMeter = parseFloat(beforeReading.currentMeter)\n            }\n          }\n        }\n\n        const fuelUsed = Math.max(0, currentMeter - baselineMeter)\n        return { ...reading, currentMeter: value, fuelUsed }\n      }\n      return reading\n    }))\n  }\n\n  const calculateTotalFuelSold = (readings: PumpReading[], tankId: string): number => {\n    return readings\n      .filter(r => r.tankId === tankId && r.fuelUsed > 0)\n      .reduce((sum, r) => sum + r.fuelUsed, 0)\n  }\n\n  const handleTakeBeforeDip = () => {\n    if (!selectedTank) {\n      toast({\n        title: \"Error\",\n        description: \"Please select a tank first\",\n        variant: \"destructive\"\n      })\n      return\n    }\n    setShowBeforeDip(true)\n    setBeforeDipTime(new Date())\n  }\n\n  const handleRecordDelivery = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !selectedTank || !supplier || !invoiceQuantity || !receivedBy) {\n      toast({\n        title: \"Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    if (!beforeDipReading) {\n      toast({\n        title: \"Error\",\n        description: \"Please take a before dip reading first\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const finalSupplier = supplier === 'Other' ? customSupplier : supplier\n      const fuelSold = calculateTotalFuelSold(pumpReadings, selectedTank)\n\n      // Prepare before meter readings for storage\n      const beforeMeterData = pumpReadings\n        .filter(r => r.tankId === selectedTank && r.currentMeter)\n        .map(r => ({\n          assignmentId: r.assignmentId,\n          nozzleId: r.nozzleId,\n          meterReading: parseFloat(r.currentMeter)\n        }))\n\n      const response = await fetch('/api/deliveries', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          tankId: selectedTank,\n          invoiceQuantity: parseFloat(invoiceQuantity),\n          supplier: finalSupplier,\n          deliveryDate: deliveryTime.toISOString(),\n          receivedBy,\n          invoiceNumber: invoiceNumber || null,\n          notes: notes || null,\n          beforeDipReading: parseFloat(beforeDipReading),\n          beforeDipTime: beforeDipTime.toISOString(),\n          fuelSoldDuring: fuelSold,\n          beforeMeterReadings: beforeMeterData\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to record delivery')\n      }\n\n      toast({\n        title: \"Success\",\n        description: \"Delivery recorded successfully! Please verify with after dip.\"\n      })\n\n      // Reset form\n      setSelectedTank('')\n      setSupplier('')\n      setCustomSupplier('')\n      setInvoiceNumber('')\n      setInvoiceQuantity('')\n      setReceivedBy('')\n      setNotes('')\n      setBeforeDipReading('')\n      setShowBeforeDip(false)\n      setActiveShifts([])\n      setPumpReadings([])\n\n      // Reload and switch to pending tab\n      loadData()\n      setActiveTab('pending')\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to record delivery'\n      toast({\n        title: \"Error\",\n        description: errorMessage,\n        variant: \"destructive\"\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleVerifyDelivery = async () => {\n    if (!verifyingDelivery || !afterDipReading) {\n      toast({\n        title: \"Error\",\n        description: \"After dip reading is required\",\n        variant: \"destructive\"\n      })\n      return\n    }\n\n    setVerifyLoading(true)\n\n    try {\n      const additionalSold = calculateTotalFuelSold(afterPumpReadings, verifyingDelivery.tankId)\n\n      const response = await fetch(`/api/deliveries/${verifyingDelivery.id}/verify`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          afterDipReading: parseFloat(afterDipReading),\n          afterDipTime: afterDipTime.toISOString(),\n          additionalFuelSold: additionalSold,\n          verifiedBy: typeof window !== 'undefined' ? localStorage.getItem('username') || 'System User' : 'System User'\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to verify delivery')\n      }\n\n      const result = await response.json()\n      toast({\n        title: \"Success\",\n        description: result.message || 'Delivery verified successfully!'\n      })\n\n      // Reset\n      setVerifyingDelivery(null)\n      setAfterDipDepth('')\n      setAfterDipReading('')\n      setAfterActiveShifts([])\n      setAfterPumpReadings([])\n\n      // Reload\n      loadData()\n      setActiveTab('verified')\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to verify delivery'\n      toast({\n        title: \"Error\",\n        description: errorMessage,\n        variant: \"destructive\"\n      })\n    } finally {\n      setVerifyLoading(false)\n    }\n  }\n\n  const columns: Column<Delivery>[] = [\n    {\n      key: 'deliveryDate' as keyof Delivery,\n      title: 'Date & Time',\n      render: (value: unknown) => {\n        if (!value) return '-'\n        return new Date(value as string).toLocaleString()\n      }\n    },\n    {\n      key: 'tank' as keyof Delivery,\n      title: 'Tank',\n      render: (_: unknown, row: Delivery) => (\n        <div className=\"flex items-center gap-2\">\n          <span className=\"font-medium\">Tank {row.tank?.tankNumber || 'N/A'}</span>\n          {row.tank?.fuel && <Badge variant=\"outline\" className=\"text-xs\">{row.tank.fuel.icon} {row.tank.fuel.name}</Badge>}\n        </div>\n      )\n    },\n    {\n      key: 'supplier' as keyof Delivery,\n      title: 'Supplier',\n      render: (value: unknown) => <span className=\"text-sm\">{value as string}</span>\n    },\n    {\n      key: 'invoiceQuantity' as keyof Delivery,\n      title: 'Invoice Qty',\n      render: (value: unknown) => {\n        if (value == null) return '-'\n        return <span>{(value as number).toLocaleString()}L</span>\n      }\n    },\n    {\n      key: 'actualReceived' as keyof Delivery,\n      title: 'Actual Received',\n      render: (value: unknown) => {\n        if (value == null) return <span className=\"text-muted-foreground\">Pending</span>\n        return <span className=\"font-semibold text-green-600\">{(value as number).toLocaleString()}L</span>\n      }\n    },\n    {\n      key: 'verificationStatus' as keyof Delivery,\n      title: 'Status',\n      render: (value: unknown) => {\n        const status = value as string\n        if (status === 'VERIFIED') return <Badge className=\"bg-green-600\">Verified</Badge>\n        if (status === 'DISCREPANCY') return <Badge variant=\"destructive\">Discrepancy</Badge>\n        return <Badge variant=\"outline\" className=\"bg-orange-500/10 text-orange-600 border-orange-500/30\">Pending</Badge>\n      }\n    },\n    {\n      key: 'receivedBy' as keyof Delivery,\n      title: 'Received By',\n      render: (value: unknown) => <span className=\"text-sm text-muted-foreground\">{value as string}</span>\n    }\n  ]\n\n  const pendingDeliveries = deliveries.filter(d => d.verificationStatus === 'PENDING_VERIFICATION')\n  const verifiedDeliveries = deliveries.filter(d => d.verificationStatus !== 'PENDING_VERIFICATION')\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Button variant=\"outline\" onClick={() => router.push('/tanks')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back\n          </Button>\n          <div>\n            <h1 className=\"text-3xl font-bold text-foreground flex items-center gap-2\">\n              <Truck className=\"h-8 w-8 text-blue-600\" />\n              Fuel Deliveries\n            </h1>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              Record and verify deliveries with before/after dip measurements\n            </p>\n          </div>\n        </div>\n        <Button variant=\"outline\" onClick={loadData}>\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Refresh\n        </Button>\n      </div>\n\n      {/* Alerts */}\n\n\n\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList>\n          <TabsTrigger value=\"new\">New Delivery</TabsTrigger>\n          <TabsTrigger value=\"pending\">\n            Pending Verification\n            {pendingDeliveries.length > 0 && (\n              <Badge variant=\"destructive\" className=\"ml-2 text-xs\">{pendingDeliveries.length}</Badge>\n            )}\n          </TabsTrigger>\n          <TabsTrigger value=\"verified\">Verified Deliveries</TabsTrigger>\n        </TabsList>\n\n        {/* New Delivery Tab */}\n        <TabsContent value=\"new\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Record New Delivery</CardTitle>\n              <CardDescription>\n                Record fuel deliveries with before-dip verification to ensure accurate inventory\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleRecordDelivery} className=\"space-y-6\">\n                {/* Basic Information */}\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <Label htmlFor=\"station\">Station *</Label>\n                    <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n                      <SelectTrigger id=\"station\">\n                        <SelectValue placeholder=\"Select station\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {stations.map((station) => (\n                          <SelectItem key={station.id} value={station.id}>\n                            {station.name} ({station.city})\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"tank\">Tank *</Label>\n                    <Select value={selectedTank} onValueChange={setSelectedTank} disabled={loading || !selectedStation}>\n                      <SelectTrigger id=\"tank\">\n                        <SelectValue placeholder=\"Select tank\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {tanks.filter(t => t.stationId === selectedStation).map((tank) => (\n                          <SelectItem key={tank.id} value={tank.id}>\n                            Tank {tank.tankNumber} - {tank.fuel?.icon} {tank.fuel?.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"deliveryTime\">Delivery Time *</Label>\n                    <DateTimePicker\n                      value={deliveryTime}\n                      onChange={(date) => date && setDeliveryTime(date)}\n                      disabled={loading}\n                    />\n                  </div>\n                </div>\n\n                {/* Supplier Information */}\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"supplier\">Supplier *</Label>\n                    <Select value={supplier} onValueChange={setSupplier} disabled={loading}>\n                      <SelectTrigger id=\"supplier\">\n                        <SelectValue placeholder=\"Select supplier\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {suppliers.map((s) => (\n                          <SelectItem key={s} value={s}>{s}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {supplier === 'Other' && (\n                    <div>\n                      <Label htmlFor=\"customSupplier\">Custom Supplier *</Label>\n                      <Input\n                        id=\"customSupplier\"\n                        value={customSupplier}\n                        onChange={(e) => setCustomSupplier(e.target.value)}\n                        placeholder=\"Enter supplier name\"\n                        required={supplier === 'Other'}\n                      />\n                    </div>\n                  )}\n\n                  <div>\n                    <Label htmlFor=\"invoiceNumber\">Invoice Number</Label>\n                    <Input\n                      id=\"invoiceNumber\"\n                      value={invoiceNumber}\n                      onChange={(e) => setInvoiceNumber(e.target.value)}\n                      placeholder=\"Enter invoice number\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"invoiceQuantity\">Invoice Quantity (L) *</Label>\n                    <Input\n                      id=\"invoiceQuantity\"\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={invoiceQuantity}\n                      onChange={(e) => setInvoiceQuantity(e.target.value)}\n                      placeholder=\"Enter quantity from invoice\"\n                      className=\"\"\n                      required\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"receivedBy\">Received By *</Label>\n                    <Input\n                      id=\"receivedBy\"\n                      value={receivedBy}\n                      onChange={(e) => setReceivedBy(e.target.value)}\n                      placeholder=\"Name of person receiving\"\n                      required\n                    />\n                  </div>\n                </div>\n\n                {/* Current Tank Level Display */}\n                {selectedTank && (() => {\n                  const tank = tanks.find(t => t.id === selectedTank)\n                  if (tank) {\n                    return (\n                      <Card className=\"bg-blue-500/5 border-blue-500/20\">\n                        <CardContent className=\"pt-6\">\n                          <div className=\"flex items-center justify-between\">\n                            <div>\n                              <div className=\"text-sm text-muted-foreground mb-1\">Current System Stock</div>\n                              <div className=\"text-2xl font-bold\">{tank.currentLevel.toLocaleString()}L</div>\n                            </div>\n                            <Droplets className=\"h-12 w-12 text-blue-600 opacity-20\" />\n                          </div>\n                        </CardContent>\n                      </Card>\n                    )\n                  }\n                  return null\n                })()}\n\n                {/* Before Dip Section */}\n                {!showBeforeDip ? (\n                  <Card className=\"border-blue-500/50 bg-blue-500/10\">\n                    <CardContent className=\"pt-6\">\n                      <div className=\"flex items-start gap-4\">\n                        <div className=\"flex-shrink-0\">\n                          <div className=\"w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center\">\n                            <Droplets className=\"h-5 w-5 text-blue-600\" />\n                          </div>\n                        </div>\n                        <div className=\"flex-1\">\n                          <h3 className=\"text-lg font-semibold text-blue-600 mb-2\">Step 1: Take Before Dip</h3>\n                          <p className=\"text-sm text-blue-600/80 mb-4\">\n                            Before the delivery arrives, measure the physical tank level. This is the starting point for calculating actual received quantity.\n                          </p>\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            className=\"border-blue-500/30 hover:bg-blue-500/20\"\n                            onClick={handleTakeBeforeDip}\n                            disabled={!selectedTank}\n                          >\n                            <Droplets className=\"mr-2 h-4 w-4\" />\n                            Take Before Dip Reading\n                          </Button>\n                          {!selectedTank && (\n                            <p className=\"text-xs text-muted-foreground mt-2\">\n                              Please select a tank first\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ) : (\n                  <Card className=\"border-blue-500/30 bg-blue-500/5\">\n                    <CardHeader>\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-sm font-bold text-blue-600\">\n                          1\n                        </div>\n                        <div>\n                          <CardTitle className=\"text-blue-600\">Before Delivery Dip Reading</CardTitle>\n                          <CardDescription>\n                            Measured at: {beforeDipTime.toLocaleString()}\n                          </CardDescription>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      {/* Active Shifts Check */}\n                      {loadingShifts ? (\n                        <div className=\"text-center py-4\">\n                          <RefreshCw className=\"h-6 w-6 animate-spin mx-auto mb-2 text-blue-600\" />\n                          <p className=\"text-sm text-muted-foreground\">Checking for active shifts...</p>\n                        </div>\n                      ) : activeShifts.length > 0 ? (() => {\n                        // Count shifts that have assignments for this tank\n                        const shiftsForSelectedTank = activeShifts.filter(shift =>\n                          shift.assignments.some(assignment => {\n                            const reading = pumpReadings.find(r => r.assignmentId === assignment.id)\n                            return reading && reading.tankId === selectedTank\n                          })\n                        )\n\n                        if (shiftsForSelectedTank.length === 0) {\n                          return (\n                            <Alert className=\"border-green-500/50 bg-green-500/10\">\n                              <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                              <AlertTitle className=\"text-green-600\">No Active Shifts for This Tank</AlertTitle>\n                              <AlertDescription className=\"text-green-600\">\n                                No shifts running on this tank\n                              </AlertDescription>\n                            </Alert>\n                          )\n                        }\n\n                        return (\n                          <div className=\"space-y-3\">\n                            <Alert className=\"border-orange-500/50 bg-orange-500/10\">\n                              <AlertCircle className=\"h-4 w-4 text-orange-600\" />\n                              <AlertTitle className=\"text-orange-600\">Shifts Active During Dip</AlertTitle>\n                              <AlertDescription className=\"text-orange-600\">\n                                {shiftsForSelectedTank.length} shift(s) running on this tank. Enter current meter readings to account for fuel sold.\n                              </AlertDescription>\n                            </Alert>\n\n                            {activeShifts.map((shift) => {\n                              // Only show shift if it has assignments for this tank\n                              const shiftsForThisTank = shift.assignments.filter(assignment => {\n                                const reading = pumpReadings.find(r => r.assignmentId === assignment.id)\n                                return reading && reading.tankId === selectedTank\n                              })\n\n                              if (shiftsForThisTank.length === 0) return null\n\n                              return (\n                                <Card key={shift.id} className=\"bg-background\">\n                                  <CardContent className=\"pt-4\">\n                                    <div className=\"font-medium mb-3 flex items-center gap-2\">\n                                      <Clock className=\"h-4 w-4\" />\n                                      {shift.template.name}\n                                    </div>\n                                    <div className=\"space-y-2\">\n                                      {shiftsForThisTank.map((assignment) => {\n                                        const reading = pumpReadings.find(r => r.assignmentId === assignment.id)\n                                        return (\n                                          <div key={assignment.id} className=\"p-3 bg-muted/50 rounded-lg space-y-3\">\n                                            {/* Header: Pumper and Nozzle */}\n                                            <div className=\"flex items-center justify-between pb-2 border-b\">\n                                              <div className=\"flex items-center gap-2\">\n                                                <div className=\"w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center\">\n                                                  <span className=\"font-bold text-orange-600 text-sm\">{assignment.pumperName.charAt(0)}</span>\n                                                </div>\n                                                <div>\n                                                  <div className=\"font-semibold\">{assignment.pumperName}</div>\n                                                  <div className=\"text-xs text-muted-foreground\">\n                                                    {assignment.nozzle.tank.name} - Nozzle {assignment.nozzle.nozzleNumber}\n                                                  </div>\n                                                </div>\n                                              </div>\n                                              <div className=\"text-right\">\n                                                <div className=\"text-xs text-muted-foreground\">Shift Opening</div>\n                                                <div className=\"font-mono font-semibold text-sm\">{assignment.startMeterReading.toLocaleString()}L</div>\n                                              </div>\n                                            </div>\n\n                                            {/* Meter readings */}\n                                            <div className=\"grid grid-cols-2 gap-3\">\n                                              <div>\n                                                <Label htmlFor={`before-${assignment.id}`} className=\"text-xs text-muted-foreground\">Current Meter (Before Dip) *</Label>\n                                                <Input\n                                                  id={`before-${assignment.id}`}\n                                                  type=\"number\"\n                                                  step=\"0.01\"\n                                                  min={assignment.startMeterReading}\n                                                  value={reading?.currentMeter || ''}\n                                                  onChange={(e) => handleMeterChange(assignment.id, e.target.value, true)}\n                                                  placeholder=\"Enter current reading\"\n                                                  className=\"font-mono h-9\"\n                                                />\n                                              </div>\n                                              <div>\n                                                <Label className=\"text-xs text-muted-foreground\">Fuel Sold So Far</Label>\n                                                <div className={`h-9 flex items-center font-mono font-semibold text-lg ${reading?.fuelUsed && reading.fuelUsed > 0 ? 'text-orange-600' : 'text-muted-foreground'}`}>\n                                                  {reading?.fuelUsed && reading.fuelUsed > 0 ? `${reading.fuelUsed.toLocaleString()}L` : '-'}\n                                                </div>\n                                              </div>\n                                            </div>\n                                          </div>\n                                        )\n                                      })}\n                                    </div>\n                                    <div className=\"mt-3 pt-3 border-t\">\n                                      <div className=\"flex justify-between items-center text-sm\">\n                                        <span className=\"text-muted-foreground\">Shift Total:</span>\n                                        <span className=\"font-mono font-semibold\">{\n                                          shiftsForThisTank\n                                            .map(a => pumpReadings.find(r => r.assignmentId === a.id))\n                                            .filter(r => r && r.tankId === selectedTank)\n                                            .reduce((sum, r) => sum + (r?.fuelUsed || 0), 0)\n                                            .toLocaleString()\n                                        }L</span>\n                                      </div>\n                                    </div>\n                                  </CardContent>\n                                </Card>\n                              )\n                            })}\n                            <div className=\"mt-4 pt-3 border-t\">\n                              <div className=\"flex justify-between items-center\">\n                                <span className=\"font-semibold\">Total Fuel Sold:</span>\n                                <span className=\"font-mono font-bold text-lg\">{calculateTotalFuelSold(pumpReadings, selectedTank).toLocaleString()}L</span>\n                              </div>\n                            </div>\n                          </div>\n                        )\n                      })() : (\n                        <Alert className=\"border-green-500/50 bg-green-500/10\">\n                          <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                          <AlertTitle className=\"text-green-600\">No Active Shifts</AlertTitle>\n                          <AlertDescription className=\"text-green-600\">\n                            No shifts running - system stock is accurate.\n                          </AlertDescription>\n                        </Alert>\n                      )}\n\n                      {/* Dip Reading Input */}\n                      <div className=\"pt-2\">\n                        {(() => {\n                          const tank = tanks.find(t => t.id === selectedTank)\n                          if (!tank) return null\n\n                          const tankCapacity = tank.capacity as 9000 | 15000 | 22500\n                          const maxDepth = getMaxDepth(tankCapacity)\n\n                          return (\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                              <div>\n                                <Label htmlFor=\"beforeDipDepth\" className=\"text-base font-semibold\">Liquid Depth (cm) *</Label>\n                                <Input\n                                  id=\"beforeDipDepth\"\n                                  type=\"number\"\n                                  step=\"0.1\"\n                                  min=\"0\"\n                                  max={maxDepth}\n                                  value={beforeDipDepth}\n                                  onChange={(e) => {\n                                    const depth = e.target.value\n                                    setBeforeDipDepth(depth)\n\n                                    if (depth && parseFloat(depth) > 0) {\n                                      const validation = validateDepth(parseFloat(depth), tankCapacity)\n                                      if (validation.valid) {\n                                        const volume = depthToVolume(parseFloat(depth), tankCapacity)\n                                        setBeforeDipReading(volume.toString())\n                                      }\n                                    } else {\n                                      setBeforeDipReading('')\n                                    }\n                                  }}\n                                  placeholder=\"Enter depth from dipstick\"\n                                  required\n                                  className=\"mt-2\"\n                                />\n                                <p className=\"text-xs text-muted-foreground mt-2\">\n                                  Using {getTankCapacityLabel(tankCapacity)} chart (max: {maxDepth}cm)\n                                </p>\n                              </div>\n\n                              <div>\n                                <Label htmlFor=\"beforeDipReading\" className=\"text-base font-semibold\">Calculated Volume (Litres)</Label>\n                                <Input\n                                  id=\"beforeDipReading\"\n                                  type=\"text\"\n                                  value={beforeDipReading ? parseFloat(beforeDipReading).toLocaleString() : ''}\n                                  disabled\n                                  placeholder=\"Auto-calculated from depth\"\n                                  className=\"mt-2 bg-muted\"\n                                />\n                                <p className=\"text-xs text-muted-foreground mt-2 flex items-start gap-2\">\n                                  {beforeDipDepth && beforeDipReading ? (\n                                    <span className=\"text-green-600 font-semibold\">\n                                       {beforeDipDepth}cm = {parseFloat(beforeDipReading).toLocaleString()}L\n                                    </span>\n                                  ) : (\n                                    <>\n                                      <AlertCircle className=\"h-3 w-3 mt-0.5 flex-shrink-0\" />\n                                      <span>Automatically calculated from depth measurement</span>\n                                    </>\n                                  )}\n                                </p>\n                              </div>\n                            </div>\n                          )\n                        })()}\n                      </div>\n\n                      {/* Variance Check */}\n                      {beforeDipReading && selectedTank && (() => {\n                        const tank = tanks.find(t => t.id === selectedTank)\n                        if (!tank) return null\n\n                        const fuelSoldBeforeDip = calculateTotalFuelSold(pumpReadings, selectedTank)\n                        const expectedLevel = tank.currentLevel - fuelSoldBeforeDip\n                        // Calculate expected depth from expected level\n                        const tankCapacity = tank.capacity as TankCapacity\n                        const expectedDepth = volumeToDepth(expectedLevel, tankCapacity)\n\n                        const physicalDip = parseFloat(beforeDipReading)\n                        const physicalDepth = parseFloat(beforeDipDepth)\n\n                        const variance = physicalDip - expectedLevel\n                        const depthVariance = physicalDepth - expectedDepth\n\n\n                        return (\n                          <div className=\"mt-4 p-4 bg-muted/50 rounded-lg border\">\n                            <div className=\"font-semibold mb-3 text-sm text-muted-foreground\">Before Dip Variance Check:</div>\n                            <div className=\"space-y-2 text-sm\">\n                              <div className=\"flex justify-between items-center\">\n                                <span>System Stock (Current):</span>\n                                <span className=\"font-semibold\">{tank.currentLevel.toLocaleString()}L</span>\n                              </div>\n                              <div className=\"flex justify-between items-center text-orange-600\">\n                                <span>- Fuel Sold Before Dip:</span>\n                                <span className=\"font-semibold\">-{fuelSoldBeforeDip.toLocaleString()}L</span>\n                              </div>\n                              <div className=\"flex justify-between items-center pt-2 border-t font-semibold\">\n                                <span>Expected Level:</span>\n                                <span className=\"text-purple-600\">\n                                  {expectedLevel.toLocaleString()}L\n                                  <span className=\"text-xs text-muted-foreground ml-1\">\n                                    (~{expectedDepth.toFixed(1)}cm)\n                                  </span>\n                                </span>\n                              </div>\n                              <div className=\"flex justify-between items-center\">\n                                <span>Physical Dip:</span>\n                                <span className=\"text-green-600 font-semibold\">{physicalDip.toLocaleString()}L</span>\n                              </div>\n                              <div className=\"flex justify-between items-center pt-2 border-t font-bold\">\n                                <span>Variance:</span>\n                                <span className={`text-lg ${Math.abs(depthVariance) <= 1 ? 'text-green-600' : 'text-red-600'}`}>\n                                  {variance > 0 ? '+' : ''}{variance.toFixed(1)}L\n                                  <span className=\"text-sm ml-1\">\n                                    / {depthVariance > 0 ? '+' : ''}{depthVariance.toFixed(1)}cm\n                                  </span>\n                                </span>\n                              </div>\n                            </div>\n\n                            {Math.abs(depthVariance) > 1 && (\n                              <Alert className=\"mt-3 border-red-500/50 bg-red-500/10\">\n                                <AlertCircle className=\"h-4 w-4 text-red-600\" />\n                                <AlertTitle className=\"text-red-600\">High Variance Detected</AlertTitle>\n                                <AlertDescription className=\"text-red-600\">\n                                  Physical dip varies by {Math.abs(depthVariance).toFixed(1)}cm (Limit: 1.0cm).\n                                  {variance > 0\n                                    ? ' Possible meter error or unrecorded sales.'\n                                    : ' Possible leak, theft, or meter error.'\n                                  }\n                                </AlertDescription>\n                              </Alert>\n                            )}\n\n                            {Math.abs(depthVariance) <= 1 && (\n                              <Alert className=\"mt-3 border-green-500/50 bg-green-500/10\">\n                                <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                                <AlertTitle className=\"text-green-600\">Within Tolerance</AlertTitle>\n                                <AlertDescription className=\"text-green-600\">\n                                  Variance is within acceptable limit (1cm).\n                                </AlertDescription>\n                              </Alert>\n                            )}\n                          </div>\n                        )\n                      })()}\n                    </CardContent>\n                  </Card>\n                )}\n\n                {/* Notes Section */}\n                {showBeforeDip && (\n                  <div>\n                    <Label htmlFor=\"notes\" className=\"text-base font-semibold\">Notes (Optional)</Label>\n                    <Textarea\n                      id=\"notes\"\n                      value={notes}\n                      onChange={(e) => setNotes(e.target.value)}\n                      placeholder=\"Additional notes about the delivery (e.g., truck number, driver name, weather conditions)\"\n                      rows={3}\n                      className=\"mt-2\"\n                    />\n                  </div>\n                )}\n\n                {/* Action Buttons */}\n                <div className=\"flex justify-end gap-4 pt-4 border-t\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => router.push('/tanks')}\n                    disabled={loading}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={loading || !beforeDipReading}\n                  >\n                    {loading ? 'Recording...' : (\n                      <>\n                        <Plus className=\"mr-2 h-4 w-4\" />\n                        Record Delivery\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </form>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Pending Verification Tab */}\n        <TabsContent value=\"pending\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Pending Verification</CardTitle>\n              <CardDescription>Deliveries awaiting after-dip verification and tank update</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {pendingDeliveries.length === 0 ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <CheckCircle className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No deliveries pending verification</p>\n                  <p className=\"text-sm mt-2\">Verified deliveries will appear in the &quot;Verified Deliveries&quot; tab</p>\n                </div>\n              ) : (\n                <>\n                  <Alert className=\"mb-4 border-orange-500/50 bg-orange-500/10\">\n                    <AlertCircle className=\"h-4 w-4 text-orange-600\" />\n                    <AlertTitle className=\"text-orange-600\">Action Required</AlertTitle>\n                    <AlertDescription className=\"text-orange-600\">\n                      These deliveries need after-dip verification. Click on a delivery to complete verification.\n                    </AlertDescription>\n                  </Alert>\n                  <DataTable\n                    data={pendingDeliveries}\n                    columns={columns}\n                    onRowClick={(delivery) => {\n                      setVerifyingDelivery(delivery)\n                      setAfterDipTime(new Date())\n                    }}\n                  />\n                </>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Verified Tab */}\n        <TabsContent value=\"verified\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Verified Deliveries</CardTitle>\n              <CardDescription>Completed delivery verifications with final calculations</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {verifiedDeliveries.length === 0 ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <Truck className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No verified deliveries yet</p>\n                </div>\n              ) : (\n                <DataTable\n                  data={verifiedDeliveries}\n                  columns={columns}\n                  onRowClick={(delivery) => {\n                    setSelectedDelivery(delivery)\n                    setShowDetails(true)\n                  }}\n                />\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Verification Dialog */}\n      <Dialog open={!!verifyingDelivery} onOpenChange={() => setVerifyingDelivery(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Verify Delivery - After Dip</DialogTitle>\n            <DialogDescription>\n              Complete verification by taking after-dip reading to calculate actual received quantity\n            </DialogDescription>\n          </DialogHeader>\n\n          {verifyingDelivery && (\n            <div className=\"space-y-5\">\n              {/* Header Info */}\n              <div className=\"grid grid-cols-2 gap-4 pb-4 border-b\">\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Tank</div>\n                  <div className=\"font-semibold\">Tank {verifyingDelivery.tank?.tankNumber} - {verifyingDelivery.tank?.fuel?.icon} {verifyingDelivery.tank?.fuel?.name}</div>\n                </div>\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Supplier</div>\n                  <div className=\"font-semibold\">{verifyingDelivery.supplier}</div>\n                </div>\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Invoice Quantity</div>\n                  <div className=\"font-mono font-bold text-xl\">{verifyingDelivery.invoiceQuantity.toLocaleString()}L</div>\n                </div>\n              </div>\n\n              {/* Step 1: Before Delivery - Info Card */}\n              <Card className=\"border-blue-500/50 bg-blue-500/5\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold\">\n                      1\n                    </div>\n                    <div>\n                      <CardTitle className=\"text-blue-600\">Before Delivery</CardTitle>\n                      <CardDescription>Recorded when delivery truck arrived</CardDescription>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"p-3 bg-background rounded-lg\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Tank</div>\n                      <div className=\"font-semibold\">Tank {verifyingDelivery.tank?.tankNumber}</div>\n                      <div className=\"text-sm text-muted-foreground\">{verifyingDelivery.tank?.fuel?.icon} {verifyingDelivery.tank?.fuel?.name}</div>\n                    </div>\n                    <div className=\"p-3 bg-background rounded-lg\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Before Dip Reading</div>\n                      <div className=\"font-mono font-bold text-xl text-blue-600\">{verifyingDelivery.beforeDipReading?.toLocaleString() || '-'}L</div>\n                    </div>\n                    <div className=\"p-3 bg-background rounded-lg\">\n                      <div className=\"text-xs text-muted-foreground mb-1\">Fuel Sold (Before Dip)</div>\n                      <div className=\"font-mono font-bold text-xl text-orange-600\">{verifyingDelivery.fuelSoldDuring?.toLocaleString() || '0'}L</div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {/* Step 2: Fuel Sold During Delivery */}\n              {loadingShifts ? (\n                <div className=\"text-center py-8\">\n                  <RefreshCw className=\"h-6 w-6 animate-spin mx-auto mb-2 text-orange-600\" />\n                  <p className=\"text-sm text-muted-foreground\">Checking for active shifts...</p>\n                </div>\n              ) : afterActiveShifts.length > 0 ? (() => {\n                // Count shifts that have assignments for this tank\n                const shiftsForSelectedTank = afterActiveShifts.filter(shift =>\n                  shift.assignments.some(assignment => {\n                    const reading = afterPumpReadings.find(r => r.assignmentId === assignment.id)\n                    return reading && reading.tankId === verifyingDelivery.tankId\n                  })\n                )\n\n                if (shiftsForSelectedTank.length === 0) {\n                  return (\n                    <Alert className=\"border-green-500/50 bg-green-500/10\">\n                      <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                      <AlertTitle className=\"text-green-600\">No Active Shifts</AlertTitle>\n                      <AlertDescription className=\"text-green-600\">\n                        No shifts running - no fuel sold during delivery\n                      </AlertDescription>\n                    </Alert>\n                  )\n                }\n\n                return (\n                  <Alert className=\"border-orange-500/50 bg-orange-500/10\">\n                    <AlertCircle className=\"h-4 w-4 text-orange-600\" />\n                    <AlertTitle className=\"text-orange-600\">Shifts Still Running</AlertTitle>\n                    <AlertDescription>\n                      <p className=\"text-orange-600 mb-3\">\n                        {shiftsForSelectedTank.length} shift(s) running on this tank. Enter current meter readings to calculate fuel sold while delivering\n                      </p>\n                      <div className=\"space-y-3\">\n                        {afterActiveShifts.map((shift) => {\n                          // Only show shift if it has assignments for this tank\n                          const shiftsForThisTank = shift.assignments.filter(assignment => {\n                            const reading = afterPumpReadings.find(r => r.assignmentId === assignment.id)\n                            return reading && reading.tankId === verifyingDelivery.tankId\n                          })\n\n                          if (shiftsForThisTank.length === 0) return null\n\n                          return (\n                            <div key={shift.id} className=\"border rounded p-3 bg-background\">\n                              <div className=\"font-medium mb-2 flex items-center gap-2\">\n                                <Clock className=\"h-4 w-4\" />\n                                {shift.template.name}\n                              </div>\n                              <div className=\"space-y-2\">\n                                {shiftsForThisTank.map((assignment) => {\n                                  const reading = afterPumpReadings.find(r => r.assignmentId === assignment.id)\n\n                                  // Get before dip meter from stored data\n                                  const beforeMeterData = verifyingDelivery.beforeMeterReadings\n                                  let beforeDipMeter = assignment.startMeterReading\n\n                                  if (beforeMeterData && Array.isArray(beforeMeterData)) {\n                                    const stored = beforeMeterData.find(m => m.assignmentId === assignment.id)\n                                    if (stored && stored.meterReading) {\n                                      beforeDipMeter = stored.meterReading\n                                    }\n                                  }\n\n                                  return (\n                                    <div key={assignment.id} className=\"p-3 bg-muted/50 rounded-lg space-y-3\">\n                                      {/* Header: Pumper and Nozzle */}\n                                      <div className=\"flex items-center justify-between pb-2 border-b\">\n                                        <div className=\"flex items-center gap-2\">\n                                          <div className=\"w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center\">\n                                            <span className=\"font-bold text-orange-600 text-sm\">{assignment.pumperName.charAt(0)}</span>\n                                          </div>\n                                          <div>\n                                            <div className=\"font-semibold\">{assignment.pumperName}</div>\n                                            <div className=\"text-xs text-muted-foreground\">\n                                              {assignment.nozzle.tank.name} - Nozzle {assignment.nozzle.nozzleNumber}\n                                            </div>\n                                          </div>\n                                        </div>\n                                        <div className=\"text-right\">\n                                          <div className=\"text-xs text-muted-foreground\">Before Dip Meter</div>\n                                          <div className=\"font-semibold text-blue-600\">{beforeDipMeter.toLocaleString()}L</div>\n                                        </div>\n                                      </div>\n\n                                      {/* Meter readings */}\n                                      <div className=\"grid grid-cols-2 gap-3\">\n                                        <div>\n                                          <Label htmlFor={`after-${assignment.id}`} className=\"text-xs text-muted-foreground\">Current Meter (After Dip) *</Label>\n                                          <Input\n                                            id={`after-${assignment.id}`}\n                                            type=\"number\"\n                                            step=\"0.01\"\n                                            min={beforeDipMeter}\n                                            value={reading?.currentMeter || ''}\n                                            onChange={(e) => handleMeterChange(assignment.id, e.target.value, false, beforeDipMeter)}\n                                            placeholder=\"Enter current reading\"\n                                            className=\"h-9\"\n                                          />\n                                        </div>\n                                        <div>\n                                          <Label className=\"text-xs text-muted-foreground\">Sold While Delivering</Label>\n                                          <div className={`h-9 flex items-center font-semibold text-lg ${reading?.fuelUsed && reading.fuelUsed > 0 ? 'text-orange-600' : 'text-muted-foreground'}`}>\n                                            {reading?.fuelUsed && reading.fuelUsed > 0 ? `${reading.fuelUsed.toLocaleString()}L` : '-'}\n                                          </div>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  )\n                                })}\n                              </div>\n                              <div className=\"mt-3 pt-3 border-t\">\n                                <div className=\"flex justify-between items-center text-sm\">\n                                  <span className=\"text-muted-foreground\">Shift Total:</span>\n                                  <span className=\"font-semibold\">{\n                                    shiftsForThisTank\n                                      .map(a => afterPumpReadings.find(r => r.assignmentId === a.id))\n                                      .filter(r => r && r.tankId === verifyingDelivery.tankId)\n                                      .reduce((sum, r) => sum + (r?.fuelUsed || 0), 0)\n                                      .toLocaleString()\n                                  }L</span>\n                                </div>\n                              </div>\n                            </div>\n                          )\n                        })}\n                      </div>\n                      <div className=\"mt-4 pt-3 border-t\">\n                        <div className=\"flex justify-between items-center\">\n                          <span className=\"font-semibold\">Total Fuel Sold:</span>\n                          <span className=\"font-bold text-lg\">{calculateTotalFuelSold(afterPumpReadings, verifyingDelivery.tankId).toLocaleString()}L</span>\n                        </div>\n                      </div>\n                    </AlertDescription>\n                  </Alert>\n                )\n              })() : (\n                <Alert className=\"border-green-500/50 bg-green-500/10\">\n                  <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                  <AlertTitle className=\"text-green-600\">No Active Shifts</AlertTitle>\n                  <AlertDescription className=\"text-green-600\">\n                    No shifts running - no fuel sold during delivery\n                  </AlertDescription>\n                </Alert>\n              )}\n\n              {/* Step 3: After Delivery */}\n              <Card className=\"border-green-500/50 bg-green-500/5\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold\">\n                      3\n                    </div>\n                    <div>\n                      <CardTitle className=\"text-green-600\">After Delivery Complete</CardTitle>\n                      <CardDescription>Tank level after fuel has been loaded</CardDescription>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {(() => {\n                    const tankCapacity = (verifyingDelivery.tank?.capacity || 9000) as 9000 | 15000 | 22500\n                    const maxDepth = getMaxDepth(tankCapacity)\n\n                    return (\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                        <div>\n                          <Label htmlFor=\"afterDipDepth\" className=\"text-base font-semibold\">Liquid Depth (cm) *</Label>\n                          <Input\n                            id=\"afterDipDepth\"\n                            type=\"number\"\n                            step=\"0.1\"\n                            min=\"0\"\n                            max={maxDepth}\n                            value={afterDipDepth}\n                            onChange={(e) => {\n                              const depth = e.target.value\n                              setAfterDipDepth(depth)\n\n                              if (depth && parseFloat(depth) > 0) {\n                                const validation = validateDepth(parseFloat(depth), tankCapacity)\n                                if (validation.valid) {\n                                  const volume = depthToVolume(parseFloat(depth), tankCapacity)\n                                  setAfterDipReading(volume.toString())\n                                }\n                              } else {\n                                setAfterDipReading('')\n                              }\n                            }}\n                            placeholder=\"Enter depth from dipstick\"\n                            required\n                            className=\"mt-2\"\n                          />\n                          <p className=\"text-xs text-muted-foreground mt-2\">\n                            Using {getTankCapacityLabel(tankCapacity)} chart (max: {maxDepth}cm)\n                          </p>\n                        </div>\n\n                        <div>\n                          <Label htmlFor=\"afterDipReading\" className=\"text-base font-semibold\">Calculated Volume (Litres)</Label>\n                          <Input\n                            id=\"afterDipReading\"\n                            type=\"text\"\n                            value={afterDipReading ? parseFloat(afterDipReading).toLocaleString() : ''}\n                            disabled\n                            placeholder=\"Auto-calculated from depth\"\n                            className=\"mt-2 bg-muted\"\n                          />\n                          <p className=\"text-xs text-muted-foreground mt-2 flex items-start gap-2\">\n                            {afterDipDepth && afterDipReading ? (\n                              <span className=\"text-green-600 font-semibold\">\n                                 {afterDipDepth}cm = {parseFloat(afterDipReading).toLocaleString()}L\n                              </span>\n                            ) : (\n                              <>\n                                <AlertCircle className=\"h-3 w-3 mt-0.5 flex-shrink-0\" />\n                                <span>Measure after delivery truck has finished loading</span>\n                              </>\n                            )}\n                          </p>\n                        </div>\n                      </div>\n                    )\n                  })()}\n                </CardContent>\n              </Card>\n\n              {/* Verification Calculation */}\n              {afterDipReading && verifyingDelivery.beforeDipReading && (() => {\n                const fuelSoldDuring = calculateTotalFuelSold(afterPumpReadings, verifyingDelivery.tankId)\n                const actualReceived = parseFloat(afterDipReading) - verifyingDelivery.beforeDipReading + fuelSoldDuring\n                const variance = actualReceived - verifyingDelivery.invoiceQuantity\n                const variancePercent = (Math.abs(variance) / verifyingDelivery.invoiceQuantity) * 100\n\n\n\n                return (\n                  <Card className=\"bg-purple-500/5 border-purple-500/30\">\n                    <CardHeader>\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold\">\n                          \n                        </div>\n                        <CardTitle className=\"text-purple-600\">Verification & Stock Update</CardTitle>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-5\">\n                        {/* Expected Stock Calculation */}\n                        <div className=\"bg-muted/50 p-4 rounded-lg\">\n                          <div className=\"font-semibold mb-3 text-sm text-muted-foreground\">Expected Stock Calculation:</div>\n                          <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex justify-between items-center\">\n                              <span>Before Dip Reading:</span>\n                              <span className=\"font-semibold\">{verifyingDelivery.beforeDipReading.toLocaleString()}L</span>\n                            </div>\n                            <div className=\"flex justify-between items-center text-green-600\">\n                              <span>+ Invoice Quantity:</span>\n                              <span className=\"font-mono font-semibold\">+{verifyingDelivery.invoiceQuantity.toLocaleString()}L</span>\n                            </div>\n                            <div className=\"flex justify-between items-center text-orange-600\">\n                              <span>- Fuel Sold During Delivery:</span>\n                              <span className=\"font-mono font-semibold\">-{fuelSoldDuring.toLocaleString()}L</span>\n                            </div>\n                            <div className=\"flex justify-between items-center pt-2 border-t font-bold text-base\">\n                              <span>Expected After Dip:</span>\n                              <span className=\"font-mono text-purple-600\">{(verifyingDelivery.beforeDipReading + verifyingDelivery.invoiceQuantity - fuelSoldDuring).toLocaleString()}L</span>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Physical Dip vs Expected */}\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"p-4 bg-green-500/10 rounded-lg border border-green-500/30\">\n                            <div className=\"text-xs text-muted-foreground mb-1\">After Dip (Physical)</div>\n                            <div className=\"font-mono font-bold text-2xl text-green-600\">{parseFloat(afterDipReading).toLocaleString()}L</div>\n                          </div>\n                          <div className=\"p-4 bg-purple-500/10 rounded-lg border border-purple-500/30\">\n                            <div className=\"text-xs text-muted-foreground mb-1\">Expected After Dip</div>\n                            <div className=\"font-mono font-bold text-2xl text-purple-600\">{(verifyingDelivery.beforeDipReading + verifyingDelivery.invoiceQuantity - fuelSoldDuring).toLocaleString()}L</div>\n                          </div>\n                        </div>\n\n                        {/* Actual Received Calculation */}\n                        <div className=\"bg-blue-500/10 p-4 rounded-lg border-2 border-blue-500/30\">\n                          <div className=\"text-sm font-semibold text-muted-foreground mb-3\">Actual Quantity Received:</div>\n                          <div className=\"space-y-1 text-sm mb-3\">\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-muted-foreground\">After Dip:</span>\n                              <span className=\"font-mono\">{parseFloat(afterDipReading).toLocaleString()}L</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-muted-foreground\">Before Dip:</span>\n                              <span className=\"font-mono\">-{verifyingDelivery.beforeDipReading.toLocaleString()}L</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-muted-foreground\">Fuel Sold During:</span>\n                              <span className=\"font-mono\">+{fuelSoldDuring.toLocaleString()}L</span>\n                            </div>\n                          </div>\n                          <div className=\"flex justify-between items-center pt-3 border-t\">\n                            <span className=\"font-bold\">Actual Received:</span>\n                            <span className=\"font-mono font-bold text-3xl text-blue-600\">{actualReceived.toLocaleString()}L</span>\n                          </div>\n                        </div>\n\n                        {/* Variance from Invoice */}\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div className=\"p-3 bg-background rounded-lg\">\n                            <div className=\"text-xs text-muted-foreground mb-1\">Invoice Quantity</div>\n                            <div className=\"font-mono font-bold text-xl\">{verifyingDelivery.invoiceQuantity.toLocaleString()}L</div>\n                          </div>\n                          <div className=\"p-3 bg-background rounded-lg\">\n                            <div className=\"text-xs text-muted-foreground mb-1\">Variance from Invoice</div>\n                            <div className={`font-mono font-bold text-xl ${variance > 0 ? 'text-green-600' : variance < 0 ? 'text-red-600' : 'text-muted-foreground'\n                              }`}>\n                              {variance > 0 ? '+' : ''}{variance.toFixed(1)}L\n                              <span className=\"text-sm ml-1\">({variancePercent.toFixed(2)}%)</span>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )\n              })()}\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setVerifyingDelivery(null)} disabled={verifyLoading}>\n              Cancel\n            </Button>\n            <Button onClick={handleVerifyDelivery} disabled={verifyLoading || !afterDipReading}>\n              {verifyLoading ? 'Verifying...' : (\n                <>\n                  <CheckCircle className=\"mr-2 h-4 w-4\" />\n                  Verify & Update Tank\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Details Dialog */}\n      <Dialog open={showDetails} onOpenChange={setShowDetails}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Delivery Details</DialogTitle>\n            <DialogDescription>Complete delivery verification information</DialogDescription>\n          </DialogHeader>\n\n          {selectedDelivery && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Tank</Label>\n                  <div className=\"font-semibold\">Tank {selectedDelivery.tank?.tankNumber} - {selectedDelivery.tank?.fuel?.icon} {selectedDelivery.tank?.fuel?.name}</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Supplier</Label>\n                  <div className=\"font-semibold\">{selectedDelivery.supplier}</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Invoice Quantity</Label>\n                  <div className=\"font-mono font-semibold\">{selectedDelivery.invoiceQuantity.toLocaleString()}L</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Actual Received</Label>\n                  <div className=\"font-mono font-semibold text-green-600\">{selectedDelivery.actualReceived?.toLocaleString() || '-'}L</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Before Dip</Label>\n                  <div className=\"font-mono\">{selectedDelivery.beforeDipReading?.toLocaleString() || '-'}L</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">After Dip</Label>\n                  <div className=\"font-mono\">{selectedDelivery.afterDipReading?.toLocaleString() || '-'}L</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Fuel Sold During</Label>\n                  <div className=\"font-mono text-orange-600\">{selectedDelivery.fuelSoldDuring?.toLocaleString() || '0'}L</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Variance</Label>\n                  <div className={`font-mono font-semibold ${selectedDelivery.dipVariance && Math.abs(selectedDelivery.dipVariance) > 50\n                    ? 'text-red-600'\n                    : 'text-green-600'\n                    }`}>\n                    {selectedDelivery.dipVariance != null\n                      ? `${selectedDelivery.dipVariance > 0 ? '+' : ''}${selectedDelivery.dipVariance.toFixed(1)}L`\n                      : '-'\n                    }\n                  </div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Received By</Label>\n                  <div>{selectedDelivery.receivedBy}</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Verified By</Label>\n                  <div>{selectedDelivery.verifiedBy || '-'}</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Status</Label>\n                  <div>\n                    {selectedDelivery.verificationStatus === 'VERIFIED' && <Badge className=\"bg-green-600\">Verified</Badge>}\n                    {selectedDelivery.verificationStatus === 'DISCREPANCY' && <Badge variant=\"destructive\">Discrepancy</Badge>}\n                    {selectedDelivery.verificationStatus === 'PENDING_VERIFICATION' && <Badge variant=\"outline\">Pending</Badge>}\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowDetails(false)}>\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\tanks\\dips\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\tanks\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Input' is defined but never used.","line":8,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Alert' is defined but never used.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertDescription' is defined but never used.","line":12,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTitle' is defined but never used.","line":12,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":31,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":32,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BarChart3' is defined but never used.","line":34,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":37,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":88,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":88,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used.","line":89,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":89,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'success' is assigned a value but never used.","line":90,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":90,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSuccess' is assigned a value but never used.","line":90,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":90,"endColumn":29},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTanks'. Either include it or remove the dependency array.","line":122,"column":6,"nodeType":"ArrayExpression","endLine":122,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTanks, selectedStation]","fix":{"range":[3057,3074],"text":"[fetchTanks, selectedStation]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'row' is defined but never used.","line":335,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":335,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  Fuel,\n  Droplets,\n  TrendingUp,\n  AlertCircle,\n  Plus,\n  BarChart3,\n  Truck,\n  FileText,\n  CheckCircle,\n  ChevronDown,\n  ChevronRight,\n  Network,\n  Wrench\n} from 'lucide-react'\n\nimport { TankWithDetails } from '@/types/db'\n\n// ... existing imports\n\ninterface Fuel {\n  id: string\n  name: string\n  icon: string\n  code: string\n}\n\n// Extend our DB type with the calculated fields used in UI\ninterface UITank extends TankWithDetails {\n  stationName?: string\n  fillPercentage: number\n  status: 'NORMAL' | 'LOW' | 'CRITICAL'\n  lastDipTime: string\n  lastDipReading: number\n  currentStock: number\n}\n\ninterface Pump {\n  id: string\n  pumpNumber: string\n  stationId: string\n}\n\ninterface Nozzle {\n  id: string\n  nozzleNumber: string\n  pump: Pump\n}\n\n// Also define the Infrastructure type if possible, or keep as any for now but localized\ninterface Infrastructure {\n  station: { id: string; name: string }\n  tanks: (TankWithDetails & { nozzles: Nozzle[] })[]\n  pumps: Pump[]\n}\n\nexport default function TanksPage() {\n  const router = useRouter()\n  const { stations, selectedStation, getSelectedStation } = useStation()\n  const [tanks, setTanks] = useState<UITank[]>([])\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n\n  interface Dip {\n    id: string\n    reading: number\n    dipDate: string\n    recordedBy: string\n  }\n\n  interface Delivery {\n    id: string\n    quantity: number\n    supplier: string\n    invoiceNumber: string\n    deliveryDate: string\n  }\n\n  // Tank details dialog state\n  const [selectedTank, setSelectedTank] = useState<UITank | null>(null)\n  const [showTankDetails, setShowTankDetails] = useState(false)\n  const [tankDetails, setTankDetails] = useState<UITank & { recentDips: Dip[]; recentDeliveries: Delivery[]; nozzles: Nozzle[] } | null>(null)\n  const [detailsLoading, setDetailsLoading] = useState(false)\n\n  // Infrastructure tree state\n  const [showInfrastructure, setShowInfrastructure] = useState(false)\n  const [infrastructure, setInfrastructure] = useState<Infrastructure | null>(null)\n  const [infraLoading, setInfraLoading] = useState(false)\n  const [expandedTanks, setExpandedTanks] = useState<Set<string>>(new Set())\n\n  useEffect(() => {\n    fetchTanks()\n  }, [selectedStation])\n\n  const fetchTanks = async () => {\n    try {\n      setLoading(true)\n\n      // Build API URL based on station selection\n      const currentStation = getSelectedStation()\n      const apiUrl = currentStation\n        ? `/api/tanks?type=tanks&stationId=${currentStation.id}`\n        : '/api/tanks?type=tanks'\n\n      const response = await fetch(apiUrl)\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch tanks')\n      }\n\n      const data = await response.json()\n\n      // Check if data is an array\n      if (!Array.isArray(data)) {\n        console.error('Expected array but got:', data)\n        setTanks([])\n        return\n      }\n\n      // Transform the data to include calculated fields\n      // The API returns TankWithDetails structure (mostly)\n      const transformedTanks = data.map((tank: TankWithDetails & { station?: { name: string }; currentLevel?: number }) => ({\n        ...tank,\n        // Ensure calculated fields are present\n        tankNumber: tank.tankNumber || 'TANK-1',\n        capacity: tank.capacity,\n        currentStock: tank.currentLevel || 0, // Handle potentially missing field mappings if API differs\n        stationName: tank.station?.name || `Station ${tank.stationId}`,\n        fillPercentage: Math.round(((tank.currentLevel || 0) / tank.capacity) * 100),\n        status: ((tank.currentLevel || 0) / tank.capacity < 0.1 ? 'CRITICAL' :\n          (tank.currentLevel || 0) / tank.capacity < 0.25 ? 'LOW' : 'NORMAL') as 'NORMAL' | 'LOW' | 'CRITICAL',\n        lastDipTime: new Date().toISOString(),\n        lastDipReading: tank.currentLevel || 0\n      }))\n\n      setTanks(transformedTanks)\n\n      // Calculate stats by fuel type\n      const fuelTypeStats: Record<string, { capacity: number; stock: number }> = {}\n\n      transformedTanks.forEach((tank: UITank) => {\n        const fuelName = tank.fuel?.name || 'Unknown'\n        if (!fuelTypeStats[fuelName]) {\n          fuelTypeStats[fuelName] = { capacity: 0, stock: 0 }\n        }\n        fuelTypeStats[fuelName].capacity += tank.capacity\n        fuelTypeStats[fuelName].stock += tank.currentStock\n      })\n\n      setStats({\n        totalTanks: transformedTanks.length,\n        fuelTypes: fuelTypeStats,\n        criticalTanks: transformedTanks.filter((tank: UITank) => tank.status === 'CRITICAL').length,\n        lowTanks: transformedTanks.filter((tank: UITank) => tank.status === 'LOW').length\n      })\n\n    } catch (err) {\n      console.error('Failed to fetch tanks:', err)\n      setError('Failed to load tanks data.')\n      setTanks([])\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const [stats, setStats] = useState<{\n    totalTanks: number;\n    fuelTypes: Record<string, { capacity: number; stock: number }>;\n    criticalTanks: number;\n    lowTanks: number;\n  }>({\n    totalTanks: 0,\n    fuelTypes: {},\n    criticalTanks: 0,\n    lowTanks: 0,\n  })\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'NORMAL': return 'bg-green-500/20 text-green-400 dark:bg-green-600/30 dark:text-green-300'\n      case 'LOW': return 'bg-yellow-500/20 text-yellow-400 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'CRITICAL': return 'bg-red-500/20 text-red-400 dark:bg-red-600/30 dark:text-red-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const getFillColor = (percentage: number) => {\n    if (percentage >= 75) return 'bg-green-500/60 dark:bg-green-500/70'\n    if (percentage >= 50) return 'bg-blue-500/60 dark:bg-blue-500/70'\n    if (percentage >= 25) return 'bg-yellow-500/60 dark:bg-yellow-500/70'\n    return 'bg-red-500/60 dark:bg-red-500/70'\n  }\n\n  const loadInfrastructure = async (stationId: string) => {\n    setInfraLoading(true)\n    try {\n      const response = await fetch(`/api/tanks/infrastructure?stationId=${stationId}`)\n      const data = await response.json()\n\n      if (data.error) {\n        throw new Error(data.error)\n      }\n\n      setInfrastructure(data)\n      setShowInfrastructure(true)\n      // Expand all tanks by default\n      if (data.tanks && Array.isArray(data.tanks)) {\n        setExpandedTanks(new Set(data.tanks.map((t: TankWithDetails) => t.id)))\n      }\n    } catch (err) {\n      console.error('Failed to load infrastructure:', err)\n      setError(err instanceof Error ? err.message : 'Failed to load infrastructure')\n    } finally {\n      setInfraLoading(false)\n    }\n  }\n\n  const toggleTankExpand = (tankId: string) => {\n    setExpandedTanks(prev => {\n      const newSet = new Set(prev)\n      if (newSet.has(tankId)) {\n        newSet.delete(tankId)\n      } else {\n        newSet.add(tankId)\n      }\n      return newSet\n    })\n  }\n\n  const handleTankClick = async (tank: UITank) => {\n    setSelectedTank(tank)\n    setShowTankDetails(true)\n    setDetailsLoading(true)\n\n    try {\n      // Fetch detailed tank information\n      const [tankRes, dipsRes, deliveriesRes] = await Promise.all([\n        fetch(`/api/tanks?id=${tank.id}`),\n        fetch(`/api/tanks/dips?tankId=${tank.id}&limit=5`),\n        fetch(`/api/deliveries?tankId=${tank.id}&limit=5`)\n      ])\n\n      const tankData = await tankRes.json()\n      const dipsData = await dipsRes.json()\n      const deliveriesData = await deliveriesRes.json()\n\n      setTankDetails({\n        ...tankData,\n        recentDips: dipsData || [],\n        recentDeliveries: deliveriesData || [],\n        nozzles: tankData.nozzles || []\n      })\n    } catch (err) {\n      console.error('Failed to load tank details:', err)\n      setTankDetails(null)\n    } finally {\n      setDetailsLoading(false)\n    }\n  }\n\n  const columns: Column<UITank>[] = [\n    {\n      key: 'stationName' as keyof UITank,\n      title: 'Station',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Fuel className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-medium\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'tankNumber' as keyof UITank,\n      title: 'Tank',\n      render: (value: unknown, row: UITank) => (\n        <div className=\"flex items-center gap-2\">\n          <span className=\"font-semibold\">Tank {value as string}</span>\n          <Badge variant=\"outline\">{row.fuel?.icon} {row.fuel?.name || 'Unknown'}</Badge>\n        </div>\n      )\n    },\n    {\n      key: 'capacity' as keyof UITank,\n      title: 'Capacity (L)',\n      render: (value: unknown) => (\n        <span>\n          {(value as number)?.toLocaleString() || 0}L\n        </span>\n      )\n    },\n    {\n      key: 'currentStock' as keyof UITank,\n      title: 'Current Stock (L)',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Droplets className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          <span className=\"font-semibold\">\n            {(value as number)?.toLocaleString() || 0}L\n          </span>\n        </div>\n      )\n    },\n    {\n      key: 'fillPercentage' as keyof UITank,\n      title: 'Fill Level',\n      render: (value: unknown, row: UITank) => {\n        const percentage = value as number\n        return (\n          <div className=\"flex items-center gap-2\">\n            <div className=\"w-20 h-2 bg-muted rounded-full overflow-hidden\">\n              <div\n                className={`h-full ${getFillColor(percentage)} transition-all duration-300`}\n                style={{ width: `${Math.min(percentage, 100)}%` }}\n              />\n            </div>\n            <span className=\"text-sm font-medium\">{percentage}%</span>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'status' as keyof UITank,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge className={getStatusColor(value as string)}>\n          {value as string}\n        </Badge>\n      )\n    },\n    {\n      key: 'lastDipTime' as keyof UITank,\n      title: 'Last Dip',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">\n          {new Date(value as string).toLocaleDateString()}\n        </span>\n      )\n    }\n  ]\n\n  const getFuelTypeColor = (fuelName: string) => {\n    const lower = fuelName.toLowerCase()\n    if (lower.includes('petrol')) return 'text-blue-600 dark:text-blue-400'\n    if (lower.includes('diesel')) return 'text-green-600 dark:text-green-400'\n    if (lower.includes('extra')) return 'text-orange-600 dark:text-orange-400'\n    return 'text-purple-600 dark:text-purple-400'\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <h1 className=\"text-3xl font-bold text-foreground\">Tank Management</h1>\n\n      {/* Statistics Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <FormCard className=\"p-4\" title=\"Total Tanks\">\n          <p className=\"text-3xl font-bold text-purple-600 dark:text-purple-400\">{stats.totalTanks}</p>\n        </FormCard>\n        {Object.entries(stats.fuelTypes).map(([fuelName, data]) => (\n          <FormCard key={fuelName} className=\"p-4\" title={fuelName}>\n            <p className={`text-3xl font-bold ${getFuelTypeColor(fuelName)}`}>\n              {data.capacity.toLocaleString()}L\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              Stock: {data.stock.toLocaleString()}L\n              {data.capacity > 0 && ` (${Math.round((data.stock / data.capacity) * 100)}%)`}\n            </p>\n          </FormCard>\n        ))}\n      </div>\n\n      {/* Quick Actions */}\n      <div className=\"flex flex-wrap gap-4\">\n        <Button variant=\"outline\" onClick={() => router.push('/tanks/dips')}>\n          <Droplets className=\"mr-2 h-4 w-4\" />\n          Record Tank Dip\n        </Button>\n        <Button variant=\"outline\" onClick={() => router.push('/tanks/deliveries')}>\n          <Truck className=\"mr-2 h-4 w-4\" />\n          Record Delivery\n        </Button>\n\n        <Button variant=\"outline\" onClick={() => router.push('/settings/tanks')}>\n          <Network className=\"mr-2 h-4 w-4\" />\n          Manage Tanks & Infrastructure\n        </Button>\n      </div>\n\n      {/* Infrastructure Tree Selector */}\n      {!showInfrastructure && (\n        <FormCard\n          className=\"p-6\"\n          title=\"View Infrastructure Tree\"\n          description=\"See all tanks, pumps, and nozzles for a station\"\n          actions={\n            <Select onValueChange={(value) => loadInfrastructure(value)} disabled={infraLoading}>\n              <SelectTrigger className=\"w-[250px]\">\n                <SelectValue placeholder=\"Select station to view\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    {station.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          }\n        >\n          <></>\n        </FormCard>\n      )}\n\n      {/* Infrastructure Tree Display */}\n      {showInfrastructure && infrastructure && (\n        <FormCard title={`Infrastructure: ${infrastructure.station.name}`} className=\"p-6\">\n          <div className=\"space-y-4\">\n            {/* Tanks Section */}\n            {infrastructure.tanks.length > 0 && (\n              <div>\n                <h4 className=\"text-md font-semibold mb-3 flex items-center gap-2\">\n                  <Fuel className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n                  Tanks ({infrastructure.tanks.length})\n                </h4>\n                <div className=\"space-y-2 border-l-2 border-border pl-4\">\n                  {infrastructure.tanks.map((tank) => {\n                    const isExpanded = expandedTanks.has(tank.id)\n                    const fillPercentage = Math.round(((tank.currentLevel || 0) / tank.capacity) * 100)\n                    return (\n                      <div key={tank.id} className=\"space-y-1\">\n                        <button\n                          onClick={() => toggleTankExpand(tank.id)}\n                          className=\"flex items-center gap-2 w-full text-left hover:bg-muted p-2 rounded-md transition-colors\"\n                        >\n                          {isExpanded ? (\n                            <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                          ) : (\n                            <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                          )}\n                          <Fuel className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n                          <span className=\"font-semibold\">{tank.fuel?.icon} {tank.fuel?.name || 'Unknown'}</span>\n                          <Badge variant=\"outline\">\n                            {fillPercentage}% full\n                          </Badge>\n                          <span className=\"text-xs text-muted-foreground ml-auto\">\n                            {tank.currentLevel.toLocaleString()}L / {tank.capacity.toLocaleString()}L\n                          </span>\n                        </button>\n                        {isExpanded && tank.nozzles.length > 0 && (\n                          <div className=\"ml-8 space-y-1 border-l-2 border-blue-500/20 dark:border-blue-500/30 pl-4\">\n                            {tank.nozzles.map((nozzle) => (\n                              <div key={nozzle.id} className=\"flex items-center gap-2 text-sm text-muted-foreground py-1\">\n                                <Droplets className=\"h-3 w-3 text-green-600 dark:text-green-400\" />\n                                Nozzle {nozzle.nozzleNumber}\n                              </div>\n                            ))}\n                          </div>\n                        )}\n                        {isExpanded && tank.nozzles.length === 0 && (\n                          <div className=\"ml-8 text-sm text-muted-foreground italic\">\n                            No nozzles connected\n                          </div>\n                        )}\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n\n            {infrastructure.tanks.length === 0 && (\n              <div className=\"text-center text-muted-foreground py-8\">\n                <Network className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground\" />\n                <p>No infrastructure found for this station.</p>\n                <Button\n                  variant=\"outline\"\n                  className=\"mt-4\"\n                  onClick={() => router.push('/settings/tanks')}\n                >\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Create Infrastructure\n                </Button>\n              </div>\n            )}\n          </div>\n\n          <div className=\"mt-6 pt-4 border-t\">\n            <Button variant=\"outline\" onClick={() => setShowInfrastructure(false)}>\n              Close View\n            </Button>\n          </div>\n        </FormCard>\n      )}\n\n      {/* Tanks Table */}\n      <FormCard title=\"Tank Overview\" className=\"p-6\">\n        <DataTable\n          data={tanks}\n          columns={columns}\n          searchPlaceholder=\"Search tanks...\"\n          emptyMessage=\"No tanks found.\"\n          onRowClick={handleTankClick}\n        />\n      </FormCard>\n\n      {/* Tank Details Dialog */}\n      <Dialog open={showTankDetails} onOpenChange={setShowTankDetails}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Fuel className=\"h-5 w-5 text-orange-600 dark:text-orange-400\" />\n              Tank Details: {selectedTank?.tankNumber || 'Loading...'}\n            </DialogTitle>\n            <DialogDescription>\n              Complete information about this fuel tank\n            </DialogDescription>\n          </DialogHeader>\n\n          {detailsLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <div className=\"text-muted-foreground\">Loading tank details...</div>\n            </div>\n          ) : tankDetails ? (\n            <div className=\"space-y-6\">\n              {/* Basic Information */}\n              <div className=\"grid grid-cols-2 gap-4 p-4 bg-muted rounded-lg\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Tank Number</Label>\n                  <div className=\"font-semibold\">{tankDetails.tankNumber || 'N/A'}</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Fuel Type</Label>\n                  <div>\n                    <Badge variant=\"outline\">{tankDetails.fuel?.icon} {tankDetails.fuel?.name || 'N/A'}</Badge>\n                  </div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Station</Label>\n                  <div className=\"font-medium\">{tankDetails.station?.name || 'N/A'}</div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">Status</Label>\n                  <div>\n                    <Badge className={getStatusColor(selectedTank?.status || 'NORMAL')}>\n                      {selectedTank?.status || 'NORMAL'}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n\n              {/* Capacity & Stock */}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-4 border rounded-lg\">\n                  <Label className=\"text-xs text-muted-foreground mb-2 block\">Capacity</Label>\n                  <div className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n                    {tankDetails.capacity?.toLocaleString() || 0}L\n                  </div>\n                </div>\n                <div className=\"p-4 border rounded-lg\">\n                  <Label className=\"text-xs text-muted-foreground mb-2 block\">Current Level</Label>\n                  <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                    {tankDetails.currentLevel?.toLocaleString() || 0}L\n                  </div>\n                  <div className=\"text-sm text-muted-foreground mt-1\">\n                    {tankDetails.capacity ?\n                      `${Math.round((tankDetails.currentLevel / tankDetails.capacity) * 100)}% full` :\n                      'N/A'}\n                  </div>\n                </div>\n              </div>\n\n              {/* Fill Level Progress */}\n              {tankDetails.capacity && (\n                <div className=\"p-4 border rounded-lg\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <Label className=\"text-sm font-semibold\">Fill Level</Label>\n                    <span className=\"text-sm font-medium\">\n                      {Math.round((tankDetails.currentLevel / tankDetails.capacity) * 100)}%\n                    </span>\n                  </div>\n                  <div className=\"w-full h-3 bg-muted rounded-full overflow-hidden\">\n                    <div\n                      className={`h-full ${getFillColor(Math.round((tankDetails.currentLevel / tankDetails.capacity) * 100))} transition-all duration-300`}\n                      style={{ width: `${Math.min((tankDetails.currentLevel / tankDetails.capacity) * 100, 100)}%` }}\n                    />\n                  </div>\n                  <div className=\"flex justify-between text-xs text-muted-foreground mt-1\">\n                    <span>0L</span>\n                    <span>{tankDetails.capacity.toLocaleString()}L</span>\n                  </div>\n                </div>\n              )}\n\n              {/* Connected Nozzles */}\n              {tankDetails.nozzles && tankDetails.nozzles.length > 0 && (\n                <div className=\"p-4 border rounded-lg\">\n                  <Label className=\"text-sm font-semibold mb-3 block flex items-center gap-2\">\n                    <Droplets className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                    Connected Nozzles ({tankDetails.nozzles.length})\n                  </Label>\n                  <div className=\"space-y-2\">\n                    {tankDetails.nozzles.map((nozzle) => (\n                      <div key={nozzle.id} className=\"flex items-center gap-2 text-sm p-2 bg-muted rounded\">\n                        <Wrench className=\"h-3 w-3 text-blue-600 dark:text-blue-400\" />\n                        <span className=\"font-medium\">Nozzle {nozzle.nozzleNumber || 'N/A'}</span>\n                        <span></span>\n                        <span>Nozzle {nozzle.nozzleNumber || 'N/A'}</span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Recent Dips */}\n              {tankDetails.recentDips && tankDetails.recentDips.length > 0 && (\n                <div className=\"p-4 border rounded-lg\">\n                  <Label className=\"text-sm font-semibold mb-3 block flex items-center gap-2\">\n                    <Droplets className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                    Recent Dips ({tankDetails.recentDips.length})\n                  </Label>\n                  <div className=\"space-y-2\">\n                    {tankDetails.recentDips.map((dip) => (\n                      <div key={dip.id} className=\"flex items-center justify-between text-sm p-2 bg-muted rounded\">\n                        <div>\n                          <div className=\"font-medium\">{dip.reading?.toLocaleString() || 0}L</div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {new Date(dip.dipDate).toLocaleString()}\n                          </div>\n                        </div>\n                        <div className=\"text-xs text-muted-foreground\">by {dip.recordedBy}</div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Recent Deliveries */}\n              {tankDetails.recentDeliveries && tankDetails.recentDeliveries.length > 0 && (\n                <div className=\"p-4 border rounded-lg\">\n                  <Label className=\"text-sm font-semibold mb-3 block flex items-center gap-2\">\n                    <Truck className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                    Recent Deliveries ({tankDetails.recentDeliveries.length})\n                  </Label>\n                  <div className=\"space-y-2\">\n                    {tankDetails.recentDeliveries.map((delivery) => (\n                      <div key={delivery.id} className=\"flex items-center justify-between text-sm p-2 bg-muted rounded\">\n                        <div>\n                          <div className=\"font-medium text-green-600 dark:text-green-400\">\n                            +{delivery.quantity?.toLocaleString() || 0}L\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {delivery.supplier}  {delivery.invoiceNumber || 'N/A'}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {new Date(delivery.deliveryDate).toLocaleString()}\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-center text-muted-foreground py-8\">\n              Failed to load tank details\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowTankDetails(false)}>\n              Close\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\tanks\\report\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tanks' is assigned a value but never used.","line":78,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":78,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":94,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":94,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":110,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":110,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":200,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":200,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Fuel,\n  Calendar,\n  TrendingUp,\n  TrendingDown,\n  AlertCircle,\n  CheckCircle,\n  Building2,\n  Droplets,\n  Truck,\n  TestTube,\n  Calculator,\n  ArrowLeft\n} from 'lucide-react'\n\ninterface Station {\n  id: string\n  name: string\n  city: string\n}\n\ninterface Tank {\n  id: string\n  stationId: string\n  tankNumber: string\n  fuelType: string\n  capacity: number\n}\n\ninterface TankReport {\n  tankId: string\n  tankNumber: string\n  fuelType: string\n  capacity: number\n  openingStock: number\n  deliveries: number\n  sales: number\n  testReturns: number\n  closingBookStock: number\n  closingDipStock: number\n  variance: number\n  variancePercentage: number\n  toleranceStatus: 'NORMAL' | 'WARNING' | 'CRITICAL'\n  toleranceLimit: number\n}\n\ninterface StationReport {\n  stationId: string\n  stationName: string\n  reportDate: string\n  tanks: TankReport[]\n  totalVariance: number\n  totalVariancePercentage: number\n  overallStatus: 'NORMAL' | 'WARNING' | 'CRITICAL'\n}\n\nexport default function TankReportPage() {\n  const router = useRouter()\n  const [stations, setStations] = useState<Station[]>([])\n  const [tanks, setTanks] = useState<Tank[]>([])\n  const [report, setReport] = useState<StationReport | null>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n\n  // Form state\n  const { selectedStation, setSelectedStation } = useStation()\n  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0])\n\n  // Load initial data\n  useEffect(() => {\n    const loadData = async () => {\n      try {\n        const response = await fetch('/api/stations?active=true')\n        const stationsData = await response.json()\n        setStations(stationsData)\n      } catch (err) {\n        setError('Failed to load stations')\n      }\n    }\n\n    loadData()\n  }, [])\n\n  // Load tanks when station changes\n  useEffect(() => {\n    if (selectedStation) {\n      const loadTanks = async () => {\n        try {\n          const response = await fetch(`/api/tanks?stationId=${selectedStation}&type=tanks`)\n          const tanksData = await response.json()\n          setTanks(tanksData)\n        } catch (err) {\n          setError('Failed to load tanks')\n        }\n      }\n\n      loadTanks()\n    } else {\n      setTanks([])\n    }\n  }, [selectedStation])\n\n  const generateReport = async () => {\n    if (!selectedStation || !selectedDate) {\n      setError('Please select both station and date')\n      return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      // Call the real API endpoint\n      const response = await fetch(`/api/tanks/report?stationId=${selectedStation}&date=${selectedDate}`)\n\n      if (!response.ok) {\n        throw new Error('Failed to generate report')\n      }\n\n      const apiData = await response.json()\n\n      // Transform API data to match our interface\n      interface TankReportData {\n        tankId: string\n        tankNumber: string\n        fuelType: string\n        capacity: number\n        openingStock: number\n        deliveries: number\n        sales: number\n        testReturns: number\n        closingBookStock: number\n        closingDipStock: number\n        variance: number\n        variancePercentage: number\n        toleranceStatus: 'NORMAL' | 'WARNING' | 'CRITICAL'\n        toleranceLimit: number\n      }\n      const tankReports: TankReport[] = apiData.tanks.map((tank: TankReportData) => ({\n        tankId: tank.tankId,\n        tankNumber: tank.tankNumber,\n        fuelType: tank.fuelType,\n        capacity: tank.capacity,\n        openingStock: tank.openingStock,\n        deliveries: tank.deliveries,\n        sales: tank.sales,\n        testReturns: tank.testReturns,\n        closingBookStock: tank.closingBookStock,\n        closingDipStock: tank.closingDipStock,\n        variance: tank.variance,\n        variancePercentage: tank.variancePercentage,\n        toleranceStatus: tank.toleranceStatus,\n        toleranceLimit: tank.toleranceLimit\n      }))\n\n      // Use data from API\n      const totalVariance = apiData.totalVariance\n      const totalVariancePercentage = apiData.totalVariancePercentage\n\n      const criticalTanks = tankReports.filter(t => t.toleranceStatus === 'CRITICAL').length\n      const warningTanks = tankReports.filter(t => t.toleranceStatus === 'WARNING').length\n\n      let overallStatus: 'NORMAL' | 'WARNING' | 'CRITICAL' = 'NORMAL'\n      if (criticalTanks > 0) {\n        overallStatus = 'CRITICAL'\n      } else if (warningTanks > 0) {\n        overallStatus = 'WARNING'\n      }\n\n      const stationReport: StationReport = {\n        stationId: selectedStation,\n        stationName: apiData.stationName || 'Unknown Station',\n        reportDate: selectedDate,\n        tanks: tankReports,\n        totalVariance: totalVariance,\n        totalVariancePercentage: totalVariancePercentage,\n        overallStatus\n      }\n\n      setReport(stationReport)\n\n    } catch (err) {\n      setError('Failed to generate report')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const getStatusColor = (status: 'NORMAL' | 'WARNING' | 'CRITICAL') => {\n    switch (status) {\n      case 'NORMAL': return 'text-green-600 dark:text-green-400 bg-green-500/10 dark:bg-green-500/20 border-green-500/20 dark:border-green-500/30'\n      case 'WARNING': return 'text-yellow-600 dark:text-yellow-400 bg-yellow-500/10 dark:bg-yellow-500/20 border-yellow-500/20 dark:border-yellow-500/30'\n      case 'CRITICAL': return 'text-red-600 dark:text-red-400 bg-red-500/10 dark:bg-red-500/20 border-red-500/20 dark:border-red-500/30'\n    }\n  }\n\n  const getStatusIcon = (status: 'NORMAL' | 'WARNING' | 'CRITICAL') => {\n    switch (status) {\n      case 'NORMAL': return <CheckCircle className=\"h-4 w-4\" />\n      case 'WARNING': return <AlertCircle className=\"h-4 w-4\" />\n      case 'CRITICAL': return <AlertCircle className=\"h-4 w-4\" />\n    }\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"outline\" onClick={() => router.push('/tanks')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <h1 className=\"text-3xl font-bold text-foreground\">Tank Variance Report</h1>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <FormCard title=\"Generate Report\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <Label htmlFor=\"station\">Station</Label>\n            <Select value={selectedStation} onValueChange={setSelectedStation} disabled={loading}>\n              <SelectTrigger id=\"station\">\n                <SelectValue placeholder=\"Select a station\" />\n              </SelectTrigger>\n              <SelectContent>\n                {stations.map((station) => (\n                  <SelectItem key={station.id} value={station.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      {station.name} ({station.city})\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div>\n            <Label htmlFor=\"date\">Report Date</Label>\n            <input\n              id=\"date\"\n              type=\"date\"\n              value={selectedDate}\n              onChange={(e) => setSelectedDate(e.target.value)}\n              className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n              disabled={loading}\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <Button onClick={generateReport} disabled={loading || !selectedStation || !selectedDate}>\n              {loading ? 'Generating...' : (\n                <>\n                  <Calculator className=\"mr-2 h-4 w-4\" />\n                  Generate Report\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n      </FormCard>\n\n      {report && (\n        <div className=\"space-y-6\">\n          {/* Report Header */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Calendar className=\"h-5 w-5\" />\n                Tank Variance Report - {report.stationName}\n              </CardTitle>\n              <p className=\"text-sm text-muted-foreground\">\n                Report Date: {new Date(report.reportDate).toLocaleDateString()}\n              </p>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"text-center\">\n                  <div className=\"text-2xl font-bold text-foreground\">\n                    {report.tanks.length}\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Total Tanks</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className={`text-2xl font-bold ${report.totalVariance >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                    {report.totalVariance >= 0 ? '+' : ''}{report.totalVariance.toLocaleString()}L\n                  </div>\n                  <div className=\"text-sm text-muted-foreground\">Total Variance</div>\n                </div>\n                <div className=\"text-center\">\n                  <Badge className={getStatusColor(report.overallStatus)}>\n                    {getStatusIcon(report.overallStatus)}\n                    <span className=\"ml-1\">{report.overallStatus}</span>\n                  </Badge>\n                  <div className=\"text-sm text-muted-foreground mt-1\">Overall Status</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Tank Details */}\n          <div className=\"grid gap-4\">\n            {report.tanks.map((tank) => (\n              <Card key={tank.tankId}>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <Fuel className=\"h-5 w-5\" />\n                      Tank {tank.tankNumber} - {tank.fuelType}\n                    </div>\n                    <Badge className={getStatusColor(tank.toleranceStatus)}>\n                      {getStatusIcon(tank.toleranceStatus)}\n                      <span className=\"ml-1\">{tank.toleranceStatus}</span>\n                    </Badge>\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 text-sm\">\n                    {/* Opening Stock */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        <Droplets className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                        <span className=\"font-medium\">Opening</span>\n                      </div>\n                      <div className=\"text-lg\">{tank.openingStock.toLocaleString()}L</div>\n                    </div>\n\n                    {/* Deliveries */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        <Truck className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                        <span className=\"font-medium\">Deliveries</span>\n                      </div>\n                      <div className=\"text-lg text-green-600 dark:text-green-400\">+{tank.deliveries.toLocaleString()}L</div>\n                    </div>\n\n                    {/* Sales */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        <TrendingDown className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n                        <span className=\"font-medium\">Sales</span>\n                      </div>\n                      <div className=\"text-lg text-red-600 dark:text-red-400\">-{tank.sales.toLocaleString()}L</div>\n                    </div>\n\n                    {/* Test Returns */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        <TestTube className=\"h-4 w-4 text-purple-600 dark:text-purple-400\" />\n                        <span className=\"font-medium\">Test Returns</span>\n                      </div>\n                      <div className=\"text-lg text-purple-600 dark:text-purple-400\">+{tank.testReturns.toLocaleString()}L</div>\n                    </div>\n\n                    {/* Book Stock */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        <Calculator className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"font-medium\">Book Stock</span>\n                      </div>\n                      <div className=\"text-lg\">{tank.closingBookStock.toLocaleString()}L</div>\n                    </div>\n\n                    {/* Dip Stock */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        <Droplets className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                        <span className=\"font-medium\">Dip Stock</span>\n                      </div>\n                      <div className=\"text-lg font-semibold\">{tank.closingDipStock.toLocaleString()}L</div>\n                    </div>\n\n                    {/* Variance */}\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center justify-center gap-1 mb-1\">\n                        {tank.variance >= 0 ? (\n                          <TrendingUp className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                        ) : (\n                          <TrendingDown className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n                        )}\n                        <span className=\"font-medium\">Variance</span>\n                      </div>\n                      <div className={`text-lg font-bold ${tank.variance >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                        {tank.variance >= 0 ? '+' : ''}{tank.variance.toLocaleString()}L\n                      </div>\n                      <div className={`text-xs ${Math.abs(tank.variancePercentage) <= 2 ? 'text-muted-foreground' : 'text-red-600 dark:text-red-400'}`}>\n                        ({tank.variancePercentage >= 0 ? '+' : ''}{tank.variancePercentage.toFixed(2)}%)\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Tolerance Information */}\n                  <div className=\"mt-4 pt-4 border-t\">\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">\n                        Tolerance Limit: {tank.toleranceLimit.toLocaleString()}L\n                      </span>\n                      <span className={`font-medium ${tank.toleranceStatus === 'NORMAL' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                        {Math.abs(tank.variance) <= tank.toleranceLimit ? 'Within Tolerance' : 'Exceeds Tolerance'}\n                      </span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n\n          {/* Summary */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Report Summary</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Tanks within tolerance</div>\n                  <div className=\"text-2xl font-bold text-green-600 dark:text-green-400\">\n                    {report.tanks.filter(t => t.toleranceStatus === 'NORMAL').length}\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Tanks with warnings</div>\n                  <div className=\"text-2xl font-bold text-yellow-600 dark:text-yellow-400\">\n                    {report.tanks.filter(t => t.toleranceStatus === 'WARNING').length}\n                  </div>\n                </div>\n                <div>\n                  <div className=\"text-sm text-muted-foreground\">Critical tanks</div>\n                  <div className=\"text-2xl font-bold text-red-600 dark:text-red-400\">\n                    {report.tanks.filter(t => t.toleranceStatus === 'CRITICAL').length}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(app)\\tanks\\setup\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Settings' is defined but never used.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":11},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadNozzles', 'loadPumps', and 'loadTanks'. Either include them or remove the dependency array.","line":88,"column":6,"nodeType":"ArrayExpression","endLine":88,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [loadNozzles, loadPumps, loadTanks, selectedStation]","fix":{"range":[2358,2375],"text":"[loadNozzles, loadPumps, loadTanks, selectedStation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useStation } from '@/contexts/StationContext'\nimport { FormCard } from '@/components/ui/FormCard'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Badge } from '@/components/ui/badge'\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { DataTable, Column } from '@/components/ui/DataTable'\nimport {\n  Settings,\n  Plus,\n  AlertCircle,\n  CheckCircle,\n  Fuel,\n  Droplets,\n  Wrench,\n  ArrowLeft\n} from 'lucide-react'\n\ninterface Pump {\n  id: string\n  pumpNumber: string\n  station: { name: string }\n  nozzles: { id: string; nozzleNumber: string; tank: { fuel?: { name: string } } }[]\n}\n\ninterface Nozzle {\n  id: string\n  nozzleNumber: string\n  pump: { pumpNumber: string }\n  tank: { fuel?: { name: string }; fuelType?: string }\n  isActive: boolean\n}\n\ninterface Tank {\n  id: string\n  fuelName?: string\n  fuel?: { name: string; icon?: string }\n  capacity: number\n  currentLevel: number\n}\n\nexport default function InfrastructureSetupPage() {\n  const router = useRouter()\n  const { stations } = useStation()\n\n  // Common state\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n  const [selectedStation, setSelectedStation] = useState('')\n\n  // Pump state\n  const [pumps, setPumps] = useState<Pump[]>([])\n  const [pumpNumber, setPumpNumber] = useState('')\n  const [pumpLoading, setPumpLoading] = useState(false)\n\n  // Nozzle state\n  const [nozzles, setNozzles] = useState<Nozzle[]>([])\n  const [tanks, setTanks] = useState<Tank[]>([])\n  const [selectedPump, setSelectedPump] = useState('')\n  const [selectedTank, setSelectedTank] = useState('')\n  const [nozzleNumber, setNozzleNumber] = useState('')\n  const [nozzleLoading, setNozzleLoading] = useState(false)\n\n  // Load pumps and nozzles when station changes\n  useEffect(() => {\n    if (selectedStation) {\n      loadPumps()\n      loadNozzles()\n      loadTanks()\n    } else {\n      setPumps([])\n      setNozzles([])\n      setTanks([])\n    }\n  }, [selectedStation])\n\n  const loadPumps = async () => {\n    try {\n      const response = await fetch(`/api/pumps?stationId=${selectedStation}`)\n      const data = await response.json()\n      setPumps(data)\n    } catch (err) {\n      console.error('Failed to load pumps:', err)\n    }\n  }\n\n  const loadNozzles = async () => {\n    try {\n      const response = await fetch(`/api/nozzles?stationId=${selectedStation}`)\n      const data = await response.json()\n      setNozzles(data)\n    } catch (err) {\n      console.error('Failed to load nozzles:', err)\n    }\n  }\n\n  const loadTanks = async () => {\n    try {\n      const response = await fetch(`/api/tanks?stationId=${selectedStation}&type=tanks`)\n      const data = await response.json()\n      setTanks(data)\n    } catch (err) {\n      console.error('Failed to load tanks:', err)\n    }\n  }\n\n  const handleCreatePump = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !pumpNumber) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    setPumpLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/pumps', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          stationId: selectedStation,\n          pumpNumber,\n          isActive: true\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to create pump')\n      }\n\n      setSuccess('Pump created successfully!')\n      setPumpNumber('')\n      loadPumps()\n      setTimeout(() => setSuccess(''), 3000)\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to create pump')\n    } finally {\n      setPumpLoading(false)\n    }\n  }\n\n  const handleCreateNozzle = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!selectedStation || !selectedPump || !selectedTank || !nozzleNumber) {\n      setError('Please fill in all required fields')\n      return\n    }\n\n    setNozzleLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const response = await fetch('/api/nozzles', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          pumpId: selectedPump,\n          tankId: selectedTank,\n          nozzleNumber,\n          isActive: true\n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to create nozzle')\n      }\n\n      setSuccess('Nozzle created successfully!')\n      setSelectedPump('')\n      setSelectedTank('')\n      setNozzleNumber('')\n      loadNozzles()\n      setTimeout(() => setSuccess(''), 3000)\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to create nozzle')\n    } finally {\n      setNozzleLoading(false)\n    }\n  }\n\n  const pumpColumns: Column<Pump>[] = [\n    {\n      key: 'pumpNumber' as keyof Pump,\n      title: 'Pump Number',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Wrench className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          <span className=\"font-semibold\">{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'station' as keyof Pump,\n      title: 'Station',\n      render: (value: unknown) => (\n        <span className=\"text-sm text-muted-foreground\">{(value as { name: string }).name}</span>\n      )\n    },\n    {\n      key: 'nozzles' as keyof Pump,\n      title: 'Nozzles',\n      render: (value: unknown) => (\n        <div className=\"flex flex-wrap gap-2\">\n          {(value as { nozzleNumber: string; tank: { fuel?: { name: string } } }[]).map((nozzle) => (\n            <Badge key={nozzle.nozzleNumber} variant=\"outline\">\n              {nozzle.nozzleNumber}  {nozzle.tank.fuel?.name || 'Unknown'}\n            </Badge>\n          ))}\n        </div>\n      )\n    }\n  ]\n\n  const nozzleColumns: Column<Nozzle>[] = [\n    {\n      key: 'pump' as keyof Nozzle,\n      title: 'Pump',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Wrench className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n          <span className=\"font-medium\">{(value as { pumpNumber: string }).pumpNumber}</span>\n        </div>\n      )\n    },\n    {\n      key: 'nozzleNumber' as keyof Nozzle,\n      title: 'Nozzle',\n      render: (value: unknown) => (\n        <div className=\"flex items-center gap-2\">\n          <Droplets className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n          <span className=\"font-semibold\">#{value as string}</span>\n        </div>\n      )\n    },\n    {\n      key: 'tank' as keyof Nozzle,\n      title: 'Tank / Fuel Type',\n      render: (value: unknown) => {\n        const tank = value as { fuel?: { name: string }; fuelType?: string }\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Fuel className=\"h-4 w-4 text-orange-600 dark:text-orange-400\" />\n            <Badge variant=\"outline\">{tank.fuel?.name || tank.fuelType || 'Unknown'}</Badge>\n          </div>\n        )\n      }\n    },\n    {\n      key: 'isActive' as keyof Nozzle,\n      title: 'Status',\n      render: (value: unknown) => (\n        <Badge variant={value ? 'default' : 'secondary'}>\n          {value ? 'Active' : 'Inactive'}\n        </Badge>\n      )\n    }\n  ]\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"outline\" onClick={() => router.push('/tanks')}>\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back\n        </Button>\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Infrastructure Setup</h1>\n          <p className=\"text-muted-foreground\">Manage pumps, nozzles, and their connections</p>\n        </div>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>Error</AlertTitle>\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      {success && (\n        <Alert>\n          <CheckCircle className=\"h-4 w-4\" />\n          <AlertTitle>Success</AlertTitle>\n          <AlertDescription>{success}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* Station Selection */}\n      <FormCard title=\"Select Station\" className=\"p-4\">\n        <div>\n          <Label htmlFor=\"infra-station\">Select Station</Label>\n          <Select value={selectedStation} onValueChange={setSelectedStation}>\n            <SelectTrigger id=\"infra-station\" className=\"mt-2\">\n              <SelectValue placeholder=\"Select a station to manage\" />\n            </SelectTrigger>\n            <SelectContent>\n              {stations.map((station) => (\n                <SelectItem key={station.id} value={station.id}>\n                  {station.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      </FormCard>\n\n      {selectedStation && (\n        <Tabs defaultValue=\"pumps\" className=\"space-y-6\">\n          <TabsList>\n            <TabsTrigger value=\"pumps\">\n              <Wrench className=\"mr-2 h-4 w-4\" />\n              Pumps\n            </TabsTrigger>\n            <TabsTrigger value=\"nozzles\">\n              <Droplets className=\"mr-2 h-4 w-4\" />\n              Nozzles\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"pumps\" className=\"space-y-4\">\n            <FormCard title=\"Create New Pump\">\n              <form onSubmit={handleCreatePump} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"pumpNumber\">Pump Number *</Label>\n                  <Input\n                    id=\"pumpNumber\"\n                    value={pumpNumber}\n                    onChange={(e) => setPumpNumber(e.target.value)}\n                    placeholder=\"P-01\"\n                    disabled={pumpLoading}\n                    required\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">Unique identifier for this pump</p>\n                </div>\n\n                <Button type=\"submit\" disabled={pumpLoading}>\n                  {pumpLoading ? 'Creating...' : (\n                    <>\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Create Pump\n                    </>\n                  )}\n                </Button>\n              </form>\n            </FormCard>\n\n            <FormCard title=\"Existing Pumps\">\n              <DataTable\n                data={pumps}\n                columns={pumpColumns}\n                searchPlaceholder=\"Search pumps...\"\n                emptyMessage=\"No pumps found. Create one to get started!\"\n              />\n            </FormCard>\n          </TabsContent>\n\n          <TabsContent value=\"nozzles\" className=\"space-y-4\">\n            <FormCard title=\"Create New Nozzle\">\n              <form onSubmit={handleCreateNozzle} className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <Label htmlFor=\"nozzlePump\">Pump *</Label>\n                    <Select value={selectedPump} onValueChange={setSelectedPump} disabled={nozzleLoading}>\n                      <SelectTrigger id=\"nozzlePump\">\n                        <SelectValue placeholder=\"Select pump\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {pumps.map((pump) => (\n                          <SelectItem key={pump.id} value={pump.id}>\n                            {pump.pumpNumber}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"nozzleTank\">Tank / Fuel Type *</Label>\n                    <Select value={selectedTank} onValueChange={setSelectedTank} disabled={nozzleLoading}>\n                      <SelectTrigger id=\"nozzleTank\">\n                        <SelectValue placeholder=\"Select tank\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {tanks.map((tank) => (\n                          <SelectItem key={tank.id} value={tank.id}>\n                            <div className=\"flex items-center gap-2\">\n                              <Fuel className=\"h-4 w-4\" />\n                              <span>{tank.fuel?.name || tank.fuelName || 'Unknown'}</span>\n                              <span className=\"text-xs text-muted-foreground\">\n                                ({tank.capacity.toLocaleString()}L)\n                              </span>\n                            </div>\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"nozzleNumber\">Nozzle Number *</Label>\n                    <Input\n                      id=\"nozzleNumber\"\n                      value={nozzleNumber}\n                      onChange={(e) => setNozzleNumber(e.target.value)}\n                      placeholder=\"01\"\n                      disabled={nozzleLoading}\n                      required\n                    />\n                  </div>\n                </div>\n\n                <Button type=\"submit\" disabled={nozzleLoading}>\n                  {nozzleLoading ? 'Creating...' : (\n                    <>\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Create Nozzle\n                    </>\n                  )}\n                </Button>\n              </form>\n            </FormCard>\n\n            <FormCard title=\"Existing Nozzles\">\n              <DataTable\n                data={nozzles}\n                columns={nozzleColumns}\n                searchPlaceholder=\"Search nozzles...\"\n                emptyMessage=\"No nozzles found. Create one to connect pumps to tanks!\"\n              />\n            </FormCard>\n          </TabsContent>\n        </Tabs>\n      )}\n\n      {!selectedStation && (\n        <Alert>\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertTitle>No Station Selected</AlertTitle>\n          <AlertDescription>Please select a station to view and manage its infrastructure.</AlertDescription>\n        </Alert>\n      )}\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(auth)\\force-change-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(auth)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\(auth)\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\admin\\reset-password\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\audit-log\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ipAddress' is assigned a value but never used.","line":18,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { createAuditLogManual } from '@/lib/audit'\r\nimport { AuditAction } from '@/lib/audit'\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const body = await request.json()\r\n        const {\r\n            userId,\r\n            userName,\r\n            userRole,\r\n            action,\r\n            entity,\r\n            entityId,\r\n            details,\r\n            stationId,\r\n            stationName,\r\n            ipAddress\r\n        } = body\r\n\r\n        // Validate required fields\r\n        if (!userId || !userName || !action || !entity || !details) {\r\n            return NextResponse.json(\r\n                { error: 'Missing required audit log fields' },\r\n                { status: 400 }\r\n            )\r\n        }\r\n\r\n        // Create the audit log entry\r\n        await createAuditLogManual(\r\n            {\r\n                action: action as AuditAction,\r\n                entity,\r\n                entityId,\r\n                details,\r\n                stationId,\r\n                stationName\r\n            },\r\n            userId,\r\n            userName,\r\n            userRole\r\n        )\r\n\r\n        return NextResponse.json({ success: true }, { status: 201 })\r\n    } catch (error) {\r\n        console.error('API Audit Log Error:', error)\r\n        return NextResponse.json(\r\n            { error: 'Internal Server Error' },\r\n            { status: 500 }\r\n        )\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\audits\\meter\\stats\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\auth\\change-password\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\auth\\login\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\auth\\me\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":25,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport jwt, { JwtPayload } from 'jsonwebtoken'\nimport { getJwtSecret } from '@/lib/jwt'\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Get authorization header\n    const authHeader = request.headers.get('authorization')\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { detail: 'Authorization header missing or invalid' },\n        { status: 401 }\n      )\n    }\n\n    // Extract token\n    const token = authHeader.substring(7)\n\n    // Verify token\n    let decoded: JwtPayload | string\n    try {\n      decoded = jwt.verify(token, getJwtSecret()) as JwtPayload\n    } catch (error) {\n      return NextResponse.json(\n        { detail: 'Invalid or expired token' },\n        { status: 401 }\n      )\n    }\n\n    // Get user from database\n    const user = await prisma.user.findUnique({\n      where: { username: decoded.sub as string },\n      include: {\n        station: {\n          select: {\n            id: true,\n            name: true,\n            city: true\n          }\n        }\n      }\n    })\n\n    if (!user) {\n      return NextResponse.json(\n        { detail: 'User not found' },\n        { status: 404 }\n      )\n    }\n\n    if (!user.isActive) {\n      return NextResponse.json(\n        { detail: 'User account is inactive' },\n        { status: 403 }\n      )\n    }\n\n    // Return user data\n    return NextResponse.json({\n      id: user.id,\n      username: user.username,\n      email: user.email,\n      role: user.role,\n      station_id: user.stationId || null,\n      is_active: user.isActive,\n      station: user.station\n    })\n  } catch (error) {\n    console.error('Get current user error:', error)\n    return NextResponse.json(\n      { detail: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\banks\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\banks\\[id]\\transactions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\banks\\accounts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\banks\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\banks\\transactions\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\banks\\transactions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\cheques\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1201,1204],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1201,1204],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\credit\\aging\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":3,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Mock aging data - in real app this would fetch from database\n    const agingData = [\n      {\n        customerId: 'customer-1',\n        customerName: 'ABC Company Ltd',\n        nicOrBrn: '123456789V',\n        creditLimit: 100000,\n        totalOutstanding: 25000,\n        current: 15000,\n        days31to60: 5000,\n        days61to90: 3000,\n        over90Days: 2000,\n        oldestInvoiceDate: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(),\n        daysPastDue: 45,\n        riskLevel: 'MEDIUM' as const,\n        lastPaymentDate: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),\n        lastPaymentAmount: 5000\n      }\n    ]\n\n    return NextResponse.json(agingData)\n  } catch (error) {\n    console.error('Error fetching aging data:', error)\n    return NextResponse.json({ error: 'Failed to fetch aging data' }, { status: 500 })\n  }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\credit\\customers\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\credit\\customers\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\credit\\payments\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'validateDate' is defined but never used.","line":3,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":72}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport { safeParseFloat, validateAmount, validateRequired, validateDate } from '@/lib/validation'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const customerId = searchParams.get('customerId')\n    const id = searchParams.get('id')\n\n    if (id) {\n      const payment = await prisma.creditPayment.findUnique({\n        where: { id },\n        include: {\n          customer: {\n            select: {\n              id: true,\n              name: true,\n              phone: true\n            }\n          },\n          bank: {\n            select: {\n              id: true,\n              name: true\n            }\n          }\n        }\n      })\n      \n      if (!payment) {\n        return NextResponse.json({ error: 'Credit payment not found' }, { status: 404 })\n      }\n      return NextResponse.json(payment)\n    }\n\n    const where = customerId ? { customerId } : {}\n    const payments = await prisma.creditPayment.findMany({\n      where,\n      include: {\n        customer: {\n          select: {\n            id: true,\n            name: true,\n            phone: true\n          }\n        },\n        bank: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      },\n      orderBy: { paymentDate: 'desc' },\n      take: 100\n    })\n\n    return NextResponse.json(payments)\n  } catch (error) {\n    console.error('Error fetching credit payments:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    console.log('Credit payment request body:', body)\n    \n    const { customerId, amount, paymentType, referenceNumber, chequeNumber, bankId, paymentDate, receivedBy, stationId } = body\n    \n    // Validate required fields\n    const errors: string[] = []\n    if (validateRequired(customerId, 'Customer ID')) errors.push(validateRequired(customerId, 'Customer ID')!)\n    if (validateRequired(paymentType, 'Payment type')) errors.push(validateRequired(paymentType, 'Payment type')!)\n    if (validateRequired(receivedBy, 'Received by')) errors.push(validateRequired(receivedBy, 'Received by')!)\n    \n    // Validate amount\n    const amountError = validateAmount(amount, 'Amount')\n    if (amountError) errors.push(amountError)\n    \n    if (errors.length > 0) {\n      return NextResponse.json(\n        { error: errors.join(', ') },\n        { status: 400 }\n      )\n    }\n    \n    const validatedAmount = safeParseFloat(amount)\n\n    // Get customer\n    const customer = await prisma.creditCustomer.findUnique({\n      where: { id: customerId }\n    })\n\n    if (!customer) {\n      return NextResponse.json({ error: 'Customer not found' }, { status: 404 })\n    }\n\n    // Create payment, update customer balance, and create safe transaction in a single transaction\n    const result = await prisma.$transaction(async (tx) => {\n      // Create the payment\n      const payment = await tx.creditPayment.create({\n        data: {\n          customerId,\n          amount: validatedAmount,\n          paymentType,\n          referenceNumber: referenceNumber || null,\n          chequeNumber: chequeNumber || null,\n          bankId: bankId || null,\n          paymentDate: paymentDate ? new Date(paymentDate) : new Date(),\n          receivedBy,\n          status: 'CLEARED'\n        },\n        include: {\n          customer: true,\n          bank: true\n        }\n      })\n\n      // Update customer balance (decrease)\n      await tx.creditCustomer.update({\n        where: { id: customerId },\n          data: {\n            currentBalance: {\n              decrement: validatedAmount\n            }\n          }\n      })\n\n      // Create safe transaction for CASH payments only\n      if (stationId && paymentType === 'CASH') {\n        console.log('Creating safe transaction for CASH payment, stationId:', stationId)\n        \n        // Get or create safe\n        let safe = await tx.safe.findUnique({\n          where: { stationId }\n        })\n        console.log('Safe found/created:', safe ? 'Yes' : 'No')\n\n        if (!safe) {\n          safe = await tx.safe.create({\n            data: {\n              stationId,\n              openingBalance: 0,\n              currentBalance: 0\n            }\n          })\n        }\n\n        // Calculate balance before transaction chronologically\n        const paymentTimestamp = paymentDate ? new Date(paymentDate) : new Date()\n        const allTransactions = await tx.safeTransaction.findMany({\n          where: { \n            safeId: safe.id,\n            timestamp: { lte: paymentTimestamp }\n          },\n          orderBy: [{ timestamp: 'asc' }, { createdAt: 'asc' }]\n        })\n\n        // Calculate balance before transaction chronologically\n        // OPENING_BALANCE transactions set the balance, they don't add/subtract\n        let balanceBefore = safe.openingBalance\n        for (const transaction of allTransactions) {\n          if (transaction.type === 'OPENING_BALANCE') {\n            balanceBefore = transaction.amount\n          } else {\n            const txIsIncome = [\n              'CASH_FUEL_SALES',\n              'POS_CARD_PAYMENT',\n              'CREDIT_PAYMENT',\n              'CHEQUE_RECEIVED',\n              'LOAN_REPAID'\n            ].includes(transaction.type)\n            balanceBefore += txIsIncome ? transaction.amount : -transaction.amount\n          }\n        }\n\n        const balanceAfter = balanceBefore + validatedAmount\n\n        // Get bank name if bankId is provided\n        let bankName = ''\n        if (bankId) {\n          const bank = await tx.bank.findUnique({\n            where: { id: bankId },\n            select: { name: true }\n          })\n          bankName = bank ? ` - ${bank.name}` : ''\n        }\n\n        // Create safe transaction\n        await tx.safeTransaction.create({\n          data: {\n            safeId: safe.id,\n            type: 'CREDIT_PAYMENT',\n            amount: validatedAmount,\n            balanceBefore,\n            balanceAfter,\n            description: `Credit payment from ${customer.name} - ${paymentType}${chequeNumber ? ` (Cheque: ${chequeNumber})` : ''}${bankName}`,\n            performedBy: receivedBy,\n            timestamp: paymentDate ? new Date(paymentDate) : new Date(),\n            // Note: We don't have a direct foreign key, but we can store payment ID in description for traceability\n          }\n        })\n\n        // Update safe balance\n        await tx.safe.update({\n          where: { id: safe.id },\n          data: { currentBalance: balanceAfter }\n        })\n      }\n\n      return payment\n    })\n\n    return NextResponse.json(result, { status: 201 })\n  } catch (error) {\n    console.error('Error creating credit payment:', error)\n    \n    // Handle foreign key constraint violations\n    if (error instanceof Error && error.message.includes('Foreign key constraint')) {\n      return NextResponse.json(\n        { error: 'Invalid customer or bank ID' },\n        { status: 400 }\n      )\n    }\n    \n    // Return detailed error for debugging\n    const errorMessage = error instanceof Error ? error.message : 'Internal server error'\n    console.error('Detailed error:', errorMessage)\n    \n    return NextResponse.json({ \n      error: 'Internal server error', \n      details: errorMessage \n    }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\credit\\sales\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\dashboard\\summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\deliveries\\[id]\\verify\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\deliveries\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":244,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7382,7385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7382,7385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\deposits\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\expenses\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\fuels\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\fuels\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":5,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/db'\r\n\r\n// GET /api/fuels - Get all fuel types\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const fuels = await prisma.fuel.findMany({\r\n      orderBy: { sortOrder: 'asc' },\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            tanks: true,\r\n            prices: true,\r\n          },\r\n        },\r\n      },\r\n    })\r\n\r\n    return NextResponse.json(fuels)\r\n  } catch (error) {\r\n    console.error('Error fetching fuel types:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to fetch fuel types' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// POST /api/fuels - Create a new fuel type\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { code, name, category, description, icon } = body\r\n\r\n    // Validate required fields\r\n    if (!code || !name || !category) {\r\n      return NextResponse.json(\r\n        { error: 'Code, name, and category are required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Check if code already exists\r\n    const existing = await prisma.fuel.findUnique({\r\n      where: { code: code.toUpperCase().replace(/\\s+/g, '_') },\r\n    })\r\n\r\n    if (existing) {\r\n      return NextResponse.json(\r\n        { error: 'A fuel type with this code already exists' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Get the highest sort order\r\n    const maxSortOrder = await prisma.fuel.aggregate({\r\n      _max: {\r\n        sortOrder: true,\r\n      },\r\n    })\r\n\r\n    const fuel = await prisma.fuel.create({\r\n      data: {\r\n        code: code.toUpperCase().replace(/\\s+/g, '_'),\r\n        name,\r\n        category,\r\n        description,\r\n        icon: icon || '',\r\n        sortOrder: (maxSortOrder._max.sortOrder || 0) + 1,\r\n      },\r\n    })\r\n\r\n    return NextResponse.json(fuel, { status: 201 })\r\n  } catch (error) {\r\n    console.error('Error creating fuel type:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to create fuel type' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\external\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\office\\[id]\\pay\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\office\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\office\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\payments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\pumper\\[id]\\pay\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\pumper\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\loans\\pumper\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\notifications\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\notifications\\generate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\notifications\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[910,913],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[910,913],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1028,1031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1028,1031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1146,1149],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1146,1149],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\nozzles\\[id]\\last-reading\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\nozzles\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\nozzles\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\office-staff\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\office-staff\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[678,681],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[678,681],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":181,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5625,5628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5625,5628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\office-staff\\salary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\oil-sales\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'shiftId' is assigned a value but never used.","line":9,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport { safeParseFloat } from '@/lib/validation'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const stationId = searchParams.get('stationId')\n    const shiftId = searchParams.get('shiftId')\n    const startDate = searchParams.get('startDate')\n    const endDate = searchParams.get('endDate')\n    const summary = searchParams.get('summary')\n    const limit = parseInt(searchParams.get('limit') || '100')\n\n    // Build where clause\n    interface OilSaleWhereInput {\n      stationId?: string\n      saleDate?: {\n        gte: Date\n        lte: Date\n      }\n    }\n    const where: OilSaleWhereInput = {}\n    if (stationId) {\n      where.stationId = stationId\n    }\n    if (startDate && endDate) {\n      where.saleDate = {\n        gte: new Date(startDate),\n        lte: new Date(endDate)\n      }\n    }\n\n    // Get summary\n    if (summary === 'true') {\n      const sales = await prisma.oilSale.findMany({\n        where,\n        select: {\n          quantity: true,\n          totalAmount: true,\n          productName: true\n        }\n      })\n\n      const summaryData = {\n        totalSales: sales.reduce((sum, sale) => sum + sale.totalAmount, 0),\n        totalQuantity: sales.reduce((sum, sale) => sum + sale.quantity, 0),\n        salesCount: sales.length,\n        products: sales.reduce((acc, sale) => {\n          if (!acc[sale.productName]) {\n            acc[sale.productName] = { quantity: 0, totalAmount: 0 }\n          }\n          acc[sale.productName].quantity += sale.quantity\n          acc[sale.productName].totalAmount += sale.totalAmount\n          return acc\n        }, {} as Record<string, { quantity: number; totalAmount: number }>)\n      }\n\n      return NextResponse.json(summaryData)\n    }\n\n    // Filter by shift - note: OilSale model doesn't have shiftId, so we skip this for now\n    // This would need to be added to the schema if shift tracking is needed\n\n    const sales = await prisma.oilSale.findMany({\n      where,\n      include: {\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      },\n      orderBy: { saleDate: 'desc' },\n      take: limit\n    })\n\n    return NextResponse.json(sales)\n  } catch (error) {\n    console.error('Error fetching oil sales:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    interface OilSaleBody {\n      stationId?: string\n      productName?: string\n      quantity?: number | string\n      unit?: string\n      price?: number | string\n      totalAmount?: number\n      customerName?: string\n      saleDate?: string | Date\n    }\n    const body = await request.json() as OilSaleBody\n\n    const { stationId, productName, quantity, unit, price, totalAmount, customerName, saleDate } = body\n\n    // Validate required fields\n    if (!stationId || !productName || quantity === undefined || price === undefined) {\n      return NextResponse.json({\n        error: 'Station ID, product name, quantity, and price are required'\n      }, { status: 400 })\n    }\n\n    const quantityNum = safeParseFloat(quantity)\n    const priceNum = safeParseFloat(price)\n    const calculatedTotal = totalAmount || (quantityNum * priceNum)\n    const saleDateObj = saleDate ? new Date(saleDate) : new Date()\n\n    const newSale = await prisma.oilSale.create({\n      data: {\n        stationId,\n        productName,\n        quantity: quantityNum,\n        unit: unit || 'liters',\n        price: priceNum,\n        totalAmount: calculatedTotal,\n        customerName: customerName || null,\n        saleDate: saleDateObj\n      },\n      include: {\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      }\n    })\n\n    return NextResponse.json(newSale, { status: 201 })\n  } catch (error) {\n    console.error('Error creating oil sale:', error)\n\n    // Handle foreign key constraint violations\n    if (error instanceof Error && error.message.includes('Foreign key constraint')) {\n      return NextResponse.json(\n        { error: 'Invalid station ID' },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pos\\batches\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stationId' is assigned a value but never used.","line":109,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":109,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const shiftId = searchParams.get('shiftId')\n    const terminalId = searchParams.get('terminalId')\n    const id = searchParams.get('id')\n    const limit = searchParams.get('limit')\n\n    if (id) {\n      // OPTIMIZED: Use select for single batch\n      const batch = await prisma.posBatch.findUnique({\n        where: { id },\n        select: {\n          id: true,\n          shiftId: true,\n          totalAmount: true,\n          createdAt: true,\n          updatedAt: true,\n          terminalEntries: {\n            select: {\n              id: true,\n              terminalId: true,\n              startNumber: true,\n              endNumber: true,\n              transactionCount: true,\n              visaAmount: true,\n              masterAmount: true,\n              amexAmount: true,\n              qrAmount: true,\n              dialogTouchAmount: true,\n              createdAt: true,\n              terminal: {\n                select: {\n                  id: true,\n                  name: true,\n                  terminalNumber: true,\n                  bank: {\n                    select: {\n                      id: true,\n                      name: true\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      })\n\n      if (!batch) {\n        return NextResponse.json({ error: 'POS batch not found' }, { status: 404 })\n      }\n      return NextResponse.json(batch)\n    }\n\n    interface PosBatchWhereInput {\n      shiftId?: string\n    }\n    const where: PosBatchWhereInput = {}\n    if (shiftId) {\n      where.shiftId = shiftId\n    }\n\n    // OPTIMIZED: Use select for batch list\n    const batches = await prisma.posBatch.findMany({\n      where,\n      include: {\n        terminalEntries: {\n          include: {\n            terminal: {\n              include: {\n                bank: true\n              }\n            }\n          }\n        }\n      },\n      orderBy: { createdAt: 'desc' },\n      ...(limit ? { take: parseInt(limit) } : {})\n    })\n\n    // Filter by terminal if specified\n    if (terminalId) {\n      const filteredBatches = batches.filter(batch =>\n        batch.terminalEntries.some(entry => entry.terminalId === terminalId)\n      )\n      return NextResponse.json(filteredBatches)\n    }\n\n    return NextResponse.json(batches)\n  } catch (error) {\n    console.error('Error fetching POS batches:', error)\n    return NextResponse.json({\n      error: 'Internal server error',\n      details: error instanceof Error ? error.message : String(error)\n    }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n\n    // New format: Accept terminalEntries array OR legacy single terminal format\n    const {\n      stationId,\n      shiftId,\n      terminalId, // Legacy field\n      startNumber, // Legacy fields\n      endNumber,\n      transactionCount,\n      visaAmount,\n      masterAmount,\n      amexAmount,\n      qrAmount,\n      dialogTouchAmount,\n      terminalEntries, // New field: array of terminal entries\n      totalAmount,\n      notes,\n      addToSafe\n    } = body\n\n    // Support both formats: array of entries OR single terminal\n    let entries = []\n    if (terminalEntries && Array.isArray(terminalEntries) && terminalEntries.length > 0) {\n      entries = terminalEntries\n    } else if (terminalId && startNumber && endNumber) {\n      // Legacy format: create single entry from old fields\n      entries = [{\n        terminalId,\n        startNumber,\n        endNumber,\n        transactionCount: transactionCount || 0,\n        visaAmount: visaAmount || 0,\n        masterAmount: masterAmount || 0,\n        amexAmount: amexAmount || 0,\n        qrAmount: qrAmount || 0,\n        dialogTouchAmount: dialogTouchAmount || 0\n      }]\n    }\n\n    if (entries.length === 0) {\n      return NextResponse.json(\n        { error: 'At least one terminal entry is required' },\n        { status: 400 }\n      )\n    }\n\n    if (totalAmount === undefined) {\n      return NextResponse.json(\n        { error: 'Total amount is required' },\n        { status: 400 }\n      )\n    }\n\n    // Validate all terminals exist and get station\n    const terminalIds = entries.map(e => e.terminalId)\n    const terminals = await prisma.posTerminal.findMany({\n      where: { id: { in: terminalIds } },\n      include: { station: true }\n    })\n\n    if (terminals.length !== terminalIds.length) {\n      return NextResponse.json({ error: 'One or more terminals not found' }, { status: 404 })\n    }\n\n    const station = terminals[0].station\n\n    // Use provided shiftId or find/create active shift\n    let shift = null\n    if (shiftId) {\n      shift = await prisma.shift.findUnique({\n        where: { id: shiftId }\n      })\n    }\n\n    if (!shift) {\n      // Find or create active shift\n      shift = await prisma.shift.findFirst({\n        where: {\n          stationId: station.id,\n          status: 'OPEN'\n        },\n        orderBy: { startTime: 'desc' }\n      })\n    }\n\n    if (!shift) {\n      // Find or create default template\n      let template = await prisma.shiftTemplate.findFirst({\n        where: {\n          stationId: station.id,\n          isActive: true\n        }\n      })\n\n      if (!template) {\n        template = await prisma.shiftTemplate.create({\n          data: {\n            stationId: station.id,\n            name: 'Default Template',\n            startTime: '00:00',\n            endTime: '23:59',\n            isActive: true\n          }\n        })\n      }\n\n      // Create new shift\n      shift = await prisma.shift.create({\n        data: {\n          stationId: station.id,\n          templateId: template.id,\n          startTime: new Date(),\n          openedBy: 'System',\n          status: 'OPEN'\n        }\n      })\n    }\n\n    // Create batch with multiple terminal entries\n    const newBatch = await prisma.posBatch.create({\n      data: {\n        shiftId: shift.id,\n        totalAmount: parseFloat(totalAmount),\n        notes: notes || null,\n        isReconciled: false,\n        terminalEntries: {\n          create: entries.map(entry => ({\n            terminalId: entry.terminalId,\n            startNumber: entry.startNumber,\n            endNumber: entry.endNumber,\n            transactionCount: entry.transactionCount || 0,\n            visaAmount: parseFloat(entry.visaAmount || 0),\n            masterAmount: parseFloat(entry.masterAmount || 0),\n            amexAmount: parseFloat(entry.amexAmount || 0),\n            qrAmount: parseFloat(entry.qrAmount || 0),\n            dialogTouchAmount: parseFloat(entry.dialogTouchAmount || 0)\n          }))\n        }\n      },\n      include: {\n        terminalEntries: {\n          include: {\n            terminal: {\n              select: {\n                id: true,\n                name: true,\n                terminalNumber: true,\n                bank: {\n                  select: {\n                    id: true,\n                    name: true\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    })\n\n    // Add to safe if requested\n    if (addToSafe && newBatch.totalAmount > 0) {\n      try {\n        // Get or create safe\n        const shift = await prisma.shift.findUnique({\n          where: { id: newBatch.shiftId },\n          select: { stationId: true }\n        })\n\n        if (shift) {\n          let safe = await prisma.safe.findUnique({\n            where: { stationId: shift.stationId }\n          })\n\n          if (!safe) {\n            safe = await prisma.safe.create({\n              data: {\n                stationId: shift.stationId,\n                openingBalance: 0,\n                currentBalance: 0\n              }\n            })\n          }\n\n          // Calculate balance before transaction chronologically\n          const batchTimestamp = newBatch.createdAt || new Date()\n          const allTransactions = await prisma.safeTransaction.findMany({\n            where: {\n              safeId: safe.id,\n              timestamp: { lte: batchTimestamp }\n            },\n            orderBy: [{ timestamp: 'asc' }, { createdAt: 'asc' }]\n          })\n\n          // Calculate balance before transaction chronologically\n          // OPENING_BALANCE transactions set the balance, they don't add/subtract\n          let balanceBefore = safe.openingBalance\n          for (const tx of allTransactions) {\n            if (tx.type === 'OPENING_BALANCE') {\n              balanceBefore = tx.amount\n            } else {\n              const isIncome = [\n                'CASH_FUEL_SALES',\n                'POS_CARD_PAYMENT',\n                'CREDIT_PAYMENT',\n                'CHEQUE_RECEIVED',\n                'LOAN_REPAID'\n              ].includes(tx.type)\n              balanceBefore += isIncome ? tx.amount : -tx.amount\n            }\n          }\n\n          const balanceAfter = balanceBefore + newBatch.totalAmount\n\n          // Create description from terminal entries\n          interface BatchEntryWithTerminal {\n            terminalNumber?: string\n            terminal?: {\n              terminalNumber: string\n            }\n          }\n          const terminalList = newBatch.terminalEntries\n            .map((entry) => {\n              const e = entry as unknown as BatchEntryWithTerminal\n              return `${e.terminal?.terminalNumber || e.terminalNumber || 'Unknown'}`\n            })\n            .join(', ')\n\n          // Create safe transaction\n          await prisma.safeTransaction.create({\n            data: {\n              safeId: safe.id,\n              type: 'POS_CARD_PAYMENT',\n              amount: newBatch.totalAmount,\n              balanceBefore,\n              balanceAfter,\n              batchId: newBatch.id,\n              shiftId: newBatch.shiftId,\n              description: `POS batch (Terminals: ${terminalList})`,\n              performedBy: 'System',\n              timestamp: batchTimestamp\n            }\n          })\n\n          // Update safe balance\n          await prisma.safe.update({\n            where: { id: safe.id },\n            data: { currentBalance: balanceAfter }\n          })\n        }\n      } catch (safeError) {\n        console.error('Error adding POS batch to safe:', safeError)\n        // Don't fail batch creation if safe transaction fails\n      }\n    }\n\n    return NextResponse.json(newBatch, { status: 201 })\n  } catch (error) {\n    console.error('Error creating POS batch:', error)\n\n    // Handle foreign key constraint violations\n    if (error instanceof Error && error.message.includes('Foreign key constraint')) {\n      return NextResponse.json(\n        { error: 'Invalid shift or terminal ID' },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pos\\missing-slip\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pos\\terminals\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pos\\terminals\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\prices\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\prices\\next\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\prices\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\profile\\change-password\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":26,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport jwt, { JwtPayload } from 'jsonwebtoken'\nimport bcrypt from 'bcrypt'\nimport { getJwtSecret } from '@/lib/jwt'\n\nexport async function PUT(request: NextRequest) {\n  try {\n    // Get authorization header\n    const authHeader = request.headers.get('authorization')\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { detail: 'Authorization header missing or invalid' },\n        { status: 401 }\n      )\n    }\n\n    // Extract token\n    const token = authHeader.substring(7)\n\n    // Verify token\n    let decoded: JwtPayload | string\n    try {\n      decoded = jwt.verify(token, getJwtSecret()) as JwtPayload\n    } catch (error) {\n      return NextResponse.json(\n        { detail: 'Invalid or expired token' },\n        { status: 401 }\n      )\n    }\n\n    // Get request body\n    const body = await request.json()\n    const { current_password, new_password } = body\n\n    if (!current_password || !new_password) {\n      return NextResponse.json(\n        { detail: 'Current password and new password are required' },\n        { status: 400 }\n      )\n    }\n\n    if (new_password.length < 6) {\n      return NextResponse.json(\n        { detail: 'New password must be at least 6 characters long' },\n        { status: 400 }\n      )\n    }\n\n    // Get user from database\n    const user = await prisma.user.findUnique({\n      where: { username: decoded.sub as string }\n    })\n\n    if (!user) {\n      return NextResponse.json(\n        { detail: 'User not found' },\n        { status: 404 }\n      )\n    }\n\n    // Verify current password\n    let passwordValid = false\n    \n    // Check if password is hashed (bcrypt hashes start with $2a$, $2b$, or $2y$)\n    if (user.password.startsWith('$2')) {\n      // Password is hashed with bcrypt\n      try {\n        passwordValid = await bcrypt.compare(current_password, user.password)\n      } catch (error) {\n        console.error('Bcrypt compare error:', error)\n        passwordValid = false\n      }\n    } else {\n      // Password is plain text (for migration purposes)\n      passwordValid = current_password === user.password\n    }\n\n    if (!passwordValid) {\n      return NextResponse.json(\n        { detail: 'Current password is incorrect' },\n        { status: 401 }\n      )\n    }\n\n    // Hash new password\n    const hashedPassword = await bcrypt.hash(new_password, 10)\n\n    // Update password in database\n    await prisma.user.update({\n      where: { id: user.id },\n      data: { password: hashedPassword }\n    })\n\n    return NextResponse.json({\n      detail: 'Password updated successfully'\n    })\n  } catch (error) {\n    console.error('Change password error:', error)\n    return NextResponse.json(\n      { detail: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\profile\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'bcrypt' is defined but never used.","line":4,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":26,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":99,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":99,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport jwt, { JwtPayload } from 'jsonwebtoken'\nimport bcrypt from 'bcrypt'\nimport { getJwtSecret } from '@/lib/jwt'\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Get authorization header\n    const authHeader = request.headers.get('authorization')\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { detail: 'Authorization header missing or invalid' },\n        { status: 401 }\n      )\n    }\n\n    // Extract token\n    const token = authHeader.substring(7)\n\n    // Verify token\n    let decoded: JwtPayload | string\n    try {\n      decoded = jwt.verify(token, getJwtSecret()) as JwtPayload\n    } catch (error) {\n      return NextResponse.json(\n        { detail: 'Invalid or expired token' },\n        { status: 401 }\n      )\n    }\n\n    // Get user from database\n    const user = await prisma.user.findUnique({\n      where: { username: decoded.sub as string },\n      include: {\n        station: {\n          select: {\n            id: true,\n            name: true,\n            city: true\n          }\n        }\n      }\n    })\n\n    if (!user) {\n      return NextResponse.json(\n        { detail: 'User not found' },\n        { status: 404 }\n      )\n    }\n\n    if (!user.isActive) {\n      return NextResponse.json(\n        { detail: 'User account is inactive' },\n        { status: 403 }\n      )\n    }\n\n    // Return user data\n    return NextResponse.json({\n      id: user.id,\n      username: user.username,\n      email: user.email,\n      role: user.role,\n      station_id: user.stationId || null,\n      is_active: user.isActive,\n      station: user.station\n    })\n  } catch (error) {\n    console.error('Get profile error:', error)\n    return NextResponse.json(\n      { detail: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  try {\n    // Get authorization header\n    const authHeader = request.headers.get('authorization')\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { detail: 'Authorization header missing or invalid' },\n        { status: 401 }\n      )\n    }\n\n    // Extract token\n    const token = authHeader.substring(7)\n\n    // Verify token\n    let decoded: JwtPayload | string\n    try {\n      decoded = jwt.verify(token, getJwtSecret()) as JwtPayload\n    } catch (error) {\n      return NextResponse.json(\n        { detail: 'Invalid or expired token' },\n        { status: 401 }\n      )\n    }\n\n    // Get request body\n    const body = await request.json()\n    const { username } = body\n\n    // Get user from database\n    const user = await prisma.user.findUnique({\n      where: { username: decoded.sub as string }\n    })\n\n    if (!user) {\n      return NextResponse.json(\n        { detail: 'User not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if new username is provided and different\n    if (username && username !== user.username) {\n      // Check if username is already taken\n      const existingUser = await prisma.user.findUnique({\n        where: { username }\n      })\n\n      if (existingUser) {\n        return NextResponse.json(\n          { detail: 'Username already taken' },\n          { status: 400 }\n        )\n      }\n\n      // Update username\n      const updatedUser = await prisma.user.update({\n        where: { id: user.id },\n        data: { username },\n        include: {\n          station: {\n            select: {\n              id: true,\n              name: true,\n              city: true\n            }\n          }\n        }\n      })\n\n      return NextResponse.json({\n        id: updatedUser.id,\n        username: updatedUser.username,\n        email: updatedUser.email,\n        role: updatedUser.role,\n        station_id: updatedUser.stationId || null,\n        is_active: updatedUser.isActive,\n        station: updatedUser.station\n      })\n    }\n\n    // Return current user data if no update needed\n    const userWithStation = await prisma.user.findUnique({\n      where: { id: user.id },\n      include: {\n        station: {\n          select: {\n            id: true,\n            name: true,\n            city: true\n          }\n        }\n      }\n    })\n\n    return NextResponse.json({\n      id: userWithStation!.id,\n      username: userWithStation!.username,\n      email: userWithStation!.email,\n      role: userWithStation!.role,\n      station_id: userWithStation!.stationId || null,\n      is_active: userWithStation!.isActive,\n      station: userWithStation!.station\n    })\n  } catch (error) {\n    console.error('Update profile error:', error)\n    return NextResponse.json(\n      { detail: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pumpers\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Prisma' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loanError' is defined but never used.","line":206,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":206,"endColumn":23}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3115,3118],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3115,3118],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport { Prisma } from '@prisma/client'\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n\n    const pumper = await prisma.pumper.findUnique({\n      where: { id }\n    })\n\n    if (!pumper) {\n      return NextResponse.json({ error: 'Pumper not found' }, { status: 404 })\n    }\n\n    return NextResponse.json(pumper)\n  } catch (error) {\n    console.error('Error fetching pumper:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n    const body = await request.json()\n\n    // Find existing pumper\n    const existingPumper = await prisma.pumper.findUnique({\n      where: { id }\n    })\n\n    if (!existingPumper) {\n      return NextResponse.json({ error: 'Pumper not found' }, { status: 404 })\n    }\n\n    // Extract and validate fields\n    const {\n      name,\n      phone,\n      phoneNumber,\n      employeeId,\n      stationId,\n      status,\n      shift,\n      hireDate,\n      experience,\n      rating,\n      specializations,\n      baseSalary,\n      holidayAllowance,\n      isActive\n    } = body\n\n    const finalName = (name !== undefined && name !== '') ? name.trim() : existingPumper.name\n    const finalEmployeeId = employeeId !== undefined ? (employeeId?.trim() || null) : existingPumper.employeeId\n    const finalPhone = phone !== undefined ? (phone || null) : (phoneNumber !== undefined ? (phoneNumber || null) : existingPumper.phone)\n\n    // CRITICAL: Check for duplicates BEFORE updating\n    // Check by name + employeeId\n    if (finalName !== existingPumper.name || finalEmployeeId !== existingPumper.employeeId) {\n      const duplicateCheck = await prisma.pumper.findFirst({\n        where: {\n          name: finalName,\n          employeeId: finalEmployeeId,\n          id: { not: id }\n        }\n      })\n\n      if (duplicateCheck) {\n        return NextResponse.json({\n          error: 'Cannot update pumper',\n          details: `Another pumper with name \"${finalName}\" and employee ID \"${finalEmployeeId || 'N/A'}\" already exists`,\n          existingId: duplicateCheck.id\n        }, { status: 400 })\n      }\n    }\n\n    // Check by name + phone if phone is being updated\n    if ((phone !== undefined || phoneNumber !== undefined) && finalPhone) {\n      const duplicateByPhone = await prisma.pumper.findFirst({\n        where: {\n          name: finalName,\n          phone: finalPhone,\n          id: { not: id }\n        }\n      })\n\n      if (duplicateByPhone) {\n        return NextResponse.json({\n          error: 'Cannot update pumper',\n          details: `Another pumper with name \"${finalName}\" and phone \"${finalPhone}\" already exists`,\n          existingId: duplicateByPhone.id\n        }, { status: 400 })\n      }\n    }\n\n    // Build update data\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const updateData: any = {}\n\n    if (name !== undefined) updateData.name = name.trim()\n    if (phone !== undefined) updateData.phone = phone || null\n    if (phoneNumber !== undefined) updateData.phone = phoneNumber || null\n    if (employeeId !== undefined) updateData.employeeId = employeeId?.trim() || null\n    if (stationId !== undefined) updateData.stationId = stationId && stationId !== '' ? stationId : null\n    if (status !== undefined) updateData.status = status\n    if (shift !== undefined) updateData.shift = shift\n    if (hireDate !== undefined) updateData.hireDate = hireDate && hireDate !== '' ? new Date(hireDate) : null\n    if (experience !== undefined) updateData.experience = experience ? parseFloat(String(experience)) : null\n    if (rating !== undefined) updateData.rating = rating ? parseFloat(String(rating)) : null\n    if (specializations !== undefined) updateData.specializations = Array.isArray(specializations) ? specializations : []\n    if (baseSalary !== undefined) updateData.baseSalary = baseSalary !== null && baseSalary !== '' ? parseFloat(String(baseSalary)) : 0\n    if (holidayAllowance !== undefined) updateData.holidayAllowance = holidayAllowance !== null && holidayAllowance !== '' ? parseFloat(String(holidayAllowance)) : 4500\n    if (isActive !== undefined) updateData.isActive = isActive\n\n    if (Object.keys(updateData).length === 0) {\n      return NextResponse.json({ error: 'No fields to update' }, { status: 400 })\n    }\n\n    // Update pumper\n    const updatedPumper = await prisma.pumper.update({\n      where: { id },\n      data: updateData\n    })\n\n    console.log(' Pumper updated successfully:', updatedPumper.id)\n    return NextResponse.json(updatedPumper)\n  } catch (error) {\n    console.error(' Error updating pumper:', error)\n    if (error instanceof Error) {\n      if (error.message.includes('P2002')) {\n        return NextResponse.json({\n          error: 'Unique constraint violation',\n          details: 'A pumper with this information already exists'\n        }, { status: 400 })\n      }\n      if (error.message.includes('P2025')) {\n        return NextResponse.json({\n          error: 'Pumper not found',\n          details: 'The pumper you are trying to update does not exist'\n        }, { status: 404 })\n      }\n    }\n    return NextResponse.json({\n      error: 'Failed to update pumper',\n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 })\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n\n    const pumper = await prisma.pumper.findUnique({\n      where: { id }\n    })\n\n    if (!pumper) {\n      return NextResponse.json({ error: 'Pumper not found' }, { status: 404 })\n    }\n\n    // Check for active assignments\n    const activeAssignmentsCount = await prisma.shiftAssignment.count({\n      where: {\n        pumperName: pumper.name,\n        status: 'ACTIVE'\n      }\n    })\n\n    if (activeAssignmentsCount > 0) {\n      return NextResponse.json({\n        error: 'Cannot delete pumper with active shift assignments',\n        details: `This pumper has ${activeAssignmentsCount} active shift assignment(s). Please close the assignments first.`,\n        activeAssignments: activeAssignmentsCount\n      }, { status: 400 })\n    }\n\n    // Check for active loans\n    try {\n      const activeLoansCount = await prisma.loanPumper.count({\n        where: {\n          pumperName: pumper.name,\n          status: 'ACTIVE'\n        }\n      })\n\n      if (activeLoansCount > 0) {\n        return NextResponse.json({\n          error: 'Cannot delete pumper with active loans',\n          details: `This pumper has ${activeLoansCount} active loan(s). Please mark the loans as PAID first.`,\n          activeLoans: activeLoansCount\n        }, { status: 400 })\n      }\n    } catch (loanError) {\n      // Ignore if loan table doesn't exist\n      console.log('  Loan check skipped')\n    }\n\n    // Delete pumper\n    await prisma.pumper.delete({\n      where: { id }\n    })\n\n    console.log(' Pumper deleted successfully:', id)\n    return NextResponse.json({\n      success: true,\n      message: 'Pumper deleted successfully',\n      deletedPumper: {\n        id: pumper.id,\n        name: pumper.name\n      }\n    })\n  } catch (error) {\n    console.error(' Error deleting pumper:', error)\n    if (error instanceof Error) {\n      if (error.message.includes('Foreign key constraint') || error.message.includes('P2003')) {\n        return NextResponse.json({\n          error: 'Cannot delete pumper',\n          details: 'This pumper is referenced by other records. Please resolve these references first.'\n        }, { status: 400 })\n      }\n    }\n    return NextResponse.json({\n      error: 'Failed to delete pumper',\n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pumpers\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Prisma' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'employeeId' is assigned a value but never used.","line":130,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":130,"endColumn":17}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":225,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":225,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6112,6115],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6112,6115],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":227,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":227,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6226,6229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6226,6229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { Prisma } from '@prisma/client'\nimport { prisma } from '@/lib/db'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const activeOnly = searchParams.get('active') === 'true'\n    const shiftId = searchParams.get('shiftId')\n    const stationId = searchParams.get('stationId')\n\n    let pumpers\n\n    // If shiftId is provided, get pumpers from shift assignments\n    if (shiftId) {\n      const assignments = await prisma.shiftAssignment.findMany({\n        where: { shiftId },\n        select: {\n          pumperName: true\n        },\n        distinct: ['pumperName']\n      })\n\n      const pumperNames = assignments.map(a => a.pumperName)\n\n      interface PumperWhereInput {\n        name?: { in: string[] }\n        stationId?: string\n        isActive?: boolean\n      }\n      const where: PumperWhereInput = {\n        name: { in: pumperNames }\n      }\n      if (stationId) {\n        where.stationId = stationId\n      }\n      if (activeOnly) {\n        where.isActive = true\n      }\n\n      pumpers = await prisma.pumper.findMany({\n        where,\n        select: {\n          id: true,\n          name: true,\n          employeeId: true,\n          phone: true,\n          stationId: true,\n          status: true,\n          shift: true,\n          experience: true,\n          rating: true,\n          specializations: true,\n          isActive: true,\n          baseSalary: true,\n          holidayAllowance: true,\n          hireDate: true,\n          createdAt: true,\n          updatedAt: true\n        },\n        orderBy: { name: 'asc' }\n      })\n    } else {\n      // OPTIMIZED: Get all pumpers with ALL needed fields\n      interface PumperWhereInput {\n        name?: { in: string[] }\n        stationId?: string\n        isActive?: boolean\n      }\n      const where: PumperWhereInput = activeOnly ? { isActive: true } : {}\n      if (stationId) {\n        where.stationId = stationId\n      }\n      pumpers = await prisma.pumper.findMany({\n        where,\n        select: {\n          id: true,\n          name: true,\n          employeeId: true,\n          phone: true,\n          stationId: true,\n          status: true,\n          shift: true,\n          experience: true,\n          rating: true,\n          specializations: true,\n          isActive: true,\n          baseSalary: true,\n          holidayAllowance: true,\n          hireDate: true,\n          createdAt: true,\n          updatedAt: true\n        },\n        orderBy: { name: 'asc' }\n      })\n    }\n\n    return NextResponse.json(pumpers)\n  } catch (error) {\n    console.error('Error fetching pumpers:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    interface PumperBody {\n      name?: string\n      phone?: string\n      phoneNumber?: string\n      employeeId?: string\n      stationId?: string\n      status?: string\n      shift?: string\n      hireDate?: string | Date\n      experience?: string | number\n      rating?: string | number\n      specializations?: string[]\n      baseSalary?: string | number\n      holidayAllowance?: string | number\n      isActive?: boolean\n    }\n    const body = await request.json() as PumperBody\n    console.log(' POST /api/pumpers - Creating new pumper')\n\n    const {\n      name,\n      phone,\n      phoneNumber,\n      employeeId,\n      stationId,\n      status,\n      shift,\n      hireDate,\n      experience,\n      rating,\n      specializations,\n      baseSalary,\n      holidayAllowance,\n      isActive\n    } = body\n\n    if (!name || !name.trim()) {\n      return NextResponse.json(\n        { error: 'Name is required' },\n        { status: 400 }\n      )\n    }\n\n    const phoneToUse = phone || phoneNumber || null\n\n    // ALWAYS auto-generate employee ID\n    // Find the highest existing employee ID\n    const allPumpers = await prisma.pumper.findMany({\n      where: {\n        employeeId: { not: null }\n      },\n      select: {\n        employeeId: true\n      }\n    })\n\n    // Extract numbers from employee IDs (e.g., EMP001 -> 1, EMP002 -> 2)\n    const employeeNumbers = allPumpers\n      .map(p => {\n        const match = p.employeeId?.match(/EMP(\\d+)/i)\n        return match ? parseInt(match[1], 10) : 0\n      })\n      .filter(n => n > 0)\n\n    // Get the next number\n    const nextNumber = employeeNumbers.length > 0\n      ? Math.max(...employeeNumbers) + 1\n      : 1\n\n    // ALWAYS generate employee ID with 3-digit padding (EMP001, EMP002, etc.)\n    const finalEmployeeId = `EMP${String(nextNumber).padStart(3, '0')}`\n\n    console.log(` Auto-generated employee ID: ${finalEmployeeId}`)\n\n    // CRITICAL: Check for duplicates before creating\n    // Check by name + employeeId\n    const existing = await prisma.pumper.findFirst({\n      where: {\n        name: name.trim(),\n        employeeId: finalEmployeeId\n      }\n    })\n\n    if (existing) {\n      return NextResponse.json({\n        error: 'Pumper already exists',\n        details: `A pumper with name \"${name}\" and employee ID \"${finalEmployeeId}\" already exists`,\n        existingId: existing.id\n      }, { status: 400 })\n    }\n\n    // Also check by name + phone if phone provided\n    if (phoneToUse) {\n      const existingByPhone = await prisma.pumper.findFirst({\n        where: {\n          name: name.trim(),\n          phone: phoneToUse\n        }\n      })\n\n      if (existingByPhone) {\n        // Only block if it's a true duplicate (same name + phone)\n        return NextResponse.json({\n          error: 'Pumper already exists',\n          details: `A pumper with name \"${name}\" and phone \"${phoneToUse}\" already exists`,\n          existingId: existingByPhone.id\n        }, { status: 400 })\n      }\n    }\n\n    // Create new pumper with auto-generated employee ID\n    const newPumper = await prisma.pumper.create({\n      data: {\n        name: name.trim(),\n        phone: phoneToUse,\n        employeeId: finalEmployeeId,\n        stationId: stationId || undefined,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        status: (status as any) || 'ACTIVE',\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        shift: (shift as any) || 'ANY',\n        hireDate: hireDate ? new Date(hireDate) : null,\n        experience: experience ? parseFloat(String(experience)) : null,\n        rating: rating ? parseFloat(String(rating)) : null,\n        specializations: Array.isArray(specializations) ? specializations : [],\n        baseSalary: baseSalary !== undefined && baseSalary !== null && baseSalary !== '' ? parseFloat(String(baseSalary)) : 0,\n        holidayAllowance: holidayAllowance !== undefined && holidayAllowance !== null && holidayAllowance !== '' ? parseFloat(String(holidayAllowance)) : 4500,\n        isActive: isActive !== undefined ? isActive : true\n      }\n    })\n\n    console.log(' Pumper created successfully:', newPumper.id)\n\n    // Create audit log for pumper creation\n    try {\n      await prisma.auditLog.create({\n        data: {\n          userId: 'system', // TODO: Extract from JWT token\n          userName: 'System User', // TODO: Extract from JWT token\n          userRole: 'MANAGER', // TODO: Extract from JWT token\n          action: 'CREATE',\n          entity: 'Pumper',\n          entityId: newPumper.id,\n          details: `Created pumper: ${newPumper.name} (${newPumper.employeeId})`,\n          stationId: newPumper.stationId || undefined\n        }\n      })\n    } catch (auditError) {\n      console.error('Failed to create audit log:', auditError)\n      // Don't fail the request if audit logging fails\n    }\n\n    return NextResponse.json(newPumper, { status: 201 })\n  } catch (error) {\n    console.error(' Error creating pumper:', error)\n    if (error instanceof Error) {\n      if (error.message.includes('Unique constraint') || error.message.includes('P2002')) {\n        return NextResponse.json({\n          error: 'Pumper already exists',\n          details: 'A pumper with this information already exists in the database'\n        }, { status: 400 })\n      }\n    }\n    return NextResponse.json({\n      error: 'Internal server error',\n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pumps\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\pumps\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\credit-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\daily-comprehensive\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\daily-sales\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\daily\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\monthly\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\pos-sales\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'bankName' is assigned a value but never used.","line":157,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":157,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/db'\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    console.log('[POS Sales] Starting report generation...')\r\n    const { searchParams } = new URL(request.url)\r\n    const stationId = searchParams.get('stationId')\r\n    const startDate = searchParams.get('startDate')\r\n    const endDate = searchParams.get('endDate')\r\n    console.log('[POS Sales] Params:', { stationId, startDate, endDate })\r\n\r\n    if (!stationId) {\r\n      return NextResponse.json({ error: 'Station ID is required' }, { status: 400 })\r\n    }\r\n\r\n    // Parse dates or use defaults (current business month)\r\n    let dateStart: Date\r\n    let dateEnd: Date\r\n    \r\n    if (startDate && endDate) {\r\n      dateStart = new Date(startDate)\r\n      dateStart.setHours(0, 0, 0, 0)\r\n      dateEnd = new Date(endDate)\r\n      dateEnd.setHours(23, 59, 59, 999)\r\n    } else {\r\n      // Default to current business month (7th to 6th)\r\n      const now = new Date()\r\n      const currentDay = now.getDate()\r\n      \r\n      if (currentDay < 7) {\r\n        dateStart = new Date(now.getFullYear(), now.getMonth() - 1, 7, 0, 0, 0, 0)\r\n        dateEnd = new Date(now.getFullYear(), now.getMonth(), 6, 23, 59, 59, 999)\r\n      } else {\r\n        dateStart = new Date(now.getFullYear(), now.getMonth(), 7, 0, 0, 0, 0)\r\n        dateEnd = new Date(now.getFullYear(), now.getMonth() + 1, 6, 23, 59, 59, 999)\r\n      }\r\n    }\r\n\r\n    // Get all POS batches for the period\r\n    const batches = await prisma.posBatch.findMany({\r\n      where: {\r\n        shift: {\r\n          stationId,\r\n          endTime: {\r\n            gte: dateStart,\r\n            lte: dateEnd\r\n          }\r\n        }\r\n      },\r\n      include: {\r\n        shift: {\r\n          select: {\r\n            id: true,\r\n            startTime: true,\r\n            endTime: true\r\n          }\r\n        },\r\n        terminalEntries: {\r\n          include: {\r\n            terminal: {\r\n              include: {\r\n                bank: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc'\r\n      }\r\n    })\r\n\r\n    // Get POS terminals for the station\r\n    const posTerminals = await prisma.posTerminal.findMany({\r\n      where: { stationId },\r\n      include: { bank: true }\r\n    })\r\n\r\n    console.log('[POS Sales] Found', batches.length, 'batches and', posTerminals.length, 'terminals')\r\n\r\n    // Get missing slips count\r\n    const missingSlips = await prisma.posMissingSlip.findMany({\r\n      where: {\r\n        terminal: {\r\n          stationId\r\n        },\r\n        timestamp: {\r\n          gte: dateStart,\r\n          lte: dateEnd\r\n        }\r\n      }\r\n    })\r\n\r\n    // Calculate statistics\r\n    let totalSales = 0\r\n    let totalTransactions = 0\r\n    \r\n    const bankSales = new Map<string, {\r\n      bankName: string\r\n      totalAmount: number\r\n      transactionCount: number\r\n      visa: number\r\n      master: number\r\n      amex: number\r\n      qr: number\r\n      dialogTouch: number\r\n    }>()\r\n    \r\n    const terminalSales = new Map<string, {\r\n      terminalId: string\r\n      terminalName: string\r\n      terminalNumber: string\r\n      bankName: string\r\n      totalAmount: number\r\n      transactionCount: number\r\n      visa: number\r\n      master: number\r\n      amex: number\r\n      qr: number\r\n      dialogTouch: number\r\n    }>()\r\n\r\n    const dailyBreakdown = new Map<string, {\r\n      date: string\r\n      totalAmount: number\r\n      transactionCount: number\r\n    }>()\r\n\r\n    // Initialize daily breakdown for all days in range\r\n    const currentDate = new Date(dateStart)\r\n    while (currentDate <= dateEnd) {\r\n      const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`\r\n      dailyBreakdown.set(dateKey, {\r\n        date: dateKey,\r\n        totalAmount: 0,\r\n        transactionCount: 0\r\n      })\r\n      currentDate.setDate(currentDate.getDate() + 1)\r\n    }\r\n    \r\n    // Daily breakdown by Bank (for multi-line chart)\r\n    const dailyByBank = new Map<string, Map<string, number>>() // bankId -> date -> amount\r\n    \r\n    // Daily breakdown by Terminal/POS Machine\r\n    const dailyByTerminal = new Map<string, Map<string, number>>() // terminalId -> date -> amount\r\n    \r\n    // Get unique banks from terminals\r\n    const uniqueBanks = new Map<string, string>() // bankId -> bankName\r\n    for (const terminal of posTerminals) {\r\n      if (terminal.bankId && terminal.bank) {\r\n        uniqueBanks.set(terminal.bankId, terminal.bank.name)\r\n      }\r\n    }\r\n    \r\n    // Initialize daily by bank maps for all banks\r\n    for (const [bankId, bankName] of uniqueBanks.entries()) {\r\n      const bankDailyMap = new Map<string, number>()\r\n      const currentDate = new Date(dateStart)\r\n      while (currentDate <= dateEnd) {\r\n        const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`\r\n        bankDailyMap.set(dateKey, 0)\r\n        currentDate.setDate(currentDate.getDate() + 1)\r\n      }\r\n      dailyByBank.set(bankId, bankDailyMap)\r\n    }\r\n    \r\n    // Initialize daily by terminal maps for all terminals\r\n    for (const terminal of posTerminals) {\r\n      const terminalDailyMap = new Map<string, number>()\r\n      const currentDate = new Date(dateStart)\r\n      while (currentDate <= dateEnd) {\r\n        const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`\r\n        terminalDailyMap.set(dateKey, 0)\r\n        currentDate.setDate(currentDate.getDate() + 1)\r\n      }\r\n      dailyByTerminal.set(terminal.id, terminalDailyMap)\r\n    }\r\n\r\n    // Process batches\r\n    for (const batch of batches) {\r\n      const batchDate = new Date(batch.shift.endTime || batch.shift.startTime)\r\n      const dateKey = `${batchDate.getFullYear()}-${String(batchDate.getMonth() + 1).padStart(2, '0')}-${String(batchDate.getDate()).padStart(2, '0')}`\r\n      \r\n      for (const entry of batch.terminalEntries) {\r\n        const entryTotal = entry.visaAmount + entry.masterAmount + entry.amexAmount + entry.qrAmount + entry.dialogTouchAmount\r\n        totalSales += entryTotal\r\n        totalTransactions += entry.transactionCount\r\n\r\n        // Daily breakdown (total)\r\n        if (dailyBreakdown.has(dateKey)) {\r\n          const dayData = dailyBreakdown.get(dateKey)!\r\n          dayData.totalAmount += entryTotal\r\n          dayData.transactionCount += entry.transactionCount\r\n        }\r\n        \r\n        // Daily breakdown by bank\r\n        const bankId = entry.terminal.bankId || 'unknown'\r\n        if (dailyByBank.has(bankId)) {\r\n          const bankDaily = dailyByBank.get(bankId)!\r\n          if (bankDaily.has(dateKey)) {\r\n            const currentAmount = bankDaily.get(dateKey)!\r\n            bankDaily.set(dateKey, currentAmount + entryTotal)\r\n          }\r\n        }\r\n        \r\n        // Daily breakdown by terminal\r\n        if (dailyByTerminal.has(entry.terminalId)) {\r\n          const terminalDaily = dailyByTerminal.get(entry.terminalId)!\r\n          if (terminalDaily.has(dateKey)) {\r\n            const currentAmount = terminalDaily.get(dateKey)!\r\n            terminalDaily.set(dateKey, currentAmount + entryTotal)\r\n          }\r\n        }\r\n\r\n        // By bank (for summary)\r\n        const bankName = entry.terminal.bank?.name || 'Unknown Bank'\r\n        \r\n        if (!bankSales.has(bankId)) {\r\n          bankSales.set(bankId, {\r\n            bankName,\r\n            totalAmount: 0,\r\n            transactionCount: 0,\r\n            visa: 0,\r\n            master: 0,\r\n            amex: 0,\r\n            qr: 0,\r\n            dialogTouch: 0\r\n          })\r\n        }\r\n        \r\n        const bankData = bankSales.get(bankId)!\r\n        bankData.totalAmount += entryTotal\r\n        bankData.transactionCount += entry.transactionCount\r\n        bankData.visa += entry.visaAmount\r\n        bankData.master += entry.masterAmount\r\n        bankData.amex += entry.amexAmount\r\n        bankData.qr += entry.qrAmount\r\n        bankData.dialogTouch += entry.dialogTouchAmount\r\n\r\n        // By terminal (individual POS machine)\r\n        const terminalKey = entry.terminalId\r\n        if (!terminalSales.has(terminalKey)) {\r\n          terminalSales.set(terminalKey, {\r\n            terminalId: entry.terminalId,\r\n            terminalName: entry.terminal.name,\r\n            terminalNumber: entry.terminal.terminalNumber,\r\n            bankName,\r\n            totalAmount: 0,\r\n            transactionCount: 0,\r\n            visa: 0,\r\n            master: 0,\r\n            amex: 0,\r\n            qr: 0,\r\n            dialogTouch: 0\r\n          })\r\n        }\r\n        \r\n        const terminalData = terminalSales.get(terminalKey)!\r\n        terminalData.totalAmount += entryTotal\r\n        terminalData.transactionCount += entry.transactionCount\r\n        terminalData.visa += entry.visaAmount\r\n        terminalData.master += entry.masterAmount\r\n        terminalData.amex += entry.amexAmount\r\n        terminalData.qr += entry.qrAmount\r\n        terminalData.dialogTouch += entry.dialogTouchAmount\r\n      }\r\n    }\r\n\r\n    console.log('[POS Sales] Found', batches.length, 'batches')\r\n    console.log('[POS Sales] Total sales:', totalSales)\r\n    console.log('[POS Sales] Total terminals:', terminalSales.size)\r\n    console.log('[POS Sales] Total banks:', bankSales.size)\r\n\r\n    // Convert maps to arrays\r\n    const bankBreakdown = Array.from(bankSales.values())\r\n      .sort((a, b) => b.totalAmount - a.totalAmount)\r\n    \r\n    const terminalBreakdown = Array.from(terminalSales.values())\r\n      .sort((a, b) => b.totalAmount - a.totalAmount)\r\n\r\n    const dailyBreakdownArray = Array.from(dailyBreakdown.values())\r\n      .sort((a, b) => a.date.localeCompare(b.date))\r\n    \r\n    // Build daily by bank array (for multi-line chart)\r\n    const dailyByBankArray = Array.from(uniqueBanks.entries()).map(([bankId, bankName]) => ({\r\n      bankId,\r\n      bankName,\r\n      dailySales: Array.from(dailyByBank.get(bankId)?.entries() || [])\r\n        .map(([date, amount]) => ({ date, amount }))\r\n        .sort((a, b) => a.date.localeCompare(b.date))\r\n    }))\r\n    \r\n    // Build daily by terminal array (for daily table view)\r\n    const dailyByTerminalArray = Array.from(terminalSales.values()).map(terminal => ({\r\n      terminalId: terminal.terminalId,\r\n      terminalName: terminal.terminalName,\r\n      terminalNumber: terminal.terminalNumber,\r\n      bankName: terminal.bankName,\r\n      dailySales: Array.from(dailyByTerminal.get(terminal.terminalId)?.entries() || [])\r\n        .map(([date, amount]) => ({ date, amount }))\r\n        .sort((a, b) => a.date.localeCompare(b.date))\r\n    }))\r\n\r\n    return NextResponse.json({\r\n      summary: {\r\n        totalSales: Math.round(totalSales),\r\n        totalTransactions,\r\n        totalTerminals: terminalSales.size,\r\n        totalBanks: bankSales.size,\r\n        missingSlipsCount: missingSlips.length,\r\n        reconciledBatches: batches.filter(b => b.isReconciled).length,\r\n        unreconciledBatches: batches.filter(b => !b.isReconciled).length\r\n      },\r\n      dailyBreakdown: dailyBreakdownArray,\r\n      dailyByBank: dailyByBankArray,\r\n      dailyByTerminal: dailyByTerminalArray,\r\n      terminalBreakdown,\r\n      bankBreakdown,\r\n      missingSlips: missingSlips.map(slip => ({\r\n        id: slip.id,\r\n        terminalName: 'Unknown', // Will be populated from include\r\n        lastFourDigits: slip.lastFourDigits,\r\n        amount: slip.amount,\r\n        timestamp: slip.timestamp,\r\n        reportedBy: slip.reportedBy\r\n      })),\r\n      dateRange: {\r\n        start: dateStart.toISOString(),\r\n        end: dateEnd.toISOString()\r\n      }\r\n    })\r\n  } catch (error) {\r\n    console.error('[POS Sales] ERROR:', error)\r\n    console.error('[POS Sales] Stack:', error instanceof Error ? error.stack : 'No stack trace')\r\n    return NextResponse.json(\r\n      { \r\n        error: 'Failed to fetch POS sales report',\r\n        details: error instanceof Error ? error.message : 'Unknown error',\r\n        stack: error instanceof Error ? error.stack : undefined\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\profit\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\pumper-details\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\pumper-variance\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'varianceStatus' is assigned a value but never used.","line":123,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/db'\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const stationId = searchParams.get('stationId')\r\n    const month = searchParams.get('month') // Format: YYYY-MM\r\n\r\n    if (!stationId) {\r\n      return NextResponse.json({ error: 'Station ID is required' }, { status: 400 })\r\n    }\r\n\r\n    if (!month) {\r\n      return NextResponse.json({ error: 'Month is required (format: YYYY-MM)' }, { status: 400 })\r\n    }\r\n\r\n    const [year, monthNum] = month.split('-').map(Number)\r\n    if (isNaN(year) || isNaN(monthNum) || monthNum < 1 || monthNum > 12) {\r\n      return NextResponse.json({ error: 'Invalid month format' }, { status: 400 })\r\n    }\r\n\r\n    // Business month: 7th of selected month to 6th of next month\r\n    const startOfMonth = new Date(year, monthNum - 1, 7, 0, 0, 0, 0)\r\n    const endOfMonth = new Date(year, monthNum, 6, 23, 59, 59, 999)\r\n\r\n    // Get all closed shifts for the month\r\n    const shifts = await prisma.shift.findMany({\r\n      where: {\r\n        stationId,\r\n        status: 'CLOSED',\r\n        startTime: {\r\n          gte: startOfMonth,\r\n          lte: endOfMonth\r\n        }\r\n      },\r\n      select: {\r\n        id: true,\r\n        startTime: true,\r\n        endTime: true,\r\n        declaredAmounts: true\r\n      }\r\n    })\r\n\r\n    // Extract pumper breakdowns from shift declaredAmounts\r\n    const pumperVarianceMap = new Map<string, {\r\n      pumperId: string\r\n      pumperName: string\r\n      totalShifts: number\r\n      shiftsWithVariance: number\r\n      varianceCount: number\r\n      totalVarianceAmount: number\r\n      maxSingleVariance: number\r\n      varianceRate: number\r\n      dailyVariances: Array<{ day: number; variance: number }>\r\n    }>()\r\n\r\n    // Get all pumpers\r\n    const pumpers = await prisma.pumper.findMany({\r\n      where: {\r\n        stationId,\r\n        isActive: true\r\n      },\r\n      select: {\r\n        id: true,\r\n        name: true\r\n      }\r\n    })\r\n\r\n    // Initialize pumper map\r\n    for (const pumper of pumpers) {\r\n      pumperVarianceMap.set(pumper.name, {\r\n        pumperId: pumper.id,\r\n        pumperName: pumper.name,\r\n        totalShifts: 0,\r\n        shiftsWithVariance: 0,\r\n        varianceCount: 0,\r\n        totalVarianceAmount: 0,\r\n        maxSingleVariance: 0,\r\n        varianceRate: 0,\r\n        dailyVariances: []\r\n      })\r\n    }\r\n\r\n    interface PumperBreakdown {\r\n      pumperName: string\r\n      variance?: number\r\n      varianceStatus?: string\r\n    }\r\n    interface DeclaredAmounts {\r\n      pumperBreakdown?: PumperBreakdown[]\r\n    }\r\n\r\n    // Process each shift's pumper breakdown\r\n    for (const shift of shifts) {\r\n      const declaredAmounts = shift.declaredAmounts as unknown as DeclaredAmounts\r\n      const pumperBreakdown = declaredAmounts?.pumperBreakdown || []\r\n\r\n      for (const breakdown of pumperBreakdown) {\r\n        const pumperName = breakdown.pumperName\r\n        if (!pumperName) continue\r\n\r\n        let pumperData = pumperVarianceMap.get(pumperName)\r\n        if (!pumperData) {\r\n          // Create entry for pumper not in list\r\n          pumperData = {\r\n            pumperId: `pumper-${pumperName}`,\r\n            pumperName,\r\n            totalShifts: 0,\r\n            shiftsWithVariance: 0,\r\n            varianceCount: 0,\r\n            totalVarianceAmount: 0,\r\n            maxSingleVariance: 0,\r\n            varianceRate: 0,\r\n            dailyVariances: []\r\n          }\r\n          pumperVarianceMap.set(pumperName, pumperData)\r\n        }\r\n\r\n        pumperData.totalShifts += 1\r\n\r\n        const variance = breakdown.variance || 0\r\n        const varianceStatus = breakdown.varianceStatus || 'NORMAL'\r\n        const varianceThreshold = 20 // Threshold for considering it a variance\r\n\r\n        if (Math.abs(variance) > varianceThreshold) {\r\n          pumperData.shiftsWithVariance += 1\r\n          pumperData.varianceCount += 1\r\n          pumperData.totalVarianceAmount += Math.abs(variance)\r\n          pumperData.maxSingleVariance = Math.max(pumperData.maxSingleVariance, Math.abs(variance))\r\n\r\n          // Add to daily variance for the day of the shift\r\n          const shiftDate = new Date(shift.startTime)\r\n          const dayOfMonth = shiftDate.getDate()\r\n          if (dayOfMonth >= 1 && dayOfMonth <= 31) {\r\n            pumperData.dailyVariances[dayOfMonth - 1].variance += variance\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Calculate variance rate and performance rating for each pumper\r\n    const pumperVariances = Array.from(pumperVarianceMap.values()).map(pumperData => {\r\n      pumperData.varianceRate = pumperData.totalShifts > 0\r\n        ? (pumperData.shiftsWithVariance / pumperData.totalShifts) * 100\r\n        : 0\r\n\r\n      let performanceRating: 'EXCELLENT' | 'GOOD' | 'NEEDS_IMPROVEMENT' | 'CRITICAL'\r\n      if (pumperData.varianceRate <= 5) {\r\n        performanceRating = 'EXCELLENT'\r\n      } else if (pumperData.varianceRate <= 15) {\r\n        performanceRating = 'GOOD'\r\n      } else if (pumperData.varianceRate <= 30) {\r\n        performanceRating = 'NEEDS_IMPROVEMENT'\r\n      } else {\r\n        performanceRating = 'CRITICAL'\r\n      }\r\n\r\n      return {\r\n        ...pumperData,\r\n        performanceRating,\r\n        averageVariance: pumperData.varianceCount > 0\r\n          ? Math.round((pumperData.totalVarianceAmount / pumperData.varianceCount) * 100) / 100\r\n          : 0\r\n      }\r\n    }).sort((a, b) => {\r\n      // Sort by variance rate (worst first)\r\n      return b.varianceRate - a.varianceRate\r\n    })\r\n\r\n    return NextResponse.json({\r\n      month,\r\n      stationId,\r\n      pumperVariances,\r\n      summary: {\r\n        totalPumpers: pumperVariances.length,\r\n        excellent: pumperVariances.filter(p => p.performanceRating === 'EXCELLENT').length,\r\n        good: pumperVariances.filter(p => p.performanceRating === 'GOOD').length,\r\n        needsImprovement: pumperVariances.filter(p => p.performanceRating === 'NEEDS_IMPROVEMENT').length,\r\n        critical: pumperVariances.filter(p => p.performanceRating === 'CRITICAL').length\r\n      }\r\n    })\r\n  } catch (error) {\r\n    console.error('Error generating pumper variance report:', error)\r\n    return NextResponse.json({\r\n      error: 'Internal server error',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\reports\\station-comparison\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\safe\\balance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\safe\\outstanding-credit\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\safe\\pending\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\safe\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\safe\\summary\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'shifts' is assigned a value but never used.","line":20,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalLoansGiven' is assigned a value but never used.","line":105,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":105,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const stationId = searchParams.get('stationId')\n    const dateStr = searchParams.get('date') || new Date().toISOString().split('T')[0]\n    const date = new Date(dateStr)\n    const startOfDay = new Date(date)\n    startOfDay.setHours(0, 0, 0, 0)\n    const endOfDay = new Date(date)\n    endOfDay.setHours(23, 59, 59, 999)\n\n    if (!stationId) {\n      return NextResponse.json({ error: 'Station ID is required' }, { status: 400 })\n    }\n\n    // Get shifts for the day to calculate sales\n    const shifts = await prisma.shift.findMany({\n      where: {\n        stationId,\n        startTime: {\n          gte: startOfDay,\n          lte: endOfDay\n        }\n      },\n      include: {\n        assignments: {\n          include: {\n            nozzle: {\n              include: {\n                tank: true,\n                pump: true\n              }\n            }\n          }\n        }\n      }\n    })\n\n    // Get actual safe transactions for the day (not calculated from shifts)\n    // This ensures we get the actual cash amounts that were declared/added to safe\n    const safe = await prisma.safe.findUnique({\n      where: { stationId }\n    })\n\n    if (!safe) {\n      return NextResponse.json({\n        date: dateStr,\n        stationId,\n        totalCashIn: 0,\n        totalExpenses: 0,\n        totalLoansGiven: 0,\n        totalCreditRepayments: 0,\n        totalChequeEncashed: 0,\n        totalDeposits: 0,\n        netCash: 0,\n        openingBalance: 0,\n        closingBalance: 0\n      })\n    }\n\n    // Get all transactions for the day\n    const dayTransactions = await prisma.safeTransaction.findMany({\n      where: {\n        safeId: safe.id,\n        timestamp: {\n          gte: startOfDay,\n          lte: endOfDay\n        }\n      },\n      orderBy: { timestamp: 'asc' }\n    })\n\n    // Calculate actual cash in from safe transactions (only CASH_FUEL_SALES type)\n    const totalCashIn = dayTransactions\n      .filter(tx => tx.type === 'CASH_FUEL_SALES')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Also get POS card payments (should be in safe)\n    const totalPosCardIn = dayTransactions\n      .filter(tx => tx.type === 'POS_CARD_PAYMENT')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Get expenses from safe transactions (EXPENSE type) or expense records\n    const totalExpensesFromSafe = dayTransactions\n      .filter(tx => tx.type === 'EXPENSE')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Also get from expense records (if not from safe)\n    const expenses = await prisma.expense.findMany({\n      where: {\n        stationId,\n        expenseDate: {\n          gte: startOfDay,\n          lte: endOfDay\n        },\n        fromSafe: false // Only count expenses not yet deducted from safe\n      }\n    })\n    const totalExpenses = totalExpensesFromSafe + expenses.reduce((sum, exp) => sum + exp.amount, 0)\n\n    // Get loans given from safe transactions\n    const totalLoansGiven = dayTransactions\n      .filter(tx => tx.type === 'LOAN_GIVEN')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Get credit repayments from safe transactions\n    const totalCreditRepayments = dayTransactions\n      .filter(tx => tx.type === 'CREDIT_PAYMENT')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Get cheques received (not encashed - those are when they clear)\n    const totalChequeReceived = dayTransactions\n      .filter(tx => tx.type === 'CHEQUE_RECEIVED')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Get deposits from safe transactions\n    const totalDeposits = dayTransactions\n      .filter(tx => tx.type === 'BANK_DEPOSIT')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Calculate opening balance (balance at start of day)\n    // Get all transactions before start of day, ordered chronologically\n    const transactionsBeforeDay = await prisma.safeTransaction.findMany({\n      where: {\n        safeId: safe.id,\n        timestamp: { lt: startOfDay }\n      },\n      orderBy: { timestamp: 'asc' }\n    })\n\n    // Calculate opening balance (balance at start of day)\n    // OPENING_BALANCE transactions set the balance, they don't add/subtract\n    let openingBalance = safe.openingBalance\n    for (const tx of transactionsBeforeDay) {\n      if (tx.type === 'OPENING_BALANCE') {\n        // OPENING_BALANCE sets the balance to this value\n        openingBalance = tx.amount\n      } else {\n        // Regular transactions add or subtract\n        const txIsIncome = [\n          'CASH_FUEL_SALES',\n          'POS_CARD_PAYMENT',\n          'CREDIT_PAYMENT',\n          'CHEQUE_RECEIVED',\n          'LOAN_REPAID'\n        ].includes(tx.type)\n\n        openingBalance += txIsIncome ? tx.amount : -tx.amount\n      }\n    }\n\n    // Calculate total income for the day\n    const totalIncome = dayTransactions\n      .filter(tx => [\n        'CASH_FUEL_SALES',\n        'POS_CARD_PAYMENT',\n        'CREDIT_PAYMENT',\n        'CHEQUE_RECEIVED',\n        'LOAN_REPAID'\n      ].includes(tx.type))\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Calculate total outflow for the day\n    const totalOutflow = dayTransactions\n      .filter(tx => [\n        'EXPENSE',\n        'BANK_DEPOSIT',\n        'LOAN_GIVEN'\n      ].includes(tx.type))\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    // Calculate closing balance and net cash\n    const closingBalance = openingBalance + totalIncome - totalOutflow\n    const netCash = totalIncome - totalOutflow\n    // expectedBalance is the same as closingBalance, no need to calculate twice\n    const expectedBalance = closingBalance\n\n    // Get actual balance from safe (current balance at end of day)\n    // Calculate actual balance at end of day\n    const allTransactions = await prisma.safeTransaction.findMany({\n      where: {\n        safeId: safe.id,\n        timestamp: { lte: endOfDay }\n      },\n      orderBy: { timestamp: 'asc' }\n    })\n\n    // Calculate actual balance at end of day\n    // OPENING_BALANCE transactions set the balance, they don't add/subtract\n    let actualBalance = safe.openingBalance\n    for (const tx of allTransactions) {\n      if (tx.type === 'OPENING_BALANCE') {\n        // OPENING_BALANCE sets the balance to this value\n        actualBalance = tx.amount\n      } else {\n        // Regular transactions add or subtract\n        const txIsIncome = [\n          'CASH_FUEL_SALES',\n          'POS_CARD_PAYMENT',\n          'CREDIT_PAYMENT',\n          'CHEQUE_RECEIVED',\n          'LOAN_REPAID'\n        ].includes(tx.type)\n        actualBalance += txIsIncome ? tx.amount : -tx.amount\n      }\n    }\n\n    const variance = actualBalance - expectedBalance\n    const isBalanced = Math.abs(variance) <= 500 // Tolerance of Rs. 500\n\n    // Get station name\n    const station = await prisma.station.findUnique({\n      where: { id: stationId },\n      select: { name: true }\n    })\n\n    interface InflowDetail {\n      id: string\n      type: string\n      description: string\n      amount: number\n      time: string\n      reference?: string\n    }\n\n    // Get inflow details\n    const inflowDetails: InflowDetail[] = dayTransactions\n      .filter(tx => [\n        'CASH_FUEL_SALES',\n        'POS_CARD_PAYMENT',\n        'CREDIT_PAYMENT',\n        'CHEQUE_RECEIVED',\n        'LOAN_REPAID'\n      ].includes(tx.type))\n      .map(tx => ({\n        id: tx.id,\n        type: tx.type === 'CASH_FUEL_SALES' ? 'CASH_SALES' :\n          tx.type === 'POS_CARD_PAYMENT' ? 'CARD_PAYMENT' :\n            tx.type === 'CREDIT_PAYMENT' ? 'CREDIT_PAYMENT' :\n              tx.type === 'CHEQUE_RECEIVED' ? 'CHEQUE_RECEIVED' :\n                tx.type === 'LOAN_REPAID' ? 'LOAN_RECEIPT' : 'OTHER',\n        description: tx.description,\n        amount: tx.amount,\n        time: new Date(tx.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),\n        reference: tx.shiftId || tx.creditSaleId || tx.batchId || tx.loanId || undefined\n      }))\n\n    interface OutflowDetail {\n      id: string\n      type: string\n      description: string\n      amount: number\n      time: string\n      reference?: string\n      approvedBy?: string\n    }\n\n    // Get outflow details\n    const outflowDetails: OutflowDetail[] = dayTransactions\n      .filter(tx => [\n        'EXPENSE',\n        'BANK_DEPOSIT',\n        'LOAN_GIVEN'\n      ].includes(tx.type))\n      .map(tx => ({\n        id: tx.id,\n        type: tx.type === 'EXPENSE' ? 'EXPENSE' :\n          tx.type === 'BANK_DEPOSIT' ? 'DEPOSIT' :\n            tx.type === 'LOAN_GIVEN' ? 'LOAN_PAYMENT' : 'OTHER',\n        description: tx.description,\n        amount: tx.amount,\n        time: new Date(tx.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),\n        reference: tx.expenseId || tx.depositId || tx.loanId || undefined,\n        approvedBy: tx.performedBy || 'System'\n      }))\n\n    // Calculate breakdown\n    const cashSales = dayTransactions\n      .filter(tx => tx.type === 'CASH_FUEL_SALES')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    const creditPayments = dayTransactions\n      .filter(tx => tx.type === 'CREDIT_PAYMENT')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    const loanReceipts = dayTransactions\n      .filter(tx => tx.type === 'LOAN_REPAID')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    const otherInflows = dayTransactions\n      .filter(tx => tx.type === 'CHEQUE_RECEIVED' || tx.type === 'POS_CARD_PAYMENT')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    const loanPayments = dayTransactions\n      .filter(tx => tx.type === 'LOAN_GIVEN')\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    const otherOutflows = dayTransactions\n      .filter(tx => tx.type !== 'EXPENSE' && tx.type !== 'BANK_DEPOSIT' &&\n        tx.type !== 'LOAN_GIVEN' && ![\n          'CASH_FUEL_SALES', 'POS_CARD_PAYMENT', 'CREDIT_PAYMENT',\n          'CHEQUE_RECEIVED', 'LOAN_REPAID', 'OPENING_BALANCE'\n        ].includes(String(tx.type)))\n      .reduce((sum, tx) => sum + tx.amount, 0)\n\n    const summary = {\n      stationId,\n      stationName: station?.name || 'Unknown Station',\n      date: dateStr,\n      openingBalance,\n      cashSales,\n      creditPayments,\n      loanReceipts,\n      otherInflows,\n      totalInflows: totalIncome,\n      expenses: totalExpenses,\n      loanPayments,\n      deposits: totalDeposits,\n      otherOutflows,\n      totalOutflows: totalOutflow,\n      expectedBalance,\n      actualBalance,\n      variance,\n      isBalanced,\n      inflowDetails,\n      outflowDetails,\n      // Also return legacy fields for compatibility\n      totalCashIn,\n      totalPosCardIn,\n      totalCreditRepayments,\n      totalChequeReceived,\n      netCash,\n      closingBalance\n    }\n\n    return NextResponse.json(summary)\n  } catch (error) {\n    console.error('Error fetching safe summary:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\safe\\transactions\\route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1344,1347],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1344,1347],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":199,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5579,5582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5579,5582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\salary\\payments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\salary\\repay-loan\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeTransaction' is assigned a value but never used.","line":55,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":55,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/db'\r\n\r\n// POST: Repay a pumper loan (mark as paid)\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { loanId, repaidBy, repaymentDate, notes } = body\r\n\r\n    if (!loanId || !repaidBy) {\r\n      return NextResponse.json(\r\n        { error: 'Loan ID and repaid by are required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Find the loan\r\n    const loan = await prisma.loanPumper.findUnique({\r\n      where: { id: loanId }\r\n    })\r\n\r\n    if (!loan) {\r\n      return NextResponse.json({ error: 'Loan not found' }, { status: 404 })\r\n    }\r\n\r\n    if (loan.status === 'PAID') {\r\n      return NextResponse.json({ error: 'Loan is already paid' }, { status: 400 })\r\n    }\r\n\r\n    // Update loan status to PAID and create safe transaction in a single transaction\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      // 1. Update loan status\r\n      const updatedLoan = await tx.loanPumper.update({\r\n        where: { id: loanId },\r\n        data: {\r\n          status: 'PAID',\r\n          updatedAt: repaymentDate ? new Date(repaymentDate) : new Date()\r\n        }\r\n      })\r\n\r\n      // 2. Handle Safe Transaction if pumper belongs to a station\r\n      let safeTransaction = null\r\n      if (updatedLoan.stationId) {\r\n        // Find safe for the station\r\n        const safe = await tx.safe.findUnique({\r\n          where: { stationId: updatedLoan.stationId }\r\n        })\r\n\r\n        if (safe) {\r\n          // Calculate new balance\r\n          const balanceBefore = safe.currentBalance\r\n          const balanceAfter = balanceBefore + loan.amount\r\n\r\n          // Create safe transaction\r\n          safeTransaction = await tx.safeTransaction.create({\r\n            data: {\r\n              safeId: safe.id,\r\n              type: 'LOAN_REPAID',\r\n              amount: loan.amount,\r\n              description: `Loan repayment from ${updatedLoan.pumperName} - ${notes || 'Loan fully repaid'}`,\r\n              performedBy: repaidBy,\r\n              timestamp: repaymentDate ? new Date(repaymentDate) : new Date(),\r\n              balanceBefore,\r\n              balanceAfter,\r\n              shiftId: null // Optional: could link to active shift if we wanted to find it\r\n            }\r\n          })\r\n\r\n          // Update safe balance\r\n          await tx.safe.update({\r\n            where: { id: safe.id },\r\n            data: { currentBalance: balanceAfter }\r\n          })\r\n        }\r\n      }\r\n\r\n      return updatedLoan\r\n    })\r\n\r\n    return NextResponse.json({\r\n      message: 'Loan marked as paid and safe transaction recorded',\r\n      loan: result\r\n    })\r\n  } catch (error) {\r\n    console.error('Error repaying loan:', error)\r\n    return NextResponse.json(\r\n      { error: 'Internal server error', details: error instanceof Error ? error.message : 'Unknown error' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\salary\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'safeLoanTransactions' is assigned a value but never used.","line":137,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":137,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const stationId = searchParams.get('stationId')\n    const month = searchParams.get('month') // Format: YYYY-MM\n    const pumperId = searchParams.get('pumperId')\n\n    if (!stationId) {\n      return NextResponse.json({ error: 'Station ID is required' }, { status: 400 })\n    }\n\n    // Parse month or use current month\n    // Salary month runs from 7th of current month to 6th of next month\n    let startDate: Date\n    let endDate: Date\n\n    if (month) {\n      const [year, monthNum] = month.split('-').map(Number)\n      // Start: 7th of the specified month\n      startDate = new Date(year, monthNum - 1, 7, 0, 0, 0, 0)\n      // End: 6th of next month at 23:59:59\n      endDate = new Date(year, monthNum, 6, 23, 59, 59, 999)\n    } else {\n      const now = new Date()\n      // If current date is before 7th, use previous month's salary period\n      // If current date is 7th or after, use current month's salary period\n      let salaryMonth = now.getMonth()\n      let salaryYear = now.getFullYear()\n\n      if (now.getDate() < 7) {\n        // Use previous month\n        salaryMonth = now.getMonth() - 1\n        if (salaryMonth < 0) {\n          salaryMonth = 11\n          salaryYear = now.getFullYear() - 1\n        }\n      }\n\n      startDate = new Date(salaryYear, salaryMonth, 7, 0, 0, 0, 0)\n      endDate = new Date(salaryYear, salaryMonth + 1, 6, 23, 59, 59, 999)\n    }\n\n    // Get all pumpers for the station with base salary\n    const pumpers = await prisma.pumper.findMany({\n      where: {\n        stationId,\n        isActive: true,\n        ...(pumperId ? { id: pumperId } : {})\n      },\n      select: {\n        id: true,\n        name: true,\n        employeeId: true,\n        baseSalary: true,\n        holidayAllowance: true // This field exists in schema but Prisma client might not be regenerated yet\n      }\n    })\n\n    // Get closed shifts for the month\n    const shifts = await prisma.shift.findMany({\n      where: {\n        stationId,\n        status: 'CLOSED',\n        endTime: {\n          gte: startDate,\n          lte: endDate\n        }\n      },\n      select: {\n        id: true,\n        startTime: true,\n        endTime: true,\n        statistics: true,\n        declaredAmounts: true,\n        assignments: {\n          select: {\n            pumperName: true,\n            startMeterReading: true,\n            endMeterReading: true\n          }\n        }\n      },\n      orderBy: {\n        endTime: 'asc'\n      }\n    })\n\n    // Get ALL active (unpaid) loans for pumpers\n    // Monthly rental should be deducted every month for active loans, regardless of when they were created\n    // Only include loans that were created before or during the salary period (to avoid future loans)\n    const loanPumperRecords = await prisma.loanPumper.findMany({\n      where: {\n        stationId,\n        status: 'ACTIVE', // Only count active (unpaid) loans\n        createdAt: {\n          lte: endDate // Loan was created before or during this salary period\n        }\n      },\n      select: {\n        id: true,\n        pumperName: true,\n        amount: true,\n        monthlyRental: true,\n        reason: true,\n        createdAt: true,\n        dueDate: true,\n        status: true,\n        paidAmount: true\n      }\n    })\n\n    // Debug: Log all loans found\n    console.log(`[Salary API] Found ${loanPumperRecords.length} active loans for station ${stationId} (created before ${endDate.toISOString()})`)\n    if (loanPumperRecords.length > 0) {\n      console.log('[Salary API] Loan details:', loanPumperRecords.map(l => ({\n        id: l.id,\n        amount: l.amount,\n        monthlyRental: l.monthlyRental,\n        status: l.status,\n        createdAt: l.createdAt,\n        paidAmount: l.paidAmount // Ensure paidAmount is logged for debugging\n      })))\n    }\n\n    // Also get loans from safe transactions (loans given from safe page)\n    // Get ALL loan transactions up to end of month - loans should be tracked until paid\n    const safe = await prisma.safe.findUnique({\n      where: { stationId }\n    })\n\n    // Get all loan transactions up to end of month\n    // Note: This is a limitation - we can't track if safe loan was repaid without a separate model\n    // For now, we'll only count loans given during or before the month\n    const safeLoanTransactions = safe ? await prisma.safeTransaction.findMany({\n      where: {\n        safeId: safe.id,\n        type: 'LOAN_GIVEN',\n        timestamp: {\n          lte: endDate // Include loans given up to end of month\n        },\n        description: {\n          contains: 'pumper' // Filter for pumper loans only\n        }\n      },\n      select: {\n        id: true,\n        amount: true,\n        description: true,\n        timestamp: true,\n        loanId: true // Link to LoanPumper if exists\n      }\n    }) : []\n\n    // Process salary data for each pumper\n    const salaryData = pumpers.map(pumper => {\n      // Filter shifts where this pumper worked\n      interface PumperBreakdown {\n        pumperName: string\n        calculatedSales?: number\n        advanceTaken?: number\n        variance?: number\n        varianceStatus?: string\n      }\n      interface DeclaredAmounts {\n        pumperBreakdown?: PumperBreakdown[]\n      }\n\n      const pumperShifts = shifts.filter(shift => {\n        const declaredAmounts = shift.declaredAmounts as unknown as DeclaredAmounts\n        const pumperBreakdown = declaredAmounts?.pumperBreakdown || []\n        return pumperBreakdown.some(pb => pb.pumperName === pumper.name) ||\n          shift.assignments.some(a => a.pumperName === pumper.name)\n      })\n\n      // Get base salary (default to 27000 if not set)\n      const baseSalary = (pumper.baseSalary !== null && pumper.baseSalary !== undefined && pumper.baseSalary > 0)\n        ? pumper.baseSalary\n        : 27000\n\n      // Get holiday allowance from pumper settings (default to 4500 if not set)\n      const holidayAllowance = (pumper.holidayAllowance !== null && pumper.holidayAllowance !== undefined && pumper.holidayAllowance > 0)\n        ? pumper.holidayAllowance\n        : 4500\n      const restDayDeduction = 900 // Deduction per rest day\n      const allowedRestDays = 5 // 5 rest days per month\n\n      // Calculate OT rate per hour: ((basic/30) / 8) * 1.5\n      const dailySalary = baseSalary / 30\n      const hourlyRate = dailySalary / 8\n      const overtimeRate = hourlyRate * 1.5\n\n      let totalHours = 0\n      let totalSales = 0\n      let totalAdvances = 0\n      let totalVarianceAdd = 0 // Amount to add to salary\n      let totalVarianceDeduct = 0 // Amount to deduct from salary\n      let shiftCount = 0\n      let totalOvertimeHours = 0\n      let totalOvertimeAmount = 0\n      const workedDates = new Set<string>() // Track unique dates worked\n      const shiftDetails: Array<{\n        shiftId: string\n        date: string\n        hours: number\n        sales: number\n        advance: number\n        variance: number\n        varianceStatus: string\n        overtimeHours?: number\n        overtimeAmount?: number\n      }> = []\n\n      pumperShifts.forEach(shift => {\n        const declaredAmounts = shift.declaredAmounts as unknown as DeclaredAmounts\n        const pumperBreakdown = declaredAmounts?.pumperBreakdown || []\n        const breakdown = pumperBreakdown.find(pb => pb.pumperName === pumper.name)\n\n        if (breakdown) {\n          const shiftStart = new Date(shift.startTime)\n          const shiftEnd = shift.endTime ? new Date(shift.endTime) : new Date()\n          const hours = (shiftEnd.getTime() - shiftStart.getTime()) / (1000 * 60 * 60)\n\n          // Track worked date (just the date, not time)\n          const workedDate = shiftEnd.toISOString().split('T')[0]\n          workedDates.add(workedDate)\n\n          totalHours += hours\n          totalSales += breakdown.calculatedSales || 0\n          totalAdvances += breakdown.advanceTaken || 0\n\n          // Calculate overtime for this shift (if > 8 hours)\n          let shiftOvertimeHours = 0\n          let shiftOvertimeAmount = 0\n          if (hours > 8) {\n            shiftOvertimeHours = hours - 8\n            shiftOvertimeAmount = shiftOvertimeHours * overtimeRate\n            totalOvertimeHours += shiftOvertimeHours\n            totalOvertimeAmount += shiftOvertimeAmount\n          }\n\n          // Handle variance adjustments based on varianceStatus from shift close\n          // Variance = Calculated Sales - Effective Declared\n          // If |variance| > 20: add/deduct FULL variance amount\n          // If |variance| <= 20: ignore (NORMAL - no adjustment)\n          // The varianceStatus is already correctly set in shift close page, so trust it\n          if (breakdown.varianceStatus === 'ADD_TO_SALARY') {\n            // Surplus - declared more than calculated, reward with FULL variance bonus\n            totalVarianceAdd += Math.abs(breakdown.variance || 0)\n          } else if (breakdown.varianceStatus === 'DEDUCT_FROM_SALARY') {\n            // Shortage - declared less than calculated, deduct FULL variance from salary\n            totalVarianceDeduct += Math.abs(breakdown.variance || 0)\n          }\n          // If status is 'NORMAL', no variance adjustment needed (|variance| <= 20)\n\n          shiftCount++\n\n          shiftDetails.push({\n            shiftId: shift.id,\n            date: workedDate,\n            hours: Math.round(hours * 100) / 100,\n            sales: breakdown.calculatedSales || 0,\n            advance: breakdown.advanceTaken || 0,\n            variance: breakdown.variance || 0,\n            varianceStatus: breakdown.varianceStatus || 'NORMAL',\n            overtimeHours: Math.round(shiftOvertimeHours * 100) / 100,\n            overtimeAmount: Math.round(shiftOvertimeAmount * 100) / 100\n          })\n        }\n      })\n\n      // Get loans for this pumper from LoanPumper records\n      // Match by exact pumper name (case-insensitive for safety)\n      const pumperLoansFromRecords = loanPumperRecords.filter(loan =>\n        loan.pumperName.toLowerCase().trim() === pumper.name.toLowerCase().trim()\n      )\n\n      // Debug: Log loans for this pumper\n      if (pumperLoansFromRecords.length > 0) {\n        console.log(`[Salary API] Pumper: ${pumper.name}, Found ${pumperLoansFromRecords.length} loans:`,\n          pumperLoansFromRecords.map(l => ({\n            id: l.id,\n            amount: l.amount,\n            monthlyRental: l.monthlyRental,\n            status: l.status,\n            createdAt: l.createdAt,\n            pumperName: l.pumperName\n          }))\n        )\n      }\n\n      // Calculate monthly loan rental deductions (not total loan amount)\n      // All loans in pumperLoansFromRecords are already active and created before endDate\n      // Sum monthly rental amounts from all active loans\n      const totalMonthlyRental = pumperLoansFromRecords.reduce((sum, loan) => {\n        const rental = loan.monthlyRental || 0\n        console.log(`[Salary API] Loan ${loan.id}: monthlyRental = ${rental}`)\n        return sum + rental\n      }, 0)\n\n      // Calculate total outstanding loan amount (sum of remaining balances)\n      const totalLoanAmount = pumperLoansFromRecords.reduce((sum, loan) => {\n        const paidAmount = loan.paidAmount || 0\n        const remainingAmount = loan.amount - paidAmount\n        return sum + remainingAmount\n      }, 0)\n\n      // Note: Safe transactions for pumper loans are now tracked via LoanPumper records\n      // We no longer count safe transactions separately for monthly rental calculation\n      // Loans created from safe page now create LoanPumper records with monthlyRental\n\n      const totalLoans = totalMonthlyRental // Use monthly rental instead of loan amount\n\n      if (totalLoans > 0) {\n        console.log(`[Salary API] Total monthly rental for ${pumper.name}: Rs. ${totalLoans}`)\n      } else if (loanPumperRecords.length > 0) {\n        console.log(`[Salary API] Warning: Found ${loanPumperRecords.length} active loans but 0 for pumper ${pumper.name}. Pumper names in loans:`,\n          loanPumperRecords.map(l => l.pumperName)\n        )\n      }\n\n      // Calculate commission: 1 rs per 1000rs sales\n      const commission = Math.floor(totalSales / 1000)\n\n      // Calculate rest days deduction\n      // Total days in salary period (from 7th to 6th of next month = ~30 days)\n      const daysInPeriod = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))\n      const daysWorked = workedDates.size\n      // Rest days taken = total days in period - days worked\n      // They are allowed 5 rest days. For each rest day taken (up to 5), deduct 900rs\n      const totalRestDays = daysInPeriod - daysWorked\n      const restDaysTaken = Math.min(totalRestDays, allowedRestDays) // Cap at 5 allowed rest days\n      // Deduct 900rs for each rest day taken (up to the 5 allowed)\n      const restDayDeductionAmount = restDaysTaken * restDayDeduction\n      const actualHolidayAllowance = holidayAllowance - restDayDeductionAmount\n\n      // Calculate EPF (Employee Provident Fund) - typically 8% of gross salary\n      // EPF = 8% of (baseSalary + holidayAllowance + overtime + commission)\n      const grossSalary = baseSalary + actualHolidayAllowance + totalOvertimeAmount + commission\n      const epf = Math.round(grossSalary * 0.08 * 100) / 100\n\n      // Calculate net salary\n      // Formula: Base Salary + Holiday Allowance + Overtime + Commission + Variance Bonuses \n      //          - Variance Deductions - Advances - Loans - EPF\n      // Net Salary = Base + Allowance + OT + Commission + Additions - Deductions - EPF\n      const netSalary = baseSalary + actualHolidayAllowance + totalOvertimeAmount + commission + totalVarianceAdd\n        - totalVarianceDeduct - totalAdvances - totalLoans - epf\n\n      // Always return data for the pumper, even if they have no shifts\n      return {\n        pumperId: pumper.id,\n        pumperName: pumper.name,\n        employeeId: pumper.employeeId,\n        baseSalary: baseSalary,\n        holidayAllowance: actualHolidayAllowance,\n        restDaysTaken: restDaysTaken,\n        daysWorked: daysWorked,\n        shiftCount,\n        totalHours: Math.round(totalHours * 100) / 100,\n        totalOvertimeHours: Math.round(totalOvertimeHours * 100) / 100,\n        totalOvertimeAmount: Math.round(totalOvertimeAmount * 100) / 100,\n        commission: commission,\n        totalSales: Math.round(totalSales),\n        totalAdvances: Math.round(totalAdvances * 100) / 100,\n        totalLoans: Math.round(totalLoans * 100) / 100,\n        totalLoanAmount: Math.round(totalLoanAmount * 100) / 100,\n        varianceAdd: Math.round(totalVarianceAdd * 100) / 100,\n        varianceDeduct: Math.round(totalVarianceDeduct * 100) / 100,\n        epf: epf,\n        netSalary: Math.round(netSalary * 100) / 100,\n        shiftDetails\n      }\n    })\n\n    // If pumperId is specified and no data found, return empty data for that pumper\n    if (pumperId && salaryData.length === 0) {\n      const pumper = await prisma.pumper.findUnique({\n        where: { id: pumperId },\n        select: {\n          id: true,\n          name: true,\n          employeeId: true,\n          baseSalary: true,\n          holidayAllowance: true\n        }\n      })\n\n      if (pumper) {\n        // Get loans even if no shifts\n        const pumperLoansFromRecords = loanPumperRecords.filter(loan =>\n          loan.pumperName.toLowerCase().trim() === pumper.name.toLowerCase().trim()\n        )\n        // Calculate monthly loan rental deductions (not total loan amount)\n        // All loans in pumperLoansFromRecords are already active and created before endDate\n        // Sum monthly rental amounts from all active loans\n        const totalMonthlyRental = pumperLoansFromRecords.reduce((sum, loan) => {\n          return sum + (loan.monthlyRental || 0)\n        }, 0)\n\n        const totalLoans = totalMonthlyRental // Use monthly rental instead of loan amount\n        const baseSalary = (pumper.baseSalary !== null && pumper.baseSalary !== undefined && pumper.baseSalary > 0)\n          ? pumper.baseSalary\n          : 27000\n        const holidayAllowance = (pumper.holidayAllowance !== null && pumper.holidayAllowance !== undefined && pumper.holidayAllowance > 0)\n          ? pumper.holidayAllowance\n          : 4500\n        const restDayDeduction = 900\n        const allowedRestDays = 5\n        const daysInPeriod = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))\n        // If no shifts worked, assume they took all 5 rest days (deduct full allowance)\n        const totalRestDays = daysInPeriod - 0 // 0 days worked\n        const restDaysTaken = Math.min(totalRestDays, allowedRestDays)\n        const restDayDeductionAmount = restDaysTaken * restDayDeduction\n        const actualHolidayAllowance = holidayAllowance - restDayDeductionAmount\n        const grossSalary = baseSalary + actualHolidayAllowance\n        const epf = Math.round(grossSalary * 0.08 * 100) / 100\n        const netSalary = baseSalary + actualHolidayAllowance - totalLoans - epf\n\n        return NextResponse.json({\n          month: month || `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`,\n          startDate: startDate.toISOString(),\n          endDate: endDate.toISOString(),\n          salaryData: [{\n            pumperId: pumper.id,\n            pumperName: pumper.name,\n            employeeId: pumper.employeeId,\n            baseSalary: baseSalary,\n            holidayAllowance: actualHolidayAllowance,\n            restDaysTaken: restDaysTaken,\n            daysWorked: 0,\n            shiftCount: 0,\n            totalHours: 0,\n            totalOvertimeHours: 0,\n            totalOvertimeAmount: 0,\n            commission: 0,\n            totalSales: 0,\n            totalAdvances: 0,\n            totalLoans: Math.round(totalLoans * 100) / 100,\n            varianceAdd: 0,\n            varianceDeduct: 0,\n            epf: epf,\n            netSalary: Math.round(netSalary * 100) / 100,\n            shiftDetails: []\n          }]\n        })\n      }\n    }\n\n    return NextResponse.json({\n      month: month || `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`,\n      startDate: startDate.toISOString(),\n      endDate: endDate.toISOString(),\n      salaryData\n    })\n  } catch (error) {\n    console.error('Error fetching salary data:', error)\n    return NextResponse.json(\n      { error: 'Failed to fetch salary data', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    )\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\settings\\tolerance\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":36,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\n\n// Tolerance configuration - Flat Rs. 20 for any sale\nlet toleranceConfig = {\n  id: 'tolerance_1',\n  percentageTolerance: 0, // Not used - flat amount only\n  flatAmountTolerance: 20, // Rs. 20 flat tolerance for any sale\n  useMaximum: false, // Not used - flat amount only\n  description: 'Flat Rs. 20 tolerance for any sale amount',\n  updatedBy: 'System Admin',\n  updatedAt: new Date().toISOString()\n}\n\nexport async function GET() {\n  return NextResponse.json(toleranceConfig)\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    interface ToleranceBody {\n      percentageTolerance?: number\n      flatAmountTolerance?: number\n      useMaximum?: boolean\n      description?: string\n    }\n    const body = await request.json() as ToleranceBody\n\n    toleranceConfig = {\n      ...toleranceConfig,\n      ...body,\n      updatedBy: 'System User', // Note: In production, this should come from auth headers\n      updatedAt: new Date().toISOString()\n    }\n\n    return NextResponse.json(toleranceConfig)\n  } catch (error) {\n    return NextResponse.json({ error: 'Failed to update tolerance configuration' }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shift-templates\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shift-templates\\cleanup\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shift-templates\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\assign\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\assignments\\[assignId]\\close\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\assignments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\close\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\report\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\[id]\\stats\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\bulk-close\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\cleanup\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\shifts\\unprocessed\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\stations\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\stations\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\cleanup\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used.","line":4,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\n\nexport async function DELETE(request: NextRequest) {\n  try {\n    console.log(' Starting tank cleanup...')\n    \n    // Delete in order (respecting foreign keys)\n    console.log('Deleting test pours...')\n    const testPours = await prisma.testPour.deleteMany()\n    console.log(`Deleted ${testPours.count} test pours`)\n    \n    console.log('Deleting meter audits...')\n    const meterAudits = await prisma.meterAudit.deleteMany()\n    console.log(`Deleted ${meterAudits.count} meter audits`)\n    \n    console.log('Deleting shift assignments...')\n    const assignments = await prisma.shiftAssignment.deleteMany()\n    console.log(`Deleted ${assignments.count} shift assignments`)\n    \n    console.log('Deleting shifts...')\n    const shifts = await prisma.shift.deleteMany()\n    console.log(`Deleted ${shifts.count} shifts`)\n    \n    console.log('Deleting tank dips...')\n    const tankDips = await prisma.tankDip.deleteMany()\n    console.log(`Deleted ${tankDips.count} tank dips`)\n    \n    console.log('Deleting deliveries...')\n    const deliveries = await prisma.delivery.deleteMany()\n    console.log(`Deleted ${deliveries.count} deliveries`)\n    \n    console.log('Deleting nozzles...')\n    const nozzles = await prisma.nozzle.deleteMany()\n    console.log(`Deleted ${nozzles.count} nozzles`)\n    \n    console.log('Deleting pumps...')\n    const pumps = await prisma.pump.deleteMany()\n    console.log(`Deleted ${pumps.count} pumps`)\n    \n    console.log('Deleting tanks...')\n    const tanks = await prisma.tank.deleteMany()\n    console.log(`Deleted ${tanks.count} tanks`)\n    \n    return NextResponse.json({\n      message: 'All tank data deleted successfully',\n      deleted: {\n        testPours: testPours.count,\n        meterAudits: meterAudits.count,\n        shiftAssignments: assignments.count,\n        shifts: shifts.count,\n        tankDips: tankDips.count,\n        deliveries: deliveries.count,\n        nozzles: nozzles.count,\n        pumps: pumps.count,\n        tanks: tanks.count\n      }\n    })\n  } catch (error) {\n    console.error('Error during cleanup:', error)\n    return NextResponse.json(\n      { error: 'Failed to cleanup tank data', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    )\n  }\n}\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\dips\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\infrastructure\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\report\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'auditOperations' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport { auditOperations } from '@/lib/auditMiddleware'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const stationId = searchParams.get('stationId')\n    const id = searchParams.get('id')\n    const type = searchParams.get('type') // tanks, pumps, nozzles\n\n    if (id) {\n      // OPTIMIZED: Get specific tank with select\n      const tank = await prisma.tank.findUnique({\n        where: { id },\n        select: {\n          id: true,\n          tankNumber: true,\n          capacity: true,\n          currentLevel: true,\n          fuelId: true,\n          stationId: true,\n          isActive: true,\n          createdAt: true,\n          updatedAt: true,\n          station: {\n            select: {\n              id: true,\n              name: true\n            }\n          },\n          fuel: {\n            select: {\n              id: true,\n              name: true,\n              code: true\n            }\n          },\n          nozzles: {\n            select: {\n              id: true,\n              nozzleNumber: true,\n              isActive: true,\n              pumpId: true,\n              pump: {\n                select: {\n                  id: true,\n                  pumpNumber: true\n                }\n              }\n            }\n          }\n        }\n      })\n\n      if (!tank) {\n        return NextResponse.json({ error: 'Tank not found' }, { status: 404 })\n      }\n      return NextResponse.json(tank)\n    }\n\n    if (type === 'pumps') {\n      const where = stationId ? { stationId } : {}\n      // Optimized: Use select for better performance\n      const pumps = await prisma.pump.findMany({\n        where,\n        select: {\n          id: true,\n          pumpNumber: true,\n          isActive: true,\n          stationId: true,\n          createdAt: true,\n          updatedAt: true,\n          station: {\n            select: {\n              id: true,\n              name: true\n            }\n          },\n          nozzles: {\n            select: {\n              id: true,\n              nozzleNumber: true,\n              isActive: true\n            }\n          }\n        },\n        orderBy: { pumpNumber: 'asc' }\n      })\n      return NextResponse.json(pumps)\n    }\n\n    if (type === 'nozzles') {\n      const pumpId = searchParams.get('pumpId')\n\n      if (pumpId) {\n        const nozzles = await prisma.nozzle.findMany({\n          where: { pumpId },\n          include: {\n            pump: {\n              select: {\n                id: true,\n                pumpNumber: true\n              }\n            },\n            tank: {\n              select: {\n                id: true,\n                fuelId: true,\n                fuel: true\n              }\n            }\n          },\n          orderBy: { nozzleNumber: 'asc' }\n        })\n        return NextResponse.json(nozzles)\n      }\n\n      // Get nozzles by station with fuel type\n      // First get pumps for the station, then get nozzles\n      if (!stationId) {\n        return NextResponse.json({ error: 'Station ID is required' }, { status: 400 })\n      }\n\n      // Get pumps for the station first\n      const pumps = await prisma.pump.findMany({\n        where: { stationId },\n        select: { id: true }\n      })\n\n      const pumpIds = pumps.map(p => p.id)\n\n      if (pumpIds.length === 0) {\n        return NextResponse.json([])\n      }\n\n      // Get nozzles for those pumps\n      // Note: Nozzle has tankId directly, not through pump\n      const nozzles = await prisma.nozzle.findMany({\n        where: {\n          pumpId: { in: pumpIds }\n        },\n        include: {\n          pump: {\n            select: {\n              id: true,\n              pumpNumber: true,\n              stationId: true,\n              isActive: true\n            }\n          },\n          tank: {\n            select: {\n              id: true,\n              fuelId: true,\n              fuel: true,\n              capacity: true,\n              currentLevel: true\n            }\n          }\n        },\n        orderBy: { nozzleNumber: 'asc' }\n      })\n\n      return NextResponse.json(nozzles)\n    }\n\n    // Get tanks\n    interface TankWhereInput {\n      stationId?: string\n    }\n    const where: TankWhereInput = {}\n    if (stationId) {\n      where.stationId = stationId\n    }\n\n    // Filter out oil tanks for dipping operations if type is 'tanks'\n    if (type === 'tanks') {\n      // We filter out OIL tanks in code after fetching\n    }\n\n    // Optimized: Use select instead of include for better performance\n    const tanks = await prisma.tank.findMany({\n      where,\n      select: {\n        id: true,\n        tankNumber: true,\n        capacity: true,\n        currentLevel: true,\n        isActive: true,\n        createdAt: true,\n        updatedAt: true,\n        fuelId: true,\n        stationId: true,\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        },\n        fuel: {\n          select: {\n            id: true,\n            name: true,\n            code: true,\n            category: true\n          }\n        },\n        nozzles: {\n          select: {\n            id: true,\n            nozzleNumber: true,\n            isActive: true,\n            pumpId: true,\n            pump: {\n              select: {\n                id: true,\n                pumpNumber: true\n              }\n            }\n          }\n        }\n      },\n      orderBy: { tankNumber: 'asc' }\n    })\n\n    // Filter out oil tanks if type is 'tanks' (for dipping operations)\n    if (type === 'tanks') {\n      const filteredTanks = tanks.filter(tank => tank.fuel?.code !== 'OIL')\n      return NextResponse.json(filteredTanks)\n    }\n\n    return NextResponse.json(tanks)\n  } catch (error) {\n    console.error('Error fetching tanks:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n\n    const { stationId, fuelId, capacity, currentLevel } = body\n\n    // Validation\n    if (!stationId || !fuelId || !capacity) {\n      return NextResponse.json(\n        { error: 'Station ID, fuel ID, and capacity are required' },\n        { status: 400 }\n      )\n    }\n\n    if (capacity <= 0) {\n      return NextResponse.json(\n        { error: 'Capacity must be greater than 0' },\n        { status: 400 }\n      )\n    }\n\n    const initialLevel = currentLevel || 0\n\n    if (initialLevel < 0 || initialLevel > capacity) {\n      return NextResponse.json(\n        { error: 'Initial level must be between 0 and capacity' },\n        { status: 400 }\n      )\n    }\n\n    // Verify station exists and is active\n    const station = await prisma.station.findUnique({\n      where: { id: stationId }\n    })\n\n    if (!station) {\n      return NextResponse.json(\n        { error: 'Station not found' },\n        { status: 404 }\n      )\n    }\n\n    if (!station.isActive) {\n      return NextResponse.json(\n        { error: 'Cannot create tank for inactive station' },\n        { status: 400 }\n      )\n    }\n\n    // Generate unique tank number if not provided\n    let tankNumber = body.tankNumber\n    if (!tankNumber) {\n      // Find highest tank number for this station (regardless of fuel type)\n      // because tankNumber must be unique per station\n      const existingTanks = await prisma.tank.findMany({\n        where: {\n          stationId\n        },\n        select: { tankNumber: true }\n      })\n\n      if (existingTanks.length === 0) {\n        tankNumber = 'TANK-01'\n      } else {\n        // Get the highest number from existing tanks\n        const numbers = existingTanks\n          .map(t => parseInt(t.tankNumber.replace(/[^0-9]/g, '')) || 0)\n        const maxNum = Math.max(...numbers)\n        tankNumber = `TANK-${(maxNum + 1).toString().padStart(2, '0')}`\n      }\n    } else {\n      // Check if custom tank number already exists\n      const existingTank = await prisma.tank.findFirst({\n        where: {\n          stationId,\n          tankNumber\n        }\n      })\n\n      if (existingTank) {\n        return NextResponse.json(\n          { error: 'Tank number already exists at this station' },\n          { status: 400 }\n        )\n      }\n    }\n\n    // Create tank\n    const newTank = await prisma.tank.create({\n      data: {\n        stationId,\n        tankNumber,\n        fuelId,\n        capacity: parseFloat(capacity),\n        currentLevel: parseFloat(initialLevel),\n        isActive: true\n      },\n      include: {\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        },\n        fuel: true\n      }\n    })\n\n    // Note: No specific audit operation for tank creation yet\n\n    return NextResponse.json(newTank, { status: 201 })\n  } catch (error) {\n    console.error('Error creating tank:', error)\n\n    // Handle foreign key constraint violations\n    if (error instanceof Error && error.message.includes('Foreign key constraint')) {\n      return NextResponse.json(\n        { error: 'Invalid station ID' },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tanks\\update-stock\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'performedBy' is assigned a value but never used.","line":8,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/db'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    \r\n    const { tankUpdates, performedBy } = body\r\n    \r\n    if (!tankUpdates || !Array.isArray(tankUpdates) || tankUpdates.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Tank updates array is required' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Update all tanks in a transaction\r\n    const results = await prisma.$transaction(\r\n      tankUpdates.map((update: { tankId: string; newLevel: number }) => \r\n        prisma.tank.update({\r\n          where: { id: update.tankId },\r\n          data: {\r\n            currentLevel: update.newLevel\r\n          }\r\n        })\r\n      )\r\n    )\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      updatedCount: results.length,\r\n      message: `Successfully updated ${results.length} tank(s)`\r\n    }, { status: 200 })\r\n  } catch (error) {\r\n    console.error('Error updating tank stock:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to update tank stock' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tenders\\shift\\[shiftId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\tests\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tankId' is assigned a value but never used.","line":10,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/db'\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const body = await request.json()\r\n        const {\r\n            shiftId,\r\n            nozzleId,\r\n            tankId,\r\n            litres,\r\n            reason,\r\n            testTime,\r\n            testedBy,\r\n            returned,\r\n            notes\r\n        } = body\r\n\r\n        // Validation\r\n        if (!shiftId || !nozzleId || !litres || !testedBy) {\r\n            return NextResponse.json(\r\n                { error: 'Shift ID, nozzle ID, litres, and tested by are required' },\r\n                { status: 400 }\r\n            )\r\n        }\r\n\r\n        // Create the test pour entry\r\n        const testPour = await prisma.testPour.create({\r\n            data: {\r\n                shiftId,\r\n                nozzleId,\r\n                amount: parseFloat(litres),\r\n                testType: reason === 'L5' ? 'L5' : reason === 'L50' ? 'L50' : 'L100', // Basic mapping to enum\r\n                timestamp: testTime ? new Date(testTime) : new Date(),\r\n                performedBy: testedBy,\r\n                returned: returned !== undefined ? returned : true,\r\n                notes: notes || reason // Store reason in notes if it doesn't match enum exactly\r\n            }\r\n        })\r\n\r\n        return NextResponse.json(testPour, { status: 201 })\r\n    } catch (error) {\r\n        console.error('API Test Pour Error:', error)\r\n        return NextResponse.json(\r\n            { error: 'Internal Server Error' },\r\n            { status: 500 }\r\n        )\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\users\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'name' is assigned a value but never used.","line":64,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":64,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport { Prisma } from '@prisma/client'\nimport bcrypt from 'bcrypt'\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n\n    const user = await prisma.user.findUnique({\n      where: { id },\n      select: {\n        id: true,\n        username: true,\n        email: true,\n        role: true,\n        stationId: true,\n        isActive: true,\n        createdAt: true,\n        updatedAt: true,\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      }\n    })\n\n    if (!user) {\n      return NextResponse.json({ error: 'User not found' }, { status: 404 })\n    }\n\n    // Format response\n    const formattedUser = {\n      id: user.id,\n      name: user.username,\n      email: user.email,\n      role: user.role,\n      status: user.isActive ? 'active' : 'inactive',\n      stationId: user.stationId,\n      stationName: user.station?.name,\n      createdAt: user.createdAt.toISOString(),\n      updatedAt: user.updatedAt.toISOString()\n    }\n\n    return NextResponse.json(formattedUser)\n  } catch (error) {\n    console.error('Error fetching user:', error)\n    return NextResponse.json({ error: 'Failed to fetch user' }, { status: 500 })\n  }\n}\n\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n    const body = await request.json()\n    const { name, username, email, password, role, stationId, status } = body\n\n    // Check if user exists\n    const existingUser = await prisma.user.findUnique({\n      where: { id }\n    })\n\n    if (!existingUser) {\n      return NextResponse.json({ error: 'User not found' }, { status: 404 })\n    }\n\n    // Check for duplicate username or email (excluding current user)\n    if (username || email) {\n      const duplicateUser = await prisma.user.findFirst({\n        where: {\n          AND: [\n            { id: { not: id } },\n            {\n              OR: [\n                ...(username ? [{ username: username.trim() }] : []),\n                ...(email ? [{ email: email.trim() }] : [])\n              ]\n            }\n          ]\n        }\n      })\n\n      if (duplicateUser) {\n        return NextResponse.json(\n          { error: 'A user with this username or email already exists' },\n          { status: 400 }\n        )\n      }\n    }\n\n    // Build update data\n    const updateData: Prisma.UserUncheckedUpdateInput = {}\n    if (username !== undefined) updateData.username = username.trim()\n    if (email !== undefined) updateData.email = email.trim()\n    if (role !== undefined) updateData.role = role\n    if (stationId !== undefined) updateData.stationId = stationId || null\n    if (status !== undefined) updateData.isActive = status === 'active'\n\n    // Hash new password if provided\n    if (password && password.trim()) {\n      updateData.password = await bcrypt.hash(password, 10)\n    }\n\n    // Update user\n    const updatedUser = await prisma.user.update({\n      where: { id },\n      data: updateData,\n      select: {\n        id: true,\n        username: true,\n        email: true,\n        role: true,\n        stationId: true,\n        isActive: true,\n        createdAt: true,\n        updatedAt: true,\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      }\n    })\n\n    // Format response\n    const formattedUser = {\n      id: updatedUser.id,\n      name: updatedUser.username,\n      email: updatedUser.email,\n      role: updatedUser.role,\n      status: updatedUser.isActive ? 'active' : 'inactive',\n      stationId: updatedUser.stationId,\n      stationName: updatedUser.station?.name,\n      createdAt: updatedUser.createdAt.toISOString(),\n      updatedAt: updatedUser.updatedAt.toISOString()\n    }\n\n    return NextResponse.json(formattedUser)\n  } catch (error) {\n    console.error('Error updating user:', error)\n\n    if (error instanceof Error && error.message.includes('Unique constraint')) {\n      return NextResponse.json(\n        { error: 'A user with this username or email already exists' },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json({ error: 'Failed to update user' }, { status: 500 })\n  }\n}\n\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n\n    // Check if user exists\n    const user = await prisma.user.findUnique({\n      where: { id },\n      select: { role: true }\n    })\n\n    if (!user) {\n      return NextResponse.json({ error: 'User not found' }, { status: 404 })\n    }\n\n    // Prevent deletion of DEVELOPER users (only DEVELOPER can delete DEVELOPER)\n    const userRole = request.headers.get('x-user-role')\n    if (user.role === 'DEVELOPER' && userRole !== 'DEVELOPER') {\n      return NextResponse.json(\n        { error: 'Only developers can delete developer accounts' },\n        { status: 403 }\n      )\n    }\n\n    // Delete user\n    await prisma.user.delete({\n      where: { id }\n    })\n\n    return NextResponse.json({ success: true, message: 'User deleted successfully' })\n  } catch (error) {\n    console.error('Error deleting user:', error)\n\n    if (error instanceof Error && error.message.includes('Foreign key constraint')) {\n      return NextResponse.json(\n        { error: 'Cannot delete user. They may have associated audit logs or other records.' },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json({ error: 'Failed to delete user' }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\api\\users\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'name' is assigned a value but never used.","line":67,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":67,"endColumn":17}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2800,2803],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2800,2803],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/db'\nimport bcrypt from 'bcrypt'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const activeOnly = searchParams.get('active') === 'true'\n\n    const where = activeOnly ? { isActive: true } : {}\n\n    const users = await prisma.user.findMany({\n      where,\n      select: {\n        id: true,\n        username: true,\n        email: true,\n        role: true,\n        stationId: true,\n        isActive: true,\n        lastLogin: true,\n        createdAt: true,\n        updatedAt: true,\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      },\n      orderBy: { createdAt: 'desc' }\n    })\n\n    // Map to frontend format\n    const formattedUsers = users.map(user => ({\n      id: user.id,\n      name: user.username,\n      email: user.email,\n      role: user.role,\n      status: user.isActive ? 'active' : 'inactive',\n      lastLogin: user.lastLogin ? user.lastLogin.toISOString() : null,\n      stationId: user.stationId,\n      stationName: user.station?.name,\n      createdAt: user.createdAt.toISOString(),\n      updatedAt: user.updatedAt.toISOString()\n    }))\n\n    return NextResponse.json(formattedUsers)\n  } catch (error) {\n    console.error('Error fetching users:', error)\n    return NextResponse.json({ error: 'Failed to fetch users' }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    interface UserBody {\n      name?: string\n      username?: string\n      email?: string\n      password?: string\n      role?: string\n      stationId?: string\n      status?: string\n    }\n    const body = await request.json() as UserBody\n    const { name, username, email, password, role, stationId, status } = body\n\n    // Validation\n    if (!username || !email || !password || !role) {\n      return NextResponse.json(\n        { error: 'Username, email, password, and role are required' },\n        { status: 400 }\n      )\n    }\n\n    // Check for duplicate username or email\n    const existingUser = await prisma.user.findFirst({\n      where: {\n        OR: [\n          { username: username.trim() },\n          { email: email.trim() }\n        ]\n      }\n    })\n\n    if (existingUser) {\n      return NextResponse.json(\n        { error: 'A user with this username or email already exists' },\n        { status: 400 }\n      )\n    }\n\n    // Hash password\n    const hashedPassword = await bcrypt.hash(password, 10)\n\n    // Create user\n    const newUser = await prisma.user.create({\n      data: {\n        username: username.trim(),\n        email: email.trim(),\n        password: hashedPassword,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        role: (role as any) || 'MANAGER',\n        stationId: stationId || null,\n        isActive: status === 'active' || status === undefined ? true : false\n      },\n      select: {\n        id: true,\n        username: true,\n        email: true,\n        role: true,\n        stationId: true,\n        isActive: true,\n        createdAt: true,\n        updatedAt: true,\n        station: {\n          select: {\n            id: true,\n            name: true\n          }\n        }\n      }\n    })\n\n    // Format response\n    const formattedUser = {\n      id: newUser.id,\n      name: newUser.username,\n      email: newUser.email,\n      role: newUser.role,\n      status: newUser.isActive ? 'active' : 'inactive',\n      lastLogin: null,\n      stationId: newUser.stationId,\n      stationName: newUser.station?.name,\n      createdAt: newUser.createdAt.toISOString(),\n      updatedAt: newUser.updatedAt.toISOString()\n    }\n\n    // Create audit log for user creation\n    try {\n      await prisma.auditLog.create({\n        data: {\n          userId: 'system', // TODO: Extract from JWT token\n          userName: 'System User', // TODO: Extract from JWT token  \n          userRole: 'OWNER', // TODO: Extract from JWT token\n          action: 'CREATE',\n          entity: 'User',\n          entityId: newUser.id,\n          details: `Created user: ${newUser.username} with role ${newUser.role}`,\n          stationId: newUser.stationId || undefined\n        }\n      })\n    } catch (auditError) {\n      console.error('Failed to create audit log:', auditError)\n    }\n\n    return NextResponse.json(formattedUser, { status: 201 })\n  } catch (error) {\n    console.error('Error creating user:', error)\n\n    if (error instanceof Error && error.message.includes('Unique constraint')) {\n      return NextResponse.json(\n        { error: 'A user with this username or email already exists' },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json({ error: 'Failed to create user' }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\BankSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BankAccount' is defined but never used.","line":31,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog'\nimport { Plus, Building2, CreditCard } from 'lucide-react'\n\ninterface Bank {\n  id: string\n  name: string\n  branch?: string | null\n  accountNumber?: string | null\n  isActive: boolean\n}\n\ninterface BankAccount {\n  id: string\n  bankId: string\n  accountNumber: string\n  accountName: string\n  isActive: boolean\n}\n\ninterface BankSelectorProps {\n  selectedBankId?: string\n  selectedAccountId?: string\n  onBankChange?: (bankId: string) => void\n  onAccountChange?: (accountId: string) => void\n  showAddButton?: boolean\n  className?: string\n}\n\nexport function BankSelector({\n  selectedBankId,\n  selectedAccountId,\n  onBankChange,\n  onAccountChange,\n  showAddButton = true,\n  className\n}: BankSelectorProps) {\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false)\n  const [newBank, setNewBank] = useState({ name: '', branch: '', accountNumber: '' })\n  const [banks, setBanks] = useState<Bank[]>([])\n  const [loading, setLoading] = useState(true)\n\n  // Fetch banks from API\n  useEffect(() => {\n    const fetchBanks = async () => {\n      try {\n        const response = await fetch('/api/banks?active=true')\n        if (response.ok) {\n          const data = await response.json()\n          setBanks(data)\n        }\n      } catch (error) {\n        console.error('Error fetching banks:', error)\n      } finally {\n        setLoading(false)\n      }\n    }\n    fetchBanks()\n  }, [])\n\n  const selectedBank = banks.find(bank => bank.id === selectedBankId)\n  // Note: Bank accounts are not yet implemented in the API\n  // This component uses bank.accountNumber as a placeholder\n  const selectedAccount = selectedBank?.accountNumber ? {\n    id: selectedBank.id,\n    bankId: selectedBank.id,\n    accountNumber: selectedBank.accountNumber,\n    accountName: `${selectedBank.name} Account`,\n    isActive: true\n  } : undefined\n\n  const handleAddBank = async () => {\n    if (newBank.name) {\n      try {\n        const response = await fetch('/api/banks', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            name: newBank.name,\n            branch: newBank.branch || null,\n            accountNumber: newBank.accountNumber || null\n          })\n        })\n        if (response.ok) {\n          const newBankData = await response.json()\n          setBanks([...banks, newBankData])\n          setNewBank({ name: '', branch: '', accountNumber: '' })\n          setIsAddDialogOpen(false)\n          if (onBankChange) {\n            onBankChange(newBankData.id)\n          }\n        } else {\n          alert('Failed to add bank. Please try again.')\n        }\n      } catch (error) {\n        console.error('Error adding bank:', error)\n        alert('Error adding bank. Please try again.')\n      }\n    }\n  }\n\n  return (\n    <div className={`space-y-4 ${className}`}>\n      {/* Bank Selection */}\n      <div className=\"space-y-2\">\n        <label className=\"text-sm font-medium text-foreground\">Bank</label>\n        <div className=\"flex gap-2\">\n          <Select value={selectedBankId} onValueChange={onBankChange}>\n            <SelectTrigger className=\"flex-1\">\n              <SelectValue placeholder=\"Select a bank\">\n                {selectedBank && (\n                  <div className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4\" />\n                    <span>{selectedBank.name}</span>\n\n                  </div>\n                )}\n              </SelectValue>\n            </SelectTrigger>\n            <SelectContent>\n              {loading ? (\n                <SelectItem value=\"loading\" disabled>Loading banks...</SelectItem>\n              ) : banks.length === 0 ? (\n                <SelectItem value=\"none\" disabled>No banks available</SelectItem>\n              ) : (\n                banks.map((bank) => (\n                  <SelectItem key={bank.id} value={bank.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-4 w-4\" />\n                      <span>{bank.name}</span>\n                      {bank.branch && (\n                        <span className=\"text-xs text-muted-foreground\">\n                          ({bank.branch})\n                        </span>\n                      )}\n                    </div>\n                  </SelectItem>\n                ))\n              )}\n            </SelectContent>\n          </Select>\n\n          {showAddButton && (\n            <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\">\n                  <Plus className=\"h-4 w-4\" />\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Add New Bank</DialogTitle>\n                  <DialogDescription>\n                    Add a new bank to the system for POS and deposit tracking.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div>\n                    <label className=\"text-sm font-medium\">Bank Name</label>\n                    <Input\n                      value={newBank.name}\n                      onChange={(e) => setNewBank(prev => ({ ...prev, name: e.target.value }))}\n                      placeholder=\"Enter bank name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Branch (Optional)</label>\n                    <Input\n                      value={newBank.branch}\n                      onChange={(e) => setNewBank(prev => ({ ...prev, branch: e.target.value }))}\n                      placeholder=\"Enter branch name\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Account Number (Optional)</label>\n                    <Input\n                      value={newBank.accountNumber}\n                      onChange={(e) => setNewBank(prev => ({ ...prev, accountNumber: e.target.value }))}\n                      placeholder=\"Enter account number\"\n                    />\n                  </div>\n                  <Button onClick={handleAddBank} className=\"w-full\">\n                    Add Bank\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          )}\n        </div>\n      </div>\n\n      {/* Account Selection */}\n      {selectedBankId && (\n        <div className=\"space-y-2\">\n          <label className=\"text-sm font-medium text-foreground\">Account</label>\n          <Select value={selectedAccountId} onValueChange={onAccountChange}>\n            <SelectTrigger>\n              <SelectValue placeholder=\"Select an account\">\n                {selectedAccount && (\n                  <div className=\"flex items-center gap-2\">\n                    <CreditCard className=\"h-4 w-4\" />\n                    <span>{selectedAccount.accountName}</span>\n                    <span className=\"text-sm text-muted-foreground\">\n                      {selectedAccount.accountNumber}\n                    </span>\n                  </div>\n                )}\n              </SelectValue>\n            </SelectTrigger>\n            <SelectContent>\n              {selectedBank?.accountNumber ? (\n                <SelectItem value={selectedBank.id}>\n                  <div className=\"flex items-center gap-2\">\n                    <CreditCard className=\"h-4 w-4\" />\n                    <span>{selectedBank.accountNumber}</span>\n                    {selectedBank.branch && (\n                      <span className=\"text-sm text-muted-foreground\">\n                        ({selectedBank.branch})\n                      </span>\n                    )}\n                  </div>\n                </SelectItem>\n              ) : (\n                <SelectItem value=\"none\" disabled>No account available for this bank</SelectItem>\n              )}\n            </SelectContent>\n          </Select>\n        </div>\n      )}\n\n      {/* Selected Bank & Account Info */}\n      {selectedBank && (\n        <div className=\"p-3 bg-muted rounded-lg\">\n          <div className=\"text-sm\">\n            <div className=\"font-medium text-foreground\">\n              {selectedBank.name}\n              {selectedBank.branch && ` - ${selectedBank.branch}`}\n            </div>\n            {selectedBank.accountNumber && (\n              <div className=\"text-muted-foreground\">\n                Account: {selectedBank.accountNumber}\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\FileUploadStub.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ThemeWrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\admin\\TempPasswordModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\auth\\IdleWarningModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\inputs\\DateTimePicker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\inputs\\MoneyInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\inputs\\NumberInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\layout\\Sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Search' is defined but never used.","line":9,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TestTube' is defined but never used.","line":10,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used.","line":13,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileText' is defined but never used.","line":18,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport Link from 'next/link'\nimport { usePathname } from 'next/navigation'\nimport { cn } from '@/lib/utils'\nimport {\n  LayoutDashboard,\n  Clock,\n  Search,\n  TestTube,\n  Fuel,\n  CreditCard,\n  Users,\n  Shield,\n  BarChart3,\n  Settings,\n  Building2,\n  FileText,\n  Bell,\n  User,\n  Wallet,\n  DollarSign,\n  Handshake,\n  Landmark\n} from 'lucide-react'\n\ntype UserRole = 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS'\n\ninterface SidebarProps {\n  userRole: UserRole\n}\n\ninterface NavItem {\n  title: string\n  href: string\n  icon: React.ComponentType<{ className?: string }>\n  roles: UserRole[]\n}\n\nconst navigation: NavItem[] = [\n  {\n    title: 'Dashboard',\n    href: '/',\n    icon: LayoutDashboard,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  {\n    title: 'Shifts',\n    href: '/shifts',\n    icon: Clock,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER']\n  },\n  // {\n  //   title: 'Audits',\n  //   href: '/audits',\n  //   icon: Search,\n  //   roles: ['DEVELOPER', 'OWNER', 'MANAGER']\n  // },\n  // {\n  //   title: 'Tests',\n  //   href: '/tests',\n  //   icon: TestTube,\n  //   roles: ['DEVELOPER', 'OWNER', 'MANAGER']\n  // },\n  {\n    title: 'Tanks',\n    href: '/tanks',\n    icon: Fuel,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER']\n  },\n  {\n    title: 'Safe',\n    href: '/safe',\n    icon: Wallet,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  {\n    title: 'Salary',\n    href: '/salary',\n    icon: DollarSign,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  {\n    title: 'Loans',\n    href: '/loans',\n    icon: Handshake,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  {\n    title: 'Bank Accounts',\n    href: '/banks',\n    icon: Landmark,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  {\n    title: 'Credit Customers',\n    href: '/credit/customers',\n    icon: CreditCard,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  {\n    title: 'Reports',\n    href: '/reports',\n    icon: BarChart3,\n    roles: ['DEVELOPER', 'OWNER', 'ACCOUNTS']\n  },\n  {\n    title: 'Notifications',\n    href: '/notifications',\n    icon: Bell,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  },\n  // {\n  //   title: 'Audit Log',\n  //   href: '/audit-log',\n  //   icon: FileText,\n  //   roles: ['DEVELOPER', 'OWNER']\n  // },\n  {\n    title: 'Settings',\n    href: '/settings',\n    icon: Settings,\n    roles: ['DEVELOPER', 'OWNER']\n  },\n  {\n    title: 'Profile',\n    href: '/settings/profile',\n    icon: User,\n    roles: ['DEVELOPER', 'OWNER', 'MANAGER', 'ACCOUNTS']\n  }\n]\n\nexport function Sidebar({ userRole }: SidebarProps) {\n  const pathname = usePathname()\n\n  const filteredNavigation = navigation.filter(item =>\n    item.roles.includes(userRole)\n  )\n\n  return (\n    <div className=\"w-64 bg-sidebar border-r border-border h-screen flex flex-col\">\n      {/* Header */}\n      <div className=\"p-6 flex-shrink-0\">\n        <div className=\"flex items-center gap-2\">\n          <Building2 className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\n          <div>\n            <h1 className=\"text-xl font-bold text-sidebar-foreground\">Fuel Station</h1>\n            <p className=\"text-sm text-muted-foreground\">Management System</p>\n          </div>\n        </div>\n      </div>\n\n      {/* Navigation - takes remaining space */}\n      <nav className=\"px-4 flex-1 overflow-y-auto\">\n        <div className=\"space-y-1\">\n          {filteredNavigation.map((item) => {\n            const isActive = pathname === item.href\n            const Icon = item.icon\n\n            return (\n              <Link\n                key={item.href}\n                href={item.href}\n                className={cn(\n                  'flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors',\n                  isActive\n                    ? 'bg-primary/10 text-primary border border-primary/20'\n                    : 'text-sidebar-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground'\n                )}\n              >\n                <Icon className=\"h-5 w-5\" />\n                {item.title}\n              </Link>\n            )\n          })}\n        </div>\n      </nav>\n\n      {/* Role Display - fixed at bottom */}\n      <div className=\"p-4 flex-shrink-0\">\n        <div className=\"bg-sidebar-accent rounded-lg p-3 border border-sidebar-border\">\n          <div className=\"text-xs text-muted-foreground mb-1\">Current Role</div>\n          <div className=\"text-sm font-medium text-sidebar-foreground capitalize\">\n            {userRole.toLowerCase()}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\layout\\TopBar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Fuel' is defined but never used.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CreditCard' is defined but never used.","line":23,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingDown' is defined but never used.","line":25,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadNotifications'. Either include it or remove the dependency array.","line":195,"column":6,"nodeType":"ArrayExpression","endLine":195,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [loadNotifications, selectedStation]","fix":{"range":[6430,6447],"text":"[loadNotifications, selectedStation]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadNotifications'. Either include it or remove the dependency array.","line":210,"column":6,"nodeType":"ArrayExpression","endLine":210,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadNotifications]","fix":{"range":[6945,6947],"text":"[loadNotifications]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { Button } from '@/components/ui/button'\nimport { useStation } from '@/contexts/StationContext'\nimport { useTheme } from '@/contexts/ThemeContext'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator\n} from '@/components/ui/dropdown-menu'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  Bell,\n  LogOut,\n  ChevronDown,\n  Building2,\n  AlertTriangle,\n  Fuel,\n  CreditCard,\n  Clock,\n  TrendingDown,\n  Sun,\n  Moon,\n  Monitor,\n  RefreshCw\n} from 'lucide-react'\n\ntype UserRole = 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS'\n\ninterface TopBarProps {\n  userRole: UserRole\n}\n\ninterface Notification {\n  id: string\n  title: string\n  message: string\n  type: 'WARNING' | 'ERROR' | 'INFO' | 'SUCCESS' | 'warning' | 'error' | 'info' | 'success'\n  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL' | 'low' | 'medium' | 'high' | 'critical'\n  timestamp: string\n  createdAt: string\n  read: boolean\n  isRead: boolean\n  actionUrl?: string | null\n}\n\nconst roleColors = {\n  DEVELOPER: 'bg-red-500/20 text-red-600 dark:bg-red-600/30 dark:text-red-300',\n  OWNER: 'bg-purple-500/20 text-purple-600 dark:bg-purple-600/30 dark:text-purple-300',\n  MANAGER: 'bg-blue-500/20 text-blue-600 dark:bg-blue-600/30 dark:text-blue-300',\n  ACCOUNTS: 'bg-green-500/20 text-green-600 dark:bg-green-600/30 dark:text-green-300'\n}\n\nexport function TopBar({ userRole }: TopBarProps) {\n  const [notifications, setNotifications] = useState<Notification[]>([])\n  const [totalUnreadCount, setTotalUnreadCount] = useState(0)\n  const [isLoadingNotifications, setIsLoadingNotifications] = useState(true)\n  const { selectedStation, stations, setSelectedStation, getSelectedStation } = useStation()\n  const { theme, setTheme } = useTheme()\n  const router = useRouter()\n\n  // Load notifications from API\n  const loadNotifications = async () => {\n    try {\n      setIsLoadingNotifications(true)\n      const params = new URLSearchParams()\n      if (selectedStation && selectedStation !== 'all') {\n        params.append('stationId', selectedStation)\n      }\n      params.append('limit', '10') // Get top 10 unread for dropdown\n      params.append('isRead', 'false') // Only unread notifications\n\n      // Create abort controller for timeout\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 5000) // 5 second timeout\n\n      const response = await fetch(`/api/notifications?${params.toString()}`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        signal: controller.signal,\n      }).catch((fetchError) => {\n        // Handle network errors and aborted requests\n        clearTimeout(timeoutId)\n        if (fetchError instanceof Error && fetchError.name === 'AbortError') {\n          console.warn('Notifications request timed out')\n        } else {\n          console.warn('Network error loading notifications:', fetchError)\n        }\n        setNotifications([])\n        return null\n      })\n\n      clearTimeout(timeoutId)\n\n      // If fetch failed, response will be null\n      if (!response) {\n        setNotifications([])\n        return\n      }\n\n      if (!response.ok) {\n        // If API fails, just show empty notifications\n        console.warn(`Notifications API returned ${response.status}: ${response.statusText}`)\n        setNotifications([])\n        return\n      }\n\n      const data = await response.json().catch((jsonError) => {\n        console.warn('Failed to parse notifications response:', jsonError)\n        setNotifications([])\n        return null\n      })\n\n      if (!data) {\n        setNotifications([])\n        return\n      }\n\n      // Handle migration required case\n      if (data.migrationRequired || data.error) {\n        console.warn('Notifications API error:', data.error || data.details)\n        setNotifications([])\n        return\n      }\n\n      if (data.notifications && Array.isArray(data.notifications)) {\n        interface ApiNotification {\n          id: string\n          title?: string\n          message?: string\n          type?: string\n          priority?: string\n          timestamp?: string\n          createdAt?: string\n          read?: boolean\n          isRead?: boolean\n          actionUrl?: string | null\n        }\n\n        // Map API format to TopBar format\n        const mappedNotifications = (data.notifications as ApiNotification[]).map((n) => ({\n          id: n.id,\n          title: n.title || 'Notification',\n          message: n.message || '',\n          type: (n.type || 'info').toLowerCase() as Notification['type'], // Convert to lowercase for compatibility\n          priority: (n.priority || 'medium').toLowerCase() as Notification['priority'], // Convert to lowercase for compatibility\n          timestamp: n.createdAt || n.timestamp || new Date().toISOString(),\n          createdAt: n.createdAt || n.timestamp || new Date().toISOString(),\n          read: n.isRead || n.read || false,\n          isRead: n.isRead || n.read || false,\n          actionUrl: n.actionUrl || null\n        }))\n\n        // Filter to only show unread notifications in the dropdown\n        const unreadOnly = mappedNotifications.filter((n) => !n.read && !n.isRead)\n        setNotifications(unreadOnly)\n\n        // Use the total unread count from pagination, not just the count of fetched notifications\n        if (data.pagination && typeof data.pagination.unread === 'number') {\n          setTotalUnreadCount(data.pagination.unread)\n        } else {\n          setTotalUnreadCount(unreadOnly.length)\n        }\n      } else {\n        setNotifications([])\n        setTotalUnreadCount(0)\n      }\n      setIsLoadingNotifications(false)\n    } catch (error) {\n      // Handle any other errors\n      if (error instanceof Error && error.name === 'AbortError') {\n        console.warn('Notifications request timed out')\n      } else {\n        console.error('Failed to load notifications:', error)\n      }\n      setNotifications([])\n      setTotalUnreadCount(0)\n      setIsLoadingNotifications(false)\n    }\n  }\n\n  // Load notifications on mount and when station changes\n  useEffect(() => {\n    loadNotifications()\n\n    // Auto-refresh every 30 seconds (for real-time updates)\n    const interval = setInterval(loadNotifications, 30 * 1000)\n    return () => clearInterval(interval)\n  }, [selectedStation])\n\n  // Listen for notification updates from other pages\n  useEffect(() => {\n    const handleNotificationUpdate = () => {\n      loadNotifications()\n    }\n\n    window.addEventListener('notificationRead', handleNotificationUpdate)\n    window.addEventListener('notificationUpdated', handleNotificationUpdate)\n\n    return () => {\n      window.removeEventListener('notificationRead', handleNotificationUpdate)\n      window.removeEventListener('notificationUpdated', handleNotificationUpdate)\n    }\n  }, [])\n\n  // Use the total unread count from API, not the count of loaded notifications\n  const unreadCount = totalUnreadCount\n\n  const handleLogout = () => {\n    localStorage.removeItem('userRole')\n    router.push('/login')\n  }\n\n  const getSelectedStationName = () => {\n    if (selectedStation === 'all') return 'All Stations'\n    const station = getSelectedStation()\n    return station ? `${station.name} / ${station.city}` : 'All Stations'\n  }\n\n  const handleNotificationClick = async (notification: Notification) => {\n    // Mark as read via API\n    if (!notification.read && !notification.isRead) {\n      try {\n        await fetch(`/api/notifications/${notification.id}`, {\n          method: 'PATCH',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ isRead: true })\n        })\n        // Update local state\n        setNotifications(prev =>\n          prev.map(n => n.id === notification.id ? { ...n, read: true, isRead: true } : n)\n        )\n        // Decrease unread count\n        setTotalUnreadCount(prev => Math.max(0, prev - 1))\n      } catch (error) {\n        console.error('Failed to mark notification as read:', error)\n      }\n    }\n\n    // Navigate to action URL if provided\n    if (notification.actionUrl) {\n      router.push(notification.actionUrl)\n    } else {\n      // If no action URL, navigate to notifications page\n      router.push('/notifications')\n    }\n  }\n\n  const getNotificationIcon = (type: string) => {\n    const normalizedType = type.toUpperCase()\n    switch (normalizedType) {\n      case 'WARNING': return <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\n      case 'ERROR': return <AlertTriangle className=\"h-4 w-4 text-red-600\" />\n      case 'INFO': return <Clock className=\"h-4 w-4 text-blue-600\" />\n      case 'SUCCESS': return <Clock className=\"h-4 w-4 text-green-600\" />\n      default: return <Bell className=\"h-4 w-4 text-muted-foreground\" />\n    }\n  }\n\n  const getNotificationBadgeColor = (type: string) => {\n    const normalizedType = type.toUpperCase()\n    switch (normalizedType) {\n      case 'WARNING': return 'bg-yellow-500/20 text-yellow-600 dark:bg-yellow-600/30 dark:text-yellow-300'\n      case 'ERROR': return 'bg-red-500/20 text-red-600 dark:bg-red-600/30 dark:text-red-300'\n      case 'INFO': return 'bg-blue-500/20 text-blue-600 dark:bg-blue-600/30 dark:text-blue-300'\n      case 'SUCCESS': return 'bg-green-500/20 text-green-600 dark:bg-green-600/30 dark:text-green-300'\n      default: return 'bg-muted text-foreground'\n    }\n  }\n\n  const formatTimeAgo = (timestamp: string) => {\n    if (!timestamp) return 'Just now'\n    const now = new Date()\n    const time = new Date(timestamp)\n    const diffInMinutes = Math.floor((now.getTime() - time.getTime()) / (1000 * 60))\n\n    if (diffInMinutes < 1) {\n      return 'Just now'\n    } else if (diffInMinutes < 60) {\n      return `${diffInMinutes}m ago`\n    } else if (diffInMinutes < 1440) {\n      return `${Math.floor(diffInMinutes / 60)}h ago`\n    } else {\n      return `${Math.floor(diffInMinutes / 1440)}d ago`\n    }\n  }\n\n  return (\n    <header className=\"bg-card border-b border-border px-6 py-4\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <h2 className=\"text-2xl font-semibold text-foreground\">\n            Dashboard\n          </h2>\n          <Badge className={roleColors[userRole]}>\n            {userRole}\n          </Badge>\n        </div>\n\n        <div className=\"flex items-center gap-4\">\n          {/* Notifications */}\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"relative\">\n                <Bell className=\"h-5 w-5\" />\n                {!isLoadingNotifications && unreadCount > 0 && (\n                  <span className=\"absolute -top-1 -right-1 min-w-[20px] h-5 px-1.5 bg-red-500/90 text-white text-xs font-bold rounded-full flex items-center justify-center shadow-sm\">\n                    {unreadCount}\n                  </span>\n                )}\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-80\">\n              <div className=\"px-4 py-3 border-b\">\n                <h3 className=\"font-semibold text-base\">Unread Notifications</h3>\n                <p className=\"text-sm text-muted-foreground\">{unreadCount} unread</p>\n              </div>\n\n              {isLoadingNotifications ? (\n                <div className=\"px-4 py-6 text-center text-base text-muted-foreground\">\n                  <RefreshCw className=\"h-5 w-5 animate-spin mx-auto mb-2\" />\n                  Loading...\n                </div>\n              ) : notifications.length === 0 ? (\n                <div className=\"px-4 py-6 text-center text-base text-muted-foreground\">\n                  No unread notifications\n                </div>\n              ) : (\n                <div className=\"max-h-96 overflow-y-auto\">\n                  {notifications.map((notification) => (\n                    <DropdownMenuItem\n                      key={notification.id}\n                      className={`px-4 py-4 cursor-pointer hover:bg-muted ${!notification.read && !notification.isRead ? 'bg-blue-500/10 dark:bg-blue-500/20' : ''\n                        }`}\n                      onClick={() => handleNotificationClick(notification)}\n                    >\n                      <div className=\"flex items-start gap-3 w-full\">\n                        <div className=\"flex-shrink-0 mt-1\">\n                          {getNotificationIcon(notification.type)}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center justify-between mb-1.5\">\n                            <p className=\"text-base font-semibold text-foreground truncate\">\n                              {notification.title}\n                            </p>\n                            <Badge className={`text-xs font-medium ${getNotificationBadgeColor(notification.type)}`}>\n                              {notification.priority}\n                            </Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-1.5 line-clamp-2 leading-relaxed\">\n                            {notification.message}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground font-medium\">\n                            {formatTimeAgo(notification.timestamp || notification.createdAt)}\n                          </p>\n                        </div>\n                        {!notification.read && !notification.isRead && (\n                          <div className=\"w-2.5 h-2.5 bg-blue-500 rounded-full flex-shrink-0 mt-2\"></div>\n                        )}\n                      </div>\n                    </DropdownMenuItem>\n                  ))}\n                </div>\n              )}\n\n              {notifications.length > 0 && (\n                <>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem\n                    className=\"text-center text-base font-semibold text-blue-600 hover:text-blue-800 cursor-pointer py-3\"\n                    onClick={() => router.push('/notifications')}\n                  >\n                    View all notifications\n                  </DropdownMenuItem>\n                </>\n              )}\n            </DropdownMenuContent>\n          </DropdownMenu>\n\n          {/* Station Selector */}\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                <Building2 className=\"h-4 w-4\" />\n                {getSelectedStationName()}\n                <ChevronDown className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem\n                onClick={() => setSelectedStation('all')}\n                className={selectedStation === 'all' ? 'bg-blue-500/10 dark:bg-blue-500/20' : ''}\n              >\n                All Stations\n              </DropdownMenuItem>\n              <DropdownMenuSeparator />\n              {stations.map((station) => (\n                <DropdownMenuItem\n                  key={station.id}\n                  onClick={() => setSelectedStation(station.id)}\n                  className={selectedStation === station.id ? 'bg-blue-500/10 dark:bg-blue-500/20' : ''}\n                >\n                  {station.name} / {station.city}\n                </DropdownMenuItem>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n\n          {/* Theme Toggle */}\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"relative\">\n                <Sun className=\"h-4 w-4 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n                <Moon className=\"h-4 w-4 absolute rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n                <span className=\"sr-only\">Toggle theme</span>\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuItem onClick={() => setTheme('light')} className={theme === 'light' ? 'bg-blue-500/10 dark:bg-blue-500/20' : ''}>\n                <Sun className=\"mr-2 h-4 w-4\" />\n                Light\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={() => setTheme('dark')} className={theme === 'dark' ? 'bg-blue-500/10 dark:bg-blue-500/20' : ''}>\n                <Moon className=\"mr-2 h-4 w-4\" />\n                Dark\n              </DropdownMenuItem>\n              <DropdownMenuItem onClick={() => setTheme('system')} className={theme === 'system' ? 'bg-blue-500/10 dark:bg-blue-500/20' : ''}>\n                <Monitor className=\"mr-2 h-4 w-4\" />\n                System\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n\n          {/* Logout Button */}\n          <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\" onClick={handleLogout}>\n            <LogOut className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Logout</span>\n          </Button>\n        </div>\n      </div>\n    </header>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\DataTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\FormCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\toast-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\components\\ui\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\contexts\\StationContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\contexts\\ThemeContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\hooks\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\hooks\\useIdleTimer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\audit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\auditLogger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\auditMiddleware.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userCheckError' is defined but never used.","line":47,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest } from 'next/server'\nimport { prisma } from '@/lib/db'\n\nexport interface AuditContext {\n  userId: string\n  userName: string\n  userRole: 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS'\n  action: 'CREATE' | 'UPDATE' | 'DELETE' | 'VIEW'\n  entity: string\n  entityId?: string\n  details: string\n  stationId?: string\n  stationName?: string\n}\n\n/**\n * Server-side audit logging utility\n * This should be called from API routes to log user actions\n */\nexport async function auditLog(context: AuditContext, request: NextRequest): Promise<void> {\n  try {\n    // Get client IP\n    const forwarded = request.headers.get('x-forwarded-for')\n    const ip = forwarded ? forwarded.split(',')[0] : 'unknown' // request.ip might not be available in types\n\n    // Get user info from context or headers\n    const userIdHeader = request.headers.get('x-user-id') || context.userId\n    const userNameHeader = request.headers.get('x-user-name') || context.userName\n    const userRoleHeader = request.headers.get('x-user-role') || context.userRole\n\n    // Verify user exists in database\n    let validUserId = userIdHeader\n    try {\n      const user = await prisma.user.findUnique({\n        where: { id: userIdHeader }\n      })\n\n      if (!user) {\n        // Try to find by username\n        const userByUsername = await prisma.user.findFirst({\n          where: { username: userNameHeader }\n        })\n        if (userByUsername) {\n          validUserId = userByUsername.id\n        }\n      }\n    } catch (userCheckError) {\n      // Continue with original userId - Prisma will handle FK constraint\n    }\n\n    // Create audit log entry using Prisma\n    await prisma.auditLog.create({\n      data: {\n        userId: validUserId,\n        userName: userNameHeader,\n        userRole: userRoleHeader as 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS',\n        action: context.action,\n        entity: context.entity,\n        entityId: context.entityId || null,\n        details: context.details,\n        ipAddress: ip || null,\n        stationId: context.stationId || null,\n        stationName: context.stationName || null,\n        timestamp: new Date()\n      }\n    })\n  } catch (error) {\n    console.error('Failed to log audit entry:', error)\n    // Don't throw - audit logging should not break the main flow\n  }\n}\n\n/**\n * Helper function to extract user context from request headers\n * In a real app, this would decode JWT tokens\n */\nexport function getUserContext(request: NextRequest): { userId: string; userName: string; userRole: 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS' } {\n  // Mock user context - in real app, extract from JWT\n  return {\n    userId: request.headers.get('x-user-id') || 'user-1',\n    userName: request.headers.get('x-user-name') || 'System User',\n    userRole: (request.headers.get('x-user-role') as 'DEVELOPER' | 'OWNER' | 'MANAGER' | 'ACCOUNTS') || 'MANAGER'\n  }\n}\n\n/**\n * Audit logging decorators for common operations\n */\nexport const auditOperations = {\n  // Station operations\n  stationCreated: (request: NextRequest, stationId: string, stationName: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Station',\n      entityId: stationId,\n      details: `Created station: ${stationName}`,\n      stationId,\n      stationName\n    }, request),\n\n  stationUpdated: (request: NextRequest, stationId: string, stationName: string, changes: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'UPDATE',\n      entity: 'Station',\n      entityId: stationId,\n      details: `Updated station: ${stationName}. Changes: ${changes}`,\n      stationId,\n      stationName\n    }, request),\n\n  stationDeleted: (request: NextRequest, stationId: string, stationName: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'DELETE',\n      entity: 'Station',\n      entityId: stationId,\n      details: `Deleted station: ${stationName}`,\n      stationId,\n      stationName\n    }, request),\n\n  // Shift operations\n  shiftOpened: (request: NextRequest, shiftId: string, stationId: string, stationName: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Shift',\n      entityId: shiftId,\n      details: `Opened shift at ${stationName}`,\n      stationId,\n      stationName\n    }, request),\n\n  shiftClosed: (request: NextRequest, shiftId: string, stationId: string, stationName: string, totalSales: number) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'UPDATE',\n      entity: 'Shift',\n      entityId: shiftId,\n      details: `Closed shift at ${stationName}. Total sales: Rs. ${totalSales.toLocaleString()}`,\n      stationId,\n      stationName\n    }, request),\n\n  // Price operations\n  priceUpdated: (request: NextRequest, priceId: string, fuelName: string, newPrice: number, stationId?: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'UPDATE',\n      entity: 'Price',\n      entityId: priceId,\n      details: `Updated ${fuelName} price to Rs. ${newPrice.toFixed(2)}`,\n      stationId\n    }, request),\n\n  // Tank operations\n  tankDipRecorded: (request: NextRequest, tankId: string, dipLitres: number, stationId: string, stationName: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Tank Dip',\n      entityId: tankId,\n      details: `Recorded tank dip: ${dipLitres}L`,\n      stationId,\n      stationName\n    }, request),\n\n  deliveryRecorded: (request: NextRequest, deliveryId: string, tankId: string, quantity: number, stationId: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Delivery',\n      entityId: deliveryId,\n      details: `Recorded fuel delivery: ${quantity}L to tank ${tankId}`,\n      stationId\n    }, request),\n\n  // Credit operations\n  creditCustomerCreated: (request: NextRequest, customerId: string, customerName: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Credit Customer',\n      entityId: customerId,\n      details: `Created credit customer: ${customerName}`\n    }, request),\n\n  creditSaleRecorded: (request: NextRequest, saleId: string, customerId: string, amount: number, stationId: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Credit Sale',\n      entityId: saleId,\n      details: `Recorded credit sale: Rs. ${amount.toLocaleString()} for customer ${customerId}`,\n      stationId\n    }, request),\n\n  // Financial operations\n  expenseRecorded: (request: NextRequest, expenseId: string, amount: number, category: string, stationId: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Expense',\n      entityId: expenseId,\n      details: `Recorded expense: Rs. ${amount.toLocaleString()} for ${category}`,\n      stationId\n    }, request),\n\n  depositRecorded: (request: NextRequest, depositId: string, amount: number, bankAccount: string, stationId: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'Deposit',\n      entityId: depositId,\n      details: `Recorded bank deposit: Rs. ${amount.toLocaleString()} to ${bankAccount}`,\n      stationId\n    }, request),\n\n  // User operations\n  userCreated: (request: NextRequest, userId: string, userName: string, userRole: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'CREATE',\n      entity: 'User',\n      entityId: userId,\n      details: `Created user: ${userName} with role ${userRole}`\n    }, request),\n\n  userUpdated: (request: NextRequest, userId: string, userName: string, changes: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'UPDATE',\n      entity: 'User',\n      entityId: userId,\n      details: `Updated user: ${userName}. Changes: ${changes}`\n    }, request),\n\n  // Settings operations\n  settingsUpdated: (request: NextRequest, settingType: string, details: string) =>\n    auditLog({\n      ...getUserContext(request),\n      action: 'UPDATE',\n      entity: 'Settings',\n      details: `Updated ${settingType}: ${details}`\n    }, request)\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\businessMonth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\calc.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TOLERANCE_CONFIG' is defined but never used.","line":7,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":21}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2985,2988],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2985,2988],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest'\r\nimport {\r\n    classifyVariance,\r\n    tankBookStock,\r\n    priceAt,\r\n    calculateShiftSummary,\r\n    TOLERANCE_CONFIG\r\n} from './calc'\r\nimport { Price } from '@/lib/types'\r\n\r\ndescribe('Calculator Logic', () => {\r\n\r\n    describe('classifyVariance', () => {\r\n        it('should classify variance as normal if within tolerance', () => {\r\n            const result = classifyVariance(1000, 1010) // -10 variance, within 20\r\n            expect(result.variance).toBe(-10)\r\n            expect(result.isNormal).toBe(true)\r\n        })\r\n\r\n        it('should classify variance as abnormal if outside tolerance', () => {\r\n            const result = classifyVariance(1000, 1050) // -50 variance, outside 20\r\n            expect(result.variance).toBe(-50)\r\n            expect(result.isNormal).toBe(false)\r\n        })\r\n\r\n        it('should use flat tolerance of 20 by default', () => {\r\n            const result = classifyVariance(1000, 1020)\r\n            expect(result.tolerance).toBe(20)\r\n            expect(result.isNormal).toBe(true)\r\n\r\n            const result2 = classifyVariance(1000, 1021)\r\n            expect(result2.isNormal).toBe(false)\r\n        })\r\n    })\r\n\r\n    describe('tankBookStock', () => {\r\n        it('should calculate correct book stock', () => {\r\n            // Opening: 1000, Delivery: 500, Outflow: 300, Returns: 50\r\n            // 1000 + 500 - 300 + 50 = 1250\r\n            const result = tankBookStock(1000, 500, 300, 50)\r\n            expect(result).toBe(1250)\r\n        })\r\n    })\r\n\r\n    describe('priceAt', () => {\r\n        const prices: Price[] = [\r\n            {\r\n                id: '1',\r\n                fuelId: 'fuel1',\r\n                price: 100,\r\n                effectiveFrom: new Date('2023-01-01T00:00:00Z'),\r\n                effectiveTo: new Date('2023-01-31T23:59:59Z')\r\n            },\r\n            {\r\n                id: '2',\r\n                fuelId: 'fuel1',\r\n                price: 110,\r\n                effectiveFrom: new Date('2023-02-01T00:00:00Z')\r\n                // No effectiveTo means active until 2099\r\n            }\r\n        ] as unknown as Price[]\r\n\r\n\r\n        it('should return correct price for date range', () => {\r\n            const price = priceAt('fuel1', '2023-01-15T12:00:00Z', prices)\r\n            expect(price).toBe(100)\r\n        })\r\n\r\n        it('should return correct price for second date range', () => {\r\n            const price = priceAt('fuel1', '2023-02-15T12:00:00Z', prices)\r\n            expect(price).toBe(110)\r\n        })\r\n\r\n        it('should return 0 if no price matches', () => {\r\n            const price = priceAt('fuel1', '2022-12-31T12:00:00Z', prices)\r\n            expect(price).toBe(0)\r\n        })\r\n    })\r\n\r\n    describe('calculateShiftSummary', () => {\r\n        it('should sum up declared amounts and calculate variance', () => {\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            const sales = [{ amount: 1000 }, { amount: 2000 }] as any\r\n            const result = calculateShiftSummary(sales, 1000, 1000, 500, 480)\r\n            // Total Sales: 3000\r\n            // Total Declared: 1000 + 1000 + 500 + 480 = 2980\r\n            // Variance: 3000 - 2980 = 20\r\n\r\n            expect(result.totalSales).toBe(3000)\r\n            expect(result.totalDeclared).toBe(2980)\r\n            expect(result.variance).toBe(20)\r\n            expect(result.varianceClassification.isNormal).toBe(true) // Exactly 20, which is tolerance\r\n        })\r\n\r\n        it('should handle invalid inputs gracefully', () => {\r\n            const result = calculateShiftSummary([], NaN, 0, 0, 0)\r\n            expect(result.totalSales).toBe(0)\r\n            expect(result.totalDeclared).toBe(0)\r\n            expect(result.variance).toBe(0)\r\n        })\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\calc.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_salesAmount' is defined but never used.","line":7,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_tolerancePercentage' is assigned a value but never used.","line":192,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":192,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Price } from '@/lib/types'\n\n// Tolerance configuration\nexport const TOLERANCE_CONFIG = {\n  percentage: 0, // Not used anymore - using flat amount only\n  flatAmount: 20, // Rs. 20 flat tolerance for any sale\n  getTolerance: (_salesAmount: number) => TOLERANCE_CONFIG.flatAmount // Always return flat Rs. 20\n}\n\nexport interface MeterReading {\n  id: string\n  nozzleId: string\n  reading: number\n  timestamp: string\n  type: 'START' | 'AUDIT' | 'END'\n}\n\nexport interface TestPour {\n  id: string\n  nozzleId: string\n  amount: number // in liters\n  timestamp: string\n  returned: boolean\n}\n\nexport interface SalesDelta {\n  nozzleId: string\n  startReading: number\n  endReading: number\n  delta: number\n  price: number\n  amount: number\n  startTime: string\n  endTime: string\n}\n\n/**\n * Get price for a fuel type at a specific datetime\n * @param fuelId - The fuel ID (or name for backward compatibility)\n * @param datetime - ISO datetime string\n * @param prices - Array of prices\n */\nexport function priceAt(fuelId: string, datetime: string, prices: Price[]): number {\n  const targetDate = new Date(datetime)\n  \n  const price = prices\n    .filter(p => p.fuelId === fuelId || p.fuel?.name === fuelId)\n    .find(p => {\n      const effectiveFrom = new Date(p.effectiveFrom)\n      const effectiveTo = p.effectiveTo ? new Date(p.effectiveTo) : new Date('2099-12-31T23:59:59Z')\n      return targetDate >= effectiveFrom && targetDate <= effectiveTo\n    })\n  \n  return price?.price || 0\n}\n\n/**\n * Split sales interval by price changes\n * @param fuelId - The fuel ID (or name for backward compatibility)\n */\nexport function splitIntervalByPrice(\n  startTime: string,\n  endTime: string,\n  prices: Price[],\n  fuelId: string\n): Array<{ startTime: string; endTime: string; price: number }> {\n  const intervals: Array<{ startTime: string; endTime: string; price: number }> = []\n  const start = new Date(startTime)\n  const end = new Date(endTime)\n  \n  // Get all price changes in the interval\n  const relevantPrices = prices\n    .filter(p => p.fuelId === fuelId || p.fuel?.name === fuelId)\n    .filter(p => {\n      const effectiveFrom = new Date(p.effectiveFrom)\n      const effectiveTo = p.effectiveTo ? new Date(p.effectiveTo) : new Date('2099-12-31T23:59:59Z')\n      return effectiveFrom <= end && effectiveTo >= start\n    })\n    .sort((a, b) => new Date(a.effectiveFrom).getTime() - new Date(b.effectiveFrom).getTime())\n  \n  let currentTime = start\n  let currentPriceIndex = 0\n  \n  while (currentTime < end) {\n    const nextPriceChange = relevantPrices[currentPriceIndex + 1]\n    const nextChangeTime = nextPriceChange ? new Date(nextPriceChange.effectiveFrom) : end\n    \n    const intervalEnd = nextChangeTime > end ? end : nextChangeTime\n    \n    intervals.push({\n      startTime: currentTime.toISOString(),\n      endTime: intervalEnd.toISOString(),\n      price: relevantPrices[currentPriceIndex]?.price || 0\n    })\n    \n    currentTime = intervalEnd\n    currentPriceIndex++\n  }\n  \n  return intervals\n}\n\n/**\n * Compute sales from meter deltas minus test pours\n */\nexport function computeSalesFromDeltas(\n  startReadings: MeterReading[],\n  auditReadings: MeterReading[],\n  endReadings: MeterReading[],\n  testPours: TestPour[],\n  prices: Price[]\n): SalesDelta[] {\n  const sales: SalesDelta[] = []\n  \n  // Group readings by nozzle\n  const readingsByNozzle = new Map<string, { start?: MeterReading; audits: MeterReading[]; end?: MeterReading }>()\n  \n  startReadings.forEach(reading => {\n    if (!readingsByNozzle.has(reading.nozzleId)) {\n      readingsByNozzle.set(reading.nozzleId, { audits: [] })\n    }\n    readingsByNozzle.get(reading.nozzleId)!.start = reading\n  })\n  \n  auditReadings.forEach(reading => {\n    if (!readingsByNozzle.has(reading.nozzleId)) {\n      readingsByNozzle.set(reading.nozzleId, { audits: [] })\n    }\n    readingsByNozzle.get(reading.nozzleId)!.audits.push(reading)\n  })\n  \n  endReadings.forEach(reading => {\n    if (!readingsByNozzle.has(reading.nozzleId)) {\n      readingsByNozzle.set(reading.nozzleId, { audits: [] })\n    }\n    readingsByNozzle.get(reading.nozzleId)!.end = reading\n  })\n  \n  // Calculate sales for each nozzle\n  readingsByNozzle.forEach((readings, nozzleId) => {\n    if (!readings.start || !readings.end) return\n    \n    const startReading = readings.start.reading\n    const endReading = readings.end.reading\n    const delta = endReading - startReading\n    \n    // Get fuel ID from nozzle (would need to look up from tank)\n    const fuelId = 'petrol-92-id' // This would be looked up from nozzle -> tank -> fuelId\n    const price = priceAt(fuelId, readings.start.timestamp, prices)\n    \n    // Subtract test pours for this nozzle\n    const nozzleTestPours = testPours.filter(tp => tp.nozzleId === nozzleId && tp.returned)\n    const testPourAmount = nozzleTestPours.reduce((sum, tp) => sum + tp.amount, 0)\n    \n    const netDelta = delta - testPourAmount\n    const amount = netDelta * price\n    \n    sales.push({\n      nozzleId,\n      startReading,\n      endReading,\n      delta: netDelta,\n      price,\n      amount,\n      startTime: readings.start.timestamp,\n      endTime: readings.end.timestamp\n    })\n  })\n  \n  return sales\n}\n\n/**\n * Calculate tank book stock\n */\nexport function tankBookStock(\n  openingStock: number,\n  deliveries: number,\n  nozzleOutflow: number,\n  testReturns: number\n): number {\n  return openingStock + deliveries - nozzleOutflow + testReturns\n}\n\n/**\n * Classify variance as normal or suspicious\n * Uses flat Rs. 20 tolerance for any sale amount\n */\nexport function classifyVariance(\n  totalSales: number,\n  declaredAmount: number,\n  _tolerancePercentage: number = 0, // Not used - kept for backward compatibility\n  toleranceFlat: number = TOLERANCE_CONFIG.flatAmount\n): {\n  variance: number\n  variancePercentage: number\n  isNormal: boolean\n  tolerance: number\n} {\n  const variance = totalSales - declaredAmount\n  const variancePercentage = totalSales > 0 ? (Math.abs(variance) / totalSales) * 100 : 0\n  // Use flat Rs. 20 tolerance for any sale\n  const tolerance = toleranceFlat\n  \n  return {\n    variance,\n    variancePercentage,\n    isNormal: Math.abs(variance) <= tolerance,\n    tolerance\n  }\n}\n\n/**\n * Calculate daily profit\n */\nexport function calculateDailyProfit(\n  sales: number,\n  expenses: number,\n  loansOut: number,\n  creditRepaymentsCash: number,\n  chequeEncashments: number,\n  deposits: number\n): number {\n  return sales - expenses - loansOut + creditRepaymentsCash + chequeEncashments - deposits\n}\n\n/**\n * Calculate tank variance (book stock vs dip stock)\n */\nexport function calculateTankVariance(\n  bookStock: number,\n  dipStock: number,\n  tolerancePercentage: number = 0.5 // 0.5% tolerance for tank variance\n): {\n  variance: number\n  variancePercentage: number\n  isWithinTolerance: boolean\n  tolerance: number\n} {\n  const variance = bookStock - dipStock\n  const variancePercentage = bookStock > 0 ? (Math.abs(variance) / bookStock) * 100 : 0\n  const tolerance = (bookStock * tolerancePercentage) / 100\n  \n  return {\n    variance,\n    variancePercentage,\n    isWithinTolerance: Math.abs(variance) <= tolerance,\n    tolerance\n  }\n}\n\n/**\n * Calculate shift summary\n */\nexport function calculateShiftSummary(\n  sales: SalesDelta[],\n  cashAmount: number,\n  cardAmount: number,\n  creditAmount: number,\n  chequeAmount: number\n): {\n  totalSales: number\n  totalDeclared: number\n  variance: number\n  varianceClassification: ReturnType<typeof classifyVariance>\n} {\n  // Validate and sanitize input values\n  const validSales = Array.isArray(sales) ? sales : []\n  const validCashAmount = isNaN(cashAmount) || !isFinite(cashAmount) ? 0 : cashAmount\n  const validCardAmount = isNaN(cardAmount) || !isFinite(cardAmount) ? 0 : cardAmount\n  const validCreditAmount = isNaN(creditAmount) || !isFinite(creditAmount) ? 0 : creditAmount\n  const validChequeAmount = isNaN(chequeAmount) || !isFinite(chequeAmount) ? 0 : chequeAmount\n  \n  // Calculate total sales, ensuring all amounts are valid numbers\n  const totalSales = validSales.reduce((sum, sale) => {\n    const amount = isNaN(sale.amount) || !isFinite(sale.amount) ? 0 : sale.amount\n    return sum + amount\n  }, 0)\n  \n  const totalDeclared = validCashAmount + validCardAmount + validCreditAmount + validChequeAmount\n  \n  // Validate totalSales and totalDeclared before calling classifyVariance\n  const safeTotalSales = isNaN(totalSales) || !isFinite(totalSales) ? 0 : totalSales\n  const safeTotalDeclared = isNaN(totalDeclared) || !isFinite(totalDeclared) ? 0 : totalDeclared\n  \n  const varianceClassification = classifyVariance(safeTotalSales, safeTotalDeclared)\n  \n  return {\n    totalSales: safeTotalSales,\n    totalDeclared: safeTotalDeclared,\n    variance: safeTotalSales - safeTotalDeclared,\n    varianceClassification\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\exportUtils.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":455,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":455,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SalaryReportResponse' is defined but never used.","line":720,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":720,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import jsPDF from 'jspdf'\nimport autoTable from 'jspdf-autotable'\nimport * as XLSX from 'xlsx'\n\n// PDF Export Utilities\nexport class PDFExporter {\n  private doc: jsPDF\n  private currentY: number = 50\n  private pageWidth: number\n  private pageHeight: number\n  private margin: number = 20\n\n  constructor(title: string, orientation: 'portrait' | 'landscape' = 'portrait') {\n    this.doc = new jsPDF({\n      orientation,\n      unit: 'mm',\n      format: 'a4'\n    })\n\n    this.pageWidth = orientation === 'portrait' ? 210 : 297\n    this.pageHeight = orientation === 'portrait' ? 297 : 210\n\n    this.addProfessionalHeader(title)\n    this.currentY = 55\n  }\n\n  private addProfessionalHeader(title: string) {\n    // Background header\n    this.doc.setFillColor(63, 81, 181) // Blue header\n    this.doc.rect(0, 0, this.pageWidth, 50, 'F')\n\n    // Company name\n    this.doc.setFontSize(24)\n    this.doc.setFont('helvetica', 'bold')\n    this.doc.setTextColor(255, 255, 255)\n    this.doc.text('FUEL STATION', this.margin, 20)\n\n    this.doc.setFontSize(12)\n    this.doc.setFont('helvetica', 'normal')\n    this.doc.text('Management System', this.margin, 28)\n\n    // Report title\n    this.doc.setFontSize(18)\n    this.doc.setFont('helvetica', 'bold')\n    this.doc.text(title, this.margin, 40)\n\n    // Date and page info\n    this.doc.setFontSize(9)\n    this.doc.setFont('helvetica', 'normal')\n    const dateStr = new Date().toLocaleString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    })\n    this.doc.text(dateStr, this.pageWidth - this.margin, 20, { align: 'right' })\n\n    // Reset text color\n    this.doc.setTextColor(0, 0, 0)\n  }\n\n  private checkPageBreak(requiredHeight: number) {\n    if (this.currentY + requiredHeight > this.pageHeight - this.margin - 15) {\n      this.addPageFooter()\n      this.doc.addPage()\n      this.currentY = this.margin\n      this.addPageHeader()\n      return true\n    }\n    return false\n  }\n\n  private addPageHeader() {\n    // Minimal header for continuation pages\n    this.doc.setFillColor(240, 240, 240)\n    this.doc.rect(0, 0, this.pageWidth, 15, 'F')\n    this.doc.setFontSize(10)\n    this.doc.setFont('helvetica', 'bold')\n    this.doc.setTextColor(63, 81, 181)\n    this.doc.text('FUEL STATION MANAGEMENT SYSTEM', this.margin, 10)\n    this.doc.setTextColor(0, 0, 0)\n    this.currentY = 20\n  }\n\n  private addPageFooter() {\n    interface ExtendedJsPDF {\n      internal: {\n        getNumberOfPages: () => number\n      }\n    }\n    const pageNum = (this.doc as unknown as ExtendedJsPDF).internal.getNumberOfPages()\n    this.doc.setFontSize(8)\n    this.doc.setTextColor(128, 128, 128)\n    this.doc.text(\n      `Page ${pageNum}`,\n      this.pageWidth / 2,\n      this.pageHeight - 10,\n      { align: 'center' }\n    )\n    this.doc.text(\n      'Confidential - For Internal Use Only',\n      this.pageWidth - this.margin,\n      this.pageHeight - 10,\n      { align: 'right' }\n    )\n    this.doc.setTextColor(0, 0, 0)\n  }\n\n  addSectionTitle(title: string) {\n    this.checkPageBreak(15)\n\n    // Section background\n    this.doc.setFillColor(245, 247, 250)\n    this.doc.rect(this.margin, this.currentY, this.pageWidth - 2 * this.margin, 10, 'F')\n\n    this.doc.setFontSize(14)\n    this.doc.setFont('helvetica', 'bold')\n    this.doc.setTextColor(63, 81, 181)\n    this.doc.text(title, this.margin + 3, this.currentY + 7)\n    this.doc.setTextColor(0, 0, 0)\n\n    this.currentY += 15\n  }\n\n  addTable(headers: string[], data: (string | number)[][], title?: string) {\n    if (title) {\n      this.addSectionTitle(title)\n    }\n\n    this.checkPageBreak(30)\n\n    autoTable(this.doc, {\n      head: [headers],\n      body: data,\n      startY: this.currentY,\n      margin: { left: this.margin, right: this.margin },\n      styles: {\n        fontSize: 9,\n        cellPadding: 3,\n        lineColor: [220, 220, 220],\n        lineWidth: 0.1\n      },\n      headStyles: {\n        fillColor: [63, 81, 181],\n        textColor: 255,\n        fontStyle: 'bold',\n        fontSize: 10,\n        cellPadding: 4\n      },\n      alternateRowStyles: {\n        fillColor: [248, 249, 250]\n      },\n      didDrawPage: (data) => {\n        if (data.pageNumber > 1) {\n          this.addPageHeader()\n        }\n      }\n    })\n\n    interface AutoTableJsPDF {\n      lastAutoTable?: {\n        finalY: number\n      }\n    }\n    const finalY = (this.doc as unknown as AutoTableJsPDF).lastAutoTable?.finalY || this.currentY\n    this.currentY = finalY + 10\n  }\n\n  addStatisticsGrid(stats: { label: string; value: string | number; color?: string }[][]) {\n    this.checkPageBreak(35)\n\n    const cardWidth = (this.pageWidth - 2 * this.margin - 10) / stats[0].length\n    const cardHeight = 25\n\n    stats.forEach((row, rowIndex) => {\n      const yPos = this.currentY + (rowIndex * (cardHeight + 5))\n\n      row.forEach((stat, colIndex) => {\n        const xPos = this.margin + (colIndex * (cardWidth + 5))\n\n        // Card background\n        this.doc.setFillColor(248, 249, 250)\n        this.doc.roundedRect(xPos, yPos, cardWidth, cardHeight, 2, 2, 'F')\n\n        // Border\n        this.doc.setDrawColor(220, 220, 220)\n        this.doc.setLineWidth(0.5)\n        this.doc.roundedRect(xPos, yPos, cardWidth, cardHeight, 2, 2, 'S')\n\n        // Label\n        this.doc.setFontSize(8)\n        this.doc.setFont('helvetica', 'normal')\n        this.doc.setTextColor(100, 100, 100)\n        this.doc.text(stat.label, xPos + 3, yPos + 7)\n\n        // Value\n        this.doc.setFontSize(16)\n        this.doc.setFont('helvetica', 'bold')\n        if (stat.color) {\n          const colors = this.parseColor(stat.color)\n          this.doc.setTextColor(colors[0], colors[1], colors[2])\n        } else {\n          this.doc.setTextColor(63, 81, 181)\n        }\n        this.doc.text(String(stat.value), xPos + 3, yPos + 18)\n\n        this.doc.setTextColor(0, 0, 0)\n      })\n    })\n\n    this.currentY += (stats.length * (cardHeight + 5)) + 10\n  }\n\n  private parseColor(color: string): [number, number, number] {\n    // Simple color parser for common colors\n    const colorMap: { [key: string]: [number, number, number] } = {\n      'blue': [63, 81, 181],\n      'green': [34, 197, 94],\n      'red': [239, 68, 68],\n      'orange': [249, 115, 22],\n      'purple': [168, 85, 247],\n      'yellow': [234, 179, 8]\n    }\n    return colorMap[color] || [63, 81, 181]\n  }\n\n  addChart(chartImageData: string, title: string, width?: number, height?: number) {\n    const imgWidth = width || (this.pageWidth - 2 * this.margin)\n    const imgHeight = height || 80\n\n    this.checkPageBreak(imgHeight + 20)\n\n    if (title) {\n      this.doc.setFontSize(12)\n      this.doc.setFont('helvetica', 'bold')\n      this.doc.text(title, this.margin, this.currentY)\n      this.currentY += 8\n    }\n\n    try {\n      this.doc.addImage(chartImageData, 'PNG', this.margin, this.currentY, imgWidth, imgHeight)\n      this.currentY += imgHeight + 10\n    } catch (error) {\n      console.error('Failed to add chart image:', error)\n      this.doc.setFontSize(10)\n      this.doc.setTextColor(200, 0, 0)\n      this.doc.text('Chart could not be rendered', this.margin, this.currentY)\n      this.currentY += 10\n      this.doc.setTextColor(0, 0, 0)\n    }\n  }\n\n  addKeyValuePairs(data: { label: string; value: string | number }[], columns: number = 2) {\n    this.checkPageBreak(data.length * 8 / columns)\n\n    const colWidth = (this.pageWidth - 2 * this.margin) / columns\n\n    data.forEach((item, index) => {\n      const col = index % columns\n      const row = Math.floor(index / columns)\n      const xPos = this.margin + (col * colWidth)\n      const yPos = this.currentY + (row * 8)\n\n      this.doc.setFontSize(9)\n      this.doc.setFont('helvetica', 'bold')\n      this.doc.text(`${item.label}:`, xPos, yPos)\n\n      this.doc.setFont('helvetica', 'normal')\n      this.doc.text(String(item.value), xPos + 50, yPos)\n    })\n\n    this.currentY += Math.ceil(data.length / columns) * 8 + 10\n  }\n\n  addDivider() {\n    this.checkPageBreak(5)\n    this.doc.setDrawColor(220, 220, 220)\n    this.doc.setLineWidth(0.5)\n    this.doc.line(this.margin, this.currentY, this.pageWidth - this.margin, this.currentY)\n    this.currentY += 8\n  }\n\n  addText(text: string, fontSize: number = 10, bold: boolean = false) {\n    this.checkPageBreak(10)\n    this.doc.setFontSize(fontSize)\n    this.doc.setFont('helvetica', bold ? 'bold' : 'normal')\n\n    const lines = this.doc.splitTextToSize(text, this.pageWidth - 2 * this.margin)\n    this.doc.text(lines, this.margin, this.currentY)\n    this.currentY += lines.length * (fontSize * 0.5) + 5\n  }\n\n  addSummaryCards(summaryData: { label: string; value: string | number }[]) {\n    this.addSectionTitle('Summary')\n\n    const cardWidth = 85\n    const cardHeight = 20\n    const cols = 2\n\n    summaryData.forEach((item, index) => {\n      const col = index % cols\n      const row = Math.floor(index / cols)\n      const x = this.margin + (col * (cardWidth + 5))\n      const y = this.currentY + (row * (cardHeight + 5))\n\n      this.checkPageBreak(cardHeight + 10)\n\n      // Card background with gradient effect\n      this.doc.setFillColor(248, 249, 250)\n      this.doc.roundedRect(x, y, cardWidth, cardHeight, 2, 2, 'F')\n\n      // Border\n      this.doc.setDrawColor(220, 220, 220)\n      this.doc.setLineWidth(0.5)\n      this.doc.roundedRect(x, y, cardWidth, cardHeight, 2, 2, 'S')\n\n      // Label\n      this.doc.setFontSize(8)\n      this.doc.setFont('helvetica', 'normal')\n      this.doc.setTextColor(100, 100, 100)\n      this.doc.text(item.label, x + 3, y + 7)\n\n      // Value\n      this.doc.setFontSize(14)\n      this.doc.setFont('helvetica', 'bold')\n      this.doc.setTextColor(63, 81, 181)\n      this.doc.text(String(item.value), x + 3, y + 16)\n\n      this.doc.setTextColor(0, 0, 0)\n    })\n\n    this.currentY += Math.ceil(summaryData.length / cols) * (cardHeight + 5) + 10\n  }\n\n  save(filename: string) {\n    // Add footer to all pages\n    interface ExtendedJsPDF {\n      internal: {\n        getNumberOfPages: () => number\n      }\n    }\n    const pageCount = (this.doc as unknown as ExtendedJsPDF).internal.getNumberOfPages()\n    for (let i = 1; i <= pageCount; i++) {\n      this.doc.setPage(i)\n      this.doc.setFontSize(8)\n      this.doc.setTextColor(128, 128, 128)\n      this.doc.text(\n        `Page ${i} of ${pageCount}`,\n        this.pageWidth / 2,\n        this.pageHeight - 10,\n        { align: 'center' }\n      )\n      this.doc.text(\n        'Confidential - For Internal Use Only',\n        this.pageWidth - this.margin,\n        this.pageHeight - 10,\n        { align: 'right' }\n      )\n      this.doc.text(\n        `Generated: ${new Date().toLocaleDateString()}`,\n        this.margin,\n        this.pageHeight - 10\n      )\n    }\n\n    this.doc.save(filename)\n  }\n\n  getBlob(): Blob {\n    return this.doc.output('blob')\n  }\n}\n\n// Excel Export Utilities\nexport class ExcelExporter {\n  private workbook: XLSX.WorkBook\n  private worksheets: { [key: string]: (string | number)[][] } = {}\n\n  constructor() {\n    this.workbook = XLSX.utils.book_new()\n  }\n\n  addWorksheet(name: string, headers: string[], data: (string | number)[][]) {\n    const worksheetData = [headers, ...data]\n    this.worksheets[name] = worksheetData\n\n    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData)\n\n    // Auto-size columns\n    const colWidths = headers.map((_, colIndex) => {\n      const maxLength = Math.max(\n        headers[colIndex]?.length || 0,\n        ...data.map(row => String(row[colIndex] || '').length)\n      )\n      return { wch: Math.min(Math.max(maxLength + 2, 10), 50) }\n    })\n    worksheet['!cols'] = colWidths\n\n    XLSX.utils.book_append_sheet(this.workbook, worksheet, name)\n  }\n\n  addSummaryWorksheet(name: string, summaryData: { label: string; value: string | number }[]) {\n    const data = summaryData.map(item => [item.label, item.value])\n    this.addWorksheet(name, ['Metric', 'Value'], data)\n  }\n\n  save(filename: string) {\n    XLSX.writeFile(this.workbook, filename)\n  }\n\n  getBuffer(): ArrayBuffer {\n    return XLSX.write(this.workbook, { bookType: 'xlsx', type: 'array' })\n  }\n}\n\n// Chart capture utility - Enhanced for better quality\nexport const captureChartAsImage = async (chartId: string): Promise<string | null> => {\n  try {\n    const chartElement = document.getElementById(chartId)\n    if (!chartElement) {\n      console.warn(`Chart element with ID \"${chartId}\" not found`)\n      return null\n    }\n\n    const svgElement = chartElement.querySelector('svg')\n    if (!svgElement) {\n      console.warn(`SVG element not found in chart \"${chartId}\"`)\n      return null\n    }\n\n    // Clone the SVG to avoid modifying the original\n    const clonedSvg = svgElement.cloneNode(true) as SVGElement\n\n    // Get dimensions\n    const bbox = svgElement.getBoundingClientRect()\n    const width = bbox.width || 800\n    const height = bbox.height || 400\n\n    // Set explicit dimensions on cloned SVG\n    clonedSvg.setAttribute('width', width.toString())\n    clonedSvg.setAttribute('height', height.toString())\n\n    // Inline all styles\n    const styleSheets = Array.from(document.styleSheets)\n    let allCSS = ''\n\n    try {\n      styleSheets.forEach(sheet => {\n        try {\n          const rules = Array.from(sheet.cssRules || [])\n          rules.forEach(rule => {\n            allCSS += rule.cssText + '\\n'\n          })\n        } catch (e) {\n          // Skip cross-origin stylesheets\n        }\n      })\n    } catch (e) {\n      console.warn('Could not read stylesheets', e)\n    }\n\n    // Add style element to SVG\n    if (allCSS) {\n      const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style')\n      styleElement.textContent = allCSS\n      clonedSvg.insertBefore(styleElement, clonedSvg.firstChild)\n    }\n\n    // Serialize SVG\n    const serializer = new XMLSerializer()\n    let svgString = serializer.serializeToString(clonedSvg)\n\n    // Add XML declaration and ensure proper encoding\n    svgString = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' + svgString\n\n    // Create canvas with higher resolution\n    const scale = 3 // 3x for high quality\n    const canvas = document.createElement('canvas')\n    canvas.width = width * scale\n    canvas.height = height * scale\n    const ctx = canvas.getContext('2d')\n\n    if (!ctx) return null\n\n    // Fill with white background\n    ctx.fillStyle = 'white'\n    ctx.fillRect(0, 0, canvas.width, canvas.height)\n\n    // Create blob and image\n    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' })\n    const url = URL.createObjectURL(blob)\n\n    return new Promise((resolve) => {\n      const img = new Image()\n      img.onload = () => {\n        ctx.scale(scale, scale)\n        ctx.drawImage(img, 0, 0, width, height)\n        URL.revokeObjectURL(url)\n        const dataUrl = canvas.toDataURL('image/png', 1.0)\n        resolve(dataUrl)\n      }\n      img.onerror = (error) => {\n        console.error('Image load error:', error)\n        URL.revokeObjectURL(url)\n        resolve(null)\n      }\n      img.src = url\n    })\n  } catch (error) {\n    console.error('Error capturing chart:', error)\n    return null\n  }\n}\n\n// Report-specific export functions\nexport interface DailyReportData {\n  salesBreakdown?: {\n    petrol92?: { litres: number; amount: number }\n    petrol95?: { litres: number; amount: number }\n    diesel?: { litres: number; amount: number }\n    superDiesel?: { litres: number; amount: number }\n  }\n  totalSales?: number\n  totalExpenses?: number\n  netProfit?: number\n  variancePercentage?: number\n}\n\nexport const exportDailyReportPDF = (reportData: DailyReportData, stationName: string, date: string): void => {\n  const pdf = new PDFExporter(`Daily Report - ${stationName} - ${date}`)\n\n  // Sales breakdown\n  const salesData = [\n    ['Petrol 92', `${reportData.salesBreakdown?.petrol92?.litres || 0}L`, `Rs. ${(reportData.salesBreakdown?.petrol92?.amount || 0).toLocaleString()}`],\n    ['Petrol 95', `${reportData.salesBreakdown?.petrol95?.litres || 0}L`, `Rs. ${(reportData.salesBreakdown?.petrol95?.amount || 0).toLocaleString()}`],\n    ['Diesel', `${reportData.salesBreakdown?.diesel?.litres || 0}L`, `Rs. ${(reportData.salesBreakdown?.diesel?.amount || 0).toLocaleString()}`],\n    ['Super Diesel', `${reportData.salesBreakdown?.superDiesel?.litres || 0}L`, `Rs. ${(reportData.salesBreakdown?.superDiesel?.amount || 0).toLocaleString()}`]\n  ]\n  pdf.addTable(['Fuel Type', 'Litres', 'Amount'], salesData, 'Sales Breakdown')\n\n  // Summary cards\n  const summaryData = [\n    { label: 'Total Sales', value: `Rs. ${(reportData.totalSales || 0).toLocaleString()}` },\n    { label: 'Total Expenses', value: `Rs. ${(reportData.totalExpenses || 0).toLocaleString()}` },\n    { label: 'Net Profit', value: `Rs. ${(reportData.netProfit || 0).toLocaleString()}` },\n    { label: 'Variance', value: `${(reportData.variancePercentage || 0).toFixed(2)}%` }\n  ]\n  pdf.addSummaryCards(summaryData)\n\n  pdf.save(`daily-report-${stationName}-${date}.pdf`)\n}\n\nexport const exportDailyReportExcel = (reportData: DailyReportData, stationName: string, date: string) => {\n  const excel = new ExcelExporter()\n\n  // Sales breakdown\n  const salesData = [\n    ['Petrol 92', reportData.salesBreakdown?.petrol92?.litres || 0, reportData.salesBreakdown?.petrol92?.amount || 0],\n    ['Petrol 95', reportData.salesBreakdown?.petrol95?.litres || 0, reportData.salesBreakdown?.petrol95?.amount || 0],\n    ['Diesel', reportData.salesBreakdown?.diesel?.litres || 0, reportData.salesBreakdown?.diesel?.amount || 0],\n    ['Super Diesel', reportData.salesBreakdown?.superDiesel?.litres || 0, reportData.salesBreakdown?.superDiesel?.amount || 0]\n  ]\n  excel.addWorksheet('Sales Breakdown', ['Fuel Type', 'Litres', 'Amount (Rs)'], salesData)\n\n  // Summary\n  const summaryData = [\n    { label: 'Total Sales', value: reportData.totalSales || 0 },\n    { label: 'Total Expenses', value: reportData.totalExpenses || 0 },\n    { label: 'Net Profit', value: reportData.netProfit || 0 },\n    { label: 'Variance %', value: reportData.variancePercentage || 0 }\n  ]\n  excel.addSummaryWorksheet('Summary', summaryData)\n\n  excel.save(`daily-report-${stationName}-${date}.xlsx`)\n}\n\ninterface ShiftReportData {\n  nozzlePerformance?: Array<{\n    nozzleName: string\n    pumperName: string\n    litresSold: number\n    amount: number\n    variancePercentage: number\n  }>\n  totalSales?: number\n  totalDeclared?: number\n  variance?: number\n  overallStatus?: string\n}\n\nexport const exportShiftReportPDF = (shiftData: ShiftReportData, stationName: string, shiftId: string) => {\n  const pdf = new PDFExporter(`Shift Report - ${stationName} - Shift ${shiftId}`)\n\n  // Nozzle performance\n  const nozzleData = shiftData.nozzlePerformance?.map((nozzle) => [\n    nozzle.nozzleName,\n    nozzle.pumperName,\n    `${nozzle.litresSold}L`,\n    `Rs. ${nozzle.amount.toLocaleString()}`,\n    `${nozzle.variancePercentage.toFixed(2)}%`\n  ]) || []\n\n  pdf.addTable(['Nozzle', 'Pumper', 'Litres', 'Amount', 'Variance'], nozzleData, 'Nozzle Performance')\n\n  // Summary\n  const summaryData = [\n    { label: 'Total Sales', value: `Rs. ${(shiftData.totalSales || 0).toLocaleString()}` },\n    { label: 'Total Declared', value: `Rs. ${(shiftData.totalDeclared || 0).toLocaleString()}` },\n    { label: 'Variance', value: `Rs. ${(shiftData.variance || 0).toLocaleString()}` },\n    { label: 'Status', value: shiftData.overallStatus || 'Unknown' }\n  ]\n  pdf.addSummaryCards(summaryData)\n\n  pdf.save(`shift-report-${stationName}-${shiftId}.pdf`)\n}\n\ninterface TankReportData {\n  tankName: string\n  fuelName: string\n  openingStock: number\n  deliveries: number\n  sales: number\n  testReturns: number\n  closingBook: number\n  closingDip: number\n  variance: number\n  variancePercentage: number\n  status: string\n}\n\nexport const exportTankReportPDF = (tankData: TankReportData[], stationName: string, date: string) => {\n  const pdf = new PDFExporter(`Tank Movement Report - ${stationName} - ${date}`, 'landscape')\n\n  const tankMovementData = tankData.map(tank => [\n    tank.tankName,\n    tank.fuelName,\n    `${tank.openingStock}L`,\n    `${tank.deliveries}L`,\n    `${tank.sales}L`,\n    `${tank.testReturns}L`,\n    `${tank.closingBook}L`,\n    `${tank.closingDip}L`,\n    `${tank.variance}L`,\n    `${tank.variancePercentage.toFixed(2)}%`,\n    tank.status\n  ])\n\n  pdf.addTable([\n    'Tank', 'Fuel Type', 'Opening', 'Deliveries', 'Sales', 'Test Returns',\n    'Closing Book', 'Closing Dip', 'Variance', 'Variance %', 'Status'\n  ], tankMovementData, 'Tank Movement')\n\n  pdf.save(`tank-report-${stationName}-${date}.pdf`)\n}\n\ninterface ProfitReportData {\n  revenueBreakdown?: Array<{\n    category: string\n    amount: number\n    percentage: number\n  }>\n  expenseBreakdown?: Array<{\n    category: string\n    amount: number\n    percentage: number\n  }>\n  totalRevenue?: number\n  totalExpenses?: number\n  netProfit?: number\n  profitMargin?: number\n}\n\nexport const exportProfitReportPDF = (profitData: ProfitReportData, stationName: string, month: string) => {\n  const pdf = new PDFExporter(`Profit Report - ${stationName} - ${month}`)\n\n  // Revenue breakdown\n  const revenueData = profitData.revenueBreakdown?.map((item) => [\n    item.category,\n    `Rs. ${item.amount.toLocaleString()}`,\n    `${item.percentage.toFixed(1)}%`\n  ]) || []\n\n  pdf.addTable(['Revenue Source', 'Amount', 'Percentage'], revenueData, 'Revenue Breakdown')\n\n  // Expense breakdown\n  const expenseData = profitData.expenseBreakdown?.map((item) => [\n    item.category,\n    `Rs. ${item.amount.toLocaleString()}`,\n    `${item.percentage.toFixed(1)}%`\n  ]) || []\n\n  pdf.addTable(['Expense Category', 'Amount', 'Percentage'], expenseData, 'Expense Breakdown')\n\n  // Summary\n  const summaryData = [\n    { label: 'Total Revenue', value: `Rs. ${(profitData.totalRevenue || 0).toLocaleString()}` },\n    { label: 'Total Expenses', value: `Rs. ${(profitData.totalExpenses || 0).toLocaleString()}` },\n    { label: 'Net Profit', value: `Rs. ${(profitData.netProfit || 0).toLocaleString()}` },\n    { label: 'Profit Margin', value: `${(profitData.profitMargin || 0).toFixed(2)}%` }\n  ]\n  pdf.addSummaryCards(summaryData)\n\n  pdf.save(`profit-report-${stationName}-${month}.pdf`)\n}\n\ninterface SalaryReportData {\n  pumperId: string\n  pumperName: string\n  employeeId?: string\n  baseSalary: number\n  shiftCount: number\n  totalHours: number\n  totalSales: number\n  totalAdvances: number\n  totalLoans: number\n  varianceAdd: number\n  varianceDeduct: number\n  netSalary: number\n}interface SalaryReportResponse {\n  month: string\n  startDate: string\n  endDate: string\n  salaryData: SalaryReportData[]\n}\n\nexport const exportSalaryReportPDF = (salaryData: SalaryReportData[], monthLabel: string) => {\n  const pdf = new PDFExporter(`Monthly Salary Report - ${monthLabel}`, 'landscape')\n\n  // Salary breakdown table\n  const salaryTableData = salaryData.map((pumper) => [\n    pumper.pumperName,\n    pumper.employeeId || 'N/A',\n    `${pumper.shiftCount}`,\n    `${pumper.totalHours.toFixed(1)}h`,\n    `Rs. ${pumper.totalSales.toLocaleString()}`,\n    `Rs. ${pumper.baseSalary.toLocaleString()}`,\n    `Rs. ${pumper.totalAdvances.toLocaleString()}`,\n    `Rs. ${pumper.totalLoans.toLocaleString()}`,\n    pumper.varianceAdd > 0 ? `+Rs. ${pumper.varianceAdd.toLocaleString()}` :\n      pumper.varianceDeduct > 0 ? `-Rs. ${pumper.varianceDeduct.toLocaleString()}` : '-',\n    `Rs. ${pumper.netSalary.toLocaleString()}`\n  ])\n\n  pdf.addTable([\n    'Pumper',\n    'Employee ID',\n    'Shifts',\n    'Hours',\n    'Total Sales',\n    'Base Salary',\n    'Advances',\n    'Loans',\n    'Variance',\n    'Net Salary'\n  ], salaryTableData, 'Monthly Salary Breakdown')\n\n  // Summary\n  const totalBaseSalary = salaryData.reduce((sum, p) => sum + p.baseSalary, 0)\n  const totalAdvances = salaryData.reduce((sum, p) => sum + p.totalAdvances, 0)\n  const totalLoans = salaryData.reduce((sum, p) => sum + p.totalLoans, 0)\n  const totalVarianceAdd = salaryData.reduce((sum, p) => sum + p.varianceAdd, 0)\n  const totalVarianceDeduct = salaryData.reduce((sum, p) => sum + p.varianceDeduct, 0)\n  const totalNetSalary = salaryData.reduce((sum, p) => sum + p.netSalary, 0)\n\n  const summaryData = [\n    { label: 'Total Pumpers', value: salaryData.length.toString() },\n    { label: 'Total Base Salary', value: `Rs. ${totalBaseSalary.toLocaleString()}` },\n    { label: 'Total Advances', value: `Rs. ${totalAdvances.toLocaleString()}` },\n    { label: 'Total Loans', value: `Rs. ${totalLoans.toLocaleString()}` },\n    { label: 'Total Variance Bonuses', value: `Rs. ${totalVarianceAdd.toLocaleString()}` },\n    { label: 'Total Variance Deductions', value: `Rs. ${totalVarianceDeduct.toLocaleString()}` },\n    { label: 'Total Net Salary', value: `Rs. ${totalNetSalary.toLocaleString()}` }\n  ]\n  pdf.addSummaryCards(summaryData)\n\n  pdf.save(`salary-report-${monthLabel.replace(/\\s+/g, '-')}.pdf`)\n}\n\n// Daily Sales Report (Rs) Export\ninterface DailySalesReportData {\n  dailySales: Array<{\n    date: string\n    sales: Record<string, number>\n    totalSales: number\n  }>\n  fuelTypes: string[]\n  grandTotal: number\n  chartImage?: string\n}\n\nexport const exportDailySalesReportPDF = async (reportData: DailySalesReportData, stationName: string, monthLabel: string, chartImage?: string) => {\n  const pdf = new PDFExporter(`Daily Sales Report (Rs) - ${stationName} - ${monthLabel}`, 'landscape')\n\n  const totalDays = reportData.dailySales.length || 1\n  const totalRevenue = reportData.grandTotal || 0\n  const avgDaily = totalDays > 0 ? Math.round(totalRevenue / totalDays) : 0\n\n  const maxDay = reportData.dailySales.length > 0\n    ? reportData.dailySales.reduce((max, day) => day.totalSales > max.totalSales ? day : max)\n    : { totalSales: 0, date: '' }\n  const minDay = reportData.dailySales.length > 0\n    ? reportData.dailySales.reduce((min, day) => day.totalSales < min.totalSales ? day : min)\n    : { totalSales: 0, date: '' }\n\n  // Report Information\n  pdf.addSectionTitle('Report Information')\n  pdf.addKeyValuePairs([\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Station', value: stationName },\n    { label: 'Total Days in Period', value: totalDays.toString() },\n    { label: 'Report Generated', value: new Date().toLocaleString() }\n  ], 2)\n\n  pdf.addDivider()\n\n  // Key Performance Metrics\n  pdf.addSectionTitle('Key Performance Metrics')\n  const statsGrid = [\n    [\n      { label: 'Total Revenue', value: `Rs. ${totalRevenue.toLocaleString()}`, color: 'blue' },\n      { label: 'Average Daily Sales', value: `Rs. ${avgDaily.toLocaleString()}`, color: 'purple' },\n      { label: 'Fuel Types Sold', value: reportData.fuelTypes.length.toString(), color: 'green' }\n    ],\n    [\n      { label: 'Best Day Revenue', value: `Rs. ${maxDay.totalSales.toLocaleString()}`, color: 'green' },\n      { label: 'Lowest Day Revenue', value: `Rs. ${minDay.totalSales.toLocaleString()}`, color: 'orange' },\n      { label: 'Revenue Range', value: `Rs. ${(maxDay.totalSales - minDay.totalSales).toLocaleString()}`, color: 'blue' }\n    ]\n  ]\n  pdf.addStatisticsGrid(statsGrid)\n\n  pdf.addDivider()\n\n  // Sales Trend Chart\n  if (chartImage) {\n    pdf.addSectionTitle('Daily Sales Trend')\n    pdf.addChart(chartImage, '', 250, 100)\n    pdf.addDivider()\n  }\n\n  // Revenue by Fuel Type\n  pdf.addSectionTitle('Revenue Breakdown by Fuel Type')\n  const fuelBreakdown: { label: string; value: string }[] = reportData.fuelTypes.map(fuelName => {\n    const total = reportData.dailySales.reduce((sum, day) => sum + (day.sales[fuelName] || 0), 0)\n    const percentage = totalRevenue > 0 ? ((total / totalRevenue) * 100).toFixed(1) : '0.0'\n    return {\n      label: fuelName,\n      value: `Rs. ${total.toLocaleString()} (${percentage}%)`\n    }\n  })\n  pdf.addKeyValuePairs(fuelBreakdown, 2)\n\n  pdf.addDivider()\n\n  // Complete Daily Sales Table\n  pdf.addSectionTitle('Daily Sales Details')\n  const salesData = reportData.dailySales.map((day) => {\n    const row: (string | number)[] = [\n      new Date(day.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })\n    ]\n    reportData.fuelTypes.forEach(fuelName => {\n      row.push(`Rs. ${(day.sales[fuelName] || 0).toLocaleString()}`)\n    })\n    row.push(`Rs. ${day.totalSales.toLocaleString()}`)\n    return row\n  })\n\n  // Add totals row\n  const totalsRow: (string | number)[] = ['TOTAL']\n  reportData.fuelTypes.forEach(fuelName => {\n    const total = reportData.dailySales.reduce((sum, day) => sum + (day.sales[fuelName] || 0), 0)\n    totalsRow.push(`Rs. ${total.toLocaleString()}`)\n  })\n  totalsRow.push(`Rs. ${totalRevenue.toLocaleString()}`)\n  salesData.push(totalsRow)\n\n  const headers = ['Date', ...reportData.fuelTypes, 'Daily Total']\n  pdf.addTable(headers, salesData)\n\n  pdf.save(`daily-sales-rs-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.pdf`)\n}\n\nexport const exportDailySalesReportExcel = (reportData: DailySalesReportData, stationName: string, monthLabel: string) => {\n  const excel = new ExcelExporter()\n\n  const totalDays = reportData.dailySales.length || 1\n  const totalRevenue = reportData.grandTotal || 0\n  const avgDaily = Math.round(totalRevenue / totalDays)\n\n  const maxDay = reportData.dailySales.length > 0\n    ? reportData.dailySales.reduce((max, day) => day.totalSales > max.totalSales ? day : max)\n    : { totalSales: 0 }\n  const minDay = reportData.dailySales.length > 0\n    ? reportData.dailySales.reduce((min, day) => day.totalSales < min.totalSales ? day : min)\n    : { totalSales: 0 }\n\n  // Daily sales data with totals\n  const salesData = reportData.dailySales.map((day) => {\n    const row: (string | number)[] = [new Date(day.date).toLocaleDateString()]\n    reportData.fuelTypes.forEach(fuelName => {\n      row.push(day.sales[fuelName] || 0)\n    })\n    row.push(day.totalSales)\n    return row\n  })\n\n  // Add totals row\n  const totalsRow: (string | number)[] = ['TOTAL']\n  reportData.fuelTypes.forEach(fuelName => {\n    const total = reportData.dailySales.reduce((sum, day) => sum + (day.sales[fuelName] || 0), 0)\n    totalsRow.push(total)\n  })\n  totalsRow.push(totalRevenue)\n  salesData.push(totalsRow)\n\n  const headers = ['Date', ...reportData.fuelTypes, 'Daily Total (Rs)']\n  excel.addWorksheet('Daily Sales', headers, salesData)\n\n  // Fuel type breakdown\n  const fuelBreakdown = reportData.fuelTypes.map(fuelName => {\n    const total = reportData.dailySales.reduce((sum, day) => sum + (day.sales[fuelName] || 0), 0)\n    const percentage = totalRevenue > 0 ? ((total / totalRevenue) * 100).toFixed(2) : '0.00'\n    return [\n      fuelName,\n      total,\n      `${percentage}%`\n    ]\n  })\n  excel.addWorksheet('Fuel Type Breakdown', ['Fuel Type', 'Total Revenue (Rs)', 'Percentage'], fuelBreakdown)\n\n  // Summary with all metrics\n  const summaryData = [\n    { label: 'Station', value: stationName },\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Total Days', value: totalDays },\n    { label: 'Total Revenue (Rs)', value: totalRevenue },\n    { label: 'Average Daily Sales (Rs)', value: avgDaily },\n    { label: 'Best Day Revenue (Rs)', value: maxDay.totalSales },\n    { label: 'Lowest Day Revenue (Rs)', value: minDay.totalSales },\n    { label: 'Revenue Range (Rs)', value: maxDay.totalSales - minDay.totalSales },\n    { label: 'Fuel Types Sold', value: reportData.fuelTypes.length }\n  ]\n  excel.addSummaryWorksheet('Summary', summaryData)\n\n  excel.save(`daily-sales-rs-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.xlsx`)\n}\n\n// Daily Sales Liters Report Export\ninterface DailySalesLitersData {\n  dailySales: Array<{\n    date: string\n    sales: Record<string, number>\n    totalLiters: number\n  }>\n  fuelTypes: string[]\n  grandTotal: number\n}\n\nexport const exportDailySalesLitersReportPDF = (reportData: DailySalesLitersData, stationName: string, monthLabel: string) => {\n  const pdf = new PDFExporter(`Daily Sales Report (Liters) - ${stationName} - ${monthLabel}`, 'landscape')\n\n  // Daily sales table\n  const salesData = reportData.dailySales.map((day) => {\n    const row: (string | number)[] = [day.date]\n    reportData.fuelTypes.forEach(fuelName => {\n      row.push(`${(day.sales[fuelName] || 0).toLocaleString()} L`)\n    })\n    row.push(`${day.totalLiters.toLocaleString()} L`)\n    return row\n  })\n\n  const headers = ['Date', ...reportData.fuelTypes, 'Total']\n  pdf.addTable(headers, salesData, 'Daily Sales Breakdown (Volume)')\n\n  // Summary\n  const summaryData = [\n    { label: 'Total Days', value: reportData.dailySales.length.toString() },\n    { label: 'Total Volume', value: `${reportData.grandTotal.toLocaleString()} L` },\n    { label: 'Average Daily Volume', value: `${Math.round(reportData.grandTotal / reportData.dailySales.length).toLocaleString()} L` }\n  ]\n  pdf.addSummaryCards(summaryData)\n\n  pdf.save(`daily-sales-liters-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.pdf`)\n}\n\nexport const exportDailySalesLitersReportExcel = (reportData: DailySalesLitersData, stationName: string, monthLabel: string) => {\n  const excel = new ExcelExporter()\n\n  const totalDays = reportData.dailySales.length || 1\n  const totalVolume = reportData.grandTotal || 0\n  const avgDaily = Math.round(totalVolume / totalDays)\n\n  // Daily sales data with totals\n  const salesData = reportData.dailySales.map((day) => {\n    const row: (string | number)[] = [new Date(day.date).toLocaleDateString()]\n    reportData.fuelTypes.forEach(fuelName => {\n      row.push(day.sales[fuelName] || 0)\n    })\n    row.push(day.totalLiters)\n    return row\n  })\n\n  // Add totals row\n  const totalsRow: (string | number)[] = ['TOTAL']\n  reportData.fuelTypes.forEach(fuelName => {\n    const total = reportData.dailySales.reduce((sum, day) => sum + (day.sales[fuelName] || 0), 0)\n    totalsRow.push(total)\n  })\n  totalsRow.push(totalVolume)\n  salesData.push(totalsRow)\n\n  const headers = ['Date', ...reportData.fuelTypes, 'Daily Total (L)']\n  excel.addWorksheet('Daily Sales', headers, salesData)\n\n  // Fuel type breakdown\n  const fuelBreakdown = reportData.fuelTypes.map(fuelName => {\n    const total = reportData.dailySales.reduce((sum, day) => sum + (day.sales[fuelName] || 0), 0)\n    const percentage = totalVolume > 0 ? ((total / totalVolume) * 100).toFixed(2) : '0.00'\n    return [\n      fuelName,\n      total,\n      `${percentage}%`\n    ]\n  })\n  excel.addWorksheet('Fuel Type Breakdown', ['Fuel Type', 'Total Volume (L)', 'Percentage'], fuelBreakdown)\n\n  // Summary\n  const summaryData = [\n    { label: 'Station', value: stationName },\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Total Days', value: totalDays },\n    { label: 'Total Volume (L)', value: totalVolume },\n    { label: 'Average Daily Volume (L)', value: avgDaily },\n    { label: 'Fuel Types Sold', value: reportData.fuelTypes.length }\n  ]\n  excel.addSummaryWorksheet('Summary', summaryData)\n\n  excel.save(`daily-sales-liters-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.xlsx`)\n}\n\n// POS Sales Report Export\ninterface POSSalesReportData {\n  summary: {\n    totalSales: number\n    totalTransactions: number\n    totalTerminals: number\n    totalBanks: number\n  }\n  bankBreakdown: Array<{\n    bankName: string\n    totalAmount: number\n    transactionCount: number\n  }>\n  terminalBreakdown: Array<{\n    terminalName: string\n    bankName: string\n    totalAmount: number\n    transactionCount: number\n  }>\n}\n\nexport const exportPOSSalesReportPDF = async (reportData: POSSalesReportData, stationName: string, monthLabel: string, chartImage?: string) => {\n  const pdf = new PDFExporter(`POS Sales Report - ${stationName} - ${monthLabel}`, 'landscape')\n\n  const totalSales = reportData.summary.totalSales || 0\n  const totalTransactions = reportData.summary.totalTransactions || 1\n  const totalTerminals = reportData.summary.totalTerminals || 1\n  const avgPerTransaction = Math.round(totalSales / totalTransactions)\n  const avgPerTerminal = Math.round(totalSales / totalTerminals)\n\n  // Report Information\n  pdf.addSectionTitle('Report Information')\n  pdf.addKeyValuePairs([\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Station', value: stationName },\n    { label: 'Banks Serviced', value: reportData.summary.totalBanks.toString() },\n    { label: 'Active POS Terminals', value: totalTerminals.toString() }\n  ], 2)\n\n  pdf.addDivider()\n\n  // Key Performance Metrics\n  pdf.addSectionTitle('Key Performance Metrics')\n  const statsGrid = [\n    [\n      { label: 'Total POS Sales', value: `Rs. ${totalSales.toLocaleString()}`, color: 'blue' },\n      { label: 'Total Transactions', value: totalTransactions.toString(), color: 'green' },\n      { label: 'Avg Per Transaction', value: `Rs. ${avgPerTransaction.toLocaleString()}`, color: 'purple' }\n    ],\n    [\n      { label: 'Active Terminals', value: totalTerminals.toString(), color: 'orange' },\n      { label: 'Avg Per Terminal', value: `Rs. ${avgPerTerminal.toLocaleString()}`, color: 'blue' },\n      { label: 'Banks Connected', value: reportData.summary.totalBanks.toString(), color: 'green' }\n    ]\n  ]\n  pdf.addStatisticsGrid(statsGrid)\n\n  pdf.addDivider()\n\n  // Sales Trend Chart\n  if (chartImage) {\n    pdf.addSectionTitle('Daily Sales Trend by Bank')\n    pdf.addChart(chartImage, '', 250, 100)\n    pdf.addDivider()\n  }\n\n  // Bank-wise breakdown\n  pdf.addSectionTitle('Sales Analysis by Bank')\n  const bankData = reportData.bankBreakdown.map((bank) => {\n    const percentage = totalSales > 0 ? ((bank.totalAmount / totalSales) * 100).toFixed(1) : '0.0'\n    const avgTrans = bank.transactionCount > 0 ? Math.round(bank.totalAmount / bank.transactionCount) : 0\n    return [\n      bank.bankName,\n      `Rs. ${bank.totalAmount.toLocaleString()}`,\n      bank.transactionCount.toString(),\n      `${percentage}%`,\n      `Rs. ${avgTrans.toLocaleString()}`\n    ]\n  })\n\n  // Add totals row for banks\n  const bankTotalsRow = [\n    'TOTAL',\n    `Rs. ${totalSales.toLocaleString()}`,\n    totalTransactions.toString(),\n    '100.0%',\n    `Rs. ${avgPerTransaction.toLocaleString()}`\n  ]\n  bankData.push(bankTotalsRow)\n\n  pdf.addTable(['Bank', 'Total Sales', 'Transactions', 'Market Share', 'Avg/Transaction'], bankData)\n\n  pdf.addDivider()\n\n  // Terminal-wise breakdown\n  pdf.addSectionTitle('Sales Analysis by POS Terminal')\n  const terminalData = reportData.terminalBreakdown.map((terminal) => {\n    const avgTrans = terminal.transactionCount > 0 ? Math.round(terminal.totalAmount / terminal.transactionCount) : 0\n    const percentage = totalSales > 0 ? ((terminal.totalAmount / totalSales) * 100).toFixed(1) : '0.0'\n    return [\n      terminal.terminalName,\n      terminal.bankName,\n      `Rs. ${terminal.totalAmount.toLocaleString()}`,\n      terminal.transactionCount.toString(),\n      `${percentage}%`,\n      `Rs. ${avgTrans.toLocaleString()}`\n    ]\n  })\n\n  // Add totals row for terminals\n  const terminalTotalsRow = [\n    'TOTAL',\n    'All Banks',\n    `Rs. ${totalSales.toLocaleString()}`,\n    totalTransactions.toString(),\n    '100.0%',\n    `Rs. ${avgPerTransaction.toLocaleString()}`\n  ]\n  terminalData.push(terminalTotalsRow)\n\n  pdf.addTable(['POS Terminal', 'Bank', 'Total Sales', 'Trans', 'Share', 'Avg/Trans'], terminalData)\n\n  pdf.save(`pos-sales-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.pdf`)\n}\n\nexport const exportPOSSalesReportExcel = (reportData: POSSalesReportData, stationName: string, monthLabel: string) => {\n  const excel = new ExcelExporter()\n\n  const totalSales = reportData.summary.totalSales || 0\n  const totalTransactions = reportData.summary.totalTransactions || 1\n  const totalTerminals = reportData.summary.totalTerminals || 1\n  const avgPerTransaction = Math.round(totalSales / totalTransactions)\n  const avgPerTerminal = Math.round(totalSales / totalTerminals)\n\n  // Bank breakdown with calculations\n  const bankData = reportData.bankBreakdown.map((bank) => {\n    const percentage = totalSales > 0 ? ((bank.totalAmount / totalSales) * 100).toFixed(2) : '0.00'\n    const avgTrans = bank.transactionCount > 0 ? Math.round(bank.totalAmount / bank.transactionCount) : 0\n    return [\n      bank.bankName,\n      bank.totalAmount,\n      bank.transactionCount,\n      `${percentage}%`,\n      avgTrans\n    ]\n  })\n\n  // Add totals row\n  bankData.push([\n    'TOTAL',\n    totalSales,\n    totalTransactions,\n    '100.00%',\n    avgPerTransaction\n  ])\n\n  excel.addWorksheet('Sales by Bank', ['Bank', 'Total Sales (Rs)', 'Transactions', 'Market Share', 'Avg/Trans (Rs)'], bankData)\n\n  // Terminal breakdown with calculations\n  const terminalData = reportData.terminalBreakdown.map((terminal) => {\n    const avgTrans = terminal.transactionCount > 0 ? Math.round(terminal.totalAmount / terminal.transactionCount) : 0\n    const percentage = totalSales > 0 ? ((terminal.totalAmount / totalSales) * 100).toFixed(2) : '0.00'\n    return [\n      terminal.terminalName,\n      terminal.bankName,\n      terminal.totalAmount,\n      terminal.transactionCount,\n      `${percentage}%`,\n      avgTrans\n    ]\n  })\n\n  // Add totals row\n  terminalData.push([\n    'TOTAL',\n    'All Banks',\n    totalSales,\n    totalTransactions,\n    '100.00%',\n    avgPerTransaction\n  ])\n\n  excel.addWorksheet('Sales by Terminal', ['POS Terminal', 'Bank', 'Total Sales (Rs)', 'Trans', 'Share', 'Avg/Trans (Rs)'], terminalData)\n\n  // Summary with all metrics\n  const summaryData = [\n    { label: 'Station', value: stationName },\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Total POS Sales (Rs)', value: totalSales },\n    { label: 'Total Transactions', value: totalTransactions },\n    { label: 'Active Terminals', value: totalTerminals },\n    { label: 'Banks Serviced', value: reportData.summary.totalBanks },\n    { label: 'Avg Per Transaction (Rs)', value: avgPerTransaction },\n    { label: 'Avg Per Terminal (Rs)', value: avgPerTerminal }\n  ]\n  excel.addSummaryWorksheet('Summary', summaryData)\n\n  excel.save(`pos-sales-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.xlsx`)\n}\n\n// Credit Customer Report Export\ninterface CreditCustomerReportData {\n  summary: {\n    totalCustomers: number\n    activeCustomers: number\n    totalOutstanding: number\n    totalCreditSales: number\n    totalPayments: number\n  }\n  customerDetails: Array<{\n    name: string\n    company: string\n    currentBalance: number\n    creditLimit: number\n    salesInPeriod: number\n    paymentsInPeriod: number\n    agingCategory: string\n  }>\n}\n\nexport const exportCreditCustomerReportPDF = async (reportData: CreditCustomerReportData, stationName: string, monthLabel: string, chartImage?: string) => {\n  const pdf = new PDFExporter(`Credit Customer Report - ${stationName} - ${monthLabel}`, 'landscape')\n\n  const totalCustomers = reportData.summary.totalCustomers || 0\n  const activeCustomers = reportData.summary.activeCustomers || 1\n  const totalOutstanding = reportData.summary.totalOutstanding || 0\n  const totalCreditSales = reportData.summary.totalCreditSales || 0\n  const totalPayments = reportData.summary.totalPayments || 0\n\n  const collectionRate = totalCreditSales > 0\n    ? ((totalPayments / totalCreditSales) * 100).toFixed(1)\n    : '0.0'\n  const avgOutstanding = Math.round(totalOutstanding / activeCustomers)\n  const avgCreditLimit = reportData.customerDetails.length > 0\n    ? Math.round(reportData.customerDetails.reduce((sum, c) => sum + c.creditLimit, 0) / reportData.customerDetails.length)\n    : 0\n  const netCreditChange = totalCreditSales - totalPayments\n\n  // Report Information\n  pdf.addSectionTitle('Report Information')\n  pdf.addKeyValuePairs([\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Station', value: stationName },\n    { label: 'Total Customers', value: totalCustomers.toString() },\n    { label: 'Active Customers', value: activeCustomers.toString() }\n  ], 2)\n\n  pdf.addDivider()\n\n  // Key Performance Metrics\n  pdf.addSectionTitle('Key Performance Metrics')\n  const statsGrid = [\n    [\n      { label: 'Total Outstanding', value: `Rs. ${totalOutstanding.toLocaleString()}`, color: 'red' },\n      { label: 'Credit Sales (Period)', value: `Rs. ${totalCreditSales.toLocaleString()}`, color: 'orange' },\n      { label: 'Payments Received', value: `Rs. ${totalPayments.toLocaleString()}`, color: 'green' }\n    ],\n    [\n      { label: 'Collection Rate', value: `${collectionRate}%`, color: 'purple' },\n      { label: 'Avg Outstanding', value: `Rs. ${avgOutstanding.toLocaleString()}`, color: 'blue' },\n      { label: 'Net Credit Change', value: `Rs. ${netCreditChange.toLocaleString()}`, color: netCreditChange >= 0 ? 'orange' : 'green' }\n    ]\n  ]\n  pdf.addStatisticsGrid(statsGrid)\n\n  pdf.addDivider()\n\n  // Aging Analysis Chart\n  if (chartImage) {\n    pdf.addSectionTitle('Customer Aging Analysis')\n    pdf.addChart(chartImage, '', 250, 100)\n    pdf.addDivider()\n  }\n\n  // Financial Analysis\n  pdf.addSectionTitle('Financial Analysis')\n  const financialMetrics = [\n    { label: 'Average Credit Limit', value: `Rs. ${avgCreditLimit.toLocaleString()}` },\n    { label: 'Average Outstanding per Customer', value: `Rs. ${avgOutstanding.toLocaleString()}` },\n    { label: 'Total Credit Extended', value: `Rs. ${(totalOutstanding + totalCreditSales).toLocaleString()}` },\n    { label: 'Recovery Rate', value: `${collectionRate}%` }\n  ]\n  pdf.addKeyValuePairs(financialMetrics, 2)\n\n  pdf.addDivider()\n\n  // Complete Customer Details\n  pdf.addSectionTitle('Customer Account Details')\n  const customerData = reportData.customerDetails.map((customer) => {\n    const utilization = customer.creditLimit > 0\n      ? ((customer.currentBalance / customer.creditLimit) * 100).toFixed(0)\n      : '0'\n    const netActivity = customer.salesInPeriod - customer.paymentsInPeriod\n    return [\n      customer.name,\n      customer.company || 'N/A',\n      `Rs. ${customer.currentBalance.toLocaleString()}`,\n      `Rs. ${customer.creditLimit.toLocaleString()}`,\n      `${utilization}%`,\n      `Rs. ${customer.salesInPeriod.toLocaleString()}`,\n      `Rs. ${customer.paymentsInPeriod.toLocaleString()}`,\n      `Rs. ${netActivity.toLocaleString()}`,\n      customer.agingCategory\n    ]\n  })\n\n  // Add totals row\n  const totalsRow = [\n    'TOTAL',\n    '-',\n    `Rs. ${totalOutstanding.toLocaleString()}`,\n    '-',\n    '-',\n    `Rs. ${totalCreditSales.toLocaleString()}`,\n    `Rs. ${totalPayments.toLocaleString()}`,\n    `Rs. ${netCreditChange.toLocaleString()}`,\n    '-'\n  ]\n  customerData.push(totalsRow)\n\n  pdf.addTable(\n    ['Customer', 'Company', 'Balance', 'Limit', 'Util%', 'Sales', 'Payments', 'Net Change', 'Aging'],\n    customerData\n  )\n\n  pdf.save(`credit-customers-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.pdf`)\n}\n\nexport const exportCreditCustomerReportExcel = (reportData: CreditCustomerReportData, stationName: string, monthLabel: string) => {\n  const excel = new ExcelExporter()\n\n  const totalOutstanding = reportData.summary.totalOutstanding || 0\n  const totalCreditSales = reportData.summary.totalCreditSales || 0\n  const totalPayments = reportData.summary.totalPayments || 0\n  const collectionRate = totalCreditSales > 0 ? ((totalPayments / totalCreditSales) * 100).toFixed(2) : '0.00'\n  const netCreditChange = totalCreditSales - totalPayments\n\n  // Customer details with calculations\n  const customerData = reportData.customerDetails.map((customer) => {\n    const utilization = customer.creditLimit > 0\n      ? `${((customer.currentBalance / customer.creditLimit) * 100).toFixed(1)}%`\n      : 'N/A'\n    const netActivity = customer.salesInPeriod - customer.paymentsInPeriod\n    return [\n      customer.name,\n      customer.company || 'N/A',\n      customer.currentBalance,\n      customer.creditLimit,\n      utilization,\n      customer.salesInPeriod,\n      customer.paymentsInPeriod,\n      netActivity,\n      customer.agingCategory\n    ]\n  })\n\n  // Add totals row\n  customerData.push([\n    'TOTAL',\n    '-',\n    totalOutstanding,\n    '-',\n    '-',\n    totalCreditSales,\n    totalPayments,\n    netCreditChange,\n    '-'\n  ])\n\n  excel.addWorksheet('Customer Details', ['Customer', 'Company', 'Balance (Rs)', 'Limit (Rs)', 'Utilization', 'Sales (Rs)', 'Payments (Rs)', 'Net Change (Rs)', 'Aging'], customerData)\n\n  // Summary with all metrics\n  const summaryData = [\n    { label: 'Station', value: stationName },\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Total Customers', value: reportData.summary.totalCustomers },\n    { label: 'Active Customers', value: reportData.summary.activeCustomers },\n    { label: 'Total Outstanding (Rs)', value: totalOutstanding },\n    { label: 'Total Credit Sales (Rs)', value: totalCreditSales },\n    { label: 'Total Payments (Rs)', value: totalPayments },\n    { label: 'Collection Rate (%)', value: collectionRate },\n    { label: 'Net Credit Change (Rs)', value: netCreditChange }\n  ]\n  excel.addSummaryWorksheet('Summary', summaryData)\n\n  excel.save(`credit-customers-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.xlsx`)\n}\n\n// Pumper Details Report Export\ninterface PumperDetailsReportData {\n  summary: {\n    totalPumpers: number\n    totalShifts: number\n    totalSales: number\n    totalLiters: number\n    excellentPerformers?: number\n    goodPerformers?: number\n    needsImprovement?: number\n    criticalPerformers?: number\n  }\n  pumperDetails: Array<{\n    name: string\n    employeeId: string\n    totalShifts: number\n    totalSales: number\n    totalLiters: number\n    averageSalesPerShift: number\n    varianceRate: number\n    performanceRating: string\n    totalLoanBalance: number\n    averageLitersPerShift: number\n    activeLoansCount: number\n    totalMonthlyRental: number\n    advanceLimit: number\n  }>\n}\n\nexport const exportPumperDetailsReportPDF = (reportData: PumperDetailsReportData, stationName: string, monthLabel: string) => {\n  const pdf = new PDFExporter(`Pumper Details Report - ${stationName} - ${monthLabel}`, 'landscape')\n\n  // Pumper details\n  const pumperData = reportData.pumperDetails.map((pumper) => [\n    pumper.name,\n    pumper.employeeId,\n    pumper.totalShifts.toString(),\n    `Rs. ${pumper.totalSales.toLocaleString()}`,\n    `${pumper.totalLiters.toLocaleString()} L`,\n    `Rs. ${pumper.averageSalesPerShift.toLocaleString()}`,\n    `${pumper.varianceRate.toFixed(2)}%`,\n    pumper.performanceRating,\n    `Rs. ${pumper.totalLoanBalance.toLocaleString()}`\n  ])\n  pdf.addTable(['Pumper', 'Employee ID', 'Shifts', 'Total Sales', 'Liters', 'Avg/Shift', 'Variance', 'Rating', 'Loans'], pumperData, 'Pumper Performance')\n\n  // Summary\n  const summaryData = [\n    { label: 'Total Pumpers', value: reportData.summary.totalPumpers.toString() },\n    { label: 'Total Shifts', value: reportData.summary.totalShifts.toString() },\n    { label: 'Total Sales', value: `Rs. ${reportData.summary.totalSales.toLocaleString()}` },\n    { label: 'Total Liters', value: `${reportData.summary.totalLiters.toLocaleString()} L` }\n  ]\n  pdf.addSummaryCards(summaryData)\n\n  pdf.save(`pumper-details-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.pdf`)\n}\n\nexport const exportPumperDetailsReportExcel = (reportData: PumperDetailsReportData, stationName: string, monthLabel: string) => {\n  const excel = new ExcelExporter()\n\n  const totalSales = reportData.summary.totalSales || 0\n  const totalLiters = reportData.summary.totalLiters || 0\n  const totalShifts = reportData.summary.totalShifts || 1\n  const avgSalesPerShift = Math.round(totalSales / totalShifts)\n  const avgLitersPerShift = Math.round(totalLiters / totalShifts)\n\n  // Pumper details with all metrics\n  const pumperData = reportData.pumperDetails.map((pumper) => [\n    pumper.name,\n    pumper.employeeId,\n    pumper.totalShifts,\n    pumper.totalSales,\n    pumper.totalLiters,\n    pumper.averageSalesPerShift,\n    pumper.averageLitersPerShift,\n    `${pumper.varianceRate}%`,\n    pumper.performanceRating,\n    pumper.totalLoanBalance,\n    pumper.activeLoansCount,\n    pumper.totalMonthlyRental,\n    pumper.advanceLimit\n  ])\n\n  // Add totals row\n  pumperData.push([\n    'TOTAL',\n    '-',\n    totalShifts,\n    totalSales,\n    totalLiters,\n    avgSalesPerShift,\n    avgLitersPerShift,\n    '-',\n    '-',\n    reportData.pumperDetails.reduce((sum, p) => sum + p.totalLoanBalance, 0),\n    reportData.pumperDetails.reduce((sum, p) => sum + p.activeLoansCount, 0),\n    reportData.pumperDetails.reduce((sum, p) => sum + p.totalMonthlyRental, 0),\n    '-'\n  ])\n\n  excel.addWorksheet('Pumper Performance', [\n    'Pumper',\n    'Employee ID',\n    'Shifts',\n    'Total Sales (Rs)',\n    'Liters',\n    'Avg Sales/Shift (Rs)',\n    'Avg Liters/Shift',\n    'Variance Rate',\n    'Performance',\n    'Loan Balance (Rs)',\n    'Active Loans',\n    'Monthly Rental (Rs)',\n    'Advance Limit (Rs)'\n  ], pumperData)\n\n  // Summary with all metrics\n  const summaryData = [\n    { label: 'Station', value: stationName },\n    { label: 'Reporting Period', value: monthLabel },\n    { label: 'Total Pumpers', value: reportData.summary.totalPumpers },\n    { label: 'Total Shifts', value: totalShifts },\n    { label: 'Total Sales (Rs)', value: totalSales },\n    { label: 'Total Liters', value: totalLiters },\n    { label: 'Avg Sales per Shift (Rs)', value: avgSalesPerShift },\n    { label: 'Avg Liters per Shift', value: avgLitersPerShift },\n    { label: 'Excellent Performers', value: reportData.summary.excellentPerformers || 0 },\n    { label: 'Good Performers', value: reportData.summary.goodPerformers || 0 },\n    { label: 'Needs Improvement', value: reportData.summary.needsImprovement || 0 },\n    { label: 'Critical Performers', value: reportData.summary.criticalPerformers || 0 }\n  ]\n  excel.addSummaryWorksheet('Summary', summaryData)\n\n  excel.save(`pumper-details-${stationName.replace(/\\s+/g, '-')}-${monthLabel.replace(/\\s+/g, '-')}.xlsx`)\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\jwt.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\nozzleUtils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\passwordGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\tank-calibration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\lib\\validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\src\\types\\db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\USER\\Desktop\\dfs management system\\shed-admin\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]